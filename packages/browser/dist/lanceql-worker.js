var W=new Map;async function ae(a){return crypto.subtle.importKey("raw",new Uint8Array(a),{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}async function ie(a,e){let t=crypto.getRandomValues(new Uint8Array(12)),s=new TextEncoder().encode(JSON.stringify(a)),o=await crypto.subtle.encrypt({name:"AES-GCM",iv:t},e,s),i=new Uint8Array(12+o.byteLength);return i.set(t,0),i.set(new Uint8Array(o),12),i}async function ce(a,e){let t=a.slice(0,12),r=a.slice(12),s=await crypto.subtle.decrypt({name:"AES-GCM",iv:t},e,r),o=new TextDecoder;return JSON.parse(o.decode(s))}var D=null,ee=null,we=new Map;function st(a){D=a}function rt(a){ee=a}var le=class{constructor(e,t={}){this.name=e,this.options=t,this._root=null,this._ready=!1,this._embedder=null,this._encryptionKeyId=null}async open(e=null){if(this._ready)return this;if(e){let{keyId:t,keyBytes:r}=e;if(!W.has(t)){let s=await ae(r);W.set(t,s)}this._encryptionKeyId=t}try{let t=await navigator.storage.getDirectory();this._root=await t.getDirectoryHandle(`lanceql-${this.name}`,{create:!0}),this._ready=!0}catch(t){throw console.error("[WorkerStore] Failed to open OPFS:",t),t}return this}_getCryptoKey(){return this._encryptionKeyId?W.get(this._encryptionKeyId):null}async get(e){await this._ensureOpen();try{let t=this._getCryptoKey(),r=t?".enc":".json",o=await(await this._root.getFileHandle(`${e}${r}`)).getFile();if(t){let i=await o.arrayBuffer();return ce(new Uint8Array(i),t)}else{let i=await o.text();return JSON.parse(i)}}catch(t){if(t.name==="NotFoundError")return;throw t}}async set(e,t){await this._ensureOpen();let r=this._getCryptoKey(),s=r?".enc":".json",i=await(await this._root.getFileHandle(`${e}${s}`,{create:!0})).createWritable();if(r){let c=await ie(t,r);await i.write(c)}else await i.write(JSON.stringify(t));await i.close()}async delete(e){await this._ensureOpen();let r=this._getCryptoKey()?".enc":".json";try{await this._root.removeEntry(`${e}${r}`)}catch(s){if(s.name!=="NotFoundError")throw s}}async keys(){await this._ensureOpen();let t=this._getCryptoKey()?".enc":".json",r=[];for await(let[s]of this._root.entries())s.endsWith(t)&&r.push(s.slice(0,-t.length));return r}async clear(){await this._ensureOpen();let e=[];for await(let[t]of this._root.entries())e.push(t);for(let t of e)await this._root.removeEntry(t)}async filter(e,t){let r=await this.get(e);if(!Array.isArray(r))throw new Error(`Key '${e}' is not a collection`);return r.filter(s=>this._matchQuery(s,t))}async find(e,t){let r=await this.get(e);if(!Array.isArray(r))throw new Error(`Key '${e}' is not a collection`);return r.find(s=>this._matchQuery(s,t))}async search(e,t,r=10){let s=await this.get(e);if(!Array.isArray(s))throw new Error(`Key '${e}' is not a collection`);if(s.length===0)return[];if(this._embedder)return this._semanticSearch(s,e,t,r);let o=t.toLowerCase();return s.map(c=>{let f=this._extractText(c).toLowerCase(),l=o.split(/\s+/),u=l.filter(h=>f.includes(h)).length;return{item:c,score:u/l.length}}).filter(c=>c.score>0).sort((c,f)=>f.score-c.score).slice(0,r)}async _semanticSearch(e,t,r,s){let o=await this._embedder.embed(r),i=[],c=[],f=[];for(let l=0;l<e.length;l++){let u=e[l],h=this._extractText(u),d=`${this.name}:${t}:${h}`;if(we.has(d)){let m=we.get(d),w=this._cosineSimilarity(o,m);i.push({item:u,score:w})}else c.push(h),f.push(l)}if(c.length>0){let l;c.length>1&&this._embedder.embedBatch?l=await this._embedder.embedBatch(c):l=await Promise.all(c.map(u=>this._embedder.embed(u)));for(let u=0;u<l.length;u++){let h=f[u],d=e[h],m=c[u],w=l[u],p=`${this.name}:${t}:${m}`;we.set(p,w);let y=this._cosineSimilarity(o,w);i.push({item:d,score:y})}}return i.sort((l,u)=>u.score-l.score).slice(0,s)}async enableSemanticSearch(e={}){let{model:t="minilm",onProgress:r}=e;if(D||(ee||(ee=this._initGPUTransformer(),rt(ee)),D=await ee,st(D)),!D)return null;let s=await D.loadModel(t,r);return this._embedder={model:t,dimensions:s.hiddenSize,embed:async o=>D.encodeText(o,t),embedBatch:async o=>D.encodeTextBatch(o,t)},{model:t,dimensions:s.hiddenSize,type:s.modelType||"text"}}async _initGPUTransformer(){try{let e=await import("./webgpu/index.js");if(!e.isWebGPUAvailable())return console.log("[WorkerStore] WebGPU not available"),null;let t=e.getGPUTransformer();return await t.init()?(console.log("[WorkerStore] WebGPU initialized"),t):(console.log("[WorkerStore] WebGPU init failed"),null)}catch(e){return console.error("[WorkerStore] WebGPU init error:",e),null}}disableSemanticSearch(){this._embedder&&D&&(D.unloadModel(this._embedder.model),this._embedder=null)}hasSemanticSearch(){return this._embedder!==null}async count(e,t=null){let r=await this.get(e);if(!Array.isArray(r))throw new Error(`Key '${e}' is not a collection`);return t?r.filter(s=>this._matchQuery(s,t)).length:r.length}async _ensureOpen(){this._ready||await this.open()}_matchQuery(e,t){for(let[r,s]of Object.entries(t)){let o=e[r];if(typeof s=="object"&&s!==null)for(let[i,c]of Object.entries(s))switch(i){case"$eq":if(o!==c)return!1;break;case"$ne":if(o===c)return!1;break;case"$lt":if(!(o<c))return!1;break;case"$lte":if(!(o<=c))return!1;break;case"$gt":if(!(o>c))return!1;break;case"$gte":if(!(o>=c))return!1;break;case"$in":if(!Array.isArray(c)||!c.includes(o))return!1;break;case"$nin":if(Array.isArray(c)&&c.includes(o))return!1;break;case"$contains":if(typeof o!="string"||!o.includes(c))return!1;break;case"$regex":if(typeof o!="string"||!new RegExp(c).test(o))return!1;break}else if(o!==s)return!1}return!0}_extractText(e){if(typeof e=="string")return e;let t=[];for(let[r,s]of Object.entries(e))typeof s=="string"&&t.push(s);return t.join(" ")}_cosineSimilarity(e,t){let r=0,s=0,o=0;for(let i=0;i<e.length;i++)r+=e[i]*t[i],s+=e[i]*e[i],o+=t[i]*t[i];return r/(Math.sqrt(s)*Math.sqrt(o))}};var ge=class{constructor(e="lanceql"){this.rootDir=e,this.root=null}async getRoot(){if(this.root)return this.root;if(typeof navigator>"u"||!navigator.storage?.getDirectory)throw new Error("OPFS not available");let e=await navigator.storage.getDirectory();return this.root=await e.getDirectoryHandle(this.rootDir,{create:!0}),this.root}async open(){return await this.getRoot(),this}async getDir(e){let t=await this.getRoot(),r=e.split("/").filter(o=>o),s=t;for(let o of r)s=await s.getDirectoryHandle(o,{create:!0});return s}async save(e,t){let r=e.split("/"),s=r.pop(),o=r.join("/"),c=await(o?await this.getDir(o):await this.getRoot()).getFileHandle(s,{create:!0});if(c.createSyncAccessHandle)try{let l=await c.createSyncAccessHandle();return l.truncate(0),l.write(t,{at:0}),l.flush(),l.close(),{path:e,size:t.byteLength}}catch{}let f=await c.createWritable();return await f.write(t),await f.close(),{path:e,size:t.byteLength}}async load(e){try{let t=e.split("/"),r=t.pop(),s=t.join("/"),f=await(await(await(s?await this.getDir(s):await this.getRoot()).getFileHandle(r)).getFile()).arrayBuffer();return new Uint8Array(f)}catch(t){if(t.name==="NotFoundError")return null;throw t}}async delete(e){try{let t=e.split("/"),r=t.pop(),s=t.join("/");return await(s?await this.getDir(s):await this.getRoot()).removeEntry(r),!0}catch(t){if(t.name==="NotFoundError")return!1;throw t}}async list(e=""){try{let t=e?await this.getDir(e):await this.getRoot(),r=[];for await(let[s,o]of t.entries())r.push({name:s,type:o.kind});return r}catch{return[]}}async exists(e){try{let t=e.split("/"),r=t.pop(),s=t.join("/");return await(s?await this.getDir(s):await this.getRoot()).getFileHandle(r),!0}catch{return!1}}async deleteDir(e){try{let t=e.split("/"),r=t.pop(),s=t.join("/");return await(s?await this.getDir(s):await this.getRoot()).removeEntry(r,{recursive:!0}),!0}catch{return!1}}},L=new ge;var P=new TextEncoder,K=new TextDecoder,Pe={INT64:"int64",INT32:"int32",FLOAT64:"float64",FLOAT32:"float32",STRING:"string",BOOL:"bool",VECTOR:"vector"},Me=1,ke=2,Ve=3,We=4,Te=5,Re=6;function De(a){switch(a){case"int32":case"integer":return Int32Array;case"int64":return BigInt64Array;case"float32":case"real":return Float32Array;case"float64":case"double":return Float64Array;default:return null}}function ot(a){switch(a){case"int32":case"integer":return Me;case"int64":return ke;case"float32":case"real":return Ve;case"float64":case"double":return We;case"string":case"text":return Te;case"bool":case"boolean":return Re;default:return Te}}var he=class{constructor(e){this.schema=e,this.columns=new Map,this.rowCount=0,this._useBinary=!0}addRows(e){if(e.length!==0){if(this.rowCount===0)for(let t of this.schema){let r=De(t.dataType);r?this.columns.set(t.name,{type:"typed",dataType:t.dataType,data:new r(Math.max(e.length,1024)),length:0}):this.columns.set(t.name,{type:"array",dataType:t.dataType,data:[],length:0})}for(let t of this.schema){let r=this.columns.get(t.name);if(r.type==="typed"){let s=r.length+e.length;if(s>r.data.length){let o=Math.max(s,r.data.length*2),i=new r.data.constructor(o);i.set(r.data),r.data=i}for(let o=0;o<e.length;o++){let i=e[o][t.name];r.data[r.length+o]=i??0}r.length+=e.length}else{for(let s=0;s<e.length;s++)r.data.push(e[s][t.name]??null);r.length+=e.length}}this.rowCount+=e.length}}buildBinary(){let e=[],t=16,r=[];for(let f of this.schema){let l=this.columns.get(f.name),u=P.encode(f.name),h=ot(f.dataType),d;if(l.type==="typed"){let p=l.data.subarray(0,l.length);d=new Uint8Array(p.buffer,p.byteOffset,p.byteLength)}else d=P.encode(JSON.stringify(l.data));r.push({nameBytes:u,typeCode:h,dataBytes:d,dataType:f.dataType});let w=(8-(t+4+u.length+1+4)%8)%8;t+=4+u.length+1+w+4+d.length}let s=new ArrayBuffer(t),o=new DataView(s),i=new Uint8Array(s),c=0;o.setUint32(c,1279348291,!1),c+=4,o.setUint32(c,2,!1),c+=4,o.setUint32(c,this.schema.length,!1),c+=4,o.setUint32(c,this.rowCount,!1),c+=4;for(let f of r){o.setUint32(c,f.nameBytes.length,!1),c+=4,i.set(f.nameBytes,c),c+=f.nameBytes.length,o.setUint8(c,f.typeCode),c+=1;let l=(8-(c+4)%8)%8;for(let u=0;u<l;u++)o.setUint8(c+u,0);c+=l,o.setUint32(c,f.dataBytes.length,!1),c+=4,i.set(f.dataBytes,c),c+=f.dataBytes.length}return new Uint8Array(s)}setColumnarData(e){let t=Object.keys(e)[0];this.rowCount=e[t]?.length||0;for(let r of this.schema){let s=e[r.name];if(!s)continue;let o=De(r.dataType);if(o&&ArrayBuffer.isView(s))this.columns.set(r.name,{type:"typed",dataType:r.dataType,data:s,length:s.length});else if(o){let i=new o(s.length);for(let c=0;c<s.length;c++)i[c]=s[c]??0;this.columns.set(r.name,{type:"typed",dataType:r.dataType,data:i,length:s.length})}else this.columns.set(r.name,{type:"array",dataType:r.dataType,data:Array.isArray(s)?s:Array.from(s),length:s.length})}}build(){if(this._useBinary&&this.rowCount>0)try{return this.buildBinary()}catch(t){console.warn("[LanceFileWriter] Binary build failed, falling back to JSON:",t)}let e={format:"json",schema:this.schema,columns:{},rowCount:this.rowCount};for(let[t,r]of this.columns)r.type==="typed"?e.columns[t]=Array.from(r.data.subarray(0,r.length)):e.columns[t]=r.data;return P.encode(JSON.stringify(e))}};function te(a){let e=new DataView(a.buffer||a),t=new Uint8Array(a.buffer||a),r=0;if(e.getUint32(r,!1)!==1279348291)return null;r+=4;let o=e.getUint32(r,!1);r+=4;let i=e.getUint32(r,!1);r+=4;let c=e.getUint32(r,!1);r+=4;let f=[],l={};for(let u=0;u<i;u++){let h=e.getUint32(r,!1);r+=4;let d=K.decode(t.subarray(r,r+h));r+=h;let m=e.getUint8(r);r+=1;let w=(8-(r+4)%8)%8;r+=w;let p=e.getUint32(r,!1);r+=4;let y=t.subarray(r,r+p);r+=p;let E,T;try{switch(m){case Me:T="int32",y.byteOffset%4!==0?E=new Int32Array(y.slice().buffer):E=new Int32Array(y.buffer,y.byteOffset,y.byteLength/4);break;case Ve:T="float32",y.byteOffset%4!==0?E=new Float32Array(y.slice().buffer):E=new Float32Array(y.buffer,y.byteOffset,y.byteLength/4);break;case We:T="float64",y.byteOffset%8!==0?E=new Float64Array(y.slice().buffer):E=new Float64Array(y.buffer,y.byteOffset,y.byteLength/8);break;case ke:T="int64",y.byteOffset%8!==0?E=new BigInt64Array(y.slice().buffer):E=new BigInt64Array(y.buffer,y.byteOffset,y.byteLength/8);break;case Te:case Re:default:T=m===Re?"bool":"string",E=JSON.parse(K.decode(y));break}}catch(g){throw console.error(`[LanceQLWorker] Error parsing column '${d}' (type ${m}, len ${p}):`,g),g}f.push({name:d,dataType:T}),l[d]=E}return{schema:f,columns:l,rowCount:c,format:"binary"}}var J=class{constructor(e=512*1024*1024){this.maxBytes=e,this.currentBytes=0,this.cache=new Map,this.head=null,this.tail=null}get(e){let t=this.cache.get(e);if(t)return this._moveToHead(t),t.value}set(e,t,r=0){let s=this.cache.get(e);if(s)this.currentBytes-=s.size,this.currentBytes+=r,s.value=t,s.size=r,this._moveToHead(s);else{let o={key:e,value:t,size:r,prev:null,next:null};this.cache.set(e,o),this._addToHead(o),this.currentBytes+=r}this._evictIfNeeded()}has(e){return this.cache.has(e)}delete(e){let t=this.cache.get(e);t&&(this._removeNode(t),this.cache.delete(e),this.currentBytes-=t.size)}clear(){this.cache.clear(),this.head=null,this.tail=null,this.currentBytes=0}_moveToHead(e){e!==this.head&&(this._removeNode(e),this._addToHead(e))}_addToHead(e){e.next=this.head,e.prev=null,this.head&&(this.head.prev=e),this.head=e,this.tail||(this.tail=e)}_removeNode(e){e.prev?e.prev.next=e.next:this.head=e.next,e.next?e.next.prev=e.prev:this.tail=e.prev}_evictIfNeeded(){for(;this.currentBytes>this.maxBytes&&this.tail;){let e=this.tail;this._removeNode(e),this.cache.delete(e.key),this.currentBytes-=e.size}}static estimateSize(e){return e?e.byteLength?e.byteLength:Array.isArray(e)?e.length*100:e.buffer&&e.buffer.byteLength?e.buffer.byteLength:1e3:0}};var Ae=new Map,at=1,z=class{constructor(e,t){this.name=e,this.tables=new Map,this.version=0,this.manifestKey=`${e}/__manifest__`,this.bufferPool=t||new J,this._writeBuffer=new Map,this._flushTimer=null,this._flushInterval=2e3,this._flushThreshold=1e4,this._columnarBuffer=new Map,this._flushing=!1,this._readCache=new Map,this._columnarCache=new Map}async open(){let e=await L.load(this.manifestKey);if(e){let t=JSON.parse(K.decode(e));this.version=t.version||0,this.tables=new Map(Object.entries(t.tables||{}));for(let[r,s]of this.tables)await this._getLatestVersion(r)===0&&s.fragments?.length>0&&await this._createVersion(r,"MIGRATE")}return this}async _saveManifest(){this.version++;let e={version:this.version,timestamp:Date.now(),tables:Object.fromEntries(this.tables)},t=P.encode(JSON.stringify(e));await L.save(this.manifestKey,t)}async _getLatestVersion(e){let t=`${this.name}/${e}/_latest`;try{let r=await L.load(t);return r?parseInt(K.decode(r),10):0}catch{return 0}}async _setLatestVersion(e,t){let r=`${this.name}/${e}/_latest`;await L.save(r,P.encode(String(t)))}async _loadTableVersion(e,t){let r=`${this.name}/${e}/_versions/${t}.manifest`,s=await L.load(r);if(!s)throw new Error(`Version ${t} not found for table '${e}'`);return JSON.parse(K.decode(s))}async _saveTableVersion(e,t){let r=`${this.name}/${e}/_versions/${t.version}.manifest`;await L.save(r,P.encode(JSON.stringify(t)))}async _createVersion(e,t){let r=this.tables.get(e);if(!r)return 0;let s=await this._getLatestVersion(e),o=s+1,i={version:o,timestamp:Date.now(),parentVersion:s,operation:t,schema:r.schema,fragments:[...r.fragments],deletionVector:[...r.deletionVector],rowCount:r.rowCount,nextRowId:r.nextRowId};return await this._saveTableVersion(e,i),await this._setLatestVersion(e,o),o}async listVersions(e){let t=await this._getLatestVersion(e),r=[];for(let s=1;s<=t;s++)try{let o=await this._loadTableVersion(e,s);r.push({version:o.version,timestamp:o.timestamp,operation:o.operation,rowCount:o.rowCount})}catch{}return r}async selectAtVersion(e,t,r={}){let s=await this._loadTableVersion(e,t),o=new Set(s.deletionVector),i=this.tables.get(e),c=[];for(let u of s.fragments){let h=await L.load(u);if(h){let d=this._parseFragment(h,s.schema);for(let m of d)o.has(m.__rowId)||c.push(m)}}let f=c;if(r.where&&(f=f.filter(r.where)),r.orderBy){let{column:u,desc:h}=r.orderBy;f.sort((d,m)=>{let w=d[u]<m[u]?-1:d[u]>m[u]?1:0;return h?-w:w})}r.offset&&(f=f.slice(r.offset)),r.limit&&(f=f.slice(0,r.limit));let l=r.columns&&r.columns.length>0&&r.columns[0]!=="*"?r.columns:null;return f.map(u=>{if(l){let h={};for(let d of l)h[d]=u[d];return h}else{let{__rowId:h,...d}=u;return d}})}async restoreToVersion(e,t){let r=await this._loadTableVersion(e,t),s=await this._getLatestVersion(e),o=s+1,i={...r,version:o,timestamp:Date.now(),parentVersion:s,operation:`RESTORE_FROM_${t}`};await this._saveTableVersion(e,i),await this._setLatestVersion(e,o);let c=this.tables.get(e);return c&&(c.fragments=[...r.fragments],c.deletionVector=[...r.deletionVector],c.rowCount=r.rowCount,c.nextRowId=r.nextRowId,this._columnarBuffer.delete(e),this._writeBuffer.delete(e),await this._saveManifest()),{restored:!0,newVersion:o}}async createTable(e,t,r=!1){if(this.tables.has(e)){if(r)return{success:!0,existed:!0};throw new Error(`Table '${e}' already exists`)}let s=t.map(i=>({name:i.name,type:Pe[(i.dataType||i.type)?.toUpperCase()]||i.dataType||i.type||"string",primaryKey:i.primaryKey||!1,vectorDim:i.vectorDim||null})),o={name:e,schema:s,fragments:[],deletionVector:[],rowCount:0,nextRowId:0,version:0,createdAt:Date.now()};return this.tables.set(e,o),await this._saveManifest(),await this._createVersion(e,"CREATE"),{success:!0,table:e}}async dropTable(e,t=!1){if(!this.tables.has(e)){if(t)return this._writeBuffer.delete(e),{success:!0,existed:!1};throw new Error(`Table '${e}' does not exist`)}let r=this.tables.get(e);this._writeBuffer.delete(e);for(let s of r.fragments)this._readCache.delete(s),await L.delete(s);return this.tables.delete(e),await this._saveManifest(),{success:!0,table:e}}async insert(e,t){if(!this.tables.has(e))throw new Error(`Table '${e}' does not exist`);let r=this.tables.get(e),s=t.length;if(!this._columnarBuffer.has(e)){let f=Math.max(1024,s*2),l={__rowId:new Float64Array(f),__length:0,__capacity:f,__schema:r.schema};for(let u of r.schema){let h=(u.dataType||u.type||"").toLowerCase();h==="text"||h==="string"||h==="varchar"?l[u.name]=new Array(f):h==="int64"||h==="bigint"?l[u.name]=new BigInt64Array(f):l[u.name]=new Float64Array(f)}this._columnarBuffer.set(e,l)}let o=this._columnarBuffer.get(e),i=o.__length,c=o.__capacity;if(i+s>c){let f=Math.max(c*2,i+s),l=new Float64Array(f);l.set(o.__rowId.subarray(0,i)),o.__rowId=l;for(let u of r.schema){let h=o[u.name];if(h instanceof Float64Array){let d=new Float64Array(f);d.set(h.subarray(0,i)),o[u.name]=d}else if(h instanceof BigInt64Array){let d=new BigInt64Array(f);d.set(h.subarray(0,i)),o[u.name]=d}else o[u.name].length=f}o.__capacity=f}for(let f=0;f<s;f++){let l=t[f];o.__rowId[i+f]=r.nextRowId++;for(let u of r.schema){let h=l[u.name];o[u.name]instanceof Float64Array?o[u.name][i+f]=h!=null?Number(h):NaN:o[u.name]instanceof BigInt64Array?o[u.name][i+f]=h!=null?BigInt(h):0n:o[u.name][i+f]=h??null}}return o.__length=i+s,r.rowCount+=s,r.version=(r.version||0)+1,this._scheduleFlush(),o.__length>=this._flushThreshold&&await this._flushTable(e),{success:!0,inserted:s}}_scheduleFlush(){this._flushTimer||(this._flushTimer=setTimeout(()=>{this._flushTimer=null,this.flush().catch(e=>console.warn("[WorkerDatabase] Flush error:",e))},this._flushInterval))}async flush(){if(!this._flushing){this._flushing=!0;try{let e=[...this._columnarBuffer.keys()];for(let t of e)await this._flushTable(t)}finally{this._flushing=!1}}}async _flushTable(e){let t=this._columnarBuffer.get(e),r=t?.__length||0;if(!t||r===0)return;let s=this.tables.get(e);if(!s)return;let o=[{name:"__rowId",type:"int64",dataType:"float64",primaryKey:!0},...s.schema.filter(u=>u.name!=="__rowId").map(u=>{let h=(u.dataType||u.type||"").toLowerCase();return h==="int64"||h==="bigint"?{...u,dataType:"int64"}:{...u,dataType:h==="float64"||h==="float32"||h==="int32"||h==="integer"||h==="real"||h==="double"?"float64":u.dataType||u.type||"float64"}})],i={};for(let u of o){let h=t[u.name];h&&(h instanceof Float64Array||h instanceof BigInt64Array?i[u.name]=h.subarray(0,r):i[u.name]=h.slice(0,r))}t.__length=0;let c=new he(o);c.setColumnarData(i);let f=c.build(),l=`${this.name}/${e}/frag_${Date.now()}_${Math.random().toString(36).slice(2)}.lance`;await L.save(l,f),s.fragments.push(l),await this._saveManifest(),await this._createVersion(e,"INSERT")}async delete(e,t){if(!this.tables.has(e))throw new Error(`Table '${e}' does not exist`);let r=this.tables.get(e),s=0,o=this._columnarBuffer.get(e),i=o?.__length||0;if(o&&i>0){let c=r.schema.map(f=>f.name);for(let f=0;f<i;f++){let l={__rowId:o.__rowId[f]};for(let u of c){let h=o[u][f];l[u]=Number.isNaN(h)?null:h}t(l)&&(r.deletionVector.includes(o.__rowId[f])||(r.deletionVector.push(o.__rowId[f]),s++))}}for(let c of r.fragments){let f=await L.load(c);if(f){let l=this._parseFragment(f,r.schema);for(let u of l)!r.deletionVector.includes(u.__rowId)&&t(u)&&(r.deletionVector.push(u.__rowId),s++)}}return r.rowCount-=s,r.version=(r.version||0)+1,await this._saveManifest(),s>0&&await this._createVersion(e,"DELETE"),{success:!0,deleted:s}}async update(e,t,r){if(!this.tables.has(e))throw new Error(`Table '${e}' does not exist`);let s=this.tables.get(e),o=0,i=this._writeBuffer.get(e);if(i&&i.length>0)for(let f of i)r(f)&&(Object.assign(f,t),o++);let c=[];for(let f of s.fragments){let l=await L.load(f);if(l){let u=this._parseFragment(l,s.schema);for(let h of u)if(!s.deletionVector.includes(h.__rowId)&&r(h)){s.deletionVector.push(h.__rowId),s.rowCount--;let d={...h,...t};delete d.__rowId,c.push(d),o++}}}return c.length>0?await this.insert(e,c):await this._saveManifest(),o>0&&c.length===0&&await this._createVersion(e,"UPDATE"),{success:!0,updated:o}}async updateWithExpr(e,t,r,s){if(!this.tables.has(e))throw new Error(`Table '${e}' does not exist`);let o=this.tables.get(e),i=0,c=this._columnarBuffer.get(e),f=c?.__length||0;if(c&&f>0){let u=o.schema.map(h=>h.name);for(let h=0;h<f;h++){let d={__rowId:c.__rowId[h]};for(let m of u){let w=c[m][h];d[m]=Number.isNaN(w)?null:w}if(r(d)){for(let[m,w]of Object.entries(t)){let p=s(w,d);c[m]!==void 0&&(c[m][h]=p??(c[m]instanceof Float64Array?NaN:null))}o.version=(o.version||0)+1,i++}}}let l=[];for(let u of o.fragments){let h=await L.load(u);if(h){let d=this._parseFragment(h,o.schema);for(let m of d)if(!o.deletionVector.includes(m.__rowId)&&r(m)){o.deletionVector.push(m.__rowId),o.rowCount--;let w={...m};for(let[p,y]of Object.entries(t))w[p]=s(y,m);delete w.__rowId,l.push(w),i++}}}return l.length>0?await this.insert(e,l):await this._saveManifest(),i>0&&l.length===0&&await this._createVersion(e,"UPDATE"),{success:!0,updated:i}}async select(e,t={}){if(!this.tables.has(e))throw new Error(`Table '${e}' does not exist`);let r=await this._readAllRows(e);if(t.where&&(r=r.filter(t.where)),t.orderBy){let{column:i,desc:c}=t.orderBy;r.sort((f,l)=>{let u=f[i]<l[i]?-1:f[i]>l[i]?1:0;return c?-u:u})}t.offset&&(r=r.slice(t.offset)),t.limit&&(r=r.slice(0,t.limit));let s=t.columns&&t.columns.length>0&&t.columns[0]!=="*"?t.columns:null,o=new Array(r.length);for(let i=0;i<r.length;i++){let c=r[i];if(s){let f={};for(let l of s)f[l]=c[l];o[i]=f}else{let{__rowId:f,...l}=c;o[i]=l}}return o}async _readAllRows(e){let t=this.tables.get(e),r=this._columnarBuffer.get(e),o=t.deletionVector.length>0?new Set(t.deletionVector):null,i=[];for(let f of t.fragments){let l=this.bufferPool.get(f),u=null;if(!l){let h=await L.load(f);h&&(l=te(h),l?this.bufferPool.set(f,l,h.byteLength):u=this._parseFragment(h,t.schema))}if(l&&!u&&(u=this._hydrateRowsFromBinary(l,t.schema)),u=u||[],!o)i.push(...u);else for(let h of u)o.has(h.__rowId)||i.push(h)}let c=r?.__length||0;if(r&&c>0){let f=t.schema.map(l=>l.name);for(let l=0;l<c;l++){if(o&&o.has(r.__rowId[l]))continue;let u={__rowId:r.__rowId[l]};for(let h of f){let d=r[h][l];u[h]=Number.isNaN(d)?null:d}i.push(u)}}return i}_hydrateRowsFromBinary(e,t){let{columns:r,rowCount:s}=e,o=t.map(c=>c.name),i=new Array(s);for(let c=0;c<s;c++){let f={__rowId:r.__rowId[c]};for(let l of o)r[l]&&(f[l]=r[l][c]);i[c]=f}return i}_parseFragment(e,t){try{let r=te(e);if(r)return this._parseBinaryColumnar(r);let s=K.decode(e),o=JSON.parse(s);return o.format==="json"&&o.columns?this._parseJsonColumnar(o):Array.isArray(o)?o:[o]}catch(r){return console.warn("[WorkerDatabase] Failed to parse fragment:",r),[]}}async selectColumnar(e){let t=this.tables.get(e);if(!t)return null;let r=this._columnarBuffer.get(e)?.__length||0,s=`${t.fragments.length}:${r}:${t.deletionVector.length}:${t.version||0}`,o=this._columnarCache.get(e);if(o&&o.version===s){let p={};for(let[y,E]of Object.entries(o.data.columns))ArrayBuffer.isView(E)?p[y]=new E.constructor(E.buffer,E.byteOffset,E.length):p[y]=E;return{schema:t.schema,columns:p,rowCount:o.data.rowCount}}let c=t.deletionVector.length>0?new Set(t.deletionVector):null,f={},l=t.schema.map(p=>p.name);for(let p of l)f[p]=[];f.__rowId=[];for(let p of t.fragments){let y=this.bufferPool.get(p);if(!y){let g=await L.load(p);if(!g)continue;y=te(g),y&&this.bufferPool.set(p,y,g.byteLength)}if(!y)continue;let{columns:E,rowCount:T}=y;if(c){let g=E.__rowId,R=[];for(let A=0;A<T;A++)c.has(g[A])||R.push(A);for(let A of l)if(E[A]){let b=E[A],I=new b.constructor(R.length);for(let C=0;C<R.length;C++)I[C]=b[R[C]];f[A].push(I)}}else{for(let g of l)E[g]&&f[g].push(E[g]);E.__rowId&&f.__rowId.push(E.__rowId)}}let u=this._columnarBuffer.get(e),h=u?.__length||0;if(u&&h>0)if(c){let p=[];for(let T=0;T<h;T++)c.has(u.__rowId[T])||p.push(T);let y=p.length;for(let T of t.schema){let g=u[T.name];if(g)if(g instanceof Float64Array){let R=new Float64Array(y);for(let A=0;A<y;A++)R[A]=g[p[A]];f[T.name].push(R)}else f[T.name].push(p.map(R=>g[R]))}let E=new Float64Array(y);for(let T=0;T<y;T++)E[T]=u.__rowId[p[T]];f.__rowId.push(E)}else{for(let y of t.schema){let E=u[y.name];if(E)if(E instanceof Float64Array){let T=new Float64Array(h);T.set(E.subarray(0,h)),f[y.name].push(T)}else f[y.name].push(E.slice(0,h))}let p=new Float64Array(h);p.set(u.__rowId.subarray(0,h)),f.__rowId.push(p)}let d={},m=0;for(let p of[...l,"__rowId"]){let y=f[p];if(y.length===0)d[p]=new Float64Array(0);else if(y.length===1)d[p]=y[0],m===0&&(m=y[0].length);else{let E=y.reduce((A,b)=>A+b.length,0);m===0&&(m=E);let T=y[0],g=ArrayBuffer.isView(T)?new T.constructor(E):new Array(E),R=0;for(let A of y){if(ArrayBuffer.isView(g))g.set(A,R);else for(let b=0;b<A.length;b++)g[R+b]=A[b];R+=A.length}d[p]=g}}let w={schema:t.schema,columns:d,rowCount:m};return this._columnarCache.set(e,{version:s,data:w}),w}async _readColumn(e,t){let r=this.tables.get(e);if(!r)return null;let s=this._writeBuffer.get(e),o=[];for(let l of r.fragments){let u=await L.load(l);if(!u)continue;let h=te(u);if(h&&h.columns[t]){let d=h.columns[t];d.length>0&&o.push(d)}}if(s&&s.length>0){let l=new Float64Array(s.length);for(let u=0;u<s.length;u++){let h=s[u][t];l[u]=typeof h=="number"?h:0}o.push(l)}if(o.length===0)return new Float64Array(0);if(o.length===1)return o[0];let i=o.reduce((l,u)=>l+u.length,0),c=new Float64Array(i),f=0;for(let l of o)c.set(l,f),f+=l.length;return c}_parseBinaryColumnar(e){let{schema:t,columns:r,rowCount:s}=e,o=new Array(s),i=t.map(l=>l.name),c=i.map(l=>r[l]),f=i.length;for(let l=0;l<s;l++){let u={};for(let h=0;h<f;h++)u[i[h]]=c[h][l]??null;o[l]=u}return o}_parseJsonColumnar(e){let{schema:t,columns:r,rowCount:s}=e,o=new Array(s),i=t.map(l=>l.name),c=i.map(l=>r[l]||[]),f=i.length;for(let l=0;l<s;l++){let u={};for(let h=0;h<f;h++)u[i[h]]=c[h][l]??null;o[l]=u}return o}getTable(e){return this.tables.get(e)}listTables(){return Array.from(this.tables.keys())}getFragmentPaths(e){let t=this.tables.get(e);return t?t.fragments:[]}getColumnIndex(e,t){let r=this.tables.get(e);if(!r)return-1;let s=r.schema.findIndex(o=>o.name===t);return s>=0?s+1:-1}hasBufferedData(e){let t=this._columnarBuffer.get(e);return t&&(t.__length||0)>0}async compact(){for(let[e,t]of this.tables){let r=await this._readAllRows(e);for(let s of t.fragments)await L.delete(s);if(t.fragments=[],t.deletionVector=[],t.rowCount=0,t.nextRowId=0,r.length>0){let s=r.map(({__rowId:o,...i})=>i);await this.insert(e,s)}}return{success:!0,compacted:this.tables.size}}async scanStart(e,t={}){if(!this.tables.has(e))throw new Error(`Table '${e}' does not exist`);let r=at++,s=this.tables.get(e),o=new Set(s.deletionVector),i=[];for(let f of s.fragments){let l=await L.load(f);if(l){let u=this._parseFragment(l,s.schema);for(let h of u)o.has(h.__rowId)||i.push(h)}}let c=this._writeBuffer.get(e);if(c)for(let f of c)o.has(f.__rowId)||i.push(f);return Ae.set(r,{rows:i,index:0,batchSize:t.batchSize||1e4,columns:t.columns}),r}scanNext(e){let t=Ae.get(e);if(!t)return{batch:[],done:!0};let r=[],s=Math.min(t.index+t.batchSize,t.rows.length);for(let i=t.index;i<s;i++){let c=t.rows[i],f;if(t.columns&&t.columns.length>0&&t.columns[0]!=="*"){f={};for(let l of t.columns)f[l]=c[l]}else{let{__rowId:l,...u}=c;f=u}r.push(f)}t.index=s;let o=t.index>=t.rows.length;return o&&Ae.delete(e),{batch:r,done:o}}};var fe=class{constructor(){this._root=null,this._ready=!1,this._kv={},this._encryptionKeyId=null,this._db=null}async open(e=null){if(this._ready)return this;if(e){let{keyId:t,keyBytes:r}=e;if(!W.has(t)){let s=await ae(r);W.set(t,s)}this._encryptionKeyId=t}try{let t=await navigator.storage.getDirectory();this._root=await t.getDirectoryHandle("vault",{create:!0}),await this._loadKV(),this._db=new z("vault"),await this._db.open(),this._ready=!0}catch(t){throw console.error("[WorkerVault] Failed to open OPFS:",t),t}return this}_getCryptoKey(){return this._encryptionKeyId?W.get(this._encryptionKeyId):null}async _loadKV(){try{let e=this._getCryptoKey(),t=e?"_vault.json.enc":"_vault.json",s=await(await this._root.getFileHandle(t)).getFile();if(e){let o=await s.arrayBuffer();this._kv=await ce(new Uint8Array(o),e)}else{let o=await s.text();this._kv=JSON.parse(o)}}catch(e){if(e.name==="NotFoundError")this._kv={};else throw e}}async _saveKV(){let e=this._getCryptoKey(),t=e?"_vault.json.enc":"_vault.json",s=await(await this._root.getFileHandle(t,{create:!0})).createWritable();if(e){let o=await ie(this._kv,e);await s.write(o)}else await s.write(JSON.stringify(this._kv));await s.close()}async get(e){return this._kv[e]}async set(e,t){this._kv[e]=t,await this._saveKV()}async delete(e){delete this._kv[e],await this._saveKV()}async keys(){return Object.keys(this._kv)}async has(e){return e in this._kv}};var it=1;var Ge={INT64:0,FLOAT64:1,INT32:2,FLOAT32:3,STRING:4,LIST:5},Ne=class{constructor(){this._registered=new Map}getLastError(){let e=M();if(!e)return"WASM not loaded";let t=k(),r=e.alloc(4096);console.log(`[WASM LOG] getLastError alloc ptr: ${r}`);let s=e.getLastError(r,4096);if(console.log(`[WASM LOG] getLastError len: ${s}`),s===0)return"Unknown Error";let o=new Uint8Array(t.buffer,r,s),i=new TextDecoder().decode(o);return console.log(`[WASM LOG] getLastError msg: ${i}`),i}getTableNames(e){let t=M();if(!t)throw new Error("WASM not loaded");let r=k(),s=new TextEncoder().encode(e),o=t.alloc(s.length);new Uint8Array(r.buffer,o,s.length).set(s);let i=t.getTableNames(o,s.length);if(i===0)return[];let c=new Uint8Array(r.buffer,i),f=0;for(;c[f]!==0&&f<1024;)f++;let l=new TextDecoder().decode(c.subarray(0,f));return l?l.split(",").filter(u=>u):[]}hasTable(e){let t=M();if(!t)return!1;let r=k(),s=new TextEncoder().encode(e),o=t.alloc(s.length);return new Uint8Array(r.buffer,o,s.length).set(s),t.hasTable(o,s.length)===1}registerTable(e,t,r,s=""){let o=M();if(!o)throw new Error("WASM not loaded");let i=this._registered.get(e);if(i&&i.version===s)return;if(i){let h=new TextEncoder().encode(e);o.clearTable(h,h.length)}let c=k(),f=new TextEncoder().encode(e),l=o.alloc(f.length);new Uint8Array(c.buffer,l,f.length).set(f);let u=new Set;for(let[h,d]of Object.entries(t)){if(h.startsWith("__"))continue;let m=new TextEncoder().encode(h),w=o.alloc(m.length);if(new Uint8Array(c.buffer,w,m.length).set(m),d instanceof Float64Array){let p=o.allocFloat64Buffer(d.length);new Float64Array(c.buffer,p,d.length).set(d),o.registerTableFloat64(l,f.length,w,m.length,p,d.length),u.add(h)}else if(d instanceof BigInt64Array){let p=o.allocInt64Buffer(d.length);new BigInt64Array(c.buffer,p,d.length).set(d),o.registerTableInt64(l,f.length,w,m.length,p,d.length),u.add(h)}else if(d instanceof Int32Array){let p=new Float64Array(d.length);for(let E=0;E<d.length;E++)p[E]=d[E];let y=o.allocFloat64Buffer(p.length);new Float64Array(c.buffer,y,p.length).set(p),o.registerTableFloat64(l,f.length,w,m.length,y,p.length),u.add(h)}else if(Array.isArray(d)){let p=new Uint32Array(d.length),y=new Uint32Array(d.length),E=0;for(let I=0;I<d.length;I++){let C=String(d[I]||"");y[I]=C.length,p[I]=E,E+=C.length}let T=new Uint8Array(E),g=0;for(let I=0;I<d.length;I++){let C=String(d[I]||""),V=new TextEncoder().encode(C);T.set(V,g),g+=V.length}let R=o.alloc(p.byteLength);new Uint32Array(c.buffer,R,p.length).set(p);let A=o.alloc(y.byteLength);new Uint32Array(c.buffer,A,y.length).set(y);let b=o.alloc(T.length);new Uint8Array(c.buffer,b,T.length).set(T),o.registerTableString(l,f.length,w,m.length,R,A,b,E,d.length),u.add(h)}}this._registered.set(e,{version:s,columns:u,rowCount:r})}registerTableFromFiles(e,t,r=""){let s=M();if(!s)throw new Error("WASM not loaded");let o=this._registered.get(e);if(o&&o.version===r)return;if(o){let l=new TextEncoder().encode(e);s.clearTable(l,l.length)}let i=new TextEncoder,c=i.encode(e),f=s.alloc(c.length);new Uint8Array(k().buffer,f,c.length).set(c);for(let l of t){let u=i.encode(l),h=s.alloc(u.length);new Uint8Array(k().buffer,h,u.length).set(u);let d=s.registerTableFromOPFS(f,c.length,h,u.length);d!==0&&console.warn(`Failed to register fragment ${l} for table ${e}: error ${d}`)}this._registered.set(e,{version:r,type:"files"})}appendTableMemory(e,t,r){let s=M();if(!s)throw new Error("WASM not loaded");let o=k(),i=new TextEncoder().encode(e),c=s.alloc(i.length);new Uint8Array(o.buffer,c,i.length).set(i);for(let[f,l]of Object.entries(t)){if(f.startsWith("__"))continue;let u=new TextEncoder().encode(f),h=s.alloc(u.length);if(new Uint8Array(o.buffer,h,u.length).set(u),l instanceof Float64Array){let d=s.allocFloat64Buffer(l.length);new Float64Array(o.buffer,d,l.length).set(l),s.appendTableMemory(c,i.length,h,u.length,d,4,r)}else if(l instanceof BigInt64Array){let d=s.allocInt64Buffer(l.length);new BigInt64Array(o.buffer,d,l.length).set(l),s.appendTableMemory(c,i.length,h,u.length,d,2,r)}else if(l instanceof Int32Array){let d=s.alloc(l.byteLength);new Int32Array(o.buffer,d,l.length).set(l),s.appendTableMemory(c,i.length,h,u.length,d,1,r)}else if(l instanceof Float32Array){let d=s.alloc(l.byteLength);new Float32Array(o.buffer,d,l.length).set(l),s.appendTableMemory(c,i.length,h,u.length,d,3,r)}}}execute(e){let t=M();if(!t)throw new Error("WASM not loaded");let r=k();if(t.setCurrentTimestamp)try{t.setCurrentTimestamp(BigInt(Date.now()))}catch(d){console.warn("setCurrentTimestamp failed:",d)}let s=t.getSqlInputBuffer(),o=t.getSqlInputBufferSize(),i=new TextEncoder().encode(e);if(i.length>o)throw new Error(`SQL too long: ${i.length} > ${o}`);new Uint8Array(r.buffer,s,i.length).set(i),t.setSqlInputLength(i.length);let c=t.executeSql();if(c===0){let d=this.getLastError();throw console.log(`[WASM LOG] execute throwing: "${d}"`),new Error(d)}let f=t.getResultSize(),l=this.getLastError();l&&l.length>0&&console.log(`[WASM DEBUG CAPTURED] ${l}`),l.length>0&&l.startsWith("DEBUG:");let u=t.memory.buffer,h=this._parseResult(r.buffer,c,f);return t.resetResult(),h}_parseResult(e,t,r){let s=new DataView(e,t,r),o=new TextDecoder;if(r>=40){let i=r-40,c=[s.getUint8(i+36),s.getUint8(i+37),s.getUint8(i+38),s.getUint8(i+39)];if(String.fromCharCode(...c)==="LANC")return this._parseLanceResult(e,t,r,i,s,o)}if(r>=36&&s.getUint32(0,!0)===it)return this._parseLegacyResult(e,t,r);throw new Error(`Invalid result format (Size: ${r}). Not a Lance file.`)}_parseLanceResult(e,t,r,s,o,i){let c=Number(o.getBigUint64(s+8,!0)),f=o.getUint32(s+28,!0),l=[],u={},h=0;for(let d=0;d<f;d++){let m=c+d*8,p=Number(o.getBigUint64(m,!0));o.getUint8(p++);let[y,E]=this._readVarint(o,p);p+=E;let T=new Uint8Array(e,t+p,y),g=i.decode(T);p+=y,l.push(g),o.getUint8(p++);let[R,A]=this._readVarint(o,p);p+=A;let b=new Uint8Array(e,t+p,R),I=i.decode(b);p+=R,o.getUint8(p++);let[C,V]=this._readVarint(o,p);p+=V,o.getUint8(p++);let ye=Number(o.getBigUint64(p,!0));p+=8,o.getUint8(p++);let[_,Q]=this._readVarint(o,p);p+=Q,h=_,o.getUint8(p++);let[Ee,nt]=this._readVarint(o,p);p+=nt;let Y=t+ye;if(I==="float64"||I==="int64"||I==="int32"||I==="float32")if(I==="float64"){let F=new Float64Array(e,Y,_).slice(),x=!1;for(let N=0;N<_;N++)if(Number.isNaN(F[N])){x=!0;break}if(x){console.log(`[WASM LOG] Column ${g} has NaNs, converting to nulls`);let N=new Array(_);for(let O=0;O<_;O++){let G=F[O];N[O]=Number.isNaN(G)?null:G}u[g]=N}else u[g]=F}else if(I==="int64"){let F=new BigInt64Array(e,Y,_),x=new Array(_),N=-9223372036854775808n;for(let O=0;O<_;O++){let G=F[O];x[O]=G===N?null:Number(G)}u[g]=x}else if(I==="int32"){let F=new Int32Array(e,Y,_),x=new Array(_);for(let N=0;N<_;N++){let O=F[N];O===-2147483648?x[N]=null:x[N]=O}u[g]=x}else{let F=new Float32Array(e,Y,_),x=new Array(_);for(let N=0;N<_;N++){let O=F[N];x[N]=isNaN(O)?null:O}u[g]=x}else if(I==="string"||I==="list"){let F=I==="list",x=(_+1)*4,N=Ee-x,O=new Uint8Array(e,Y,N).slice(),G=new Uint32Array(e,Y+N,_+1).slice();u[g]={_arrowString:!0,offsets:G,bytes:O,isList:I==="list",nullable:C===1}}}return{_format:"columnar",columns:l,rowCount:h,data:u}}_readVarint(e,t){let r=0,s=0,o=0;for(;;){let i=e.getUint8(t+o);if(o++,r|=(i&127)<<s,(i&128)===0)break;s+=7}return[r,o]}_parseLegacyResult(e,t,r){let s=new DataView(e,t,r),o=new TextDecoder,i=s.getUint32(4,!0),c=Number(s.getBigUint64(8,!0)),f=s.getUint32(24,!0),l=s.getUint32(32,!0),u=[],h={};for(let d=0;d<i;d++){let m=36+d*16,w=s.getUint32(m,!0),p=s.getUint32(m+4,!0),y=s.getUint32(m+8,!0),E=s.getUint32(m+12,!0),T=new Uint8Array(e,t+l+p,y),g=o.decode(T);u.push(g);let R=Object.keys(Ge).find(b=>Ge[b]===w).toLowerCase(),A=t+f+E;if(R==="float64"||R==="int64"||R==="int32"||R==="float32")R==="float64"?h[g]=new Float64Array(e,A,c).slice():R==="int64"?h[g]=new Float64Array(e,A,c).slice():R==="int32"?h[g]=new Int32Array(e,A,c).slice():R==="float32"&&(h[g]=new Float32Array(e,A,c).slice());else if(R==="string"||R==="list"){let b=new Uint32Array(c+1),I=0;b[0]=0;let C=A,V=0;for(let Q=0;Q<c;Q++){let Ee=s.getUint32(C+Q*8+4,!0);V+=Ee,b[Q+1]=V}let ye=A+c*8,_=new Uint8Array(e,ye,V).slice();h[g]={_arrowString:!0,offsets:b,bytes:_,isList:R==="list"}}}return{_format:"columnar",columns:u,rowCount:c,data:h}}clear(){let e=M();e&&e.clearTables(),this._registered.clear()}},Ie=null;function ne(){return Ie||(Ie=new Ne),Ie}var n={SELECT:"SELECT",DISTINCT:"DISTINCT",FROM:"FROM",WHERE:"WHERE",AND:"AND",OR:"OR",NOT:"NOT",ORDER:"ORDER",BY:"BY",ASC:"ASC",DESC:"DESC",LIMIT:"LIMIT",OFFSET:"OFFSET",AS:"AS",NULL:"NULL",IS:"IS",IN:"IN",BETWEEN:"BETWEEN",LIKE:"LIKE",TRUE:"TRUE",FALSE:"FALSE",GROUP:"GROUP",HAVING:"HAVING",QUALIFY:"QUALIFY",ROLLUP:"ROLLUP",CUBE:"CUBE",GROUPING:"GROUPING",SETS:"SETS",COUNT:"COUNT",SUM:"SUM",AVG:"AVG",MIN:"MIN",MAX:"MAX",NEAR:"NEAR",TOPK:"TOPK",FILE:"FILE",JOIN:"JOIN",INNER:"INNER",LEFT:"LEFT",RIGHT:"RIGHT",FULL:"FULL",OUTER:"OUTER",CROSS:"CROSS",ON:"ON",CREATE:"CREATE",TABLE:"TABLE",INSERT:"INSERT",INTO:"INTO",VALUES:"VALUES",UPDATE:"UPDATE",SET:"SET",DELETE:"DELETE",DROP:"DROP",IF:"IF",EXISTS:"EXISTS",VERSION:"VERSION",VERSIONS:"VERSIONS",SHOW:"SHOW",RESTORE:"RESTORE",TO:"TO",INT:"INT",INTEGER:"INTEGER",BIGINT:"BIGINT",FLOAT:"FLOAT",REAL:"REAL",DOUBLE:"DOUBLE",TEXT:"TEXT",VARCHAR:"VARCHAR",BOOLEAN:"BOOLEAN",BOOL:"BOOL",VECTOR:"VECTOR",PRIMARY:"PRIMARY",KEY:"KEY",WITH:"WITH",RECURSIVE:"RECURSIVE",UNION:"UNION",ALL:"ALL",PIVOT:"PIVOT",UNPIVOT:"UNPIVOT",FOR:"FOR",INTERSECT:"INTERSECT",EXCEPT:"EXCEPT",OVER:"OVER",PARTITION:"PARTITION",ROW_NUMBER:"ROW_NUMBER",RANK:"RANK",DENSE_RANK:"DENSE_RANK",NTILE:"NTILE",LAG:"LAG",LEAD:"LEAD",FIRST_VALUE:"FIRST_VALUE",LAST_VALUE:"LAST_VALUE",NTH_VALUE:"NTH_VALUE",PERCENT_RANK:"PERCENT_RANK",CUME_DIST:"CUME_DIST",ROWS:"ROWS",RANGE:"RANGE",UNBOUNDED:"UNBOUNDED",PRECEDING:"PRECEDING",FOLLOWING:"FOLLOWING",CURRENT:"CURRENT",ROW:"ROW",EXPLAIN:"EXPLAIN",ARRAY:"ARRAY",CASE:"CASE",WHEN:"WHEN",THEN:"THEN",ELSE:"ELSE",END:"END",CAST:"CAST",COALESCE:"COALESCE",NULLIF:"NULLIF",IDENTIFIER:"IDENTIFIER",NUMBER:"NUMBER",STRING:"STRING",STAR:"STAR",COMMA:"COMMA",DOT:"DOT",LPAREN:"LPAREN",RPAREN:"RPAREN",EQ:"EQ",NE:"NE",LT:"LT",LE:"LE",GT:"GT",GE:"GE",PLUS:"PLUS",MINUS:"MINUS",SLASH:"SLASH",LBRACKET:"LBRACKET",RBRACKET:"RBRACKET",EOF:"EOF"},ct={SELECT:n.SELECT,DISTINCT:n.DISTINCT,FROM:n.FROM,WHERE:n.WHERE,AND:n.AND,OR:n.OR,NOT:n.NOT,ORDER:n.ORDER,BY:n.BY,ASC:n.ASC,DESC:n.DESC,LIMIT:n.LIMIT,OFFSET:n.OFFSET,AS:n.AS,NULL:n.NULL,IS:n.IS,IN:n.IN,BETWEEN:n.BETWEEN,LIKE:n.LIKE,TRUE:n.TRUE,FALSE:n.FALSE,GROUP:n.GROUP,HAVING:n.HAVING,QUALIFY:n.QUALIFY,ROLLUP:n.ROLLUP,CUBE:n.CUBE,GROUPING:n.GROUPING,SETS:n.SETS,COUNT:n.COUNT,SUM:n.SUM,AVG:n.AVG,MIN:n.MIN,MAX:n.MAX,NEAR:n.NEAR,TOPK:n.TOPK,FILE:n.FILE,JOIN:n.JOIN,INNER:n.INNER,LEFT:n.LEFT,RIGHT:n.RIGHT,FULL:n.FULL,OUTER:n.OUTER,CROSS:n.CROSS,ON:n.ON,CREATE:n.CREATE,TABLE:n.TABLE,INSERT:n.INSERT,INTO:n.INTO,VALUES:n.VALUES,UPDATE:n.UPDATE,SET:n.SET,DELETE:n.DELETE,DROP:n.DROP,IF:n.IF,EXISTS:n.EXISTS,VERSION:n.VERSION,VERSIONS:n.VERSIONS,SHOW:n.SHOW,RESTORE:n.RESTORE,TO:n.TO,INT:n.INT,INTEGER:n.INTEGER,BIGINT:n.BIGINT,FLOAT:n.FLOAT,REAL:n.REAL,DOUBLE:n.DOUBLE,TEXT:n.TEXT,VARCHAR:n.VARCHAR,BOOLEAN:n.BOOLEAN,BOOL:n.BOOL,VECTOR:n.VECTOR,PRIMARY:n.PRIMARY,KEY:n.KEY,WITH:n.WITH,RECURSIVE:n.RECURSIVE,UNION:n.UNION,ALL:n.ALL,PIVOT:n.PIVOT,UNPIVOT:n.UNPIVOT,FOR:n.FOR,INTERSECT:n.INTERSECT,EXCEPT:n.EXCEPT,OVER:n.OVER,PARTITION:n.PARTITION,ROW_NUMBER:n.ROW_NUMBER,RANK:n.RANK,DENSE_RANK:n.DENSE_RANK,NTILE:n.NTILE,LAG:n.LAG,LEAD:n.LEAD,FIRST_VALUE:n.FIRST_VALUE,LAST_VALUE:n.LAST_VALUE,NTH_VALUE:n.NTH_VALUE,PERCENT_RANK:n.PERCENT_RANK,CUME_DIST:n.CUME_DIST,ROWS:n.ROWS,RANGE:n.RANGE,UNBOUNDED:n.UNBOUNDED,PRECEDING:n.PRECEDING,FOLLOWING:n.FOLLOWING,CURRENT:n.CURRENT,ROW:n.ROW,EXPLAIN:n.EXPLAIN,ARRAY:n.ARRAY,CASE:n.CASE,WHEN:n.WHEN,THEN:n.THEN,ELSE:n.ELSE,END:n.END,CAST:n.CAST,COALESCE:n.COALESCE,NULLIF:n.NULLIF},se=class{constructor(e){this.sql=e,this.pos=0,this.length=e.length}peek(){return this.pos>=this.length?"\0":this.sql[this.pos]}advance(){return this.pos<this.length?this.sql[this.pos++]:"\0"}skipWhitespace(){for(;this.pos<this.length&&/\s/.test(this.sql[this.pos]);)this.pos++}readIdentifier(){let e=this.pos;for(;this.pos<this.length&&/[a-zA-Z0-9_]/.test(this.sql[this.pos]);)this.pos++;return this.sql.slice(e,this.pos)}readNumber(){let e=this.pos,t=!1;for(;this.pos<this.length;){let r=this.sql[this.pos];if(r==="."&&!t)t=!0,this.pos++;else if(/\d/.test(r))this.pos++;else break}return this.sql.slice(e,this.pos)}readString(e){let t=this.pos;for(this.advance();this.pos<this.length;){if(this.sql[this.pos]===e){if(this.pos+1<this.length&&this.sql[this.pos+1]===e){this.pos+=2;continue}this.pos++;break}this.pos++}return this.sql.slice(t+1,this.pos-1).replace(new RegExp(e+e,"g"),e)}nextToken(){if(this.skipWhitespace(),this.pos>=this.length)return{type:n.EOF,value:null};let e=this.peek();if(/[a-zA-Z_]/.test(e)){let t=this.readIdentifier(),r=t.toUpperCase(),s=ct[r]||n.IDENTIFIER;return{type:s,value:s===n.IDENTIFIER?t:r}}if(/\d/.test(e)){let t=this.readNumber();return{type:n.NUMBER,value:t}}if(e==="'"||e==='"'){let t=this.readString(e);return{type:n.STRING,value:t}}switch(this.advance(),e){case"*":return{type:n.STAR,value:"*"};case",":return{type:n.COMMA,value:","};case".":return{type:n.DOT,value:"."};case"(":return{type:n.LPAREN,value:"("};case")":return{type:n.RPAREN,value:")"};case"+":return{type:n.PLUS,value:"+"};case"-":return{type:n.MINUS,value:"-"};case"/":return{type:n.SLASH,value:"/"};case"[":return{type:n.LBRACKET,value:"["};case"]":return{type:n.RBRACKET,value:"]"};case"=":return{type:n.EQ,value:"="};case"<":return this.peek()==="="?(this.advance(),{type:n.LE,value:"<="}):this.peek()===">"?(this.advance(),{type:n.NE,value:"<>"}):{type:n.LT,value:"<"};case">":return this.peek()==="="?(this.advance(),{type:n.GE,value:">="}):{type:n.GT,value:">"};case"!":if(this.peek()==="=")return this.advance(),{type:n.NE,value:"!="};throw new Error(`Unexpected character: ${e}`);default:throw new Error(`Unexpected character: ${e}`)}}tokenize(){let e=[],t;for(;(t=this.nextToken()).type!==n.EOF;)e.push(t);return e.push(t),e}};function U(a){return lt(a)}function lt(a){let e=Ke(a);for(;a.match(n.OR);){let t=Ke(a);e={type:"binary",op:"OR",left:e,right:t}}return e}function Ke(a){let e=be(a);for(;a.match(n.AND);){let t=be(a);e={type:"binary",op:"AND",left:e,right:t}}return e}function be(a){return a.match(n.NOT)?{type:"unary",op:"NOT",operand:be(a)}:ht(a)}function ht(a){let e=ue(a);if(a.match(n.IS)){let s=!!a.match(n.NOT);return a.expect(n.NULL),{type:"binary",op:s?"!=":"==",left:e,right:{type:"literal",value:null}}}if(a.match(n.IN)){if(a.expect(n.LPAREN),a.check(n.SELECT)){let o=a.parseSelect(!0);return a.expect(n.RPAREN),{type:"in",expr:e,values:[{type:"subquery",query:o}]}}let s=[];for(s.push(H(a));a.match(n.COMMA);)s.push(H(a));return a.expect(n.RPAREN),{type:"in",expr:e,values:s}}if(a.match(n.BETWEEN)){let s=ue(a);a.expect(n.AND);let o=ue(a);return{type:"between",expr:e,low:s,high:o}}if(a.match(n.LIKE)){let s=H(a);return{type:"like",expr:e,pattern:s}}if(a.match(n.NEAR)){let s=H(a);return{type:"near",column:e,value:s}}let t={[n.EQ]:"==",[n.NE]:"!=",[n.LT]:"<",[n.LE]:"<=",[n.GT]:">",[n.GE]:">="},r=a.match(n.EQ,n.NE,n.LT,n.LE,n.GT,n.GE);if(r){let s=ue(a);return{type:"binary",op:t[r.type],left:e,right:s}}return e}function ue(a){let e=He(a);for(;;){let t=a.match(n.PLUS,n.MINUS);if(!t)break;let r=He(a);e={type:"binary",op:t.value,left:e,right:r}}return e}function He(a){let e=_e(a);for(;;){let t=a.match(n.STAR,n.SLASH);if(!t)break;let r=_e(a);e={type:"binary",op:t.value,left:e,right:r}}return e}function _e(a){return a.match(n.MINUS)?{type:"unary",op:"-",operand:_e(a)}:H(a)}function H(a){if(a.match(n.NULL))return{type:"literal",value:null};if(a.match(n.TRUE))return{type:"literal",value:!0};if(a.match(n.FALSE))return{type:"literal",value:!1};if(a.match(n.ARRAY)){let t=Le(a);for(;a.check(n.LBRACKET);){a.advance();let r=U(a);a.expect(n.RBRACKET),t={type:"subscript",array:t,index:r}}return t}if(a.check(n.LBRACKET)){let t=Le(a);for(;a.check(n.LBRACKET);){a.advance();let r=U(a);a.expect(n.RBRACKET),t={type:"subscript",array:t,index:r}}return t}if(a.check(n.NUMBER)){let t=a.advance().value;return{type:"literal",value:parseFloat(t)}}if(a.check(n.STRING))return{type:"literal",value:a.advance().value};if([n.ROW_NUMBER,n.RANK,n.DENSE_RANK,n.NTILE,n.LAG,n.LEAD,n.FIRST_VALUE,n.LAST_VALUE,n.NTH_VALUE,n.PERCENT_RANK,n.CUME_DIST].some(t=>a.check(t))){let t=a.advance().type;a.expect(n.LPAREN);let r=[];if(!a.check(n.RPAREN))for(r.push(U(a));a.match(n.COMMA);)r.push(U(a));a.expect(n.RPAREN);let s=a.parseOverClause();return{type:"call",name:t,args:r,distinct:!1,over:s}}if(a.check(n.IDENTIFIER)||a.check(n.COUNT,n.SUM,n.AVG,n.MIN,n.MAX,n.GROUPING)){let t=a.advance().value;if(a.match(n.LPAREN)){let s=!!a.match(n.DISTINCT),o=[];if(!a.check(n.RPAREN))if(a.check(n.STAR))a.advance(),o.push({type:"star"});else for(o.push(U(a));a.match(n.COMMA);)o.push(U(a));a.expect(n.RPAREN);let i=null;return a.check(n.OVER)&&(i=a.parseOverClause()),{type:"call",name:t.toUpperCase(),args:o,distinct:s,over:i}}if(a.match(n.DOT)){let s=t,o=a.advance(),i=o.value||o.type.toLowerCase();return{type:"column",table:s,column:i}}let r={type:"column",column:t};if(a.check(n.LBRACKET)){a.advance();let s=U(a);a.expect(n.RBRACKET),r={type:"subscript",array:r,index:s}}return r}if(a.match(n.LPAREN)){if(a.check(n.SELECT)){let r=a.parseSelect(!0);return a.expect(n.RPAREN),{type:"subquery",query:r}}let t=U(a);return a.expect(n.RPAREN),t}if(a.match(n.STAR))return{type:"star"};throw new Error(`Unexpected token: ${a.current().type} (${a.current().value})`)}function de(a){if(a.match(n.NULL))return{type:"null",value:null};if(a.match(n.TRUE))return{type:"boolean",value:!0};if(a.match(n.FALSE))return{type:"boolean",value:!1};if(a.check(n.NUMBER)){let e=a.advance();return{type:"number",value:e.value.includes(".")?parseFloat(e.value):parseInt(e.value,10)}}if(a.check(n.STRING))return{type:"string",value:a.advance().value};if(a.check(n.MINUS)){a.advance();let e=a.expect(n.NUMBER);return{type:"number",value:e.value.includes(".")?-parseFloat(e.value):-parseInt(e.value,10)}}if(a.check(n.LBRACKET))return Le(a);throw new Error(`Expected value, got ${a.current().type}`)}function Le(a){a.expect(n.LBRACKET);let e=[];if(!a.check(n.RBRACKET))for(e.push(U(a));a.match(n.COMMA);)e.push(U(a));return a.expect(n.RBRACKET),{type:"array",elements:e}}function $e(a){a.expect(n.WITH);let e=!!a.match(n.RECURSIVE),t=[];do{let r=a.expect(n.IDENTIFIER).value,s=[];if(a.match(n.LPAREN)){for(s.push(a.expect(n.IDENTIFIER).value);a.match(n.COMMA);)s.push(a.expect(n.IDENTIFIER).value);a.expect(n.RPAREN)}a.expect(n.AS),a.expect(n.LPAREN);let o=ut(a,e);a.expect(n.RPAREN),t.push({name:r,columns:s,body:o,recursive:e})}while(a.match(n.COMMA));return t}function ut(a,e){let t=a.parseSelect(!0,!0);if(e&&a.match(n.UNION)){a.expect(n.ALL);let r=a.parseSelect(!0,!0);return{type:"RECURSIVE_CTE",anchor:t,recursive:r}}return t}function je(a){let e=[];do if(a.match(n.ROLLUP)){a.expect(n.LPAREN);let r=Se(a);a.expect(n.RPAREN),e.push({type:"ROLLUP",columns:r})}else if(a.match(n.CUBE)){a.expect(n.LPAREN);let r=Se(a);a.expect(n.RPAREN),e.push({type:"CUBE",columns:r})}else if(a.match(n.GROUPING)){a.expect(n.SETS),a.expect(n.LPAREN);let r=dt(a);a.expect(n.RPAREN),e.push({type:"GROUPING_SETS",sets:r})}else e.push({type:"COLUMN",column:a.expect(n.IDENTIFIER).value});while(a.match(n.COMMA));let t=null;return a.match(n.TOPK)&&(t=parseInt(a.expect(n.NUMBER).value,10)),{items:e,topK:t}}function dt(a){let e=[];do a.expect(n.LPAREN),a.check(n.RPAREN)?e.push([]):e.push(Se(a)),a.expect(n.RPAREN);while(a.match(n.COMMA));return e}function Se(a){let e=[a.expect(n.IDENTIFIER).value];for(;a.match(n.COMMA);)e.push(a.expect(n.IDENTIFIER).value);return e}function qe(a){a.expect(n.OVER),a.expect(n.LPAREN);let e={partitionBy:[],orderBy:[],frame:null};if(a.match(n.PARTITION))for(a.expect(n.BY),e.partitionBy.push(a.parseExpr());a.match(n.COMMA);)e.partitionBy.push(a.parseExpr());return a.match(n.ORDER)&&(a.expect(n.BY),e.orderBy=a.parseOrderByList()),(a.check(n.ROWS)||a.check(n.RANGE))&&(e.frame=pt(a)),a.expect(n.RPAREN),e}function pt(a){let t={type:a.advance().type,start:null,end:null};return a.match(n.BETWEEN)?(t.start=Oe(a),a.expect(n.AND),t.end=Oe(a)):(t.start=Oe(a),t.end={type:"CURRENT ROW"}),t}function Oe(a){if(a.match(n.UNBOUNDED)){if(a.match(n.PRECEDING))return{type:"UNBOUNDED PRECEDING"};if(a.match(n.FOLLOWING))return{type:"UNBOUNDED FOLLOWING"};throw new Error("Expected PRECEDING or FOLLOWING after UNBOUNDED")}if(a.match(n.CURRENT))return a.expect(n.ROW),{type:"CURRENT ROW"};if(a.check(n.NUMBER)){let e=parseInt(a.advance().value,10);if(a.match(n.PRECEDING))return{type:"PRECEDING",offset:e};if(a.match(n.FOLLOWING))return{type:"FOLLOWING",offset:e};throw new Error("Expected PRECEDING or FOLLOWING after number")}throw new Error("Invalid frame bound")}function Qe(a,e){a.expect(n.LPAREN);let t=e(a);if(t.type!=="call")throw new Error("PIVOT requires an aggregate function (e.g., SUM, COUNT, AVG)");a.expect(n.FOR);let r=a.expect(n.IDENTIFIER).value;a.expect(n.IN),a.expect(n.LPAREN);let s=[];for(s.push(e(a).value);a.match(n.COMMA);)s.push(e(a).value);return a.expect(n.RPAREN),a.expect(n.RPAREN),{aggregate:t,forColumn:r,inValues:s}}function Ye(a){a.expect(n.LPAREN);let e=a.expect(n.IDENTIFIER).value;a.expect(n.FOR);let t=a.expect(n.IDENTIFIER).value;a.expect(n.IN),a.expect(n.LPAREN);let r=[];for(r.push(a.expect(n.IDENTIFIER).value);a.match(n.COMMA);)r.push(a.expect(n.IDENTIFIER).value);return a.expect(n.RPAREN),a.expect(n.RPAREN),{valueColumn:e,nameColumn:t,inColumns:r}}function Je(a){let e=null,t=null,r=null,s=20,o="minilm";if(a.check(n.IDENTIFIER)){let i=a.advance().value;if(a.check(n.STRING)||a.check(n.NUMBER))e=i;else throw new Error(`NEAR requires quoted text or row number. Did you mean: NEAR '${i}'?`)}if(a.check(n.STRING))t=a.advance().value;else if(a.check(n.NUMBER))r=parseInt(a.advance().value,10);else throw new Error("NEAR requires a quoted text string or row number");return a.match(n.TOPK)&&(s=parseInt(a.expect(n.NUMBER).value,10)),{query:t,searchRow:r,column:e,topK:s,encoder:o}}var re=class{constructor(e){this.tokens=e,this.pos=0}current(){return this.tokens[this.pos]||{type:n.EOF}}advance(){return this.pos<this.tokens.length?this.tokens[this.pos++]:{type:n.EOF}}expect(e){let t=this.current();if(t.type!==e)throw new Error(`Expected ${e}, got ${t.type} (${t.value})`);return this.advance()}match(...e){return e.includes(this.current().type)?this.advance():null}check(...e){return e.includes(this.current().type)}parse(){if(this.check(n.EXPLAIN))return this.advance(),{type:"EXPLAIN",statement:this.parse()};let e=[];if(this.check(n.WITH)&&(e=$e(this)),this.check(n.SELECT)){let t=this.parseSelect();return t.ctes=e,t}else{if(this.check(n.INSERT))return this.parseInsert();if(this.check(n.UPDATE))return this.parseUpdate();if(this.check(n.DELETE))return this.parseDelete();if(this.check(n.CREATE))return this.parseCreateTable();if(this.check(n.DROP))return this.parseDropTable();if(this.check(n.SHOW))return this.parseShowVersions();if(this.check(n.RESTORE))return this.parseRestoreTable();throw new Error(`Unexpected token: ${this.current().type}. Expected SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, SHOW, RESTORE, or EXPLAIN`)}}parseSelect(e=!1,t=!1){this.expect(n.SELECT);let r=!!this.match(n.DISTINCT),s=this.parseSelectList(),o=null;this.match(n.FROM)&&(o=this.parseFromClause());let i=[];for(;this.check(n.JOIN)||this.check(n.INNER)||this.check(n.LEFT)||this.check(n.RIGHT)||this.check(n.FULL)||this.check(n.CROSS);)i.push(this.parseJoinClause());let c=null;this.match(n.PIVOT)&&(c=Qe(this,H));let f=null;this.match(n.UNPIVOT)&&(f=Ye(this));let l=null;this.match(n.WHERE)&&(l=this.parseExpr());let u=[],h=null;if(this.match(n.GROUP)){this.expect(n.BY);let y=je(this);u=y.items,h=y.topK}let d=null;this.match(n.HAVING)&&(d=this.parseExpr());let m=null;this.match(n.QUALIFY)&&(m=this.parseExpr());let w=null;this.match(n.NEAR)&&(w=Je(this));let p={type:"SELECT",distinct:r,columns:s,from:o,joins:i,pivot:c,unpivot:f,where:l,groupBy:u,groupByTopK:h,having:d,qualify:m,search:w,orderBy:[],limit:null,offset:null};if(!t&&(this.check(n.UNION)||this.check(n.INTERSECT)||this.check(n.EXCEPT))){let y=this.advance().type,E=!!this.match(n.ALL),T=this.parseSelect(!0,!0),g=[],R=null,A=null;if(this.match(n.ORDER)&&(this.expect(n.BY),g=this.parseOrderByList()),(this.match(n.LIMIT)||this.match(n.TOPK))&&(R=parseInt(this.expect(n.NUMBER).value,10)),g.length===0&&this.match(n.ORDER)&&(this.expect(n.BY),g=this.parseOrderByList()),this.match(n.OFFSET)&&(A=parseInt(this.expect(n.NUMBER).value,10)),!e&&this.current().type!==n.EOF)throw new Error(`Unexpected token after query: ${this.current().type} (${this.current().value}). Check your SQL syntax.`);return{type:"SET_OPERATION",operator:y,all:E,left:p,right:T,orderBy:g,limit:R,offset:A,groupByTopK:p.groupByTopK}}if(!t){let y=[],E=null,T=null;this.match(n.ORDER)&&(this.expect(n.BY),y=this.parseOrderByList()),(this.match(n.LIMIT)||this.match(n.TOPK))&&(E=parseInt(this.expect(n.NUMBER).value,10)),y.length===0&&this.match(n.ORDER)&&(this.expect(n.BY),y=this.parseOrderByList()),this.match(n.OFFSET)&&(T=parseInt(this.expect(n.NUMBER).value,10)),p.orderBy=y,p.limit=E,p.offset=T}if(!e&&this.current().type!==n.EOF)throw new Error(`Unexpected token after query: ${this.current().type} (${this.current().value}). Check your SQL syntax.`);return p}parseInsert(){this.expect(n.INSERT),this.expect(n.INTO);let e=this.expect(n.IDENTIFIER).value,t=null;if(this.match(n.LPAREN)){for(t=[],t.push(this.expect(n.IDENTIFIER).value);this.match(n.COMMA);)t.push(this.expect(n.IDENTIFIER).value);this.expect(n.RPAREN)}this.expect(n.VALUES);let r=[];do{this.expect(n.LPAREN);let s=[];for(s.push(de(this));this.match(n.COMMA);)s.push(de(this));this.expect(n.RPAREN),r.push(s)}while(this.match(n.COMMA));return{type:"INSERT",table:e,columns:t,rows:r}}parseUpdate(){this.expect(n.UPDATE);let e=this.expect(n.IDENTIFIER).value;this.expect(n.SET);let t=[];do{let s=this.expect(n.IDENTIFIER).value;this.expect(n.EQ);let o=de(this);t.push({column:s,value:o})}while(this.match(n.COMMA));let r=null;return this.match(n.WHERE)&&(r=this.parseExpr()),{type:"UPDATE",table:e,assignments:t,where:r}}parseDelete(){this.expect(n.DELETE),this.expect(n.FROM);let e=this.expect(n.IDENTIFIER).value,t=null;return this.match(n.WHERE)&&(t=this.parseExpr()),{type:"DELETE",table:e,where:t}}parseCreateTable(){this.expect(n.CREATE),this.expect(n.TABLE);let e=!1;this.match(n.IF)&&(this.expect(n.NOT),this.expect(n.EXISTS),e=!0);let t=this.expect(n.IDENTIFIER).value;this.expect(n.LPAREN);let r=[];do{let s=this.expect(n.IDENTIFIER).value,o="TEXT",i=!1,c=null;this.check(n.INT)||this.check(n.INTEGER)||this.check(n.BIGINT)?(this.advance(),o="INT64"):this.check(n.FLOAT)||this.check(n.REAL)||this.check(n.DOUBLE)?(this.advance(),o="FLOAT64"):this.check(n.TEXT)||this.check(n.VARCHAR)?(this.advance(),o="STRING"):this.check(n.BOOLEAN)||this.check(n.BOOL)?(this.advance(),o="BOOL"):this.check(n.VECTOR)&&(this.advance(),o="VECTOR",this.match(n.LPAREN)&&(c=parseInt(this.expect(n.NUMBER).value,10),this.expect(n.RPAREN))),this.match(n.PRIMARY)&&(this.expect(n.KEY),i=!0),r.push({name:s,dataType:o,primaryKey:i,vectorDim:c})}while(this.match(n.COMMA));return this.expect(n.RPAREN),{type:"CREATE_TABLE",table:t,columns:r,ifNotExists:e}}parseDropTable(){this.expect(n.DROP),this.expect(n.TABLE);let e=!1;return this.match(n.IF)&&(this.expect(n.EXISTS),e=!0),{type:"DROP_TABLE",table:this.expect(n.IDENTIFIER).value,ifExists:e}}parseSelectList(){let e=[this.parseSelectItem()];for(;this.match(n.COMMA);)e.push(this.parseSelectItem());return e}parseSelectItem(){if(this.match(n.STAR))return{type:"star"};let e=this.parseExpr(),t=null;return this.match(n.AS)?t=this.expect(n.IDENTIFIER).value:this.check(n.IDENTIFIER)&&!this.check(n.FROM,n.WHERE,n.ORDER,n.LIMIT,n.TOPK,n.GROUP,n.JOIN,n.INNER,n.LEFT,n.RIGHT,n.COMMA)&&(t=this.advance().value),{type:"expr",expr:e,alias:t}}parseFromClause(){let e=null;if(this.check(n.STRING))e={type:"url",url:this.advance().value};else if(this.check(n.IDENTIFIER)){let t=this.advance().value;if(this.match(n.LPAREN))if(t.toLowerCase()==="read_lance")e={type:"url",function:"read_lance"},this.check(n.RPAREN)||(this.match(n.FILE)?(e.isFile=!0,this.match(n.COMMA)&&(e.version=parseInt(this.expect(n.NUMBER).value,10))):this.check(n.STRING)&&(e.url=this.advance().value,this.match(n.COMMA)&&(e.version=parseInt(this.expect(n.NUMBER).value,10)))),this.expect(n.RPAREN);else throw new Error(`Unknown table function: ${t}. Supported: read_lance()`);else e={type:"table",name:t}}else throw new Error("Expected table name, URL string, or read_lance() after FROM");if(e&&(this.match(n.AS)?e.alias=this.expect(n.IDENTIFIER).value:this.check(n.IDENTIFIER)&&!this.check(n.WHERE,n.ORDER,n.LIMIT,n.TOPK,n.GROUP,n.NEAR,n.JOIN,n.INNER,n.LEFT,n.RIGHT,n.COMMA,n.VERSION)&&(e.alias=this.advance().value),this.match(n.VERSION))){this.expect(n.AS);let t=this.expect(n.IDENTIFIER);if(t.value.toUpperCase()!=="OF")throw new Error(`Expected OF after VERSION AS, got ${t.value}`);e.asOfVersion=parseInt(this.expect(n.NUMBER).value,10)}return e}parseJoinClause(){let e="INNER";this.match(n.INNER)?(this.expect(n.JOIN),e="INNER"):this.match(n.LEFT)?(this.match(n.OUTER),this.expect(n.JOIN),e="LEFT"):this.match(n.RIGHT)?(this.match(n.OUTER),this.expect(n.JOIN),e="RIGHT"):this.match(n.FULL)?(this.match(n.OUTER),this.expect(n.JOIN),e="FULL"):this.match(n.CROSS)?(this.expect(n.JOIN),e="CROSS"):this.expect(n.JOIN);let t=this.parseFromClause(),r=t.alias||null,s=null;return e!=="CROSS"&&(this.expect(n.ON),s=this.parseExpr()),{type:e,table:t,alias:r,on:s}}parseOrderByList(){let e=[this.parseOrderByItem()];for(;this.match(n.COMMA);)e.push(this.parseOrderByItem());return e}parseOrderByItem(){let e=this.expect(n.IDENTIFIER).value,t=!1;return this.match(n.DESC)?t=!0:this.match(n.ASC),{column:e,descending:t}}parseExpr(){return U(this)}parseOverClause(){return qe(this)}parseShowVersions(){return this.expect(n.SHOW),this.expect(n.VERSIONS),this.expect(n.FROM),{type:"SHOW_VERSIONS",table:this.expect(n.IDENTIFIER).value}}parseRestoreTable(){this.expect(n.RESTORE),this.expect(n.TABLE);let e=this.expect(n.IDENTIFIER).value;this.expect(n.TO),this.expect(n.VERSION);let t=parseInt(this.expect(n.NUMBER).value,10);return{type:"RESTORE_TABLE",table:e,version:t}}};async function ze(a,e){if(!B&&(await oe(),!B))throw new Error("WASM not loaded");let t=ne(),r=t.getTableNames(e);for(let s of r){if(t.hasTable(s))continue;let i=a.tables.get(s);if(!i)continue;let c=a._columnarBuffer?.get(s),f=c?.__length||0,l=`${s}:${i.fragments?.length||0}:${f}:${i.deletionVector?.length||0}`,u=i.fragments.length>0,h=f>0;if(u){let d=[];for(let m of i.fragments){let w=await wt(m);w&&d.push(w)}if(t.registerTableFromFiles(s,i.fragments,l),h){let m={};for(let w of i.schema){let p=c[w.name];p&&ArrayBuffer.isView(p)&&(m[w.name]=p.subarray(0,f))}t.appendTableMemory(s,m,f)}}else if(h){let d=await a.selectColumnar(s);if(d){let{columns:m,rowCount:w}=d;t.registerTable(s,m,w,l)}}}return t.execute(e)}var B=null,q=null,Z=new Map,yt=1;async function tt(a){let e=await navigator.storage.getDirectory();e=await e.getDirectoryHandle("lanceql",{create:!0});for(let t of a)e=await e.getDirectoryHandle(t,{create:!0});return e}function Et(){return{env:{opfs_open:(a,e)=>{try{let t=new Uint8Array(q.buffer,a,e),r=new TextDecoder().decode(t);for(let[s,o]of Z.entries())if(o._path===r)return s;return console.warn("[LanceQLWorker] WASM tried to open unregistered path:",r),0}catch(t){return console.error("[LanceQLWorker] Error:",t),0}},opfs_read:(a,e,t,r)=>{let s=Z.get(a);if(!s)return 0;try{let o=new Uint8Array(q.buffer,e,t);return s.read(o,{at:Number(r)})}catch{return 0}},opfs_size:a=>{let e=Z.get(a);if(!e)return BigInt(0);try{return BigInt(e.getSize())}catch{return BigInt(0)}},opfs_close:a=>{},__assert_fail:(a,e,t,r)=>{let o=new TextDecoder().decode(new Uint8Array(q.buffer,a).subarray(0,100));console.error(`[WASM ASSERT] ${o} at line ${t}`)},js_log:(a,e)=>{let r=new TextDecoder().decode(new Uint8Array(q.buffer,a,e));console.log(`[WASM LOG] ${r}`);for(let s of Fe)s.postMessage({type:"log",message:r,marker:"__WASM_LOG_BRIDGE__"})}}}}async function wt(a){try{let e=a.split("/").filter(c=>c),t=e.pop(),o=await(await(await tt(e)).getFileHandle(t)).createSyncAccessHandle(),i=yt++;return o._path=a,Z.set(i,o),i}catch(e){return console.warn("[LanceQLWorker] Failed to register OPFS file:",a,e),0}}function hn(a){let e=Z.get(a);if(e){try{e.close()}catch{}Z.delete(a)}}async function oe(){if(B)return B;try{let a=new URL("./lanceql.wasm",import.meta.url);a.searchParams.set("v",Date.now().toString());let t=await(await fetch(a)).arrayBuffer(),r=Et();return B=(await WebAssembly.instantiate(t,r)).instance.exports,q=B.memory,console.log("[LanceQLWorker] WASM loaded with OPFS support"),B}catch(a){return console.warn("[LanceQLWorker] WASM not available:",a.message),null}}function M(){return B}function k(){return q}var xe=0,Xe=0,gt=1024*1024;function Tt(a){if(!B)return 0;if(a<=Xe&&xe!==0)return xe;let e=Math.max(a,gt),t=B.alloc(e);return t&&(xe=t,Xe=e),t}async function fn(a){let e=await oe();if(!e)return 0;try{let t=a.split("/").filter(h=>h),r=t.pop(),i=await(await(await tt(t)).getFileHandle(r)).createSyncAccessHandle(),c=i.getSize(),f=Tt(c);if(!f)return i.close(),0;let l=new Uint8Array(q.buffer,f,c),u=i.read(l,{at:0});return i.close(),u!==c?0:e.openFile(f,c)}catch(t){return console.warn("[LanceQLWorker] Failed to load fragment:",a,t),0}}async function Rt(a,e){let t=e.split("/").filter(s=>s),r=a;for(let s=0;s<t.length-1;s++)r=await r.getDirectoryHandle(t[s],{create:!1});return await r.getFileHandle(t[t.length-1],{create:!1})}var Ce=null;async function At(a){let e=Be.get(a);if(e)return e;Ce||(Ce=await navigator.storage.getDirectory());let s=await(await(await Rt(Ce,a)).getFile()).arrayBuffer();return e=new Uint8Array(s),e&&Be.set(a,e,e.byteLength),e}async function un(a,e,t){if(!await At(a))return null;let s=B;switch(t){case"sum":return s.opfsSumFloat64Column(e);case"min":return s.opfsMinFloat64Column(e);case"max":return s.opfsMaxFloat64Column(e);case"avg":return s.opfsAvgFloat64Column(e);case"count":return Number(s.opfsCountRows());default:return null}}oe();var Be=new J,ve=new Map,Ue=new Map,pe=null,Fe=new Set,X=null,j=0,It=1024,me=new Map,Ze=1;async function $(a=null){return pe||(pe=new fe),await pe.open(a),pe}async function v(a,e={},t=null){let r=t?.keyId||"none",s=`${a}:${r}:${JSON.stringify(e)}`;if(!ve.has(s)){let o=new le(a,e);await o.open(t),ve.set(s,o)}return ve.get(s)}async function S(a){if(!Ue.has(a)){let e=new z(a,Be);await e.open(),Ue.set(a,e)}return Ue.get(a)}function Nt(a,e,t){if(t&&t._format==="wasm_binary"){a.postMessage({id:e,result:{_format:"wasm_binary",buffer:t.buffer,columns:t.columns,rowCount:t.rowCount,schema:t.schema}},[t.buffer]);return}if(t&&t._format==="columnar"&&t.data){let r=t.columns,s=t.rowCount;if(s<1e5){let m=[],w={},p=new Set;for(let y of r){let E=t.data[y];if(ArrayBuffer.isView(E)){let T=E.byteOffset!==0||E.byteLength<E.buffer.byteLength,g=p.has(E.buffer);if(T||g){let R=new E.constructor(E);w[y]=R,m.push(R.buffer)}else w[y]=E,m.push(E.buffer),p.add(E.buffer)}else E&&E._arrowString?(w[y]=E,E.offsets&&E.offsets.buffer&&!p.has(E.offsets.buffer)&&(m.push(E.offsets.buffer),p.add(E.offsets.buffer)),E.bytes&&E.bytes.buffer&&!p.has(E.bytes.buffer)&&(m.push(E.bytes.buffer),p.add(E.bytes.buffer))):w[y]=E}a.postMessage({id:e,result:{_format:"columnar",columns:r,rowCount:s,data:w}},m);return}let o=[],i=[],c=0;for(let m of r){let w=t.data[m];ArrayBuffer.isView(w)?(o.push({name:m,arr:w}),c+=w.byteLength):Array.isArray(w)&&i.push({name:m,arr:w})}let f=c>0?new ArrayBuffer(c):null,l={},u=0;if(f){let m=new Uint8Array(f);for(let{name:w,arr:p}of o){let y=new Uint8Array(p.buffer,p.byteOffset,p.byteLength);m.set(y,u),l[w]={offset:u,length:p.length,type:p.constructor.name},u+=p.byteLength}}let h={};for(let{name:m,arr:w}of i)h[m]=w;let d=[];f&&d.push(f),a.postMessage({id:e,result:{_format:"packed",columns:r,rowCount:s,packedBuffer:f,colOffsets:l,stringData:h}},d);return}if(X&&t!==void 0){let r=JSON.stringify(t);if(r.length>It){let s=P.encode(r);if(j+s.length<=X.byteLength){new Uint8Array(X,j,s.length).set(s),a.postMessage({id:e,sharedOffset:j,sharedLength:s.length}),j+=s.length,j>X.byteLength/2&&(j=0);return}}}a.postMessage({id:e,result:t})}async function et(a,e){if(e.type==="initSharedBuffer"){X=e.buffer,j=0,console.log("[LanceQLWorker] SharedArrayBuffer initialized:",X.byteLength,"bytes");return}let{id:t,method:r,args:s}=e;try{let o;if(r==="ping")o="pong";else if(r==="open")await v(s.name,s.options,s.encryption),o=!0;else if(r==="get")o=await(await v(s.name)).get(s.key);else if(r==="set")await(await v(s.name)).set(s.key,s.value),o=!0;else if(r==="delete")await(await v(s.name)).delete(s.key),o=!0;else if(r==="keys")o=await(await v(s.name)).keys();else if(r==="clear")await(await v(s.name)).clear(),o=!0;else if(r==="filter")o=await(await v(s.name)).filter(s.key,s.query);else if(r==="find")o=await(await v(s.name)).find(s.key,s.query);else if(r==="search")o=await(await v(s.name)).search(s.key,s.text,s.limit);else if(r==="count")o=await(await v(s.name)).count(s.key,s.query);else if(r==="enableSemanticSearch")o=await(await v(s.name)).enableSemanticSearch(s.options);else if(r==="disableSemanticSearch")(await v(s.name)).disableSemanticSearch(),o=!0;else if(r==="hasSemanticSearch")o=(await v(s.name)).hasSemanticSearch();else if(r==="db:open")console.log(`[LanceQLWorker] db:open ${s.name}`),await S(s.name),o=!0;else if(r==="db:createTable")console.log(`[LanceQLWorker] db:createTable ${s.tableName}`),o=await(await S(s.db)).createTable(s.tableName,s.columns,s.ifNotExists),console.log(`[LanceQLWorker] db:createTable ${s.tableName} done`);else if(r==="db:dropTable"){console.log(`[LanceQLWorker] db:dropTable ${s.tableName}`),o=await(await S(s.db)).dropTable(s.tableName,s.ifExists);let c=P.encode(s.tableName);ne().clearTable(c,c.length)}else if(r==="db:insert")console.log(`[LanceQLWorker] db:insert into ${s.tableName}, rows: ${s.rows?.length}`),o=await(await S(s.db)).insert(s.tableName,s.rows),console.log("[LanceQLWorker] db:insert done");else if(r==="db:delete"){let i=await S(s.db),c=s.where?f=>evalWhere(s.where,f):()=>!0;o=await i.delete(s.tableName,c)}else if(r==="db:update"){let i=await S(s.db),c=s.where?f=>evalWhere(s.where,f):()=>!0;o=await i.update(s.tableName,s.updates,c)}else if(r==="db:select"){let i=await S(s.db),c={...s.options};s.where&&(c.where=f=>evalWhere(s.where,f)),o=await i.select(s.tableName,c)}else if(r==="db:exec"){let i=await S(s.db),f=new se(s.sql).tokenize(),u=new re(f).parse();if(u.type==="SHOW_VERSIONS"){let h=await i.listVersions(u.table);o={_format:"columnar",columns:["version","timestamp","operation","rowCount"],rowCount:h.length,data:{version:new Float64Array(h.map(d=>d.version)),timestamp:h.map(d=>new Date(d.timestamp).toISOString()),operation:h.map(d=>d.operation),rowCount:new Float64Array(h.map(d=>d.rowCount))}}}else if(u.type==="RESTORE_TABLE"){let h=await i.restoreToVersion(u.table,u.version);o={_format:"columnar",columns:["status","newVersion"],rowCount:1,data:{status:["restored"],newVersion:new Float64Array([h.newVersion])}}}else if(u.type==="SELECT"&&u.from?.asOfVersion){let h=await i.selectAtVersion(u.from.name||u.from.table,u.from.asOfVersion,{limit:u.limit,offset:u.offset});if(h.length>0){let d=Object.keys(h[0]),m={};for(let w of d)m[w]=h.map(p=>p[w]);o={_format:"columnar",columns:d,rowCount:h.length,data:m}}else o={_format:"columnar",columns:[],rowCount:0,data:{}}}else{let d=ne().getTableNames(s.sql),m=d[0]?i.tables.get(d[0]):null,w=m?m.rowCount:0;o=await ze(i,s.sql)}if(o&&o._format==="columnar"&&o.rowCount>=1e5){let h=Ze++;me.set(h,o),o={_format:"cursor",cursorId:h,columns:o.columns,rowCount:o.rowCount}}}else if(r==="cursor:fetch"){let i=me.get(s.cursorId);if(!i)throw new Error("Cursor not found");o=i,me.delete(s.cursorId)}else if(r==="db:flush")console.log(`[LanceQLWorker] db:flush ${s.db}`),await(await S(s.db)).flush(),console.log(`[LanceQLWorker] db:flush ${s.db} done`),o=!0;else if(r==="db:compact")o=await(await S(s.db)).compact();else if(r==="db:listTables")o=(await S(s.db)).listTables();else if(r==="db:getTable")o=(await S(s.db)).getTable(s.tableName);else if(r==="db:scanStart")o=await(await S(s.db)).scanStart(s.tableName,s.options);else if(r==="db:scanNext")o=(await S(s.db)).scanNext(s.streamId);else if(r==="db:listVersions")o=await(await S(s.db)).listVersions(s.tableName);else if(r==="db:selectAtVersion"){let i=await S(s.db),c={...s.options};s.where&&(c.where=f=>evalWhere(s.where,f)),o=await i.selectAtVersion(s.tableName,s.version,c)}else if(r==="db:restoreTable")o=await(await S(s.db)).restoreToVersion(s.tableName,s.version);else if(r==="vault:open")await $(s.encryption),o=!0;else if(r==="vault:get")o=await(await $()).get(s.key);else if(r==="vault:set")await(await $()).set(s.key,s.value),o=!0;else if(r==="vault:delete")await(await $()).delete(s.key),o=!0;else if(r==="vault:keys")o=await(await $()).keys();else if(r==="vault:has")o=await(await $()).has(s.key);else if(r==="vault:exec"){let c=(await $())._db,l=new se(s.sql).tokenize(),h=new re(l).parse();if(h.type==="SHOW_VERSIONS"){let d=await c.listVersions(h.table);o={_format:"columnar",columns:["version","timestamp","operation","rowCount"],rowCount:d.length,data:{version:new Float64Array(d.map(m=>m.version)),timestamp:d.map(m=>new Date(m.timestamp).toISOString()),operation:d.map(m=>m.operation),rowCount:new Float64Array(d.map(m=>m.rowCount))}}}else if(h.type==="RESTORE_TABLE"){let d=await c.restoreToVersion(h.table,h.version);o={_format:"columnar",columns:["status","newVersion"],rowCount:1,data:{status:["restored"],newVersion:new Float64Array([d.newVersion])}}}else if(h.type==="SELECT"&&h.from?.asOfVersion){let d=await c.selectAtVersion(h.from.name||h.from.table,h.from.asOfVersion,{limit:h.limit,offset:h.offset});if(d.length>0){let m=Object.keys(d[0]),w={};for(let p of m)w[p]=d.map(y=>y[p]);o={_format:"columnar",columns:m,rowCount:d.length,data:w}}else o={_format:"columnar",columns:[],rowCount:0,data:{}}}else{let m=ne().getTableNames(s.sql),w=m[0]?c.tables.get(m[0]):null,p=w?w.rowCount:0;o=await ze(c,s.sql)}if(o&&o._format==="columnar"&&o.rowCount>=1e5){let d=Ze++;me.set(d,o),o={_format:"cursor",cursorId:d,columns:o.columns,rowCount:o.rowCount}}}else throw new Error(`Unknown method: ${r}`);Nt(a,t,o)}catch(o){a.postMessage({id:t,error:o.stack||o.message})}}var bt=typeof SharedWorkerGlobalScope<"u"&&self instanceof SharedWorkerGlobalScope;bt?self.onconnect=a=>{let e=a.ports[0];Fe.add(e),e.onmessage=t=>{et(e,t.data)},e.onmessageerror=t=>{console.error("[LanceQLWorker] Message error:",t)},oe().then(()=>{e.postMessage({type:"ready"})}).catch(t=>{console.error("[LanceQLWorker] Failed to load WASM:",t),e.postMessage({type:"ready",error:"WASM load failed"})}),e.start(),console.log("[LanceQLWorker] New connection, total ports:",Fe.size)}:(self.onmessage=a=>{et(self,a.data)},oe().then(()=>{self.postMessage({type:"ready"})}).catch(a=>{console.error("[LanceQLWorker] Failed to load WASM:",a),self.postMessage({type:"ready",error:"WASM load failed"})}));console.log("[LanceQLWorker] Initialized");export{hn as closeOPFSFile,M as getWasm,k as getWasmMemory,fn as loadFragmentToWasm,wt as registerOPFSFile,un as wasmAggregate};
//# sourceMappingURL=lanceql-worker.js.map
