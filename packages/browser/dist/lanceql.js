var et=Object.defineProperty;var _e=Object.getOwnPropertyDescriptor;var Ie=Object.getOwnPropertyNames;var Ae=Object.prototype.hasOwnProperty;var xe=(o,e,t)=>e in o?et(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var Ce=(o,e)=>{for(var t in e)et(o,t,{get:e[t],enumerable:!0})},Fe=(o,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Ie(e))!Ae.call(o,s)&&s!==t&&et(o,s,{get:()=>e[s],enumerable:!(n=_e(e,s))||n.enumerable});return o};var Te=o=>Fe(et({},"__esModule",{value:!0}),o);var Ut=(o,e,t)=>xe(o,typeof e!="symbol"?e+"":e,t);var on={};Ce(on,{LanceQL:()=>at,LocalDatabase:()=>ct,RemoteLanceDataset:()=>j,TableRef:()=>K,Vault:()=>q,default:()=>dt,vault:()=>dt});module.exports=Te(on);var Ee={},V=null,ut=null,Se=0,ht=new Map,nt="clone",H=null,Pe=16*1024*1024;function Re(){try{if(typeof SharedArrayBuffer<"u"&&typeof crossOriginIsolated<"u"&&crossOriginIsolated)return H=new SharedArrayBuffer(Pe),nt="sharedBuffer",console.log("[LanceQL] Using SharedArrayBuffer (zero-copy)"),!0}catch{}try{let o=new ArrayBuffer(8);return typeof ArrayBuffer.prototype.transfer<"u",nt="transfer",console.log("[LanceQL] Using Transferable ArrayBuffers"),!1}catch{}return nt="clone",console.log("[LanceQL] Using structured clone (fallback)"),!1}function Ue(){return V||(Re(),ut=new Promise((o,e)=>{console.log("[LanceQL] Using regular Worker for better logging");try{V=new Worker(new URL("./lanceql-worker.js?v="+Date.now(),Ee.url),{type:"module",name:"lanceql"}),V.onmessage=t=>{Be(t.data,V,o)},V.onerror=t=>{console.error("[LanceQL] Worker error:",t),e(t)},H&&V.postMessage({type:"initSharedBuffer",buffer:H})}catch(t){console.error("[LanceQL] Failed to create Worker:",t),e(t)}})),ut}function Be(o,e,t){if(console.log("[LanceQL] Incoming worker message:",o.type||(o.id!==void 0?"RPC reply":"unknown")),o.type==="ready"){t(e);return}if(o.type==="log"){console.log(o.message);return}if(o.id!==void 0){let n=ht.get(o.id);if(n)if(ht.delete(o.id),o.sharedOffset!==void 0&&H){let s=new Uint8Array(H,o.sharedOffset,o.sharedLength),r=JSON.parse(new TextDecoder().decode(s));n.resolve(r)}else if(o.error)n.reject(new Error(o.error));else{let s=o.result;if(s&&s._format==="cursor"){let{cursorId:r,columns:i,rowCount:a}=s;s={_format:"columnar",columns:i,rowCount:a,_cursorId:r,_fetched:!1},Object.defineProperty(s,"data",{configurable:!0,enumerable:!0,get(){return this._fetched||console.warn("Cursor data accessed - fetching from worker"),{}}}),Object.defineProperty(s,"rows",{configurable:!0,enumerable:!0,get(){return[]}})}else if(s&&s._format==="wasm_binary"){let r=-9223372036854775808n,{buffer:i,columns:a,rowCount:c,schema:u}=s,l=new DataView(i),f=new Uint8Array(i),h=32,d=24,m={};for(let g=0;g<a.length;g++){let b=h+g*d,p=l.getUint32(b,!0),w=l.getUint32(b+8,!0),y=Number(l.getBigUint64(b+12,!0)),_=l.getUint32(b+20,!0),I=a[g];if(p<=3){let A=y/_;p===0?m[I]=new BigInt64Array(i,w,A):p===1?m[I]=new Float64Array(i,w,A):p===2?m[I]=new Int32Array(i,w,A):p===3&&(m[I]=new Float32Array(i,w,A))}else{let A=w,x=new Uint32Array(i,A,c),F=w+c*4,C=y-c*4,B=f.subarray(F,F+C),v=new TextDecoder,E=new Array(c),R=!1;m[I]=new Proxy(E,{get(U,L){if(L==="length")return c;if(typeof L=="string"&&!isNaN(L)){if(!R){for(let P=0;P<c;P++){let lt=x[P],ft=P<c-1?x[P+1]:C;U[P]=v.decode(B.subarray(lt,ft))}R=!0}return U[+L]}if(L===Symbol.iterator){if(!R){for(let P=0;P<c;P++){let lt=x[P],ft=P<c-1?x[P+1]:C;U[P]=v.decode(B.subarray(lt,ft))}R=!0}return()=>U[Symbol.iterator]()}return U[L]}})}}s={_format:"columnar",columns:a,rowCount:c,data:m},Object.defineProperty(s,"rows",{configurable:!0,enumerable:!0,get(){let g=new Array(c),b=a.map(p=>m[p]);for(let p=0;p<c;p++){let w={};for(let y=0;y<a.length;y++){let _=b[y][p];(_===r||typeof _=="number"&&isNaN(_))&&(_=null),w[a[y]]=_}g[p]=w}return Object.defineProperty(this,"rows",{value:g,writable:!1}),g}})}else if(s&&s._format==="packed"){let{columns:r,rowCount:i,packedBuffer:a,colOffsets:c,stringData:u}=s,l={...u||{}};if(a&&c){let f={Float64Array,Float32Array,Int32Array,Int16Array,Int8Array,Uint32Array,Uint16Array,Uint8Array,BigInt64Array,BigUint64Array};for(let[h,d]of Object.entries(c)){let m=f[d.type]||Float64Array;l[h]=new m(a,d.offset,d.length)}}s.data=l,s._format="columnar",Object.defineProperty(s,"rows",{configurable:!0,enumerable:!0,get(){let f=new Array(i),h=r.map(d=>l[d]);for(let d=0;d<i;d++){let m={};for(let g=0;g<r.length;g++)m[r[g]]=h[g][d];f[d]=m}return Object.defineProperty(this,"rows",{value:f,writable:!1}),f}})}else if(s&&s._format==="columnar"){let{columns:r,rowCount:i,data:a}=s;for(let c of r){let u=a[c];if(u&&u._arrowString){let{offsets:l,bytes:f,isList:h,nullable:d}=u;h&&console.log(`[WorkerRPC] Column ${c} is list mode`);let m=new TextDecoder,g=new Array(i),b=!1;a[c]=new Proxy(g,{get(p,w){if(w==="length")return i;if(typeof w=="string"&&!isNaN(w)){if(!b&&f&&l){for(let y=0;y<i;y++){let _=l[y],I=l[y+1];if(d&&_===I){p[y]=null;continue}let A=m.decode(f.subarray(_,I));try{p[y]=h?JSON.parse(A):A}catch{p[y]=A}}b=!0}return p[+w]}if(w===Symbol.iterator){if(!b&&f&&l){for(let y=0;y<i;y++){let _=l[y],I=l[y+1];if(d&&_===I){p[y]=null;continue}let A=m.decode(f.subarray(_,I));try{p[y]=h?JSON.parse(A):A}catch{p[y]=A}}b=!0}return()=>p[Symbol.iterator]()}return p[w]}})}}Object.defineProperty(s,"rows",{configurable:!0,enumerable:!0,get(){let c=new Array(i),u=r.map(l=>a[l]);for(let l=0;l<i;l++){let f={};for(let h=0;h<r.length;h++)f[r[h]]=u[h][l];c[l]=f}return Object.defineProperty(this,"rows",{value:c,writable:!1}),c}})}n.resolve(s)}}}async function T(o,e){let t=await Ue(),n=++Se;return new Promise((s,r)=>{ht.set(n,{resolve:s,reject:r});let i=[];if(nt==="transfer"&&e)for(let a of Object.keys(e)){let c=e[a];c instanceof ArrayBuffer?i.push(c):ArrayBuffer.isView(c)&&i.push(c.buffer)}i.length>0?t.postMessage({id:n,method:o,args:e},i):t.postMessage({id:n,method:o,args:e})})}var Bt=new Uint8Array([76,65,78,67]);var $=class o{constructor(){this.chunks=[]}static encodeVarint(e){let t=[],n=typeof e=="bigint"?e:BigInt(e);for(;n>0x7fn;)t.push(Number(n&0x7fn)|128),n>>=7n;return t.push(Number(n)),new Uint8Array(t)}static encodeFieldHeader(e,t){let n=e<<3|t;return o.encodeVarint(n)}writeVarint(e,t){this.chunks.push(o.encodeFieldHeader(e,0)),this.chunks.push(o.encodeVarint(t))}writeBytes(e,t){this.chunks.push(o.encodeFieldHeader(e,2)),this.chunks.push(o.encodeVarint(t.length)),this.chunks.push(t)}writePackedUint64(e,t){let n=[];for(let r of t)n.push(o.encodeVarint(r));let s=n.reduce((r,i)=>r+i.length,0);this.chunks.push(o.encodeFieldHeader(e,2)),this.chunks.push(o.encodeVarint(s));for(let r of n)this.chunks.push(r)}toBytes(){let e=this.chunks.reduce((s,r)=>s+r.length,0),t=new Uint8Array(e),n=0;for(let s of this.chunks)t.set(s,n),n+=s.length;return t}clear(){this.chunks=[]}},N={INT64:"int64",FLOAT64:"float64",STRING:"string",BOOL:"bool",INT32:"int32",FLOAT32:"float32"},st=class{constructor(e={}){this.majorVersion=e.majorVersion??0,this.minorVersion=e.minorVersion??3,this.columns=[],this.rowCount=null}_validateRowCount(e){if(this.rowCount===null)this.rowCount=e;else if(this.rowCount!==e)throw new Error(`Row count mismatch: expected ${this.rowCount}, got ${e}`)}addInt64Column(e,t){this._validateRowCount(t.length),this.columns.push({name:e,type:N.INT64,data:new Uint8Array(t.buffer,t.byteOffset,t.byteLength),length:t.length})}addInt32Column(e,t){this._validateRowCount(t.length),this.columns.push({name:e,type:N.INT32,data:new Uint8Array(t.buffer,t.byteOffset,t.byteLength),length:t.length})}addFloat64Column(e,t){this._validateRowCount(t.length),this.columns.push({name:e,type:N.FLOAT64,data:new Uint8Array(t.buffer,t.byteOffset,t.byteLength),length:t.length})}addFloat32Column(e,t){this._validateRowCount(t.length),this.columns.push({name:e,type:N.FLOAT32,data:new Uint8Array(t.buffer,t.byteOffset,t.byteLength),length:t.length})}addBoolColumn(e,t){this._validateRowCount(t.length);let n=new Uint8Array(t.length);for(let s=0;s<t.length;s++)n[s]=t[s]?1:0;this.columns.push({name:e,type:N.BOOL,data:n,length:t.length})}addStringColumn(e,t){this._validateRowCount(t.length);let n=new TextEncoder,s=new Int32Array(t.length+1),r=[],i=0;for(let f=0;f<t.length;f++){s[f]=i;let h=n.encode(t[f]);r.push(h),i+=h.length}s[t.length]=i;let a=new Uint8Array(s.buffer),c=r.reduce((f,h)=>f+h.length,0),u=new Uint8Array(c),l=0;for(let f of r)u.set(f,l),l+=f.length;this.columns.push({name:e,type:N.STRING,offsetsData:a,stringData:u,data:null,length:t.length})}_buildColumnMeta(e,t,n,s){let r=new $;r.writePackedUint64(1,[BigInt(e)]),r.writePackedUint64(2,[BigInt(t)]),r.writeVarint(3,n),r.writeVarint(5,0);let i=r.toBytes(),a=new $;return a.writeBytes(2,i),a.toBytes()}_buildStringColumnMeta(e,t,n,s,r){let i=new $;i.writePackedUint64(1,[BigInt(e),BigInt(n)]),i.writePackedUint64(2,[BigInt(t),BigInt(s)]),i.writeVarint(3,r),i.writeVarint(5,0);let a=i.toBytes(),c=new $;return c.writeBytes(2,a),c.toBytes()}finalize(){if(this.columns.length===0)throw new Error("No columns added");let e=[],t=0,n=[];for(let w of this.columns)if(w.type===N.STRING){let y=t;e.push(w.offsetsData),t+=w.offsetsData.length;let _=t;e.push(w.stringData),t+=w.stringData.length,n.push({type:"string",offsetsOffset:y,offsetsSize:w.offsetsData.length,dataOffset:_,dataSize:w.stringData.length,length:w.length})}else{let y=t;e.push(w.data),t+=w.data.length,n.push({type:w.type,offset:y,size:w.data.length,length:w.length})}let s=[];for(let w=0;w<this.columns.length;w++){let y=n[w],_;y.type==="string"?_=this._buildStringColumnMeta(y.offsetsOffset,y.offsetsSize,y.dataOffset,y.dataSize,y.length):_=this._buildColumnMeta(y.offset,y.size,y.length,y.type),s.push(_)}let r=t,i=[],a=0;for(let w of s)i.push(a),e.push(w),t+=w.length,a+=w.length;let c=t,u=new BigUint64Array(i.length);for(let w=0;w<i.length;w++)u[w]=BigInt(i[w]);let l=new Uint8Array(u.buffer);e.push(l),t+=l.length;let f=t,h=0,d=new ArrayBuffer(40),m=new DataView(d);m.setBigUint64(0,BigInt(r),!0),m.setBigUint64(8,BigInt(c),!0),m.setBigUint64(16,BigInt(f),!0),m.setUint32(24,h,!0),m.setUint32(28,this.columns.length,!0),m.setUint16(32,this.majorVersion,!0),m.setUint16(34,this.minorVersion,!0),new Uint8Array(d,36,4).set(Bt),e.push(new Uint8Array(d));let g=t+40,b=new Uint8Array(g),p=0;for(let w of e)b.set(w,p),p+=w.length;return b}getNumColumns(){return this.columns.length}getRowCount(){return this.rowCount}getColumnNames(){return this.columns.map(e=>e.name)}};var q=class{constructor(e=null){this._getEncryptionKey=e,this._encryptionKeyId=null,this._ready=!1}async _init(){if(this._ready)return this;let e=null;if(this._getEncryptionKey){let t=await this._getEncryptionKey();this._encryptionKeyId=`vault:${Date.now()}`;let n;if(t instanceof CryptoKey)n=await crypto.subtle.exportKey("raw",t);else if(t instanceof ArrayBuffer||t instanceof Uint8Array)n=t instanceof Uint8Array?t:new Uint8Array(t);else if(typeof t=="string"){let r=new TextEncoder().encode(t),i=await crypto.subtle.digest("SHA-256",r);n=new Uint8Array(i)}else throw new Error("Encryption key must be CryptoKey, ArrayBuffer, Uint8Array, or string");e={keyId:this._encryptionKeyId,keyBytes:Array.from(n instanceof Uint8Array?n:new Uint8Array(n))}}return await T("vault:open",{encryption:e}),this._ready=!0,this}async get(e){return T("vault:get",{key:e})}async set(e,t){await T("vault:set",{key:e,value:t})}async delete(e){return T("vault:delete",{key:e})}async keys(){return T("vault:keys",{})}async has(e){return await this.get(e)!==void 0}async exec(e){return T("vault:exec",{sql:e})}async query(e){let t=await this.exec(e);return!t||!t.columns||!t.rows?[]:t.rows.map(n=>{let s={};return t.columns.forEach((r,i)=>{s[r]=n[i]}),s})}table(e){return new K(this,e)}async tables(){return T("vault:tables",{})}async exportToLance(e){let t=await this.exec(`SELECT * FROM ${e} LIMIT 0`);if(!t||!t.columns)throw new Error(`Table '${e}' not found or empty`);let n=await this.exec(`SELECT * FROM ${e}`);if(!n||!n.rows||n.rows.length===0)throw new Error(`Table '${e}' is empty`);let s=new st,r=n.columns,i=n.rows;for(let a=0;a<r.length;a++){let c=r[a],u=i.map(f=>f[c]!==void 0?f[c]:f[a]),l=u.find(f=>f!=null);if(l===void 0)s.addStringColumn(c,u.map(f=>f===null?"":String(f)));else if(typeof l=="bigint")s.addInt64Column(c,BigInt64Array.from(u.map(f=>f===null?0n:BigInt(f))));else if(typeof l=="number")Number.isInteger(l)&&l<=2147483647&&l>=-2147483648?s.addInt32Column(c,Int32Array.from(u.map(f=>f===null?0:f))):s.addFloat64Column(c,Float64Array.from(u.map(f=>f===null?0:f)));else if(typeof l=="boolean")s.addBoolColumn(c,u.map(f=>f===null?!1:f));else if(Array.isArray(l)){let f=l.length,h=new Float32Array(u.length*f);for(let d=0;d<u.length;d++){let m=u[d]||new Array(f).fill(0);for(let g=0;g<f;g++)h[d*f+g]=m[g]||0}s.addVectorColumn(c,h,f)}else s.addStringColumn(c,u.map(f=>f===null?"":String(f)))}return s.finalize()}async uploadToUrl(e,t,n={}){let{onProgress:s}=n;if(s&&typeof XMLHttpRequest<"u")return new Promise((i,a)=>{let c=new XMLHttpRequest;c.open("PUT",t,!0),c.setRequestHeader("Content-Type","application/octet-stream"),c.upload.onprogress=u=>{u.lengthComputable&&s(u.loaded,u.total)},c.onload=()=>{c.status>=200&&c.status<300?i({ok:!0,status:c.status}):a(new Error(`Upload failed: ${c.status} ${c.statusText}`))},c.onerror=()=>a(new Error("Upload failed: network error")),c.send(e)});let r=await fetch(t,{method:"PUT",body:e,headers:{"Content-Type":"application/octet-stream"}});if(!r.ok)throw new Error(`Upload failed: ${r.status} ${r.statusText}`);return r}async exportToRemote(e,t,n={}){let s=await this.exportToLance(e);return await this.uploadToUrl(s,t,n),{size:s.length,url:t.split("?")[0]}}},K=class o{constructor(e,t){this._vault=e,this._tableName=t,this._filters=[],this._similar=null,this._selectCols=null,this._limitValue=null,this._orderBy=null}filter(e,t,n){let s=this._clone();return s._filters.push({column:e,op:t,value:n}),s}similar(e,t,n=20){let s=this._clone();return s._similar={column:e,text:t,limit:n},s}select(...e){let t=this._clone();return t._selectCols=e.flat(),t}limit(e){let t=this._clone();return t._limitValue=e,t}orderBy(e,t="ASC"){let n=this._clone();return n._orderBy={column:e,direction:t},n}async toArray(){let e=this._toSQL();return this._vault.query(e)}async first(){let e=this._clone();return e._limitValue=1,(await e.toArray())[0]||null}async count(){let e=this._toSQL(!0);return(await this._vault.exec(e))?.rows?.[0]?.[0]||0}_toSQL(e=!1){let n=`SELECT ${e?"COUNT(*)":this._selectCols?.join(", ")||"*"} FROM ${this._tableName}`,s=[];for(let i of this._filters){let a=typeof i.value=="string"?`'${i.value}'`:i.value;s.push(`${i.column} ${i.op} ${a}`)}this._similar&&s.push(`${this._similar.column} NEAR '${this._similar.text}'`),s.length>0&&(n+=" WHERE "+s.join(" AND ")),this._orderBy&&!e&&(n+=` ORDER BY ${this._orderBy.column} ${this._orderBy.direction}`);let r=this._similar?.limit||this._limitValue;return r&&!e&&(n+=` LIMIT ${r}`),n}_clone(){let e=new o(this._vault,this._tableName);return e._filters=[...this._filters],e._similar=this._similar,e._selectCols=this._selectCols?[...this._selectCols]:null,e._limitValue=this._limitValue,e._orderBy=this._orderBy,e}};async function dt(o=null){let e=new q(o);return await e._init(),e}var wt=class{constructor(){this.device=null,this.pipeline=null,this.available=!1,this._initPromise=null}async init(){return this._initPromise?this._initPromise:(this._initPromise=this._doInit(),this._initPromise)}async _doInit(){if(!navigator.gpu)return console.log("[WebGPU] Not available in this browser"),!1;try{let e=await navigator.gpu.requestAdapter();return e?(this.device=await e.requestDevice(),this._createPipeline(),this.available=!0,console.log("[WebGPU] Initialized successfully"),!0):(console.log("[WebGPU] No adapter found"),!1)}catch(e){return console.warn("[WebGPU] Init failed:",e),!1}}_createPipeline(){let t=this.device.createShaderModule({code:`
            struct Params {
                dim: u32,
                numVectors: u32,
            }

            @group(0) @binding(0) var<uniform> params: Params;
            @group(0) @binding(1) var<storage, read> query: array<f32>;
            @group(0) @binding(2) var<storage, read> vectors: array<f32>;
            @group(0) @binding(3) var<storage, read_write> scores: array<f32>;

            @compute @workgroup_size(256)
            fn main(@builtin(global_invocation_id) globalId: vec3u) {
                let idx = globalId.x;
                if (idx >= params.numVectors) {
                    return;
                }

                let dim = params.dim;
                let offset = idx * dim;

                // Compute dot product (= cosine similarity for normalized vectors)
                var dot: f32 = 0.0;
                for (var i: u32 = 0u; i < dim; i++) {
                    dot += query[i] * vectors[offset + i];
                }

                scores[idx] = dot;
            }
        `});this.pipeline=this.device.createComputePipeline({layout:"auto",compute:{module:t,entryPoint:"main"}})}async batchCosineSimilarity(e,t,n=!0,s=!1){if(!this.available||t.length===0)return null;let r=e.length,i=s?t.length/r:t.length,a=i*r*4,c=this.device.limits?.maxStorageBufferBindingSize||134217728;if(a>c)return console.warn(`[WebGPU] Buffer size ${(a/1024/1024).toFixed(1)}MB exceeds limit ${(c/1024/1024).toFixed(1)}MB, falling back`),null;let u=this.device.createBuffer({size:8,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),l=this.device.createBuffer({size:r*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),f=this.device.createBuffer({size:i*r*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),h=this.device.createBuffer({size:i*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),d=this.device.createBuffer({size:i*4,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST});if(this.device.queue.writeBuffer(u,0,new Uint32Array([r,i])),this.device.queue.writeBuffer(l,0,e),s)this.device.queue.writeBuffer(f,0,t);else{let w=new Float32Array(i*r);for(let y=0;y<i;y++)w.set(t[y],y*r);this.device.queue.writeBuffer(f,0,w)}let m=this.device.createBindGroup({layout:this.pipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:u}},{binding:1,resource:{buffer:l}},{binding:2,resource:{buffer:f}},{binding:3,resource:{buffer:h}}]}),g=this.device.createCommandEncoder(),b=g.beginComputePass();b.setPipeline(this.pipeline),b.setBindGroup(0,m),b.dispatchWorkgroups(Math.ceil(i/256)),b.end(),g.copyBufferToBuffer(h,0,d,0,i*4),this.device.queue.submit([g.finish()]),await d.mapAsync(GPUMapMode.READ);let p=new Float32Array(d.getMappedRange().slice(0));return d.unmap(),u.destroy(),l.destroy(),f.destroy(),h.destroy(),d.destroy(),p}isAvailable(){return this.available}getMaxVectorsPerBatch(e){if(!this.available)return 0;let t=this.device.limits?.maxStorageBufferBindingSize||134217728;return Math.floor(t*.9/(e*4))}},mt=null;function M(){return mt||(mt=new wt),mt}var pt=class{constructor(){this.device=null,this.pipelines=new Map,this.available=!1,this._initPromise=null}async init(){return this._initPromise?this._initPromise:(this._initPromise=this._doInit(),this._initPromise)}async _doInit(){if(typeof navigator>"u"||!navigator.gpu)return!1;try{let e=await navigator.gpu.requestAdapter();return e?(this.device=await e.requestDevice({requiredLimits:{maxStorageBufferBindingSize:256*1024*1024,maxBufferSize:256*1024*1024}}),await this._compileShaders(),this.available=!0,!0):!1}catch{return!1}}async _compileShaders(){let e=this.device.createShaderModule({code:VECTOR_DISTANCE_SHADER});this.pipelines.set("distance",this.device.createComputePipeline({layout:"auto",compute:{module:e,entryPoint:"compute_distances"}}));let t=this.device.createShaderModule({code:TOPK_SHADER});this.pipelines.set("local_topk",this.device.createComputePipeline({layout:"auto",compute:{module:t,entryPoint:"local_topk"}})),this.pipelines.set("merge_topk",this.device.createComputePipeline({layout:"auto",compute:{module:t,entryPoint:"merge_topk"}}))}isAvailable(){return this.available}async computeDistances(e,t,n=1,s=0){let r=t.length,i=e.length/n;if(!this.available||r<GPU_DISTANCE_THRESHOLD)return this._cpuDistances(e,t,n,s);let a=new Float32Array(r*i);for(let p=0;p<r;p++)a.set(t[p],p*i);let c=this._createUniform(new Uint32Array([i,r,n,s])),u=this._createStorage(e),l=this._createStorage(a),f=this.device.createBuffer({size:n*r*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),h=this.device.createBuffer({size:n*r*4,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),d=this.device.createBindGroup({layout:this.pipelines.get("distance").getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:c}},{binding:1,resource:{buffer:u}},{binding:2,resource:{buffer:l}},{binding:3,resource:{buffer:f}}]}),m=this.device.createCommandEncoder(),g=m.beginComputePass();g.setPipeline(this.pipelines.get("distance")),g.setBindGroup(0,d),g.dispatchWorkgroups(Math.ceil(r/256),n,1),g.end(),m.copyBufferToBuffer(f,0,h,0,n*r*4),this.device.queue.submit([m.finish()]),await h.mapAsync(GPUMapMode.READ);let b=new Float32Array(h.getMappedRange().slice(0));return h.unmap(),[c,u,l,f,h].forEach(p=>p.destroy()),b}async topK(e,t=null,n=10,s=!0){let r=e.length;if(!this.available||r<GPU_TOPK_THRESHOLD)return this._cpuTopK(e,t,n,s);if(!t){t=new Uint32Array(r);for(let C=0;C<r;C++)t[C]=C}let i=Math.ceil(r/512),a=Math.min(n,512),c=i*a,u=this._createUniform(new Uint32Array([r,n,s?1:0,i])),l=this._createStorage(e),f=this._createStorage(t),h=this.device.createBuffer({size:c*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),d=this.device.createBuffer({size:c*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),m=this.device.createBindGroup({layout:this.pipelines.get("local_topk").getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:u}},{binding:1,resource:{buffer:l}},{binding:2,resource:{buffer:f}},{binding:3,resource:{buffer:h}},{binding:4,resource:{buffer:d}}]}),g=this.device.createCommandEncoder(),b=g.beginComputePass();b.setPipeline(this.pipelines.get("local_topk")),b.setBindGroup(0,m),b.dispatchWorkgroups(i,1,1),b.end(),this.device.queue.submit([g.finish()]);let p=this._createUniform(new Uint32Array([c,n,s?1:0,0])),w=this.device.createBuffer({size:n*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),y=this.device.createBuffer({size:n*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),_=this.device.createBuffer({size:n*4,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),I=this.device.createBuffer({size:n*4,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),A=this.device.createBindGroup({layout:this.pipelines.get("merge_topk").getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:p}},{binding:1,resource:{buffer:h}},{binding:2,resource:{buffer:d}},{binding:3,resource:{buffer:w}},{binding:4,resource:{buffer:y}}]});g=this.device.createCommandEncoder(),b=g.beginComputePass(),b.setPipeline(this.pipelines.get("merge_topk")),b.setBindGroup(0,A),b.dispatchWorkgroups(1,1,1),b.end(),g.copyBufferToBuffer(w,0,_,0,n*4),g.copyBufferToBuffer(y,0,I,0,n*4),this.device.queue.submit([g.finish()]),await Promise.all([_.mapAsync(GPUMapMode.READ),I.mapAsync(GPUMapMode.READ)]);let x=new Float32Array(_.getMappedRange().slice(0)),F=new Uint32Array(I.getMappedRange().slice(0));return _.unmap(),I.unmap(),[u,l,f,h,d,p,w,y,_,I].forEach(C=>C.destroy()),{indices:F,scores:x}}async search(e,t,n=10,s={}){let{metric:r=0}=s,i=await this.computeDistances(e,t,1,r),a=r===0||r===2;return await this.topK(i,null,n,a)}_cpuDistances(e,t,n,s){let r=e.length/n,i=t.length,a=new Float32Array(n*i);for(let c=0;c<n;c++){let u=c*r;for(let l=0;l<i;l++){let f=t[l],h=0;if(s===1){for(let d=0;d<r;d++){let m=e[u+d]-f[d];h+=m*m}h=Math.sqrt(h)}else for(let d=0;d<r;d++)h+=e[u+d]*f[d];a[c*i+l]=h}}return a}_cpuTopK(e,t,n,s){let r=e.length;if(!t){t=new Uint32Array(r);for(let c=0;c<r;c++)t[c]=c}let i=Array.from(e).map((c,u)=>({score:c,idx:t[u]}));s?i.sort((c,u)=>u.score-c.score):i.sort((c,u)=>c.score-u.score);let a=i.slice(0,n);return{indices:new Uint32Array(a.map(c=>c.idx)),scores:new Float32Array(a.map(c=>c.score))}}_createStorage(e){let t=this.device.createBuffer({size:e.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});return this.device.queue.writeBuffer(t,0,e),t}_createUniform(e){let t=this.device.createBuffer({size:Math.max(e.byteLength,16),usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});return this.device.queue.writeBuffer(t,0,e),t}},gt=null;function yt(){return gt||(gt=new pt),gt}var Y=class{constructor(e,t){this.lanceql=e,this.wasm=e.wasm,this.memory=e.memory;let n=new Uint8Array(t);if(this.dataPtr=this.wasm.alloc(n.length),!this.dataPtr)throw new Error("Failed to allocate memory for Lance file");if(this.dataLen=n.length,new Uint8Array(this.memory.buffer).set(n,this.dataPtr),this.wasm.openFile(this.dataPtr,this.dataLen)===0)throw this.wasm.free(this.dataPtr,this.dataLen),new Error("Failed to open Lance file")}close(){this.wasm.closeFile(),this.dataPtr&&(this.wasm.free(this.dataPtr,this.dataLen),this.dataPtr=null)}get numColumns(){return this.wasm.getNumColumns()}getRowCount(e){return this.wasm.getRowCount(e)}getColumnDebugInfo(e){return{offset:this.wasm.getColumnBufferOffset(e),size:this.wasm.getColumnBufferSize(e),rows:this.wasm.getRowCount(e)}}readInt64Column(e){let t=Number(this.getRowCount(e));if(t===0)return new BigInt64Array(0);let n=this.wasm.allocInt64Buffer(t);if(!n)throw new Error("Failed to allocate int64 buffer");try{let s=this.wasm.readInt64Column(e,n,t),r=new BigInt64Array(s),i=new BigInt64Array(this.memory.buffer,n,s);return r.set(i),r}finally{this.wasm.freeInt64Buffer(n,t)}}readFloat64Column(e){let t=Number(this.getRowCount(e));if(t===0)return new Float64Array(0);let n=this.wasm.allocFloat64Buffer(t);if(!n)throw new Error("Failed to allocate float64 buffer");try{let s=this.wasm.readFloat64Column(e,n,t),r=new Float64Array(s),i=new Float64Array(this.memory.buffer,n,s);return r.set(i),r}finally{this.wasm.freeFloat64Buffer(n,t)}}readInt32Column(e){let t=Number(this.getRowCount(e));if(t===0)return new Int32Array(0);let n=this.wasm.allocInt32Buffer(t);if(!n)throw new Error("Failed to allocate int32 buffer");try{let s=this.wasm.readInt32Column(e,n,t),r=new Int32Array(s),i=new Int32Array(this.memory.buffer,n,s);return r.set(i),r}finally{this.wasm.free(n,t*4)}}readInt16Column(e){let t=Number(this.getRowCount(e));if(t===0)return new Int16Array(0);let n=this.wasm.allocInt16Buffer(t);if(!n)throw new Error("Failed to allocate int16 buffer");try{let s=this.wasm.readInt16Column(e,n,t),r=new Int16Array(s),i=new Int16Array(this.memory.buffer,n,s);return r.set(i),r}finally{this.wasm.free(n,t*2)}}readInt8Column(e){let t=Number(this.getRowCount(e));if(t===0)return new Int8Array(0);let n=this.wasm.allocInt8Buffer(t);if(!n)throw new Error("Failed to allocate int8 buffer");try{let s=this.wasm.readInt8Column(e,n,t),r=new Int8Array(s),i=new Int8Array(this.memory.buffer,n,s);return r.set(i),r}finally{this.wasm.free(n,t)}}readUint64Column(e){let t=Number(this.getRowCount(e));if(t===0)return new BigUint64Array(0);let n=this.wasm.allocUint64Buffer(t);if(!n)throw new Error("Failed to allocate uint64 buffer");try{let s=this.wasm.readUint64Column(e,n,t),r=new BigUint64Array(s),i=new BigUint64Array(this.memory.buffer,n,s);return r.set(i),r}finally{this.wasm.free(n,t*8)}}readUint32Column(e){let t=Number(this.getRowCount(e));if(t===0)return new Uint32Array(0);let n=this.wasm.allocIndexBuffer(t);if(!n)throw new Error("Failed to allocate uint32 buffer");try{let s=this.wasm.readUint32Column(e,n,t),r=new Uint32Array(s),i=new Uint32Array(this.memory.buffer,n,s);return r.set(i),r}finally{this.wasm.free(n,t*4)}}readUint16Column(e){let t=Number(this.getRowCount(e));if(t===0)return new Uint16Array(0);let n=this.wasm.allocUint16Buffer(t);if(!n)throw new Error("Failed to allocate uint16 buffer");try{let s=this.wasm.readUint16Column(e,n,t),r=new Uint16Array(s),i=new Uint16Array(this.memory.buffer,n,s);return r.set(i),r}finally{this.wasm.free(n,t*2)}}readUint8Column(e){let t=Number(this.getRowCount(e));if(t===0)return new Uint8Array(0);let n=this.wasm.allocStringBuffer(t);if(!n)throw new Error("Failed to allocate uint8 buffer");try{let s=this.wasm.readUint8Column(e,n,t),r=new Uint8Array(s),i=new Uint8Array(this.memory.buffer,n,s);return r.set(i),r}finally{this.wasm.free(n,t)}}readFloat32Column(e){let t=Number(this.getRowCount(e));if(t===0)return new Float32Array(0);let n=this.wasm.allocFloat32Buffer(t);if(!n)throw new Error("Failed to allocate float32 buffer");try{let s=this.wasm.readFloat32Column(e,n,t),r=new Float32Array(s),i=new Float32Array(this.memory.buffer,n,s);return r.set(i),r}finally{this.wasm.free(n,t*4)}}readBoolColumn(e){let t=Number(this.getRowCount(e));if(t===0)return new Uint8Array(0);let n=this.wasm.allocStringBuffer(t);if(!n)throw new Error("Failed to allocate bool buffer");try{let s=this.wasm.readBoolColumn(e,n,t),r=new Uint8Array(s),i=new Uint8Array(this.memory.buffer,n,s);return r.set(i),r}finally{this.wasm.free(n,t)}}readInt32AtIndices(e,t){if(t.length===0)return new Int32Array(0);let n=this.wasm.allocIndexBuffer(t.length);if(!n)throw new Error("Failed to allocate index buffer");let s=this.wasm.allocInt32Buffer(t.length);if(!s)throw this.wasm.free(n,t.length*4),new Error("Failed to allocate output buffer");try{new Uint32Array(this.memory.buffer,n,t.length).set(t);let r=this.wasm.readInt32AtIndices(e,n,t.length,s),i=new Int32Array(r),a=new Int32Array(this.memory.buffer,s,r);return i.set(a),i}finally{this.wasm.free(n,t.length*4),this.wasm.free(s,t.length*4)}}readFloat32AtIndices(e,t){if(t.length===0)return new Float32Array(0);let n=this.wasm.allocIndexBuffer(t.length);if(!n)throw new Error("Failed to allocate index buffer");let s=this.wasm.allocFloat32Buffer(t.length);if(!s)throw this.wasm.free(n,t.length*4),new Error("Failed to allocate output buffer");try{new Uint32Array(this.memory.buffer,n,t.length).set(t);let r=this.wasm.readFloat32AtIndices(e,n,t.length,s),i=new Float32Array(r),a=new Float32Array(this.memory.buffer,s,r);return i.set(a),i}finally{this.wasm.free(n,t.length*4),this.wasm.free(s,t.length*4)}}readUint8AtIndices(e,t){if(t.length===0)return new Uint8Array(0);let n=this.wasm.allocIndexBuffer(t.length);if(!n)throw new Error("Failed to allocate index buffer");let s=this.wasm.allocStringBuffer(t.length);if(!s)throw this.wasm.free(n,t.length*4),new Error("Failed to allocate output buffer");try{new Uint32Array(this.memory.buffer,n,t.length).set(t);let r=this.wasm.readUint8AtIndices(e,n,t.length,s),i=new Uint8Array(r),a=new Uint8Array(this.memory.buffer,s,r);return i.set(a),i}finally{this.wasm.free(n,t.length*4),this.wasm.free(s,t.length)}}readBoolAtIndices(e,t){if(t.length===0)return new Uint8Array(0);let n=this.wasm.allocIndexBuffer(t.length);if(!n)throw new Error("Failed to allocate index buffer");let s=this.wasm.allocStringBuffer(t.length);if(!s)throw this.wasm.free(n,t.length*4),new Error("Failed to allocate output buffer");try{new Uint32Array(this.memory.buffer,n,t.length).set(t);let r=this.wasm.readBoolAtIndices(e,n,t.length,s),i=new Uint8Array(r),a=new Uint8Array(this.memory.buffer,s,r);return i.set(a),i}finally{this.wasm.free(n,t.length*4),this.wasm.free(s,t.length)}}filterInt64(e,t,n){let s=Number(this.getRowCount(e));if(s===0)return new Uint32Array(0);let r=this.wasm.allocIndexBuffer(s);if(!r)throw new Error("Failed to allocate index buffer");try{let i=this.wasm.filterInt64Column(e,t,BigInt(n),r,s),a=new Uint32Array(i),c=new Uint32Array(this.memory.buffer,r,i);return a.set(c),a}finally{this.wasm.free(r,s*4)}}filterFloat64(e,t,n){let s=Number(this.getRowCount(e));if(s===0)return new Uint32Array(0);let r=this.wasm.allocIndexBuffer(s);if(!r)throw new Error("Failed to allocate index buffer");try{let i=this.wasm.filterFloat64Column(e,t,n,r,s),a=new Uint32Array(i),c=new Uint32Array(this.memory.buffer,r,i);return a.set(c),a}finally{this.wasm.free(r,s*4)}}readInt64AtIndices(e,t){if(t.length===0)return new BigInt64Array(0);let n=this.wasm.allocIndexBuffer(t.length);if(!n)throw new Error("Failed to allocate index buffer");let s=this.wasm.allocInt64Buffer(t.length);if(!s)throw this.wasm.free(n,t.length*4),new Error("Failed to allocate output buffer");try{new Uint32Array(this.memory.buffer,n,t.length).set(t);let r=this.wasm.readInt64AtIndices(e,n,t.length,s),i=new BigInt64Array(r),a=new BigInt64Array(this.memory.buffer,s,r);return i.set(a),i}finally{this.wasm.free(n,t.length*4),this.wasm.freeInt64Buffer(s,t.length)}}readFloat64AtIndices(e,t){if(t.length===0)return new Float64Array(0);let n=this.wasm.allocIndexBuffer(t.length);if(!n)throw new Error("Failed to allocate index buffer");let s=this.wasm.allocFloat64Buffer(t.length);if(!s)throw this.wasm.free(n,t.length*4),new Error("Failed to allocate output buffer");try{new Uint32Array(this.memory.buffer,n,t.length).set(t);let r=this.wasm.readFloat64AtIndices(e,n,t.length,s),i=new Float64Array(r),a=new Float64Array(this.memory.buffer,s,r);return i.set(a),i}finally{this.wasm.free(n,t.length*4),this.wasm.freeFloat64Buffer(s,t.length)}}sumInt64(e){return this.wasm.sumInt64Column(e)}sumFloat64(e){return this.wasm.sumFloat64Column(e)}minInt64(e){return this.wasm.minInt64Column(e)}maxInt64(e){return this.wasm.maxInt64Column(e)}avgFloat64(e){return this.wasm.avgFloat64Column(e)}debugStringColInfo(e){let t=this.wasm.debugStringColInfo(e);return{offsetsSize:Number(BigInt(t)>>32n),dataSize:Number(BigInt(t)&0xFFFFFFFFn)}}debugReadStringInfo(e,t){let n=this.wasm.debugReadStringInfo(e,t);if((n&0xFFFF0000n)===0xDEAD0000n){let s=Number(n&0xFFFFn);return{error:{1:"No file data",2:"No column entry",3:"Col meta out of bounds",4:"Not a string column",5:"Row out of bounds",6:"Invalid offset size"}[s]||`Unknown error ${s}`}}return{strStart:Number(BigInt(n)>>32n),strLen:Number(BigInt(n)&0xFFFFFFFFn)}}debugStringDataStart(e){let t=this.wasm.debugStringDataStart(e);return{dataStart:Number(BigInt(t)>>32n),fileLen:Number(BigInt(t)&0xFFFFFFFFn)}}getStringCount(e){return Number(this.wasm.getStringCount(e))}readStringAt(e,t){let s=this.wasm.allocStringBuffer(4096);if(!s)throw new Error("Failed to allocate string buffer");try{let r=this.wasm.readStringAt(e,t,s,4096);if(r===0)return"";let i=new Uint8Array(this.memory.buffer,s,Math.min(r,4096));return new TextDecoder().decode(i)}finally{this.wasm.free(s,4096)}}readStringColumn(e,t=1e3){let n=Math.min(this.getStringCount(e),t);if(n===0)return[];let s=[];for(let r=0;r<n;r++)s.push(this.readStringAt(e,r));return s}readStringsAtIndices(e,t){if(t.length===0)return[];let n=Math.min(t.length*256,256*1024),s=this.wasm.allocIndexBuffer(t.length);if(!s)throw new Error("Failed to allocate index buffer");let r=this.wasm.allocStringBuffer(n);if(!r)throw this.wasm.free(s,t.length*4),new Error("Failed to allocate string buffer");let i=this.wasm.allocU32Buffer(t.length);if(!i)throw this.wasm.free(s,t.length*4),this.wasm.free(r,n),new Error("Failed to allocate length buffer");try{new Uint32Array(this.memory.buffer,s,t.length).set(t);let a=this.wasm.readStringsAtIndices(e,s,t.length,r,n,i),c=new Uint32Array(this.memory.buffer,i,t.length),u=[],l=0;for(let f=0;f<t.length;f++){let h=c[f];if(h>0&&l+h<=a){let d=new Uint8Array(this.memory.buffer,r+l,h);u.push(new TextDecoder().decode(d)),l+=h}else u.push("")}return u}finally{this.wasm.free(s,t.length*4),this.wasm.free(r,n),this.wasm.free(i,t.length*4)}}getVectorInfo(e){let t=this.wasm.getVectorInfo(e);return{rows:Number(BigInt(t)>>32n),dimension:Number(BigInt(t)&0xFFFFFFFFn)}}readVectorAt(e,t){let n=this.getVectorInfo(e);if(n.dimension===0)return new Float32Array(0);let s=this.wasm.allocFloat32Buffer(n.dimension);if(!s)throw new Error("Failed to allocate vector buffer");try{let r=this.wasm.readVectorAt(e,t,s,n.dimension),i=new Float32Array(r),a=new Float32Array(this.memory.buffer,s,r);return i.set(a),i}finally{this.wasm.free(s,n.dimension*4)}}cosineSimilarity(e,t){if(e.length!==t.length)throw new Error("Vector dimensions must match");let n=this.wasm.allocFloat32Buffer(e.length),s=this.wasm.allocFloat32Buffer(t.length);if(!n||!s)throw new Error("Failed to allocate buffers");try{return new Float32Array(this.memory.buffer,n,e.length).set(e),new Float32Array(this.memory.buffer,s,t.length).set(t),this.wasm.cosineSimilarity(n,s,e.length)}finally{this.wasm.free(n,e.length*4),this.wasm.free(s,t.length*4)}}batchCosineSimilarity(e,t,n=!0){if(t.length===0)return new Float32Array(0);let s=e.length,r=t.length,i=this.wasm.allocFloat32Buffer(s),a=this.wasm.allocFloat32Buffer(r*s),c=this.wasm.allocFloat32Buffer(r);if(!i||!a||!c)throw new Error("Failed to allocate WASM buffers");try{new Float32Array(this.memory.buffer,i,s).set(e);let u=new Float32Array(this.memory.buffer,a,r*s);for(let f=0;f<r;f++)u.set(t[f],f*s);this.wasm.batchCosineSimilarity(i,a,s,r,c,n?1:0);let l=new Float32Array(r);return l.set(new Float32Array(this.memory.buffer,c,r)),l}finally{this.wasm.free(i,s*4),this.wasm.free(a,r*s*4),this.wasm.free(c,r*4)}}readAllVectors(e){let t=this.getVectorInfo(e);if(t.dimension===0||t.rows===0)return[];let n=t.dimension,s=t.rows,r=[],i=this.wasm.allocFloat32Buffer(s*n);if(!i)throw new Error("Failed to allocate vector buffer");try{if(this.wasm.readVectorColumn){let a=this.wasm.readVectorColumn(e,i,s*n),c=new Float32Array(this.memory.buffer,i,a);for(let u=0;u<s&&u*n<a;u++){let l=new Float32Array(n);l.set(c.subarray(u*n,(u+1)*n)),r.push(l)}}else for(let a=0;a<s;a++)r.push(this.readVectorAt(e,a));return r}finally{this.wasm.free(i,s*n*4)}}async vectorSearch(e,t,n=10,s=null){let r=t.length,a=this.getVectorInfo(e).rows,c=M();if(c.isAvailable()){s&&s(0,a);let f=this.readAllVectors(e);s&&s(a,a);let h=await c.batchCosineSimilarity(t,f,!0);return await yt().topK(h,null,n,!0)}s&&s(0,a);let u=this.readAllVectors(e);s&&s(a,a);let l=this.lanceql.batchCosineSimilarity(t,u,!0);return await yt().topK(l,null,n,!0)}df(){return new DataFrame(this)}};Ut(Y,"Op",{EQ:0,NE:1,LT:2,LE:3,GT:4,GE:5});var _t=class{constructor(e=null,t={}){this.storage=e,this.cacheDir=t.cacheDir||"_cache",this.maxFileSize=t.maxFileSize||10*1024*1024,this.maxCacheSize=t.maxCacheSize||500*1024*1024,this.enabled=t.enabled??!0,this._stats={hits:0,misses:0,bytesFromCache:0,bytesFromNetwork:0},this._metaCache=new Map,this._metaCacheOrder=[],this.maxMetaCacheEntries=t.maxMetaCacheEntries||100}_setMetaCache(e,t){let n=this._metaCacheOrder.indexOf(e);for(n!==-1&&this._metaCacheOrder.splice(n,1);this._metaCacheOrder.length>=this.maxMetaCacheEntries;){let s=this._metaCacheOrder.shift();this._metaCache.delete(s)}this._metaCache.set(e,t),this._metaCacheOrder.push(e)}async init(){this.storage||(this.storage=new OPFSStorage,await this.storage.open())}_getCacheKey(e){let t=0;for(let n=0;n<e.length;n++){let s=e.charCodeAt(n);t=(t<<5)-t+s,t=t&t}return Math.abs(t).toString(36)}_getCachePath(e,t=""){let n=this._getCacheKey(e);return`${this.cacheDir}/${n}${t}`}async isCached(e){if(!this.enabled)return{cached:!1};try{await this.init();let t=this._getCachePath(e,"/meta.json"),n=await this.storage.load(t);return n?{cached:!0,meta:JSON.parse(new TextDecoder().decode(n))}:{cached:!1}}catch{return{cached:!1}}}async getFile(e,t=null){if(!this.enabled)return this._fetchFile(e);await this.init();let{cached:n,meta:s}=await this.isCached(e);if(n&&s.fullFile){let i=this._getCachePath(e,"/data.lance"),a=await this.storage.load(i);if(a)return this._stats.hits++,this._stats.bytesFromCache+=a.byteLength,console.log(`[HotTierCache] HIT: ${e} (${(a.byteLength/1024).toFixed(1)} KB)`),a}this._stats.misses++;let r=await this._fetchFile(e);return this._stats.bytesFromNetwork+=r.byteLength,r.byteLength<=this.maxFileSize&&await this._cacheFile(e,r),r}async getRange(e,t,n,s=null){if(!this.enabled)return this._fetchRange(e,t,n);let r=this._metaCache.get(e);if(r?.fullFileData){let a=r.fullFileData;if(a.byteLength>n)return this._stats.hits++,this._stats.bytesFromCache+=n-t+1,a.slice(t,n+1).buffer}if(await this.init(),!r){let{cached:a,meta:c}=await this.isCached(e);if(a&&c.fullFile){let u=this._getCachePath(e,"/data.lance"),l=await this.storage.load(u);if(l&&l.byteLength>n)return this._setMetaCache(e,{meta:c,fullFileData:l}),this._stats.hits++,this._stats.bytesFromCache+=n-t+1,l.slice(t,n+1).buffer}this._setMetaCache(e,{meta:a?c:null,fullFileData:null})}this._stats.misses++;let i=await this._fetchRange(e,t,n);return this._stats.bytesFromNetwork+=i.byteLength,i}async prefetch(e,t=null){await this.init();let{cached:n,meta:s}=await this.isCached(e);if(n&&s.fullFile){console.log(`[HotTierCache] Already cached: ${e}`);return}console.log(`[HotTierCache] Prefetching: ${e}`);let r=await this._fetchFile(e,t);await this._cacheFile(e,r),console.log(`[HotTierCache] Cached: ${e} (${(r.byteLength/1024/1024).toFixed(2)} MB)`)}async evict(e){await this.init();let t=this._getCachePath(e);await this.storage.delete(t),console.log(`[HotTierCache] Evicted: ${e}`)}async clear(){await this.init(),await this.storage.delete(this.cacheDir),this._stats={hits:0,misses:0,bytesFromCache:0,bytesFromNetwork:0},console.log("[HotTierCache] Cleared all cache")}getStats(){let e=this._stats.hits+this._stats.misses>0?(this._stats.hits/(this._stats.hits+this._stats.misses)*100).toFixed(1):0;return{...this._stats,hitRate:`${e}%`,bytesFromCacheMB:(this._stats.bytesFromCache/1024/1024).toFixed(2),bytesFromNetworkMB:(this._stats.bytesFromNetwork/1024/1024).toFixed(2)}}async _fetchFile(e,t=null){let n=await fetch(e);if(!n.ok)throw new Error(`HTTP error: ${n.status}`);if(t&&n.headers.get("content-length")){let r=parseInt(n.headers.get("content-length")),i=n.body.getReader(),a=[],c=0;for(;;){let{done:f,value:h}=await i.read();if(f)break;a.push(h),c+=h.length,t(c,r)}let u=new Uint8Array(c),l=0;for(let f of a)u.set(f,l),l+=f.length;return u}let s=await n.arrayBuffer();return new Uint8Array(s)}async _fetchRange(e,t,n){let s=await fetch(e,{headers:{Range:`bytes=${t}-${n}`}});if(!s.ok&&s.status!==206)throw new Error(`HTTP error: ${s.status}`);return s.arrayBuffer()}async _cacheFile(e,t){let n=this._getCachePath(e,"/meta.json"),s=this._getCachePath(e,"/data.lance"),r={url:e,size:t.byteLength,cachedAt:Date.now(),fullFile:!0,ranges:null};await this.storage.save(n,new TextEncoder().encode(JSON.stringify(r))),await this.storage.save(s,t)}async _cacheRange(e,t,n,s,r){let i=this._getCachePath(e,"/meta.json"),a=this._getCachePath(e,`/ranges/${t}-${n}`),c,{cached:u,meta:l}=await this.isCached(e);u?(c=l,c.ranges=c.ranges||[]):c={url:e,size:r,cachedAt:Date.now(),fullFile:!1,ranges:[]},c.ranges.push({start:t,end:n,cachedAt:Date.now()}),c.ranges=this._mergeRanges(c.ranges),await this.storage.save(i,new TextEncoder().encode(JSON.stringify(c))),await this.storage.save(a,s)}_mergeRanges(e){if(e.length<=1)return e;e.sort((n,s)=>n.start-s.start);let t=[e[0]];for(let n=1;n<e.length;n++){let s=t[t.length-1],r=e[n];r.start<=s.end+1?s.end=Math.max(s.end,r.end):t.push(r)}return t}},bt=null;function kt(){return bt||(bt=new _t),bt}async function vt(o){let e=[1,5,10,20,50,100],t=await Promise.all(e.map(async s=>{try{return(await fetch(`${o}/_versions/${s}.manifest`,{method:"HEAD"})).ok?s:0}catch{return 0}})),n=Math.max(...t);if(n===0)return null;for(let s=n+1;s<=n+30;s++)try{if((await fetch(`${o}/_versions/${s}.manifest`,{method:"HEAD"})).ok)n=s;else break}catch{break}return n}function Mt(o){let t=new DataView(o.buffer,o.byteOffset).getUint32(0,!0),n=o.slice(4,4+t),s=0,r=null,i=null,a=(c,u)=>{let l=0,f=0,h=u;for(;h<c.length;){let d=c[h++];if(l|=(d&127)<<f,(d&128)===0)break;f+=7}return{value:l,pos:h}};for(;s<n.length;){let c=a(n,s);s=c.pos;let u=c.value>>3,l=c.value&7;if(l===2){let f=a(n,s);s=f.pos;let h=n.slice(s,s+f.value);if(s+=f.value,u===1){let d=ke(h);d?.uuid&&(r=d.uuid,i=d.fieldId)}}else l===0?s=a(n,s).pos:l===5?s+=4:l===1&&(s+=8)}return r?{uuid:r,fieldId:i}:null}function ke(o){let e=0,t=null,n=null,s=()=>{let r=0,i=0;for(;e<o.length;){let a=o[e++];if(r|=(a&127)<<i,(a&128)===0)break;i+=7}return r};for(;e<o.length;){let r=s(),i=r>>3,a=r&7;if(a===2){let c=s(),u=o.slice(e,e+c);e+=c,i===1&&(t=ve(u))}else if(a===0){let c=s();i===2&&(n=c)}else a===5?e+=4:a===1&&(e+=8)}return{uuid:t,fieldId:n}}function ve(o){let e=0;for(;e<o.length;){let t=o[e++],n=t>>3,s=t&7;if(s===2&&n===1){let r=o[e++],i=o.slice(e,e+r),a=Array.from(i).map(c=>c.toString(16).padStart(2,"0")).join("");return`${a.slice(0,8)}-${a.slice(8,12)}-${a.slice(12,16)}-${a.slice(16,20)}-${a.slice(20,32)}`}else if(s===0)for(;e<o.length&&o[e++]&128;);else s===5?e+=4:s===1&&(e+=8)}return null}function Ot(o,e,t){let n=new t,s=Lt(o);if(s&&(s.centroids&&(n.centroids=s.centroids.data,n.numPartitions=s.centroids.numPartitions,n.dimension=s.centroids.dimension),s.offsets?.length>0&&(n.partitionOffsets=s.offsets),s.lengths?.length>0&&(n.partitionLengths=s.lengths)),!n.centroids){let r=0,i=()=>{let a=0,c=0;for(;r<o.length;){let u=o[r++];if(a|=(u&127)<<c,(u&128)===0)break;c+=7}return a};for(;r<o.length-4;){let c=i()&7;if(c===2){let u=i();if(u>o.length-r)break;let l=o.slice(r,r+u);if(r+=u,u>100&&u<1e8){let f=Nt(l);f&&(n.centroids=f.data,n.numPartitions=f.numPartitions,n.dimension=f.dimension)}}else c===0?i():c===5?r+=4:c===1&&(r+=8)}}return n.centroids?n:null}function Lt(o){let e=0,t=[],n=[],s=null,r=()=>{let i=0,a=0;for(;e<o.length;){let c=o[e++];if(i|=(c&127)<<a,(c&128)===0)break;a+=7}return i};for(;e<o.length-4;){let i=e,a=r(),c=a>>3,u=a&7;if(u===2){let l=r();if(l>o.length-e||l<0){e=i+1;continue}let f=o.slice(e,e+l);if(e+=l,c===2&&l%8===0&&l>0){let h=new DataView(f.buffer,f.byteOffset,l);for(let d=0;d<l/8;d++)t.push(Number(h.getBigUint64(d*8,!0)))}else if(c===3)if(l%4===0&&l>0){let h=new DataView(f.buffer,f.byteOffset,l);for(let d=0;d<l/4;d++)n.push(h.getUint32(d*4,!0))}else{let h=0;for(;h<f.length;){let d=0,m=0;for(;h<f.length;){let g=f[h++];if(d|=(g&127)<<m,(g&128)===0)break;m+=7}n.push(d)}}else if(c===4)s=Nt(f);else if(l>100){let h=Lt(f);(h?.centroids||h?.offsets?.length>0)&&(h.centroids&&!s&&(s=h.centroids),h.offsets?.length>t.length&&(t=h.offsets),h.lengths?.length>n.length&&(n=h.lengths))}}else u===0?r():u===5?e+=4:u===1?e+=8:e=i+1}return s||t.length>0||n.length>0?{centroids:s,offsets:t,lengths:n}:null}function Nt(o){let e=0,t=[],n=null,s=2,r=()=>{let i=0,a=0;for(;e<o.length;){let c=o[e++];if(i|=(c&127)<<a,(c&128)===0)break;a+=7}return i};for(;e<o.length;){let i=r(),a=i>>3,c=i&7;if(c===0){let u=r();a===1&&(s=u)}else if(c===2){let u=r(),l=o.slice(e,e+u);if(e+=u,a===2){let f=0;for(;f<l.length;){let h=0,d=0;for(;f<l.length;){let m=l[f++];if(h|=(m&127)<<d,(m&128)===0)break;d+=7}t.push(h)}}else a===3&&(n=l)}else c===5?e+=4:c===1&&(e+=8)}if(t.length>=2&&n&&s===2){let i=t[0],a=t[1];if(n.length===i*a*4)return{data:new Float32Array(n.buffer,n.byteOffset,i*a),numPartitions:i,dimension:a}}return null}async function It(o){let e;try{e=await fetch(o.auxiliaryUrl,{method:"HEAD"})}catch{return}if(!e.ok)return;let t=parseInt(e.headers.get("content-length"));if(!t)return;let n=await fetch(o.auxiliaryUrl,{headers:{Range:`bytes=${t-40}-${t-1}`}});if(!n.ok)return;let s=new Uint8Array(await n.arrayBuffer()),r=new DataView(s.buffer,s.byteOffset),i=Number(r.getBigUint64(0,!0)),a=Number(r.getBigUint64(8,!0)),c=Number(r.getBigUint64(16,!0)),u=r.getUint32(24,!0);if(new TextDecoder().decode(s.slice(36,40))!=="LANC")return;let f=u*16,h=await fetch(o.auxiliaryUrl,{headers:{Range:`bytes=${c}-${c+f-1}`}});if(!h.ok)return;let d=new Uint8Array(await h.arrayBuffer()),m=new DataView(d.buffer,d.byteOffset),g=[];for(let w=0;w<u;w++){let y=Number(m.getBigUint64(w*16,!0)),_=Number(m.getBigUint64(w*16+8,!0));g.push({offset:y,length:_})}if(g.length<2)return;o._auxBuffers=g,o._auxFileSize=t;let b=await fetch(o.auxiliaryUrl,{headers:{Range:`bytes=${a}-${c-1}`}});if(!b.ok)return;let p=new Uint8Array(await b.arrayBuffer());if(p.length>=32){let w=new DataView(p.buffer,p.byteOffset),y=Number(w.getBigUint64(0,!0)),_=Number(w.getBigUint64(8,!0)),I=await fetch(o.auxiliaryUrl,{headers:{Range:`bytes=${y}-${y+_-1}`}});if(I.ok){let A=new Uint8Array(await I.arrayBuffer());At(o,A)}}}function At(o,e){let t=0,n=[],s=()=>{let r=0,i=0;for(;t<e.length;){let a=e[t++];if(r|=(a&127)<<i,(a&128)===0)break;i+=7}return r};for(;t<e.length;){let r=s(),i=r>>3,a=r&7;if(a===2){let c=s();if(c>e.length-t)break;let u=e.slice(t,t+c);if(t+=c,i===2){let l=Oe(u);l&&n.push(l)}}else a===0?s():a===5?t+=4:a===1&&(t+=8)}o._columnPages=n}function Oe(o){let e=0,t=0,n=[],s=[],r=()=>{let i=0,a=0;for(;e<o.length;){let c=o[e++];if(i|=(c&127)<<a,(c&128)===0)break;a+=7}return i};for(;e<o.length;){let i=r(),a=i>>3,c=i&7;if(c===0){let u=r();a===3&&(t=u)}else if(c===2){let u=r(),l=o.slice(e,e+u);if(e+=u,a===1){let f=0;for(;f<l.length;){let h=0n,d=0n;for(;f<l.length;){let m=l[f++];if(h|=BigInt(m&127)<<d,(m&128)===0)break;d+=7n}n.push(Number(h))}}if(a===2){let f=0;for(;f<l.length;){let h=0n,d=0n;for(;f<l.length;){let m=l[f++];if(h|=BigInt(m&127)<<d,(m&128)===0)break;d+=7n}s.push(Number(h))}}}else c===5?e+=4:c===1&&(e+=8)}return{numRows:t,bufferOffsets:n,bufferSizes:s}}function Dt(o,e){let t=0,n=()=>{let s=0,r=0;for(;t<e.length;){let i=e[t++];if(s|=(i&127)<<r,(i&128)===0)break;r+=7}return s};for(;t<e.length-4;){let s=n(),r=s>>3,i=s&7;if(i===2){let a=n();if(a>e.length-t)break;let c=e.slice(t,t+a);if(t+=a,r===2&&a>100&&a<2e3){let u=[],l=0;for(;l<c.length;){let f=0,h=0;for(;l<c.length;){let d=c[l++];if(f|=(d&127)<<h,(d&128)===0)break;h+=7}u.push(f)}u.length===o.numPartitions&&(o.partitionOffsets=u)}else if(r===3&&a>100&&a<2e3){let u=[],l=0;for(;l<c.length;){let f=0,h=0;for(;l<c.length;){let d=c[l++];if(f|=(d&127)<<h,(d&128)===0)break;h+=7}u.push(f)}u.length===o.numPartitions&&(o.partitionLengths=u)}}else if(i===0)n();else if(i===1)t+=8;else if(i===5)t+=4;else break}}var rt=class{constructor(e={}){this.maxSize=e.maxSize??50*1024*1024,this.currentSize=0,this.cache=new Map,this._head=null,this._tail=null}get(e){let t=this.cache.get(e);if(t)return this._moveToHead(t),t.data}delete(e){let t=this.cache.get(e);return t?(this._removeNode(t),this.cache.delete(e),this.currentSize-=t.size,!0):!1}set(e,t,n=null){return this.put(e,t,n)}put(e,t,n=null){let s=this.cache.get(e);s&&(this._removeNode(s),this.currentSize-=s.size,this.cache.delete(e));let r=n;for(r===null&&(t==null?r=0:t.byteLength!==void 0?r=t.byteLength:typeof t=="string"?r=t.length*2:typeof t=="object"?r=JSON.stringify(t).length*2:r=8);this.currentSize+r>this.maxSize&&this._tail;)this._evictTail();if(r>this.maxSize)return;let i={key:e,data:t,size:r,prev:null,next:null};this._addToHead(i),this.cache.set(e,i),this.currentSize+=r}_addToHead(e){e.prev=null,e.next=this._head,this._head&&(this._head.prev=e),this._head=e,this._tail||(this._tail=e)}_removeNode(e){e.prev?e.prev.next=e.next:this._head=e.next,e.next?e.next.prev=e.prev:this._tail=e.prev,e.prev=null,e.next=null}_moveToHead(e){e!==this._head&&(this._removeNode(e),this._addToHead(e))}_evictTail(){if(!this._tail)return;let e=this._tail;this._removeNode(e),this.cache.delete(e.key),this.currentSize-=e.size}clear(){this.cache.clear(),this._head=null,this._tail=null,this.currentSize=0}stats(){return{entries:this.cache.size,currentSize:this.currentSize,maxSize:this.maxSize,utilization:(this.currentSize/this.maxSize*100).toFixed(1)+"%"}}};var Ne=50*1024*1024;async function xt(o){let e=`${o.datasetBaseUrl}/ivf_vectors.bin`;o.partitionVectorsUrl=e;let t=await fetch(e,{headers:{Range:"bytes=0-2055"}});if(!t.ok)return;let n=await t.arrayBuffer(),s=new BigUint64Array(n);o.partitionOffsets=Array.from(s,r=>Number(r)),o.hasPartitionIndex=!0}async function $t(o,e,t=384,n=null){if(!o.hasPartitionIndex||!o.partitionVectorsUrl)return null;let s=0,r=0,i=[],a=new Map;o._partitionCache||(o._partitionCache=new rt({maxSize:Ne}));for(let u of e){let l=o._partitionCache.get(u);l!==void 0?a.set(u,l):(i.push(u),s+=o.partitionOffsets[u+1]-o.partitionOffsets[u])}if(i.length===0)return Vt(e,a,t,n);o._fetchStats||(o._fetchStats={concurrency:6,recentLatencies:[],minConcurrency:2,maxConcurrency:12});let c=o._fetchStats;for(let u=0;u<i.length;u+=c.concurrency){let l=i.slice(u,u+c.concurrency),f=performance.now(),h=await Promise.all(l.map(async g=>{let b=o.partitionOffsets[g],p=o.partitionOffsets[g+1],w=p-b;try{let y=await fetch(o.partitionVectorsUrl,{headers:{Range:`bytes=${b}-${p-1}`}});if(!y.ok)return{p:g,rowIds:[],vectors:[]};let _=await y.arrayBuffer(),A=new DataView(_).getUint32(0,!0),x=4+A*4,F=new Uint32Array(_.slice(4,x)),C=new Float32Array(_.slice(x));return r+=w,n&&n(r,s),{p:g,rowIds:Array.from(F),vectors:C,numVectors:A}}catch{return{p:g,rowIds:[],vectors:[]}}}));for(let g of h){let b={rowIds:g.rowIds,vectors:g.vectors,numVectors:g.numVectors??g.rowIds.length},p=g.rowIds.length*4+(g.vectors.byteLength||g.vectors.length*4);o._partitionCache.set(g.p,b,p),a.set(g.p,b)}let d=performance.now()-f;c.recentLatencies.push(d),c.recentLatencies.length>10&&c.recentLatencies.shift();let m=c.recentLatencies.reduce((g,b)=>g+b,0)/c.recentLatencies.length;m<50&&c.concurrency<c.maxConcurrency?c.concurrency++:m>200&&c.concurrency>c.minConcurrency&&c.concurrency--}return Vt(e,a,t,n)}function Vt(o,e,t,n){let s=0,r=0;for(let l of o){let f=e.get(l);f&&(s+=f.rowIds.length,r+=f.vectors.length)}let i=new Array(s),a=new Float32Array(r),c=0,u=0;for(let l of o){let f=e.get(l);if(f){for(let h=0;h<f.rowIds.length;h++)i[c++]=f.rowIds[h];a.set(f.vectors,u),u+=f.vectors.length}}return n&&n(100,100),{rowIds:i,vectors:a,preFlattened:!0}}async function Ct(o){if(!o.auxiliaryUrl||!o._auxBufferOffsets||o._rowIdCacheReady)return;let e=o.partitionLengths.reduce((s,r)=>s+r,0);if(e===0)return;let t=o._auxBufferOffsets[1],n=e*8;try{let s=await fetch(o.auxiliaryUrl,{headers:{Range:`bytes=${t}-${t+n-1}`}});if(!s.ok)return;let r=new Uint8Array(await s.arrayBuffer()),i=new DataView(r.buffer,r.byteOffset);o._rowIdCache=new Map;let a=0;for(let c=0;c<o.partitionLengths.length;c++){let u=o.partitionLengths[c],l=[];for(let f=0;f<u;f++){let h=Number(i.getBigUint64(a*8,!0));l.push({fragId:Math.floor(h/4294967296),rowOffset:h%4294967296}),a++}o._rowIdCache.set(c,l)}o._rowIdCacheReady=!0}catch{}}async function zt(o,e){if(o._rowIdCacheReady&&o._rowIdCache){let r=[];for(let i of e){let a=o._rowIdCache.get(i);if(a)for(let c of a)r.push({...c,partition:i})}return r}if(!o.auxiliaryUrl||!o._auxBufferOffsets)return null;let t=[];for(let r of e)r<o.partitionOffsets.length&&t.push({partition:r,startRow:o.partitionOffsets[r],numRows:o.partitionLengths[r]});if(t.length===0)return[];let n=[],s=o._auxBufferOffsets[1];for(let r of t){let i=s+r.startRow*8,a=i+r.numRows*8-1;try{let c=await fetch(o.auxiliaryUrl,{headers:{Range:`bytes=${i}-${a}`}});if(!c.ok)continue;let u=new Uint8Array(await c.arrayBuffer()),l=new DataView(u.buffer,u.byteOffset);for(let f=0;f<r.numRows;f++){let h=Number(l.getBigUint64(f*8,!0));n.push({fragId:Math.floor(h/4294967296),rowOffset:h%4294967296,partition:r.partition})}}catch{}}return n}function Gt(o,e){let t=0;for(let n of e)n<o.partitionLengths.length&&(t+=o.partitionLengths[n]);return t}var Ft=new Map,ot=new Map;function Ve(o,e){if(e>=o.length)return o;if(e<=0)return[];let t=0,n=o.length-1;for(;t<n;){let s=t+n>>1;o[s].score>o[t].score&&Q(o,t,s),o[n].score>o[t].score&&Q(o,t,n),o[s].score>o[n].score&&Q(o,s,n);let r=o[n].score,i=t;for(let a=t;a<n;a++)o[a].score>=r&&(Q(o,i,a),i++);if(Q(o,i,n),i===e-1)break;i<e-1?t=i+1:n=i-1}return o.slice(0,e)}function Q(o,e,t){let n=o[e];o[e]=o[t],o[t]=n}var z=class o{constructor(){this.centroids=null,this.numPartitions=0,this.dimension=0,this.partitionOffsets=[],this.partitionLengths=[],this.metricType="cosine",this.partitionIndexUrl=null,this.partitionStarts=null,this.hasPartitionIndex=!1,this._rowIdCache=null,this._rowIdCacheReady=!1,this._accessCounts=new Map}static async tryLoad(e){if(!e)return null;if(Ft.has(e))return Ft.get(e);if(ot.has(e))return ot.get(e);let t=o._doLoad(e);ot.set(e,t);try{let n=await t;return n&&Ft.set(e,n),n}finally{ot.delete(e)}}static async _doLoad(e){try{let t=await vt(e);if(!t)return null;let n=`${e}/_versions/${t}.manifest`,s=await fetch(n);if(!s.ok)return null;let r=await s.arrayBuffer(),i=Mt(new Uint8Array(r));if(!i?.uuid)return null;let a=`${e}/_indices/${i.uuid}/index.idx`,c=await fetch(a);if(!c.ok)return null;let u=await c.arrayBuffer(),l=Ot(new Uint8Array(u),i,o);if(!l)return null;l.auxiliaryUrl=`${e}/_indices/${i.uuid}/auxiliary.idx`,l.datasetBaseUrl=e;try{await It(l)}catch{}try{await xt(l)}catch{}try{await Ct(l)}catch{}return l}catch{return null}}async _loadPartitionIndex(){return xt(this)}fetchPartitionData(e,t=384,n=null){return $t(this,e,t,n)}async _loadAuxiliaryMetadata(){return It(this)}_parseColumnMetaForPartitions(e){return At(this,e)}_parseAuxiliaryPartitionInfo(e){return Dt(this,e)}async prefetchAllRowIds(){return Ct(this)}fetchPartitionRowIds(e){return zt(this,e)}getPartitionRowCount(e){return Gt(this,e)}findNearestPartitions(e,t=10){if(!this.centroids||e.length!==this.dimension)return[];t=Math.min(t,this.numPartitions);let n=new Array(this.numPartitions),s=0;for(let c=0;c<this.dimension;c++)s+=e[c]*e[c];let r=Math.sqrt(s);for(let c=0;c<this.numPartitions;c++){let u=c*this.dimension,l=0,f=0;for(let d=0;d<this.dimension;d++){let m=this.centroids[u+d];l+=e[d]*m,f+=m*m}let h=r*Math.sqrt(f);n[c]={idx:c,score:h===0?0:l/h}}let a=Ve(n,t).map(c=>c.idx);for(let c of a)this._accessCounts.set(c,(this._accessCounts.get(c)||0)+1);return a}async prefetchHotPartitions(e=10,t=3){if(!this._accessCounts||this._accessCounts.size===0)return;let n=[...this._accessCounts.entries()].filter(([s,r])=>r>=t).sort((s,r)=>r[1]-s[1]).slice(0,e).map(([s])=>s);n.length!==0&&await this.fetchPartitionData(n,this.dimension)}getAccessStats(){return{totalPartitions:this.numPartitions,accessedPartitions:this._accessCounts.size,topPartitions:[...this._accessCounts.entries()].sort((e,t)=>t[1]-e[1]).slice(0,10)}}};async function jt(o){let e=o.url.match(/^(.+\.lance)\/data\/.+\.lance$/);if(e){o._datasetBaseUrl=e[1];try{let t=`${o._datasetBaseUrl}/_versions/1.manifest`,n=await fetch(t);if(!n.ok)return;let s=await n.arrayBuffer();o._schema=$e(new Uint8Array(s))}catch{}}}function $e(o){let e=new DataView(o.buffer,o.byteOffset),t=e.getUint32(0,!0),n=4+t,s;if(n+4<o.length){let c=e.getUint32(n,!0);c>0&&n+4+c<=o.length?s=o.slice(n+4,n+4+c):s=o.slice(4,4+t)}else s=o.slice(4,4+t);let r=0,i=[],a=()=>{let c=0,u=0;for(;r<s.length;){let l=s[r++];if(c|=(l&127)<<u,(l&128)===0)break;u+=7}return c};for(;r<s.length;){let c=a(),u=c>>3,l=c&7;if(u===1&&l===2){let f=a(),h=r+f,d=null,m=null,g=null;for(;r<h;){let b=a(),p=b>>3,w=b&7;if(w===0){let y=a();p===3&&(m=y)}else if(w===2){let y=a(),_=s.slice(r,r+y);r+=y,p===2?d=new TextDecoder().decode(_):p===5&&(g=new TextDecoder().decode(_))}else w===5?r+=4:w===1&&(r+=8)}d&&i.push({name:d,id:m,type:g})}else if(l===0)a();else if(l===2){let f=a();r+=f}else l===5?r+=4:l===1&&(r+=8)}return i}function Wt(o){return o._schema&&o._schema.length>0?o._schema.map(e=>e.name):Array.from({length:o._numColumns},(e,t)=>`column_${t}`)}async function Ht(o){if(o._columnTypes)return o._columnTypes;let e=[];if(o._schema&&o._schema.length>0){for(let t=0;t<o._numColumns;t++){let n=o._schema[t],s=n?.type?.toLowerCase()||"",r=n?.name?.toLowerCase()||"",i="unknown",a=r.includes("embedding")||r.includes("vector")||r.includes("emb")||r==="vec";s.includes("utf8")||s.includes("string")||s.includes("large_utf8")?i="string":s.includes("fixed_size_list")||s.includes("vector")||a?i="vector":s.includes("int64")||s==="int64"?i="int64":s.includes("int32")||s==="int32"?i="int32":s.includes("int16")||s==="int16"?i="int16":s.includes("int8")||s==="int8"?i="int8":s.includes("float64")||s.includes("double")?i="float64":s.includes("float32")||s.includes("float")&&!s.includes("64")?i="float32":s.includes("bool")&&(i="bool"),e.push(i)}if(e.some(t=>t!=="unknown"))return o._columnTypes=e,e;e.length=0}for(let t=0;t<o._numColumns;t++){let n="unknown",s=o.columnNames[t]?.toLowerCase()||"",r=s.includes("embedding")||s.includes("vector")||s.includes("emb")||s==="vec";try{await o.readStringAt(t,0),n="string",e.push(n);continue}catch{}try{let i=await o.getColumnOffsetEntry(t);if(i.len>0){let a=await o.fetchRange(i.pos,i.pos+i.len-1),c=new Uint8Array(a),u=o._parseColumnMeta(c);if(u.rows>0&&u.size>0){let l=u.size/u.rows;if(r&&l>=4)n="vector";else if(l===8)n="int64";else if(l===4)try{let f=await o.readInt32AtIndices(t,[0]);if(f.length>0){let h=f[0];h>=-1e6&&h<=1e6&&Number.isInteger(h)?n="int32":n="float32"}}catch{n="float32"}else l>8&&l%4===0?n="vector":l===2?n="int16":l===1&&(n="int8")}}}catch{}e.push(n)}return o._columnTypes=e,e}function qt(o){let e=0,t=[],n=0,s=()=>{let f=0n,h=0n;for(;e<o.length;){let d=o[e++];if(f|=BigInt(d&127)<<h,(d&128)===0)break;h+=7n}return Number(f)};for(;e<o.length;){let f=s(),h=f>>3,d=f&7;if(h===2&&d===2){let m=s(),g=e+m,b=[],p=[],w=0;for(;e<g;){let y=s(),_=y>>3,I=y&7;if(_===1&&I===2){let A=s(),x=e+A;for(;e<x;)b.push(s())}else if(_===2&&I===2){let A=s(),x=e+A;for(;e<x;)p.push(s())}else if(_===3&&I===0)w=s();else if(I===0)s();else if(I===2){let A=s();e+=A}else I===5?e+=4:I===1&&(e+=8)}t.push({offsets:b,sizes:p,rows:w}),n+=w}else if(d===0)s();else if(d===2){let m=s();e+=m}else d===5?e+=4:d===1&&(e+=8)}let r=t[0]||{offsets:[],sizes:[],rows:0},i=r.offsets,a=r.sizes,c=0;for(let f of t){let h=f.sizes.length>1?1:0;c+=f.sizes[h]||0}let u=i.length>1?1:0,l=i.length>1?0:-1;return{offset:i[u]||0,size:t.length>1?c:a[u]||0,rows:n,nullBitmapOffset:l>=0?i[l]:null,nullBitmapSize:l>=0?a[l]:null,bufferOffsets:i,bufferSizes:a,pages:t}}function J(o){let e=[],t=0,n=()=>{let r=0,i=0;for(;t<o.length;){let a=o[t++];if(r|=(a&127)<<i,(a&128)===0)break;i+=7}return r};for(;t<o.length;){let r=n(),i=r>>3,a=r&7;if(i===2&&a===2){let c=n(),u=t+c,l=[0,0],f=[0,0],h=0;for(;t<u;){let d=n(),m=d>>3,g=d&7;if(m===1&&g===2){let b=n(),p=t+b,w=0;for(;t<p&&w<2;)l[w++]=n();t=p}else if(m===2&&g===2){let b=n(),p=t+b,w=0;for(;t<p&&w<2;)f[w++]=n();t=p}else if(m===3&&g===0)h=n();else if(m===4&&g===2){let b=n();t+=b}else if(g===0)n();else if(g===2){let b=n();t+=b}else g===5?t+=4:g===1&&(t+=8)}e.push({offsetsStart:l[0],offsetsSize:f[0],dataStart:l[1],dataSize:f[1],rows:h})}else if(a===0)n();else if(a===2){let c=n();t+=c}else a===5?t+=4:a===1&&(t+=8)}return{...e[0]||{offsetsStart:0,offsetsSize:0,dataStart:0,dataSize:0,rows:0},pages:e}}function k(o,e,t=1024){if(o.length===0)return[];let n=[...o].map((i,a)=>({idx:i,origPos:a}));n.sort((i,a)=>i.idx-a.idx);let s=[],r=0;for(let i=1;i<=n.length;i++)(i===n.length||(n[i].idx-n[i-1].idx)*e>t)&&(s.push({startIdx:n[r].idx,endIdx:n[i-1].idx,items:n.slice(r,i)}),r=i);return s}async function Kt(o,e,t){if(t.length===0)return new BigInt64Array(0);let n=await o.getColumnOffsetEntry(e),s=await o.fetchRange(n.pos,n.pos+n.len-1),r=o._parseColumnMeta(new Uint8Array(s)),i=new BigInt64Array(t.length),a=8,c=k(t,a);return await Promise.all(c.map(async u=>{let l=r.offset+u.startIdx*a,f=r.offset+(u.endIdx+1)*a-1,h=await o.fetchRange(l,f),d=new DataView(h);for(let m of u.items){let g=(m.idx-u.startIdx)*a;i[m.origPos]=d.getBigInt64(g,!0)}})),i}async function Yt(o,e,t){if(t.length===0)return new Float64Array(0);let n=await o.getColumnOffsetEntry(e),s=await o.fetchRange(n.pos,n.pos+n.len-1),r=o._parseColumnMeta(new Uint8Array(s)),i=new Float64Array(t.length),a=8,c=k(t,a);return await Promise.all(c.map(async u=>{let l=r.offset+u.startIdx*a,f=r.offset+(u.endIdx+1)*a-1,h=await o.fetchRange(l,f),d=new DataView(h);for(let m of u.items){let g=(m.idx-u.startIdx)*a;i[m.origPos]=d.getFloat64(g,!0)}})),i}async function Qt(o,e,t){if(t.length===0)return new Int32Array(0);let n=await o.getColumnOffsetEntry(e),s=await o.fetchRange(n.pos,n.pos+n.len-1),r=o._parseColumnMeta(new Uint8Array(s)),i=new Int32Array(t.length),a=4,c=k(t,a);return await Promise.all(c.map(async u=>{let l=r.offset+u.startIdx*a,f=r.offset+(u.endIdx+1)*a-1,h=await o.fetchRange(l,f),d=new DataView(h);for(let m of u.items){let g=(m.idx-u.startIdx)*a;i[m.origPos]=d.getInt32(g,!0)}})),i}async function Jt(o,e,t){if(t.length===0)return new Float32Array(0);let n=await o.getColumnOffsetEntry(e),s=await o.fetchRange(n.pos,n.pos+n.len-1),r=o._parseColumnMeta(new Uint8Array(s)),i=new Float32Array(t.length),a=4,c=k(t,a);return await Promise.all(c.map(async u=>{let l=r.offset+u.startIdx*a,f=r.offset+(u.endIdx+1)*a-1,h=await o.fetchRange(l,f),d=new DataView(h);for(let m of u.items){let g=(m.idx-u.startIdx)*a;i[m.origPos]=d.getFloat32(g,!0)}})),i}async function Zt(o,e,t){if(t.length===0)return new Int16Array(0);let n=await o.getColumnOffsetEntry(e),s=await o.fetchRange(n.pos,n.pos+n.len-1),r=o._parseColumnMeta(new Uint8Array(s)),i=new Int16Array(t.length),a=2,c=k(t,a);return await Promise.all(c.map(async u=>{let l=r.offset+u.startIdx*a,f=r.offset+(u.endIdx+1)*a-1,h=await o.fetchRange(l,f),d=new DataView(h);for(let m of u.items){let g=(m.idx-u.startIdx)*a;i[m.origPos]=d.getInt16(g,!0)}})),i}async function Xt(o,e,t){if(t.length===0)return new Uint8Array(0);let n=await o.getColumnOffsetEntry(e),s=await o.fetchRange(n.pos,n.pos+n.len-1),r=o._parseColumnMeta(new Uint8Array(s)),i=new Uint8Array(t.length),a=1,c=k(t,a);return await Promise.all(c.map(async u=>{let l=r.offset+u.startIdx*a,f=r.offset+(u.endIdx+1)*a-1,h=await o.fetchRange(l,f),d=new Uint8Array(h);for(let m of u.items){let g=m.idx-u.startIdx;i[m.origPos]=d[g]}})),i}async function te(o,e,t){if(t.length===0)return new Uint8Array(0);let n=await o.getColumnOffsetEntry(e),s=await o.fetchRange(n.pos,n.pos+n.len-1),r=o._parseColumnMeta(new Uint8Array(s)),i=new Uint8Array(t.length),a=t.map(g=>Math.floor(g/8)),c=[...new Set(a)].sort((g,b)=>g-b);if(c.length===0)return i;let u=c[0],l=c[c.length-1],f=r.offset+u,h=r.offset+l,d=await o.fetchRange(f,h),m=new Uint8Array(d);for(let g=0;g<t.length;g++){let b=t[g],p=Math.floor(b/8),w=b%8,y=p-u;y>=0&&y<m.length&&(i[g]=m[y]>>w&1)}return i}async function ee(o,e,t){let n=await o.getColumnOffsetEntry(e),s=await o.fetchRange(n.pos,n.pos+n.len-1),r=J(new Uint8Array(s));if(r.offsetsSize===0||r.dataSize===0)throw new Error(`Not a string column - offsetsSize=${r.offsetsSize}, dataSize=${r.dataSize}`);let i=r.offsetsSize/r.rows;if(i!==4&&i!==8)throw new Error(`Not a string column - bytesPerOffset=${i}, expected 4 or 8`);if(t>=r.rows)return"";let a=i,c=r.offsetsStart+t*a,u=await o.fetchRange(c,c+a*2-1),l=new DataView(u),f,h;if(a===4?(f=l.getUint32(0,!0),h=l.getUint32(4,!0)):(f=Number(l.getBigUint64(0,!0)),h=Number(l.getBigUint64(8,!0))),h<=f)return"";let d=h-f,m=await o.fetchRange(r.dataStart+f,r.dataStart+h-1);return new TextDecoder().decode(m)}async function ne(o,e,t){if(t.length===0)return[];let n=await o.getColumnOffsetEntry(e),s=await o.fetchRange(n.pos,n.pos+n.len-1),r=J(new Uint8Array(s));if(!r.pages||r.pages.length===0)return t.map(()=>"");let i=new Array(t.length).fill(""),a=0,c=[];for(let l of r.pages){if(l.offsetsSize===0||l.dataSize===0||l.rows===0){a+=l.rows;continue}c.push({start:a,end:a+l.rows,page:l}),a+=l.rows}let u=new Map;for(let l=0;l<t.length;l++){let f=t[l];for(let h=0;h<c.length;h++){let d=c[h];if(f>=d.start&&f<d.end){u.has(h)||u.set(h,[]),u.get(h).push({globalIdx:f,localIdx:f-d.start,resultIdx:l});break}}}for(let[l,f]of u){let d=c[l].page,m=d.offsetsSize/d.rows;if(m!==4&&m!==8)continue;f.sort((w,y)=>w.localIdx-y.localIdx);let g=[],b=0;for(let w=1;w<=f.length;w++)(w===f.length||f[w].localIdx-f[w-1].localIdx>100)&&(g.push(f.slice(b,w)),b=w);let p=[];if(await Promise.all(g.map(async w=>{let y=w[0].localIdx,_=w[w.length-1].localIdx,I=y>0?y-1:0,A=_,x=d.offsetsStart+I*m,F=d.offsetsStart+(A+1)*m-1,C=await o.fetchRange(x,F),B=new DataView(C);for(let v of w){let E=v.localIdx-I,R,U;m===4?(U=B.getUint32(E*4,!0),R=v.localIdx===0?0:B.getUint32((E-1)*4,!0)):(U=Number(B.getBigUint64(E*8,!0)),R=v.localIdx===0?0:Number(B.getBigUint64((E-1)*8,!0))),U>R&&p.push({start:R,end:U,resultIdx:v.resultIdx,dataStart:d.dataStart})}})),p.length>0){p.sort((_,I)=>_.start-I.start);let w=[],y=0;for(let _=1;_<=p.length;_++)(_===p.length||p[_].start-p[_-1].end>4096)&&(w.push({rangeStart:p[y].start,rangeEnd:p[_-1].end,items:p.slice(y,_),dataStart:p[y].dataStart}),y=_);await Promise.all(w.map(async _=>{let I=await o.fetchRange(_.dataStart+_.rangeStart,_.dataStart+_.rangeEnd-1),A=new Uint8Array(I);for(let x of _.items){let F=x.start-_.rangeStart,C=x.end-x.start,B=A.slice(F,F+C);i[x.resultIdx]=new TextDecoder().decode(B)}}))}}return i}async function Tt(o,e){let t=await o.getColumnOffsetEntry(e);if(t.len===0)return{rows:0,dimension:0};let n=await o.fetchRange(t.pos,t.pos+t.len-1),s=o._parseColumnMeta(new Uint8Array(n));if(s.rows===0)return{rows:0,dimension:0};let r=0;if(s.pages&&s.pages.length>0){let i=s.pages[0],a=i.sizes.length>1?1:0,c=i.sizes[a]||0,u=i.rows||0;u>0&&c>0&&(r=Math.floor(c/(u*4)))}else s.size>0&&(r=Math.floor(s.size/(s.rows*4)));return{rows:s.rows,dimension:r}}async function se(o,e,t){let n=await o.getColumnOffsetEntry(e),s=await o.fetchRange(n.pos,n.pos+n.len-1),r=o._parseColumnMeta(new Uint8Array(s));if(r.rows===0)return new Float32Array(0);if(t>=r.rows)return new Float32Array(0);let i=Math.floor(r.size/(r.rows*4));if(i===0)return new Float32Array(0);let a=r.offset+t*i*4,c=a+i*4-1,u=await o.fetchRange(a,c);return new Float32Array(u)}async function St(o,e,t){if(t.length===0)return[];let n=await o.getColumnOffsetEntry(e),s=await o.fetchRange(n.pos,n.pos+n.len-1),r=o._parseColumnMeta(new Uint8Array(s));if(r.rows===0)return t.map(()=>new Float32Array(0));let i=Math.floor(r.size/(r.rows*4));if(i===0)return t.map(()=>new Float32Array(0));let a=i*4,c=new Array(t.length),u=k(t,a,a*50),l=6;for(let f=0;f<u.length;f+=l){let h=u.slice(f,f+l);await Promise.all(h.map(async d=>{try{let m=r.offset+d.startIdx*a,g=r.offset+(d.endIdx+1)*a-1,b=await o.fetchRange(m,g);for(let p of d.items){let w=(p.idx-d.startIdx)*a;c[p.origPos]=new Float32Array(b.slice(w,w+a))}}catch{for(let g of d.items)c[g.origPos]=new Float32Array(0)}}))}return c}function re(o,e){if(o.length!==e.length)return 0;let t=0,n=0,s=0;for(let i=0;i<o.length;i++)t+=o[i]*e[i],n+=o[i]*o[i],s+=e[i]*e[i];let r=Math.sqrt(n)*Math.sqrt(s);return r===0?0:t/r}async function oe(o,e,t,n=10,s=null,r={}){let{nprobe:i=10}=r,a=await Tt(o,e);if(a.dimension===0||a.dimension!==t.length)throw new Error(`Dimension mismatch: query=${t.length}, column=${a.dimension}`);if(!o.hasIndex())throw new Error("No IVF index found. Vector search requires an IVF index for efficient querying.");if(o._ivfIndex.dimension!==t.length)throw new Error(`Query dimension (${t.length}) does not match index dimension (${o._ivfIndex.dimension}).`);return await je(o,e,t,n,i,s)}async function je(o,e,t,n,s,r){r&&r(0,100);let i=o._ivfIndex.findNearestPartitions(t,s),a=await o._ivfIndex.fetchPartitionRowIds(i);if(a&&a.length>0)return await We(o,e,t,n,a,r);throw new Error("Failed to fetch row IDs from IVF index. Dataset may be missing auxiliary.idx or ivf_partitions.bin.")}async function We(o,e,t,n,s,r){let i=t.length,a=new Map;for(let g of s)a.has(g.fragId)||a.set(g.fragId,[]),a.get(g.fragId).push(g.rowOffset);let c=[],u=[],l=0,f=s.length;for(let[g,b]of a){r&&r(l,f);let p=await St(o,e,b);for(let w=0;w<b.length;w++){let y=p[w];y&&y.length===i&&(c.push(y),u.push(g*5e4+b[w])),l++}}let h,d=M();d.isAvailable()&&(h=await d.batchCosineSimilarity(t,c,!0)),h||(h=o.lanceql.batchCosineSimilarity(t,c,!0));let m=[];for(let g=0;g<h.length;g++){let b=h[g],p=u[g];m.length<n?(m.push({idx:p,score:b}),m.sort((w,y)=>y.score-w.score)):b>m[n-1].score&&(m[n-1]={idx:p,score:b},m.sort((w,y)=>y.score-w.score))}return r&&r(f,f),{indices:m.map(g=>g.idx),scores:m.map(g=>g.score),usedIndex:!0,searchedRows:c.length}}async function ie(o,e){let t=await o.getColumnOffsetEntry(e),n=await o.fetchRange(t.pos,t.pos+t.len-1),s=o._parseColumnMeta(new Uint8Array(n));if(!s.pages||s.pages.length===0||s.rows===0)return new Float32Array(0);let r=s.pages[0],i=r.sizes.length>1?1:0,a=r.sizes[i]||0,c=r.rows||0;if(c===0||a===0)return new Float32Array(0);let u=Math.floor(a/(c*4));if(u===0)return new Float32Array(0);let l=s.rows,f=new Float32Array(l*u),h=s.pages.map(async(g,b)=>{let p=g.sizes.length>1?1:0,w=g.offsets[p]||0,y=g.sizes[p]||0;if(y===0)return{pageIdx:b,data:new Float32Array(0),rows:0};let _=await o.fetchRange(w,w+y-1),I=new Float32Array(_);return{pageIdx:b,data:I,rows:g.rows}}),d=await Promise.all(h),m=0;for(let g of d.sort((b,p)=>b.pageIdx-p.pageIdx))f.set(g.data,m),m+=g.rows*u;return f}async function ae(o,{offset:e=0,limit:t=50,columns:n=null}={}){let s=n||Array.from({length:o._numColumns},(h,d)=>d),r=await o.getRowCount(0),i=Math.min(e,r),a=Math.min(t,r-i);if(a<=0)return{columns:s.map(()=>[]),columnNames:o.columnNames.slice(0,s.length),total:r};let c=Array.from({length:a},(h,d)=>i+d),u=await o.detectColumnTypes(),l=s.map(async h=>{let d=u[h]||"unknown";try{switch(d){case"string":case"utf8":case"large_utf8":return await o.readStringsAtIndices(h,c);case"int64":return Array.from(await o.readInt64AtIndices(h,c));case"int32":return Array.from(await o.readInt32AtIndices(h,c));case"int16":return Array.from(await o.readInt16AtIndices(h,c));case"uint8":return Array.from(await o.readUint8AtIndices(h,c));case"float64":case"double":return Array.from(await o.readFloat64AtIndices(h,c));case"float32":case"float":return Array.from(await o.readFloat32AtIndices(h,c));case"bool":case"boolean":return await o.readBoolAtIndices(h,c);case"fixed_size_list":case"vector":let m=await o.readVectorsAtIndices(h,c);return Array.isArray(m)?m:Array.from(m);default:return await o.readStringsAtIndices(h,c)}}catch{return c.map(()=>null)}});return{columns:await Promise.all(l),columnNames:s.map(h=>o.columnNames[h]||`column_${h}`),total:r}}var G=class o{constructor(e,t,n,s){this.lanceql=e,this.wasm=e.wasm,this.memory=e.memory,this.url=t,this.fileSize=n;let r=new Uint8Array(s);if(this.footerPtr=this.wasm.alloc(r.length),!this.footerPtr)throw new Error("Failed to allocate memory for footer");this.footerLen=r.length,new Uint8Array(this.memory.buffer).set(r,this.footerPtr),this._numColumns=this.wasm.parseFooterGetColumns(this.footerPtr,this.footerLen),this._majorVersion=this.wasm.parseFooterGetMajorVersion(this.footerPtr,this.footerLen),this._minorVersion=this.wasm.parseFooterGetMinorVersion(this.footerPtr,this.footerLen),this._columnMetaStart=this.wasm.getColumnMetaStart(this.footerPtr,this.footerLen),this._columnMetaOffsetsStart=this.wasm.getColumnMetaOffsetsStart(this.footerPtr,this.footerLen),this._columnMetaCache=new Map,this._columnOffsetCache=new Map,this._columnTypes=null,this._schema=null,this._datasetBaseUrl=null,this._ivfIndex=null}static async open(e,t){let n=await fetch(t,{method:"HEAD"});if(!n.ok)throw new Error(`HTTP error: ${n.status}`);let s=n.headers.get("Content-Length");if(!s)throw new Error("Server did not return Content-Length");let r=parseInt(s,10),a=r-40,c=await fetch(t,{headers:{Range:`bytes=${a}-${r-1}`}});if(!c.ok&&c.status!==206)throw new Error(`HTTP error: ${c.status}`);let u=await c.arrayBuffer(),l=new Uint8Array(u),f=String.fromCharCode(l[36],l[37],l[38],l[39]);if(f!=="LANC")throw new Error(`Invalid Lance file: expected LANC magic, got "${f}"`);let h=new o(e,t,r,u);await jt(h);let d=t.includes("/data/");return d||await h._tryLoadIndex(),d||console.log(`[LanceQL] Loaded: ${h._numColumns} columns, ${(r/1024/1024).toFixed(1)}MB, schema: ${h._schema?"yes":"no"}, index: ${h.hasIndex()?"yes":"no"}`),h}async _tryLoadIndex(){if(this._datasetBaseUrl)try{this._ivfIndex=await z.tryLoad(this._datasetBaseUrl)}catch{}}hasIndex(){return this._ivfIndex!==null&&this._ivfIndex.centroids!==null}get columnNames(){return Wt(this)}get schema(){return this._schema}get datasetBaseUrl(){return this._datasetBaseUrl}get numColumns(){return this._numColumns}get size(){return this.fileSize}get version(){return{major:this._majorVersion,minor:this._minorVersion}}get columnMetaStart(){return Number(this._columnMetaStart)}get columnMetaOffsetsStart(){return Number(this._columnMetaOffsetsStart)}async fetchRange(e,t){(e<0||t<e||t>=this.size)&&console.error(`Invalid range: ${e}-${t}, file size: ${this.size}`);let n=kt();if(n.enabled){let i=await n.getRange(this.url,e,t,this.size);return this._onFetch&&this._onFetch(i.byteLength,1),i}let s=await fetch(this.url,{headers:{Range:`bytes=${e}-${t}`}});if(!s.ok&&s.status!==206)throw console.error(`Fetch failed: ${s.status} for range ${e}-${t}`),new Error(`HTTP error: ${s.status}`);let r=await s.arrayBuffer();return this._onFetch&&this._onFetch(r.byteLength,1),r}onFetch(e){this._onFetch=e}close(){this.footerPtr&&(this.wasm.free(this.footerPtr,this.footerLen),this.footerPtr=null)}async getColumnOffsetEntry(e){if(e>=this._numColumns)return{pos:0,len:0};if(this._columnOffsetCache.has(e))return this._columnOffsetCache.get(e);let t=this.columnMetaOffsetsStart+e*16,n=await this.fetchRange(t,t+15),s=new DataView(n),r={pos:Number(s.getBigUint64(0,!0)),len:Number(s.getBigUint64(8,!0))};return this._columnOffsetCache.set(e,r),r}async getColumnDebugInfo(e){let t=await this.getColumnOffsetEntry(e);if(t.len===0)return{offset:0,size:0,rows:0};let n=await this.fetchRange(t.pos,t.pos+t.len-1),s=new Uint8Array(n);return this._parseColumnMeta(s)}_parseColumnMeta(e){return qt(e)}_parseStringColumnMeta(e){return J(e)}_batchIndices(e,t,n=1024){return k(e,t,n)}async _getCachedColumnMeta(e){if(this._columnMetaCache.has(e))return this._columnMetaCache.get(e);let t=await this.getColumnOffsetEntry(e);if(t.len===0)return null;let n=await this.fetchRange(t.pos,t.pos+t.len-1),s=new Uint8Array(n);return this._columnMetaCache.set(e,s),s}readInt64AtIndices(e,t){return Kt(this,e,t)}readFloat64AtIndices(e,t){return Yt(this,e,t)}readInt32AtIndices(e,t){return Qt(this,e,t)}readFloat32AtIndices(e,t){return Jt(this,e,t)}readInt16AtIndices(e,t){return Zt(this,e,t)}readUint8AtIndices(e,t){return Xt(this,e,t)}readBoolAtIndices(e,t){return te(this,e,t)}readStringAt(e,t){return ee(this,e,t)}readStringsAtIndices(e,t){return ne(this,e,t)}async getRowCount(e){return(await this.getColumnDebugInfo(e)).rows}detectColumnTypes(){return Ht(this)}getVectorInfo(e){return Tt(this,e)}readVectorAt(e,t){return se(this,e,t)}readVectorsAtIndices(e,t){return St(this,e,t)}cosineSimilarity(e,t){return re(e,t)}vectorSearch(e,t,n=10,s=null,r={}){return oe(this,e,t,n,s,r)}readVectorColumn(e){return ie(this,e)}readRows(e={}){return ae(this,e)}};var Z=class{constructor(e="lanceql-cache",t=1){this.dbName=e,this.version=t,this.db=null}async open(){return this.db?this.db:new Promise((e,t)=>{let n=indexedDB.open(this.dbName,this.version);n.onerror=()=>t(n.error),n.onsuccess=()=>{this.db=n.result,e(this.db)},n.onupgradeneeded=s=>{let r=s.target.result;r.objectStoreNames.contains("datasets")||r.createObjectStore("datasets",{keyPath:"url"}).createIndex("timestamp","timestamp")}})}async get(e){try{let t=await this.open();return new Promise(n=>{let i=t.transaction("datasets","readonly").objectStore("datasets").get(e);i.onsuccess=()=>n(i.result||null),i.onerror=()=>n(null)})}catch(t){return console.warn("[MetadataCache] Get failed:",t),null}}async set(e,t){try{let n=await this.open();return new Promise((s,r)=>{let a=n.transaction("datasets","readwrite").objectStore("datasets"),c={url:e,timestamp:Date.now(),...t},u=a.put(c);u.onsuccess=()=>s(),u.onerror=()=>r(u.error)})}catch(n){console.warn("[MetadataCache] Set failed:",n)}}async delete(e){try{let t=await this.open();return new Promise(n=>{let s=t.transaction("datasets","readwrite");s.objectStore("datasets").delete(e),s.oncomplete=()=>n()})}catch(t){console.warn("[MetadataCache] Delete failed:",t)}}async clear(){try{let e=await this.open();return new Promise(t=>{let n=e.transaction("datasets","readwrite");n.objectStore("datasets").clear(),n.oncomplete=()=>t()})}catch(e){console.warn("[MetadataCache] Clear failed:",e)}}},Ln=new Z;function ce(o,e,t){let n=0,s=0,r=0,i=0,a=0,c=()=>{let f=0,h=0;for(;a<o.length;){let d=o[a++];if(f|=(d&127)<<h,(d&128)===0)break;h+=7}return f};for(;a<o.length;){let f=c(),h=f>>3,d=f&7;if(d===0){let m=c();h===1?n=m:h===2?s=m:h===3?r=m:h===4&&(i=m)}else if(d===2){let m=c();a+=m}else d===5?a+=4:d===1&&(a+=8)}if(i===0)return null;let l=`_deletions/${e}-${s}-${r}.${n===0?"arrow":"bin"}`;return{fileType:n===0?"arrow":"bitmap",readVersion:s,id:r,numDeletedRows:i,path:l,url:`${t}/${l}`}}function qe(o){let e=new Set,t=0;o.length>=8&&String.fromCharCode(...o.slice(0,6))==="ARROW1"&&(t=8);let n=new DataView(o.buffer,o.byteOffset,o.byteLength);for(;t<o.length-4;)if(n.getInt32(t,!0)===-1){if(t+=4,t+4>o.length)break;let r=n.getInt32(t,!0);for(t+=4+r;t+4<=o.length&&n.getInt32(t,!0)!==-1;){let a=n.getInt32(t,!0);a>=0&&a<1e7&&e.add(a),t+=4}}else t++;return e}function Ke(o){let e=new Set,t=new DataView(o.buffer,o.byteOffset,o.byteLength);if(o.length<8)return e;let n=t.getUint32(0,!0);if(n===12346||n===12347){let s=n===12347,r=4,i=t.getUint16(r,!0);r+=2;let a=r;r+=i*4;for(let c=0;c<i&&r<o.length;c++){let u=t.getUint16(a+c*4,!0),l=t.getUint16(a+c*4+2,!0)+1,f=u<<16;for(let h=0;h<l&&r+2<=o.length;h++){let d=t.getUint16(r,!0);e.add(f|d),r+=2}}}return e}async function le(o,e){if(o._deletedRows.has(e))return o._deletedRows.get(e);let t=o._fragments[e];if(!t?.deletionFile){let i=new Set;return o._deletedRows.set(e,i),i}let{url:n,fileType:s,numDeletedRows:r}=t.deletionFile;console.log(`[LanceQL] Loading ${r} deletions from ${n} (${s})`);try{let i=await fetch(n);if(!i.ok){console.warn(`[LanceQL] Failed to load deletion file: ${i.status}`);let l=new Set;return o._deletedRows.set(e,l),l}let a=await i.arrayBuffer(),c=new Uint8Array(a),u;return s==="arrow"?u=qe(c):u=Ke(c),console.log(`[LanceQL] Loaded ${u.size} deleted rows for fragment ${e}`),o._deletedRows.set(e,u),u}catch(i){console.error("[LanceQL] Error loading deletion file:",i);let a=new Set;return o._deletedRows.set(e,a),a}}async function fe(o,e,t,n=10,s=null,r={}){let{normalized:i=!0,workerPool:a=null,useIndex:c=!0,nprobe:u=20}=r,l=e;if(l<0)throw new Error("No vector column found in dataset");let f=t.length;if(!o.hasIndex())throw new Error("No IVF index found. Vector search requires an IVF index for efficient querying.");if(o._ivfIndex.dimension!==f)throw new Error(`Query dimension (${f}) does not match index dimension (${o._ivfIndex.dimension}).`);if(!o._ivfIndex.hasPartitionIndex)throw new Error("IVF partition index (ivf_partitions.bin) not found. Required for efficient search.");return await Ye(o,t,n,l,u,s)}async function Ye(o,e,t,n,s,r){let i=o._ivfIndex.findNearestPartitions(e,s),a=await o._ivfIndex.fetchPartitionData(i,o._ivfIndex.dimension,(p,w)=>{if(r){let y=w>0?p/w:0;r(Math.floor(y*80),100)}});if(!a||a.rowIds.length===0)throw new Error("IVF index not available. This dataset requires ivf_vectors.bin for efficient search.");let{rowIds:c,vectors:u,preFlattened:l}=a,f=e.length,h=l?u.length/f:u.length,d=new Float32Array(h),m=M();if(m.isAvailable()){let p=m.getMaxVectorsPerBatch(f);if(l)for(let w=0;w<h;w+=p){let y=Math.min(w+p,h),_=y-w,I=u.subarray(w*f,y*f);try{let A=await m.batchCosineSimilarity(e,I,!0,!0);if(A){d.set(A,w);continue}}catch{}if(o.lanceql?.batchCosineSimilarityFlat){let A=o.lanceql.batchCosineSimilarityFlat(e,I,f,!0);d.set(A,w)}else for(let A=0;A<_;A++){let x=A*f,F=0;for(let C=0;C<f;C++)F+=e[C]*I[x+C];d[w+A]=F}}else for(let w=0;w<h;w+=p){let y=Math.min(w+p,h),_=u.slice(w,y);try{let I=await m.batchCosineSimilarity(e,_,!0,!1);if(I){d.set(I,w);continue}}catch{}for(let I=0;I<_.length;I++){let A=_[I];if(!A||A.length!==f)continue;let x=0;for(let F=0;F<f;F++)x+=e[F]*A[F];d[w+I]=x}}}else if(l)for(let p=0;p<h;p++){let w=p*f,y=0;for(let _=0;_<f;_++)y+=e[_]*u[w+_];d[p]=y}else for(let p=0;p<h;p++){let w=u[p];if(!w||w.length!==f)continue;let y=0;for(let _=0;_<f;_++)y+=e[_]*w[_];d[p]=y}r&&r(90,100);let g=new Array(c.length);for(let p=0;p<c.length;p++)g[p]={index:c[p],score:d[p]};let b=Math.min(t,g.length);return Qe(g,b),r&&r(100,100),{indices:g.slice(0,b).map(p=>p.index),scores:g.slice(0,b).map(p=>p.score),usedIndex:!0,searchedRows:c.length}}function Qe(o,e){if(e>=o.length||e<=0)return;let t=0,n=o.length-1;for(;t<n;){let s=t+n>>1;o[s].score>o[t].score&&X(o,t,s),o[n].score>o[t].score&&X(o,t,n),o[s].score>o[n].score&&X(o,s,n);let r=o[n].score,i=t;for(let a=t;a<n;a++)o[a].score>=r&&(X(o,i,a),i++);if(X(o,i,n),i===e-1)break;i<e-1?t=i+1:n=i-1}}function X(o,e,t){let n=o[e];o[e]=o[t],o[t]=n}function ue(o){if(!o._schema)return-1;for(let e=0;e<o._schema.length;e++){let t=o._schema[e];if(t.name==="embedding"||t.name==="vector"||t.type==="fixed_size_list"||t.type==="list")return e}return o._schema.length-1}function Pt(o,e){let t=0;for(let n=0;n<o._fragments.length;n++){let s=o._fragments[n];if(e<t+s.numRows)return{fragmentIndex:n,localIndex:e-t};t+=s.numRows}return null}function D(o,e){let t=new Map;for(let n of e){let s=Pt(o,n);s&&(t.has(s.fragmentIndex)||t.set(s.fragmentIndex,{localIndices:[],globalIndices:[]}),t.get(s.fragmentIndex).localIndices.push(s.localIndex),t.get(s.fragmentIndex).globalIndices.push(n))}return t}async function Rt(o,{offset:e=0,limit:t=50,columns:n=null,_isPrefetch:s=!1}={}){let r=[],i=0;for(let m=0;m<o._fragments.length;m++){let g=o._fragments[m],b=i,p=i+g.numRows;if(p>e&&b<e+t){let w=Math.max(0,e-b),y=Math.min(g.numRows,e+t-b);r.push({fragmentIndex:m,localOffset:w,localLimit:y-w,globalStart:b+w})}if(i=p,i>=e+t)break}if(r.length===0)return{columns:[],columnNames:o.columnNames,total:o._totalRows};let a=r.map(async m=>{let b=await(await o.openFragment(m.fragmentIndex)).readRows({offset:m.localOffset,limit:m.localLimit,columns:n});return{...m,result:b}}),c=await Promise.all(a);c.sort((m,g)=>m.globalStart-g.globalStart);let u=[],l=c[0]?.result.columnNames||o.columnNames,f=n?n.length:o._numColumns;for(let m=0;m<f;m++){let g=[];for(let b of c)b.result.columns[m]&&g.push(...b.result.columns[m]);u.push(g)}let h={columns:u,columnNames:l,total:o._totalRows},d=e+t;return!s&&d<o._totalRows&&t<=100&&Ze(o,d,t,n),h}function Ze(o,e,t,n){let s=`${e}-${t}-${n?.join(",")||"all"}`;if(o._prefetchCache?.has(s))return;o._prefetchCache||(o._prefetchCache=new Map);let r=Rt(o,{offset:e,limit:t,columns:n,_isPrefetch:!0}).then(i=>{o._prefetchCache.set(s,i)}).catch(()=>{});o._prefetchCache.set(s,r)}async function he(o,e,t){let n=D(o,t),s=new Map,r=[];for(let[i,a]of n)r.push((async()=>{let u=await(await o.openFragment(i)).readStringsAtIndices(e,a.localIndices);for(let l=0;l<a.globalIndices.length;l++)s.set(a.globalIndices[l],u[l])})());return await Promise.all(r),t.map(i=>s.get(i)||null)}async function de(o,e,t){let n=D(o,t),s=new Map,r=[];for(let[i,a]of n)r.push((async()=>{let u=await(await o.openFragment(i)).readInt64AtIndices(e,a.localIndices);for(let l=0;l<a.globalIndices.length;l++)s.set(a.globalIndices[l],u[l])})());return await Promise.all(r),new BigInt64Array(t.map(i=>s.get(i)||0n))}async function me(o,e,t){let n=D(o,t),s=new Map,r=[];for(let[i,a]of n)r.push((async()=>{let u=await(await o.openFragment(i)).readFloat64AtIndices(e,a.localIndices);for(let l=0;l<a.globalIndices.length;l++)s.set(a.globalIndices[l],u[l])})());return await Promise.all(r),new Float64Array(t.map(i=>s.get(i)||0))}async function we(o,e,t){let n=D(o,t),s=new Map,r=[];for(let[i,a]of n)r.push((async()=>{let u=await(await o.openFragment(i)).readInt32AtIndices(e,a.localIndices);for(let l=0;l<a.globalIndices.length;l++)s.set(a.globalIndices[l],u[l])})());return await Promise.all(r),new Int32Array(t.map(i=>s.get(i)||0))}async function ge(o,e,t){let n=D(o,t),s=new Map,r=[];for(let[i,a]of n)r.push((async()=>{let u=await(await o.openFragment(i)).readFloat32AtIndices(e,a.localIndices);for(let l=0;l<a.globalIndices.length;l++)s.set(a.globalIndices[l],u[l])})());return await Promise.all(r),new Float32Array(t.map(i=>s.get(i)||0))}function tn(o){let e={type:"SELECT",columns:"*",limit:null,offset:null,where:null},t=o.toUpperCase();if(t.includes("LIMIT")){let n=o.match(/LIMIT\s+(\d+)/i);n&&(e.limit=parseInt(n[1]))}if(t.includes("OFFSET")){let n=o.match(/OFFSET\s+(\d+)/i);n&&(e.offset=parseInt(n[1]))}return t.includes("WHERE")&&(e.where=!0),e}async function pe(o,e){let t=tn(e);if(t.type==="SELECT"&&t.columns==="*"&&!t.where){let l=t.limit||50,f=t.offset||0;return await o.readRows({offset:f,limit:l})}let n=o._fragments.map(async(l,f)=>{let h=await o.openFragment(f);try{return await h.executeSQL(e)}catch(d){return console.warn(`Fragment ${f} query failed:`,d),{columns:[],columnNames:[],total:0}}}),s=await Promise.all(n);if(s.length===0||s.every(l=>l.columns.length===0))return{columns:[],columnNames:o.columnNames,total:0};let r=s.find(l=>l.columns.length>0);if(!r)return{columns:[],columnNames:o.columnNames,total:0};let i=r.columns.length,a=r.columnNames,c=Array.from({length:i},()=>[]),u=0;for(let l of s){for(let f=0;f<i&&f<l.columns.length;f++)c[f].push(...l.columns[f]);u+=l.total}if(t.limit){let l=t.offset||0;for(let f=0;f<i;f++)c[f]=c[f].slice(l,l+t.limit)}return{columns:c,columnNames:a,total:u}}var it=new Z,j=class o{constructor(e,t){this.lanceql=e,this.baseUrl=t.replace(/\/$/,""),this._fragments=[],this._schema=null,this._totalRows=0,this._numColumns=0,this._onFetch=null,this._fragmentFiles=new Map,this._isRemote=!0,this._ivfIndex=null,this._deletedRows=new Map}static async open(e,t,n={}){let s=new o(e,t);s._requestedVersion=n.version||null;let r=n.version?`${t}@v${n.version}`:t;if(!n.skipCache){let a=await it.get(r);a&&a.schema&&a.fragments&&(s._schema=a.schema,s._fragments=a.fragments,s._numColumns=a.schema.length,s._totalRows=a.fragments.reduce((c,u)=>c+u.numRows,0),s._version=a.version,s._columnTypes=a.columnTypes||null,s._fromCache=!0)}return s._fromCache||(await s._tryLoadSidecar()||await s._loadManifest(),it.set(r,{schema:s._schema,fragments:s._fragments,version:s._version,columnTypes:s._columnTypes||null}).catch(()=>{})),await s._tryLoadIndex(),(n.prefetch??!1)&&s._fragments.length>0&&s._prefetchFragments(),s}async _tryLoadSidecar(){try{let e=`${this.baseUrl}/.meta.json`,t=await fetch(e);if(!t.ok)return!1;let n=await t.json();return!n.schema||!n.fragments?!1:(this._schema=n.schema.map(s=>({name:s.name,id:s.index,type:s.type})),this._fragments=n.fragments.map(s=>({id:s.id,path:s.data_files?.[0]||`${s.id}.lance`,numRows:s.num_rows,physicalRows:s.physical_rows||s.num_rows,url:`${this.baseUrl}/data/${s.data_files?.[0]||s.id+".lance"}`,deletionFile:s.has_deletions?{numDeletedRows:s.deleted_rows||0}:null})),this._numColumns=n.num_columns,this._totalRows=n.total_rows,this._version=n.lance_version,this._columnTypes=n.schema.map(s=>{let r=s.type;return r.startsWith("vector[")?"vector":r==="float64"||r==="double"?"float64":r==="float32"?"float32":r.includes("int")?r:r==="string"?"string":"unknown"}),!0)}catch{return!1}}_prefetchFragments(){let e=this._fragments.map((t,n)=>this.openFragment(n).catch(()=>null));Promise.all(e).catch(()=>{})}hasIndex(){return this._ivfIndex!==null&&this._ivfIndex.centroids!==null}async _tryLoadIndex(){try{this._ivfIndex=await z.tryLoad(this.baseUrl)}catch{this._ivfIndex=null}}async _loadManifest(){let e=null,t=0;if(this._requestedVersion){t=this._requestedVersion;let n=`${this.baseUrl}/_versions/${t}.manifest`,s=await fetch(n);if(!s.ok)throw new Error(`Version ${t} not found (${s.status})`);e=new Uint8Array(await s.arrayBuffer())}else{let n=[1,5,10,20,50,100],s=await Promise.all(n.map(async c=>{try{let u=`${this.baseUrl}/_versions/${c}.manifest`;return(await fetch(u,{method:"HEAD"})).ok?c:0}catch{return 0}})),r=Math.max(...s);if(r>0)for(let c=r+1;c<=r+50;c++)try{let u=`${this.baseUrl}/_versions/${c}.manifest`;if((await fetch(u,{method:"HEAD"})).ok)r=c;else break}catch{break}if(t=r,t===0)throw new Error("No manifest found in dataset");let i=`${this.baseUrl}/_versions/${t}.manifest`,a=await fetch(i);if(!a.ok)throw new Error(`Failed to fetch manifest: ${a.status}`);e=new Uint8Array(await a.arrayBuffer())}this._version=t,this._latestVersion=this._requestedVersion?null:t,this._parseManifest(e)}async listVersions(){let e=[],t=this._latestVersion||100;return(await Promise.all(Array.from({length:t},(s,r)=>r+1).map(async s=>{try{let r=`${this.baseUrl}/_versions/${s}.manifest`;return(await fetch(r,{method:"HEAD"})).ok?s:0}catch{return 0}}))).filter(s=>s>0)}get version(){return this._version}_parseManifest(e){let t=new DataView(e.buffer,e.byteOffset),n=t.getUint32(0,!0),s=4+n,r;if(s+4<e.length){let f=t.getUint32(s,!0);f>0&&s+4+f<=e.length?r=e.slice(s+4,s+4+f):r=e.slice(4,4+n)}else r=e.slice(4,4+n);let i=0,a=[],c=[],u=()=>{let f=0,h=0;for(;i<r.length;){let d=r[i++];if(f|=(d&127)<<h,(d&128)===0)break;h+=7}return f},l=f=>{if(f===0)u();else if(f===2){let h=u();i+=h}else f===5?i+=4:f===1&&(i+=8)};for(;i<r.length;){let f=u(),h=f>>3,d=f&7;if(h===1&&d===2){let m=u(),g=i+m,b=null,p=null,w=null;for(;i<g;){let y=u(),_=y>>3,I=y&7;if(I===0){let A=u();_===3&&(p=A)}else if(I===2){let A=u(),x=r.slice(i,i+A);i+=A,_===2?b=new TextDecoder().decode(x):_===5&&(w=new TextDecoder().decode(x))}else l(I)}b&&a.push({name:b,id:p,type:w})}else if(h===2&&d===2){let m=u(),g=i+m,b=null,p=null,w=0,y=null;for(;i<g;){let _=u(),I=_>>3,A=_&7;if(A===0){let x=u();I===1?b=x:I===4&&(w=x)}else if(A===2){let x=u(),F=r.slice(i,i+x);if(i+=x,I===2){let C=0;for(;C<F.length;){let B=F[C++],v=B>>3,E=B&7;if(E===2){let R=0,U=0;for(;C<F.length;){let P=F[C++];if(R|=(P&127)<<U,(P&128)===0)break;U+=7}let L=F.slice(C,C+R);C+=R,v===1&&(p=new TextDecoder().decode(L))}else if(E===0)for(;C<F.length&&(F[C++]&128)!==0;);else E===5?C+=4:E===1&&(C+=8)}}else I===3&&(y=this._parseDeletionFile(F,b))}else l(A)}if(p){let _=y?w-y.numDeletedRows:w;c.push({id:b,path:p,numRows:_,physicalRows:w,deletionFile:y,url:`${this.baseUrl}/data/${p}`})}}else l(d)}this._schema=a,this._fragments=c,this._numColumns=a.length,this._totalRows=c.reduce((f,h)=>f+h.numRows,0)}_parseDeletionFile(e,t){return ce(e,t,this.baseUrl)}async _loadDeletedRows(e){return le(this,e)}async isRowDeleted(e,t){return(await this._loadDeletedRows(e)).has(t)}get numColumns(){return this._numColumns}get rowCount(){return this._totalRows}async getRowCount(e=0){return this._totalRows}async readVectorAt(e,t){let n=this._getFragmentForRow(t);return n?await(await this.openFragment(n.fragmentIndex)).readVectorAt(e,n.localIndex):new Float32Array(0)}async getVectorInfo(e){if(this._fragments.length===0)return{rows:0,dimension:0};let n=await(await this.openFragment(0)).getVectorInfo(e);return n.dimension===0?{rows:0,dimension:0}:{rows:this._totalRows,dimension:n.dimension}}get columnNames(){return this._schema?this._schema.map(e=>e.name):[]}get schema(){return this._schema}get fragments(){return this._fragments}get size(){if(this._cachedSize)return this._cachedSize;let e=0;for(let t=0;t<(this._columnTypes?.length||0);t++){let n=this._columnTypes[t];if(n==="int64"||n==="float64"||n==="double")e+=8;else if(n==="int32"||n==="float32")e+=4;else if(n==="string")e+=50;else if(n==="vector"||n?.startsWith("vector[")){let s=n?.match(/\[(\d+)\]/),r=s?parseInt(s[1]):384;e+=r*4}else e+=8}return e===0&&(e=100),this._cachedSize=this._totalRows*e,this._cachedSize}onFetch(e){this._onFetch=e}async openFragment(e){if(e<0||e>=this._fragments.length)throw new Error(`Invalid fragment index: ${e}`);if(this._fragmentFiles.has(e))return this._fragmentFiles.get(e);let t=this._fragments[e],n=await G.open(this.lanceql,t.url);return this._onFetch&&n.onFetch(this._onFetch),this._fragmentFiles.set(e,n),n}async readRows(e={}){return Rt(this,e)}async detectColumnTypes(){if(this._columnTypes&&this._columnTypes.length>0)return this._columnTypes;if(this._fragments.length===0)return[];let t=await(await this.openFragment(0)).detectColumnTypes();this._columnTypes=t;let n=this._requestedVersion?`${this.baseUrl}@v${this._requestedVersion}`:this.baseUrl;return it.get(n).then(s=>{s&&(s.columnTypes=t,it.set(n,s).catch(()=>{}))}).catch(()=>{}),t}_getFragmentForRow(e){return Pt(this,e)}_groupIndicesByFragment(e){return D(this,e)}async readStringsAtIndices(e,t){return he(this,e,t)}async readInt64AtIndices(e,t){return de(this,e,t)}async readFloat64AtIndices(e,t){return me(this,e,t)}async readInt32AtIndices(e,t){return we(this,e,t)}async readFloat32AtIndices(e,t){return ge(this,e,t)}async vectorSearch(e,t,n=10,s=null,r={}){return fe(this,e,t,n,s,r)}_findVectorColumn(){return ue(this)}async executeSQL(e){return pe(this,e)}close(){for(let e of this._fragmentFiles.values())e.close&&e.close();this._fragmentFiles.clear()}};var nn=new TextEncoder,Qn=new TextDecoder,S,tt,O=0,W=0,ye=()=>!O||!W?null:new Uint8Array(tt.buffer,O,W),be=o=>O&&o<=W?!0:(O&&S.free&&S.free(O,W),W=Math.max(o+1024,4096),O=S.alloc(W),O!==0),sn=o=>{if(o instanceof Uint8Array)return be(o.length)?(ye().set(o),[O,o.length]):[o];if(typeof o!="string")return[o];let e=nn.encode(o);return be(e.length)?(ye().set(e),[O,e.length]):[o]};var rn=o=>({getVersion(){let e=S.getVersion(),t=e>>16&255,n=e>>8&255,s=e&255;return`${t}.${n}.${s}`},open(e){return new Y(o,e)},async openUrl(e){return await M().init(),await G.open(o,e)},async openDataset(e,t={}){return await M().init(),await j.open(o,e,t)},parseFooter(e){let t=new Uint8Array(e),n=S.alloc(t.length);if(!n)return null;try{new Uint8Array(tt.buffer).set(t,n);let s=S.parseFooterGetColumns(n,t.length),r=S.parseFooterGetMajorVersion(n,t.length),i=S.parseFooterGetMinorVersion(n,t.length);return s===0&&r===0?null:{numColumns:s,majorVersion:r,minorVersion:i}}finally{S.free(n,t.length)}},isValidLanceFile(e){let t=new Uint8Array(e),n=S.alloc(t.length);if(!n)return!1;try{return new Uint8Array(tt.buffer).set(t,n),S.isValidLanceFile(n,t.length)===1}finally{S.free(n,t.length)}}}),at=class{static async load(e="./lanceql.wasm"){let n=await(await fetch(e)).arrayBuffer();S=(await WebAssembly.instantiate(n,{env:{opfs_open:(a,c)=>0,opfs_read:(a,c,u,l)=>0,opfs_size:a=>0n,opfs_close:a=>{},js_log:(a,c)=>{}}})).instance.exports,tt=S.memory;let r=null,i=new Proxy({},{get(a,c){return r||(r=rn(i)),c in r?r[c]:c==="memory"?tt:c==="raw"||c==="wasm"?S:typeof S[c]=="function"?(...u)=>S[c](...u.flatMap(sn)):S[c]}});return i}};var ct=class{constructor(e){this.name=e,this._ready=!1}async open(){return this._ready?this:(await T("db:open",{name:this.name}),this._ready=!0,this)}async _ensureOpen(){this._ready||await this.open()}async createTable(e,t,n=!1){return await this._ensureOpen(),T("db:createTable",{db:this.name,tableName:e,columns:t,ifNotExists:n})}async dropTable(e,t=!1){return await this._ensureOpen(),T("db:dropTable",{db:this.name,tableName:e,ifExists:t})}async insert(e,t){return await this._ensureOpen(),T("db:insert",{db:this.name,tableName:e,rows:t})}async flush(){return await this._ensureOpen(),T("db:flush",{db:this.name})}async delete(e,t=null){return await this._ensureOpen(),T("db:delete",{db:this.name,tableName:e,where:t})}async update(e,t,n=null){return await this._ensureOpen(),T("db:update",{db:this.name,tableName:e,updates:t,where:n})}async select(e,t={}){await this._ensureOpen();let n={...t};return delete n.where,T("db:select",{db:this.name,tableName:e,options:n,where:t.whereAST||null})}async exec(e){return await this._ensureOpen(),T("db:exec",{db:this.name,sql:e})}async getTable(e){return await this._ensureOpen(),T("db:getTable",{db:this.name,tableName:e})}async listTables(){return await this._ensureOpen(),T("db:listTables",{db:this.name})}async compact(){return await this._ensureOpen(),T("db:compact",{db:this.name})}async*scan(e,t={}){await this._ensureOpen();let n=await T("db:scanStart",{db:this.name,tableName:e,options:t});for(;;){let{batch:s,done:r}=await T("db:scanNext",{db:this.name,streamId:n});if(s.length>0&&(yield s),r)break}}async close(){await this._ensureOpen(),await this.flush()}async listVersions(e){return await this._ensureOpen(),T("db:listVersions",{db:this.name,tableName:e})}async selectAtVersion(e,t,n={}){await this._ensureOpen();let s={...n};return delete s.where,T("db:selectAtVersion",{db:this.name,tableName:e,version:t,options:s,where:n.whereAST||null})}async restoreToVersion(e,t){return await this._ensureOpen(),T("db:restoreTable",{db:this.name,tableName:e,version:t})}};
//# sourceMappingURL=lanceql.js.map
