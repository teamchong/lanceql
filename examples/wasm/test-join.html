<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LanceQL JOIN Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #0f172a;
            color: #e2e8f0;
        }

        h1 {
            color: #3b82f6;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #94a3b8;
            margin-bottom: 30px;
        }

        .test-section {
            background: #1e293b;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .test-section h2 {
            margin-top: 0;
            color: #60a5fa;
            font-size: 1.2rem;
        }

        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            font-weight: 500;
        }

        button:hover {
            background: #2563eb;
        }

        button:disabled {
            background: #475569;
            cursor: not-allowed;
        }

        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .status.loading {
            background: #1e3a5f;
            border-left: 4px solid #3b82f6;
        }

        .status.success {
            background: #14532d;
            border-left: 4px solid #22c55e;
        }

        .status.error {
            background: #7f1d1d;
            border-left: 4px solid #ef4444;
        }

        pre {
            background: #0f172a;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid #334155;
        }

        th {
            background: #0f172a;
            color: #60a5fa;
            font-weight: 600;
        }

        tr:hover {
            background: #1e293b;
        }

        .code {
            background: #0f172a;
            padding: 4px 8px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #fbbf24;
            display: block;
            margin: 10px 0;
            white-space: pre-wrap;
        }

        .schema {
            background: #1e293b;
            padding: 10px;
            border-left: 3px solid #60a5fa;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .run-all {
            background: #059669;
            font-size: 16px;
            padding: 12px 24px;
        }

        .run-all:hover {
            background: #047857;
        }
    </style>
</head>

<body>
    <h1>üîó LanceQL JOIN Demo</h1>
    <p class="subtitle">Row-based JOIN operations using vault with in-memory tables</p>

    <button class="run-all" onclick="runAllTests()">‚ñ∂ Run All Tests</button>

    <div class="test-section">
        <h2>1. Initialize Vault</h2>
        <button id="btn-init" onclick="testInit()">Initialize Vault</button>
        <div id="status-init"></div>
    </div>

    <div class="test-section">
        <h2>2. Create Tables</h2>
        <div class="schema">
            CREATE TABLE customers (id INT, name TEXT, city TEXT)
            CREATE TABLE orders (id INT, customer_id INT, product TEXT, amount FLOAT)
        </div>
        <button id="btn-create" onclick="testCreate()" disabled>Create Tables</button>
        <div id="status-create"></div>
    </div>

    <div class="test-section">
        <h2>3. Insert Sample Data</h2>
        <button id="btn-insert" onclick="testInsert()" disabled>Insert Data</button>
        <div id="status-insert"></div>
        <div id="result-insert"></div>
    </div>

    <div class="test-section">
        <h2>4. INNER JOIN</h2>
        <code class="code">SELECT c.name, c.city, o.product, o.amount
FROM customers c
JOIN orders o ON c.id = o.customer_id</code>
        <button id="btn-inner-join" onclick="testInnerJoin()" disabled>Execute INNER JOIN</button>
        <div id="status-inner-join"></div>
        <div id="result-inner-join"></div>
    </div>

    <div class="test-section">
        <h2>5. LEFT JOIN</h2>
        <code class="code">SELECT c.name, c.city, o.product, o.amount
FROM customers c
LEFT JOIN orders o ON c.id = o.customer_id</code>
        <button id="btn-left-join" onclick="testLeftJoin()" disabled>Execute LEFT JOIN</button>
        <div id="status-left-join"></div>
        <div id="result-left-join"></div>
    </div>

    <div class="test-section">
        <h2>6. JOIN with WHERE and ORDER BY</h2>
        <code class="code">SELECT c.name, o.product, o.amount
FROM customers c
JOIN orders o ON c.id = o.customer_id
WHERE o.amount > 100
ORDER BY o.amount DESC</code>
        <button id="btn-complex-join" onclick="testComplexJoin()" disabled>Execute Complex JOIN</button>
        <div id="status-complex-join"></div>
        <div id="result-complex-join"></div>
    </div>

    <div class="test-section">
        <h2>7. JOIN with Aggregation</h2>
        <code class="code">SELECT c.name, c.city, COUNT(*) as order_count, SUM(o.amount) as total_spent
FROM customers c
JOIN orders o ON c.id = o.customer_id
GROUP BY c.name, c.city
ORDER BY total_spent DESC</code>
        <button id="btn-agg-join" onclick="testAggregationJoin()" disabled>Execute Aggregation JOIN</button>
        <div id="status-agg-join"></div>
        <div id="result-agg-join"></div>
    </div>

    <script type="module">
        import { vault, LanceDatabase, SQLLexer, SQLParser, SQLExecutor } from './lanceql.js';

        // Expose on window for test access
        window.LanceDatabase = LanceDatabase;
        window.SQLLexer = SQLLexer;
        window.SQLParser = SQLParser;
        window.SQLExecutor = SQLExecutor;

        let v = null;

        function setStatus(id, type, message) {
            const el = document.getElementById(`status-${id}`);
            el.className = `status ${type}`;
            el.innerHTML = message;
        }

        function enableButton(id) {
            document.getElementById(`btn-${id}`).disabled = false;
        }

        function renderTable(result) {
            if (!result || !result.rows || result.rows.length === 0) {
                return '<p style="color: #94a3b8;">No rows returned</p>';
            }

            let html = '<table><thead><tr>';
            for (const col of result.columns) {
                html += `<th>${col}</th>`;
            }
            html += '</tr></thead><tbody>';

            for (const row of result.rows) {
                html += '<tr>';
                for (const val of row) {
                    html += `<td>${val !== null && val !== undefined ? val : '<span style="color: #64748b;">NULL</span>'}</td>`;
                }
                html += '</tr>';
            }
            html += '</tbody></table>';

            return html;
        }

        window.testInit = async function () {
            const btn = document.getElementById('btn-init');
            const status = document.getElementById('status-init');

            btn.disabled = true;
            status.innerHTML = '<div class="status loading">‚è≥ Initializing vault...</div>';

            try {
                v = await vault();
                status.innerHTML = '<div class="status success">‚úì Vault initialized successfully!</div>';
                enableButton('create');
            } catch (error) {
                status.innerHTML = `<div class="status error">‚úó Error: ${error.message}</div>`;
                btn.disabled = false;
            }
        };

        window.testCreate = async function () {
            const btn = document.getElementById('btn-create');
            const status = document.getElementById('status-create');

            btn.disabled = true;
            status.innerHTML = '<div class="status loading">‚è≥ Creating tables...</div>';

            try {
                await v.exec("CREATE TABLE customers (id INT, name TEXT, city TEXT)");
                await v.exec("CREATE TABLE orders (id INT, customer_id INT, product TEXT, amount FLOAT)");

                status.innerHTML = '<div class="status success">‚úì Tables created: customers, orders</div>';
                enableButton('insert');
            } catch (error) {
                status.innerHTML = `<div class="status error">‚úó Error: ${error.message}</div>`;
                btn.disabled = false;
            }
        };

        window.testInsert = async function () {
            const btn = document.getElementById('btn-insert');
            const status = document.getElementById('status-insert');
            const result = document.getElementById('result-insert');

            btn.disabled = true;
            status.innerHTML = '<div class="status loading">‚è≥ Inserting sample data...</div>';

            try {
                await v.exec("INSERT INTO customers VALUES (1, 'Alice', 'New York'), (2, 'Bob', 'Los Angeles'), (3, 'Charlie', 'Chicago'), (4, 'Diana', 'San Francisco'), (5, 'Eve', 'Seattle')");
                await v.exec("INSERT INTO orders VALUES (1, 1, 'Laptop', 1200.00), (2, 1, 'Mouse', 25.00), (3, 2, 'Monitor', 350.00), (4, 3, 'Keyboard', 80.00), (5, 1, 'USB Cable', 15.00), (6, 4, 'Headphones', 150.00)");

                const customers = await v.exec("SELECT * FROM customers");
                const orders = await v.exec("SELECT * FROM orders");

                status.innerHTML = `<div class="status success">‚úì Inserted ${customers.rows.length} customers and ${orders.rows.length} orders</div>`;

                result.innerHTML = `
                    <h3 style="color: #60a5fa; margin-top: 15px;">Customers</h3>
                    ${renderTable(customers)}
                    <h3 style="color: #60a5fa; margin-top: 15px;">Orders</h3>
                    ${renderTable(orders)}
                `;

                enableButton('inner-join');
                enableButton('left-join');
                enableButton('complex-join');
                enableButton('agg-join');
            } catch (error) {
                status.innerHTML = `<div class="status error">‚úó Error: ${error.message}</div>`;
                btn.disabled = false;
            }
        };

        window.testInnerJoin = async function () {
            const btn = document.getElementById('btn-inner-join');
            const status = document.getElementById('status-inner-join');
            const result = document.getElementById('result-inner-join');

            btn.disabled = true;
            status.innerHTML = '<div class="status loading">‚è≥ Executing INNER JOIN...</div>';

            try {
                const sql = "SELECT c.name, c.city, o.product, o.amount FROM customers c JOIN orders o ON c.id = o.customer_id";
                const startTime = performance.now();
                const res = await v.exec(sql);
                const endTime = performance.now();

                status.innerHTML = `<div class="status success">‚úì INNER JOIN executed in ${(endTime - startTime).toFixed(2)}ms</div>`;
                status.innerHTML += `<div class="status success">‚úì Returned ${res.rows.length} rows (only customers with orders)</div>`;

                result.innerHTML = renderTable(res);
            } catch (error) {
                status.innerHTML = `<div class="status error">‚úó Error: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
            }
        };

        window.testLeftJoin = async function () {
            const btn = document.getElementById('btn-left-join');
            const status = document.getElementById('status-left-join');
            const result = document.getElementById('result-left-join');

            btn.disabled = true;
            status.innerHTML = '<div class="status loading">‚è≥ Executing LEFT JOIN...</div>';

            try {
                const sql = "SELECT c.name, c.city, o.product, o.amount FROM customers c LEFT JOIN orders o ON c.id = o.customer_id";
                const startTime = performance.now();
                const res = await v.exec(sql);
                const endTime = performance.now();

                status.innerHTML = `<div class="status success">‚úì LEFT JOIN executed in ${(endTime - startTime).toFixed(2)}ms</div>`;
                status.innerHTML += `<div class="status success">‚úì Returned ${res.rows.length} rows (all customers, with NULL for no orders)</div>`;

                result.innerHTML = renderTable(res);
            } catch (error) {
                status.innerHTML = `<div class="status error">‚úó Error: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
            }
        };

        window.testComplexJoin = async function () {
            const btn = document.getElementById('btn-complex-join');
            const status = document.getElementById('status-complex-join');
            const result = document.getElementById('result-complex-join');

            btn.disabled = true;
            status.innerHTML = '<div class="status loading">‚è≥ Executing complex JOIN with WHERE and ORDER BY...</div>';

            try {
                const sql = "SELECT c.name, o.product, o.amount FROM customers c JOIN orders o ON c.id = o.customer_id WHERE o.amount > 100 ORDER BY o.amount DESC";
                const startTime = performance.now();
                const res = await v.exec(sql);
                const endTime = performance.now();

                status.innerHTML = `<div class="status success">‚úì Complex JOIN executed in ${(endTime - startTime).toFixed(2)}ms</div>`;
                status.innerHTML += `<div class="status success">‚úì Returned ${res.rows.length} rows (filtered and sorted)</div>`;

                result.innerHTML = renderTable(res);
            } catch (error) {
                status.innerHTML = `<div class="status error">‚úó Error: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
            }
        };

        window.testAggregationJoin = async function () {
            const btn = document.getElementById('btn-agg-join');
            const status = document.getElementById('status-agg-join');
            const result = document.getElementById('result-agg-join');

            btn.disabled = true;
            status.innerHTML = '<div class="status loading">‚è≥ Executing JOIN with aggregation...</div>';

            try {
                const sql = "SELECT c.name, c.city, COUNT(*) as order_count, SUM(o.amount) as total_spent FROM customers c JOIN orders o ON c.id = o.customer_id GROUP BY c.name, c.city ORDER BY total_spent DESC";
                const startTime = performance.now();
                const res = await v.exec(sql);
                const endTime = performance.now();

                status.innerHTML = `<div class="status success">‚úì Aggregation JOIN executed in ${(endTime - startTime).toFixed(2)}ms</div>`;
                status.innerHTML += `<div class="status success">‚úì Returned ${res.rows.length} customers with order statistics</div>`;

                result.innerHTML = renderTable(res);
            } catch (error) {
                status.innerHTML = `<div class="status error">‚úó Error: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
            }
        };

        window.runAllTests = async function () {
            await testInit();
            if (v) {
                await testCreate();
                await testInsert();
                await testInnerJoin();
                await testLeftJoin();
                await testComplexJoin();
                await testAggregationJoin();
            }
        };

        window.addEventListener('load', () => {
            console.log('JOIN demo loaded. Click "Initialize Vault" or "Run All Tests" to start.');
        });
    </script>
</body>

</html>