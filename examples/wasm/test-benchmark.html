<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LanceQL vs DuckDB Benchmark</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0d1117; color: #c9d1d9; padding: 20px; }
        h1 { color: #58a6ff; margin-bottom: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        button { background: #238636; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; }
        button:hover { background: #2ea043; }
        button:disabled { background: #484f58; cursor: not-allowed; }
        select { background: #21262d; color: #c9d1d9; border: 1px solid #30363d; padding: 10px; border-radius: 6px; font-size: 14px; }
        .results { background: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #30363d; }
        th { color: #8b949e; font-weight: 500; }
        .faster { color: #3fb950; }
        .slower { color: #f85149; }
        .status { margin: 20px 0; padding: 15px; background: #21262d; border-radius: 6px; }
        .loading { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        pre { background: #0d1117; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 13px; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>LanceQL vs DuckDB WASM Benchmark</h1>

        <div class="controls">
            <select id="rowCount">
                <option value="100">100 rows</option>
                <option value="1000" selected>1,000 rows</option>
                <option value="10000">10,000 rows</option>
            </select>
            <select id="benchmarkType">
                <option value="all">All Benchmarks</option>
                <option value="select">Simple SELECT</option>
                <option value="aggregation">Aggregation</option>
                <option value="join">JOIN</option>
                <option value="where">Complex WHERE</option>
            </select>
            <button id="runBtn" onclick="runBenchmarks()">Run Benchmarks</button>
        </div>

        <div class="status" id="status">Ready to run benchmarks. DuckDB WASM will be loaded from CDN.</div>

        <div class="results">
            <h3>Results</h3>
            <table>
                <thead>
                    <tr>
                        <th>Query Type</th>
                        <th>Rows</th>
                        <th>LanceQL (ms)</th>
                        <th>DuckDB (ms)</th>
                        <th>Ratio</th>
                        <th>Winner</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                    <tr><td colspan="6" style="text-align: center; color: #8b949e;">No results yet</td></tr>
                </tbody>
            </table>
        </div>

        <div style="margin-top: 20px;">
            <h3>Benchmark Log</h3>
            <pre id="log"></pre>
        </div>
    </div>

    <script type="module">
        const log = (msg) => {
            const logEl = document.getElementById('log');
            logEl.textContent += msg + '\n';
            logEl.scrollTop = logEl.scrollHeight;
        };

        const setStatus = (msg, loading = false) => {
            const status = document.getElementById('status');
            status.textContent = msg;
            status.className = 'status' + (loading ? ' loading' : '');
        };

        let duckdbConn = null;
        let duckdbDb = null;
        let duckdbWorker = null;
        let lanceVault = null;

        async function initEngines() {
            setStatus('Initializing LanceQL...', true);
            log('Loading LanceQL...');
            const { vault } = await import('./lanceql.js');
            lanceVault = await vault();
            log('LanceQL initialized');

            setStatus('Loading DuckDB WASM from CDN...', true);
            log('Loading DuckDB WASM...');
            const duckdb = await import('https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.29.0/+esm');

            const DUCKDB_BUNDLES = {
                mvp: {
                    mainModule: 'https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.29.0/dist/duckdb-mvp.wasm',
                    mainWorker: 'https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.29.0/dist/duckdb-browser-mvp.worker.js',
                },
                eh: {
                    mainModule: 'https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.29.0/dist/duckdb-eh.wasm',
                    mainWorker: 'https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.29.0/dist/duckdb-browser-eh.worker.js',
                },
            };

            const bundle = await duckdb.selectBundle(DUCKDB_BUNDLES);
            duckdbWorker = new Worker(bundle.mainWorker);
            const logger = new duckdb.ConsoleLogger();
            duckdbDb = new duckdb.AsyncDuckDB(logger, duckdbWorker);
            await duckdbDb.instantiate(bundle.mainModule);
            duckdbConn = await duckdbDb.connect();
            log('DuckDB initialized');

            setStatus('Both engines ready');
        }

        async function runSingleBenchmark(name, lanceQuery, duckQuery, setupFn, runs = 5) {
            log(`\nRunning ${name}...`);

            // Setup
            await setupFn();

            // Warmup
            for (let i = 0; i < 2; i++) {
                await lanceVault.exec(lanceQuery);
                await duckdbConn.query(duckQuery);
            }

            // Benchmark LanceQL
            const lanceTimes = [];
            for (let i = 0; i < runs; i++) {
                const start = performance.now();
                await lanceVault.exec(lanceQuery);
                lanceTimes.push(performance.now() - start);
            }

            // Benchmark DuckDB
            const duckTimes = [];
            for (let i = 0; i < runs; i++) {
                const start = performance.now();
                await duckdbConn.query(duckQuery);
                duckTimes.push(performance.now() - start);
            }

            // Calculate median
            const median = arr => {
                const sorted = [...arr].sort((a, b) => a - b);
                const mid = Math.floor(sorted.length / 2);
                return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
            };

            const lanceMedian = median(lanceTimes);
            const duckMedian = median(duckTimes);
            const ratio = lanceMedian / duckMedian;

            log(`  LanceQL: ${lanceMedian.toFixed(2)}ms`);
            log(`  DuckDB:  ${duckMedian.toFixed(2)}ms`);
            log(`  Ratio:   ${ratio.toFixed(2)}x`);

            return { name, lanceMedian, duckMedian, ratio };
        }

        window.runBenchmarks = async function() {
            const btn = document.getElementById('runBtn');
            btn.disabled = true;
            document.getElementById('log').textContent = '';
            document.getElementById('resultsBody').innerHTML = '<tr><td colspan="6" style="text-align: center;">Running...</td></tr>';

            const rowCount = parseInt(document.getElementById('rowCount').value);
            const benchType = document.getElementById('benchmarkType').value;

            try {
                if (!lanceVault) {
                    await initEngines();
                }

                const results = [];
                const categories = ['A', 'B', 'C', 'D', 'E'];
                const statuses = ['active', 'pending', 'inactive', 'archived'];

                // Simple SELECT
                if (benchType === 'all' || benchType === 'select') {
                    const setupSelect = async () => {
                        await lanceVault.exec('DROP TABLE IF EXISTS bench_select');
                        await lanceVault.exec('CREATE TABLE bench_select (id INTEGER, name TEXT, value REAL)');
                        await duckdbConn.query('DROP TABLE IF EXISTS bench_select');
                        await duckdbConn.query('CREATE TABLE bench_select (id INTEGER, name VARCHAR, value DOUBLE)');

                        for (let i = 0; i < rowCount; i++) {
                            const val = Math.random() * 1000;
                            await lanceVault.exec(`INSERT INTO bench_select VALUES (${i}, 'Name${i}', ${val})`);
                            await duckdbConn.query(`INSERT INTO bench_select VALUES (${i}, 'Name${i}', ${val})`);
                        }
                    };
                    const r = await runSingleBenchmark('Simple SELECT', 'SELECT * FROM bench_select', 'SELECT * FROM bench_select', setupSelect);
                    r.rows = rowCount;
                    results.push(r);
                }

                // Aggregation
                if (benchType === 'all' || benchType === 'aggregation') {
                    const setupAgg = async () => {
                        await lanceVault.exec('DROP TABLE IF EXISTS bench_agg');
                        await lanceVault.exec('CREATE TABLE bench_agg (id INTEGER, category TEXT, amount REAL)');
                        await duckdbConn.query('DROP TABLE IF EXISTS bench_agg');
                        await duckdbConn.query('CREATE TABLE bench_agg (id INTEGER, category VARCHAR, amount DOUBLE)');

                        for (let i = 0; i < rowCount; i++) {
                            const cat = categories[i % categories.length];
                            const amt = Math.random() * 1000;
                            await lanceVault.exec(`INSERT INTO bench_agg VALUES (${i}, '${cat}', ${amt})`);
                            await duckdbConn.query(`INSERT INTO bench_agg VALUES (${i}, '${cat}', ${amt})`);
                        }
                    };
                    const query = 'SELECT category, COUNT(*), SUM(amount), AVG(amount) FROM bench_agg GROUP BY category';
                    const r = await runSingleBenchmark('Aggregation', query, query, setupAgg);
                    r.rows = rowCount;
                    results.push(r);
                }

                // JOIN
                if (benchType === 'all' || benchType === 'join') {
                    const numCustomers = Math.min(Math.floor(rowCount / 10), 100);
                    const setupJoin = async () => {
                        await lanceVault.exec('DROP TABLE IF EXISTS bench_orders');
                        await lanceVault.exec('DROP TABLE IF EXISTS bench_customers');
                        await lanceVault.exec('CREATE TABLE bench_customers (id INTEGER, name TEXT)');
                        await lanceVault.exec('CREATE TABLE bench_orders (id INTEGER, customer_id INTEGER, amount REAL)');

                        await duckdbConn.query('DROP TABLE IF EXISTS bench_orders');
                        await duckdbConn.query('DROP TABLE IF EXISTS bench_customers');
                        await duckdbConn.query('CREATE TABLE bench_customers (id INTEGER, name VARCHAR)');
                        await duckdbConn.query('CREATE TABLE bench_orders (id INTEGER, customer_id INTEGER, amount DOUBLE)');

                        for (let i = 0; i < numCustomers; i++) {
                            await lanceVault.exec(`INSERT INTO bench_customers VALUES (${i}, 'Customer${i}')`);
                            await duckdbConn.query(`INSERT INTO bench_customers VALUES (${i}, 'Customer${i}')`);
                        }

                        for (let i = 0; i < rowCount; i++) {
                            const customerId = Math.floor(Math.random() * numCustomers);
                            const amt = Math.random() * 1000;
                            await lanceVault.exec(`INSERT INTO bench_orders VALUES (${i}, ${customerId}, ${amt})`);
                            await duckdbConn.query(`INSERT INTO bench_orders VALUES (${i}, ${customerId}, ${amt})`);
                        }
                    };
                    const query = 'SELECT c.name, SUM(o.amount) FROM bench_orders o JOIN bench_customers c ON o.customer_id = c.id GROUP BY c.name';
                    const r = await runSingleBenchmark('JOIN', query, query, setupJoin);
                    r.rows = rowCount;
                    results.push(r);
                }

                // Complex WHERE
                if (benchType === 'all' || benchType === 'where') {
                    const setupWhere = async () => {
                        await lanceVault.exec('DROP TABLE IF EXISTS bench_where');
                        await lanceVault.exec('CREATE TABLE bench_where (id INTEGER, status TEXT, amount REAL, priority INTEGER)');

                        await duckdbConn.query('DROP TABLE IF EXISTS bench_where');
                        await duckdbConn.query('CREATE TABLE bench_where (id INTEGER, status VARCHAR, amount DOUBLE, priority INTEGER)');

                        for (let i = 0; i < rowCount; i++) {
                            const status = statuses[i % statuses.length];
                            const priority = (i % 5) + 1;
                            const amt = Math.random() * 1000;
                            await lanceVault.exec(`INSERT INTO bench_where VALUES (${i}, '${status}', ${amt}, ${priority})`);
                            await duckdbConn.query(`INSERT INTO bench_where VALUES (${i}, '${status}', ${amt}, ${priority})`);
                        }
                    };
                    const query = `SELECT * FROM bench_where WHERE (status IN ('active', 'pending') AND amount > 500) OR (priority >= 4 AND amount BETWEEN 100 AND 300)`;
                    const r = await runSingleBenchmark('Complex WHERE', query, query, setupWhere);
                    r.rows = rowCount;
                    results.push(r);
                }

                // Display results
                const tbody = document.getElementById('resultsBody');
                tbody.innerHTML = results.map(r => {
                    const winner = r.ratio < 1 ? 'LanceQL' : 'DuckDB';
                    const winnerClass = r.ratio < 1 ? 'faster' : 'slower';
                    return `<tr>
                        <td>${r.name}</td>
                        <td>${r.rows.toLocaleString()}</td>
                        <td>${r.lanceMedian.toFixed(2)}</td>
                        <td>${r.duckMedian.toFixed(2)}</td>
                        <td>${r.ratio.toFixed(2)}x</td>
                        <td class="${winnerClass}">${winner}</td>
                    </tr>`;
                }).join('');

                setStatus('Benchmarks complete!');
                log('\nDone!');

            } catch (e) {
                log(`Error: ${e.message}`);
                setStatus(`Error: ${e.message}`);
                console.error(e);
            }

            btn.disabled = false;
        };
    </script>
</body>
</html>
