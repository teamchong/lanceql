var Is=Object.defineProperty;var Rs=(s,e,t)=>e in s?Is(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var qt=(s,e,t)=>Rs(s,typeof e!="symbol"?e+"":e,t);var se=null,Qe=null,As=0,Je=new Map,Ne="clone",de=null,Cs=16*1024*1024;function Ts(){try{if(typeof SharedArrayBuffer<"u"&&typeof crossOriginIsolated<"u"&&crossOriginIsolated)return de=new SharedArrayBuffer(Cs),Ne="sharedBuffer",console.log("[LanceQL] Using SharedArrayBuffer (zero-copy)"),!0}catch{}try{let s=new ArrayBuffer(8);return typeof ArrayBuffer.prototype.transfer<"u",Ne="transfer",console.log("[LanceQL] Using Transferable ArrayBuffers"),!1}catch{}return Ne="clone",console.log("[LanceQL] Using structured clone (fallback)"),!1}function Ss(){return se||(Ts(),Qe=new Promise((s,e)=>{console.log("[LanceQL] Using regular Worker for better logging");try{se=new Worker(new URL("./lanceql-worker.js?v="+Date.now(),import.meta.url),{type:"module",name:"lanceql"}),se.onmessage=t=>{Ns(t.data,se,s)},se.onerror=t=>{console.error("[LanceQL] Worker error:",t),e(t)},de&&se.postMessage({type:"initSharedBuffer",buffer:de})}catch(t){console.error("[LanceQL] Failed to create Worker:",t),e(t)}})),Qe}function Ns(s,e,t){if(console.log("[LanceQL] Incoming worker message:",s.type||(s.id!==void 0?"RPC reply":"unknown")),s.type==="ready"){t(e);return}if(s.type==="log"){console.log(s.message);return}if(s.id!==void 0){let n=Je.get(s.id);if(n)if(Je.delete(s.id),s.sharedOffset!==void 0&&de){let r=new Uint8Array(de,s.sharedOffset,s.sharedLength),o=JSON.parse(new TextDecoder().decode(r));n.resolve(o)}else if(s.error)n.reject(new Error(s.error));else{let r=s.result;if(r&&r._format==="cursor"){let{cursorId:o,columns:i,rowCount:a}=r;r={_format:"columnar",columns:i,rowCount:a,_cursorId:o,_fetched:!1},Object.defineProperty(r,"data",{configurable:!0,enumerable:!0,get(){return this._fetched||console.warn("Cursor data accessed - fetching from worker"),{}}}),Object.defineProperty(r,"rows",{configurable:!0,enumerable:!0,get(){return[]}})}else if(r&&r._format==="wasm_binary"){let o=-9223372036854775808n,{buffer:i,columns:a,rowCount:l,schema:c}=r,f=new DataView(i),h=new Uint8Array(i),m=32,p=24,d={};for(let g=0;g<a.length;g++){let E=m+g*p,w=f.getUint32(E,!0),y=f.getUint32(E+8,!0),b=Number(f.getBigUint64(E+12,!0)),I=f.getUint32(E+20,!0),R=a[g];if(w<=3){let C=b/I;w===0?d[R]=new BigInt64Array(i,y,C):w===1?d[R]=new Float64Array(i,y,C):w===2?d[R]=new Int32Array(i,y,C):w===3&&(d[R]=new Float32Array(i,y,C))}else{let C=y,S=new Uint32Array(i,C,l),O=y+l*4,A=b-l*4,N=h.subarray(O,O+A),T=new TextDecoder,_=new Array(l),v=!1;d[R]=new Proxy(_,{get(x,L){if(L==="length")return l;if(typeof L=="string"&&!isNaN(L)){if(!v){for(let U=0;U<l;U++){let D=S[U],q=U<l-1?S[U+1]:A;x[U]=T.decode(N.subarray(D,q))}v=!0}return x[+L]}if(L===Symbol.iterator){if(!v){for(let U=0;U<l;U++){let D=S[U],q=U<l-1?S[U+1]:A;x[U]=T.decode(N.subarray(D,q))}v=!0}return()=>x[Symbol.iterator]()}return x[L]}})}}r={_format:"columnar",columns:a,rowCount:l,data:d},Object.defineProperty(r,"rows",{configurable:!0,enumerable:!0,get(){let g=new Array(l),E=a.map(w=>d[w]);for(let w=0;w<l;w++){let y={};for(let b=0;b<a.length;b++){let I=E[b][w];(I===o||typeof I=="number"&&isNaN(I))&&(I=null),y[a[b]]=I}g[w]=y}return Object.defineProperty(this,"rows",{value:g,writable:!1}),g}})}else if(r&&r._format==="packed"){let{columns:o,rowCount:i,packedBuffer:a,colOffsets:l,stringData:c}=r,f={...c||{}};if(a&&l){let h={Float64Array,Float32Array,Int32Array,Int16Array,Int8Array,Uint32Array,Uint16Array,Uint8Array,BigInt64Array,BigUint64Array};for(let[m,p]of Object.entries(l)){let d=h[p.type]||Float64Array;f[m]=new d(a,p.offset,p.length)}}r.data=f,r._format="columnar",Object.defineProperty(r,"rows",{configurable:!0,enumerable:!0,get(){let h=new Array(i),m=o.map(p=>f[p]);for(let p=0;p<i;p++){let d={};for(let g=0;g<o.length;g++)d[o[g]]=m[g][p];h[p]=d}return Object.defineProperty(this,"rows",{value:h,writable:!1}),h}})}else if(r&&r._format==="columnar"){let{columns:o,rowCount:i,data:a}=r;for(let l of o){let c=a[l];if(c&&c._arrowString){let{offsets:f,bytes:h,isList:m,nullable:p}=c;m&&console.log(`[WorkerRPC] Column ${l} is list mode`);let d=new TextDecoder,g=new Array(i),E=!1;a[l]=new Proxy(g,{get(w,y){if(y==="length")return i;if(typeof y=="string"&&!isNaN(y)){if(!E&&h&&f){for(let b=0;b<i;b++){let I=f[b],R=f[b+1];if(p&&I===R){w[b]=null;continue}let C=d.decode(h.subarray(I,R));try{w[b]=m?JSON.parse(C):C}catch{w[b]=C}}E=!0}return w[+y]}if(y===Symbol.iterator){if(!E&&h&&f){for(let b=0;b<i;b++){let I=f[b],R=f[b+1];if(p&&I===R){w[b]=null;continue}let C=d.decode(h.subarray(I,R));try{w[b]=m?JSON.parse(C):C}catch{w[b]=C}}E=!0}return()=>w[Symbol.iterator]()}return w[y]}})}}Object.defineProperty(r,"rows",{configurable:!0,enumerable:!0,get(){let l=new Array(i),c=o.map(f=>a[f]);for(let f=0;f<i;f++){let h={};for(let m=0;m<o.length;m++)h[o[m]]=c[m][f];l[f]=h}return Object.defineProperty(this,"rows",{value:l,writable:!1}),l}})}n.resolve(r)}}}async function F(s,e){let t=await Ss(),n=++As;return new Promise((r,o)=>{Je.set(n,{resolve:r,reject:o});let i=[];if(Ne==="transfer"&&e)for(let a of Object.keys(e)){let l=e[a];l instanceof ArrayBuffer?i.push(l):ArrayBuffer.isView(l)&&i.push(l.buffer)}i.length>0?t.postMessage({id:n,method:s,args:e},i):t.postMessage({id:n,method:s,args:e})})}var Qt=new Uint8Array([76,65,78,67]);var re=class s{constructor(){this.chunks=[]}static encodeVarint(e){let t=[],n=typeof e=="bigint"?e:BigInt(e);for(;n>0x7fn;)t.push(Number(n&0x7fn)|128),n>>=7n;return t.push(Number(n)),new Uint8Array(t)}static encodeFieldHeader(e,t){let n=e<<3|t;return s.encodeVarint(n)}writeVarint(e,t){this.chunks.push(s.encodeFieldHeader(e,0)),this.chunks.push(s.encodeVarint(t))}writeBytes(e,t){this.chunks.push(s.encodeFieldHeader(e,2)),this.chunks.push(s.encodeVarint(t.length)),this.chunks.push(t)}writePackedUint64(e,t){let n=[];for(let o of t)n.push(s.encodeVarint(o));let r=n.reduce((o,i)=>o+i.length,0);this.chunks.push(s.encodeFieldHeader(e,2)),this.chunks.push(s.encodeVarint(r));for(let o of n)this.chunks.push(o)}toBytes(){let e=this.chunks.reduce((r,o)=>r+o.length,0),t=new Uint8Array(e),n=0;for(let r of this.chunks)t.set(r,n),n+=r.length;return t}clear(){this.chunks=[]}},Z={INT64:"int64",FLOAT64:"float64",STRING:"string",BOOL:"bool",INT32:"int32",FLOAT32:"float32"},_e=class{constructor(e={}){this.majorVersion=e.majorVersion??0,this.minorVersion=e.minorVersion??3,this.columns=[],this.rowCount=null}_validateRowCount(e){if(this.rowCount===null)this.rowCount=e;else if(this.rowCount!==e)throw new Error(`Row count mismatch: expected ${this.rowCount}, got ${e}`)}addInt64Column(e,t){this._validateRowCount(t.length),this.columns.push({name:e,type:Z.INT64,data:new Uint8Array(t.buffer,t.byteOffset,t.byteLength),length:t.length})}addInt32Column(e,t){this._validateRowCount(t.length),this.columns.push({name:e,type:Z.INT32,data:new Uint8Array(t.buffer,t.byteOffset,t.byteLength),length:t.length})}addFloat64Column(e,t){this._validateRowCount(t.length),this.columns.push({name:e,type:Z.FLOAT64,data:new Uint8Array(t.buffer,t.byteOffset,t.byteLength),length:t.length})}addFloat32Column(e,t){this._validateRowCount(t.length),this.columns.push({name:e,type:Z.FLOAT32,data:new Uint8Array(t.buffer,t.byteOffset,t.byteLength),length:t.length})}addBoolColumn(e,t){this._validateRowCount(t.length);let n=new Uint8Array(t.length);for(let r=0;r<t.length;r++)n[r]=t[r]?1:0;this.columns.push({name:e,type:Z.BOOL,data:n,length:t.length})}addStringColumn(e,t){this._validateRowCount(t.length);let n=new TextEncoder,r=new Int32Array(t.length+1),o=[],i=0;for(let h=0;h<t.length;h++){r[h]=i;let m=n.encode(t[h]);o.push(m),i+=m.length}r[t.length]=i;let a=new Uint8Array(r.buffer),l=o.reduce((h,m)=>h+m.length,0),c=new Uint8Array(l),f=0;for(let h of o)c.set(h,f),f+=h.length;this.columns.push({name:e,type:Z.STRING,offsetsData:a,stringData:c,data:null,length:t.length})}_buildColumnMeta(e,t,n,r){let o=new re;o.writePackedUint64(1,[BigInt(e)]),o.writePackedUint64(2,[BigInt(t)]),o.writeVarint(3,n),o.writeVarint(5,0);let i=o.toBytes(),a=new re;return a.writeBytes(2,i),a.toBytes()}_buildStringColumnMeta(e,t,n,r,o){let i=new re;i.writePackedUint64(1,[BigInt(e),BigInt(n)]),i.writePackedUint64(2,[BigInt(t),BigInt(r)]),i.writeVarint(3,o),i.writeVarint(5,0);let a=i.toBytes(),l=new re;return l.writeBytes(2,a),l.toBytes()}finalize(){if(this.columns.length===0)throw new Error("No columns added");let e=[],t=0,n=[];for(let y of this.columns)if(y.type===Z.STRING){let b=t;e.push(y.offsetsData),t+=y.offsetsData.length;let I=t;e.push(y.stringData),t+=y.stringData.length,n.push({type:"string",offsetsOffset:b,offsetsSize:y.offsetsData.length,dataOffset:I,dataSize:y.stringData.length,length:y.length})}else{let b=t;e.push(y.data),t+=y.data.length,n.push({type:y.type,offset:b,size:y.data.length,length:y.length})}let r=[];for(let y=0;y<this.columns.length;y++){let b=n[y],I;b.type==="string"?I=this._buildStringColumnMeta(b.offsetsOffset,b.offsetsSize,b.dataOffset,b.dataSize,b.length):I=this._buildColumnMeta(b.offset,b.size,b.length,b.type),r.push(I)}let o=t,i=[],a=0;for(let y of r)i.push(a),e.push(y),t+=y.length,a+=y.length;let l=t,c=new BigUint64Array(i.length);for(let y=0;y<i.length;y++)c[y]=BigInt(i[y]);let f=new Uint8Array(c.buffer);e.push(f),t+=f.length;let h=t,m=0,p=new ArrayBuffer(40),d=new DataView(p);d.setBigUint64(0,BigInt(o),!0),d.setBigUint64(8,BigInt(l),!0),d.setBigUint64(16,BigInt(h),!0),d.setUint32(24,m,!0),d.setUint32(28,this.columns.length,!0),d.setUint16(32,this.majorVersion,!0),d.setUint16(34,this.minorVersion,!0),new Uint8Array(p,36,4).set(Qt),e.push(new Uint8Array(p));let g=t+40,E=new Uint8Array(g),w=0;for(let y of e)E.set(y,w),w+=y.length;return E}getNumColumns(){return this.columns.length}getRowCount(){return this.rowCount}getColumnNames(){return this.columns.map(e=>e.name)}};var xe=class{constructor(e=null){this._getEncryptionKey=e,this._encryptionKeyId=null,this._ready=!1}async _init(){if(this._ready)return this;let e=null;if(this._getEncryptionKey){let t=await this._getEncryptionKey();this._encryptionKeyId=`vault:${Date.now()}`;let n;if(t instanceof CryptoKey)n=await crypto.subtle.exportKey("raw",t);else if(t instanceof ArrayBuffer||t instanceof Uint8Array)n=t instanceof Uint8Array?t:new Uint8Array(t);else if(typeof t=="string"){let o=new TextEncoder().encode(t),i=await crypto.subtle.digest("SHA-256",o);n=new Uint8Array(i)}else throw new Error("Encryption key must be CryptoKey, ArrayBuffer, Uint8Array, or string");e={keyId:this._encryptionKeyId,keyBytes:Array.from(n instanceof Uint8Array?n:new Uint8Array(n))}}return await F("vault:open",{encryption:e}),this._ready=!0,this}async get(e){return F("vault:get",{key:e})}async set(e,t){await F("vault:set",{key:e,value:t})}async delete(e){return F("vault:delete",{key:e})}async keys(){return F("vault:keys",{})}async has(e){return await this.get(e)!==void 0}async exec(e){return F("vault:exec",{sql:e})}async query(e){let t=await this.exec(e);return!t||!t.columns||!t.rows?[]:t.rows.map(n=>{let r={};return t.columns.forEach((o,i)=>{r[o]=n[i]}),r})}table(e){return new Oe(this,e)}async tables(){return F("vault:tables",{})}async exportToLance(e){let t=await this.exec(`SELECT * FROM ${e} LIMIT 0`);if(!t||!t.columns)throw new Error(`Table '${e}' not found or empty`);let n=await this.exec(`SELECT * FROM ${e}`);if(!n||!n.rows||n.rows.length===0)throw new Error(`Table '${e}' is empty`);let r=new _e,o=n.columns,i=n.rows;for(let a=0;a<o.length;a++){let l=o[a],c=i.map(h=>h[l]!==void 0?h[l]:h[a]),f=c.find(h=>h!=null);if(f===void 0)r.addStringColumn(l,c.map(h=>h===null?"":String(h)));else if(typeof f=="bigint")r.addInt64Column(l,BigInt64Array.from(c.map(h=>h===null?0n:BigInt(h))));else if(typeof f=="number")Number.isInteger(f)&&f<=2147483647&&f>=-2147483648?r.addInt32Column(l,Int32Array.from(c.map(h=>h===null?0:h))):r.addFloat64Column(l,Float64Array.from(c.map(h=>h===null?0:h)));else if(typeof f=="boolean")r.addBoolColumn(l,c.map(h=>h===null?!1:h));else if(Array.isArray(f)){let h=f.length,m=new Float32Array(c.length*h);for(let p=0;p<c.length;p++){let d=c[p]||new Array(h).fill(0);for(let g=0;g<h;g++)m[p*h+g]=d[g]||0}r.addVectorColumn(l,m,h)}else r.addStringColumn(l,c.map(h=>h===null?"":String(h)))}return r.finalize()}async uploadToUrl(e,t,n={}){let{onProgress:r}=n;if(r&&typeof XMLHttpRequest<"u")return new Promise((i,a)=>{let l=new XMLHttpRequest;l.open("PUT",t,!0),l.setRequestHeader("Content-Type","application/octet-stream"),l.upload.onprogress=c=>{c.lengthComputable&&r(c.loaded,c.total)},l.onload=()=>{l.status>=200&&l.status<300?i({ok:!0,status:l.status}):a(new Error(`Upload failed: ${l.status} ${l.statusText}`))},l.onerror=()=>a(new Error("Upload failed: network error")),l.send(e)});let o=await fetch(t,{method:"PUT",body:e,headers:{"Content-Type":"application/octet-stream"}});if(!o.ok)throw new Error(`Upload failed: ${o.status} ${o.statusText}`);return o}async exportToRemote(e,t,n={}){let r=await this.exportToLance(e);return await this.uploadToUrl(r,t,n),{size:r.length,url:t.split("?")[0]}}},Oe=class s{constructor(e,t){this._vault=e,this._tableName=t,this._filters=[],this._similar=null,this._selectCols=null,this._limitValue=null,this._orderBy=null}filter(e,t,n){let r=this._clone();return r._filters.push({column:e,op:t,value:n}),r}similar(e,t,n=20){let r=this._clone();return r._similar={column:e,text:t,limit:n},r}select(...e){let t=this._clone();return t._selectCols=e.flat(),t}limit(e){let t=this._clone();return t._limitValue=e,t}orderBy(e,t="ASC"){let n=this._clone();return n._orderBy={column:e,direction:t},n}async toArray(){let e=this._toSQL();return this._vault.query(e)}async first(){let e=this._clone();return e._limitValue=1,(await e.toArray())[0]||null}async count(){let e=this._toSQL(!0);return(await this._vault.exec(e))?.rows?.[0]?.[0]||0}_toSQL(e=!1){let n=`SELECT ${e?"COUNT(*)":this._selectCols?.join(", ")||"*"} FROM ${this._tableName}`,r=[];for(let i of this._filters){let a=typeof i.value=="string"?`'${i.value}'`:i.value;r.push(`${i.column} ${i.op} ${a}`)}this._similar&&r.push(`${this._similar.column} NEAR '${this._similar.text}'`),r.length>0&&(n+=" WHERE "+r.join(" AND ")),this._orderBy&&!e&&(n+=` ORDER BY ${this._orderBy.column} ${this._orderBy.direction}`);let o=this._similar?.limit||this._limitValue;return o&&!e&&(n+=` LIMIT ${o}`),n}_clone(){let e=new s(this._vault,this._tableName);return e._filters=[...this._filters],e._similar=this._similar,e._selectCols=this._selectCols?[...this._selectCols]:null,e._limitValue=this._limitValue,e._orderBy=this._orderBy,e}};async function Yt(s=null){let e=new xe(s);return await e._init(),e}var Xe=class{constructor(){this.device=null,this.pipeline=null,this.available=!1,this._initPromise=null}async init(){return this._initPromise?this._initPromise:(this._initPromise=this._doInit(),this._initPromise)}async _doInit(){if(!navigator.gpu)return console.log("[WebGPU] Not available in this browser"),!1;try{let e=await navigator.gpu.requestAdapter();return e?(this.device=await e.requestDevice(),this._createPipeline(),this.available=!0,console.log("[WebGPU] Initialized successfully"),!0):(console.log("[WebGPU] No adapter found"),!1)}catch(e){return console.warn("[WebGPU] Init failed:",e),!1}}_createPipeline(){let t=this.device.createShaderModule({code:`
            struct Params {
                dim: u32,
                numVectors: u32,
            }

            @group(0) @binding(0) var<uniform> params: Params;
            @group(0) @binding(1) var<storage, read> query: array<f32>;
            @group(0) @binding(2) var<storage, read> vectors: array<f32>;
            @group(0) @binding(3) var<storage, read_write> scores: array<f32>;

            @compute @workgroup_size(256)
            fn main(@builtin(global_invocation_id) globalId: vec3u) {
                let idx = globalId.x;
                if (idx >= params.numVectors) {
                    return;
                }

                let dim = params.dim;
                let offset = idx * dim;

                // Compute dot product (= cosine similarity for normalized vectors)
                var dot: f32 = 0.0;
                for (var i: u32 = 0u; i < dim; i++) {
                    dot += query[i] * vectors[offset + i];
                }

                scores[idx] = dot;
            }
        `});this.pipeline=this.device.createComputePipeline({layout:"auto",compute:{module:t,entryPoint:"main"}})}async batchCosineSimilarity(e,t,n=!0,r=!1){if(!this.available||t.length===0)return null;let o=e.length,i=r?t.length/o:t.length,a=i*o*4,l=this.device.limits?.maxStorageBufferBindingSize||134217728;if(a>l)return console.warn(`[WebGPU] Buffer size ${(a/1024/1024).toFixed(1)}MB exceeds limit ${(l/1024/1024).toFixed(1)}MB, falling back`),null;let c=this.device.createBuffer({size:8,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),f=this.device.createBuffer({size:o*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),h=this.device.createBuffer({size:i*o*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),m=this.device.createBuffer({size:i*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),p=this.device.createBuffer({size:i*4,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST});if(this.device.queue.writeBuffer(c,0,new Uint32Array([o,i])),this.device.queue.writeBuffer(f,0,e),r)this.device.queue.writeBuffer(h,0,t);else{let y=new Float32Array(i*o);for(let b=0;b<i;b++)y.set(t[b],b*o);this.device.queue.writeBuffer(h,0,y)}let d=this.device.createBindGroup({layout:this.pipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:c}},{binding:1,resource:{buffer:f}},{binding:2,resource:{buffer:h}},{binding:3,resource:{buffer:m}}]}),g=this.device.createCommandEncoder(),E=g.beginComputePass();E.setPipeline(this.pipeline),E.setBindGroup(0,d),E.dispatchWorkgroups(Math.ceil(i/256)),E.end(),g.copyBufferToBuffer(m,0,p,0,i*4),this.device.queue.submit([g.finish()]),await p.mapAsync(GPUMapMode.READ);let w=new Float32Array(p.getMappedRange().slice(0));return p.unmap(),c.destroy(),f.destroy(),h.destroy(),m.destroy(),p.destroy(),w}isAvailable(){return this.available}getMaxVectorsPerBatch(e){if(!this.available)return 0;let t=this.device.limits?.maxStorageBufferBindingSize||134217728;return Math.floor(t*.9/(e*4))}},Ye=null;function Q(){return Ye||(Ye=new Xe),Ye}var et=class{constructor(){this.device=null,this.pipelines=new Map,this.available=!1,this._initPromise=null}async init(){return this._initPromise?this._initPromise:(this._initPromise=this._doInit(),this._initPromise)}async _doInit(){if(typeof navigator>"u"||!navigator.gpu)return!1;try{let e=await navigator.gpu.requestAdapter();return e?(this.device=await e.requestDevice({requiredLimits:{maxStorageBufferBindingSize:256*1024*1024,maxBufferSize:256*1024*1024}}),await this._compileShaders(),this.available=!0,!0):!1}catch{return!1}}async _compileShaders(){let e=this.device.createShaderModule({code:VECTOR_DISTANCE_SHADER});this.pipelines.set("distance",this.device.createComputePipeline({layout:"auto",compute:{module:e,entryPoint:"compute_distances"}}));let t=this.device.createShaderModule({code:TOPK_SHADER});this.pipelines.set("local_topk",this.device.createComputePipeline({layout:"auto",compute:{module:t,entryPoint:"local_topk"}})),this.pipelines.set("merge_topk",this.device.createComputePipeline({layout:"auto",compute:{module:t,entryPoint:"merge_topk"}}))}isAvailable(){return this.available}async computeDistances(e,t,n=1,r=0){let o=t.length,i=e.length/n;if(!this.available||o<GPU_DISTANCE_THRESHOLD)return this._cpuDistances(e,t,n,r);let a=new Float32Array(o*i);for(let w=0;w<o;w++)a.set(t[w],w*i);let l=this._createUniform(new Uint32Array([i,o,n,r])),c=this._createStorage(e),f=this._createStorage(a),h=this.device.createBuffer({size:n*o*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),m=this.device.createBuffer({size:n*o*4,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),p=this.device.createBindGroup({layout:this.pipelines.get("distance").getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:l}},{binding:1,resource:{buffer:c}},{binding:2,resource:{buffer:f}},{binding:3,resource:{buffer:h}}]}),d=this.device.createCommandEncoder(),g=d.beginComputePass();g.setPipeline(this.pipelines.get("distance")),g.setBindGroup(0,p),g.dispatchWorkgroups(Math.ceil(o/256),n,1),g.end(),d.copyBufferToBuffer(h,0,m,0,n*o*4),this.device.queue.submit([d.finish()]),await m.mapAsync(GPUMapMode.READ);let E=new Float32Array(m.getMappedRange().slice(0));return m.unmap(),[l,c,f,h,m].forEach(w=>w.destroy()),E}async topK(e,t=null,n=10,r=!0){let o=e.length;if(!this.available||o<GPU_TOPK_THRESHOLD)return this._cpuTopK(e,t,n,r);if(!t){t=new Uint32Array(o);for(let A=0;A<o;A++)t[A]=A}let i=Math.ceil(o/512),a=Math.min(n,512),l=i*a,c=this._createUniform(new Uint32Array([o,n,r?1:0,i])),f=this._createStorage(e),h=this._createStorage(t),m=this.device.createBuffer({size:l*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),p=this.device.createBuffer({size:l*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),d=this.device.createBindGroup({layout:this.pipelines.get("local_topk").getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:c}},{binding:1,resource:{buffer:f}},{binding:2,resource:{buffer:h}},{binding:3,resource:{buffer:m}},{binding:4,resource:{buffer:p}}]}),g=this.device.createCommandEncoder(),E=g.beginComputePass();E.setPipeline(this.pipelines.get("local_topk")),E.setBindGroup(0,d),E.dispatchWorkgroups(i,1,1),E.end(),this.device.queue.submit([g.finish()]);let w=this._createUniform(new Uint32Array([l,n,r?1:0,0])),y=this.device.createBuffer({size:n*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),b=this.device.createBuffer({size:n*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),I=this.device.createBuffer({size:n*4,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),R=this.device.createBuffer({size:n*4,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),C=this.device.createBindGroup({layout:this.pipelines.get("merge_topk").getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:w}},{binding:1,resource:{buffer:m}},{binding:2,resource:{buffer:p}},{binding:3,resource:{buffer:y}},{binding:4,resource:{buffer:b}}]});g=this.device.createCommandEncoder(),E=g.beginComputePass(),E.setPipeline(this.pipelines.get("merge_topk")),E.setBindGroup(0,C),E.dispatchWorkgroups(1,1,1),E.end(),g.copyBufferToBuffer(y,0,I,0,n*4),g.copyBufferToBuffer(b,0,R,0,n*4),this.device.queue.submit([g.finish()]),await Promise.all([I.mapAsync(GPUMapMode.READ),R.mapAsync(GPUMapMode.READ)]);let S=new Float32Array(I.getMappedRange().slice(0)),O=new Uint32Array(R.getMappedRange().slice(0));return I.unmap(),R.unmap(),[c,f,h,m,p,w,y,b,I,R].forEach(A=>A.destroy()),{indices:O,scores:S}}async search(e,t,n=10,r={}){let{metric:o=0}=r,i=await this.computeDistances(e,t,1,o),a=o===0||o===2;return await this.topK(i,null,n,a)}_cpuDistances(e,t,n,r){let o=e.length/n,i=t.length,a=new Float32Array(n*i);for(let l=0;l<n;l++){let c=l*o;for(let f=0;f<i;f++){let h=t[f],m=0;if(r===1){for(let p=0;p<o;p++){let d=e[c+p]-h[p];m+=d*d}m=Math.sqrt(m)}else for(let p=0;p<o;p++)m+=e[c+p]*h[p];a[l*i+f]=m}}return a}_cpuTopK(e,t,n,r){let o=e.length;if(!t){t=new Uint32Array(o);for(let l=0;l<o;l++)t[l]=l}let i=Array.from(e).map((l,c)=>({score:l,idx:t[c]}));r?i.sort((l,c)=>c.score-l.score):i.sort((l,c)=>l.score-c.score);let a=i.slice(0,n);return{indices:new Uint32Array(a.map(l=>l.idx)),scores:new Float32Array(a.map(l=>l.score))}}_createStorage(e){let t=this.device.createBuffer({size:e.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});return this.device.queue.writeBuffer(t,0,e),t}_createUniform(e){let t=this.device.createBuffer({size:Math.max(e.byteLength,16),usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});return this.device.queue.writeBuffer(t,0,e),t}},Ze=null;function tt(){return Ze||(Ze=new et),Ze}var ge=class{constructor(e,t){this.lanceql=e,this.wasm=e.wasm,this.memory=e.memory;let n=new Uint8Array(t);if(this.dataPtr=this.wasm.alloc(n.length),!this.dataPtr)throw new Error("Failed to allocate memory for Lance file");if(this.dataLen=n.length,new Uint8Array(this.memory.buffer).set(n,this.dataPtr),this.wasm.openFile(this.dataPtr,this.dataLen)===0)throw this.wasm.free(this.dataPtr,this.dataLen),new Error("Failed to open Lance file")}close(){this.wasm.closeFile(),this.dataPtr&&(this.wasm.free(this.dataPtr,this.dataLen),this.dataPtr=null)}get numColumns(){return this.wasm.getNumColumns()}getRowCount(e){return this.wasm.getRowCount(e)}getColumnDebugInfo(e){return{offset:this.wasm.getColumnBufferOffset(e),size:this.wasm.getColumnBufferSize(e),rows:this.wasm.getRowCount(e)}}readInt64Column(e){let t=Number(this.getRowCount(e));if(t===0)return new BigInt64Array(0);let n=this.wasm.allocInt64Buffer(t);if(!n)throw new Error("Failed to allocate int64 buffer");try{let r=this.wasm.readInt64Column(e,n,t),o=new BigInt64Array(r),i=new BigInt64Array(this.memory.buffer,n,r);return o.set(i),o}finally{this.wasm.freeInt64Buffer(n,t)}}readFloat64Column(e){let t=Number(this.getRowCount(e));if(t===0)return new Float64Array(0);let n=this.wasm.allocFloat64Buffer(t);if(!n)throw new Error("Failed to allocate float64 buffer");try{let r=this.wasm.readFloat64Column(e,n,t),o=new Float64Array(r),i=new Float64Array(this.memory.buffer,n,r);return o.set(i),o}finally{this.wasm.freeFloat64Buffer(n,t)}}readInt32Column(e){let t=Number(this.getRowCount(e));if(t===0)return new Int32Array(0);let n=this.wasm.allocInt32Buffer(t);if(!n)throw new Error("Failed to allocate int32 buffer");try{let r=this.wasm.readInt32Column(e,n,t),o=new Int32Array(r),i=new Int32Array(this.memory.buffer,n,r);return o.set(i),o}finally{this.wasm.free(n,t*4)}}readInt16Column(e){let t=Number(this.getRowCount(e));if(t===0)return new Int16Array(0);let n=this.wasm.allocInt16Buffer(t);if(!n)throw new Error("Failed to allocate int16 buffer");try{let r=this.wasm.readInt16Column(e,n,t),o=new Int16Array(r),i=new Int16Array(this.memory.buffer,n,r);return o.set(i),o}finally{this.wasm.free(n,t*2)}}readInt8Column(e){let t=Number(this.getRowCount(e));if(t===0)return new Int8Array(0);let n=this.wasm.allocInt8Buffer(t);if(!n)throw new Error("Failed to allocate int8 buffer");try{let r=this.wasm.readInt8Column(e,n,t),o=new Int8Array(r),i=new Int8Array(this.memory.buffer,n,r);return o.set(i),o}finally{this.wasm.free(n,t)}}readUint64Column(e){let t=Number(this.getRowCount(e));if(t===0)return new BigUint64Array(0);let n=this.wasm.allocUint64Buffer(t);if(!n)throw new Error("Failed to allocate uint64 buffer");try{let r=this.wasm.readUint64Column(e,n,t),o=new BigUint64Array(r),i=new BigUint64Array(this.memory.buffer,n,r);return o.set(i),o}finally{this.wasm.free(n,t*8)}}readUint32Column(e){let t=Number(this.getRowCount(e));if(t===0)return new Uint32Array(0);let n=this.wasm.allocIndexBuffer(t);if(!n)throw new Error("Failed to allocate uint32 buffer");try{let r=this.wasm.readUint32Column(e,n,t),o=new Uint32Array(r),i=new Uint32Array(this.memory.buffer,n,r);return o.set(i),o}finally{this.wasm.free(n,t*4)}}readUint16Column(e){let t=Number(this.getRowCount(e));if(t===0)return new Uint16Array(0);let n=this.wasm.allocUint16Buffer(t);if(!n)throw new Error("Failed to allocate uint16 buffer");try{let r=this.wasm.readUint16Column(e,n,t),o=new Uint16Array(r),i=new Uint16Array(this.memory.buffer,n,r);return o.set(i),o}finally{this.wasm.free(n,t*2)}}readUint8Column(e){let t=Number(this.getRowCount(e));if(t===0)return new Uint8Array(0);let n=this.wasm.allocStringBuffer(t);if(!n)throw new Error("Failed to allocate uint8 buffer");try{let r=this.wasm.readUint8Column(e,n,t),o=new Uint8Array(r),i=new Uint8Array(this.memory.buffer,n,r);return o.set(i),o}finally{this.wasm.free(n,t)}}readFloat32Column(e){let t=Number(this.getRowCount(e));if(t===0)return new Float32Array(0);let n=this.wasm.allocFloat32Buffer(t);if(!n)throw new Error("Failed to allocate float32 buffer");try{let r=this.wasm.readFloat32Column(e,n,t),o=new Float32Array(r),i=new Float32Array(this.memory.buffer,n,r);return o.set(i),o}finally{this.wasm.free(n,t*4)}}readBoolColumn(e){let t=Number(this.getRowCount(e));if(t===0)return new Uint8Array(0);let n=this.wasm.allocStringBuffer(t);if(!n)throw new Error("Failed to allocate bool buffer");try{let r=this.wasm.readBoolColumn(e,n,t),o=new Uint8Array(r),i=new Uint8Array(this.memory.buffer,n,r);return o.set(i),o}finally{this.wasm.free(n,t)}}readInt32AtIndices(e,t){if(t.length===0)return new Int32Array(0);let n=this.wasm.allocIndexBuffer(t.length);if(!n)throw new Error("Failed to allocate index buffer");let r=this.wasm.allocInt32Buffer(t.length);if(!r)throw this.wasm.free(n,t.length*4),new Error("Failed to allocate output buffer");try{new Uint32Array(this.memory.buffer,n,t.length).set(t);let o=this.wasm.readInt32AtIndices(e,n,t.length,r),i=new Int32Array(o),a=new Int32Array(this.memory.buffer,r,o);return i.set(a),i}finally{this.wasm.free(n,t.length*4),this.wasm.free(r,t.length*4)}}readFloat32AtIndices(e,t){if(t.length===0)return new Float32Array(0);let n=this.wasm.allocIndexBuffer(t.length);if(!n)throw new Error("Failed to allocate index buffer");let r=this.wasm.allocFloat32Buffer(t.length);if(!r)throw this.wasm.free(n,t.length*4),new Error("Failed to allocate output buffer");try{new Uint32Array(this.memory.buffer,n,t.length).set(t);let o=this.wasm.readFloat32AtIndices(e,n,t.length,r),i=new Float32Array(o),a=new Float32Array(this.memory.buffer,r,o);return i.set(a),i}finally{this.wasm.free(n,t.length*4),this.wasm.free(r,t.length*4)}}readUint8AtIndices(e,t){if(t.length===0)return new Uint8Array(0);let n=this.wasm.allocIndexBuffer(t.length);if(!n)throw new Error("Failed to allocate index buffer");let r=this.wasm.allocStringBuffer(t.length);if(!r)throw this.wasm.free(n,t.length*4),new Error("Failed to allocate output buffer");try{new Uint32Array(this.memory.buffer,n,t.length).set(t);let o=this.wasm.readUint8AtIndices(e,n,t.length,r),i=new Uint8Array(o),a=new Uint8Array(this.memory.buffer,r,o);return i.set(a),i}finally{this.wasm.free(n,t.length*4),this.wasm.free(r,t.length)}}readBoolAtIndices(e,t){if(t.length===0)return new Uint8Array(0);let n=this.wasm.allocIndexBuffer(t.length);if(!n)throw new Error("Failed to allocate index buffer");let r=this.wasm.allocStringBuffer(t.length);if(!r)throw this.wasm.free(n,t.length*4),new Error("Failed to allocate output buffer");try{new Uint32Array(this.memory.buffer,n,t.length).set(t);let o=this.wasm.readBoolAtIndices(e,n,t.length,r),i=new Uint8Array(o),a=new Uint8Array(this.memory.buffer,r,o);return i.set(a),i}finally{this.wasm.free(n,t.length*4),this.wasm.free(r,t.length)}}filterInt64(e,t,n){let r=Number(this.getRowCount(e));if(r===0)return new Uint32Array(0);let o=this.wasm.allocIndexBuffer(r);if(!o)throw new Error("Failed to allocate index buffer");try{let i=this.wasm.filterInt64Column(e,t,BigInt(n),o,r),a=new Uint32Array(i),l=new Uint32Array(this.memory.buffer,o,i);return a.set(l),a}finally{this.wasm.free(o,r*4)}}filterFloat64(e,t,n){let r=Number(this.getRowCount(e));if(r===0)return new Uint32Array(0);let o=this.wasm.allocIndexBuffer(r);if(!o)throw new Error("Failed to allocate index buffer");try{let i=this.wasm.filterFloat64Column(e,t,n,o,r),a=new Uint32Array(i),l=new Uint32Array(this.memory.buffer,o,i);return a.set(l),a}finally{this.wasm.free(o,r*4)}}readInt64AtIndices(e,t){if(t.length===0)return new BigInt64Array(0);let n=this.wasm.allocIndexBuffer(t.length);if(!n)throw new Error("Failed to allocate index buffer");let r=this.wasm.allocInt64Buffer(t.length);if(!r)throw this.wasm.free(n,t.length*4),new Error("Failed to allocate output buffer");try{new Uint32Array(this.memory.buffer,n,t.length).set(t);let o=this.wasm.readInt64AtIndices(e,n,t.length,r),i=new BigInt64Array(o),a=new BigInt64Array(this.memory.buffer,r,o);return i.set(a),i}finally{this.wasm.free(n,t.length*4),this.wasm.freeInt64Buffer(r,t.length)}}readFloat64AtIndices(e,t){if(t.length===0)return new Float64Array(0);let n=this.wasm.allocIndexBuffer(t.length);if(!n)throw new Error("Failed to allocate index buffer");let r=this.wasm.allocFloat64Buffer(t.length);if(!r)throw this.wasm.free(n,t.length*4),new Error("Failed to allocate output buffer");try{new Uint32Array(this.memory.buffer,n,t.length).set(t);let o=this.wasm.readFloat64AtIndices(e,n,t.length,r),i=new Float64Array(o),a=new Float64Array(this.memory.buffer,r,o);return i.set(a),i}finally{this.wasm.free(n,t.length*4),this.wasm.freeFloat64Buffer(r,t.length)}}sumInt64(e){return this.wasm.sumInt64Column(e)}sumFloat64(e){return this.wasm.sumFloat64Column(e)}minInt64(e){return this.wasm.minInt64Column(e)}maxInt64(e){return this.wasm.maxInt64Column(e)}avgFloat64(e){return this.wasm.avgFloat64Column(e)}debugStringColInfo(e){let t=this.wasm.debugStringColInfo(e);return{offsetsSize:Number(BigInt(t)>>32n),dataSize:Number(BigInt(t)&0xFFFFFFFFn)}}debugReadStringInfo(e,t){let n=this.wasm.debugReadStringInfo(e,t);if((n&0xFFFF0000n)===0xDEAD0000n){let r=Number(n&0xFFFFn);return{error:{1:"No file data",2:"No column entry",3:"Col meta out of bounds",4:"Not a string column",5:"Row out of bounds",6:"Invalid offset size"}[r]||`Unknown error ${r}`}}return{strStart:Number(BigInt(n)>>32n),strLen:Number(BigInt(n)&0xFFFFFFFFn)}}debugStringDataStart(e){let t=this.wasm.debugStringDataStart(e);return{dataStart:Number(BigInt(t)>>32n),fileLen:Number(BigInt(t)&0xFFFFFFFFn)}}getStringCount(e){return Number(this.wasm.getStringCount(e))}readStringAt(e,t){let r=this.wasm.allocStringBuffer(4096);if(!r)throw new Error("Failed to allocate string buffer");try{let o=this.wasm.readStringAt(e,t,r,4096);if(o===0)return"";let i=new Uint8Array(this.memory.buffer,r,Math.min(o,4096));return new TextDecoder().decode(i)}finally{this.wasm.free(r,4096)}}readStringColumn(e,t=1e3){let n=Math.min(this.getStringCount(e),t);if(n===0)return[];let r=[];for(let o=0;o<n;o++)r.push(this.readStringAt(e,o));return r}readStringsAtIndices(e,t){if(t.length===0)return[];let n=Math.min(t.length*256,256*1024),r=this.wasm.allocIndexBuffer(t.length);if(!r)throw new Error("Failed to allocate index buffer");let o=this.wasm.allocStringBuffer(n);if(!o)throw this.wasm.free(r,t.length*4),new Error("Failed to allocate string buffer");let i=this.wasm.allocU32Buffer(t.length);if(!i)throw this.wasm.free(r,t.length*4),this.wasm.free(o,n),new Error("Failed to allocate length buffer");try{new Uint32Array(this.memory.buffer,r,t.length).set(t);let a=this.wasm.readStringsAtIndices(e,r,t.length,o,n,i),l=new Uint32Array(this.memory.buffer,i,t.length),c=[],f=0;for(let h=0;h<t.length;h++){let m=l[h];if(m>0&&f+m<=a){let p=new Uint8Array(this.memory.buffer,o+f,m);c.push(new TextDecoder().decode(p)),f+=m}else c.push("")}return c}finally{this.wasm.free(r,t.length*4),this.wasm.free(o,n),this.wasm.free(i,t.length*4)}}getVectorInfo(e){let t=this.wasm.getVectorInfo(e);return{rows:Number(BigInt(t)>>32n),dimension:Number(BigInt(t)&0xFFFFFFFFn)}}readVectorAt(e,t){let n=this.getVectorInfo(e);if(n.dimension===0)return new Float32Array(0);let r=this.wasm.allocFloat32Buffer(n.dimension);if(!r)throw new Error("Failed to allocate vector buffer");try{let o=this.wasm.readVectorAt(e,t,r,n.dimension),i=new Float32Array(o),a=new Float32Array(this.memory.buffer,r,o);return i.set(a),i}finally{this.wasm.free(r,n.dimension*4)}}cosineSimilarity(e,t){if(e.length!==t.length)throw new Error("Vector dimensions must match");let n=this.wasm.allocFloat32Buffer(e.length),r=this.wasm.allocFloat32Buffer(t.length);if(!n||!r)throw new Error("Failed to allocate buffers");try{return new Float32Array(this.memory.buffer,n,e.length).set(e),new Float32Array(this.memory.buffer,r,t.length).set(t),this.wasm.cosineSimilarity(n,r,e.length)}finally{this.wasm.free(n,e.length*4),this.wasm.free(r,t.length*4)}}batchCosineSimilarity(e,t,n=!0){if(t.length===0)return new Float32Array(0);let r=e.length,o=t.length,i=this.wasm.allocFloat32Buffer(r),a=this.wasm.allocFloat32Buffer(o*r),l=this.wasm.allocFloat32Buffer(o);if(!i||!a||!l)throw new Error("Failed to allocate WASM buffers");try{new Float32Array(this.memory.buffer,i,r).set(e);let c=new Float32Array(this.memory.buffer,a,o*r);for(let h=0;h<o;h++)c.set(t[h],h*r);this.wasm.batchCosineSimilarity(i,a,r,o,l,n?1:0);let f=new Float32Array(o);return f.set(new Float32Array(this.memory.buffer,l,o)),f}finally{this.wasm.free(i,r*4),this.wasm.free(a,o*r*4),this.wasm.free(l,o*4)}}readAllVectors(e){let t=this.getVectorInfo(e);if(t.dimension===0||t.rows===0)return[];let n=t.dimension,r=t.rows,o=[],i=this.wasm.allocFloat32Buffer(r*n);if(!i)throw new Error("Failed to allocate vector buffer");try{if(this.wasm.readVectorColumn){let a=this.wasm.readVectorColumn(e,i,r*n),l=new Float32Array(this.memory.buffer,i,a);for(let c=0;c<r&&c*n<a;c++){let f=new Float32Array(n);f.set(l.subarray(c*n,(c+1)*n)),o.push(f)}}else for(let a=0;a<r;a++)o.push(this.readVectorAt(e,a));return o}finally{this.wasm.free(i,r*n*4)}}async vectorSearch(e,t,n=10,r=null){let o=t.length,a=this.getVectorInfo(e).rows,l=Q();if(l.isAvailable()){r&&r(0,a);let h=this.readAllVectors(e);r&&r(a,a);let m=await l.batchCosineSimilarity(t,h,!0);return await tt().topK(m,null,n,!0)}r&&r(0,a);let c=this.readAllVectors(e);r&&r(a,a);let f=this.lanceql.batchCosineSimilarity(t,c,!0);return await tt().topK(f,null,n,!0)}df(){return new DataFrame(this)}};qt(ge,"Op",{EQ:0,NE:1,LT:2,LE:3,GT:4,GE:5});var st=class{constructor(e=null,t={}){this.storage=e,this.cacheDir=t.cacheDir||"_cache",this.maxFileSize=t.maxFileSize||10*1024*1024,this.maxCacheSize=t.maxCacheSize||500*1024*1024,this.enabled=t.enabled??!0,this._stats={hits:0,misses:0,bytesFromCache:0,bytesFromNetwork:0},this._metaCache=new Map,this._metaCacheOrder=[],this.maxMetaCacheEntries=t.maxMetaCacheEntries||100}_setMetaCache(e,t){let n=this._metaCacheOrder.indexOf(e);for(n!==-1&&this._metaCacheOrder.splice(n,1);this._metaCacheOrder.length>=this.maxMetaCacheEntries;){let r=this._metaCacheOrder.shift();this._metaCache.delete(r)}this._metaCache.set(e,t),this._metaCacheOrder.push(e)}async init(){this.storage||(this.storage=new OPFSStorage,await this.storage.open())}_getCacheKey(e){let t=0;for(let n=0;n<e.length;n++){let r=e.charCodeAt(n);t=(t<<5)-t+r,t=t&t}return Math.abs(t).toString(36)}_getCachePath(e,t=""){let n=this._getCacheKey(e);return`${this.cacheDir}/${n}${t}`}async isCached(e){if(!this.enabled)return{cached:!1};try{await this.init();let t=this._getCachePath(e,"/meta.json"),n=await this.storage.load(t);return n?{cached:!0,meta:JSON.parse(new TextDecoder().decode(n))}:{cached:!1}}catch{return{cached:!1}}}async getFile(e,t=null){if(!this.enabled)return this._fetchFile(e);await this.init();let{cached:n,meta:r}=await this.isCached(e);if(n&&r.fullFile){let i=this._getCachePath(e,"/data.lance"),a=await this.storage.load(i);if(a)return this._stats.hits++,this._stats.bytesFromCache+=a.byteLength,console.log(`[HotTierCache] HIT: ${e} (${(a.byteLength/1024).toFixed(1)} KB)`),a}this._stats.misses++;let o=await this._fetchFile(e);return this._stats.bytesFromNetwork+=o.byteLength,o.byteLength<=this.maxFileSize&&await this._cacheFile(e,o),o}async getRange(e,t,n,r=null){if(!this.enabled)return this._fetchRange(e,t,n);let o=this._metaCache.get(e);if(o?.fullFileData){let a=o.fullFileData;if(a.byteLength>n)return this._stats.hits++,this._stats.bytesFromCache+=n-t+1,a.slice(t,n+1).buffer}if(await this.init(),!o){let{cached:a,meta:l}=await this.isCached(e);if(a&&l.fullFile){let c=this._getCachePath(e,"/data.lance"),f=await this.storage.load(c);if(f&&f.byteLength>n)return this._setMetaCache(e,{meta:l,fullFileData:f}),this._stats.hits++,this._stats.bytesFromCache+=n-t+1,f.slice(t,n+1).buffer}this._setMetaCache(e,{meta:a?l:null,fullFileData:null})}this._stats.misses++;let i=await this._fetchRange(e,t,n);return this._stats.bytesFromNetwork+=i.byteLength,i}async prefetch(e,t=null){await this.init();let{cached:n,meta:r}=await this.isCached(e);if(n&&r.fullFile){console.log(`[HotTierCache] Already cached: ${e}`);return}console.log(`[HotTierCache] Prefetching: ${e}`);let o=await this._fetchFile(e,t);await this._cacheFile(e,o),console.log(`[HotTierCache] Cached: ${e} (${(o.byteLength/1024/1024).toFixed(2)} MB)`)}async evict(e){await this.init();let t=this._getCachePath(e);await this.storage.delete(t),console.log(`[HotTierCache] Evicted: ${e}`)}async clear(){await this.init(),await this.storage.delete(this.cacheDir),this._stats={hits:0,misses:0,bytesFromCache:0,bytesFromNetwork:0},console.log("[HotTierCache] Cleared all cache")}getStats(){let e=this._stats.hits+this._stats.misses>0?(this._stats.hits/(this._stats.hits+this._stats.misses)*100).toFixed(1):0;return{...this._stats,hitRate:`${e}%`,bytesFromCacheMB:(this._stats.bytesFromCache/1024/1024).toFixed(2),bytesFromNetworkMB:(this._stats.bytesFromNetwork/1024/1024).toFixed(2)}}async _fetchFile(e,t=null){let n=await fetch(e);if(!n.ok)throw new Error(`HTTP error: ${n.status}`);if(t&&n.headers.get("content-length")){let o=parseInt(n.headers.get("content-length")),i=n.body.getReader(),a=[],l=0;for(;;){let{done:h,value:m}=await i.read();if(h)break;a.push(m),l+=m.length,t(l,o)}let c=new Uint8Array(l),f=0;for(let h of a)c.set(h,f),f+=h.length;return c}let r=await n.arrayBuffer();return new Uint8Array(r)}async _fetchRange(e,t,n){let r=await fetch(e,{headers:{Range:`bytes=${t}-${n}`}});if(!r.ok&&r.status!==206)throw new Error(`HTTP error: ${r.status}`);return r.arrayBuffer()}async _cacheFile(e,t){let n=this._getCachePath(e,"/meta.json"),r=this._getCachePath(e,"/data.lance"),o={url:e,size:t.byteLength,cachedAt:Date.now(),fullFile:!0,ranges:null};await this.storage.save(n,new TextEncoder().encode(JSON.stringify(o))),await this.storage.save(r,t)}async _cacheRange(e,t,n,r,o){let i=this._getCachePath(e,"/meta.json"),a=this._getCachePath(e,`/ranges/${t}-${n}`),l,{cached:c,meta:f}=await this.isCached(e);c?(l=f,l.ranges=l.ranges||[]):l={url:e,size:o,cachedAt:Date.now(),fullFile:!1,ranges:[]},l.ranges.push({start:t,end:n,cachedAt:Date.now()}),l.ranges=this._mergeRanges(l.ranges),await this.storage.save(i,new TextEncoder().encode(JSON.stringify(l))),await this.storage.save(a,r)}_mergeRanges(e){if(e.length<=1)return e;e.sort((n,r)=>n.start-r.start);let t=[e[0]];for(let n=1;n<e.length;n++){let r=t[t.length-1],o=e[n];o.start<=r.end+1?r.end=Math.max(r.end,o.end):t.push(o)}return t}},nt=null;function Xt(){return nt||(nt=new st),nt}async function Zt(s){let e=[1,5,10,20,50,100],t=await Promise.all(e.map(async r=>{try{return(await fetch(`${s}/_versions/${r}.manifest`,{method:"HEAD"})).ok?r:0}catch{return 0}})),n=Math.max(...t);if(n===0)return null;for(let r=n+1;r<=n+30;r++)try{if((await fetch(`${s}/_versions/${r}.manifest`,{method:"HEAD"})).ok)n=r;else break}catch{break}return n}function en(s){let t=new DataView(s.buffer,s.byteOffset).getUint32(0,!0),n=s.slice(4,4+t),r=0,o=null,i=null,a=(l,c)=>{let f=0,h=0,m=c;for(;m<l.length;){let p=l[m++];if(f|=(p&127)<<h,(p&128)===0)break;h+=7}return{value:f,pos:m}};for(;r<n.length;){let l=a(n,r);r=l.pos;let c=l.value>>3,f=l.value&7;if(f===2){let h=a(n,r);r=h.pos;let m=n.slice(r,r+h.value);if(r+=h.value,c===1){let p=_s(m);p?.uuid&&(o=p.uuid,i=p.fieldId)}}else f===0?r=a(n,r).pos:f===5?r+=4:f===1&&(r+=8)}return o?{uuid:o,fieldId:i}:null}function _s(s){let e=0,t=null,n=null,r=()=>{let o=0,i=0;for(;e<s.length;){let a=s[e++];if(o|=(a&127)<<i,(a&128)===0)break;i+=7}return o};for(;e<s.length;){let o=r(),i=o>>3,a=o&7;if(a===2){let l=r(),c=s.slice(e,e+l);e+=l,i===1&&(t=xs(c))}else if(a===0){let l=r();i===2&&(n=l)}else a===5?e+=4:a===1&&(e+=8)}return{uuid:t,fieldId:n}}function xs(s){let e=0;for(;e<s.length;){let t=s[e++],n=t>>3,r=t&7;if(r===2&&n===1){let o=s[e++],i=s.slice(e,e+o),a=Array.from(i).map(l=>l.toString(16).padStart(2,"0")).join("");return`${a.slice(0,8)}-${a.slice(8,12)}-${a.slice(12,16)}-${a.slice(16,20)}-${a.slice(20,32)}`}else if(r===0)for(;e<s.length&&s[e++]&128;);else r===5?e+=4:r===1&&(e+=8)}return null}function tn(s,e,t){let n=new t,r=nn(s);if(r&&(r.centroids&&(n.centroids=r.centroids.data,n.numPartitions=r.centroids.numPartitions,n.dimension=r.centroids.dimension),r.offsets?.length>0&&(n.partitionOffsets=r.offsets),r.lengths?.length>0&&(n.partitionLengths=r.lengths)),!n.centroids){let o=0,i=()=>{let a=0,l=0;for(;o<s.length;){let c=s[o++];if(a|=(c&127)<<l,(c&128)===0)break;l+=7}return a};for(;o<s.length-4;){let l=i()&7;if(l===2){let c=i();if(c>s.length-o)break;let f=s.slice(o,o+c);if(o+=c,c>100&&c<1e8){let h=sn(f);h&&(n.centroids=h.data,n.numPartitions=h.numPartitions,n.dimension=h.dimension)}}else l===0?i():l===5?o+=4:l===1&&(o+=8)}}return n.centroids?n:null}function nn(s){let e=0,t=[],n=[],r=null,o=()=>{let i=0,a=0;for(;e<s.length;){let l=s[e++];if(i|=(l&127)<<a,(l&128)===0)break;a+=7}return i};for(;e<s.length-4;){let i=e,a=o(),l=a>>3,c=a&7;if(c===2){let f=o();if(f>s.length-e||f<0){e=i+1;continue}let h=s.slice(e,e+f);if(e+=f,l===2&&f%8===0&&f>0){let m=new DataView(h.buffer,h.byteOffset,f);for(let p=0;p<f/8;p++)t.push(Number(m.getBigUint64(p*8,!0)))}else if(l===3)if(f%4===0&&f>0){let m=new DataView(h.buffer,h.byteOffset,f);for(let p=0;p<f/4;p++)n.push(m.getUint32(p*4,!0))}else{let m=0;for(;m<h.length;){let p=0,d=0;for(;m<h.length;){let g=h[m++];if(p|=(g&127)<<d,(g&128)===0)break;d+=7}n.push(p)}}else if(l===4)r=sn(h);else if(f>100){let m=nn(h);(m?.centroids||m?.offsets?.length>0)&&(m.centroids&&!r&&(r=m.centroids),m.offsets?.length>t.length&&(t=m.offsets),m.lengths?.length>n.length&&(n=m.lengths))}}else c===0?o():c===5?e+=4:c===1?e+=8:e=i+1}return r||t.length>0||n.length>0?{centroids:r,offsets:t,lengths:n}:null}function sn(s){let e=0,t=[],n=null,r=2,o=()=>{let i=0,a=0;for(;e<s.length;){let l=s[e++];if(i|=(l&127)<<a,(l&128)===0)break;a+=7}return i};for(;e<s.length;){let i=o(),a=i>>3,l=i&7;if(l===0){let c=o();a===1&&(r=c)}else if(l===2){let c=o(),f=s.slice(e,e+c);if(e+=c,a===2){let h=0;for(;h<f.length;){let m=0,p=0;for(;h<f.length;){let d=f[h++];if(m|=(d&127)<<p,(d&128)===0)break;p+=7}t.push(m)}}else a===3&&(n=f)}else l===5?e+=4:l===1&&(e+=8)}if(t.length>=2&&n&&r===2){let i=t[0],a=t[1];if(n.length===i*a*4)return{data:new Float32Array(n.buffer,n.byteOffset,i*a),numPartitions:i,dimension:a}}return null}async function rt(s){let e;try{e=await fetch(s.auxiliaryUrl,{method:"HEAD"})}catch{return}if(!e.ok)return;let t=parseInt(e.headers.get("content-length"));if(!t)return;let n=await fetch(s.auxiliaryUrl,{headers:{Range:`bytes=${t-40}-${t-1}`}});if(!n.ok)return;let r=new Uint8Array(await n.arrayBuffer()),o=new DataView(r.buffer,r.byteOffset),i=Number(o.getBigUint64(0,!0)),a=Number(o.getBigUint64(8,!0)),l=Number(o.getBigUint64(16,!0)),c=o.getUint32(24,!0);if(new TextDecoder().decode(r.slice(36,40))!=="LANC")return;let h=c*16,m=await fetch(s.auxiliaryUrl,{headers:{Range:`bytes=${l}-${l+h-1}`}});if(!m.ok)return;let p=new Uint8Array(await m.arrayBuffer()),d=new DataView(p.buffer,p.byteOffset),g=[];for(let y=0;y<c;y++){let b=Number(d.getBigUint64(y*16,!0)),I=Number(d.getBigUint64(y*16+8,!0));g.push({offset:b,length:I})}if(g.length<2)return;s._auxBuffers=g,s._auxFileSize=t;let E=await fetch(s.auxiliaryUrl,{headers:{Range:`bytes=${a}-${l-1}`}});if(!E.ok)return;let w=new Uint8Array(await E.arrayBuffer());if(w.length>=32){let y=new DataView(w.buffer,w.byteOffset),b=Number(y.getBigUint64(0,!0)),I=Number(y.getBigUint64(8,!0)),R=await fetch(s.auxiliaryUrl,{headers:{Range:`bytes=${b}-${b+I-1}`}});if(R.ok){let C=new Uint8Array(await R.arrayBuffer());ot(s,C)}}}function ot(s,e){let t=0,n=[],r=()=>{let o=0,i=0;for(;t<e.length;){let a=e[t++];if(o|=(a&127)<<i,(a&128)===0)break;i+=7}return o};for(;t<e.length;){let o=r(),i=o>>3,a=o&7;if(a===2){let l=r();if(l>e.length-t)break;let c=e.slice(t,t+l);if(t+=l,i===2){let f=Ls(c);f&&n.push(f)}}else a===0?r():a===5?t+=4:a===1&&(t+=8)}s._columnPages=n}function Ls(s){let e=0,t=0,n=[],r=[],o=()=>{let i=0,a=0;for(;e<s.length;){let l=s[e++];if(i|=(l&127)<<a,(l&128)===0)break;a+=7}return i};for(;e<s.length;){let i=o(),a=i>>3,l=i&7;if(l===0){let c=o();a===3&&(t=c)}else if(l===2){let c=o(),f=s.slice(e,e+c);if(e+=c,a===1){let h=0;for(;h<f.length;){let m=0n,p=0n;for(;h<f.length;){let d=f[h++];if(m|=BigInt(d&127)<<p,(d&128)===0)break;p+=7n}n.push(Number(m))}}if(a===2){let h=0;for(;h<f.length;){let m=0n,p=0n;for(;h<f.length;){let d=f[h++];if(m|=BigInt(d&127)<<p,(d&128)===0)break;p+=7n}r.push(Number(m))}}}else l===5?e+=4:l===1&&(e+=8)}return{numRows:t,bufferOffsets:n,bufferSizes:r}}function rn(s,e){let t=0,n=()=>{let r=0,o=0;for(;t<e.length;){let i=e[t++];if(r|=(i&127)<<o,(i&128)===0)break;o+=7}return r};for(;t<e.length-4;){let r=n(),o=r>>3,i=r&7;if(i===2){let a=n();if(a>e.length-t)break;let l=e.slice(t,t+a);if(t+=a,o===2&&a>100&&a<2e3){let c=[],f=0;for(;f<l.length;){let h=0,m=0;for(;f<l.length;){let p=l[f++];if(h|=(p&127)<<m,(p&128)===0)break;m+=7}c.push(h)}c.length===s.numPartitions&&(s.partitionOffsets=c)}else if(o===3&&a>100&&a<2e3){let c=[],f=0;for(;f<l.length;){let h=0,m=0;for(;f<l.length;){let p=l[f++];if(h|=(p&127)<<m,(p&128)===0)break;m+=7}c.push(h)}c.length===s.numPartitions&&(s.partitionLengths=c)}}else if(i===0)n();else if(i===1)t+=8;else if(i===5)t+=4;else break}}var Le=class{constructor(e={}){this.maxSize=e.maxSize??50*1024*1024,this.currentSize=0,this.cache=new Map,this._head=null,this._tail=null}get(e){let t=this.cache.get(e);if(t)return this._moveToHead(t),t.data}delete(e){let t=this.cache.get(e);return t?(this._removeNode(t),this.cache.delete(e),this.currentSize-=t.size,!0):!1}set(e,t,n=null){return this.put(e,t,n)}put(e,t,n=null){let r=this.cache.get(e);r&&(this._removeNode(r),this.currentSize-=r.size,this.cache.delete(e));let o=n;for(o===null&&(t==null?o=0:t.byteLength!==void 0?o=t.byteLength:typeof t=="string"?o=t.length*2:typeof t=="object"?o=JSON.stringify(t).length*2:o=8);this.currentSize+o>this.maxSize&&this._tail;)this._evictTail();if(o>this.maxSize)return;let i={key:e,data:t,size:o,prev:null,next:null};this._addToHead(i),this.cache.set(e,i),this.currentSize+=o}_addToHead(e){e.prev=null,e.next=this._head,this._head&&(this._head.prev=e),this._head=e,this._tail||(this._tail=e)}_removeNode(e){e.prev?e.prev.next=e.next:this._head=e.next,e.next?e.next.prev=e.prev:this._tail=e.prev,e.prev=null,e.next=null}_moveToHead(e){e!==this._head&&(this._removeNode(e),this._addToHead(e))}_evictTail(){if(!this._tail)return;let e=this._tail;this._removeNode(e),this.cache.delete(e.key),this.currentSize-=e.size}clear(){this.cache.clear(),this._head=null,this._tail=null,this.currentSize=0}stats(){return{entries:this.cache.size,currentSize:this.currentSize,maxSize:this.maxSize,utilization:(this.currentSize/this.maxSize*100).toFixed(1)+"%"}}};var Fs=50*1024*1024;async function it(s){let e=`${s.datasetBaseUrl}/ivf_vectors.bin`;s.partitionVectorsUrl=e;let t=await fetch(e,{headers:{Range:"bytes=0-2055"}});if(!t.ok)return;let n=await t.arrayBuffer(),r=new BigUint64Array(n);s.partitionOffsets=Array.from(r,o=>Number(o)),s.hasPartitionIndex=!0}async function an(s,e,t=384,n=null){if(!s.hasPartitionIndex||!s.partitionVectorsUrl)return null;let r=0,o=0,i=[],a=new Map;s._partitionCache||(s._partitionCache=new Le({maxSize:Fs}));for(let c of e){let f=s._partitionCache.get(c);f!==void 0?a.set(c,f):(i.push(c),r+=s.partitionOffsets[c+1]-s.partitionOffsets[c])}if(i.length===0)return on(e,a,t,n);s._fetchStats||(s._fetchStats={concurrency:6,recentLatencies:[],minConcurrency:2,maxConcurrency:12});let l=s._fetchStats;for(let c=0;c<i.length;c+=l.concurrency){let f=i.slice(c,c+l.concurrency),h=performance.now(),m=await Promise.all(f.map(async g=>{let E=s.partitionOffsets[g],w=s.partitionOffsets[g+1],y=w-E;try{let b=await fetch(s.partitionVectorsUrl,{headers:{Range:`bytes=${E}-${w-1}`}});if(!b.ok)return{p:g,rowIds:[],vectors:[]};let I=await b.arrayBuffer(),C=new DataView(I).getUint32(0,!0),S=4+C*4,O=new Uint32Array(I.slice(4,S)),A=new Float32Array(I.slice(S));return o+=y,n&&n(o,r),{p:g,rowIds:Array.from(O),vectors:A,numVectors:C}}catch{return{p:g,rowIds:[],vectors:[]}}}));for(let g of m){let E={rowIds:g.rowIds,vectors:g.vectors,numVectors:g.numVectors??g.rowIds.length},w=g.rowIds.length*4+(g.vectors.byteLength||g.vectors.length*4);s._partitionCache.set(g.p,E,w),a.set(g.p,E)}let p=performance.now()-h;l.recentLatencies.push(p),l.recentLatencies.length>10&&l.recentLatencies.shift();let d=l.recentLatencies.reduce((g,E)=>g+E,0)/l.recentLatencies.length;d<50&&l.concurrency<l.maxConcurrency?l.concurrency++:d>200&&l.concurrency>l.minConcurrency&&l.concurrency--}return on(e,a,t,n)}function on(s,e,t,n){let r=0,o=0;for(let f of s){let h=e.get(f);h&&(r+=h.rowIds.length,o+=h.vectors.length)}let i=new Array(r),a=new Float32Array(o),l=0,c=0;for(let f of s){let h=e.get(f);if(h){for(let m=0;m<h.rowIds.length;m++)i[l++]=h.rowIds[m];a.set(h.vectors,c),c+=h.vectors.length}}return n&&n(100,100),{rowIds:i,vectors:a,preFlattened:!0}}async function at(s){if(!s.auxiliaryUrl||!s._auxBufferOffsets||s._rowIdCacheReady)return;let e=s.partitionLengths.reduce((r,o)=>r+o,0);if(e===0)return;let t=s._auxBufferOffsets[1],n=e*8;try{let r=await fetch(s.auxiliaryUrl,{headers:{Range:`bytes=${t}-${t+n-1}`}});if(!r.ok)return;let o=new Uint8Array(await r.arrayBuffer()),i=new DataView(o.buffer,o.byteOffset);s._rowIdCache=new Map;let a=0;for(let l=0;l<s.partitionLengths.length;l++){let c=s.partitionLengths[l],f=[];for(let h=0;h<c;h++){let m=Number(i.getBigUint64(a*8,!0));f.push({fragId:Math.floor(m/4294967296),rowOffset:m%4294967296}),a++}s._rowIdCache.set(l,f)}s._rowIdCacheReady=!0}catch{}}async function ln(s,e){if(s._rowIdCacheReady&&s._rowIdCache){let o=[];for(let i of e){let a=s._rowIdCache.get(i);if(a)for(let l of a)o.push({...l,partition:i})}return o}if(!s.auxiliaryUrl||!s._auxBufferOffsets)return null;let t=[];for(let o of e)o<s.partitionOffsets.length&&t.push({partition:o,startRow:s.partitionOffsets[o],numRows:s.partitionLengths[o]});if(t.length===0)return[];let n=[],r=s._auxBufferOffsets[1];for(let o of t){let i=r+o.startRow*8,a=i+o.numRows*8-1;try{let l=await fetch(s.auxiliaryUrl,{headers:{Range:`bytes=${i}-${a}`}});if(!l.ok)continue;let c=new Uint8Array(await l.arrayBuffer()),f=new DataView(c.buffer,c.byteOffset);for(let h=0;h<o.numRows;h++){let m=Number(f.getBigUint64(h*8,!0));n.push({fragId:Math.floor(m/4294967296),rowOffset:m%4294967296,partition:o.partition})}}catch{}}return n}function cn(s,e){let t=0;for(let n of e)n<s.partitionLengths.length&&(t+=s.partitionLengths[n]);return t}var lt=new Map,ve=new Map;function Ms(s,e){if(e>=s.length)return s;if(e<=0)return[];let t=0,n=s.length-1;for(;t<n;){let r=t+n>>1;s[r].score>s[t].score&&we(s,t,r),s[n].score>s[t].score&&we(s,t,n),s[r].score>s[n].score&&we(s,r,n);let o=s[n].score,i=t;for(let a=t;a<n;a++)s[a].score>=o&&(we(s,i,a),i++);if(we(s,i,n),i===e-1)break;i<e-1?t=i+1:n=i-1}return s.slice(0,e)}function we(s,e,t){let n=s[e];s[e]=s[t],s[t]=n}var oe=class s{constructor(){this.centroids=null,this.numPartitions=0,this.dimension=0,this.partitionOffsets=[],this.partitionLengths=[],this.metricType="cosine",this.partitionIndexUrl=null,this.partitionStarts=null,this.hasPartitionIndex=!1,this._rowIdCache=null,this._rowIdCacheReady=!1,this._accessCounts=new Map}static async tryLoad(e){if(!e)return null;if(lt.has(e))return lt.get(e);if(ve.has(e))return ve.get(e);let t=s._doLoad(e);ve.set(e,t);try{let n=await t;return n&&lt.set(e,n),n}finally{ve.delete(e)}}static async _doLoad(e){try{let t=await Zt(e);if(!t)return null;let n=`${e}/_versions/${t}.manifest`,r=await fetch(n);if(!r.ok)return null;let o=await r.arrayBuffer(),i=en(new Uint8Array(o));if(!i?.uuid)return null;let a=`${e}/_indices/${i.uuid}/index.idx`,l=await fetch(a);if(!l.ok)return null;let c=await l.arrayBuffer(),f=tn(new Uint8Array(c),i,s);if(!f)return null;f.auxiliaryUrl=`${e}/_indices/${i.uuid}/auxiliary.idx`,f.datasetBaseUrl=e;try{await rt(f)}catch{}try{await it(f)}catch{}try{await at(f)}catch{}return f}catch{return null}}async _loadPartitionIndex(){return it(this)}fetchPartitionData(e,t=384,n=null){return an(this,e,t,n)}async _loadAuxiliaryMetadata(){return rt(this)}_parseColumnMetaForPartitions(e){return ot(this,e)}_parseAuxiliaryPartitionInfo(e){return rn(this,e)}async prefetchAllRowIds(){return at(this)}fetchPartitionRowIds(e){return ln(this,e)}getPartitionRowCount(e){return cn(this,e)}findNearestPartitions(e,t=10){if(!this.centroids||e.length!==this.dimension)return[];t=Math.min(t,this.numPartitions);let n=new Array(this.numPartitions),r=0;for(let l=0;l<this.dimension;l++)r+=e[l]*e[l];let o=Math.sqrt(r);for(let l=0;l<this.numPartitions;l++){let c=l*this.dimension,f=0,h=0;for(let p=0;p<this.dimension;p++){let d=this.centroids[c+p];f+=e[p]*d,h+=d*d}let m=o*Math.sqrt(h);n[l]={idx:l,score:m===0?0:f/m}}let a=Ms(n,t).map(l=>l.idx);for(let l of a)this._accessCounts.set(l,(this._accessCounts.get(l)||0)+1);return a}async prefetchHotPartitions(e=10,t=3){if(!this._accessCounts||this._accessCounts.size===0)return;let n=[...this._accessCounts.entries()].filter(([r,o])=>o>=t).sort((r,o)=>o[1]-r[1]).slice(0,e).map(([r])=>r);n.length!==0&&await this.fetchPartitionData(n,this.dimension)}getAccessStats(){return{totalPartitions:this.numPartitions,accessedPartitions:this._accessCounts.size,topPartitions:[...this._accessCounts.entries()].sort((e,t)=>t[1]-e[1]).slice(0,10)}}};async function un(s){let e=s.url.match(/^(.+\.lance)\/data\/.+\.lance$/);if(e){s._datasetBaseUrl=e[1];try{let t=`${s._datasetBaseUrl}/_versions/1.manifest`,n=await fetch(t);if(!n.ok)return;let r=await n.arrayBuffer();s._schema=Ps(new Uint8Array(r))}catch{}}}function Ps(s){let e=new DataView(s.buffer,s.byteOffset),t=e.getUint32(0,!0),n=4+t,r;if(n+4<s.length){let l=e.getUint32(n,!0);l>0&&n+4+l<=s.length?r=s.slice(n+4,n+4+l):r=s.slice(4,4+t)}else r=s.slice(4,4+t);let o=0,i=[],a=()=>{let l=0,c=0;for(;o<r.length;){let f=r[o++];if(l|=(f&127)<<c,(f&128)===0)break;c+=7}return l};for(;o<r.length;){let l=a(),c=l>>3,f=l&7;if(c===1&&f===2){let h=a(),m=o+h,p=null,d=null,g=null;for(;o<m;){let E=a(),w=E>>3,y=E&7;if(y===0){let b=a();w===3&&(d=b)}else if(y===2){let b=a(),I=r.slice(o,o+b);o+=b,w===2?p=new TextDecoder().decode(I):w===5&&(g=new TextDecoder().decode(I))}else y===5?o+=4:y===1&&(o+=8)}p&&i.push({name:p,id:d,type:g})}else if(f===0)a();else if(f===2){let h=a();o+=h}else f===5?o+=4:f===1&&(o+=8)}return i}function fn(s){return s._schema&&s._schema.length>0?s._schema.map(e=>e.name):Array.from({length:s._numColumns},(e,t)=>`column_${t}`)}async function hn(s){if(s._columnTypes)return s._columnTypes;let e=[];if(s._schema&&s._schema.length>0){for(let t=0;t<s._numColumns;t++){let n=s._schema[t],r=n?.type?.toLowerCase()||"",o=n?.name?.toLowerCase()||"",i="unknown",a=o.includes("embedding")||o.includes("vector")||o.includes("emb")||o==="vec";r.includes("utf8")||r.includes("string")||r.includes("large_utf8")?i="string":r.includes("fixed_size_list")||r.includes("vector")||a?i="vector":r.includes("int64")||r==="int64"?i="int64":r.includes("int32")||r==="int32"?i="int32":r.includes("int16")||r==="int16"?i="int16":r.includes("int8")||r==="int8"?i="int8":r.includes("float64")||r.includes("double")?i="float64":r.includes("float32")||r.includes("float")&&!r.includes("64")?i="float32":r.includes("bool")&&(i="bool"),e.push(i)}if(e.some(t=>t!=="unknown"))return s._columnTypes=e,e;e.length=0}for(let t=0;t<s._numColumns;t++){let n="unknown",r=s.columnNames[t]?.toLowerCase()||"",o=r.includes("embedding")||r.includes("vector")||r.includes("emb")||r==="vec";try{await s.readStringAt(t,0),n="string",e.push(n);continue}catch{}try{let i=await s.getColumnOffsetEntry(t);if(i.len>0){let a=await s.fetchRange(i.pos,i.pos+i.len-1),l=new Uint8Array(a),c=s._parseColumnMeta(l);if(c.rows>0&&c.size>0){let f=c.size/c.rows;if(o&&f>=4)n="vector";else if(f===8)n="int64";else if(f===4)try{let h=await s.readInt32AtIndices(t,[0]);if(h.length>0){let m=h[0];m>=-1e6&&m<=1e6&&Number.isInteger(m)?n="int32":n="float32"}}catch{n="float32"}else f>8&&f%4===0?n="vector":f===2?n="int16":f===1&&(n="int8")}}}catch{}e.push(n)}return s._columnTypes=e,e}function mn(s){let e=0,t=[],n=0,r=()=>{let h=0n,m=0n;for(;e<s.length;){let p=s[e++];if(h|=BigInt(p&127)<<m,(p&128)===0)break;m+=7n}return Number(h)};for(;e<s.length;){let h=r(),m=h>>3,p=h&7;if(m===2&&p===2){let d=r(),g=e+d,E=[],w=[],y=0;for(;e<g;){let b=r(),I=b>>3,R=b&7;if(I===1&&R===2){let C=r(),S=e+C;for(;e<S;)E.push(r())}else if(I===2&&R===2){let C=r(),S=e+C;for(;e<S;)w.push(r())}else if(I===3&&R===0)y=r();else if(R===0)r();else if(R===2){let C=r();e+=C}else R===5?e+=4:R===1&&(e+=8)}t.push({offsets:E,sizes:w,rows:y}),n+=y}else if(p===0)r();else if(p===2){let d=r();e+=d}else p===5?e+=4:p===1&&(e+=8)}let o=t[0]||{offsets:[],sizes:[],rows:0},i=o.offsets,a=o.sizes,l=0;for(let h of t){let m=h.sizes.length>1?1:0;l+=h.sizes[m]||0}let c=i.length>1?1:0,f=i.length>1?0:-1;return{offset:i[c]||0,size:t.length>1?l:a[c]||0,rows:n,nullBitmapOffset:f>=0?i[f]:null,nullBitmapSize:f>=0?a[f]:null,bufferOffsets:i,bufferSizes:a,pages:t}}function ye(s){let e=[],t=0,n=()=>{let o=0,i=0;for(;t<s.length;){let a=s[t++];if(o|=(a&127)<<i,(a&128)===0)break;i+=7}return o};for(;t<s.length;){let o=n(),i=o>>3,a=o&7;if(i===2&&a===2){let l=n(),c=t+l,f=[0,0],h=[0,0],m=0;for(;t<c;){let p=n(),d=p>>3,g=p&7;if(d===1&&g===2){let E=n(),w=t+E,y=0;for(;t<w&&y<2;)f[y++]=n();t=w}else if(d===2&&g===2){let E=n(),w=t+E,y=0;for(;t<w&&y<2;)h[y++]=n();t=w}else if(d===3&&g===0)m=n();else if(d===4&&g===2){let E=n();t+=E}else if(g===0)n();else if(g===2){let E=n();t+=E}else g===5?t+=4:g===1&&(t+=8)}e.push({offsetsStart:f[0],offsetsSize:h[0],dataStart:f[1],dataSize:h[1],rows:m})}else if(a===0)n();else if(a===2){let l=n();t+=l}else a===5?t+=4:a===1&&(t+=8)}return{...e[0]||{offsetsStart:0,offsetsSize:0,dataStart:0,dataSize:0,rows:0},pages:e}}function j(s,e,t=1024){if(s.length===0)return[];let n=[...s].map((i,a)=>({idx:i,origPos:a}));n.sort((i,a)=>i.idx-a.idx);let r=[],o=0;for(let i=1;i<=n.length;i++)(i===n.length||(n[i].idx-n[i-1].idx)*e>t)&&(r.push({startIdx:n[o].idx,endIdx:n[i-1].idx,items:n.slice(o,i)}),o=i);return r}async function pn(s,e,t){if(t.length===0)return new BigInt64Array(0);let n=await s.getColumnOffsetEntry(e),r=await s.fetchRange(n.pos,n.pos+n.len-1),o=s._parseColumnMeta(new Uint8Array(r)),i=new BigInt64Array(t.length),a=8,l=j(t,a);return await Promise.all(l.map(async c=>{let f=o.offset+c.startIdx*a,h=o.offset+(c.endIdx+1)*a-1,m=await s.fetchRange(f,h),p=new DataView(m);for(let d of c.items){let g=(d.idx-c.startIdx)*a;i[d.origPos]=p.getBigInt64(g,!0)}})),i}async function dn(s,e,t){if(t.length===0)return new Float64Array(0);let n=await s.getColumnOffsetEntry(e),r=await s.fetchRange(n.pos,n.pos+n.len-1),o=s._parseColumnMeta(new Uint8Array(r)),i=new Float64Array(t.length),a=8,l=j(t,a);return await Promise.all(l.map(async c=>{let f=o.offset+c.startIdx*a,h=o.offset+(c.endIdx+1)*a-1,m=await s.fetchRange(f,h),p=new DataView(m);for(let d of c.items){let g=(d.idx-c.startIdx)*a;i[d.origPos]=p.getFloat64(g,!0)}})),i}async function gn(s,e,t){if(t.length===0)return new Int32Array(0);let n=await s.getColumnOffsetEntry(e),r=await s.fetchRange(n.pos,n.pos+n.len-1),o=s._parseColumnMeta(new Uint8Array(r)),i=new Int32Array(t.length),a=4,l=j(t,a);return await Promise.all(l.map(async c=>{let f=o.offset+c.startIdx*a,h=o.offset+(c.endIdx+1)*a-1,m=await s.fetchRange(f,h),p=new DataView(m);for(let d of c.items){let g=(d.idx-c.startIdx)*a;i[d.origPos]=p.getInt32(g,!0)}})),i}async function wn(s,e,t){if(t.length===0)return new Float32Array(0);let n=await s.getColumnOffsetEntry(e),r=await s.fetchRange(n.pos,n.pos+n.len-1),o=s._parseColumnMeta(new Uint8Array(r)),i=new Float32Array(t.length),a=4,l=j(t,a);return await Promise.all(l.map(async c=>{let f=o.offset+c.startIdx*a,h=o.offset+(c.endIdx+1)*a-1,m=await s.fetchRange(f,h),p=new DataView(m);for(let d of c.items){let g=(d.idx-c.startIdx)*a;i[d.origPos]=p.getFloat32(g,!0)}})),i}async function yn(s,e,t){if(t.length===0)return new Int16Array(0);let n=await s.getColumnOffsetEntry(e),r=await s.fetchRange(n.pos,n.pos+n.len-1),o=s._parseColumnMeta(new Uint8Array(r)),i=new Int16Array(t.length),a=2,l=j(t,a);return await Promise.all(l.map(async c=>{let f=o.offset+c.startIdx*a,h=o.offset+(c.endIdx+1)*a-1,m=await s.fetchRange(f,h),p=new DataView(m);for(let d of c.items){let g=(d.idx-c.startIdx)*a;i[d.origPos]=p.getInt16(g,!0)}})),i}async function En(s,e,t){if(t.length===0)return new Uint8Array(0);let n=await s.getColumnOffsetEntry(e),r=await s.fetchRange(n.pos,n.pos+n.len-1),o=s._parseColumnMeta(new Uint8Array(r)),i=new Uint8Array(t.length),a=1,l=j(t,a);return await Promise.all(l.map(async c=>{let f=o.offset+c.startIdx*a,h=o.offset+(c.endIdx+1)*a-1,m=await s.fetchRange(f,h),p=new Uint8Array(m);for(let d of c.items){let g=d.idx-c.startIdx;i[d.origPos]=p[g]}})),i}async function bn(s,e,t){if(t.length===0)return new Uint8Array(0);let n=await s.getColumnOffsetEntry(e),r=await s.fetchRange(n.pos,n.pos+n.len-1),o=s._parseColumnMeta(new Uint8Array(r)),i=new Uint8Array(t.length),a=t.map(g=>Math.floor(g/8)),l=[...new Set(a)].sort((g,E)=>g-E);if(l.length===0)return i;let c=l[0],f=l[l.length-1],h=o.offset+c,m=o.offset+f,p=await s.fetchRange(h,m),d=new Uint8Array(p);for(let g=0;g<t.length;g++){let E=t[g],w=Math.floor(E/8),y=E%8,b=w-c;b>=0&&b<d.length&&(i[g]=d[b]>>y&1)}return i}async function In(s,e,t){let n=await s.getColumnOffsetEntry(e),r=await s.fetchRange(n.pos,n.pos+n.len-1),o=ye(new Uint8Array(r));if(o.offsetsSize===0||o.dataSize===0)throw new Error(`Not a string column - offsetsSize=${o.offsetsSize}, dataSize=${o.dataSize}`);let i=o.offsetsSize/o.rows;if(i!==4&&i!==8)throw new Error(`Not a string column - bytesPerOffset=${i}, expected 4 or 8`);if(t>=o.rows)return"";let a=i,l=o.offsetsStart+t*a,c=await s.fetchRange(l,l+a*2-1),f=new DataView(c),h,m;if(a===4?(h=f.getUint32(0,!0),m=f.getUint32(4,!0)):(h=Number(f.getBigUint64(0,!0)),m=Number(f.getBigUint64(8,!0))),m<=h)return"";let p=m-h,d=await s.fetchRange(o.dataStart+h,o.dataStart+m-1);return new TextDecoder().decode(d)}async function Rn(s,e,t){if(t.length===0)return[];let n=await s.getColumnOffsetEntry(e),r=await s.fetchRange(n.pos,n.pos+n.len-1),o=ye(new Uint8Array(r));if(!o.pages||o.pages.length===0)return t.map(()=>"");let i=new Array(t.length).fill(""),a=0,l=[];for(let f of o.pages){if(f.offsetsSize===0||f.dataSize===0||f.rows===0){a+=f.rows;continue}l.push({start:a,end:a+f.rows,page:f}),a+=f.rows}let c=new Map;for(let f=0;f<t.length;f++){let h=t[f];for(let m=0;m<l.length;m++){let p=l[m];if(h>=p.start&&h<p.end){c.has(m)||c.set(m,[]),c.get(m).push({globalIdx:h,localIdx:h-p.start,resultIdx:f});break}}}for(let[f,h]of c){let p=l[f].page,d=p.offsetsSize/p.rows;if(d!==4&&d!==8)continue;h.sort((y,b)=>y.localIdx-b.localIdx);let g=[],E=0;for(let y=1;y<=h.length;y++)(y===h.length||h[y].localIdx-h[y-1].localIdx>100)&&(g.push(h.slice(E,y)),E=y);let w=[];if(await Promise.all(g.map(async y=>{let b=y[0].localIdx,I=y[y.length-1].localIdx,R=b>0?b-1:0,C=I,S=p.offsetsStart+R*d,O=p.offsetsStart+(C+1)*d-1,A=await s.fetchRange(S,O),N=new DataView(A);for(let T of y){let _=T.localIdx-R,v,x;d===4?(x=N.getUint32(_*4,!0),v=T.localIdx===0?0:N.getUint32((_-1)*4,!0)):(x=Number(N.getBigUint64(_*8,!0)),v=T.localIdx===0?0:Number(N.getBigUint64((_-1)*8,!0))),x>v&&w.push({start:v,end:x,resultIdx:T.resultIdx,dataStart:p.dataStart})}})),w.length>0){w.sort((I,R)=>I.start-R.start);let y=[],b=0;for(let I=1;I<=w.length;I++)(I===w.length||w[I].start-w[I-1].end>4096)&&(y.push({rangeStart:w[b].start,rangeEnd:w[I-1].end,items:w.slice(b,I),dataStart:w[b].dataStart}),b=I);await Promise.all(y.map(async I=>{let R=await s.fetchRange(I.dataStart+I.rangeStart,I.dataStart+I.rangeEnd-1),C=new Uint8Array(R);for(let S of I.items){let O=S.start-I.rangeStart,A=S.end-S.start,N=C.slice(O,O+A);i[S.resultIdx]=new TextDecoder().decode(N)}}))}}return i}async function ct(s,e){let t=await s.getColumnOffsetEntry(e);if(t.len===0)return{rows:0,dimension:0};let n=await s.fetchRange(t.pos,t.pos+t.len-1),r=s._parseColumnMeta(new Uint8Array(n));if(r.rows===0)return{rows:0,dimension:0};let o=0;if(r.pages&&r.pages.length>0){let i=r.pages[0],a=i.sizes.length>1?1:0,l=i.sizes[a]||0,c=i.rows||0;c>0&&l>0&&(o=Math.floor(l/(c*4)))}else r.size>0&&(o=Math.floor(r.size/(r.rows*4)));return{rows:r.rows,dimension:o}}async function An(s,e,t){let n=await s.getColumnOffsetEntry(e),r=await s.fetchRange(n.pos,n.pos+n.len-1),o=s._parseColumnMeta(new Uint8Array(r));if(o.rows===0)return new Float32Array(0);if(t>=o.rows)return new Float32Array(0);let i=Math.floor(o.size/(o.rows*4));if(i===0)return new Float32Array(0);let a=o.offset+t*i*4,l=a+i*4-1,c=await s.fetchRange(a,l);return new Float32Array(c)}async function ut(s,e,t){if(t.length===0)return[];let n=await s.getColumnOffsetEntry(e),r=await s.fetchRange(n.pos,n.pos+n.len-1),o=s._parseColumnMeta(new Uint8Array(r));if(o.rows===0)return t.map(()=>new Float32Array(0));let i=Math.floor(o.size/(o.rows*4));if(i===0)return t.map(()=>new Float32Array(0));let a=i*4,l=new Array(t.length),c=j(t,a,a*50),f=6;for(let h=0;h<c.length;h+=f){let m=c.slice(h,h+f);await Promise.all(m.map(async p=>{try{let d=o.offset+p.startIdx*a,g=o.offset+(p.endIdx+1)*a-1,E=await s.fetchRange(d,g);for(let w of p.items){let y=(w.idx-p.startIdx)*a;l[w.origPos]=new Float32Array(E.slice(y,y+a))}}catch{for(let g of p.items)l[g.origPos]=new Float32Array(0)}}))}return l}function Cn(s,e){if(s.length!==e.length)return 0;let t=0,n=0,r=0;for(let i=0;i<s.length;i++)t+=s[i]*e[i],n+=s[i]*s[i],r+=e[i]*e[i];let o=Math.sqrt(n)*Math.sqrt(r);return o===0?0:t/o}async function Tn(s,e,t,n=10,r=null,o={}){let{nprobe:i=10}=o,a=await ct(s,e);if(a.dimension===0||a.dimension!==t.length)throw new Error(`Dimension mismatch: query=${t.length}, column=${a.dimension}`);if(!s.hasIndex())throw new Error("No IVF index found. Vector search requires an IVF index for efficient querying.");if(s._ivfIndex.dimension!==t.length)throw new Error(`Query dimension (${t.length}) does not match index dimension (${s._ivfIndex.dimension}).`);return await Ds(s,e,t,n,i,r)}async function Ds(s,e,t,n,r,o){o&&o(0,100);let i=s._ivfIndex.findNearestPartitions(t,r),a=await s._ivfIndex.fetchPartitionRowIds(i);if(a&&a.length>0)return await $s(s,e,t,n,a,o);throw new Error("Failed to fetch row IDs from IVF index. Dataset may be missing auxiliary.idx or ivf_partitions.bin.")}async function $s(s,e,t,n,r,o){let i=t.length,a=new Map;for(let g of r)a.has(g.fragId)||a.set(g.fragId,[]),a.get(g.fragId).push(g.rowOffset);let l=[],c=[],f=0,h=r.length;for(let[g,E]of a){o&&o(f,h);let w=await ut(s,e,E);for(let y=0;y<E.length;y++){let b=w[y];b&&b.length===i&&(l.push(b),c.push(g*5e4+E[y])),f++}}let m,p=Q();p.isAvailable()&&(m=await p.batchCosineSimilarity(t,l,!0)),m||(m=s.lanceql.batchCosineSimilarity(t,l,!0));let d=[];for(let g=0;g<m.length;g++){let E=m[g],w=c[g];d.length<n?(d.push({idx:w,score:E}),d.sort((y,b)=>b.score-y.score)):E>d[n-1].score&&(d[n-1]={idx:w,score:E},d.sort((y,b)=>b.score-y.score))}return o&&o(h,h),{indices:d.map(g=>g.idx),scores:d.map(g=>g.score),usedIndex:!0,searchedRows:l.length}}async function Sn(s,e){let t=await s.getColumnOffsetEntry(e),n=await s.fetchRange(t.pos,t.pos+t.len-1),r=s._parseColumnMeta(new Uint8Array(n));if(!r.pages||r.pages.length===0||r.rows===0)return new Float32Array(0);let o=r.pages[0],i=o.sizes.length>1?1:0,a=o.sizes[i]||0,l=o.rows||0;if(l===0||a===0)return new Float32Array(0);let c=Math.floor(a/(l*4));if(c===0)return new Float32Array(0);let f=r.rows,h=new Float32Array(f*c),m=r.pages.map(async(g,E)=>{let w=g.sizes.length>1?1:0,y=g.offsets[w]||0,b=g.sizes[w]||0;if(b===0)return{pageIdx:E,data:new Float32Array(0),rows:0};let I=await s.fetchRange(y,y+b-1),R=new Float32Array(I);return{pageIdx:E,data:R,rows:g.rows}}),p=await Promise.all(m),d=0;for(let g of p.sort((E,w)=>E.pageIdx-w.pageIdx))h.set(g.data,d),d+=g.rows*c;return h}async function Nn(s,{offset:e=0,limit:t=50,columns:n=null}={}){let r=n||Array.from({length:s._numColumns},(m,p)=>p),o=await s.getRowCount(0),i=Math.min(e,o),a=Math.min(t,o-i);if(a<=0)return{columns:r.map(()=>[]),columnNames:s.columnNames.slice(0,r.length),total:o};let l=Array.from({length:a},(m,p)=>i+p),c=await s.detectColumnTypes(),f=r.map(async m=>{let p=c[m]||"unknown";try{switch(p){case"string":case"utf8":case"large_utf8":return await s.readStringsAtIndices(m,l);case"int64":return Array.from(await s.readInt64AtIndices(m,l));case"int32":return Array.from(await s.readInt32AtIndices(m,l));case"int16":return Array.from(await s.readInt16AtIndices(m,l));case"uint8":return Array.from(await s.readUint8AtIndices(m,l));case"float64":case"double":return Array.from(await s.readFloat64AtIndices(m,l));case"float32":case"float":return Array.from(await s.readFloat32AtIndices(m,l));case"bool":case"boolean":return await s.readBoolAtIndices(m,l);case"fixed_size_list":case"vector":let d=await s.readVectorsAtIndices(m,l);return Array.isArray(d)?d:Array.from(d);default:return await s.readStringsAtIndices(m,l)}}catch{return l.map(()=>null)}});return{columns:await Promise.all(f),columnNames:r.map(m=>s.columnNames[m]||`column_${m}`),total:o}}var ie=class s{constructor(e,t,n,r){this.lanceql=e,this.wasm=e.wasm,this.memory=e.memory,this.url=t,this.fileSize=n;let o=new Uint8Array(r);if(this.footerPtr=this.wasm.alloc(o.length),!this.footerPtr)throw new Error("Failed to allocate memory for footer");this.footerLen=o.length,new Uint8Array(this.memory.buffer).set(o,this.footerPtr),this._numColumns=this.wasm.parseFooterGetColumns(this.footerPtr,this.footerLen),this._majorVersion=this.wasm.parseFooterGetMajorVersion(this.footerPtr,this.footerLen),this._minorVersion=this.wasm.parseFooterGetMinorVersion(this.footerPtr,this.footerLen),this._columnMetaStart=this.wasm.getColumnMetaStart(this.footerPtr,this.footerLen),this._columnMetaOffsetsStart=this.wasm.getColumnMetaOffsetsStart(this.footerPtr,this.footerLen),this._columnMetaCache=new Map,this._columnOffsetCache=new Map,this._columnTypes=null,this._schema=null,this._datasetBaseUrl=null,this._ivfIndex=null}static async open(e,t){let n=await fetch(t,{method:"HEAD"});if(!n.ok)throw new Error(`HTTP error: ${n.status}`);let r=n.headers.get("Content-Length");if(!r)throw new Error("Server did not return Content-Length");let o=parseInt(r,10),a=o-40,l=await fetch(t,{headers:{Range:`bytes=${a}-${o-1}`}});if(!l.ok&&l.status!==206)throw new Error(`HTTP error: ${l.status}`);let c=await l.arrayBuffer(),f=new Uint8Array(c),h=String.fromCharCode(f[36],f[37],f[38],f[39]);if(h!=="LANC")throw new Error(`Invalid Lance file: expected LANC magic, got "${h}"`);let m=new s(e,t,o,c);await un(m);let p=t.includes("/data/");return p||await m._tryLoadIndex(),p||console.log(`[LanceQL] Loaded: ${m._numColumns} columns, ${(o/1024/1024).toFixed(1)}MB, schema: ${m._schema?"yes":"no"}, index: ${m.hasIndex()?"yes":"no"}`),m}async _tryLoadIndex(){if(this._datasetBaseUrl)try{this._ivfIndex=await oe.tryLoad(this._datasetBaseUrl)}catch{}}hasIndex(){return this._ivfIndex!==null&&this._ivfIndex.centroids!==null}get columnNames(){return fn(this)}get schema(){return this._schema}get datasetBaseUrl(){return this._datasetBaseUrl}get numColumns(){return this._numColumns}get size(){return this.fileSize}get version(){return{major:this._majorVersion,minor:this._minorVersion}}get columnMetaStart(){return Number(this._columnMetaStart)}get columnMetaOffsetsStart(){return Number(this._columnMetaOffsetsStart)}async fetchRange(e,t){(e<0||t<e||t>=this.size)&&console.error(`Invalid range: ${e}-${t}, file size: ${this.size}`);let n=Xt();if(n.enabled){let i=await n.getRange(this.url,e,t,this.size);return this._onFetch&&this._onFetch(i.byteLength,1),i}let r=await fetch(this.url,{headers:{Range:`bytes=${e}-${t}`}});if(!r.ok&&r.status!==206)throw console.error(`Fetch failed: ${r.status} for range ${e}-${t}`),new Error(`HTTP error: ${r.status}`);let o=await r.arrayBuffer();return this._onFetch&&this._onFetch(o.byteLength,1),o}onFetch(e){this._onFetch=e}close(){this.footerPtr&&(this.wasm.free(this.footerPtr,this.footerLen),this.footerPtr=null)}async getColumnOffsetEntry(e){if(e>=this._numColumns)return{pos:0,len:0};if(this._columnOffsetCache.has(e))return this._columnOffsetCache.get(e);let t=this.columnMetaOffsetsStart+e*16,n=await this.fetchRange(t,t+15),r=new DataView(n),o={pos:Number(r.getBigUint64(0,!0)),len:Number(r.getBigUint64(8,!0))};return this._columnOffsetCache.set(e,o),o}async getColumnDebugInfo(e){let t=await this.getColumnOffsetEntry(e);if(t.len===0)return{offset:0,size:0,rows:0};let n=await this.fetchRange(t.pos,t.pos+t.len-1),r=new Uint8Array(n);return this._parseColumnMeta(r)}_parseColumnMeta(e){return mn(e)}_parseStringColumnMeta(e){return ye(e)}_batchIndices(e,t,n=1024){return j(e,t,n)}async _getCachedColumnMeta(e){if(this._columnMetaCache.has(e))return this._columnMetaCache.get(e);let t=await this.getColumnOffsetEntry(e);if(t.len===0)return null;let n=await this.fetchRange(t.pos,t.pos+t.len-1),r=new Uint8Array(n);return this._columnMetaCache.set(e,r),r}readInt64AtIndices(e,t){return pn(this,e,t)}readFloat64AtIndices(e,t){return dn(this,e,t)}readInt32AtIndices(e,t){return gn(this,e,t)}readFloat32AtIndices(e,t){return wn(this,e,t)}readInt16AtIndices(e,t){return yn(this,e,t)}readUint8AtIndices(e,t){return En(this,e,t)}readBoolAtIndices(e,t){return bn(this,e,t)}readStringAt(e,t){return In(this,e,t)}readStringsAtIndices(e,t){return Rn(this,e,t)}async getRowCount(e){return(await this.getColumnDebugInfo(e)).rows}detectColumnTypes(){return hn(this)}getVectorInfo(e){return ct(this,e)}readVectorAt(e,t){return An(this,e,t)}readVectorsAtIndices(e,t){return ut(this,e,t)}cosineSimilarity(e,t){return Cn(e,t)}vectorSearch(e,t,n=10,r=null,o={}){return Tn(this,e,t,n,r,o)}readVectorColumn(e){return Sn(this,e)}readRows(e={}){return Nn(this,e)}};var Ee=class{constructor(e="lanceql-cache",t=1){this.dbName=e,this.version=t,this.db=null}async open(){return this.db?this.db:new Promise((e,t)=>{let n=indexedDB.open(this.dbName,this.version);n.onerror=()=>t(n.error),n.onsuccess=()=>{this.db=n.result,e(this.db)},n.onupgradeneeded=r=>{let o=r.target.result;o.objectStoreNames.contains("datasets")||o.createObjectStore("datasets",{keyPath:"url"}).createIndex("timestamp","timestamp")}})}async get(e){try{let t=await this.open();return new Promise(n=>{let i=t.transaction("datasets","readonly").objectStore("datasets").get(e);i.onsuccess=()=>n(i.result||null),i.onerror=()=>n(null)})}catch(t){return console.warn("[MetadataCache] Get failed:",t),null}}async set(e,t){try{let n=await this.open();return new Promise((r,o)=>{let a=n.transaction("datasets","readwrite").objectStore("datasets"),l={url:e,timestamp:Date.now(),...t},c=a.put(l);c.onsuccess=()=>r(),c.onerror=()=>o(c.error)})}catch(n){console.warn("[MetadataCache] Set failed:",n)}}async delete(e){try{let t=await this.open();return new Promise(n=>{let r=t.transaction("datasets","readwrite");r.objectStore("datasets").delete(e),r.oncomplete=()=>n()})}catch(t){console.warn("[MetadataCache] Delete failed:",t)}}async clear(){try{let e=await this.open();return new Promise(t=>{let n=e.transaction("datasets","readwrite");n.objectStore("datasets").clear(),n.oncomplete=()=>t()})}catch(e){console.warn("[MetadataCache] Clear failed:",e)}}},po=new Ee;function _n(s,e,t){let n=0,r=0,o=0,i=0,a=0,l=()=>{let h=0,m=0;for(;a<s.length;){let p=s[a++];if(h|=(p&127)<<m,(p&128)===0)break;m+=7}return h};for(;a<s.length;){let h=l(),m=h>>3,p=h&7;if(p===0){let d=l();m===1?n=d:m===2?r=d:m===3?o=d:m===4&&(i=d)}else if(p===2){let d=l();a+=d}else p===5?a+=4:p===1&&(a+=8)}if(i===0)return null;let f=`_deletions/${e}-${r}-${o}.${n===0?"arrow":"bin"}`;return{fileType:n===0?"arrow":"bitmap",readVersion:r,id:o,numDeletedRows:i,path:f,url:`${t}/${f}`}}function Gs(s){let e=new Set,t=0;s.length>=8&&String.fromCharCode(...s.slice(0,6))==="ARROW1"&&(t=8);let n=new DataView(s.buffer,s.byteOffset,s.byteLength);for(;t<s.length-4;)if(n.getInt32(t,!0)===-1){if(t+=4,t+4>s.length)break;let o=n.getInt32(t,!0);for(t+=4+o;t+4<=s.length&&n.getInt32(t,!0)!==-1;){let a=n.getInt32(t,!0);a>=0&&a<1e7&&e.add(a),t+=4}}else t++;return e}function zs(s){let e=new Set,t=new DataView(s.buffer,s.byteOffset,s.byteLength);if(s.length<8)return e;let n=t.getUint32(0,!0);if(n===12346||n===12347){let r=n===12347,o=4,i=t.getUint16(o,!0);o+=2;let a=o;o+=i*4;for(let l=0;l<i&&o<s.length;l++){let c=t.getUint16(a+l*4,!0),f=t.getUint16(a+l*4+2,!0)+1,h=c<<16;for(let m=0;m<f&&o+2<=s.length;m++){let p=t.getUint16(o,!0);e.add(h|p),o+=2}}}return e}async function xn(s,e){if(s._deletedRows.has(e))return s._deletedRows.get(e);let t=s._fragments[e];if(!t?.deletionFile){let i=new Set;return s._deletedRows.set(e,i),i}let{url:n,fileType:r,numDeletedRows:o}=t.deletionFile;console.log(`[LanceQL] Loading ${o} deletions from ${n} (${r})`);try{let i=await fetch(n);if(!i.ok){console.warn(`[LanceQL] Failed to load deletion file: ${i.status}`);let f=new Set;return s._deletedRows.set(e,f),f}let a=await i.arrayBuffer(),l=new Uint8Array(a),c;return r==="arrow"?c=Gs(l):c=zs(l),console.log(`[LanceQL] Loaded ${c.size} deleted rows for fragment ${e}`),s._deletedRows.set(e,c),c}catch(i){console.error("[LanceQL] Error loading deletion file:",i);let a=new Set;return s._deletedRows.set(e,a),a}}async function On(s,e,t,n=10,r=null,o={}){let{normalized:i=!0,workerPool:a=null,useIndex:l=!0,nprobe:c=20}=o,f=e;if(f<0)throw new Error("No vector column found in dataset");let h=t.length;if(!s.hasIndex())throw new Error("No IVF index found. Vector search requires an IVF index for efficient querying.");if(s._ivfIndex.dimension!==h)throw new Error(`Query dimension (${h}) does not match index dimension (${s._ivfIndex.dimension}).`);if(!s._ivfIndex.hasPartitionIndex)throw new Error("IVF partition index (ivf_partitions.bin) not found. Required for efficient search.");return await Ws(s,t,n,f,c,r)}async function Ws(s,e,t,n,r,o){let i=s._ivfIndex.findNearestPartitions(e,r),a=await s._ivfIndex.fetchPartitionData(i,s._ivfIndex.dimension,(w,y)=>{if(o){let b=y>0?w/y:0;o(Math.floor(b*80),100)}});if(!a||a.rowIds.length===0)throw new Error("IVF index not available. This dataset requires ivf_vectors.bin for efficient search.");let{rowIds:l,vectors:c,preFlattened:f}=a,h=e.length,m=f?c.length/h:c.length,p=new Float32Array(m),d=Q();if(d.isAvailable()){let w=d.getMaxVectorsPerBatch(h);if(f)for(let y=0;y<m;y+=w){let b=Math.min(y+w,m),I=b-y,R=c.subarray(y*h,b*h);try{let C=await d.batchCosineSimilarity(e,R,!0,!0);if(C){p.set(C,y);continue}}catch{}if(s.lanceql?.batchCosineSimilarityFlat){let C=s.lanceql.batchCosineSimilarityFlat(e,R,h,!0);p.set(C,y)}else for(let C=0;C<I;C++){let S=C*h,O=0;for(let A=0;A<h;A++)O+=e[A]*R[S+A];p[y+C]=O}}else for(let y=0;y<m;y+=w){let b=Math.min(y+w,m),I=c.slice(y,b);try{let R=await d.batchCosineSimilarity(e,I,!0,!1);if(R){p.set(R,y);continue}}catch{}for(let R=0;R<I.length;R++){let C=I[R];if(!C||C.length!==h)continue;let S=0;for(let O=0;O<h;O++)S+=e[O]*C[O];p[y+R]=S}}}else if(f)for(let w=0;w<m;w++){let y=w*h,b=0;for(let I=0;I<h;I++)b+=e[I]*c[y+I];p[w]=b}else for(let w=0;w<m;w++){let y=c[w];if(!y||y.length!==h)continue;let b=0;for(let I=0;I<h;I++)b+=e[I]*y[I];p[w]=b}o&&o(90,100);let g=new Array(l.length);for(let w=0;w<l.length;w++)g[w]={index:l[w],score:p[w]};let E=Math.min(t,g.length);return js(g,E),o&&o(100,100),{indices:g.slice(0,E).map(w=>w.index),scores:g.slice(0,E).map(w=>w.score),usedIndex:!0,searchedRows:l.length}}function js(s,e){if(e>=s.length||e<=0)return;let t=0,n=s.length-1;for(;t<n;){let r=t+n>>1;s[r].score>s[t].score&&be(s,t,r),s[n].score>s[t].score&&be(s,t,n),s[r].score>s[n].score&&be(s,r,n);let o=s[n].score,i=t;for(let a=t;a<n;a++)s[a].score>=o&&(be(s,i,a),i++);if(be(s,i,n),i===e-1)break;i<e-1?t=i+1:n=i-1}}function be(s,e,t){let n=s[e];s[e]=s[t],s[t]=n}function Ln(s){if(!s._schema)return-1;for(let e=0;e<s._schema.length;e++){let t=s._schema[e];if(t.name==="embedding"||t.name==="vector"||t.type==="fixed_size_list"||t.type==="list")return e}return s._schema.length-1}function ft(s,e){let t=0;for(let n=0;n<s._fragments.length;n++){let r=s._fragments[n];if(e<t+r.numRows)return{fragmentIndex:n,localIndex:e-t};t+=r.numRows}return null}function ee(s,e){let t=new Map;for(let n of e){let r=ft(s,n);r&&(t.has(r.fragmentIndex)||t.set(r.fragmentIndex,{localIndices:[],globalIndices:[]}),t.get(r.fragmentIndex).localIndices.push(r.localIndex),t.get(r.fragmentIndex).globalIndices.push(n))}return t}async function ht(s,{offset:e=0,limit:t=50,columns:n=null,_isPrefetch:r=!1}={}){let o=[],i=0;for(let d=0;d<s._fragments.length;d++){let g=s._fragments[d],E=i,w=i+g.numRows;if(w>e&&E<e+t){let y=Math.max(0,e-E),b=Math.min(g.numRows,e+t-E);o.push({fragmentIndex:d,localOffset:y,localLimit:b-y,globalStart:E+y})}if(i=w,i>=e+t)break}if(o.length===0)return{columns:[],columnNames:s.columnNames,total:s._totalRows};let a=o.map(async d=>{let E=await(await s.openFragment(d.fragmentIndex)).readRows({offset:d.localOffset,limit:d.localLimit,columns:n});return{...d,result:E}}),l=await Promise.all(a);l.sort((d,g)=>d.globalStart-g.globalStart);let c=[],f=l[0]?.result.columnNames||s.columnNames,h=n?n.length:s._numColumns;for(let d=0;d<h;d++){let g=[];for(let E of l)E.result.columns[d]&&g.push(...E.result.columns[d]);c.push(g)}let m={columns:c,columnNames:f,total:s._totalRows},p=e+t;return!r&&p<s._totalRows&&t<=100&&Ks(s,p,t,n),m}function Ks(s,e,t,n){let r=`${e}-${t}-${n?.join(",")||"all"}`;if(s._prefetchCache?.has(r))return;s._prefetchCache||(s._prefetchCache=new Map);let o=ht(s,{offset:e,limit:t,columns:n,_isPrefetch:!0}).then(i=>{s._prefetchCache.set(r,i)}).catch(()=>{});s._prefetchCache.set(r,o)}async function vn(s,e,t){let n=ee(s,t),r=new Map,o=[];for(let[i,a]of n)o.push((async()=>{let c=await(await s.openFragment(i)).readStringsAtIndices(e,a.localIndices);for(let f=0;f<a.globalIndices.length;f++)r.set(a.globalIndices[f],c[f])})());return await Promise.all(o),t.map(i=>r.get(i)||null)}async function Fn(s,e,t){let n=ee(s,t),r=new Map,o=[];for(let[i,a]of n)o.push((async()=>{let c=await(await s.openFragment(i)).readInt64AtIndices(e,a.localIndices);for(let f=0;f<a.globalIndices.length;f++)r.set(a.globalIndices[f],c[f])})());return await Promise.all(o),new BigInt64Array(t.map(i=>r.get(i)||0n))}async function Un(s,e,t){let n=ee(s,t),r=new Map,o=[];for(let[i,a]of n)o.push((async()=>{let c=await(await s.openFragment(i)).readFloat64AtIndices(e,a.localIndices);for(let f=0;f<a.globalIndices.length;f++)r.set(a.globalIndices[f],c[f])})());return await Promise.all(o),new Float64Array(t.map(i=>r.get(i)||0))}async function Mn(s,e,t){let n=ee(s,t),r=new Map,o=[];for(let[i,a]of n)o.push((async()=>{let c=await(await s.openFragment(i)).readInt32AtIndices(e,a.localIndices);for(let f=0;f<a.globalIndices.length;f++)r.set(a.globalIndices[f],c[f])})());return await Promise.all(o),new Int32Array(t.map(i=>r.get(i)||0))}async function Pn(s,e,t){let n=ee(s,t),r=new Map,o=[];for(let[i,a]of n)o.push((async()=>{let c=await(await s.openFragment(i)).readFloat32AtIndices(e,a.localIndices);for(let f=0;f<a.globalIndices.length;f++)r.set(a.globalIndices[f],c[f])})());return await Promise.all(o),new Float32Array(t.map(i=>r.get(i)||0))}function Qs(s){let e={type:"SELECT",columns:"*",limit:null,offset:null,where:null},t=s.toUpperCase();if(t.includes("LIMIT")){let n=s.match(/LIMIT\s+(\d+)/i);n&&(e.limit=parseInt(n[1]))}if(t.includes("OFFSET")){let n=s.match(/OFFSET\s+(\d+)/i);n&&(e.offset=parseInt(n[1]))}return t.includes("WHERE")&&(e.where=!0),e}async function Bn(s,e){let t=Qs(e);if(t.type==="SELECT"&&t.columns==="*"&&!t.where){let f=t.limit||50,h=t.offset||0;return await s.readRows({offset:h,limit:f})}let n=s._fragments.map(async(f,h)=>{let m=await s.openFragment(h);try{return await m.executeSQL(e)}catch(p){return console.warn(`Fragment ${h} query failed:`,p),{columns:[],columnNames:[],total:0}}}),r=await Promise.all(n);if(r.length===0||r.every(f=>f.columns.length===0))return{columns:[],columnNames:s.columnNames,total:0};let o=r.find(f=>f.columns.length>0);if(!o)return{columns:[],columnNames:s.columnNames,total:0};let i=o.columns.length,a=o.columnNames,l=Array.from({length:i},()=>[]),c=0;for(let f of r){for(let h=0;h<i&&h<f.columns.length;h++)l[h].push(...f.columns[h]);c+=f.total}if(t.limit){let f=t.offset||0;for(let h=0;h<i;h++)l[h]=l[h].slice(f,f+t.limit)}return{columns:l,columnNames:a,total:c}}var Fe=new Ee,Ie=class s{constructor(e,t){this.lanceql=e,this.baseUrl=t.replace(/\/$/,""),this._fragments=[],this._schema=null,this._totalRows=0,this._numColumns=0,this._onFetch=null,this._fragmentFiles=new Map,this._isRemote=!0,this._ivfIndex=null,this._deletedRows=new Map}static async open(e,t,n={}){let r=new s(e,t);r._requestedVersion=n.version||null;let o=n.version?`${t}@v${n.version}`:t;if(!n.skipCache){let a=await Fe.get(o);a&&a.schema&&a.fragments&&(r._schema=a.schema,r._fragments=a.fragments,r._numColumns=a.schema.length,r._totalRows=a.fragments.reduce((l,c)=>l+c.numRows,0),r._version=a.version,r._columnTypes=a.columnTypes||null,r._fromCache=!0)}return r._fromCache||(await r._tryLoadSidecar()||await r._loadManifest(),Fe.set(o,{schema:r._schema,fragments:r._fragments,version:r._version,columnTypes:r._columnTypes||null}).catch(()=>{})),await r._tryLoadIndex(),(n.prefetch??!1)&&r._fragments.length>0&&r._prefetchFragments(),r}async _tryLoadSidecar(){try{let e=`${this.baseUrl}/.meta.json`,t=await fetch(e);if(!t.ok)return!1;let n=await t.json();return!n.schema||!n.fragments?!1:(this._schema=n.schema.map(r=>({name:r.name,id:r.index,type:r.type})),this._fragments=n.fragments.map(r=>({id:r.id,path:r.data_files?.[0]||`${r.id}.lance`,numRows:r.num_rows,physicalRows:r.physical_rows||r.num_rows,url:`${this.baseUrl}/data/${r.data_files?.[0]||r.id+".lance"}`,deletionFile:r.has_deletions?{numDeletedRows:r.deleted_rows||0}:null})),this._numColumns=n.num_columns,this._totalRows=n.total_rows,this._version=n.lance_version,this._columnTypes=n.schema.map(r=>{let o=r.type;return o.startsWith("vector[")?"vector":o==="float64"||o==="double"?"float64":o==="float32"?"float32":o.includes("int")?o:o==="string"?"string":"unknown"}),!0)}catch{return!1}}_prefetchFragments(){let e=this._fragments.map((t,n)=>this.openFragment(n).catch(()=>null));Promise.all(e).catch(()=>{})}hasIndex(){return this._ivfIndex!==null&&this._ivfIndex.centroids!==null}async _tryLoadIndex(){try{this._ivfIndex=await oe.tryLoad(this.baseUrl)}catch{this._ivfIndex=null}}async _loadManifest(){let e=null,t=0;if(this._requestedVersion){t=this._requestedVersion;let n=`${this.baseUrl}/_versions/${t}.manifest`,r=await fetch(n);if(!r.ok)throw new Error(`Version ${t} not found (${r.status})`);e=new Uint8Array(await r.arrayBuffer())}else{let n=[1,5,10,20,50,100],r=await Promise.all(n.map(async l=>{try{let c=`${this.baseUrl}/_versions/${l}.manifest`;return(await fetch(c,{method:"HEAD"})).ok?l:0}catch{return 0}})),o=Math.max(...r);if(o>0)for(let l=o+1;l<=o+50;l++)try{let c=`${this.baseUrl}/_versions/${l}.manifest`;if((await fetch(c,{method:"HEAD"})).ok)o=l;else break}catch{break}if(t=o,t===0)throw new Error("No manifest found in dataset");let i=`${this.baseUrl}/_versions/${t}.manifest`,a=await fetch(i);if(!a.ok)throw new Error(`Failed to fetch manifest: ${a.status}`);e=new Uint8Array(await a.arrayBuffer())}this._version=t,this._latestVersion=this._requestedVersion?null:t,this._parseManifest(e)}async listVersions(){let e=[],t=this._latestVersion||100;return(await Promise.all(Array.from({length:t},(r,o)=>o+1).map(async r=>{try{let o=`${this.baseUrl}/_versions/${r}.manifest`;return(await fetch(o,{method:"HEAD"})).ok?r:0}catch{return 0}}))).filter(r=>r>0)}get version(){return this._version}_parseManifest(e){let t=new DataView(e.buffer,e.byteOffset),n=t.getUint32(0,!0),r=4+n,o;if(r+4<e.length){let h=t.getUint32(r,!0);h>0&&r+4+h<=e.length?o=e.slice(r+4,r+4+h):o=e.slice(4,4+n)}else o=e.slice(4,4+n);let i=0,a=[],l=[],c=()=>{let h=0,m=0;for(;i<o.length;){let p=o[i++];if(h|=(p&127)<<m,(p&128)===0)break;m+=7}return h},f=h=>{if(h===0)c();else if(h===2){let m=c();i+=m}else h===5?i+=4:h===1&&(i+=8)};for(;i<o.length;){let h=c(),m=h>>3,p=h&7;if(m===1&&p===2){let d=c(),g=i+d,E=null,w=null,y=null;for(;i<g;){let b=c(),I=b>>3,R=b&7;if(R===0){let C=c();I===3&&(w=C)}else if(R===2){let C=c(),S=o.slice(i,i+C);i+=C,I===2?E=new TextDecoder().decode(S):I===5&&(y=new TextDecoder().decode(S))}else f(R)}E&&a.push({name:E,id:w,type:y})}else if(m===2&&p===2){let d=c(),g=i+d,E=null,w=null,y=0,b=null;for(;i<g;){let I=c(),R=I>>3,C=I&7;if(C===0){let S=c();R===1?E=S:R===4&&(y=S)}else if(C===2){let S=c(),O=o.slice(i,i+S);if(i+=S,R===2){let A=0;for(;A<O.length;){let N=O[A++],T=N>>3,_=N&7;if(_===2){let v=0,x=0;for(;A<O.length;){let U=O[A++];if(v|=(U&127)<<x,(U&128)===0)break;x+=7}let L=O.slice(A,A+v);A+=v,T===1&&(w=new TextDecoder().decode(L))}else if(_===0)for(;A<O.length&&(O[A++]&128)!==0;);else _===5?A+=4:_===1&&(A+=8)}}else R===3&&(b=this._parseDeletionFile(O,E))}else f(C)}if(w){let I=b?y-b.numDeletedRows:y;l.push({id:E,path:w,numRows:I,physicalRows:y,deletionFile:b,url:`${this.baseUrl}/data/${w}`})}}else f(p)}this._schema=a,this._fragments=l,this._numColumns=a.length,this._totalRows=l.reduce((h,m)=>h+m.numRows,0)}_parseDeletionFile(e,t){return _n(e,t,this.baseUrl)}async _loadDeletedRows(e){return xn(this,e)}async isRowDeleted(e,t){return(await this._loadDeletedRows(e)).has(t)}get numColumns(){return this._numColumns}get rowCount(){return this._totalRows}async getRowCount(e=0){return this._totalRows}async readVectorAt(e,t){let n=this._getFragmentForRow(t);return n?await(await this.openFragment(n.fragmentIndex)).readVectorAt(e,n.localIndex):new Float32Array(0)}async getVectorInfo(e){if(this._fragments.length===0)return{rows:0,dimension:0};let n=await(await this.openFragment(0)).getVectorInfo(e);return n.dimension===0?{rows:0,dimension:0}:{rows:this._totalRows,dimension:n.dimension}}get columnNames(){return this._schema?this._schema.map(e=>e.name):[]}get schema(){return this._schema}get fragments(){return this._fragments}get size(){if(this._cachedSize)return this._cachedSize;let e=0;for(let t=0;t<(this._columnTypes?.length||0);t++){let n=this._columnTypes[t];if(n==="int64"||n==="float64"||n==="double")e+=8;else if(n==="int32"||n==="float32")e+=4;else if(n==="string")e+=50;else if(n==="vector"||n?.startsWith("vector[")){let r=n?.match(/\[(\d+)\]/),o=r?parseInt(r[1]):384;e+=o*4}else e+=8}return e===0&&(e=100),this._cachedSize=this._totalRows*e,this._cachedSize}onFetch(e){this._onFetch=e}async openFragment(e){if(e<0||e>=this._fragments.length)throw new Error(`Invalid fragment index: ${e}`);if(this._fragmentFiles.has(e))return this._fragmentFiles.get(e);let t=this._fragments[e],n=await ie.open(this.lanceql,t.url);return this._onFetch&&n.onFetch(this._onFetch),this._fragmentFiles.set(e,n),n}async readRows(e={}){return ht(this,e)}async detectColumnTypes(){if(this._columnTypes&&this._columnTypes.length>0)return this._columnTypes;if(this._fragments.length===0)return[];let t=await(await this.openFragment(0)).detectColumnTypes();this._columnTypes=t;let n=this._requestedVersion?`${this.baseUrl}@v${this._requestedVersion}`:this.baseUrl;return Fe.get(n).then(r=>{r&&(r.columnTypes=t,Fe.set(n,r).catch(()=>{}))}).catch(()=>{}),t}_getFragmentForRow(e){return ft(this,e)}_groupIndicesByFragment(e){return ee(this,e)}async readStringsAtIndices(e,t){return vn(this,e,t)}async readInt64AtIndices(e,t){return Fn(this,e,t)}async readFloat64AtIndices(e,t){return Un(this,e,t)}async readInt32AtIndices(e,t){return Mn(this,e,t)}async readFloat32AtIndices(e,t){return Pn(this,e,t)}async vectorSearch(e,t,n=10,r=null,o={}){return On(this,e,t,n,r,o)}_findVectorColumn(){return Ln(this)}async executeSQL(e){return Bn(this,e)}close(){for(let e of this._fragmentFiles.values())e.close&&e.close();this._fragmentFiles.clear()}};var u={SELECT:"SELECT",DISTINCT:"DISTINCT",FROM:"FROM",WHERE:"WHERE",AND:"AND",OR:"OR",NOT:"NOT",ORDER:"ORDER",BY:"BY",ASC:"ASC",DESC:"DESC",LIMIT:"LIMIT",OFFSET:"OFFSET",AS:"AS",NULL:"NULL",IS:"IS",IN:"IN",BETWEEN:"BETWEEN",LIKE:"LIKE",TRUE:"TRUE",FALSE:"FALSE",GROUP:"GROUP",HAVING:"HAVING",QUALIFY:"QUALIFY",ROLLUP:"ROLLUP",CUBE:"CUBE",GROUPING:"GROUPING",SETS:"SETS",COUNT:"COUNT",SUM:"SUM",AVG:"AVG",MIN:"MIN",MAX:"MAX",NEAR:"NEAR",TOPK:"TOPK",FILE:"FILE",JOIN:"JOIN",INNER:"INNER",LEFT:"LEFT",RIGHT:"RIGHT",FULL:"FULL",OUTER:"OUTER",CROSS:"CROSS",ON:"ON",CREATE:"CREATE",TABLE:"TABLE",INSERT:"INSERT",INTO:"INTO",VALUES:"VALUES",UPDATE:"UPDATE",SET:"SET",DELETE:"DELETE",DROP:"DROP",IF:"IF",EXISTS:"EXISTS",VERSION:"VERSION",VERSIONS:"VERSIONS",SHOW:"SHOW",RESTORE:"RESTORE",TO:"TO",INT:"INT",INTEGER:"INTEGER",BIGINT:"BIGINT",FLOAT:"FLOAT",REAL:"REAL",DOUBLE:"DOUBLE",TEXT:"TEXT",VARCHAR:"VARCHAR",BOOLEAN:"BOOLEAN",BOOL:"BOOL",VECTOR:"VECTOR",PRIMARY:"PRIMARY",KEY:"KEY",WITH:"WITH",RECURSIVE:"RECURSIVE",UNION:"UNION",ALL:"ALL",PIVOT:"PIVOT",UNPIVOT:"UNPIVOT",FOR:"FOR",INTERSECT:"INTERSECT",EXCEPT:"EXCEPT",OVER:"OVER",PARTITION:"PARTITION",ROW_NUMBER:"ROW_NUMBER",RANK:"RANK",DENSE_RANK:"DENSE_RANK",NTILE:"NTILE",LAG:"LAG",LEAD:"LEAD",FIRST_VALUE:"FIRST_VALUE",LAST_VALUE:"LAST_VALUE",NTH_VALUE:"NTH_VALUE",PERCENT_RANK:"PERCENT_RANK",CUME_DIST:"CUME_DIST",ROWS:"ROWS",RANGE:"RANGE",UNBOUNDED:"UNBOUNDED",PRECEDING:"PRECEDING",FOLLOWING:"FOLLOWING",CURRENT:"CURRENT",ROW:"ROW",EXPLAIN:"EXPLAIN",ARRAY:"ARRAY",CASE:"CASE",WHEN:"WHEN",THEN:"THEN",ELSE:"ELSE",END:"END",CAST:"CAST",COALESCE:"COALESCE",NULLIF:"NULLIF",IDENTIFIER:"IDENTIFIER",NUMBER:"NUMBER",STRING:"STRING",STAR:"STAR",COMMA:"COMMA",DOT:"DOT",LPAREN:"LPAREN",RPAREN:"RPAREN",EQ:"EQ",NE:"NE",LT:"LT",LE:"LE",GT:"GT",GE:"GE",PLUS:"PLUS",MINUS:"MINUS",SLASH:"SLASH",LBRACKET:"LBRACKET",RBRACKET:"RBRACKET",EOF:"EOF"},Ys={SELECT:u.SELECT,DISTINCT:u.DISTINCT,FROM:u.FROM,WHERE:u.WHERE,AND:u.AND,OR:u.OR,NOT:u.NOT,ORDER:u.ORDER,BY:u.BY,ASC:u.ASC,DESC:u.DESC,LIMIT:u.LIMIT,OFFSET:u.OFFSET,AS:u.AS,NULL:u.NULL,IS:u.IS,IN:u.IN,BETWEEN:u.BETWEEN,LIKE:u.LIKE,TRUE:u.TRUE,FALSE:u.FALSE,GROUP:u.GROUP,HAVING:u.HAVING,QUALIFY:u.QUALIFY,ROLLUP:u.ROLLUP,CUBE:u.CUBE,GROUPING:u.GROUPING,SETS:u.SETS,COUNT:u.COUNT,SUM:u.SUM,AVG:u.AVG,MIN:u.MIN,MAX:u.MAX,NEAR:u.NEAR,TOPK:u.TOPK,FILE:u.FILE,JOIN:u.JOIN,INNER:u.INNER,LEFT:u.LEFT,RIGHT:u.RIGHT,FULL:u.FULL,OUTER:u.OUTER,CROSS:u.CROSS,ON:u.ON,CREATE:u.CREATE,TABLE:u.TABLE,INSERT:u.INSERT,INTO:u.INTO,VALUES:u.VALUES,UPDATE:u.UPDATE,SET:u.SET,DELETE:u.DELETE,DROP:u.DROP,IF:u.IF,EXISTS:u.EXISTS,VERSION:u.VERSION,VERSIONS:u.VERSIONS,SHOW:u.SHOW,RESTORE:u.RESTORE,TO:u.TO,INT:u.INT,INTEGER:u.INTEGER,BIGINT:u.BIGINT,FLOAT:u.FLOAT,REAL:u.REAL,DOUBLE:u.DOUBLE,TEXT:u.TEXT,VARCHAR:u.VARCHAR,BOOLEAN:u.BOOLEAN,BOOL:u.BOOL,VECTOR:u.VECTOR,PRIMARY:u.PRIMARY,KEY:u.KEY,WITH:u.WITH,RECURSIVE:u.RECURSIVE,UNION:u.UNION,ALL:u.ALL,PIVOT:u.PIVOT,UNPIVOT:u.UNPIVOT,FOR:u.FOR,INTERSECT:u.INTERSECT,EXCEPT:u.EXCEPT,OVER:u.OVER,PARTITION:u.PARTITION,ROW_NUMBER:u.ROW_NUMBER,RANK:u.RANK,DENSE_RANK:u.DENSE_RANK,NTILE:u.NTILE,LAG:u.LAG,LEAD:u.LEAD,FIRST_VALUE:u.FIRST_VALUE,LAST_VALUE:u.LAST_VALUE,NTH_VALUE:u.NTH_VALUE,PERCENT_RANK:u.PERCENT_RANK,CUME_DIST:u.CUME_DIST,ROWS:u.ROWS,RANGE:u.RANGE,UNBOUNDED:u.UNBOUNDED,PRECEDING:u.PRECEDING,FOLLOWING:u.FOLLOWING,CURRENT:u.CURRENT,ROW:u.ROW,EXPLAIN:u.EXPLAIN,ARRAY:u.ARRAY,CASE:u.CASE,WHEN:u.WHEN,THEN:u.THEN,ELSE:u.ELSE,END:u.END,CAST:u.CAST,COALESCE:u.COALESCE,NULLIF:u.NULLIF},J=class{constructor(e){this.sql=e,this.pos=0,this.length=e.length}peek(){return this.pos>=this.length?"\0":this.sql[this.pos]}advance(){return this.pos<this.length?this.sql[this.pos++]:"\0"}skipWhitespace(){for(;this.pos<this.length&&/\s/.test(this.sql[this.pos]);)this.pos++}readIdentifier(){let e=this.pos;for(;this.pos<this.length&&/[a-zA-Z0-9_]/.test(this.sql[this.pos]);)this.pos++;return this.sql.slice(e,this.pos)}readNumber(){let e=this.pos,t=!1;for(;this.pos<this.length;){let n=this.sql[this.pos];if(n==="."&&!t)t=!0,this.pos++;else if(/\d/.test(n))this.pos++;else break}return this.sql.slice(e,this.pos)}readString(e){let t=this.pos;for(this.advance();this.pos<this.length;){if(this.sql[this.pos]===e){if(this.pos+1<this.length&&this.sql[this.pos+1]===e){this.pos+=2;continue}this.pos++;break}this.pos++}return this.sql.slice(t+1,this.pos-1).replace(new RegExp(e+e,"g"),e)}nextToken(){if(this.skipWhitespace(),this.pos>=this.length)return{type:u.EOF,value:null};let e=this.peek();if(/[a-zA-Z_]/.test(e)){let t=this.readIdentifier(),n=t.toUpperCase(),r=Ys[n]||u.IDENTIFIER;return{type:r,value:r===u.IDENTIFIER?t:n}}if(/\d/.test(e)){let t=this.readNumber();return{type:u.NUMBER,value:t}}if(e==="'"||e==='"'){let t=this.readString(e);return{type:u.STRING,value:t}}switch(this.advance(),e){case"*":return{type:u.STAR,value:"*"};case",":return{type:u.COMMA,value:","};case".":return{type:u.DOT,value:"."};case"(":return{type:u.LPAREN,value:"("};case")":return{type:u.RPAREN,value:")"};case"+":return{type:u.PLUS,value:"+"};case"-":return{type:u.MINUS,value:"-"};case"/":return{type:u.SLASH,value:"/"};case"[":return{type:u.LBRACKET,value:"["};case"]":return{type:u.RBRACKET,value:"]"};case"=":return{type:u.EQ,value:"="};case"<":return this.peek()==="="?(this.advance(),{type:u.LE,value:"<="}):this.peek()===">"?(this.advance(),{type:u.NE,value:"<>"}):{type:u.LT,value:"<"};case">":return this.peek()==="="?(this.advance(),{type:u.GE,value:">="}):{type:u.GT,value:">"};case"!":if(this.peek()==="=")return this.advance(),{type:u.NE,value:"!="};throw new Error(`Unexpected character: ${e}`);default:throw new Error(`Unexpected character: ${e}`)}}tokenize(){let e=[],t;for(;(t=this.nextToken()).type!==u.EOF;)e.push(t);return e.push(t),e}};function V(s){return Xs(s)}function Xs(s){let e=kn(s);for(;s.match(u.OR);){let t=kn(s);e={type:"binary",op:"OR",left:e,right:t}}return e}function kn(s){let e=mt(s);for(;s.match(u.AND);){let t=mt(s);e={type:"binary",op:"AND",left:e,right:t}}return e}function mt(s){return s.match(u.NOT)?{type:"unary",op:"NOT",operand:mt(s)}:Zs(s)}function Zs(s){let e=Ue(s);if(s.match(u.IS)){let r=!!s.match(u.NOT);return s.expect(u.NULL),{type:"binary",op:r?"!=":"==",left:e,right:{type:"literal",value:null}}}if(s.match(u.IN)){if(s.expect(u.LPAREN),s.check(u.SELECT)){let o=s.parseSelect(!0);return s.expect(u.RPAREN),{type:"in",expr:e,values:[{type:"subquery",query:o}]}}let r=[];for(r.push(te(s));s.match(u.COMMA);)r.push(te(s));return s.expect(u.RPAREN),{type:"in",expr:e,values:r}}if(s.match(u.BETWEEN)){let r=Ue(s);s.expect(u.AND);let o=Ue(s);return{type:"between",expr:e,low:r,high:o}}if(s.match(u.LIKE)){let r=te(s);return{type:"like",expr:e,pattern:r}}if(s.match(u.NEAR)){let r=te(s);return{type:"near",column:e,value:r}}let t={[u.EQ]:"==",[u.NE]:"!=",[u.LT]:"<",[u.LE]:"<=",[u.GT]:">",[u.GE]:">="},n=s.match(u.EQ,u.NE,u.LT,u.LE,u.GT,u.GE);if(n){let r=Ue(s);return{type:"binary",op:t[n.type],left:e,right:r}}return e}function Ue(s){let e=Dn(s);for(;;){let t=s.match(u.PLUS,u.MINUS);if(!t)break;let n=Dn(s);e={type:"binary",op:t.value,left:e,right:n}}return e}function Dn(s){let e=pt(s);for(;;){let t=s.match(u.STAR,u.SLASH);if(!t)break;let n=pt(s);e={type:"binary",op:t.value,left:e,right:n}}return e}function pt(s){return s.match(u.MINUS)?{type:"unary",op:"-",operand:pt(s)}:te(s)}function te(s){if(s.match(u.NULL))return{type:"literal",value:null};if(s.match(u.TRUE))return{type:"literal",value:!0};if(s.match(u.FALSE))return{type:"literal",value:!1};if(s.match(u.ARRAY)){let t=dt(s);for(;s.check(u.LBRACKET);){s.advance();let n=V(s);s.expect(u.RBRACKET),t={type:"subscript",array:t,index:n}}return t}if(s.check(u.LBRACKET)){let t=dt(s);for(;s.check(u.LBRACKET);){s.advance();let n=V(s);s.expect(u.RBRACKET),t={type:"subscript",array:t,index:n}}return t}if(s.check(u.NUMBER)){let t=s.advance().value;return{type:"literal",value:parseFloat(t)}}if(s.check(u.STRING))return{type:"literal",value:s.advance().value};if([u.ROW_NUMBER,u.RANK,u.DENSE_RANK,u.NTILE,u.LAG,u.LEAD,u.FIRST_VALUE,u.LAST_VALUE,u.NTH_VALUE,u.PERCENT_RANK,u.CUME_DIST].some(t=>s.check(t))){let t=s.advance().type;s.expect(u.LPAREN);let n=[];if(!s.check(u.RPAREN))for(n.push(V(s));s.match(u.COMMA);)n.push(V(s));s.expect(u.RPAREN);let r=s.parseOverClause();return{type:"call",name:t,args:n,distinct:!1,over:r}}if(s.check(u.IDENTIFIER)||s.check(u.COUNT,u.SUM,u.AVG,u.MIN,u.MAX,u.GROUPING)){let t=s.advance().value;if(s.match(u.LPAREN)){let r=!!s.match(u.DISTINCT),o=[];if(!s.check(u.RPAREN))if(s.check(u.STAR))s.advance(),o.push({type:"star"});else for(o.push(V(s));s.match(u.COMMA);)o.push(V(s));s.expect(u.RPAREN);let i=null;return s.check(u.OVER)&&(i=s.parseOverClause()),{type:"call",name:t.toUpperCase(),args:o,distinct:r,over:i}}if(s.match(u.DOT)){let r=t,o=s.advance(),i=o.value||o.type.toLowerCase();return{type:"column",table:r,column:i}}let n={type:"column",column:t};if(s.check(u.LBRACKET)){s.advance();let r=V(s);s.expect(u.RBRACKET),n={type:"subscript",array:n,index:r}}return n}if(s.match(u.LPAREN)){if(s.check(u.SELECT)){let n=s.parseSelect(!0);return s.expect(u.RPAREN),{type:"subquery",query:n}}let t=V(s);return s.expect(u.RPAREN),t}if(s.match(u.STAR))return{type:"star"};throw new Error(`Unexpected token: ${s.current().type} (${s.current().value})`)}function Me(s){if(s.match(u.NULL))return{type:"null",value:null};if(s.match(u.TRUE))return{type:"boolean",value:!0};if(s.match(u.FALSE))return{type:"boolean",value:!1};if(s.check(u.NUMBER)){let e=s.advance();return{type:"number",value:e.value.includes(".")?parseFloat(e.value):parseInt(e.value,10)}}if(s.check(u.STRING))return{type:"string",value:s.advance().value};if(s.check(u.MINUS)){s.advance();let e=s.expect(u.NUMBER);return{type:"number",value:e.value.includes(".")?-parseFloat(e.value):-parseInt(e.value,10)}}if(s.check(u.LBRACKET))return dt(s);throw new Error(`Expected value, got ${s.current().type}`)}function dt(s){s.expect(u.LBRACKET);let e=[];if(!s.check(u.RBRACKET))for(e.push(V(s));s.match(u.COMMA);)e.push(V(s));return s.expect(u.RBRACKET),{type:"array",elements:e}}function $n(s){s.expect(u.WITH);let e=!!s.match(u.RECURSIVE),t=[];do{let n=s.expect(u.IDENTIFIER).value,r=[];if(s.match(u.LPAREN)){for(r.push(s.expect(u.IDENTIFIER).value);s.match(u.COMMA);)r.push(s.expect(u.IDENTIFIER).value);s.expect(u.RPAREN)}s.expect(u.AS),s.expect(u.LPAREN);let o=tr(s,e);s.expect(u.RPAREN),t.push({name:n,columns:r,body:o,recursive:e})}while(s.match(u.COMMA));return t}function tr(s,e){let t=s.parseSelect(!0,!0);if(e&&s.match(u.UNION)){s.expect(u.ALL);let n=s.parseSelect(!0,!0);return{type:"RECURSIVE_CTE",anchor:t,recursive:n}}return t}function Vn(s){let e=[];do if(s.match(u.ROLLUP)){s.expect(u.LPAREN);let n=wt(s);s.expect(u.RPAREN),e.push({type:"ROLLUP",columns:n})}else if(s.match(u.CUBE)){s.expect(u.LPAREN);let n=wt(s);s.expect(u.RPAREN),e.push({type:"CUBE",columns:n})}else if(s.match(u.GROUPING)){s.expect(u.SETS),s.expect(u.LPAREN);let n=nr(s);s.expect(u.RPAREN),e.push({type:"GROUPING_SETS",sets:n})}else e.push({type:"COLUMN",column:s.expect(u.IDENTIFIER).value});while(s.match(u.COMMA));let t=null;return s.match(u.TOPK)&&(t=parseInt(s.expect(u.NUMBER).value,10)),{items:e,topK:t}}function nr(s){let e=[];do s.expect(u.LPAREN),s.check(u.RPAREN)?e.push([]):e.push(wt(s)),s.expect(u.RPAREN);while(s.match(u.COMMA));return e}function wt(s){let e=[s.expect(u.IDENTIFIER).value];for(;s.match(u.COMMA);)e.push(s.expect(u.IDENTIFIER).value);return e}function Gn(s){s.expect(u.OVER),s.expect(u.LPAREN);let e={partitionBy:[],orderBy:[],frame:null};if(s.match(u.PARTITION))for(s.expect(u.BY),e.partitionBy.push(s.parseExpr());s.match(u.COMMA);)e.partitionBy.push(s.parseExpr());return s.match(u.ORDER)&&(s.expect(u.BY),e.orderBy=s.parseOrderByList()),(s.check(u.ROWS)||s.check(u.RANGE))&&(e.frame=sr(s)),s.expect(u.RPAREN),e}function sr(s){let t={type:s.advance().type,start:null,end:null};return s.match(u.BETWEEN)?(t.start=gt(s),s.expect(u.AND),t.end=gt(s)):(t.start=gt(s),t.end={type:"CURRENT ROW"}),t}function gt(s){if(s.match(u.UNBOUNDED)){if(s.match(u.PRECEDING))return{type:"UNBOUNDED PRECEDING"};if(s.match(u.FOLLOWING))return{type:"UNBOUNDED FOLLOWING"};throw new Error("Expected PRECEDING or FOLLOWING after UNBOUNDED")}if(s.match(u.CURRENT))return s.expect(u.ROW),{type:"CURRENT ROW"};if(s.check(u.NUMBER)){let e=parseInt(s.advance().value,10);if(s.match(u.PRECEDING))return{type:"PRECEDING",offset:e};if(s.match(u.FOLLOWING))return{type:"FOLLOWING",offset:e};throw new Error("Expected PRECEDING or FOLLOWING after number")}throw new Error("Invalid frame bound")}function zn(s,e){s.expect(u.LPAREN);let t=e(s);if(t.type!=="call")throw new Error("PIVOT requires an aggregate function (e.g., SUM, COUNT, AVG)");s.expect(u.FOR);let n=s.expect(u.IDENTIFIER).value;s.expect(u.IN),s.expect(u.LPAREN);let r=[];for(r.push(e(s).value);s.match(u.COMMA);)r.push(e(s).value);return s.expect(u.RPAREN),s.expect(u.RPAREN),{aggregate:t,forColumn:n,inValues:r}}function Wn(s){s.expect(u.LPAREN);let e=s.expect(u.IDENTIFIER).value;s.expect(u.FOR);let t=s.expect(u.IDENTIFIER).value;s.expect(u.IN),s.expect(u.LPAREN);let n=[];for(n.push(s.expect(u.IDENTIFIER).value);s.match(u.COMMA);)n.push(s.expect(u.IDENTIFIER).value);return s.expect(u.RPAREN),s.expect(u.RPAREN),{valueColumn:e,nameColumn:t,inColumns:n}}function jn(s){let e=null,t=null,n=null,r=20,o="minilm";if(s.check(u.IDENTIFIER)){let i=s.advance().value;if(s.check(u.STRING)||s.check(u.NUMBER))e=i;else throw new Error(`NEAR requires quoted text or row number. Did you mean: NEAR '${i}'?`)}if(s.check(u.STRING))t=s.advance().value;else if(s.check(u.NUMBER))n=parseInt(s.advance().value,10);else throw new Error("NEAR requires a quoted text string or row number");return s.match(u.TOPK)&&(r=parseInt(s.expect(u.NUMBER).value,10)),{query:t,searchRow:n,column:e,topK:r,encoder:o}}var Y=class{constructor(e){this.tokens=e,this.pos=0}current(){return this.tokens[this.pos]||{type:u.EOF}}advance(){return this.pos<this.tokens.length?this.tokens[this.pos++]:{type:u.EOF}}expect(e){let t=this.current();if(t.type!==e)throw new Error(`Expected ${e}, got ${t.type} (${t.value})`);return this.advance()}match(...e){return e.includes(this.current().type)?this.advance():null}check(...e){return e.includes(this.current().type)}parse(){if(this.check(u.EXPLAIN))return this.advance(),{type:"EXPLAIN",statement:this.parse()};let e=[];if(this.check(u.WITH)&&(e=$n(this)),this.check(u.SELECT)){let t=this.parseSelect();return t.ctes=e,t}else{if(this.check(u.INSERT))return this.parseInsert();if(this.check(u.UPDATE))return this.parseUpdate();if(this.check(u.DELETE))return this.parseDelete();if(this.check(u.CREATE))return this.parseCreateTable();if(this.check(u.DROP))return this.parseDropTable();if(this.check(u.SHOW))return this.parseShowVersions();if(this.check(u.RESTORE))return this.parseRestoreTable();throw new Error(`Unexpected token: ${this.current().type}. Expected SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, SHOW, RESTORE, or EXPLAIN`)}}parseSelect(e=!1,t=!1){this.expect(u.SELECT);let n=!!this.match(u.DISTINCT),r=this.parseSelectList(),o=null;this.match(u.FROM)&&(o=this.parseFromClause());let i=[];for(;this.check(u.JOIN)||this.check(u.INNER)||this.check(u.LEFT)||this.check(u.RIGHT)||this.check(u.FULL)||this.check(u.CROSS);)i.push(this.parseJoinClause());let a=null;this.match(u.PIVOT)&&(a=zn(this,te));let l=null;this.match(u.UNPIVOT)&&(l=Wn(this));let c=null;this.match(u.WHERE)&&(c=this.parseExpr());let f=[],h=null;if(this.match(u.GROUP)){this.expect(u.BY);let E=Vn(this);f=E.items,h=E.topK}let m=null;this.match(u.HAVING)&&(m=this.parseExpr());let p=null;this.match(u.QUALIFY)&&(p=this.parseExpr());let d=null;this.match(u.NEAR)&&(d=jn(this));let g={type:"SELECT",distinct:n,columns:r,from:o,joins:i,pivot:a,unpivot:l,where:c,groupBy:f,groupByTopK:h,having:m,qualify:p,search:d,orderBy:[],limit:null,offset:null};if(!t&&(this.check(u.UNION)||this.check(u.INTERSECT)||this.check(u.EXCEPT))){let E=this.advance().type,w=!!this.match(u.ALL),y=this.parseSelect(!0,!0),b=[],I=null,R=null;if(this.match(u.ORDER)&&(this.expect(u.BY),b=this.parseOrderByList()),(this.match(u.LIMIT)||this.match(u.TOPK))&&(I=parseInt(this.expect(u.NUMBER).value,10)),b.length===0&&this.match(u.ORDER)&&(this.expect(u.BY),b=this.parseOrderByList()),this.match(u.OFFSET)&&(R=parseInt(this.expect(u.NUMBER).value,10)),!e&&this.current().type!==u.EOF)throw new Error(`Unexpected token after query: ${this.current().type} (${this.current().value}). Check your SQL syntax.`);return{type:"SET_OPERATION",operator:E,all:w,left:g,right:y,orderBy:b,limit:I,offset:R,groupByTopK:g.groupByTopK}}if(!t){let E=[],w=null,y=null;this.match(u.ORDER)&&(this.expect(u.BY),E=this.parseOrderByList()),(this.match(u.LIMIT)||this.match(u.TOPK))&&(w=parseInt(this.expect(u.NUMBER).value,10)),E.length===0&&this.match(u.ORDER)&&(this.expect(u.BY),E=this.parseOrderByList()),this.match(u.OFFSET)&&(y=parseInt(this.expect(u.NUMBER).value,10)),g.orderBy=E,g.limit=w,g.offset=y}if(!e&&this.current().type!==u.EOF)throw new Error(`Unexpected token after query: ${this.current().type} (${this.current().value}). Check your SQL syntax.`);return g}parseInsert(){this.expect(u.INSERT),this.expect(u.INTO);let e=this.expect(u.IDENTIFIER).value,t=null;if(this.match(u.LPAREN)){for(t=[],t.push(this.expect(u.IDENTIFIER).value);this.match(u.COMMA);)t.push(this.expect(u.IDENTIFIER).value);this.expect(u.RPAREN)}this.expect(u.VALUES);let n=[];do{this.expect(u.LPAREN);let r=[];for(r.push(Me(this));this.match(u.COMMA);)r.push(Me(this));this.expect(u.RPAREN),n.push(r)}while(this.match(u.COMMA));return{type:"INSERT",table:e,columns:t,rows:n}}parseUpdate(){this.expect(u.UPDATE);let e=this.expect(u.IDENTIFIER).value;this.expect(u.SET);let t=[];do{let r=this.expect(u.IDENTIFIER).value;this.expect(u.EQ);let o=Me(this);t.push({column:r,value:o})}while(this.match(u.COMMA));let n=null;return this.match(u.WHERE)&&(n=this.parseExpr()),{type:"UPDATE",table:e,assignments:t,where:n}}parseDelete(){this.expect(u.DELETE),this.expect(u.FROM);let e=this.expect(u.IDENTIFIER).value,t=null;return this.match(u.WHERE)&&(t=this.parseExpr()),{type:"DELETE",table:e,where:t}}parseCreateTable(){this.expect(u.CREATE),this.expect(u.TABLE);let e=!1;this.match(u.IF)&&(this.expect(u.NOT),this.expect(u.EXISTS),e=!0);let t=this.expect(u.IDENTIFIER).value;this.expect(u.LPAREN);let n=[];do{let r=this.expect(u.IDENTIFIER).value,o="TEXT",i=!1,a=null;this.check(u.INT)||this.check(u.INTEGER)||this.check(u.BIGINT)?(this.advance(),o="INT64"):this.check(u.FLOAT)||this.check(u.REAL)||this.check(u.DOUBLE)?(this.advance(),o="FLOAT64"):this.check(u.TEXT)||this.check(u.VARCHAR)?(this.advance(),o="STRING"):this.check(u.BOOLEAN)||this.check(u.BOOL)?(this.advance(),o="BOOL"):this.check(u.VECTOR)&&(this.advance(),o="VECTOR",this.match(u.LPAREN)&&(a=parseInt(this.expect(u.NUMBER).value,10),this.expect(u.RPAREN))),this.match(u.PRIMARY)&&(this.expect(u.KEY),i=!0),n.push({name:r,dataType:o,primaryKey:i,vectorDim:a})}while(this.match(u.COMMA));return this.expect(u.RPAREN),{type:"CREATE_TABLE",table:t,columns:n,ifNotExists:e}}parseDropTable(){this.expect(u.DROP),this.expect(u.TABLE);let e=!1;return this.match(u.IF)&&(this.expect(u.EXISTS),e=!0),{type:"DROP_TABLE",table:this.expect(u.IDENTIFIER).value,ifExists:e}}parseSelectList(){let e=[this.parseSelectItem()];for(;this.match(u.COMMA);)e.push(this.parseSelectItem());return e}parseSelectItem(){if(this.match(u.STAR))return{type:"star"};let e=this.parseExpr(),t=null;return this.match(u.AS)?t=this.expect(u.IDENTIFIER).value:this.check(u.IDENTIFIER)&&!this.check(u.FROM,u.WHERE,u.ORDER,u.LIMIT,u.TOPK,u.GROUP,u.JOIN,u.INNER,u.LEFT,u.RIGHT,u.COMMA)&&(t=this.advance().value),{type:"expr",expr:e,alias:t}}parseFromClause(){let e=null;if(this.check(u.STRING))e={type:"url",url:this.advance().value};else if(this.check(u.IDENTIFIER)){let t=this.advance().value;if(this.match(u.LPAREN))if(t.toLowerCase()==="read_lance")e={type:"url",function:"read_lance"},this.check(u.RPAREN)||(this.match(u.FILE)?(e.isFile=!0,this.match(u.COMMA)&&(e.version=parseInt(this.expect(u.NUMBER).value,10))):this.check(u.STRING)&&(e.url=this.advance().value,this.match(u.COMMA)&&(e.version=parseInt(this.expect(u.NUMBER).value,10)))),this.expect(u.RPAREN);else throw new Error(`Unknown table function: ${t}. Supported: read_lance()`);else e={type:"table",name:t}}else throw new Error("Expected table name, URL string, or read_lance() after FROM");if(e&&(this.match(u.AS)?e.alias=this.expect(u.IDENTIFIER).value:this.check(u.IDENTIFIER)&&!this.check(u.WHERE,u.ORDER,u.LIMIT,u.TOPK,u.GROUP,u.NEAR,u.JOIN,u.INNER,u.LEFT,u.RIGHT,u.COMMA,u.VERSION)&&(e.alias=this.advance().value),this.match(u.VERSION))){this.expect(u.AS);let t=this.expect(u.IDENTIFIER);if(t.value.toUpperCase()!=="OF")throw new Error(`Expected OF after VERSION AS, got ${t.value}`);e.asOfVersion=parseInt(this.expect(u.NUMBER).value,10)}return e}parseJoinClause(){let e="INNER";this.match(u.INNER)?(this.expect(u.JOIN),e="INNER"):this.match(u.LEFT)?(this.match(u.OUTER),this.expect(u.JOIN),e="LEFT"):this.match(u.RIGHT)?(this.match(u.OUTER),this.expect(u.JOIN),e="RIGHT"):this.match(u.FULL)?(this.match(u.OUTER),this.expect(u.JOIN),e="FULL"):this.match(u.CROSS)?(this.expect(u.JOIN),e="CROSS"):this.expect(u.JOIN);let t=this.parseFromClause(),n=t.alias||null,r=null;return e!=="CROSS"&&(this.expect(u.ON),r=this.parseExpr()),{type:e,table:t,alias:n,on:r}}parseOrderByList(){let e=[this.parseOrderByItem()];for(;this.match(u.COMMA);)e.push(this.parseOrderByItem());return e}parseOrderByItem(){let e=this.expect(u.IDENTIFIER).value,t=!1;return this.match(u.DESC)?t=!0:this.match(u.ASC),{column:e,descending:t}}parseExpr(){return V(this)}parseOverClause(){return Gn(this)}parseShowVersions(){return this.expect(u.SHOW),this.expect(u.VERSIONS),this.expect(u.FROM),{type:"SHOW_VERSIONS",table:this.expect(u.IDENTIFIER).value}}parseRestoreTable(){this.expect(u.RESTORE),this.expect(u.TABLE);let e=this.expect(u.IDENTIFIER).value;this.expect(u.TO),this.expect(u.VERSION);let t=parseInt(this.expect(u.NUMBER).value,10);return{type:"RESTORE_TABLE",table:e,version:t}}};var Pe=class{constructor(){this._cache=new Map,this._opfsRoot=null,this._computing=new Map}async _getStatsDir(){if(this._opfsRoot)return this._opfsRoot;if(typeof navigator>"u"||!navigator.storage?.getDirectory)return null;try{let e=await navigator.storage.getDirectory();return this._opfsRoot=await e.getDirectoryHandle("lanceql-stats",{create:!0}),this._opfsRoot}catch{return null}}_getCacheKey(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return`stats_${Math.abs(t).toString(16)}`}async loadFromCache(e,t){let n=this._getCacheKey(e);if(this._cache.has(n)){let o=this._cache.get(n);if(o.version===t)return o}let r=await this._getStatsDir();if(!r)return null;try{let a=await(await(await r.getFileHandle(`${n}.json`)).getFile()).text(),l=JSON.parse(a);return l.version!==t?null:(this._cache.set(n,l),l)}catch{return null}}async saveToCache(e,t,n){let r=this._getCacheKey(e),o={datasetUrl:e,version:t,timestamp:Date.now(),columns:n.columns,fragments:n.fragments||null};this._cache.set(r,o);let i=await this._getStatsDir();if(i)try{let l=await(await i.getFileHandle(`${r}.json`,{create:!0})).createWritable();await l.write(JSON.stringify(o)),await l.close()}catch{}}async getColumnStats(e,t,n={}){let r=e.baseUrl,o=e._version,i=n.sampleSize||1e5,a=await this.loadFromCache(r,o);if(a?.columns?.[t])return a.columns[t];let l=`${r}:${t}`;if(this._computing.has(l))return this._computing.get(l);let c=this._computeColumnStats(e,t,i);this._computing.set(l,c);try{let f=await c,h=await this.loadFromCache(r,o)||{columns:{}};return h.columns[t]=f,await this.saveToCache(r,o,h),f}finally{this._computing.delete(l)}}async _computeColumnStats(e,t,n){let r=e.schema.findIndex(c=>c.name===t);if(r===-1)throw new Error(`Column not found: ${t}`);let o=e._columnTypes?.[r]||"unknown",i=["int8","int16","int32","int64","float32","float64","double"].includes(o),a={column:t,type:o,rowCount:0,nullCount:0,min:null,max:null,computed:!0,sampleSize:0},l=0;for(let c=0;c<e._fragments.length&&l<n;c++)try{let f=await e.openFragment(c),h=Math.min(e._fragments[c].numRows,n-l),m=Array.from({length:h},(d,g)=>g),p=await f.readColumnAtIndices(r,m);for(let d of p){if(a.rowCount++,a.sampleSize++,d==null){a.nullCount++;continue}i&&((a.min===null||d<a.min)&&(a.min=d),(a.max===null||d>a.max)&&(a.max=d))}l+=p.length}catch{}return a}async precomputeForPlan(e,t){let n=new Set;for(let a of t.pushedFilters||[])a.column&&n.add(a.column),a.left?.column&&n.add(a.left.column),a.right?.column&&n.add(a.right.column);let r=Array.from(n).map(a=>this.getColumnStats(e,a).catch(()=>null)),o=await Promise.all(r),i=new Map;return Array.from(n).forEach((a,l)=>{o[l]&&i.set(a,o[l])}),i}canMatchFragment(e,t){if(!e||!t)return!0;let n=e[t.column];if(!n||n.min===null||n.max===null)return!0;switch(t.type){case"equality":return t.value>=n.min&&t.value<=n.max;case"range":switch(t.op){case">":return n.max>t.value;case">=":return n.max>=t.value;case"<":return n.min<t.value;case"<=":return n.min<=t.value}break;case"between":return n.max>=t.low&&n.min<=t.high;case"in":if(Array.isArray(t.values))return t.values.some(r=>r>=n.min&&r<=n.max);break}return!0}async getFragmentStats(e,t,n){let r=e.baseUrl,o=e._version,i=await this.loadFromCache(r,o);if(i?.fragments?.[n]?.[t])return i.fragments[n][t];let a=e.schema.findIndex(f=>f.name===t);if(a===-1)return null;let l=e._columnTypes?.[a]||"unknown",c=["int8","int16","int32","int64","float32","float64","double"].includes(l);try{let f=await e.openFragment(n),h=e._fragments[n].numRows,m=Math.min(h,1e4),p=Array.from({length:m},(w,y)=>y),d=await f.readColumnAtIndices(a,p),g={fragmentIndex:n,column:t,rowCount:h,sampledRows:m,nullCount:0,min:null,max:null};for(let w of d){if(w==null){g.nullCount++;continue}c&&((g.min===null||w<g.min)&&(g.min=w),(g.max===null||w>g.max)&&(g.max=w))}let E=await this.loadFromCache(r,o)||{columns:{},fragments:{}};return E.fragments||(E.fragments={}),E.fragments[n]||(E.fragments[n]={}),E.fragments[n][t]=g,await this.saveToCache(r,o,E),g}catch{return null}}async getPrunableFragments(e,t){if(!t||t.length===0||!e._fragments)return null;let n=e._fragments.length,r=[],o=0,i=new Set;for(let a of t)a.column&&i.add(a.column);for(let a=0;a<n;a++){let l=!1;for(let c of t){if(!c.column)continue;let f=await this.getFragmentStats(e,c.column,a);if(f&&!this.canMatchFragment({[c.column]:f},c)){l=!0;break}}l?o++:r.push(a)}return{matchingFragments:r,fragmentsPruned:o,totalFragments:n}}},yt=new Pe;function Hn(s,e){let t={type:e.type,scanColumns:[],pushedFilters:[],postFilters:[],aggregations:[],groupBy:[],having:null,orderBy:[],limit:e.limit||null,offset:e.offset||0,projection:[],canUseStatistics:!1,canStreamResults:!0,estimatedSelectivity:1},n=new Set;if(e.columns==="*"||Array.isArray(e.columns)&&e.columns.some(r=>r.type==="star"))t.projection=["*"],t.canStreamResults=!1;else if(Array.isArray(e.columns))for(let r of e.columns)or(r,n,t);if(e.where&&(K(e.where,n),It(e.where,t)),e.groupBy&&e.groupBy.length>0)for(let r of e.groupBy)K(r,n),t.groupBy.push(r);if(e.having&&(K(e.having,n),t.having=e.having),e.orderBy&&e.orderBy.length>0)for(let r of e.orderBy)K(r.expr||r,n),t.orderBy.push(r);return t.scanColumns=Array.from(n),t.estimatedSelectivity=ir(t.pushedFilters),t.canUseStatistics=t.pushedFilters.some(r=>r.type==="range"||r.type==="equality"),t}function or(s,e,t){if(s.type==="star"){t.projection.push("*");return}if(s.type==="expr"){let n=s.expr;if(n.type==="call"){let r=n.name.toUpperCase();if(["COUNT","SUM","AVG","MIN","MAX","STDDEV","STDDEV_SAMP","STDDEV_POP","VARIANCE","VAR_SAMP","VAR_POP","MEDIAN","STRING_AGG","GROUP_CONCAT"].includes(r)){let i={type:r,column:null,alias:s.alias||`${r}(${n.args[0]?.name||"*"})`,distinct:n.distinct||!1};if(n.args&&n.args.length>0){let a=n.args[0];a.type==="column"?(i.column=a.name||a.column,e.add(i.column)):a.type!=="star"&&K(a,e)}t.aggregations.push(i),t.projection.push({type:"aggregation",index:t.aggregations.length-1});return}}K(n,e),t.projection.push({type:"column",expr:n,alias:s.alias})}}function K(s,e){if(s)if(s.type==="column")e.add(s.name||s.column);else if(s.type==="binary")K(s.left,e),K(s.right,e);else if(s.type==="call")for(let t of s.args||[])K(t,e);else s.type==="unary"&&K(s.operand,e)}function It(s,e){if(s)if(s.type==="binary")if(Et(s))e.pushedFilters.push(bt(s));else if(s.op==="AND")It(s.left,e),It(s.right,e);else if(s.op==="OR"){let t=Et(s.left),n=Et(s.right);t&&n?e.pushedFilters.push({type:"or",left:bt(s.left),right:bt(s.right)}):e.postFilters.push(s)}else e.postFilters.push(s);else e.postFilters.push(s)}function Et(s){if(s.type!=="binary"||!["=","==","!=","<>","<","<=",">",">=","LIKE","IN","BETWEEN"].includes(s.op.toUpperCase()))return!1;let t=s.left.type==="column",n=s.right?.type==="column",r=s.left.type==="literal"||s.left.type==="list",o=s.right?.type==="literal"||s.right?.type==="list";return t&&o||n&&r}function bt(s){let e=s.left.type==="column",t=e?s.left.name||s.left.column:s.right.name||s.right.column,n=e?s.right.value:s.left.value,r=s.op.toUpperCase();if(r==="="||r==="==")return{type:"equality",column:t,value:n,op:"="};if(r==="!="||r==="<>")return{type:"inequality",column:t,value:n,op:"!="};if(["<","<=",">",">="].includes(r))return{type:"range",column:t,value:n,op:r};if(r==="LIKE")return{type:"like",column:t,pattern:n};if(r==="IN"){let o=s.right.type==="list"?s.right.values:[s.right.value];return{type:"in",column:t,values:o}}else if(r==="BETWEEN")return{type:"between",column:t,low:s.right.low,high:s.right.high};return{type:"unknown",expr:s}}function ir(s){if(s.length===0)return 1;let e=1;for(let t of s)switch(t.type){case"equality":e*=.1;break;case"range":e*=.3;break;case"in":e*=Math.min(.5,t.values.length*.05);break;case"like":e*=t.pattern.startsWith("%")?.5:.2;break;default:e*=.5}return Math.max(.01,e)}var ae=class{plan(e,t){let{leftTableName:n,leftAlias:r,rightTableName:o,rightAlias:i}=t,a=this._analyzeColumns(e,t),l=this._analyzeFilters(e,t),c=this._estimateFetchSize(e,l);return{leftScan:{table:n,alias:r,columns:a.left.all,filters:l.left,limit:c.left,purpose:{join:a.left.join,where:a.left.where,result:a.left.result}},rightScan:{table:o,alias:i,columns:a.right.all,filters:l.right,filterByJoinKeys:!0,purpose:{join:a.right.join,where:a.right.where,result:a.right.result}},join:{type:e.joins[0].type,leftKey:a.joinKeys.left,rightKey:a.joinKeys.right,algorithm:"HASH_JOIN"},projection:a.resultColumns,limit:e.limit||null,offset:e.offset||0}}planSingleTable(e){return Hn(this,e)}_analyzeColumns(e,t){let{leftAlias:n,rightAlias:r}=t,o={join:new Set,where:new Set,result:new Set,all:[]},i={join:new Set,where:new Set,result:new Set,all:[]};for(let f of e.columns)if(f.type==="star")o.result.add("*"),i.result.add("*");else if(f.type==="expr"&&f.expr.type==="column"){let h=f.expr,m=h.table||null,p=h.column;(!m||m===n)&&o.result.add(p),(!m||m===r)&&i.result.add(p)}let a=e.joins[0],l=this._extractJoinKeys(a.on,n,r);l.left&&o.join.add(l.left),l.right&&i.join.add(l.right),e.where&&this._extractWhereColumns(e.where,n,r,o.where,i.where),o.all=[...new Set([...o.join,...o.where,...o.result])],i.all=[...new Set([...i.join,...i.where,...i.result])],o.result.has("*")&&(o.all=["*"]),i.result.has("*")&&(i.all=["*"]);let c=[];for(let f of e.columns)if(f.type==="star")c.push("*");else if(f.type==="expr"&&f.expr.type==="column"){let h=f.expr,m=f.alias||`${h.table||""}.${h.column}`.replace(/^\./,"");c.push({table:h.table,column:h.column,alias:m})}return{left:o,right:i,joinKeys:l,resultColumns:c}}_extractJoinKeys(e,t,n){if(!e||e.type!=="binary")return{left:null,right:null};let r=e.left,o=e.right,i=null,a=null;return r.type==="column"&&(!r.table||r.table===t?i=r.column:r.table===n&&(a=r.column)),o.type==="column"&&(!o.table||o.table===t?i=o.column:o.table===n&&(a=o.column)),{left:i,right:a}}_extractWhereColumns(e,t,n,r,o){if(e)if(e.type==="column"){let i=e.table,a=e.column;!i||i===t?r.add(a):i===n&&o.add(a)}else e.type==="binary"?(this._extractWhereColumns(e.left,t,n,r,o),this._extractWhereColumns(e.right,t,n,r,o)):e.type==="unary"&&this._extractWhereColumns(e.expr,t,n,r,o)}_analyzeFilters(e,t){let{leftAlias:n,rightAlias:r}=t,o=[],i=[],a=[];return e.where&&this._separateFilters(e.where,n,r,o,i,a),{left:o,right:i,join:a}}_separateFilters(e,t,n,r,o,i){if(!e)return;if(e.type==="binary"&&e.op==="AND"){this._separateFilters(e.left,t,n,r,o,i),this._separateFilters(e.right,t,n,r,o,i);return}let a=this._getReferencedTables(e,t,n);a.size===1?a.has(t)?r.push(e):a.has(n)&&o.push(e):a.size>1&&i.push(e)}_getReferencedTables(e,t,n){let r=new Set,o=i=>{if(i)if(i.type==="column"){let a=i.table;a?a===t?r.add(t):a===n&&r.add(n):(r.add(t),r.add(n))}else if(i.type==="binary")o(i.left),o(i.right);else if(i.type==="unary")o(i.operand);else if(i.type==="call")for(let a of i.args||[])o(a);else if(i.type==="in"){o(i.expr);for(let a of i.values||[])o(a)}else i.type==="between"?(o(i.expr),o(i.low),o(i.high)):i.type==="like"&&(o(i.expr),o(i.pattern))};return o(e),r}_estimateFetchSize(e,t){let n=e.limit||1e3,r=t.left.length>0?.5:1,a=Math.ceil(n/(r*.7)*2.5);return{left:Math.min(a,1e4),right:null}}};function ce(s){if(!s)return null;if(s.type==="near"){let e=s.column?.name||s.column,t=s.value?.value??s.value;return{column:e,value:t,limit:20}}if(s.type==="binary"&&(s.op==="AND"||s.op==="OR")){let e=ce(s.left);return e||ce(s.right)}return null}function le(s){if(!s||s.type==="near")return null;if(s.type==="binary"&&(s.op==="AND"||s.op==="OR")){let e=s.left?.type==="near",t=s.right?.type==="near";if(e&&t)return null;if(e)return le(s.right);if(t)return le(s.left);let n=le(s.left),r=le(s.right);return!n&&!r?null:n?r?{...s,left:n,right:r}:n:r}return s}function Kn(s){return!s||typeof s!="string"?[]:s.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter(e=>e.length>1).filter(e=>!lr(e))}function lr(s){return new Set(["a","an","the","and","or","but","in","on","at","to","for","of","with","by","from","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","could","should","may","might","must","shall","can","need","it","its","this","that","these","those","i","you","he","she","we","they","what","which","who","whom","where","when","why","how"]).has(s)}function cr(s,e){let r=new Map;for(let o of s){let i=e.termDocs.get(o);if(!i)continue;let a=i.size,l=e.totalDocs,c=Math.log((l-a+.5)/(a+.5)+1);for(let f of i){let h=e.termFreqs.get(o).get(f),m=e.docLengths.get(f),p=e.avgDocLength,d=h*(1.2+1),g=h+1.2*(1-.75+.75*m/p),E=c*(d/g);r.set(f,(r.get(f)||0)+E)}}return r}function ur(s,e){return Array.from(s.entries()).sort((t,n)=>n[1]-t[1]).slice(0,e).map(([t])=>t)}async function fr(s,e,t){let n={termDocs:new Map,termFreqs:new Map,docLengths:new Map,totalDocs:0,avgDocLength:0},r=1e3,o=0;for(let i=0;i<t;i+=r){let a=Math.min(i+r,t),l=Array.from({length:a-i},(f,h)=>i+h),c=await s(e,l);for(let f=0;f<c.length;f++){let h=i+f,m=c[f];if(!m||typeof m!="string")continue;let p=Kn(m);n.docLengths.set(h,p.length),o+=p.length,n.totalDocs++;let d=new Map;for(let g of p)d.set(g,(d.get(g)||0)+1);for(let[g,E]of d)n.termDocs.has(g)||(n.termDocs.set(g,new Set),n.termFreqs.set(g,new Map)),n.termDocs.get(g).add(h),n.termFreqs.get(g).set(h,E)}}return n.avgDocLength=n.totalDocs>0?o/n.totalDocs:0,n}async function hr(s,e,t){let{column:n,value:r,limit:o}=e,i=s.columnMap[n.toLowerCase()];if(i===void 0)throw new Error(`Column '${n}' not found for text search`);let a=Kn(r);if(a.length===0)return[];let l=`fts_${i}_${t}`;s.file._ftsIndexCache||(s.file._ftsIndexCache=new Map);let c=s.file._ftsIndexCache.get(l);c||(c=await fr((h,m)=>s.readColumnData(h,m),i,t),s.file._ftsIndexCache.set(l,c));let f=cr(a,c);return ur(f,o)}async function qn(s,e,t){let{column:n,value:r,limit:o}=e,i=s.file.columnNames?.find(c=>c==="embedding"||c===`${n}_embedding`||c.endsWith("_embedding")||c.endsWith("_vector"));if(!i)return await hr(s,e,t);let a=s.columnMap[i.toLowerCase()];if(a===void 0)throw new Error(`Vector column '${i}' found but index missing`);let l=Math.min(o,t);try{return(await s.file.vectorSearch(a,r,l)).map(f=>f.index)}catch(c){throw console.error("[SQLExecutor] Vector search failed:",c),new Error(`NEAR search failed: ${c.message}`)}}async function Qn(s,e,t,n,r){r&&r("Executing vector search...",0,100);let o=await qn(s,e,n);if(!o||o.length===0)return[];let i=le(t);if(!i)return o;r&&r("Applying filters...",50,100);let a=new Set;s.collectColumnsFromExpr(i,a);let l={};for(let f of a){let h=s.columnMap[f.toLowerCase()];h!==void 0&&(l[f.toLowerCase()]=await s.readColumnData(h,o))}let c=[];for(let f=0;f<o.length;f++)s.evaluateExpr(i,l,f)&&c.push(o[f]);return c}async function mr(s,e,t){let n=new Set;s.collectColumnsFromExpr(t,n);let r={};for(let o of n){let i=s.columnMap[o.toLowerCase()];i!==void 0&&(r[o.toLowerCase()]=await s.readColumnData(i,e))}return e.filter((o,i)=>s.evaluateExpr(t,r,i))}async function Jn(s,e,t,n){let r=ce(e.where);if(!r)return await s.executeAggregateQuery(e,t,n);let o=await qn(s,r,t);if(o.length===0)return s._emptyAggregateResult(e);let i=le(e.where),a=o;return i&&(a=await mr(s,o,i)),a.length===0?s._emptyAggregateResult(e):e.groupBy&&e.groupBy.length>0?await s._executeGroupByOnIndices(e,a,n):await s._executeSimpleAggregateOnIndices(e,a,n)}function Yn(s){return s.columns?.some(e=>e.expr?.type==="call"&&e.expr.over)}function At(s,e,t,n){if(!e||e.length===0)return[s.map((o,i)=>({idx:i,row:o}))];let r=new Map;for(let o=0;o<s.length;o++){let i=e.map(a=>JSON.stringify(n(a,t,o))).join("|");r.has(i)||r.set(i,[]),r.get(i).push({idx:o,row:s[o]})}return Array.from(r.values())}function ne(s,e,t,n,r){for(let o of t){let i=r({type:"column",column:o.column},n,s.idx),a=r({type:"column",column:o.column},n,e.idx),l=o.direction==="DESC"?-1:1;if(!(i==null&&a==null)){if(i==null)return 1*l;if(a==null||i<a)return-1*l;if(i>a)return 1*l}}return 0}function Rt(s,e,t){let n=e.length,r=0,o=t,i=s.start||{type:"UNBOUNDED PRECEDING"},a=i.type.replace(" ","_").toUpperCase(),l=Number(i.offset??i.value??1)||1;switch(a){case"UNBOUNDED_PRECEDING":r=0;break;case"CURRENT_ROW":r=t;break;case"PRECEDING":r=Math.max(0,t-l);break;case"FOLLOWING":r=Math.min(n-1,t+l);break}let c=s.end||{type:"CURRENT ROW"},f=c.type.replace(" ","_").toUpperCase(),h=Number(c.offset??c.value??1)||1;switch(f){case"UNBOUNDED_FOLLOWING":o=n-1;break;case"CURRENT_ROW":o=t;break;case"PRECEDING":o=Math.max(0,t-h);break;case"FOLLOWING":o=Math.min(n-1,t+h);break}return r>o&&([r,o]=[o,r]),[r,o]}function dr(s,e,t,n,r,o){let i=new Array(n.length).fill(null),a=At(n,t.partitionBy,r,o);for(let l of a){t.orderBy&&t.orderBy.length>0&&l.sort((c,f)=>ne(c,f,t.orderBy,r,o));for(let c=0;c<l.length;c++){let f=l[c].idx;switch(s){case"ROW_NUMBER":i[f]=c+1;break;case"RANK":{c>0&&ne(l[c-1],l[c],t.orderBy,r,o)===0?i[f]=i[l[c-1].idx]:i[f]=c+1;break}case"DENSE_RANK":{c===0?i[f]=1:ne(l[c-1],l[c],t.orderBy,r,o)===0?i[f]=i[l[c-1].idx]:i[f]=i[l[c-1].idx]+1;break}case"NTILE":{let h=Math.max(1,Number(e[0]?.value)||1),m=Math.min(h,l.length);i[f]=Math.floor(c*m/l.length)+1;break}case"PERCENT_RANK":{let h=c+1;for(let p=0;p<c;p++)if(ne(l[p],l[c],t.orderBy,r,o)===0){h=p+1;break}let m=l.length;i[f]=m>1?(h-1)/(m-1):0;break}case"CUME_DIST":{let h=0;for(let m=0;m<l.length;m++)ne(l[m],l[c],t.orderBy,r,o)<=0&&h++;i[f]=h/l.length;break}case"LAG":{let h=e[0],m=e[1]?.value||1,p=e[2]?.value??null;if(c>=m){let d=l[c-m].idx;i[f]=o(h,r,d)}else i[f]=p;break}case"LEAD":{let h=e[0],m=e[1]?.value||1,p=e[2]?.value??null;if(c+m<l.length){let d=l[c+m].idx;i[f]=o(h,r,d)}else i[f]=p;break}case"FIRST_VALUE":{let h=l[0].idx;i[f]=o(e[0],r,h);break}case"LAST_VALUE":{let h=t.frame||{type:"RANGE",start:{type:"UNBOUNDED_PRECEDING"},end:{type:"CURRENT_ROW"}},[,m]=Rt(h,l,c),p=l[m].idx;i[f]=o(e[0],r,p);break}case"NTH_VALUE":{let h=Number(e[1]?.value)||1,m=t.frame||{type:"RANGE",start:{type:"UNBOUNDED_PRECEDING"},end:{type:"CURRENT_ROW"}},[p,d]=Rt(m,l,c),g=d-p+1;if(h>0&&h<=g){let E=l[p+h-1].idx;i[f]=o(e[0],r,E)}else i[f]=null;break}case"SUM":case"AVG":case"COUNT":case"MIN":case"MAX":{let h=t.frame||{type:"RANGE",start:{type:"UNBOUNDED_PRECEDING"},end:{type:"CURRENT_ROW"}},[m,p]=Rt(h,l,c),d=e[0]?.type==="star",g=[],E=0;for(let y=m;y<=p;y++)if(E++,!d){let b=o(e[0],r,l[y].idx),I=Number(b);b!=null&&!isNaN(I)&&g.push(I)}let w=null;switch(s){case"SUM":w=g.reduce((y,b)=>y+b,0);break;case"AVG":w=g.length>0?g.reduce((y,b)=>y+b,0)/g.length:null;break;case"COUNT":w=d?E:g.length;break;case"MIN":w=g.length>0?Math.min(...g):null;break;case"MAX":w=g.length>0?Math.max(...g):null;break}i[f]=w;break}default:i[f]=null}}}return i}function Ct(s,e,t,n){let r=[];for(let o=0;o<s.columns.length;o++){let i=s.columns[o];if(i.expr?.type==="call"&&i.expr.over){let a=dr(i.expr.name,i.expr.args,i.expr.over,e,t,n);r.push({colIndex:o,alias:i.alias||i.expr.name,values:a})}}return r}function Xn(s,e,t,n,r){let o=r.map(m=>t.rows[m]),i=Ct(e,o,n,(m,p,d)=>s._evaluateInMemoryExpr(m,p,d)),a=[];for(let m of e.columns)if(m.alias)a.push(m.alias);else if(m.expr?.type==="call"){let p=m.expr.args?.[0]?.name||m.expr.args?.[0]?.column||"*";a.push(`${m.expr.name}(${p})`)}else m.expr?.type==="column"?a.push(m.expr.name||m.expr.column):a.push("?");let l=[];for(let m=0;m<r.length;m++){let p=r[m],d=[];for(let g=0;g<e.columns.length;g++){let w=e.columns[g].expr;if(w?.over){let y=i.find(b=>b.colIndex===g);d.push(y?y.values[m]:null)}else if(w?.type==="column"){let y=(w.name||w.column||"").toLowerCase();d.push(n[y]?.[p]??null)}else d.push(s._evaluateInMemoryExpr(w,n,p))}l.push(d)}let c=l;if(e.qualify){c=[];let m={};a.forEach((p,d)=>{m[p.toLowerCase()]=d});for(let p=0;p<l.length;p++){let d={};for(let g=0;g<a.length;g++)d[a[g].toLowerCase()]=l[p][g];s._evaluateInMemoryExpr(e.qualify,d,0)&&c.push(l[p])}}if(e.orderBy&&e.orderBy.length>0){let m={};a.forEach((p,d)=>{m[p.toLowerCase()]=d}),c.sort((p,d)=>{for(let g of e.orderBy){let E=m[g.column.toLowerCase()];if(E===void 0){console.warn(`[SQLExecutor] ORDER BY column '${g.column}' not found in result columns`);continue}let w=p[E],y=d[E],b=g.descending||g.direction==="DESC"?-1:1;if(!(w==null&&y==null)){if(w==null)return 1*b;if(y==null||w<y)return-1*b;if(w>y)return 1*b}}return 0})}let f=e.offset||0,h=c;return f>0&&(h=h.slice(f)),e.limit&&(h=h.slice(0,e.limit)),{columns:a,rows:h,total:c.length}}function Zn(s,e,t){if(s.type!=="binary"||!["==","!=","<","<=",">",">="].includes(s.op))return null;let n=null,r=null,o=s.op;if(s.left.type==="column"&&s.right.type==="literal"?(n=s.left.name,r=s.right.value):s.left.type==="literal"&&s.right.type==="column"&&(n=s.right.name,r=s.left.value,o==="<"?o=">":o===">"?o="<":o==="<="?o=">=":o===">="&&(o="<=")),!n||r===null)return null;let i=e[n.toLowerCase()];if(i===void 0)return null;let a=t[i];return["int64","int32","float64","float32"].includes(a)?{column:n,colIdx:i,op:o,value:r,colType:a}:null}async function es(s,e,t,n){let r=[];for(let i=0;i<t;i+=5e3){if(n){let f=Math.round(i/t*100);n(`Filtering ${e.column}... ${f}%`,i,t)}let a=Math.min(i+5e3,t),l=Array.from({length:a-i},(f,h)=>i+h),c=await s.readColumnData(e.colIdx,l);for(let f=0;f<l.length;f++){let h=c[f],m=!1;switch(e.op){case"==":m=h===e.value;break;case"!=":m=h!==e.value;break;case"<":m=h<e.value;break;case"<=":m=h<=e.value;break;case">":m=h>e.value;break;case">=":m=h>=e.value;break}m&&r.push(l[f])}if(r.length>=1e4)break}return r}async function ts(s,e,t,n){let r=[],i=new Set;s.collectColumnsFromExpr(e,i);for(let a=0;a<t;a+=1e3){n&&n("Filtering rows...",a,t);let l=Math.min(a+1e3,t),c=Array.from({length:l-a},(h,m)=>a+m),f={};for(let h of i){let m=s.columnMap[h.toLowerCase()];m!==void 0&&(f[h.toLowerCase()]=await s.readColumnData(m,c))}for(let h=0;h<c.length;h++)B(s,e,f,h)&&r.push(c[h]);if(r.length>=1e4)break}return r}function B(s,e,t,n){if(!e)return null;switch(e.type){case"literal":return e.value;case"column":{let r=(e.name||e.column||"").toLowerCase(),o=t[r];return o?o[n]:null}case"star":return"*";case"binary":{let r=B(s,e.left,t,n),o=B(s,e.right,t,n);switch(e.op){case"+":return(r||0)+(o||0);case"-":return(r||0)-(o||0);case"*":return(r||0)*(o||0);case"/":return o!==0?(r||0)/o:null;case"==":return r===o;case"!=":return r!==o;case"<":return r<o;case"<=":return r<=o;case">":return r>o;case">=":return r>=o;case"AND":return r&&o;case"OR":return r||o;default:return null}}case"unary":{let r=B(s,e.operand,t,n);switch(e.op){case"-":return-r;case"NOT":return!r;default:return null}}case"in":{let r=B(s,e.expr,t,n);return e.values.map(i=>B(s,i,t,n)).includes(r)}case"between":{let r=B(s,e.expr,t,n),o=B(s,e.low,t,n),i=B(s,e.high,t,n);return r==null||o==null||i==null?null:r>=o&&r<=i}case"like":{let r=B(s,e.expr,t,n),o=B(s,e.pattern,t,n);return typeof r!="string"||typeof o!="string"?!1:new RegExp("^"+o.replace(/%/g,".*").replace(/_/g,".")+"$","i").test(r)}case"near":return!0;case"call":return null;case"subquery":return s._executeSubquery(e.query,t,n);case"array":return e.elements.map(r=>B(s,r,t,n));case"subscript":{let r=B(s,e.array,t,n),o=B(s,e.index,t,n);return Array.isArray(r)?r[o-1]??null:null}default:return null}}function M(s,e,t){if(!s)return null;switch(s.type){case"literal":return s.value;case"column":{let n=s.column.toLowerCase(),r=e[n];return r?Array.isArray(r)?r[t]:r:null}case"binary":{let n=M(s.left,e,t),r=M(s.right,e,t);switch(s.op||s.operator){case"=":case"==":return n==r;case"!=":case"<>":return n!=r;case"<":return n<r;case"<=":return n<=r;case">":return n>r;case">=":return n>=r;case"+":return Number(n)+Number(r);case"-":return Number(n)-Number(r);case"*":return Number(n)*Number(r);case"/":return r!==0?Number(n)/Number(r):null;case"AND":return n&&r;case"OR":return n||r;default:return null}}case"unary":{let n=M(s.operand,e,t);switch(s.op||s.operator){case"NOT":return!n;case"-":return-n;case"IS NULL":return n==null;case"IS NOT NULL":return n!=null;default:return null}}case"call":{let n=s.name.toUpperCase(),r=s.args?.map(o=>M(o,e,t))||[];switch(n){case"UPPER":return String(r[0]).toUpperCase();case"LOWER":return String(r[0]).toLowerCase();case"LENGTH":return String(r[0]).length;case"SUBSTR":case"SUBSTRING":{if(r[0]==null||r[1]==null)return null;let o=Number(r[1]);if(isNaN(o))return null;let i=r[2]!=null?Number(r[2]):void 0;return i!==void 0&&(isNaN(i)||i<0)?null:String(r[0]).substring(o-1,i!==void 0?o-1+i:void 0)}case"COALESCE":return r.find(o=>o!=null)??null;case"ABS":return Math.abs(r[0]);case"ROUND":return Math.round(r[0]*Math.pow(10,r[1]||0))/Math.pow(10,r[1]||0);case"GROUPING":{let o=s.args?.[0],i=o?.column||o?.name;return i?(e._groupingSet||[]).includes(i.toLowerCase())?0:1:0}default:return null}}case"in":{let n=M(s.expr,e,t);return s.values.map(o=>o.value??M(o,e,t)).includes(n)}case"between":{let n=M(s.expr,e,t),r=M(s.low,e,t),o=M(s.high,e,t);return n==null||r==null||o==null?null:n>=r&&n<=o}case"like":{let n=String(M(s.expr,e,t)),r=M(s.pattern,e,t);return new RegExp("^"+String(r).replace(/%/g,".*").replace(/_/g,".")+"$","i").test(n)}case"array":return s.elements.map(n=>M(n,e,t));case"subscript":{let n=M(s.array,e,t),r=M(s.index,e,t);return Array.isArray(n)?n[r-1]??null:null}default:return null}}function G(s,e){if(s)switch(s.type){case"column":e.add((s.name||s.column||"").toLowerCase());break;case"binary":G(s.left,e),G(s.right,e);break;case"unary":G(s.operand,e);break;case"call":for(let t of s.args||[])G(t,e);break;case"in":G(s.expr,e);break;case"between":G(s.expr,e);break;case"like":G(s.expr,e);break;case"near":G(s.column,e);break}}function wr(s){let e=0;for(let t of s)if(t==null)e=e*31+0>>>0;else if(typeof t=="number")e=e*31+t>>>0;else if(t instanceof Uint8Array)for(let n of t)e=e*31+n>>>0;else if(Array.isArray(t))for(let n=0;n<t.length;n++)e=e*31+(t[n]||0)>>>0;else{let n=String(t);for(let r=0;r<n.length;r++)e=e*31+n.charCodeAt(r)>>>0}return e}function yr(s){let e=new Uint32Array(s.length);for(let t=0;t<s.length;t++)e[t]=wr(s[t]);return e}function Er(s,e){let t=e.filter(n=>n!=null&&typeof n=="number");switch(s.toUpperCase()){case"SUM":return t.length>0?t.reduce((n,r)=>n+r,0):null;case"COUNT":return e.filter(n=>n!=null).length;case"AVG":return t.length>0?t.reduce((n,r)=>n+r,0)/t.length:null;case"MIN":return t.length>0?Math.min(...t):null;case"MAX":return t.length>0?Math.max(...t):null;default:return null}}function ns(s,e,t){let{aggregate:n,forColumn:r,inValues:o}=t,i=e.map(E=>E.type==="star"?"*":E.alias||(E.expr.type==="column"?E.expr.name:null)),a=i.findIndex(E=>E&&E.toLowerCase()===r.toLowerCase());if(a===-1)throw new Error(`PIVOT: Column '${r}' not found in result set`);let l=n.args&&n.args[0]?n.args[0].name||n.args[0].column||n.args[0]:null,c=l?i.findIndex(E=>E&&E.toLowerCase()===String(l).toLowerCase()):-1;if(c===-1&&n.name.toUpperCase()!=="COUNT")throw new Error("PIVOT: Aggregate source column not found");let f=[];for(let E=0;E<i.length;E++)E!==a&&E!==c&&f.push(E);let h=new Map;for(let E of s){let w=f.map(C=>JSON.stringify(E[C])).join("|"),y=E[a],b=c>=0?E[c]:1;h.has(w)||h.set(w,{groupValues:f.map(C=>E[C]),pivots:new Map});let I=h.get(w),R=String(y);I.pivots.has(R)||I.pivots.set(R,[]),I.pivots.get(R).push(b)}let p=[...f.map(E=>i[E]),...o.map(E=>String(E))],d=[];for(let[,E]of h){let w=[...E.groupValues];for(let y of o){let b=String(y),I=E.pivots.get(b)||[];w.push(Er(n.name,I))}d.push(w)}let g=p.map(E=>({type:"column",expr:{type:"column",name:E},alias:E}));return{rows:d,columns:g}}function ss(s,e,t){let{valueColumn:n,nameColumn:r,inColumns:o}=t,i=e.map(p=>p.type==="star"?"*":p.alias||(p.expr.type==="column"?p.expr.name:null)),a=o.map(p=>{let d=i.findIndex(g=>g&&g.toLowerCase()===p.toLowerCase());if(d===-1)throw new Error(`UNPIVOT: Column '${p}' not found in result set`);return d}),l=[],c=[];for(let p=0;p<i.length;p++)a.includes(p)||(l.push(p),c.push(i[p]));let f=[...c,r,n],h=[];for(let p of s){let d=l.map(g=>p[g]);for(let g=0;g<o.length;g++){let E=o[g],w=p[a[g]];w!=null&&h.push([...d,E,w])}}let m=f.map(p=>({type:"column",expr:{type:"column",name:p},alias:p}));return{rows:h,columns:m}}async function Tt(s,e,t=null){if(e.length===0)return[];if(e.length>=1e4&&t?.isAvailable?.()){let o=yr(e),i=await t.groupBy(o),a=new Int32Array(i).fill(-1);for(let c=0;c<e.length;c++){let f=o[c]%i;a[f]===-1&&(a[f]=c)}let l=[];for(let c=0;c<i;c++)a[c]!==-1&&l.push(e[a[c]]);return l}let n=new Set,r=[];for(let o of e){let i=JSON.stringify(o);n.has(i)||(n.add(i),r.push(o))}return r}async function St(s,e,t,n,r=null){let o={},i=0;for(let a of n)if(a.type==="star")for(let l of s.file.columnNames||[])o[l.toLowerCase()]=i++;else{let l=a.alias||s.exprToName(a.expr);o[l.toLowerCase()]=i++}if(e.length>=1e4&&r?.isAvailable?.()){let a=new Uint32Array(e.length);for(let c=0;c<e.length;c++)a[c]=c;for(let c=t.length-1;c>=0;c--){let f=t[c],h=o[f.column.toLowerCase()];if(h===void 0)continue;let m=!f.descending,p=new Float32Array(e.length);for(let E=0;E<e.length;E++){let w=e[a[E]][h];if(w==null)p[E]=m?34e37:-34e37;else if(typeof w=="number")p[E]=w;else if(typeof w=="string"){let y=0;for(let b=0;b<Math.min(4,w.length);b++)y=y*256+w.charCodeAt(b);p[E]=y}else p[E]=0}let d=await r.sort(p,m),g=new Uint32Array(e.length);for(let E=0;E<e.length;E++)g[E]=a[d[E]];a=g}let l=[];for(let c=0;c<e.length;c++)l.push(e[a[c]]);e.length=0,e.push(...l);return}e.sort((a,l)=>{for(let c of t){let f=o[c.column.toLowerCase()];if(f===void 0)continue;let h=a[f],m=l[f],p=c.descending?-1:1;if(!(h==null&&m==null)){if(h==null)return 1*p;if(m==null||h<m)return-1*p;if(h>m)return 1*p}}return 0})}function ue(s,e,t,n){if(!s)return!0;if(s.type==="binary"){if(s.op==="AND")return ue(s.left,e,t,n)&&ue(s.right,e,t,n);if(s.op==="OR")return ue(s.left,e,t,n)||ue(s.right,e,t,n);let r=n(s.left,e,t),o=n(s.right,e,t);switch(s.op){case"=":case"==":return r==o;case"!=":case"<>":return r!=o;case"<":return r<o;case"<=":return r<=o;case">":return r>o;case">=":return r>=o;default:return!0}}return!0}function rs(s,e,t){if(s.type==="literal")return s.value;if(s.type==="column"){let n=s.name||s.column,r=e.indexOf(n)!==-1?e.indexOf(n):e.indexOf(n.toLowerCase());return r!==-1?t[r]:null}return null}function z(s){if(!s)return"?";switch(s.type){case"column":return s.name||s.column||"?";case"literal":return String(s.value);case"call":let e=(s.args||[]).map(t=>z(t)).join(", ");return`${s.name}(${e})`;case"binary":return`${z(s.left)} ${s.op} ${z(s.right)}`;case"star":return"*";default:return"?"}}var fe=["COUNT","SUM","AVG","MIN","MAX","STDDEV","STDDEV_SAMP","STDDEV_POP","VARIANCE","VAR_SAMP","VAR_POP","MEDIAN","STRING_AGG","GROUP_CONCAT"];function _t(s){return!s||s.length===0||typeof s[0]=="string"?!1:s.some(e=>e.type==="ROLLUP"||e.type==="CUBE"||e.type==="GROUPING_SETS")}function Ir(s){let e=[];for(let t of s)if(t.type==="COLUMN")e.includes(t.column)||e.push(t.column);else if(t.type==="ROLLUP"||t.type==="CUBE")for(let n of t.columns)e.includes(n)||e.push(n);else if(t.type==="GROUPING_SETS")for(let n of t.sets)for(let r of n)e.includes(r)||e.push(r);return e}var os=12;function xt(s){if(s.length>os)throw new Error(`CUBE/ROLLUP power set limited to ${os} columns (got ${s.length}). This would generate ${Math.pow(2,s.length)} groupings.`);let e=[[]];for(let t of s){let n=e.length;for(let r=0;r<n;r++)e.push([...e[r],t])}return e}function Nt(s,e){let t=[];for(let n of s)for(let r of e)t.push([...n,...r]);return t}function Ot(s){if(!s||s.length===0)return[[]];if(typeof s[0]=="string")return[s];let e=[[]];for(let n of s)if(n.type==="COLUMN")e=e.map(r=>[...r,n.column]);else if(n.type==="ROLLUP"){let r=[];for(let o=n.columns.length;o>=0;o--)r.push(n.columns.slice(0,o));e=Nt(e,r)}else if(n.type==="CUBE"){let r=xt(n.columns);e=Nt(e,r)}else n.type==="GROUPING_SETS"&&(e=Nt(e,n.sets));let t=new Set;return e.filter(n=>{let r=JSON.stringify(n.sort());return t.has(r)?!1:(t.add(r),!0)})}function Re(s,e,t={}){let n=e.filter(r=>r!=null&&typeof r=="number"&&!isNaN(r));switch(s.toUpperCase()){case"COUNT":return e.filter(r=>r!=null).length;case"SUM":return n.reduce((r,o)=>r+o,0);case"AVG":return n.length>0?n.reduce((r,o)=>r+o,0)/n.length:null;case"MIN":return n.length>0?Math.min(...n):null;case"MAX":return n.length>0?Math.max(...n):null;case"STDDEV":case"STDDEV_SAMP":{if(n.length<2)return null;let r=n.reduce((i,a)=>i+a,0)/n.length,o=n.reduce((i,a)=>i+Math.pow(a-r,2),0)/(n.length-1);return Math.sqrt(o)}case"STDDEV_POP":{if(n.length===0)return null;let r=n.reduce((i,a)=>i+a,0)/n.length,o=n.reduce((i,a)=>i+Math.pow(a-r,2),0)/n.length;return Math.sqrt(o)}case"VARIANCE":case"VAR_SAMP":{if(n.length<2)return null;let r=n.reduce((o,i)=>o+i,0)/n.length;return n.reduce((o,i)=>o+Math.pow(i-r,2),0)/(n.length-1)}case"VAR_POP":{if(n.length===0)return null;let r=n.reduce((o,i)=>o+i,0)/n.length;return n.reduce((o,i)=>o+Math.pow(i-r,2),0)/n.length}case"MEDIAN":{if(n.length===0)return null;let r=[...n].sort((i,a)=>i-a),o=Math.floor(r.length/2);return r.length%2?r[o]:(r[o-1]+r[o])/2}case"STRING_AGG":case"GROUP_CONCAT":{let r=t.separator??",";return e.filter(o=>o!=null).map(String).join(r)}default:return null}}function Lt(s){for(let e of s.columns)if(e.type==="expr"&&e.expr.type==="call"&&fe.includes(e.expr.name.toUpperCase()))return!0;return!1}function vt(s){if(s.columns.length!==1)return!1;let e=s.columns[0];return e.type==="expr"&&e.expr.type==="call"&&e.expr.name.toUpperCase()==="COUNT"?e.expr.args[0]?.type==="star":!1}function is(s){let e=s.columns.map(n=>n.alias||z(n.expr||n)),t=s.columns.map(n=>{let r=n.expr||n;return r.type==="call"&&r.name.toUpperCase()==="COUNT"?0:null});return s.groupBy&&s.groupBy.length>0?{columns:e,rows:[],total:0,aggregationStats:{scannedRows:0,totalRows:0,coveragePercent:"100.00",isPartialScan:!1,fromSearch:!0}}:{columns:e,rows:[t],total:1,aggregationStats:{scannedRows:0,totalRows:0,coveragePercent:"100.00",isPartialScan:!1,fromSearch:!0}}}function Rr(s,e,t,n,r){let o=new Map,i=n.map(l=>l.toLowerCase());for(let l of t){let c=n.length>0?n.map(f=>{let h=e[f.toLowerCase()]?.[l];return JSON.stringify(h)}).join("|"):"__grand_total__";if(!o.has(c)){let f={};for(let h of r)i.includes(h.toLowerCase())?f[h]=e[h.toLowerCase()]?.[l]:f[h]=null;o.set(c,{values:f,indices:[],_groupingSet:n})}o.get(c).indices.push(l)}if(n.length===0&&o.size===0){let l={};for(let c of r)l[c]=null;o.set("__grand_total__",{values:l,indices:[],_groupingSet:n})}let a=[];for(let[,l]of o){let c={...l.values,_groupingSet:l._groupingSet};for(let f of s.columns){let h=f.expr;if(h?.type==="call"&&fe.includes((h.name||"").toUpperCase())){let m=h.name.toUpperCase(),p=h.args?.[0],d=p?.type==="star",g=(p?.name||p?.column||"").toLowerCase(),E=f.alias||`${m}(${d?"*":g})`,w=l.indices,y=[];d?y=w.map(()=>1):y=w.map(b=>e[g]?.[b]).filter(b=>b!=null),c[E]=m==="COUNT"&&d?w.length:Re(m,y)}}a.push(c)}return a}function Ar(s,e,t){let n=[];for(let a of s.columns)if(a.alias)n.push(a.alias);else if(a.expr?.type==="call"){let l=a.expr.args?.[0]?.name||a.expr.args?.[0]?.column||"*";n.push(`${a.expr.name}(${l})`)}else a.expr?.type==="column"?n.push(a.expr.name||a.expr.column):n.push("?");let r=e.map(a=>n.map(l=>a[l]??a[l.toLowerCase()]??null));if(s.orderBy&&s.orderBy.length>0){let a={};n.forEach((l,c)=>{a[l.toLowerCase()]=c}),r.sort((l,c)=>{for(let f of s.orderBy){let h=a[f.column.toLowerCase()];if(h===void 0)continue;let m=l[h],p=c[h],d=f.descending||f.direction==="DESC"?-1:1;if(!(m==null&&p==null)){if(m==null)return 1*d;if(p==null||m<p)return-1*d;if(m>p)return 1*d}}return 0})}let o=s.offset||0,i=r;return o>0&&(i=i.slice(o)),s.limit&&(i=i.slice(0,s.limit)),{columns:n,rows:i,total:e.length}}function Cr(s,e,t,n,r){let o=Ot(e.groupBy),i=Ir(e.groupBy),a=[];for(let l of o){let c=Rr(e,n,r,l,i);a.push(...c)}return Ar(e,a,i)}function as(s,e,t,n,r){let o=e.groupBy&&e.groupBy.length>0;if(o&&_t(e.groupBy))return Cr(s,e,t,n,r);let i=new Map;for(let h of r){let m="";o&&(m=e.groupBy.map(p=>{let d=(p.column||p.name||"").toLowerCase(),g=n[d]?.[h];return g==null?"\0":String(g)}).join("")),i.has(m)||i.set(m,[]),i.get(m).push(h)}!o&&i.size===0&&i.set("",[]);let a=[];for(let h of e.columns)if(h.alias)a.push(h.alias);else if(h.expr?.type==="call"){let m=h.expr.args?.[0]?.name||h.expr.args?.[0]?.column||"*";a.push(`${h.expr.name}(${m})`)}else h.expr?.type==="column"?a.push(h.expr.name||h.expr.column):a.push("?");let l=[];for(let[,h]of i){let m=[];for(let p of e.columns){let d=p.expr;if(d?.type==="call"&&fe.includes((d.name||"").toUpperCase())){let g=d.name.toUpperCase(),E=d.args?.[0],w=E?.type==="star",y=(E?.name||E?.column||"").toLowerCase();if(g==="COUNT"&&w)m.push(h.length);else{let b=h.map(R=>n[y]?.[R]),I=d.args?.[1]?.value;m.push(Re(g,b,{separator:I}))}}else if(d?.type==="column"){let g=(d.name||d.column||"").toLowerCase();m.push(n[g]?.[h[0]]??null)}else m.push(M(d,n,h[0]))}l.push(m)}if(e.orderBy&&e.orderBy.length>0){let h={};a.forEach((m,p)=>{h[m.toLowerCase()]=p}),l.sort((m,p)=>{for(let d of e.orderBy){let g=h[d.column.toLowerCase()];if(g===void 0)continue;let E=m[g],w=p[g],y=d.descending||d.direction==="DESC"?-1:1;if(!(E==null&&w==null)){if(E==null)return 1*y;if(w==null||E<w)return-1*y;if(E>w)return 1*y}}return 0})}let c=e.offset||0,f=l;return c>0&&(f=f.slice(c)),e.limit&&(f=f.slice(0,e.limit)),{columns:a,rows:f,total:i.size}}function ls(s,e,t,n){let r=structuredClone(e),o=r.from?.name||r.from?.table,i=Sr(r,o),a={};for(let c of i){let f=c.column.toLowerCase();t[f]&&(a[c.table+"."+c.column]=t[f][n])}Object.keys(a).length>0&&W(r.where,a);let l=r.from?.name?.toLowerCase()||r.from?.table?.toLowerCase();if(l&&s._cteResults?.has(l)){let c=Be(s,r,s._cteResults.get(l));return c.rows.length>0?c.rows[0][0]:null}if(s._database)try{let c=s._database._executeSingleTable(r);return c&&c.then?null:c?.rows?.[0]?.[0]??null}catch{return null}return null}function Sr(s,e){let t=[],n=r=>{r&&(r.type==="column"&&r.table&&r.table!==e?t.push(r):r.type==="binary"?(n(r.left),n(r.right)):r.type==="unary"?n(r.operand):r.type==="in"?(n(r.expr),r.values?.forEach(n)):r.type==="between"?(n(r.expr),n(r.low),n(r.high)):r.type==="like"?(n(r.expr),n(r.pattern)):r.type==="call"&&r.args?.forEach(n))};return n(s.where),t}function W(s,e){if(s)if(s.type==="column"&&s.table){let t=s.table+"."+s.column;e.hasOwnProperty(t)&&(s.type="literal",s.value=e[t],delete s.table,delete s.column)}else s.type==="binary"?(W(s.left,e),W(s.right,e)):s.type==="unary"?W(s.operand,e):s.type==="in"?(W(s.expr,e),s.values?.forEach(t=>W(t,e))):s.type==="between"?(W(s.expr,e),W(s.low,e),W(s.high,e)):s.type==="like"?(W(s.expr,e),W(s.pattern,e)):s.type==="call"&&s.args?.forEach(t=>W(t,e))}async function cs(s,e,t){s._database=t;for(let n of e){let r=n.name.toLowerCase();if(n.body.type==="RECURSIVE_CTE"){let o=await Ae(s,n.body.anchor,t),i={columns:o.columns,rows:[...o.rows]};for(let a=0;a<1e3;a++){s._cteResults.set(r,i);let l=await Ae(s,n.body.recursive,t);if(l.rows.length===0)break;i={columns:i.columns,rows:[...i.rows,...l.rows]}}s._cteResults.set(r,i)}else{let o=await Ae(s,n.body,t);s._cteResults.set(r,o)}}}async function Ae(s,e,t){let n=e.from?.name?.toLowerCase()||e.from?.table?.toLowerCase();return n&&s._cteResults.has(n)?Be(s,e,s._cteResults.get(n)):t._executeSingleTable(e)}function Nr(s){let e=["COUNT","SUM","AVG","MIN","MAX","STDDEV","STDDEV_SAMP","STDDEV_POP","VARIANCE","VAR_SAMP","VAR_POP","MEDIAN","STRING_AGG","GROUP_CONCAT"];for(let t of s)if(t.expr?.type==="call"){if(t.expr.over)continue;let n=(t.expr.name||"").toUpperCase();if(e.includes(n))return!0}return!1}function Be(s,e,t){let n={};for(let m=0;m<t.columns.length;m++){let p=t.columns[m].toLowerCase();n[p]=t.rows.map(d=>d[m])}let r=[];for(let m=0;m<t.rows.length;m++)(!e.where||M(e.where,n,m))&&r.push(m);let o=e.groupBy&&e.groupBy.length>0,i=Nr(e.columns);if(o||i)return s._executeGroupByAggregation(e,t,n,r);if(s.hasWindowFunctions(e))return s._executeWindowFunctions(e,t,n,r);let a=[],l=[];if(e.columns.length===1&&(e.columns[0].type==="star"||e.columns[0].expr?.type==="star")){for(let m of t.columns)a.push(m);for(let m of r)l.push([...t.rows[m]])}else{for(let m of e.columns)a.push(m.alias||m.expr?.column||"*");for(let m of r){let p=e.columns.map(d=>d.type==="star"||d.expr?.type==="star"?t.rows[m]:M(d.expr,n,m));l.push(p.flat())}}if(e.orderBy&&e.orderBy.length>0){let m={};a.forEach((p,d)=>{m[p.toLowerCase()]=d}),l.sort((p,d)=>{for(let g of e.orderBy){let E=m[g.column.toLowerCase()];if(E===void 0)continue;let w=p[E],y=d[E],b=g.descending||g.direction==="DESC"?-1:1;if(!(w==null&&y==null)){if(w==null)return 1*b;if(y==null||w<y)return-1*b;if(w>y)return 1*b}}return 0})}let f=e.offset||0,h=l;return f>0&&(h=h.slice(f)),e.limit&&(h=h.slice(0,e.limit)),{columns:a,rows:h,total:r.length}}var $=class{constructor(e,t={}){this.file=e,this.columnMap={},this.columnTypes=[],this._cteResults=new Map,this._database=null,this._ftsIndexCache=null,this._debug=t.debug??!1,e.columnNames&&e.columnNames.forEach((n,r)=>{this.columnMap[n.toLowerCase()]=r})}setDatabase(e){this._database=e}async execute(e,t=null){let r=new J(e).tokenize(),i=new Y(r).parse(),l=new ae().planSingleTable(i);this.columnTypes.length===0&&(this.file._isRemote&&this.file.detectColumnTypes?this.columnTypes=await this.file.detectColumnTypes():this.file._columnTypes?this.columnTypes=this.file._columnTypes:this.columnTypes=Array(this.file.numColumns||0).fill("unknown"));let c=this.file._isRemote?await this.file.getRowCount(0):Number(this.file.getRowCount(0)),f=null;i.where&&l.pushedFilters.length>0&&this.file._isRemote&&(f=await yt.precomputeForPlan(this.file,l),l.columnStats=Object.fromEntries(f));let h=l.scanColumns.length>0?l.scanColumns:this.collectNeededColumns(i),m=this.resolveOutputColumns(i);if(l.aggregations.length>0||Lt(i))return vt(i)&&!i.where&&!i.search?{columns:["COUNT(*)"],rows:[[c]],total:1,aggregationStats:{scannedRows:0,totalRows:c,coveragePercent:"100.00",isPartialScan:!1,fromMetadata:!0},queryPlan:l}:i.search||ce(i.where)?await Jn(this,i,c,t):await this.executeAggregateQuery(i,c,t);let d,g=i.limit||100,E=i.offset||0;if(i.where)d=await this.evaluateWhere(i.where,c,t),d=d.slice(E,E+g);else{d=[];let I=Math.min(E+g,c);for(let R=E;R<I;R++)d.push(R)}t&&t("Fetching column data...",0,m.length);let w={};for(let I=0;I<h.length;I++){let R=h[I],C=this.columnMap[R.toLowerCase()];C!==void 0&&(t&&t(`Fetching ${R}...`,I,h.length),w[R.toLowerCase()]=await this.readColumnData(C,d))}let y=[];for(let I=0;I<d.length;I++){let R=[];for(let C of m)if(C.type==="star")for(let S of this.file.columnNames||[])R.push(w[S.toLowerCase()]?.[I]??null);else R.push(this.evaluateExpr(C.expr,w,I));y.push(R)}if(i.pivot){let I=ns(y,m,i.pivot);y.length=0,y.push(...I.rows),m.length=0,m.push(...I.columns)}if(i.unpivot){let I=ss(y,m,i.unpivot);y.length=0,y.push(...I.rows),m.length=0,m.push(...I.columns)}if(i.distinct){let I=await Tt(this,y,gpuSorter);y.length=0,y.push(...I)}i.orderBy&&i.orderBy.length>0&&await St(this,y,i.orderBy,m,gpuSorter);let b=[];for(let I of m)I.type==="star"?b.push(...this.file.columnNames||[]):b.push(I.alias||z(I.expr));return{columns:b,rows:y,total:i.limit?y.length:c,orderByOnSubset:i.orderBy&&i.orderBy.length>0&&y.length<c,orderByColumns:i.orderBy?i.orderBy.map(I=>`${I.column} ${I.direction}`):[],queryPlan:l,optimization:{statsComputed:f?.size>0,columnStats:f?Object.fromEntries(f):null,pushedFilters:l.pushedFilters?.length||0,estimatedSelectivity:l.estimatedSelectivity}}}collectNeededColumns(e){let t=new Set;for(let n of e.columns)n.type==="star"?(this.file.columnNames||[]).forEach(r=>t.add(r.toLowerCase())):G(n.expr,t);e.where&&G(e.where,t);for(let n of e.orderBy||[])t.add(n.column.toLowerCase());return Array.from(t)}collectColumnsFromExpr(e,t){G(e,t)}resolveOutputColumns(e){return e.columns}async readColumnData(e,t){let n=this.columnTypes[e]||"unknown";try{if(n==="string"){let r=await this.file.readStringsAtIndices(e,t);return Array.isArray(r)?r:Array.from(r)}else if(n==="int64"){let r=await this.file.readInt64AtIndices(e,t);return Array.from(r,o=>Number(o))}else{if(n==="float64")return Array.from(await this.file.readFloat64AtIndices(e,t));if(n==="int32")return Array.from(await this.file.readInt32AtIndices(e,t));if(n==="float32")return Array.from(await this.file.readFloat32AtIndices(e,t));if(n==="vector")return t.map(()=>"[vector]");try{return await this.file.readStringsAtIndices(e,t)}catch(r){return this._debug&&console.warn(`[SQLExecutor] readColumnData col ${e} fallback failed:`,r.message),t.map(()=>null)}}}catch(r){return this._debug&&console.warn(`[SQLExecutor] readColumnData col ${e} failed:`,r.message),t.map(()=>null)}}async evaluateWhere(e,t,n){let r=ce(e);if(r)return await Qn(this,r,e,t,n);let o=Zn(e,this.columnMap,this.columnTypes);return o?await es(this,o,t,n):await ts(this,e,t,n)}evaluateExpr(e,t,n){return B(this,e,t,n)}_executeSubquery(e,t,n){return ls(this,e,t,n)}_executeCTEBody(e,t){return Ae(this,e,t)}async materializeCTEs(e,t){return cs(this,e,t)}_executeOnInMemoryData(e,t){return Be(this,e,t)}_evaluateInMemoryExpr(e,t,n){return M(e,t,n)}hasWindowFunctions(e){return Yn(e)}computeWindowFunctions(e,t,n){return Ct(e,t,n,(r,o,i)=>this._evaluateInMemoryExpr(r,o,i))}_executeWindowFunctions(e,t,n,r){return Xn(this,e,t,n,r)}_partitionRows(e,t,n,r){return At(e,t,n,r)}_compareRowsByOrder(e,t,n,r,o){return ne(e,t,n,r,o)}hasAggregates(e){return Lt(e)}_executeGroupByAggregation(e,t,n,r){return as(this,e,t,n,r)}_hasAdvancedGroupBy(e){return _t(e)}_emptyAggregateResult(e){return is(e)}async executeAggregateQuery(e,t,n){let r=fe,o=[],i=[];for(let m of e.columns)if(m.type==="star")o.push({type:"COUNT",column:null,isStar:!0}),i.push("COUNT(*)");else if(m.expr.type==="call"&&r.includes(m.expr.name.toUpperCase())){let p=m.expr.name.toUpperCase(),d=m.expr.args[0];o.push({type:p,column:d?.type==="column"?d.name:null,isStar:d?.type==="star",sum:0,count:0,min:null,max:null,values:[]}),i.push(m.alias||z(m.expr))}else o.push({type:"FIRST",column:m.expr.type==="column"?m.expr.name:null,value:null}),i.push(m.alias||z(m.expr));let a=new Set;for(let m of o)m.column&&a.add(m.column.toLowerCase());e.where&&this.collectColumnsFromExpr(e.where,a);let l=e.limit?Math.min(e.limit,t):t,c=1e3,f=0;for(let m=0;m<l;m+=c){n&&n("Aggregating...",m,l);let p=Math.min(m+c,l),d=Array.from({length:p-m},(E,w)=>m+w);f+=d.length;let g={};for(let E of a){let w=this.columnMap[E.toLowerCase()];w!==void 0&&(g[E.toLowerCase()]=await this.readColumnData(w,d))}for(let E=0;E<d.length;E++)if(!(e.where&&!this.evaluateExpr(e.where,g,E))){for(let w of o)if(w.type==="COUNT")w.count++;else if(w.type==="FIRST"&&w.value===null&&w.column)w.value=g[w.column.toLowerCase()]?.[E];else if(w.column){let y=g[w.column.toLowerCase()]?.[E];y!=null&&!isNaN(y)&&(w.count++,(w.type==="SUM"||w.type==="AVG")&&(w.sum+=y),w.type==="MIN"&&(w.min=w.min===null?y:Math.min(w.min,y)),w.type==="MAX"&&(w.max=w.max===null?y:Math.max(w.max,y)))}}}let h=o.map(m=>{switch(m.type){case"COUNT":return m.count;case"SUM":return m.sum;case"AVG":return m.count>0?m.sum/m.count:null;case"MIN":return m.min;case"MAX":return m.max;case"FIRST":return m.value;default:return null}});if(e.having){let m={};if(i.forEach((p,d)=>{m[p.toLowerCase()]=[h[d]]}),!this._evaluateInMemoryExpr(e.having,m,0))return{columns:i,rows:[],total:0,aggregationStats:{scannedRows:f,totalRows:t}}}return{columns:i,rows:[h],total:1,aggregationStats:{scannedRows:f,totalRows:t,coveragePercent:t>0?(f/t*100).toFixed(2):"100.00",isPartialScan:f<t}}}async _executeSimpleAggregateOnIndices(e,t,n){let r=e.columns.map(l=>l.alias||z(l.expr||l)),o=new Set;for(let l of e.columns)l.expr?.args?.[0]?.type==="column"&&o.add((l.expr.args[0].name||l.expr.args[0].column).toLowerCase());let i={};for(let l of o){let c=this.columnMap[l];c!==void 0&&(i[l]=await this.readColumnData(c,t))}let a=e.columns.map(l=>{if(l.expr?.type==="call"){let c=l.expr.name.toUpperCase(),f=l.expr.args?.[0],h=f?.type==="star";if(c==="COUNT"&&h)return t.length;let m=(f?.name||f?.column)?.toLowerCase(),p=t.map((d,g)=>i[m]?.[g]);return Re(c,p)}return null});return{columns:r,rows:[a],total:1}}async _executeGroupByOnIndices(e,t,n){let r=new Set;for(let c of e.groupBy)r.add((c.column||c.name).toLowerCase());for(let c of e.columns)c.expr?.type==="column"&&r.add((c.expr.name||c.expr.column).toLowerCase()),c.expr?.args?.[0]?.type==="column"&&r.add((c.expr.args[0].name||c.expr.args[0].column).toLowerCase());let o={};for(let c of r){let f=this.columnMap[c];f!==void 0&&(o[c]=await this.readColumnData(f,t))}let i=new Map;for(let c=0;c<t.length;c++){let f=e.groupBy.map(h=>JSON.stringify(o[(h.column||h.name).toLowerCase()]?.[c])).join("|");i.has(f)||i.set(f,[]),i.get(f).push(c)}let a=e.columns.map(c=>c.alias||z(c.expr||c)),l=[];for(let[,c]of i){let f=e.columns.map(h=>{let m=h.expr||h;if(m.type==="call"&&fe.includes(m.name.toUpperCase())){let p=(m.args?.[0]?.name||m.args?.[0]?.column)?.toLowerCase(),d=m.args?.[0]?.type==="star";if(m.name.toUpperCase()==="COUNT"&&d)return c.length;let g=c.map(E=>o[p]?.[E]);return Re(m.name.toUpperCase(),g)}else if(m.type==="column")return o[(m.name||m.column).toLowerCase()]?.[c[0]];return null});l.push(f)}return{columns:a,rows:l,total:l.length}}exprToName(e){return z(e)}isSimpleCountStar(e){return vt(e)}async applyOrderBy(e,t,n){return St(this,e,t,n,gpuSorter)}async applyDistinct(e){return Tt(this,e,gpuSorter)}async*executeStream(e,t={}){let{chunkSize:n=1e3}=t,o=new J(e).tokenize(),a=new Y(o).parse();this.columnTypes.length===0&&(this.file._isRemote&&this.file.detectColumnTypes?this.columnTypes=await this.file.detectColumnTypes():this.file._columnTypes?this.columnTypes=this.file._columnTypes:this.columnTypes=Array(this.file.numColumns||0).fill("unknown"));let l=this.file._isRemote?await this.file.getRowCount(0):Number(this.file.getRowCount(0)),c=this.collectNeededColumns(a),f=a.limit||l,h=0;for(let m=0;m<l&&h<f;m+=n){let p=Math.min(n,f-h,l-m),d=Array.from({length:p},(y,b)=>m+b),g=[];for(let y of c){let b=this.columnMap[y.toLowerCase()];g.push(b!==void 0?await this.readColumnData(b,d):d.map(()=>null))}let E=d.map((y,b)=>c.map((I,R)=>g[R][b])),w=E;a.where&&(w=E.filter(y=>ue(a.where,c,y,rs))),w.length>0&&(yield{columns:c,rows:w},h+=w.length)}}_expandGroupBy(e){return Ot(e)}_powerSet(e){return xt(e)}_rank(e,t){return(void 0)(e,t)}_denseRank(e,t){return(void 0)(e,t)}_percentRank(e,t){return(void 0)(e,t)}_cumeDist(e,t){return(void 0)(e,t)}_getRowNumber(e){return(void 0)(e)}};var ke=class{constructor(e=opfsStorage){this.storage=e,this.sessionId=`join_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,this.basePath=`_join_temp/${this.sessionId}`,this.numPartitions=64,this.chunkSize=1e3,this.stats={leftRowsWritten:0,rightRowsWritten:0,resultRowsWritten:0,bytesWrittenToOPFS:0,bytesReadFromOPFS:0,partitionsUsed:new Set}}async*executeHashJoin(e,t,n,r,o={}){let{limit:i=1/0,projection:a=null,leftAlias:l="left",rightAlias:c="right",joinType:f="INNER",prePartitionedLeft:h=null}=o;try{let m;h?m=h:m=await this._partitionToOPFS(e,n,"left");let p=await this._partitionToOPFS(t,r,"right"),d=0,g=new Array(m.columns.length).fill(null),E=new Array(p.columns.length).fill(null),w=[...m.columns.map(A=>`${l}.${A}`),...p.columns.map(A=>`${c}.${A}`)],y=function*(A){A.length>0&&(yield{columns:w,rows:A.splice(0)})};if(f==="CROSS"){let A=[];for(let N of m.partitionsUsed){let T=await this._loadPartition("left",N,m.columns);for(let _ of p.partitionsUsed){let v=await this._loadPartition("right",_,p.columns);for(let x of T){for(let L of v){if(d>=i)break;A.push([...x,...L]),d++,A.length>=this.chunkSize&&(yield{columns:w,rows:A.splice(0)})}if(d>=i)break}if(d>=i)break}if(d>=i)break}A.length>0&&(yield{columns:w,rows:A});return}let b=m.columns.indexOf(n),I=p.columns.indexOf(r),R=f==="LEFT"||f==="FULL",C=f==="RIGHT"||f==="FULL",S=C?new Set:null,O=new Set([...m.partitionsUsed].filter(A=>p.partitionsUsed.has(A)));for(let A of O){if(d>=i)break;let N=await this._loadPartition("left",A,m.columns);if(N.length===0)continue;let T=new Map,_=R?new Set:null;for(let L=0;L<N.length;L++){let U=N[L],D=U[b];D!=null&&(T.has(D)||T.set(D,[]),T.get(D).push({row:U,index:L}))}let v=await this._loadPartition("right",A,p.columns),x=[];for(let L=0;L<v.length&&!(d>=i);L++){let U=v[L],D=U[I],q=T.get(D);if(q){S&&S.add(`${A}_${L}`);for(let{row:Ke,index:Se}of q){if(d>=i)break;_&&_.add(Se),x.push([...Ke,...U]),d++,x.length>=this.chunkSize&&(yield{columns:w,rows:x.splice(0)})}}}if(R&&_)for(let L=0;L<N.length&&!(d>=i);L++)_.has(L)||(x.push([...N[L],...E]),d++,x.length>=this.chunkSize&&(yield{columns:w,rows:x.splice(0)}));x.length>0&&(yield{columns:w,rows:x})}if(R)for(let A of m.partitionsUsed){if(d>=i)break;if(O.has(A))continue;let N=await this._loadPartition("left",A,m.columns),T=[];for(let _ of N){if(d>=i)break;T.push([..._,...E]),d++,T.length>=this.chunkSize&&(yield{columns:w,rows:T.splice(0)})}T.length>0&&(yield{columns:w,rows:T})}if(C)for(let A of p.partitionsUsed){if(d>=i)break;let N=await this._loadPartition("right",A,p.columns),T=[];for(let _=0;_<N.length&&!(d>=i);_++){let v=`${A}_${_}`;S.has(v)||(T.push([...g,...N[_]]),d++,T.length>=this.chunkSize&&(yield{columns:w,rows:T.splice(0)}))}T.length>0&&(yield{columns:w,rows:T})}}finally{await this.cleanup()}}async _partitionToOPFS(e,t,n,r=!1){let o=new Map,i=500,a=null,l=-1,c=0,f=new Set,h=r?new Set:null;for await(let m of e){if(!a&&(a=m.columns,l=a.indexOf(t),l===-1))throw new Error(`Join key column '${t}' not found in columns: ${a.join(", ")}`);for(let p of m.rows){let d=p[l],g=this._hashToPartition(d);f.add(g),r&&d!==null&&d!==void 0&&h.add(d),o.has(g)||o.set(g,[]),o.get(g).push(p),c++,o.get(g).length>=i&&(await this._appendToPartition(n,g,o.get(g)),o.set(g,[]))}}for(let[m,p]of o)p.length>0&&await this._appendToPartition(n,m,p);return n==="left"?this.stats.leftRowsWritten=c:this.stats.rightRowsWritten=c,{columns:a,totalRows:c,partitionsUsed:f,collectedKeys:h}}_hashToPartition(e){if(e==null)return 0;let t=String(e),n=0;for(let r=0;r<t.length;r++){let o=t.charCodeAt(r);n=(n<<5)-n+o,n=n&n}return Math.abs(n)%this.numPartitions}async _appendToPartition(e,t,n){let r=`${this.basePath}/${e}/partition_${String(t).padStart(3,"0")}.jsonl`,o=n.map(l=>JSON.stringify(l)).join(`
`)+`
`,i=new TextEncoder().encode(o),a=await this.storage.load(r);if(a){let l=new Uint8Array(a.length+i.length);l.set(a),l.set(i,a.length),await this.storage.save(r,l),this.stats.bytesWrittenToOPFS+=i.length}else await this.storage.save(r,i),this.stats.bytesWrittenToOPFS+=i.length;this.stats.partitionsUsed.add(t)}async _loadPartition(e,t,n){let r=`${this.basePath}/${e}/partition_${String(t).padStart(3,"0")}.jsonl`,o=await this.storage.load(r);return o?(this.stats.bytesReadFromOPFS+=o.length,new TextDecoder().decode(o).trim().split(`
`).filter(l=>l).map(l=>JSON.parse(l))):[]}getStats(){return{...this.stats,partitionsUsed:this.stats.partitionsUsed.size,bytesWrittenMB:(this.stats.bytesWrittenToOPFS/1024/1024).toFixed(2),bytesReadMB:(this.stats.bytesReadFromOPFS/1024/1024).toFixed(2)}}async cleanup(){try{await this.storage.deleteDir(this.basePath)}catch{}}};var Ft=class{constructor(e){this.name=e,this._ready=!1}async open(){return this._ready?this:(await F("db:open",{name:this.name}),this._ready=!0,this)}async _ensureOpen(){this._ready||await this.open()}async createTable(e,t,n=!1){return await this._ensureOpen(),F("db:createTable",{db:this.name,tableName:e,columns:t,ifNotExists:n})}async dropTable(e,t=!1){return await this._ensureOpen(),F("db:dropTable",{db:this.name,tableName:e,ifExists:t})}async insert(e,t){return await this._ensureOpen(),F("db:insert",{db:this.name,tableName:e,rows:t})}async flush(){return await this._ensureOpen(),F("db:flush",{db:this.name})}async delete(e,t=null){return await this._ensureOpen(),F("db:delete",{db:this.name,tableName:e,where:t})}async update(e,t,n=null){return await this._ensureOpen(),F("db:update",{db:this.name,tableName:e,updates:t,where:n})}async select(e,t={}){await this._ensureOpen();let n={...t};return delete n.where,F("db:select",{db:this.name,tableName:e,options:n,where:t.whereAST||null})}async exec(e){return await this._ensureOpen(),F("db:exec",{db:this.name,sql:e})}async getTable(e){return await this._ensureOpen(),F("db:getTable",{db:this.name,tableName:e})}async listTables(){return await this._ensureOpen(),F("db:listTables",{db:this.name})}async compact(){return await this._ensureOpen(),F("db:compact",{db:this.name})}async*scan(e,t={}){await this._ensureOpen();let n=await F("db:scanStart",{db:this.name,tableName:e,options:t});for(;;){let{batch:r,done:o}=await F("db:scanNext",{db:this.name,streamId:n});if(r.length>0&&(yield r),o)break}}async close(){await this._ensureOpen(),await this.flush()}async listVersions(e){return await this._ensureOpen(),F("db:listVersions",{db:this.name,tableName:e})}async selectAtVersion(e,t,n={}){await this._ensureOpen();let r={...n};return delete r.where,F("db:selectAtVersion",{db:this.name,tableName:e,version:t,options:r,where:n.whereAST||null})}async restoreToVersion(e,t){return await this._ensureOpen(),F("db:restoreTable",{db:this.name,tableName:e,version:t})}};var Ut=class{constructor(e="lanceql"){this.rootDir=e,this.root=null}async getRoot(){if(this.root)return this.root;if(typeof navigator>"u"||!navigator.storage?.getDirectory)throw new Error("OPFS not available. Requires modern browser with Origin Private File System support.");let e=await navigator.storage.getDirectory();return this.root=await e.getDirectoryHandle(this.rootDir,{create:!0}),this.root}async open(){return await this.getRoot(),this}async getDir(e){let t=await this.getRoot(),n=e.split("/").filter(o=>o),r=t;for(let o of n)r=await r.getDirectoryHandle(o,{create:!0});return r}async save(e,t){let n=e.split("/"),r=n.pop(),o=n.join("/"),a=await(o?await this.getDir(o):await this.getRoot()).getFileHandle(r,{create:!0});if(a.createSyncAccessHandle)try{let c=await a.createSyncAccessHandle();return c.truncate(0),c.write(t,{at:0}),c.flush(),c.close(),{path:e,size:t.byteLength}}catch{}let l=await a.createWritable();return await l.write(t),await l.close(),{path:e,size:t.byteLength}}async load(e){try{let t=e.split("/"),n=t.pop(),r=t.join("/"),l=await(await(await(r?await this.getDir(r):await this.getRoot()).getFileHandle(n)).getFile()).arrayBuffer();return new Uint8Array(l)}catch(t){if(t.name==="NotFoundError")return null;throw t}}async delete(e){try{let t=e.split("/"),n=t.pop(),r=t.join("/");return await(r?await this.getDir(r):await this.getRoot()).removeEntry(n),!0}catch(t){if(t.name==="NotFoundError")return!1;throw t}}async list(e=""){try{let t=e?await this.getDir(e):await this.getRoot(),n=[];for await(let[r,o]of t.entries())n.push({name:r,type:o.kind});return n}catch{return[]}}async exists(e){try{let t=e.split("/"),n=t.pop(),r=t.join("/");return await(r?await this.getDir(r):await this.getRoot()).getFileHandle(n),!0}catch{return!1}}async deleteDir(e){try{let t=e.split("/"),n=t.pop(),r=t.join("/");return await(r?await this.getDir(r):await this.getRoot()).removeEntry(n,{recursive:!0}),!0}catch{return!1}}async readRange(e,t,n){try{let r=e.split("/"),o=r.pop(),i=r.join("/"),h=await(await(await(i?await this.getDir(i):await this.getRoot()).getFileHandle(o)).getFile()).slice(t,t+n).arrayBuffer();return new Uint8Array(h)}catch(r){if(r.name==="NotFoundError")return null;throw r}}async getFileSize(e){try{let t=e.split("/"),n=t.pop(),r=t.join("/");return(await(await(r?await this.getDir(r):await this.getRoot()).getFileHandle(n)).getFile()).size}catch(t){if(t.name==="NotFoundError")return null;throw t}}async openFile(e){try{let t=e.split("/"),n=t.pop(),r=t.join("/"),i=await(r?await this.getDir(r):await this.getRoot()).getFileHandle(n);return new Mt(i)}catch(t){if(t.name==="NotFoundError")return null;throw t}}async isSupported(){try{return typeof navigator>"u"||!navigator.storage?.getDirectory?!1:(await navigator.storage.getDirectory(),!0)}catch{return!1}}async getStats(){try{let e=await this.getRoot(),t=0,n=0;async function r(o){for await(let[i,a]of o.entries())if(a.kind==="file"){let l=await a.getFile();t++,n+=l.size}else a.kind==="directory"&&await r(a)}return await r(e),{fileCount:t,totalSize:n}}catch{return{fileCount:0,totalSize:0}}}async listFiles(){try{let e=await this.getRoot(),t=[];async function n(r,o=""){for await(let[i,a]of r.entries())if(a.kind==="file"){let l=await a.getFile();t.push({name:o?`${o}/${i}`:i,size:l.size,lastModified:l.lastModified})}else a.kind==="directory"&&await n(a,o?`${o}/${i}`:i)}return await n(e),t}catch{return[]}}async clearAll(){try{let e=await this.getRoot(),t=0,n=[];for await(let[r,o]of e.entries())n.push({name:r,kind:o.kind});for(let r of n)await e.removeEntry(r.name,{recursive:r.kind==="directory"}),t++;return t}catch(e){return console.warn("Failed to clear OPFS:",e),0}}},Mt=class{constructor(e){this.fileHandle=e,this._file=null,this._size=null}async getFile(){return this._file||(this._file=await this.fileHandle.getFile(),this._size=this._file.size),this._file}async getSize(){return this._size===null&&await this.getFile(),this._size}async readRange(e,t){let o=await(await this.getFile()).slice(e,e+t).arrayBuffer();return new Uint8Array(o)}async readFromEnd(e){let t=await this.getSize();return this.readRange(t-e,e)}invalidate(){this._file=null,this._size=null}},Pt=new Ut;async function Bt(s,e){let t=e.from.name||e.from.table,n=e.from.alias||t;e.from.alias&&s.aliases.set(e.from.alias,t);let r=null,o=n,i=t,a=s.getTable(t);for(let l=0;l<e.joins.length;l++){let c=e.joins[l],f=c.table.name||c.table.table,h=c.alias||f;c.alias&&s.aliases.set(c.alias,f);let m=s.getTable(f),p={...e,joins:[c],limit:l===e.joins.length-1?e.limit:void 0,columns:l===e.joins.length-1?e.columns:[{type:"column",column:"*"}]};r===null?r=await xr(s,a,m,p,{leftAlias:o,rightAlias:h,leftTableName:i,rightTableName:f}):r=await kt(s,r,m,p,{leftAlias:o,rightAlias:h,leftTableName:i,rightTableName:f}),o=`${o}_${h}`,i=`(${i} JOIN ${f})`}return r}async function xr(s,e,t,n,r){let{leftAlias:o,rightAlias:i,leftTableName:a,rightTableName:l}=r,c=n.joins[0],f=c.type||"INNER",h=c.on;if(f!=="CROSS"&&(!h||h.type!=="binary"||h.op!=="="))throw new Error("JOIN ON condition must be an equality (e.g., table1.col1 = table2.col2)");let m,p,d,g,E;if(f==="CROSS")m=null,p=null,d=`SELECT * FROM ${a}`,g=`SELECT * FROM ${l}`;else{E=new ae().plan(n,r),m=E.join.leftKey,p=E.join.rightKey;let L=E.leftScan.columns,U=E.rightScan.columns,D=E.leftScan.filters,q=E.rightScan.filters,Ke=L.includes("*")?["*"]:[...new Set([m,...L])],Se="";D.length>0&&(Se=` WHERE ${D.map(qe=>k(qe)).join(" AND ")}`),d=`SELECT ${Ke.join(", ")} FROM ${a}${Se}`;let bs=U.includes("*")?["*"]:[...new Set([p,...U])],Kt="";q.length>0&&(Kt=` WHERE ${q.map(qe=>k(qe)).join(" AND ")}`),g=`SELECT ${bs.join(", ")} FROM ${l}${Kt}`}await Pt.open();let w=new ke(Pt),y=new $(e),b=new $(t),I=y.executeStream(d),R=await w._partitionToOPFS(I,m,"left",!0),C=g;if(R.collectedKeys&&R.collectedKeys.size>0&&R.collectedKeys.size<=1e4){let x=De(p,R.collectedKeys);C=$e(g,x)}let O=b.executeStream(C),A=[],N=null;try{for await(let x of w.executeHashJoin(null,O,m,p,{limit:n.limit||1/0,leftAlias:o,rightAlias:i,joinType:c.type||"INNER",prePartitionedLeft:R}))if(N||(N=x.columns),A.push(...x.rows),n.limit&&A.length>=n.limit)break}catch(x){throw console.error("[LanceDatabase] OPFS join failed:",x),x}let T=w.getStats();if(!N||A.length===0)return{columns:[],rows:[],total:0,opfsStats:T};let _=Dt(A,N,E.projection,o,i),v=n.limit?_.rows.slice(0,n.limit):_.rows;return{columns:_.columns,rows:v,total:v.length,opfsStats:T}}async function kt(s,e,t,n,r){let{leftAlias:o,rightAlias:i,leftTableName:a,rightTableName:l}=r,c=n.joins[0],f=c.type||"INNER",h=c.on;if(f!=="CROSS"&&(!h||h.type!=="binary"||h.op!=="="))throw new Error("JOIN ON condition must be an equality (e.g., table1.col1 = table2.col2)");let m,p;if(f==="CROSS")m=null,p=null;else{let A=h.left,N=h.right,T=A.column,_=N.column;new Set(e.columns.map(x=>{let L=x.split(".");return L[L.length-1]})).has(T)?(m=T,p=_):(m=_,p=T)}let d=`SELECT * FROM ${l}`,g=1e3;if(m&&f!=="CROSS"){let A=Ce(e.columns,m);if(A!==-1){let N=new Set;for(let T of e.rows){let _=T[A];_!=null&&N.add(_)}if(N.size>0&&N.size<=g){let T=De(p,N);d=$e(d,T)}}}let w=await new $(t).execute(new Y(new J(d).tokenize()).parse()),y=m?Ce(e.columns,m):-1,b=p?Ce(w.columns,p):-1,I=[...e.columns,...w.columns.map(A=>`${i}.${A}`)],R=[],C=new Array(w.columns.length).fill(null),S=new Array(e.columns.length).fill(null);if(f==="CROSS")for(let A of e.rows){for(let N of w.rows)if(R.push([...A,...N]),n.limit&&R.length>=n.limit)break;if(n.limit&&R.length>=n.limit)break}else{let A=new Map;for(let T of w.rows){let _=T[b];_!=null&&(A.has(_)||A.set(_,[]),A.get(_).push(T))}let N=f==="FULL"||f==="RIGHT"?new Set:null;for(let T of e.rows){let _=T[y],v=A.get(_)||[];if(v.length>0){for(let x of v)if(R.push([...T,...x]),N&&N.add(w.rows.indexOf(x)),n.limit&&R.length>=n.limit)break}else(f==="LEFT"||f==="FULL")&&R.push([...T,...C]);if(n.limit&&R.length>=n.limit)break}if((f==="RIGHT"||f==="FULL")&&N)for(let T=0;T<w.rows.length&&!(!N.has(T)&&(R.push([...S,...w.rows[T]]),n.limit&&R.length>=n.limit));T++);}let O=n.limit?R.slice(0,n.limit):R;return{columns:I,rows:O,total:O.length}}function Ce(s,e){let t=s.indexOf(e);if(t!==-1)return t;for(let n=0;n<s.length;n++){let o=s[n].split(".");if(o[o.length-1]===e)return n}return-1}function k(s){if(!s)return"";if(s.type==="binary"){let e=k(s.left),t=k(s.right);return`${e} ${s.op} ${t}`}else{if(s.type==="column")return s.column;if(s.type==="literal")return typeof s.value=="string"?`'${s.value.replace(/'/g,"''")}'`:s.value===null?"NULL":String(s.value);if(s.type==="call"){let e=(s.args||[]).map(t=>k(t)).join(", ");return`${s.name}(${e})`}else if(s.type==="in"){let e=k(s.expr),t=s.values.map(n=>k(n)).join(", ");return`${e} IN (${t})`}else if(s.type==="between"){let e=k(s.expr),t=k(s.low),n=k(s.high);return`${e} BETWEEN ${t} AND ${n}`}else if(s.type==="like"){let e=k(s.expr),t=k(s.pattern);return`${e} LIKE ${t}`}else if(s.type==="unary"){let e=k(s.operand);return s.op==="NOT"?`NOT ${e}`:`${s.op}${e}`}}return""}function Dt(s,e,t,n,r){if(t.includes("*"))return{columns:e,rows:s};let o=[],i=[];for(let l of t){if(l==="*")continue;let c=-1,f=l.column;if(l.table){let h=`${l.table}.${l.column}`;c=e.indexOf(h),f=h}c===-1&&(c=e.findIndex(h=>h===l.column||h.endsWith(`.${l.column}`)),c!==-1&&(f=e[c])),c!==-1&&(o.push(l.alias||f),i.push(c))}let a=s.map(l=>i.map(c=>l[c]));return{columns:o,rows:a}}function De(s,e){let t=Array.from(e).map(n=>typeof n=="string"?`'${n.replace(/'/g,"''")}'`:n===null?"NULL":String(n)).join(", ");return`${s} IN (${t})`}function $e(s,e){return s.toUpperCase().includes("WHERE")?s.replace(/WHERE\s+/i,`WHERE ${e} AND `):s.replace(/FROM\s+(\w+)(\s+\w+)?/i,n=>`${n} WHERE ${e}`)}var Ve=class{constructor(e,t){this.name=e,this.schema=t,this.columns=t.map(n=>n.name),this.rows=[],this._columnIndex=new Map,this.columns.forEach((n,r)=>{this._columnIndex.set(n.toLowerCase(),r)})}toInMemoryData(){return{columns:this.columns,rows:this.rows}}};function us(s,e){let t=(e.table||e.name||"").toLowerCase();if(!t)throw new Error("CREATE TABLE requires a table name");if(s.memoryTables.has(t)||s.tables.has(t)){if(e.ifNotExists)return{success:!0,existed:!0,table:t};throw new Error(`Table '${t}' already exists`)}let n=(e.columns||[]).map(o=>({name:o.name,dataType:o.dataType||o.type||"TEXT",primaryKey:o.primaryKey||!1}));if(n.length===0)throw new Error("CREATE TABLE requires at least one column");let r=new Ve(t,n);return s.memoryTables.set(t,r),{success:!0,table:t,columns:n.map(o=>o.name)}}function fs(s,e){let t=(e.table||e.name||"").toLowerCase();if(!s.memoryTables.has(t)){if(e.ifExists)return{success:!0,existed:!1,table:t};throw new Error(`Memory table '${t}' not found`)}return s.memoryTables.delete(t),{success:!0,table:t}}function hs(s,e){let t=(e.table||"").toLowerCase(),n=s.memoryTables.get(t);if(!n)throw new Error(`Memory table '${t}' not found. Use CREATE TABLE first.`);let r=e.columns||n.columns,o=0;for(let i of e.rows||e.values||[]){let a=new Array(n.columns.length).fill(null);r.forEach((l,c)=>{let f=n._columnIndex.get((typeof l=="string"?l:l.name||l).toLowerCase());if(f!==void 0&&c<i.length){let h=i[c];a[f]=h?.value!==void 0?h.value:h}}),n.rows.push(a),o++}return{success:!0,inserted:o,total:n.rows.length}}function ms(s,e){let t=(e.table||"").toLowerCase(),n=s.memoryTables.get(t);if(!n)throw new Error(`Memory table '${t}' not found`);let r={};n.columns.forEach((a,l)=>{r[a.toLowerCase()]=n.rows.map(c=>c[l])});let o=new $({columnNames:n.columns}),i=0;for(let a=0;a<n.rows.length;a++)if(!e.where||o._evaluateInMemoryExpr(e.where,r,a)){for(let c of e.assignments||e.set||[]){let f=(c.column||c.name||"").toLowerCase(),h=n._columnIndex.get(f);if(h!==void 0){let m=c.value;n.rows[a][h]=m?.value!==void 0?m.value:m}}i++}return{success:!0,updated:i}}function ps(s,e){let t=(e.table||"").toLowerCase(),n=s.memoryTables.get(t);if(!n)throw new Error(`Memory table '${t}' not found`);let r=n.rows.length;if(e.where){let o={};n.columns.forEach((a,l)=>{o[a.toLowerCase()]=n.rows.map(c=>c[l])});let i=new $({columnNames:n.columns});n.rows=n.rows.filter((a,l)=>!i._evaluateInMemoryExpr(e.where,o,l))}else n.rows=[];return{success:!0,deleted:r-n.rows.length,remaining:n.rows.length}}function Gt(s,e){let t=je(e),n=s._planCache.get(t);return n?(n.hits++,n.lastUsed=Date.now(),n.plan):null}function zt(s,e,t){let n=je(e);if(s._planCache.size>=s._planCacheMaxSize){let r=null,o=1/0;for(let[i,a]of s._planCache)a.lastUsed<o&&(o=a.lastUsed,r=i);r&&s._planCache.delete(r)}s._planCache.set(n,{plan:t,hits:0,lastUsed:Date.now(),created:Date.now()})}function je(s){return s.trim().replace(/\s+/g," ").toLowerCase()}function gs(s){let e=0;for(let t of s._planCache.values())e+=t.hits;return{size:s._planCache.size,maxSize:s._planCacheMaxSize,totalHits:e}}function he(s){if(!s)return s;s.left&&(s.left=he(s.left)),s.right&&(s.right=he(s.right)),s.operand&&(s.operand=he(s.operand)),s.args&&(s.args=s.args.map(t=>he(t)));let e=s.op||s.operator;if(s.type==="binary"&&We(s.left)&&We(s.right))return vr(s);if(s.type==="binary"&&e==="AND"){if(Ge(s.right))return s.left;if(Ge(s.left))return s.right;if(ze(s.left)||ze(s.right))return{type:"literal",value:!1}}if(s.type==="binary"&&e==="OR"){if(ze(s.right))return s.left;if(ze(s.left))return s.right;if(Ge(s.left)||Ge(s.right))return{type:"literal",value:!0}}return s}function We(s){return s&&["literal","number","string"].includes(s.type)}function Ge(s){return s?.type==="literal"&&s.value===!0}function ze(s){return s?.type==="literal"&&s.value===!1}function vr(s){let e=me(s.left),t=me(s.right),n=s.op||s.operator,r;switch(n){case"+":r=e+t;break;case"-":r=e-t;break;case"*":r=e*t;break;case"/":r=t!==0?e/t:null;break;case"%":r=e%t;break;case"=":case"==":r=e===t;break;case"!=":case"<>":r=e!==t;break;case"<":r=e<t;break;case">":r=e>t;break;case"<=":r=e<=t;break;case">=":r=e>=t;break;default:return s}return{type:"literal",value:r}}function me(s){return s.type==="number"||s.type==="string"||s.type==="literal"?s.value:null}function Wt(s){let e=[];return Vt(s,e),e}function Vt(s,e){if(!s)return;let t=s.op||s.operator;if(s.type==="binary"&&t==="AND"){Vt(s.left,e),Vt(s.right,e);return}let n=t==="=="?"=":t;if([">","<",">=","<=","=","!=","<>"].includes(n)&&(ds(s.left)&&We(s.right)?e.push({column:$t(s.left),operator:n,value:me(s.right)}):We(s.left)&&ds(s.right)&&e.push({column:$t(s.right),operator:Fr(n),value:me(s.left)})),s.type==="between"&&s.expr){let r=$t(s.expr);r&&s.low&&s.high&&(e.push({column:r,operator:">=",value:me(s.low)}),e.push({column:r,operator:"<=",value:me(s.high)}))}}function Fr(s){return{">":"<","<":">",">=":"<=","<=":">="}[s]||s}function ds(s){return s&&(s.type==="column"||s.type==="identifier")}function $t(s){return s.type==="column"?s.name||s.column:s.type==="identifier"?s.name||s.value:null}function ws(s,e){for(let t of e){let n=s[t.column];if(!n)continue;let{min:r,max:o,nullCount:i,rowCount:a}=n;if(i===a)return!0;switch(t.operator){case">":if(o<=t.value)return!0;break;case">=":if(o<t.value)return!0;break;case"<":if(r>=t.value)return!0;break;case"<=":if(r>t.value)return!0;break;case"=":if(t.value<r||t.value>o)return!0;break;case"!=":case"<>":if(r===o&&r===t.value)return!0;break}}return!1}function jt(s,e){let t={type:e.type,tables:[],predicates:[],optimizations:[]};if(e.from&&t.tables.push({name:e.from.name||e.from.table,alias:e.from.alias}),e.joins)for(let n of e.joins)t.tables.push({name:n.table?.name||n.table?.table,alias:n.table?.alias,joinType:n.type});return e.where&&(t.predicates=Wt(e.where)),e.where&&t.optimizations.push("PREDICATE_PUSHDOWN"),e.groupBy&&t.optimizations.push("AGGREGATE"),e.orderBy&&t.optimizations.push("SORT"),e.limit&&t.optimizations.push("LIMIT_PUSHDOWN"),{columns:["Plan"],rows:[[JSON.stringify(t,null,2)]],total:1}}var He=class{constructor(){this.tables=new Map,this.aliases=new Map,this._planCache=new Map,this._planCacheMaxSize=100,this.memoryTables=new Map}register(e,t){this.tables.set(e,t)}async registerRemote(e,t,n={}){let r=window.lanceql||globalThis.lanceql;if(!r)throw new Error("LanceQL WASM module not loaded. Call LanceQL.load() first.");let o=await r.openDataset(t,n);return this.register(e,o),o}getTable(e){let t=this.aliases.get(e)||e,n=this.tables.get(t);if(!n)throw new Error(`Table '${e}' not found. Did you forget to register it?`);return n}async executeSQL(e){let t=Gt(this,e),n;if(t)n=t;else{let o=new J(e).tokenize();n=new Y(o).parse(),n.type!=="EXPLAIN"&&zt(this,e,n)}if(n.type==="EXPLAIN")return jt(this,n.statement);if(n.type==="CREATE_TABLE")return us(this,n);if(n.type==="DROP_TABLE")return fs(this,n);if(n.type==="INSERT")return hs(this,n);if(n.type==="UPDATE")return ms(this,n);if(n.type==="DELETE")return ps(this,n);if(n.type==="SET_OPERATION")return this._executeSetOperation(n);if(n.type!=="SELECT")throw new Error("Only SELECT queries are supported in LanceDatabase");return n.ctes&&n.ctes.length>0?this._executeWithCTEs(n):!n.joins||n.joins.length===0?this._executeSingleTable(n):Bt(this,n)}async _executeWithCTEs(e){let t=new $({columnNames:[]});t.setDatabase(this),await t.materializeCTEs(e.ctes,this);let n=e.from?.name?.toLowerCase()||e.from?.table?.toLowerCase();return n&&t._cteResults.has(n)?t._executeOnInMemoryData(e,t._cteResults.get(n)):!e.joins||e.joins.length===0?this._executeSingleTable(e):Bt(this,e)}async _executeSetOperation(e){let t=await this.executeSQL(this._astToSQL(e.left)),n=await this.executeSQL(this._astToSQL(e.right));if(t.columns.length!==n.columns.length)throw new Error("SET operations require same number of columns");let r=a=>JSON.stringify(a),o;switch(e.operator){case"UNION":if(o=[...t.rows,...n.rows],!e.all){let c=new Set;o=o.filter(f=>{let h=r(f);return c.has(h)?!1:(c.add(h),!0)})}break;case"INTERSECT":let a=new Set(n.rows.map(r));if(o=t.rows.filter(c=>a.has(r(c))),!e.all){let c=new Set;o=o.filter(f=>{let h=r(f);return c.has(h)?!1:(c.add(h),!0)})}break;case"EXCEPT":let l=new Set(n.rows.map(r));if(o=t.rows.filter(c=>!l.has(r(c))),!e.all){let c=new Set;o=o.filter(f=>{let h=r(f);return c.has(h)?!1:(c.add(h),!0)})}break;default:throw new Error(`Unknown SET operator: ${e.operator}`)}if(e.orderBy&&e.orderBy.length>0){let a={};t.columns.forEach((l,c)=>{a[l.toLowerCase()]=c}),o.sort((l,c)=>{for(let f of e.orderBy){let h=a[f.column.toLowerCase()];if(h===void 0)continue;let m=l[h],p=c[h],d=f.direction==="DESC"?-1:1;if(!(m==null&&p==null)){if(m==null)return 1*d;if(p==null||m<p)return-1*d;if(m>p)return 1*d}}return 0})}let i=e.offset||0;return i>0&&(o=o.slice(i)),e.limit&&(o=o.slice(0,e.limit)),{columns:t.columns,rows:o,total:o.length}}_astToSQL(e){if(e.type==="SET_OPERATION"){let n=this._astToSQL(e.left),r=this._astToSQL(e.right),o=e.operator+(e.all?" ALL":"");return`(${n}) ${o} (${r})`}let t=e.distinct?"SELECT DISTINCT ":"SELECT ";if(t+=e.columns.map(n=>{if(n.expr?.type==="star")return"*";let r=this._exprToSQL(n.expr);return n.alias?`${r} AS ${n.alias}`:r}).join(", "),e.from){let n=e.from.name||e.from.table;t+=` FROM ${n}`,e.from.alias&&(t+=` AS ${e.from.alias}`)}if(e.joins)for(let n of e.joins){let r=n.table?.name||n.table?.table;t+=` ${n.type} ${r}`,n.alias&&(t+=` AS ${n.alias}`),n.on&&(t+=` ON ${this._exprToSQL(n.on)}`)}return e.where&&(t+=` WHERE ${this._exprToSQL(e.where)}`),e.groupBy?.length&&(t+=` GROUP BY ${e.groupBy.join(", ")}`),e.having&&(t+=` HAVING ${this._exprToSQL(e.having)}`),e.orderBy?.length&&(t+=` ORDER BY ${e.orderBy.map(n=>`${n.column} ${n.direction||"ASC"}`).join(", ")}`),e.limit&&(t+=` LIMIT ${e.limit}`),e.offset&&(t+=` OFFSET ${e.offset}`),t}_exprToSQL(e){if(!e)return"";switch(e.type){case"literal":return e.value===null?"NULL":typeof e.value=="string"?`'${e.value.replace(/'/g,"''")}'`:String(e.value);case"column":return e.table?`${e.table}.${e.column}`:e.column;case"star":return"*";case"binary":return`(${this._exprToSQL(e.left)} ${e.operator} ${this._exprToSQL(e.right)})`;case"unary":return`(${e.operator} ${this._exprToSQL(e.operand)})`;case"call":let t=e.args.map(r=>this._exprToSQL(r)).join(", ");return`${e.name}(${e.distinct?"DISTINCT ":""}${t})`;case"in":let n=e.values.map(r=>this._exprToSQL(r)).join(", ");return`${this._exprToSQL(e.expr)} IN (${n})`;case"between":return`${this._exprToSQL(e.expr)} BETWEEN ${this._exprToSQL(e.low)} AND ${this._exprToSQL(e.high)}`;case"like":return`${this._exprToSQL(e.expr)} LIKE ${this._exprToSQL(e.pattern)}`;default:return""}}async _executeSingleTable(e){if(!e.from)throw new Error("FROM clause required");let t=e.from.name||e.from.table;if(!t&&e.from.url)throw new Error("Single-table queries must use registered table names, not URLs");let n=t.toLowerCase();if(this.memoryTables.has(n)){let i=this.memoryTables.get(n);return new $({columnNames:i.columns})._executeOnInMemoryData(e,i.toInMemoryData())}let r=this.getTable(t);return new $(r).execute(e)}_extractColumnFromExpr(e,t){if(e.type==="column")return e.table&&e.table!==t?null:e.column;throw new Error(`Invalid join condition expression: ${JSON.stringify(e)}`)}_getColumnsForTable(e,t){let n=[];for(let r of e){if(r.type==="star")return["*"];if(r.type==="expr"&&r.expr.type==="column"){let o=r.expr;(!o.table||o.table===t)&&n.push(o.column)}}return n.length>0?n:["*"]}clearPlanCache(){this._planCache.clear()}getPlanCacheStats(){return gs(this)}_normalizeSQL(e){return je(e)}_getCachedPlan(e){return Gt(this,e)}_setCachedPlan(e,t){return zt(this,e,t)}_clearPlanCache(){this._planCache.clear()}_explainQuery(e){return jt(this,e)}_optimizeExpr(e){return he(e)}_extractRangePredicates(e){return Wt(e)}_canPruneFragment(e,t){return ws(e,t)}_findColumnIndex(e,t){return Ce(e,t)}_filterToSQL(e){return k(e)}_applyProjection(e,t,n,r,o){return Dt(e,t,n,r,o)}_buildInClause(e,t){return De(e,t)}_hashJoinWithInMemoryLeft(e,t,n,r){return kt(this,e,t,n,r)}_appendWhereClause(e,t){return $e(e,t)}};var Mr=new TextEncoder,hi=new TextDecoder,P,Te,X=0,pe=0,ys=()=>!X||!pe?null:new Uint8Array(Te.buffer,X,pe),Es=s=>X&&s<=pe?!0:(X&&P.free&&P.free(X,pe),pe=Math.max(s+1024,4096),X=P.alloc(pe),X!==0),Pr=s=>{if(s instanceof Uint8Array)return Es(s.length)?(ys().set(s),[X,s.length]):[s];if(typeof s!="string")return[s];let e=Mr.encode(s);return Es(e.length)?(ys().set(e),[X,e.length]):[s]};var Br=s=>({getVersion(){let e=P.getVersion(),t=e>>16&255,n=e>>8&255,r=e&255;return`${t}.${n}.${r}`},open(e){return new ge(s,e)},async openUrl(e){return await Q().init(),await ie.open(s,e)},async openDataset(e,t={}){return await Q().init(),await Ie.open(s,e,t)},parseFooter(e){let t=new Uint8Array(e),n=P.alloc(t.length);if(!n)return null;try{new Uint8Array(Te.buffer).set(t,n);let r=P.parseFooterGetColumns(n,t.length),o=P.parseFooterGetMajorVersion(n,t.length),i=P.parseFooterGetMinorVersion(n,t.length);return r===0&&o===0?null:{numColumns:r,majorVersion:o,minorVersion:i}}finally{P.free(n,t.length)}},isValidLanceFile(e){let t=new Uint8Array(e),n=P.alloc(t.length);if(!n)return!1;try{return new Uint8Array(Te.buffer).set(t,n),P.isValidLanceFile(n,t.length)===1}finally{P.free(n,t.length)}},createDatabase(){return typeof window<"u"?window.lanceql=s:typeof globalThis<"u"&&(globalThis.lanceql=s),new He}}),Ht=class{static async load(e="./lanceql.wasm"){let n=await(await fetch(e)).arrayBuffer();P=(await WebAssembly.instantiate(n,{env:{opfs_open:(a,l)=>0,opfs_read:(a,l,c,f)=>0,opfs_size:a=>0n,opfs_close:a=>{},js_log:(a,l)=>{}}})).instance.exports,Te=P.memory;let o=null,i=new Proxy({},{get(a,l){return o||(o=Br(i)),l in o?o[l]:l==="memory"?Te:l==="raw"||l==="wasm"?P:typeof P[l]=="function"?(...c)=>P[l](...c.flatMap(Pr)):P[l]}});return i}};export{Ht as LanceQL,Ft as LocalDatabase,Ie as RemoteLanceDataset,Oe as TableRef,xe as Vault,Yt as default,Yt as vault};
//# sourceMappingURL=lanceql.esm.js.map
