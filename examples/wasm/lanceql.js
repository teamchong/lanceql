var rs=Object.defineProperty;var Wr=(r,e,t)=>e in r?rs(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var O=(r,e)=>()=>(r&&(e=r(r=0)),e);var Ee=(r,e)=>{for(var t in e)rs(r,t,{get:e[t],enumerable:!0})};var X=(r,e,t)=>Wr(r,typeof e!="symbol"?e+"":e,t);var _e,di,Wt=O(()=>{_e=class{constructor(e="lanceql-cache",t=1){this.dbName=e,this.version=t,this.db=null}async open(){return this.db?this.db:new Promise((e,t)=>{let n=indexedDB.open(this.dbName,this.version);n.onerror=()=>t(n.error),n.onsuccess=()=>{this.db=n.result,e(this.db)},n.onupgradeneeded=s=>{let o=s.target.result;o.objectStoreNames.contains("datasets")||o.createObjectStore("datasets",{keyPath:"url"}).createIndex("timestamp","timestamp")}})}async get(e){try{let t=await this.open();return new Promise(n=>{let i=t.transaction("datasets","readonly").objectStore("datasets").get(e);i.onsuccess=()=>n(i.result||null),i.onerror=()=>n(null)})}catch(t){return console.warn("[MetadataCache] Get failed:",t),null}}async set(e,t){try{let n=await this.open();return new Promise((s,o)=>{let a=n.transaction("datasets","readwrite").objectStore("datasets"),l={url:e,timestamp:Date.now(),...t},c=a.put(l);c.onsuccess=()=>s(),c.onerror=()=>o(c.error)})}catch(n){console.warn("[MetadataCache] Set failed:",n)}}async delete(e){try{let t=await this.open();return new Promise(n=>{let s=t.transaction("datasets","readwrite");s.objectStore("datasets").delete(e),s.oncomplete=()=>n()})}catch(t){console.warn("[MetadataCache] Delete failed:",t)}}async clear(){try{let e=await this.open();return new Promise(t=>{let n=e.transaction("datasets","readwrite");n.objectStore("datasets").clear(),n.oncomplete=()=>t()})}catch(e){console.warn("[MetadataCache] Clear failed:",e)}}},di=new _e});var ie,ot=O(()=>{ie=class{constructor(e={}){this.maxSize=e.maxSize??50*1024*1024,this.currentSize=0,this.cache=new Map,this._head=null,this._tail=null}get(e){let t=this.cache.get(e);if(t)return this._moveToHead(t),t.data}delete(e){let t=this.cache.get(e);return t?(this._removeNode(t),this.cache.delete(e),this.currentSize-=t.size,!0):!1}set(e,t,n=null){return this.put(e,t,n)}put(e,t,n=null){let s=this.cache.get(e);s&&(this._removeNode(s),this.currentSize-=s.size,this.cache.delete(e));let o=n;for(o===null&&(t==null?o=0:t.byteLength!==void 0?o=t.byteLength:typeof t=="string"?o=t.length*2:typeof t=="object"?o=JSON.stringify(t).length*2:o=8);this.currentSize+o>this.maxSize&&this._tail;)this._evictTail();if(o>this.maxSize)return;let i={key:e,data:t,size:o,prev:null,next:null};this._addToHead(i),this.cache.set(e,i),this.currentSize+=o}_addToHead(e){e.prev=null,e.next=this._head,this._head&&(this._head.prev=e),this._head=e,this._tail||(this._tail=e)}_removeNode(e){e.prev?e.prev.next=e.next:this._head=e.next,e.next?e.next.prev=e.prev:this._tail=e.prev,e.prev=null,e.next=null}_moveToHead(e){e!==this._head&&(this._removeNode(e),this._addToHead(e))}_evictTail(){if(!this._tail)return;let e=this._tail;this._removeNode(e),this.cache.delete(e.key),this.currentSize-=e.size}clear(){this.cache.clear(),this._head=null,this._tail=null,this.currentSize=0}stats(){return{entries:this.cache.size,currentSize:this.currentSize,maxSize:this.maxSize,utilization:(this.currentSize/this.maxSize*100).toFixed(1)+"%"}}}});function ae(){return qt||(qt=new it),qt}var it,qt,at=O(()=>{it=class{constructor(e=null,t={}){this.storage=e,this.cacheDir=t.cacheDir||"_cache",this.maxFileSize=t.maxFileSize||10*1024*1024,this.maxCacheSize=t.maxCacheSize||500*1024*1024,this.enabled=t.enabled??!0,this._stats={hits:0,misses:0,bytesFromCache:0,bytesFromNetwork:0},this._metaCache=new Map,this._metaCacheOrder=[],this.maxMetaCacheEntries=t.maxMetaCacheEntries||100}_setMetaCache(e,t){let n=this._metaCacheOrder.indexOf(e);for(n!==-1&&this._metaCacheOrder.splice(n,1);this._metaCacheOrder.length>=this.maxMetaCacheEntries;){let s=this._metaCacheOrder.shift();this._metaCache.delete(s)}this._metaCache.set(e,t),this._metaCacheOrder.push(e)}async init(){this.storage||(this.storage=new OPFSStorage,await this.storage.open())}_getCacheKey(e){let t=0;for(let n=0;n<e.length;n++){let s=e.charCodeAt(n);t=(t<<5)-t+s,t=t&t}return Math.abs(t).toString(36)}_getCachePath(e,t=""){let n=this._getCacheKey(e);return`${this.cacheDir}/${n}${t}`}async isCached(e){if(!this.enabled)return{cached:!1};try{await this.init();let t=this._getCachePath(e,"/meta.json"),n=await this.storage.load(t);return n?{cached:!0,meta:JSON.parse(new TextDecoder().decode(n))}:{cached:!1}}catch{return{cached:!1}}}async getFile(e,t=null){if(!this.enabled)return this._fetchFile(e);await this.init();let{cached:n,meta:s}=await this.isCached(e);if(n&&s.fullFile){let i=this._getCachePath(e,"/data.lance"),a=await this.storage.load(i);if(a)return this._stats.hits++,this._stats.bytesFromCache+=a.byteLength,console.log(`[HotTierCache] HIT: ${e} (${(a.byteLength/1024).toFixed(1)} KB)`),a}this._stats.misses++;let o=await this._fetchFile(e);return this._stats.bytesFromNetwork+=o.byteLength,o.byteLength<=this.maxFileSize&&await this._cacheFile(e,o),o}async getRange(e,t,n,s=null){if(!this.enabled)return this._fetchRange(e,t,n);let o=this._metaCache.get(e);if(o?.fullFileData){let a=o.fullFileData;if(a.byteLength>n)return this._stats.hits++,this._stats.bytesFromCache+=n-t+1,a.slice(t,n+1).buffer}if(await this.init(),!o){let{cached:a,meta:l}=await this.isCached(e);if(a&&l.fullFile){let c=this._getCachePath(e,"/data.lance"),u=await this.storage.load(c);if(u&&u.byteLength>n)return this._setMetaCache(e,{meta:l,fullFileData:u}),this._stats.hits++,this._stats.bytesFromCache+=n-t+1,u.slice(t,n+1).buffer}this._setMetaCache(e,{meta:a?l:null,fullFileData:null})}this._stats.misses++;let i=await this._fetchRange(e,t,n);return this._stats.bytesFromNetwork+=i.byteLength,i}async prefetch(e,t=null){await this.init();let{cached:n,meta:s}=await this.isCached(e);if(n&&s.fullFile){console.log(`[HotTierCache] Already cached: ${e}`);return}console.log(`[HotTierCache] Prefetching: ${e}`);let o=await this._fetchFile(e,t);await this._cacheFile(e,o),console.log(`[HotTierCache] Cached: ${e} (${(o.byteLength/1024/1024).toFixed(2)} MB)`)}async evict(e){await this.init();let t=this._getCachePath(e);await this.storage.delete(t),console.log(`[HotTierCache] Evicted: ${e}`)}async clear(){await this.init(),await this.storage.delete(this.cacheDir),this._stats={hits:0,misses:0,bytesFromCache:0,bytesFromNetwork:0},console.log("[HotTierCache] Cleared all cache")}getStats(){let e=this._stats.hits+this._stats.misses>0?(this._stats.hits/(this._stats.hits+this._stats.misses)*100).toFixed(1):0;return{...this._stats,hitRate:`${e}%`,bytesFromCacheMB:(this._stats.bytesFromCache/1024/1024).toFixed(2),bytesFromNetworkMB:(this._stats.bytesFromNetwork/1024/1024).toFixed(2)}}async _fetchFile(e,t=null){let n=await fetch(e);if(!n.ok)throw new Error(`HTTP error: ${n.status}`);if(t&&n.headers.get("content-length")){let o=parseInt(n.headers.get("content-length")),i=n.body.getReader(),a=[],l=0;for(;;){let{done:f,value:h}=await i.read();if(f)break;a.push(h),l+=h.length,t(l,o)}let c=new Uint8Array(l),u=0;for(let f of a)c.set(f,u),u+=f.length;return c}let s=await n.arrayBuffer();return new Uint8Array(s)}async _fetchRange(e,t,n){let s=await fetch(e,{headers:{Range:`bytes=${t}-${n}`}});if(!s.ok&&s.status!==206)throw new Error(`HTTP error: ${s.status}`);return s.arrayBuffer()}async _cacheFile(e,t){let n=this._getCachePath(e,"/meta.json"),s=this._getCachePath(e,"/data.lance"),o={url:e,size:t.byteLength,cachedAt:Date.now(),fullFile:!0,ranges:null};await this.storage.save(n,new TextEncoder().encode(JSON.stringify(o))),await this.storage.save(s,t)}async _cacheRange(e,t,n,s,o){let i=this._getCachePath(e,"/meta.json"),a=this._getCachePath(e,`/ranges/${t}-${n}`),l,{cached:c,meta:u}=await this.isCached(e);c?(l=u,l.ranges=l.ranges||[]):l={url:e,size:o,cachedAt:Date.now(),fullFile:!1,ranges:[]},l.ranges.push({start:t,end:n,cachedAt:Date.now()}),l.ranges=this._mergeRanges(l.ranges),await this.storage.save(i,new TextEncoder().encode(JSON.stringify(l))),await this.storage.save(a,s)}_mergeRanges(e){if(e.length<=1)return e;e.sort((n,s)=>n.start-s.start);let t=[e[0]];for(let n=1;n<e.length;n++){let s=t[t.length-1],o=e[n];o.start<=s.end+1?s.end=Math.max(s.end,o.end):t.push(o)}return t}},qt=null});function q(){return jt||(jt=new lt),jt}var lt,jt,le=O(()=>{lt=class{constructor(){this.device=null,this.pipeline=null,this.available=!1,this._initPromise=null}async init(){return this._initPromise?this._initPromise:(this._initPromise=this._doInit(),this._initPromise)}async _doInit(){if(!navigator.gpu)return console.log("[WebGPU] Not available in this browser"),!1;try{let e=await navigator.gpu.requestAdapter();return e?(this.device=await e.requestDevice(),this._createPipeline(),this.available=!0,console.log("[WebGPU] Initialized successfully"),!0):(console.log("[WebGPU] No adapter found"),!1)}catch(e){return console.warn("[WebGPU] Init failed:",e),!1}}_createPipeline(){let t=this.device.createShaderModule({code:`
            struct Params {
                dim: u32,
                numVectors: u32,
            }

            @group(0) @binding(0) var<uniform> params: Params;
            @group(0) @binding(1) var<storage, read> query: array<f32>;
            @group(0) @binding(2) var<storage, read> vectors: array<f32>;
            @group(0) @binding(3) var<storage, read_write> scores: array<f32>;

            @compute @workgroup_size(256)
            fn main(@builtin(global_invocation_id) globalId: vec3u) {
                let idx = globalId.x;
                if (idx >= params.numVectors) {
                    return;
                }

                let dim = params.dim;
                let offset = idx * dim;

                // Compute dot product (= cosine similarity for normalized vectors)
                var dot: f32 = 0.0;
                for (var i: u32 = 0u; i < dim; i++) {
                    dot += query[i] * vectors[offset + i];
                }

                scores[idx] = dot;
            }
        `});this.pipeline=this.device.createComputePipeline({layout:"auto",compute:{module:t,entryPoint:"main"}})}async batchCosineSimilarity(e,t,n=!0,s=!1){if(!this.available||t.length===0)return null;let o=e.length,i=s?t.length/o:t.length,a=i*o*4,l=this.device.limits?.maxStorageBufferBindingSize||134217728;if(a>l)return console.warn(`[WebGPU] Buffer size ${(a/1024/1024).toFixed(1)}MB exceeds limit ${(l/1024/1024).toFixed(1)}MB, falling back`),null;let c=this.device.createBuffer({size:8,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),u=this.device.createBuffer({size:o*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),f=this.device.createBuffer({size:i*o*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),h=this.device.createBuffer({size:i*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),d=this.device.createBuffer({size:i*4,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST});if(this.device.queue.writeBuffer(c,0,new Uint32Array([o,i])),this.device.queue.writeBuffer(u,0,e),s)this.device.queue.writeBuffer(f,0,t);else{let w=new Float32Array(i*o);for(let E=0;E<i;E++)w.set(t[E],E*o);this.device.queue.writeBuffer(f,0,w)}let p=this.device.createBindGroup({layout:this.pipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:c}},{binding:1,resource:{buffer:u}},{binding:2,resource:{buffer:f}},{binding:3,resource:{buffer:h}}]}),g=this.device.createCommandEncoder(),b=g.beginComputePass();b.setPipeline(this.pipeline),b.setBindGroup(0,p),b.dispatchWorkgroups(Math.ceil(i/256)),b.end(),g.copyBufferToBuffer(h,0,d,0,i*4),this.device.queue.submit([g.finish()]),await d.mapAsync(GPUMapMode.READ);let y=new Float32Array(d.getMappedRange().slice(0));return d.unmap(),c.destroy(),u.destroy(),f.destroy(),h.destroy(),d.destroy(),y}isAvailable(){return this.available}getMaxVectorsPerBatch(e){if(!this.available)return 0;let t=this.device.limits?.maxStorageBufferBindingSize||134217728;return Math.floor(t*.9/(e*4))}},jt=null});var ht={};Ee(ht,{OPFSFileReader:()=>$e,OPFSStorage:()=>ce,opfsStorage:()=>ft});var ce,$e,ft,ue=O(()=>{ce=class{constructor(e="lanceql"){this.rootDir=e,this.root=null}async getRoot(){if(this.root)return this.root;if(typeof navigator>"u"||!navigator.storage?.getDirectory)throw new Error("OPFS not available. Requires modern browser with Origin Private File System support.");let e=await navigator.storage.getDirectory();return this.root=await e.getDirectoryHandle(this.rootDir,{create:!0}),this.root}async open(){return await this.getRoot(),this}async getDir(e){let t=await this.getRoot(),n=e.split("/").filter(o=>o),s=t;for(let o of n)s=await s.getDirectoryHandle(o,{create:!0});return s}async save(e,t){let n=e.split("/"),s=n.pop(),o=n.join("/"),a=await(o?await this.getDir(o):await this.getRoot()).getFileHandle(s,{create:!0});if(a.createSyncAccessHandle)try{let c=await a.createSyncAccessHandle();return c.truncate(0),c.write(t,{at:0}),c.flush(),c.close(),{path:e,size:t.byteLength}}catch{}let l=await a.createWritable();return await l.write(t),await l.close(),{path:e,size:t.byteLength}}async load(e){try{let t=e.split("/"),n=t.pop(),s=t.join("/"),l=await(await(await(s?await this.getDir(s):await this.getRoot()).getFileHandle(n)).getFile()).arrayBuffer();return new Uint8Array(l)}catch(t){if(t.name==="NotFoundError")return null;throw t}}async delete(e){try{let t=e.split("/"),n=t.pop(),s=t.join("/");return await(s?await this.getDir(s):await this.getRoot()).removeEntry(n),!0}catch(t){if(t.name==="NotFoundError")return!1;throw t}}async list(e=""){try{let t=e?await this.getDir(e):await this.getRoot(),n=[];for await(let[s,o]of t.entries())n.push({name:s,type:o.kind});return n}catch{return[]}}async exists(e){try{let t=e.split("/"),n=t.pop(),s=t.join("/");return await(s?await this.getDir(s):await this.getRoot()).getFileHandle(n),!0}catch{return!1}}async deleteDir(e){try{let t=e.split("/"),n=t.pop(),s=t.join("/");return await(s?await this.getDir(s):await this.getRoot()).removeEntry(n,{recursive:!0}),!0}catch{return!1}}async readRange(e,t,n){try{let s=e.split("/"),o=s.pop(),i=s.join("/"),f=await(await(await(i?await this.getDir(i):await this.getRoot()).getFileHandle(o)).getFile()).slice(t,t+n).arrayBuffer();return new Uint8Array(f)}catch(s){if(s.name==="NotFoundError")return null;throw s}}async getFileSize(e){try{let t=e.split("/"),n=t.pop(),s=t.join("/");return(await(await(s?await this.getDir(s):await this.getRoot()).getFileHandle(n)).getFile()).size}catch(t){if(t.name==="NotFoundError")return null;throw t}}async openFile(e){try{let t=e.split("/"),n=t.pop(),s=t.join("/"),i=await(s?await this.getDir(s):await this.getRoot()).getFileHandle(n);return new $e(i)}catch(t){if(t.name==="NotFoundError")return null;throw t}}async isSupported(){try{return typeof navigator>"u"||!navigator.storage?.getDirectory?!1:(await navigator.storage.getDirectory(),!0)}catch{return!1}}async getStats(){try{let e=await this.getRoot(),t=0,n=0;async function s(o){for await(let[i,a]of o.entries())if(a.kind==="file"){let l=await a.getFile();t++,n+=l.size}else a.kind==="directory"&&await s(a)}return await s(e),{fileCount:t,totalSize:n}}catch{return{fileCount:0,totalSize:0}}}async listFiles(){try{let e=await this.getRoot(),t=[];async function n(s,o=""){for await(let[i,a]of s.entries())if(a.kind==="file"){let l=await a.getFile();t.push({name:o?`${o}/${i}`:i,size:l.size,lastModified:l.lastModified})}else a.kind==="directory"&&await n(a,o?`${o}/${i}`:i)}return await n(e),t}catch{return[]}}async clearAll(){try{let e=await this.getRoot(),t=0,n=[];for await(let[s,o]of e.entries())n.push({name:s,kind:o.kind});for(let s of n)await e.removeEntry(s.name,{recursive:s.kind==="directory"}),t++;return t}catch(e){return console.warn("Failed to clear OPFS:",e),0}}},$e=class{constructor(e){this.fileHandle=e,this._file=null,this._size=null}async getFile(){return this._file||(this._file=await this.fileHandle.getFile(),this._size=this._file.size),this._file}async getSize(){return this._size===null&&await this.getFile(),this._size}async readRange(e,t){let o=await(await this.getFile()).slice(e,e+t).arrayBuffer();return new Uint8Array(o)}async readFromEnd(e){let t=await this.getSize();return this.readRange(t-e,e)}invalidate(){this._file=null,this._size=null}},ft=new ce});var mt,Zt=O(()=>{mt=new Uint8Array([76,65,78,67])});var os={};Ee(os,{ChunkedLanceReader:()=>dt,MemoryManager:()=>Ve});var dt,Ve,Ti,en=O(()=>{ot();Zt();dt=class r{constructor(e,t=null){this.fileReader=e,this.pageCache=t||new ie,this.footer=null,this.columnMetaCache=new Map,this._cacheKey=null}static async open(e,t,n=null){let s=await e.openFile(t);if(!s)throw new Error(`File not found: ${t}`);let o=new r(s,n);return o._cacheKey=t,await o._readFooter(),o}async _readFooter(){let e=await this.fileReader.readFromEnd(40),t=e.slice(36,40);if(!this._arraysEqual(t,mt))throw new Error("Invalid Lance file: magic bytes mismatch");let n=new DataView(e.buffer,e.byteOffset);return this.footer={columnMetaStart:n.getBigUint64(0,!0),columnMetaOffsetsStart:n.getBigUint64(8,!0),globalBuffOffsetsStart:n.getBigUint64(16,!0),numGlobalBuffers:n.getUint32(24,!0),numColumns:n.getUint32(28,!0),majorVersion:n.getUint16(32,!0),minorVersion:n.getUint16(34,!0)},this.footer}_arraysEqual(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}async getSize(){return this.fileReader.getSize()}getNumColumns(){if(!this.footer)throw new Error("Footer not loaded");return this.footer.numColumns}getVersion(){if(!this.footer)throw new Error("Footer not loaded");return{major:this.footer.majorVersion,minor:this.footer.minorVersion}}async _readColumnMetaOffsets(){let e=this.footer.numColumns,t=e*8,n=await this.fileReader.readRange(Number(this.footer.columnMetaOffsetsStart),t);return new BigUint64Array(n.buffer,n.byteOffset,e)}async readColumnMetaRaw(e){if(e>=this.footer.numColumns)throw new Error(`Column index ${e} out of range (${this.footer.numColumns} columns)`);let t=`${this._cacheKey}:colmeta:${e}`,n=this.pageCache.get(t);if(n)return n;let s=await this._readColumnMetaOffsets(),o=Number(this.footer.columnMetaStart)+Number(s[e]),i=e<this.footer.numColumns-1?Number(this.footer.columnMetaStart)+Number(s[e+1]):Number(this.footer.columnMetaOffsetsStart),a=await this.fileReader.readRange(o,i-o);return this.pageCache.put(t,a),a}async readRange(e,t){let n=`${this._cacheKey}:range:${e}:${t}`,s=this.pageCache.get(n);if(s)return s;let o=await this.fileReader.readRange(e,t);return t<10*1024*1024&&this.pageCache.put(n,o),o}getCacheStats(){return this.pageCache.stats()}close(){this.fileReader.invalidate(),this.columnMetaCache.clear()}},Ve=class{constructor(e={}){this.maxHeapMB=e.maxHeapMB||100,this.warningThreshold=e.warningThreshold||.8,this.caches=new Set,this.lastCheck=0,this.checkInterval=5e3}registerCache(e){this.caches.add(e)}unregisterCache(e){this.caches.delete(e)}getMemoryUsage(){return typeof performance<"u"&&performance.memory?{usedHeapMB:performance.memory.usedJSHeapSize/(1024*1024),totalHeapMB:performance.memory.totalJSHeapSize/(1024*1024),limitMB:performance.memory.jsHeapSizeLimit/(1024*1024)}:null}checkAndCleanup(){let e=Date.now();if(e-this.lastCheck<this.checkInterval)return!1;this.lastCheck=e;let t=this.getMemoryUsage();return t&&t.usedHeapMB/this.maxHeapMB>this.warningThreshold?(console.warn(`[MemoryManager] High memory usage: ${t.usedHeapMB.toFixed(1)}MB / ${this.maxHeapMB}MB`),this.cleanup(),!0):!1}cleanup(){for(let e of this.caches){let n=e.stats().currentSize/2;for(;e.currentSize>n&&e.cache.size>0;)e._evictOldest()}}getCacheStats(){let e=0,t=0,n=0;for(let s of this.caches){let o=s.stats();e+=o.entries,t+=o.currentSize,n+=o.maxSize}return{caches:this.caches.size,totalEntries:e,totalSizeMB:(t/(1024*1024)).toFixed(2),totalMaxSizeMB:(n/(1024*1024)).toFixed(2),memory:this.getMemoryUsage()}}},Ti=new Ve});async function Ps(r){let e=[1,5,10,20,50,100],t=await Promise.all(e.map(async s=>{try{return(await fetch(`${r}/_versions/${s}.manifest`,{method:"HEAD"})).ok?s:0}catch{return 0}})),n=Math.max(...t);if(n===0)return null;for(let s=n+1;s<=n+30;s++)try{if((await fetch(`${r}/_versions/${s}.manifest`,{method:"HEAD"})).ok)n=s;else break}catch{break}return n}function Fs(r){let t=new DataView(r.buffer,r.byteOffset).getUint32(0,!0),n=r.slice(4,4+t),s=0,o=null,i=null,a=(l,c)=>{let u=0,f=0,h=c;for(;h<l.length;){let d=l[h++];if(u|=(d&127)<<f,(d&128)===0)break;f+=7}return{value:u,pos:h}};for(;s<n.length;){let l=a(n,s);s=l.pos;let c=l.value>>3,u=l.value&7;if(u===2){let f=a(n,s);s=f.pos;let h=n.slice(s,s+f.value);if(s+=f.value,c===1){let d=To(h);d?.uuid&&(o=d.uuid,i=d.fieldId)}}else u===0?s=a(n,s).pos:u===5?s+=4:u===1&&(s+=8)}return o?{uuid:o,fieldId:i}:null}function To(r){let e=0,t=null,n=null,s=()=>{let o=0,i=0;for(;e<r.length;){let a=r[e++];if(o|=(a&127)<<i,(a&128)===0)break;i+=7}return o};for(;e<r.length;){let o=s(),i=o>>3,a=o&7;if(a===2){let l=s(),c=r.slice(e,e+l);e+=l,i===1&&(t=xo(c))}else if(a===0){let l=s();i===2&&(n=l)}else a===5?e+=4:a===1&&(e+=8)}return{uuid:t,fieldId:n}}function xo(r){let e=0;for(;e<r.length;){let t=r[e++],n=t>>3,s=t&7;if(s===2&&n===1){let o=r[e++],i=r.slice(e,e+o),a=Array.from(i).map(l=>l.toString(16).padStart(2,"0")).join("");return`${a.slice(0,8)}-${a.slice(8,12)}-${a.slice(12,16)}-${a.slice(16,20)}-${a.slice(20,32)}`}else if(s===0)for(;e<r.length&&r[e++]&128;);else s===5?e+=4:s===1&&(e+=8)}return null}function Ms(r,e,t){let n=new t,s=Bs(r);if(s&&(s.centroids&&(n.centroids=s.centroids.data,n.numPartitions=s.centroids.numPartitions,n.dimension=s.centroids.dimension),s.offsets?.length>0&&(n.partitionOffsets=s.offsets),s.lengths?.length>0&&(n.partitionLengths=s.lengths)),!n.centroids){let o=0,i=()=>{let a=0,l=0;for(;o<r.length;){let c=r[o++];if(a|=(c&127)<<l,(c&128)===0)break;l+=7}return a};for(;o<r.length-4;){let l=i()&7;if(l===2){let c=i();if(c>r.length-o)break;let u=r.slice(o,o+c);if(o+=c,c>100&&c<1e8){let f=Ls(u);f&&(n.centroids=f.data,n.numPartitions=f.numPartitions,n.dimension=f.dimension)}}else l===0?i():l===5?o+=4:l===1&&(o+=8)}}return n.centroids?n:null}function Bs(r){let e=0,t=[],n=[],s=null,o=()=>{let i=0,a=0;for(;e<r.length;){let l=r[e++];if(i|=(l&127)<<a,(l&128)===0)break;a+=7}return i};for(;e<r.length-4;){let i=e,a=o(),l=a>>3,c=a&7;if(c===2){let u=o();if(u>r.length-e||u<0){e=i+1;continue}let f=r.slice(e,e+u);if(e+=u,l===2&&u%8===0&&u>0){let h=new DataView(f.buffer,f.byteOffset,u);for(let d=0;d<u/8;d++)t.push(Number(h.getBigUint64(d*8,!0)))}else if(l===3)if(u%4===0&&u>0){let h=new DataView(f.buffer,f.byteOffset,u);for(let d=0;d<u/4;d++)n.push(h.getUint32(d*4,!0))}else{let h=0;for(;h<f.length;){let d=0,p=0;for(;h<f.length;){let g=f[h++];if(d|=(g&127)<<p,(g&128)===0)break;p+=7}n.push(d)}}else if(l===4)s=Ls(f);else if(u>100){let h=Bs(f);(h?.centroids||h?.offsets?.length>0)&&(h.centroids&&!s&&(s=h.centroids),h.offsets?.length>t.length&&(t=h.offsets),h.lengths?.length>n.length&&(n=h.lengths))}}else c===0?o():c===5?e+=4:c===1?e+=8:e=i+1}return s||t.length>0||n.length>0?{centroids:s,offsets:t,lengths:n}:null}function Ls(r){let e=0,t=[],n=null,s=2,o=()=>{let i=0,a=0;for(;e<r.length;){let l=r[e++];if(i|=(l&127)<<a,(l&128)===0)break;a+=7}return i};for(;e<r.length;){let i=o(),a=i>>3,l=i&7;if(l===0){let c=o();a===1&&(s=c)}else if(l===2){let c=o(),u=r.slice(e,e+c);if(e+=c,a===2){let f=0;for(;f<u.length;){let h=0,d=0;for(;f<u.length;){let p=u[f++];if(h|=(p&127)<<d,(p&128)===0)break;d+=7}t.push(h)}}else a===3&&(n=u)}else l===5?e+=4:l===1&&(e+=8)}if(t.length>=2&&n&&s===2){let i=t[0],a=t[1];if(n.length===i*a*4)return{data:new Float32Array(n.buffer,n.byteOffset,i*a),numPartitions:i,dimension:a}}return null}var Os=O(()=>{});async function Sn(r){let e;try{e=await fetch(r.auxiliaryUrl,{method:"HEAD"})}catch{return}if(!e.ok)return;let t=parseInt(e.headers.get("content-length"));if(!t)return;let n=await fetch(r.auxiliaryUrl,{headers:{Range:`bytes=${t-40}-${t-1}`}});if(!n.ok)return;let s=new Uint8Array(await n.arrayBuffer()),o=new DataView(s.buffer,s.byteOffset),i=Number(o.getBigUint64(0,!0)),a=Number(o.getBigUint64(8,!0)),l=Number(o.getBigUint64(16,!0)),c=o.getUint32(24,!0);if(new TextDecoder().decode(s.slice(36,40))!=="LANC")return;let f=c*16,h=await fetch(r.auxiliaryUrl,{headers:{Range:`bytes=${l}-${l+f-1}`}});if(!h.ok)return;let d=new Uint8Array(await h.arrayBuffer()),p=new DataView(d.buffer,d.byteOffset),g=[];for(let w=0;w<c;w++){let E=Number(p.getBigUint64(w*16,!0)),_=Number(p.getBigUint64(w*16+8,!0));g.push({offset:E,length:_})}if(g.length<2)return;r._auxBuffers=g,r._auxFileSize=t;let b=await fetch(r.auxiliaryUrl,{headers:{Range:`bytes=${a}-${l-1}`}});if(!b.ok)return;let y=new Uint8Array(await b.arrayBuffer());if(y.length>=32){let w=new DataView(y.buffer,y.byteOffset),E=Number(w.getBigUint64(0,!0)),_=Number(w.getBigUint64(8,!0)),S=await fetch(r.auxiliaryUrl,{headers:{Range:`bytes=${E}-${E+_-1}`}});if(S.ok){let A=new Uint8Array(await S.arrayBuffer());An(r,A)}}}function An(r,e){let t=0,n=[],s=()=>{let o=0,i=0;for(;t<e.length;){let a=e[t++];if(o|=(a&127)<<i,(a&128)===0)break;i+=7}return o};for(;t<e.length;){let o=s(),i=o>>3,a=o&7;if(a===2){let l=s();if(l>e.length-t)break;let c=e.slice(t,t+l);if(t+=l,i===2){let u=No(c);u&&n.push(u)}}else a===0?s():a===5?t+=4:a===1&&(t+=8)}r._columnPages=n}function No(r){let e=0,t=0,n=[],s=[],o=()=>{let i=0,a=0;for(;e<r.length;){let l=r[e++];if(i|=(l&127)<<a,(l&128)===0)break;a+=7}return i};for(;e<r.length;){let i=o(),a=i>>3,l=i&7;if(l===0){let c=o();a===3&&(t=c)}else if(l===2){let c=o(),u=r.slice(e,e+c);if(e+=c,a===1){let f=0;for(;f<u.length;){let h=0n,d=0n;for(;f<u.length;){let p=u[f++];if(h|=BigInt(p&127)<<d,(p&128)===0)break;d+=7n}n.push(Number(h))}}if(a===2){let f=0;for(;f<u.length;){let h=0n,d=0n;for(;f<u.length;){let p=u[f++];if(h|=BigInt(p&127)<<d,(p&128)===0)break;d+=7n}s.push(Number(h))}}}else l===5?e+=4:l===1&&(e+=8)}return{numRows:t,bufferOffsets:n,bufferSizes:s}}function ks(r,e){let t=0,n=()=>{let s=0,o=0;for(;t<e.length;){let i=e[t++];if(s|=(i&127)<<o,(i&128)===0)break;o+=7}return s};for(;t<e.length-4;){let s=n(),o=s>>3,i=s&7;if(i===2){let a=n();if(a>e.length-t)break;let l=e.slice(t,t+a);if(t+=a,o===2&&a>100&&a<2e3){let c=[],u=0;for(;u<l.length;){let f=0,h=0;for(;u<l.length;){let d=l[u++];if(f|=(d&127)<<h,(d&128)===0)break;h+=7}c.push(f)}c.length===r.numPartitions&&(r.partitionOffsets=c)}else if(o===3&&a>100&&a<2e3){let c=[],u=0;for(;u<l.length;){let f=0,h=0;for(;u<l.length;){let d=l[u++];if(f|=(d&127)<<h,(d&128)===0)break;h+=7}c.push(f)}c.length===r.numPartitions&&(r.partitionLengths=c)}}else if(i===0)n();else if(i===1)t+=8;else if(i===5)t+=4;else break}}var Ds=O(()=>{});async function Cn(r){let e=`${r.datasetBaseUrl}/ivf_vectors.bin`;r.partitionVectorsUrl=e;let t=await fetch(e,{headers:{Range:"bytes=0-2055"}});if(!t.ok)return;let n=await t.arrayBuffer(),s=new BigUint64Array(n);r.partitionOffsets=Array.from(s,o=>Number(o)),r.hasPartitionIndex=!0}async function zs(r,e,t=384,n=null){if(!r.hasPartitionIndex||!r.partitionVectorsUrl)return null;let s=0,o=0,i=[],a=new Map;r._partitionCache||(r._partitionCache=new ie({maxSize:Po}));for(let c of e){let u=r._partitionCache.get(c);u!==void 0?a.set(c,u):(i.push(c),s+=r.partitionOffsets[c+1]-r.partitionOffsets[c])}if(i.length===0)return Gs(e,a,t,n);r._fetchStats||(r._fetchStats={concurrency:6,recentLatencies:[],minConcurrency:2,maxConcurrency:12});let l=r._fetchStats;for(let c=0;c<i.length;c+=l.concurrency){let u=i.slice(c,c+l.concurrency),f=performance.now(),h=await Promise.all(u.map(async g=>{let b=r.partitionOffsets[g],y=r.partitionOffsets[g+1],w=y-b;try{let E=await fetch(r.partitionVectorsUrl,{headers:{Range:`bytes=${b}-${y-1}`}});if(!E.ok)return{p:g,rowIds:[],vectors:[]};let _=await E.arrayBuffer(),A=new DataView(_).getUint32(0,!0),R=4+A*4,U=new Uint32Array(_.slice(4,R)),C=new Float32Array(_.slice(R));return o+=w,n&&n(o,s),{p:g,rowIds:Array.from(U),vectors:C,numVectors:A}}catch{return{p:g,rowIds:[],vectors:[]}}}));for(let g of h){let b={rowIds:g.rowIds,vectors:g.vectors,numVectors:g.numVectors??g.rowIds.length},y=g.rowIds.length*4+(g.vectors.byteLength||g.vectors.length*4);r._partitionCache.set(g.p,b,y),a.set(g.p,b)}let d=performance.now()-f;l.recentLatencies.push(d),l.recentLatencies.length>10&&l.recentLatencies.shift();let p=l.recentLatencies.reduce((g,b)=>g+b,0)/l.recentLatencies.length;p<50&&l.concurrency<l.maxConcurrency?l.concurrency++:p>200&&l.concurrency>l.minConcurrency&&l.concurrency--}return Gs(e,a,t,n)}function Gs(r,e,t,n){let s=0,o=0;for(let u of r){let f=e.get(u);f&&(s+=f.rowIds.length,o+=f.vectors.length)}let i=new Array(s),a=new Float32Array(o),l=0,c=0;for(let u of r){let f=e.get(u);if(f){for(let h=0;h<f.rowIds.length;h++)i[l++]=f.rowIds[h];a.set(f.vectors,c),c+=f.vectors.length}}return n&&n(100,100),{rowIds:i,vectors:a,preFlattened:!0}}async function In(r){if(!r.auxiliaryUrl||!r._auxBufferOffsets||r._rowIdCacheReady)return;let e=r.partitionLengths.reduce((s,o)=>s+o,0);if(e===0)return;let t=r._auxBufferOffsets[1],n=e*8;try{let s=await fetch(r.auxiliaryUrl,{headers:{Range:`bytes=${t}-${t+n-1}`}});if(!s.ok)return;let o=new Uint8Array(await s.arrayBuffer()),i=new DataView(o.buffer,o.byteOffset);r._rowIdCache=new Map;let a=0;for(let l=0;l<r.partitionLengths.length;l++){let c=r.partitionLengths[l],u=[];for(let f=0;f<c;f++){let h=Number(i.getBigUint64(a*8,!0));u.push({fragId:Math.floor(h/4294967296),rowOffset:h%4294967296}),a++}r._rowIdCache.set(l,u)}r._rowIdCacheReady=!0}catch{}}async function $s(r,e){if(r._rowIdCacheReady&&r._rowIdCache){let o=[];for(let i of e){let a=r._rowIdCache.get(i);if(a)for(let l of a)o.push({...l,partition:i})}return o}if(!r.auxiliaryUrl||!r._auxBufferOffsets)return null;let t=[];for(let o of e)o<r.partitionOffsets.length&&t.push({partition:o,startRow:r.partitionOffsets[o],numRows:r.partitionLengths[o]});if(t.length===0)return[];let n=[],s=r._auxBufferOffsets[1];for(let o of t){let i=s+o.startRow*8,a=i+o.numRows*8-1;try{let l=await fetch(r.auxiliaryUrl,{headers:{Range:`bytes=${i}-${a}`}});if(!l.ok)continue;let c=new Uint8Array(await l.arrayBuffer()),u=new DataView(c.buffer,c.byteOffset);for(let f=0;f<o.numRows;f++){let h=Number(u.getBigUint64(f*8,!0));n.push({fragId:Math.floor(h/4294967296),rowOffset:h%4294967296,partition:o.partition})}}catch{}}return n}function Vs(r,e){let t=0;for(let n of e)n<r.partitionLengths.length&&(t+=r.partitionLengths[n]);return t}var Po,Ws=O(()=>{ot();Po=50*1024*1024});function Mo(r,e){if(e>=r.length)return r;if(e<=0)return[];let t=0,n=r.length-1;for(;t<n;){let s=t+n>>1;r[s].score>r[t].score&&Ke(r,t,s),r[n].score>r[t].score&&Ke(r,t,n),r[s].score>r[n].score&&Ke(r,s,n);let o=r[n].score,i=t;for(let a=t;a<n;a++)r[a].score>=o&&(Ke(r,i,a),i++);if(Ke(r,i,n),i===e-1)break;i<e-1?t=i+1:n=i-1}return r.slice(0,e)}function Ke(r,e,t){let n=r[e];r[e]=r[t],r[t]=n}var ge,St=O(()=>{Os();Ds();Ws();ge=class r{constructor(){this.centroids=null,this.numPartitions=0,this.dimension=0,this.partitionOffsets=[],this.partitionLengths=[],this.metricType="cosine",this.partitionIndexUrl=null,this.partitionStarts=null,this.hasPartitionIndex=!1,this._rowIdCache=null,this._rowIdCacheReady=!1,this._accessCounts=new Map}static async tryLoad(e){if(!e)return null;try{let t=await Ps(e);if(!t)return null;let n=`${e}/_versions/${t}.manifest`,s=await fetch(n);if(!s.ok)return null;let o=await s.arrayBuffer(),i=Fs(new Uint8Array(o));if(!i?.uuid)return null;let a=`${e}/_indices/${i.uuid}/index.idx`,l=await fetch(a);if(!l.ok)return null;let c=await l.arrayBuffer(),u=Ms(new Uint8Array(c),i,r);if(!u)return null;u.auxiliaryUrl=`${e}/_indices/${i.uuid}/auxiliary.idx`,u.datasetBaseUrl=e;try{await Sn(u)}catch{}try{await Cn(u)}catch{}try{await In(u)}catch{}return u}catch{return null}}async _loadPartitionIndex(){return Cn(this)}fetchPartitionData(e,t=384,n=null){return zs(this,e,t,n)}async _loadAuxiliaryMetadata(){return Sn(this)}_parseColumnMetaForPartitions(e){return An(this,e)}_parseAuxiliaryPartitionInfo(e){return ks(this,e)}async prefetchAllRowIds(){return In(this)}fetchPartitionRowIds(e){return $s(this,e)}getPartitionRowCount(e){return Vs(this,e)}findNearestPartitions(e,t=10){if(!this.centroids||e.length!==this.dimension)return[];t=Math.min(t,this.numPartitions);let n=new Array(this.numPartitions),s=0;for(let l=0;l<this.dimension;l++)s+=e[l]*e[l];let o=Math.sqrt(s);for(let l=0;l<this.numPartitions;l++){let c=l*this.dimension,u=0,f=0;for(let d=0;d<this.dimension;d++){let p=this.centroids[c+d];u+=e[d]*p,f+=p*p}let h=o*Math.sqrt(f);n[l]={idx:l,score:h===0?0:u/h}}let a=Mo(n,t).map(l=>l.idx);for(let l of a)this._accessCounts.set(l,(this._accessCounts.get(l)||0)+1);return a}async prefetchHotPartitions(e=10,t=3){if(!this._accessCounts||this._accessCounts.size===0)return;let n=[...this._accessCounts.entries()].filter(([s,o])=>o>=t).sort((s,o)=>o[1]-s[1]).slice(0,e).map(([s])=>s);n.length!==0&&await this.fetchPartitionData(n,this.dimension)}getAccessStats(){return{totalPartitions:this.numPartitions,accessedPartitions:this._accessCounts.size,topPartitions:[...this._accessCounts.entries()].sort((e,t)=>t[1]-e[1]).slice(0,10)}}}});async function qs(r){let e=r.url.match(/^(.+\.lance)\/data\/.+\.lance$/);if(e){r._datasetBaseUrl=e[1];try{let t=`${r._datasetBaseUrl}/_versions/1.manifest`,n=await fetch(t);if(!n.ok)return;let s=await n.arrayBuffer();r._schema=Bo(new Uint8Array(s))}catch{}}}function Bo(r){let e=new DataView(r.buffer,r.byteOffset),t=e.getUint32(0,!0),n=4+t,s;if(n+4<r.length){let l=e.getUint32(n,!0);l>0&&n+4+l<=r.length?s=r.slice(n+4,n+4+l):s=r.slice(4,4+t)}else s=r.slice(4,4+t);let o=0,i=[],a=()=>{let l=0,c=0;for(;o<s.length;){let u=s[o++];if(l|=(u&127)<<c,(u&128)===0)break;c+=7}return l};for(;o<s.length;){let l=a(),c=l>>3,u=l&7;if(c===1&&u===2){let f=a(),h=o+f,d=null,p=null,g=null;for(;o<h;){let b=a(),y=b>>3,w=b&7;if(w===0){let E=a();y===3&&(p=E)}else if(w===2){let E=a(),_=s.slice(o,o+E);o+=E,y===2?d=new TextDecoder().decode(_):y===5&&(g=new TextDecoder().decode(_))}else w===5?o+=4:w===1&&(o+=8)}d&&i.push({name:d,id:p,type:g})}else if(u===0)a();else if(u===2){let f=a();o+=f}else u===5?o+=4:u===1&&(o+=8)}return i}function js(r){return r._schema&&r._schema.length>0?r._schema.map(e=>e.name):Array.from({length:r._numColumns},(e,t)=>`column_${t}`)}async function Hs(r){if(r._columnTypes)return r._columnTypes;let e=[];if(r._schema&&r._schema.length>0){for(let t=0;t<r._numColumns;t++){let n=r._schema[t],s=n?.type?.toLowerCase()||"",o=n?.name?.toLowerCase()||"",i="unknown",a=o.includes("embedding")||o.includes("vector")||o.includes("emb")||o==="vec";s.includes("utf8")||s.includes("string")||s.includes("large_utf8")?i="string":s.includes("fixed_size_list")||s.includes("vector")||a?i="vector":s.includes("int64")||s==="int64"?i="int64":s.includes("int32")||s==="int32"?i="int32":s.includes("int16")||s==="int16"?i="int16":s.includes("int8")||s==="int8"?i="int8":s.includes("float64")||s.includes("double")?i="float64":s.includes("float32")||s.includes("float")&&!s.includes("64")?i="float32":s.includes("bool")&&(i="bool"),e.push(i)}if(e.some(t=>t!=="unknown"))return r._columnTypes=e,e;e.length=0}for(let t=0;t<r._numColumns;t++){let n="unknown",s=r.columnNames[t]?.toLowerCase()||"",o=s.includes("embedding")||s.includes("vector")||s.includes("emb")||s==="vec";try{await r.readStringAt(t,0),n="string",e.push(n);continue}catch{}try{let i=await r.getColumnOffsetEntry(t);if(i.len>0){let a=await r.fetchRange(i.pos,i.pos+i.len-1),l=new Uint8Array(a),c=r._parseColumnMeta(l);if(c.rows>0&&c.size>0){let u=c.size/c.rows;if(o&&u>=4)n="vector";else if(u===8)n="int64";else if(u===4)try{let f=await r.readInt32AtIndices(t,[0]);if(f.length>0){let h=f[0];h>=-1e6&&h<=1e6&&Number.isInteger(h)?n="int32":n="float32"}}catch{n="float32"}else u>8&&u%4===0?n="vector":u===2?n="int16":u===1&&(n="int8")}}}catch{}e.push(n)}return r._columnTypes=e,e}var Ks=O(()=>{});function Qs(r){let e=0,t=[],n=0,s=()=>{let f=0n,h=0n;for(;e<r.length;){let d=r[e++];if(f|=BigInt(d&127)<<h,(d&128)===0)break;h+=7n}return Number(f)};for(;e<r.length;){let f=s(),h=f>>3,d=f&7;if(h===2&&d===2){let p=s(),g=e+p,b=[],y=[],w=0;for(;e<g;){let E=s(),_=E>>3,S=E&7;if(_===1&&S===2){let A=s(),R=e+A;for(;e<R;)b.push(s())}else if(_===2&&S===2){let A=s(),R=e+A;for(;e<R;)y.push(s())}else if(_===3&&S===0)w=s();else if(S===0)s();else if(S===2){let A=s();e+=A}else S===5?e+=4:S===1&&(e+=8)}t.push({offsets:b,sizes:y,rows:w}),n+=w}else if(d===0)s();else if(d===2){let p=s();e+=p}else d===5?e+=4:d===1&&(e+=8)}let o=t[0]||{offsets:[],sizes:[],rows:0},i=o.offsets,a=o.sizes,l=0;for(let f of t){let h=f.sizes.length>1?1:0;l+=f.sizes[h]||0}let c=i.length>1?1:0,u=i.length>1?0:-1;return{offset:i[c]||0,size:t.length>1?l:a[c]||0,rows:n,nullBitmapOffset:u>=0?i[u]:null,nullBitmapSize:u>=0?a[u]:null,bufferOffsets:i,bufferSizes:a,pages:t}}function Qe(r){let e=[],t=0,n=()=>{let o=0,i=0;for(;t<r.length;){let a=r[t++];if(o|=(a&127)<<i,(a&128)===0)break;i+=7}return o};for(;t<r.length;){let o=n(),i=o>>3,a=o&7;if(i===2&&a===2){let l=n(),c=t+l,u=[0,0],f=[0,0],h=0;for(;t<c;){let d=n(),p=d>>3,g=d&7;if(p===1&&g===2){let b=n(),y=t+b,w=0;for(;t<y&&w<2;)u[w++]=n();t=y}else if(p===2&&g===2){let b=n(),y=t+b,w=0;for(;t<y&&w<2;)f[w++]=n();t=y}else if(p===3&&g===0)h=n();else if(p===4&&g===2){let b=n();t+=b}else if(g===0)n();else if(g===2){let b=n();t+=b}else g===5?t+=4:g===1&&(t+=8)}e.push({offsetsStart:u[0],offsetsSize:f[0],dataStart:u[1],dataSize:f[1],rows:h})}else if(a===0)n();else if(a===2){let l=n();t+=l}else a===5?t+=4:a===1&&(t+=8)}return{...e[0]||{offsetsStart:0,offsetsSize:0,dataStart:0,dataSize:0,rows:0},pages:e}}function ee(r,e,t=1024){if(r.length===0)return[];let n=[...r].map((i,a)=>({idx:i,origPos:a}));n.sort((i,a)=>i.idx-a.idx);let s=[],o=0;for(let i=1;i<=n.length;i++)(i===n.length||(n[i].idx-n[i-1].idx)*e>t)&&(s.push({startIdx:n[o].idx,endIdx:n[i-1].idx,items:n.slice(o,i)}),o=i);return s}var Je=O(()=>{});async function Js(r,e,t){if(t.length===0)return new BigInt64Array(0);let n=await r.getColumnOffsetEntry(e),s=await r.fetchRange(n.pos,n.pos+n.len-1),o=r._parseColumnMeta(new Uint8Array(s)),i=new BigInt64Array(t.length),a=8,l=ee(t,a);return await Promise.all(l.map(async c=>{let u=o.offset+c.startIdx*a,f=o.offset+(c.endIdx+1)*a-1,h=await r.fetchRange(u,f),d=new DataView(h);for(let p of c.items){let g=(p.idx-c.startIdx)*a;i[p.origPos]=d.getBigInt64(g,!0)}})),i}async function Ys(r,e,t){if(t.length===0)return new Float64Array(0);let n=await r.getColumnOffsetEntry(e),s=await r.fetchRange(n.pos,n.pos+n.len-1),o=r._parseColumnMeta(new Uint8Array(s)),i=new Float64Array(t.length),a=8,l=ee(t,a);return await Promise.all(l.map(async c=>{let u=o.offset+c.startIdx*a,f=o.offset+(c.endIdx+1)*a-1,h=await r.fetchRange(u,f),d=new DataView(h);for(let p of c.items){let g=(p.idx-c.startIdx)*a;i[p.origPos]=d.getFloat64(g,!0)}})),i}async function Xs(r,e,t){if(t.length===0)return new Int32Array(0);let n=await r.getColumnOffsetEntry(e),s=await r.fetchRange(n.pos,n.pos+n.len-1),o=r._parseColumnMeta(new Uint8Array(s)),i=new Int32Array(t.length),a=4,l=ee(t,a);return await Promise.all(l.map(async c=>{let u=o.offset+c.startIdx*a,f=o.offset+(c.endIdx+1)*a-1,h=await r.fetchRange(u,f),d=new DataView(h);for(let p of c.items){let g=(p.idx-c.startIdx)*a;i[p.origPos]=d.getInt32(g,!0)}})),i}async function Zs(r,e,t){if(t.length===0)return new Float32Array(0);let n=await r.getColumnOffsetEntry(e),s=await r.fetchRange(n.pos,n.pos+n.len-1),o=r._parseColumnMeta(new Uint8Array(s)),i=new Float32Array(t.length),a=4,l=ee(t,a);return await Promise.all(l.map(async c=>{let u=o.offset+c.startIdx*a,f=o.offset+(c.endIdx+1)*a-1,h=await r.fetchRange(u,f),d=new DataView(h);for(let p of c.items){let g=(p.idx-c.startIdx)*a;i[p.origPos]=d.getFloat32(g,!0)}})),i}async function er(r,e,t){if(t.length===0)return new Int16Array(0);let n=await r.getColumnOffsetEntry(e),s=await r.fetchRange(n.pos,n.pos+n.len-1),o=r._parseColumnMeta(new Uint8Array(s)),i=new Int16Array(t.length),a=2,l=ee(t,a);return await Promise.all(l.map(async c=>{let u=o.offset+c.startIdx*a,f=o.offset+(c.endIdx+1)*a-1,h=await r.fetchRange(u,f),d=new DataView(h);for(let p of c.items){let g=(p.idx-c.startIdx)*a;i[p.origPos]=d.getInt16(g,!0)}})),i}async function tr(r,e,t){if(t.length===0)return new Uint8Array(0);let n=await r.getColumnOffsetEntry(e),s=await r.fetchRange(n.pos,n.pos+n.len-1),o=r._parseColumnMeta(new Uint8Array(s)),i=new Uint8Array(t.length),a=1,l=ee(t,a);return await Promise.all(l.map(async c=>{let u=o.offset+c.startIdx*a,f=o.offset+(c.endIdx+1)*a-1,h=await r.fetchRange(u,f),d=new Uint8Array(h);for(let p of c.items){let g=p.idx-c.startIdx;i[p.origPos]=d[g]}})),i}async function nr(r,e,t){if(t.length===0)return new Uint8Array(0);let n=await r.getColumnOffsetEntry(e),s=await r.fetchRange(n.pos,n.pos+n.len-1),o=r._parseColumnMeta(new Uint8Array(s)),i=new Uint8Array(t.length),a=t.map(g=>Math.floor(g/8)),l=[...new Set(a)].sort((g,b)=>g-b);if(l.length===0)return i;let c=l[0],u=l[l.length-1],f=o.offset+c,h=o.offset+u,d=await r.fetchRange(f,h),p=new Uint8Array(d);for(let g=0;g<t.length;g++){let b=t[g],y=Math.floor(b/8),w=b%8,E=y-c;E>=0&&E<p.length&&(i[g]=p[E]>>w&1)}return i}var sr=O(()=>{Je()});async function rr(r,e,t){let n=await r.getColumnOffsetEntry(e),s=await r.fetchRange(n.pos,n.pos+n.len-1),o=Qe(new Uint8Array(s));if(o.offsetsSize===0||o.dataSize===0)throw new Error(`Not a string column - offsetsSize=${o.offsetsSize}, dataSize=${o.dataSize}`);let i=o.offsetsSize/o.rows;if(i!==4&&i!==8)throw new Error(`Not a string column - bytesPerOffset=${i}, expected 4 or 8`);if(t>=o.rows)return"";let a=i,l=o.offsetsStart+t*a,c=await r.fetchRange(l,l+a*2-1),u=new DataView(c),f,h;if(a===4?(f=u.getUint32(0,!0),h=u.getUint32(4,!0)):(f=Number(u.getBigUint64(0,!0)),h=Number(u.getBigUint64(8,!0))),h<=f)return"";let d=h-f,p=await r.fetchRange(o.dataStart+f,o.dataStart+h-1);return new TextDecoder().decode(p)}async function or(r,e,t){if(t.length===0)return[];let n=await r.getColumnOffsetEntry(e),s=await r.fetchRange(n.pos,n.pos+n.len-1),o=Qe(new Uint8Array(s));if(!o.pages||o.pages.length===0)return t.map(()=>"");let i=new Array(t.length).fill(""),a=0,l=[];for(let u of o.pages){if(u.offsetsSize===0||u.dataSize===0||u.rows===0){a+=u.rows;continue}l.push({start:a,end:a+u.rows,page:u}),a+=u.rows}let c=new Map;for(let u=0;u<t.length;u++){let f=t[u];for(let h=0;h<l.length;h++){let d=l[h];if(f>=d.start&&f<d.end){c.has(h)||c.set(h,[]),c.get(h).push({globalIdx:f,localIdx:f-d.start,resultIdx:u});break}}}for(let[u,f]of c){let d=l[u].page,p=d.offsetsSize/d.rows;if(p!==4&&p!==8)continue;f.sort((w,E)=>w.localIdx-E.localIdx);let g=[],b=0;for(let w=1;w<=f.length;w++)(w===f.length||f[w].localIdx-f[w-1].localIdx>100)&&(g.push(f.slice(b,w)),b=w);let y=[];if(await Promise.all(g.map(async w=>{let E=w[0].localIdx,_=w[w.length-1].localIdx,S=E>0?E-1:0,A=_,R=d.offsetsStart+S*p,U=d.offsetsStart+(A+1)*p-1,C=await r.fetchRange(R,U),x=new DataView(C);for(let T of w){let N=T.localIdx-S,B,P;p===4?(P=x.getUint32(N*4,!0),B=T.localIdx===0?0:x.getUint32((N-1)*4,!0)):(P=Number(x.getBigUint64(N*8,!0)),B=T.localIdx===0?0:Number(x.getBigUint64((N-1)*8,!0))),P>B&&y.push({start:B,end:P,resultIdx:T.resultIdx,dataStart:d.dataStart})}})),y.length>0){y.sort((_,S)=>_.start-S.start);let w=[],E=0;for(let _=1;_<=y.length;_++)(_===y.length||y[_].start-y[_-1].end>4096)&&(w.push({rangeStart:y[E].start,rangeEnd:y[_-1].end,items:y.slice(E,_),dataStart:y[E].dataStart}),E=_);await Promise.all(w.map(async _=>{let S=await r.fetchRange(_.dataStart+_.rangeStart,_.dataStart+_.rangeEnd-1),A=new Uint8Array(S);for(let R of _.items){let U=R.start-_.rangeStart,C=R.end-R.start,x=A.slice(U,U+C);i[R.resultIdx]=new TextDecoder().decode(x)}}))}}return i}var ir=O(()=>{Je()});async function Rn(r,e){let t=await r.getColumnOffsetEntry(e);if(t.len===0)return{rows:0,dimension:0};let n=await r.fetchRange(t.pos,t.pos+t.len-1),s=r._parseColumnMeta(new Uint8Array(n));if(s.rows===0)return{rows:0,dimension:0};let o=0;if(s.pages&&s.pages.length>0){let i=s.pages[0],a=i.sizes.length>1?1:0,l=i.sizes[a]||0,c=i.rows||0;c>0&&l>0&&(o=Math.floor(l/(c*4)))}else s.size>0&&(o=Math.floor(s.size/(s.rows*4)));return{rows:s.rows,dimension:o}}async function ar(r,e,t){let n=await r.getColumnOffsetEntry(e),s=await r.fetchRange(n.pos,n.pos+n.len-1),o=r._parseColumnMeta(new Uint8Array(s));if(o.rows===0)return new Float32Array(0);if(t>=o.rows)return new Float32Array(0);let i=Math.floor(o.size/(o.rows*4));if(i===0)return new Float32Array(0);let a=o.offset+t*i*4,l=a+i*4-1,c=await r.fetchRange(a,l);return new Float32Array(c)}async function Tn(r,e,t){if(t.length===0)return[];let n=await r.getColumnOffsetEntry(e),s=await r.fetchRange(n.pos,n.pos+n.len-1),o=r._parseColumnMeta(new Uint8Array(s));if(o.rows===0)return t.map(()=>new Float32Array(0));let i=Math.floor(o.size/(o.rows*4));if(i===0)return t.map(()=>new Float32Array(0));let a=i*4,l=new Array(t.length),c=ee(t,a,a*50),u=6;for(let f=0;f<c.length;f+=u){let h=c.slice(f,f+u);await Promise.all(h.map(async d=>{try{let p=o.offset+d.startIdx*a,g=o.offset+(d.endIdx+1)*a-1,b=await r.fetchRange(p,g);for(let y of d.items){let w=(y.idx-d.startIdx)*a;l[y.origPos]=new Float32Array(b.slice(w,w+a))}}catch{for(let g of d.items)l[g.origPos]=new Float32Array(0)}}))}return l}function lr(r,e){if(r.length!==e.length)return 0;let t=0,n=0,s=0;for(let i=0;i<r.length;i++)t+=r[i]*e[i],n+=r[i]*r[i],s+=e[i]*e[i];let o=Math.sqrt(n)*Math.sqrt(s);return o===0?0:t/o}async function cr(r,e,t,n=10,s=null,o={}){let{nprobe:i=10}=o,a=await Rn(r,e);if(a.dimension===0||a.dimension!==t.length)throw new Error(`Dimension mismatch: query=${t.length}, column=${a.dimension}`);if(!r.hasIndex())throw new Error("No IVF index found. Vector search requires an IVF index for efficient querying.");if(r._ivfIndex.dimension!==t.length)throw new Error(`Query dimension (${t.length}) does not match index dimension (${r._ivfIndex.dimension}).`);return await ko(r,e,t,n,i,s)}async function ko(r,e,t,n,s,o){o&&o(0,100);let i=r._ivfIndex.findNearestPartitions(t,s),a=await r._ivfIndex.fetchPartitionRowIds(i);if(a&&a.length>0)return await Do(r,e,t,n,a,o);throw new Error("Failed to fetch row IDs from IVF index. Dataset may be missing auxiliary.idx or ivf_partitions.bin.")}async function Do(r,e,t,n,s,o){let i=t.length,a=new Map;for(let g of s)a.has(g.fragId)||a.set(g.fragId,[]),a.get(g.fragId).push(g.rowOffset);let l=[],c=[],u=0,f=s.length;for(let[g,b]of a){o&&o(u,f);let y=await Tn(r,e,b);for(let w=0;w<b.length;w++){let E=y[w];E&&E.length===i&&(l.push(E),c.push(g*5e4+b[w])),u++}}let h,d=q();d.isAvailable()&&(h=await d.batchCosineSimilarity(t,l,!0)),h||(h=r.lanceql.batchCosineSimilarity(t,l,!0));let p=[];for(let g=0;g<h.length;g++){let b=h[g],y=c[g];p.length<n?(p.push({idx:y,score:b}),p.sort((w,E)=>E.score-w.score)):b>p[n-1].score&&(p[n-1]={idx:y,score:b},p.sort((w,E)=>E.score-w.score))}return o&&o(f,f),{indices:p.map(g=>g.idx),scores:p.map(g=>g.score),usedIndex:!0,searchedRows:l.length}}async function ur(r,e){let t=await r.getColumnOffsetEntry(e),n=await r.fetchRange(t.pos,t.pos+t.len-1),s=r._parseColumnMeta(new Uint8Array(n));if(!s.pages||s.pages.length===0||s.rows===0)return new Float32Array(0);let o=s.pages[0],i=o.sizes.length>1?1:0,a=o.sizes[i]||0,l=o.rows||0;if(l===0||a===0)return new Float32Array(0);let c=Math.floor(a/(l*4));if(c===0)return new Float32Array(0);let u=s.rows,f=new Float32Array(u*c),h=s.pages.map(async(g,b)=>{let y=g.sizes.length>1?1:0,w=g.offsets[y]||0,E=g.sizes[y]||0;if(E===0)return{pageIdx:b,data:new Float32Array(0),rows:0};let _=await r.fetchRange(w,w+E-1),S=new Float32Array(_);return{pageIdx:b,data:S,rows:g.rows}}),d=await Promise.all(h),p=0;for(let g of d.sort((b,y)=>b.pageIdx-y.pageIdx))f.set(g.data,p),p+=g.rows*c;return f}async function fr(r,{offset:e=0,limit:t=50,columns:n=null}={}){let s=n||Array.from({length:r._numColumns},(h,d)=>d),o=await r.getRowCount(0),i=Math.min(e,o),a=Math.min(t,o-i);if(a<=0)return{columns:s.map(()=>[]),columnNames:r.columnNames.slice(0,s.length),total:o};let l=Array.from({length:a},(h,d)=>i+d),c=await r.detectColumnTypes(),u=s.map(async h=>{let d=c[h]||"unknown";try{switch(d){case"string":case"utf8":case"large_utf8":return await r.readStringsAtIndices(h,l);case"int64":return Array.from(await r.readInt64AtIndices(h,l));case"int32":return Array.from(await r.readInt32AtIndices(h,l));case"int16":return Array.from(await r.readInt16AtIndices(h,l));case"uint8":return Array.from(await r.readUint8AtIndices(h,l));case"float64":case"double":return Array.from(await r.readFloat64AtIndices(h,l));case"float32":case"float":return Array.from(await r.readFloat32AtIndices(h,l));case"bool":case"boolean":return await r.readBoolAtIndices(h,l);case"fixed_size_list":case"vector":let p=await r.readVectorsAtIndices(h,l);return Array.isArray(p)?p:Array.from(p);default:return await r.readStringsAtIndices(h,l)}}catch{return l.map(()=>null)}});return{columns:await Promise.all(u),columnNames:s.map(h=>r.columnNames[h]||`column_${h}`),total:o}}var hr=O(()=>{Je();le()});var mr={};Ee(mr,{RemoteLanceFile:()=>Ne});var Ne,At=O(()=>{at();St();Ks();Je();sr();ir();hr();Ne=class r{constructor(e,t,n,s){this.lanceql=e,this.wasm=e.wasm,this.memory=e.memory,this.url=t,this.fileSize=n;let o=new Uint8Array(s);if(this.footerPtr=this.wasm.alloc(o.length),!this.footerPtr)throw new Error("Failed to allocate memory for footer");this.footerLen=o.length,new Uint8Array(this.memory.buffer).set(o,this.footerPtr),this._numColumns=this.wasm.parseFooterGetColumns(this.footerPtr,this.footerLen),this._majorVersion=this.wasm.parseFooterGetMajorVersion(this.footerPtr,this.footerLen),this._minorVersion=this.wasm.parseFooterGetMinorVersion(this.footerPtr,this.footerLen),this._columnMetaStart=this.wasm.getColumnMetaStart(this.footerPtr,this.footerLen),this._columnMetaOffsetsStart=this.wasm.getColumnMetaOffsetsStart(this.footerPtr,this.footerLen),this._columnMetaCache=new Map,this._columnOffsetCache=new Map,this._columnTypes=null,this._schema=null,this._datasetBaseUrl=null,this._ivfIndex=null}static async open(e,t){let n=await fetch(t,{method:"HEAD"});if(!n.ok)throw new Error(`HTTP error: ${n.status}`);let s=n.headers.get("Content-Length");if(!s)throw new Error("Server did not return Content-Length");let o=parseInt(s,10),a=o-40,l=await fetch(t,{headers:{Range:`bytes=${a}-${o-1}`}});if(!l.ok&&l.status!==206)throw new Error(`HTTP error: ${l.status}`);let c=await l.arrayBuffer(),u=new Uint8Array(c),f=String.fromCharCode(u[36],u[37],u[38],u[39]);if(f!=="LANC")throw new Error(`Invalid Lance file: expected LANC magic, got "${f}"`);let h=new r(e,t,o,c);return await qs(h),await h._tryLoadIndex(),console.log(`[LanceQL] Loaded: ${h._numColumns} columns, ${(o/1024/1024).toFixed(1)}MB, schema: ${h._schema?"yes":"no"}, index: ${h.hasIndex()?"yes":"no"}`),h}async _tryLoadIndex(){if(this._datasetBaseUrl)try{this._ivfIndex=await ge.tryLoad(this._datasetBaseUrl)}catch{}}hasIndex(){return this._ivfIndex!==null&&this._ivfIndex.centroids!==null}get columnNames(){return js(this)}get schema(){return this._schema}get datasetBaseUrl(){return this._datasetBaseUrl}get numColumns(){return this._numColumns}get size(){return this.fileSize}get version(){return{major:this._majorVersion,minor:this._minorVersion}}get columnMetaStart(){return Number(this._columnMetaStart)}get columnMetaOffsetsStart(){return Number(this._columnMetaOffsetsStart)}async fetchRange(e,t){(e<0||t<e||t>=this.size)&&console.error(`Invalid range: ${e}-${t}, file size: ${this.size}`);let n=ae();if(n.enabled){let i=await n.getRange(this.url,e,t,this.size);return this._onFetch&&this._onFetch(i.byteLength,1),i}let s=await fetch(this.url,{headers:{Range:`bytes=${e}-${t}`}});if(!s.ok&&s.status!==206)throw console.error(`Fetch failed: ${s.status} for range ${e}-${t}`),new Error(`HTTP error: ${s.status}`);let o=await s.arrayBuffer();return this._onFetch&&this._onFetch(o.byteLength,1),o}onFetch(e){this._onFetch=e}close(){this.footerPtr&&(this.wasm.free(this.footerPtr,this.footerLen),this.footerPtr=null)}async getColumnOffsetEntry(e){if(e>=this._numColumns)return{pos:0,len:0};if(this._columnOffsetCache.has(e))return this._columnOffsetCache.get(e);let t=this.columnMetaOffsetsStart+e*16,n=await this.fetchRange(t,t+15),s=new DataView(n),o={pos:Number(s.getBigUint64(0,!0)),len:Number(s.getBigUint64(8,!0))};return this._columnOffsetCache.set(e,o),o}async getColumnDebugInfo(e){let t=await this.getColumnOffsetEntry(e);if(t.len===0)return{offset:0,size:0,rows:0};let n=await this.fetchRange(t.pos,t.pos+t.len-1),s=new Uint8Array(n);return this._parseColumnMeta(s)}_parseColumnMeta(e){return Qs(e)}_parseStringColumnMeta(e){return Qe(e)}_batchIndices(e,t,n=1024){return ee(e,t,n)}async _getCachedColumnMeta(e){if(this._columnMetaCache.has(e))return this._columnMetaCache.get(e);let t=await this.getColumnOffsetEntry(e);if(t.len===0)return null;let n=await this.fetchRange(t.pos,t.pos+t.len-1),s=new Uint8Array(n);return this._columnMetaCache.set(e,s),s}readInt64AtIndices(e,t){return Js(this,e,t)}readFloat64AtIndices(e,t){return Ys(this,e,t)}readInt32AtIndices(e,t){return Xs(this,e,t)}readFloat32AtIndices(e,t){return Zs(this,e,t)}readInt16AtIndices(e,t){return er(this,e,t)}readUint8AtIndices(e,t){return tr(this,e,t)}readBoolAtIndices(e,t){return nr(this,e,t)}readStringAt(e,t){return rr(this,e,t)}readStringsAtIndices(e,t){return or(this,e,t)}async getRowCount(e){return(await this.getColumnDebugInfo(e)).rows}detectColumnTypes(){return Hs(this)}getVectorInfo(e){return Rn(this,e)}readVectorAt(e,t){return ar(this,e,t)}readVectorsAtIndices(e,t){return Tn(this,e,t)}cosineSimilarity(e,t){return lr(e,t)}vectorSearch(e,t,n=10,s=null,o={}){return cr(this,e,t,n,s,o)}readVectorColumn(e){return ur(this,e)}readRows(e={}){return fr(this,e)}}});function dr(r,e,t){let n=0,s=0,o=0,i=0,a=0,l=()=>{let f=0,h=0;for(;a<r.length;){let d=r[a++];if(f|=(d&127)<<h,(d&128)===0)break;h+=7}return f};for(;a<r.length;){let f=l(),h=f>>3,d=f&7;if(d===0){let p=l();h===1?n=p:h===2?s=p:h===3?o=p:h===4&&(i=p)}else if(d===2){let p=l();a+=p}else d===5?a+=4:d===1&&(a+=8)}if(i===0)return null;let u=`_deletions/${e}-${s}-${o}.${n===0?"arrow":"bin"}`;return{fileType:n===0?"arrow":"bitmap",readVersion:s,id:o,numDeletedRows:i,path:u,url:`${t}/${u}`}}function zo(r){let e=new Set,t=0;r.length>=8&&String.fromCharCode(...r.slice(0,6))==="ARROW1"&&(t=8);let n=new DataView(r.buffer,r.byteOffset,r.byteLength);for(;t<r.length-4;)if(n.getInt32(t,!0)===-1){if(t+=4,t+4>r.length)break;let o=n.getInt32(t,!0);for(t+=4+o;t+4<=r.length&&n.getInt32(t,!0)!==-1;){let a=n.getInt32(t,!0);a>=0&&a<1e7&&e.add(a),t+=4}}else t++;return e}function $o(r){let e=new Set,t=new DataView(r.buffer,r.byteOffset,r.byteLength);if(r.length<8)return e;let n=t.getUint32(0,!0);if(n===12346||n===12347){let s=n===12347,o=4,i=t.getUint16(o,!0);o+=2;let a=o;o+=i*4;for(let l=0;l<i&&o<r.length;l++){let c=t.getUint16(a+l*4,!0),u=t.getUint16(a+l*4+2,!0)+1,f=c<<16;for(let h=0;h<u&&o+2<=r.length;h++){let d=t.getUint16(o,!0);e.add(f|d),o+=2}}}return e}async function pr(r,e){if(r._deletedRows.has(e))return r._deletedRows.get(e);let t=r._fragments[e];if(!t?.deletionFile){let i=new Set;return r._deletedRows.set(e,i),i}let{url:n,fileType:s,numDeletedRows:o}=t.deletionFile;console.log(`[LanceQL] Loading ${o} deletions from ${n} (${s})`);try{let i=await fetch(n);if(!i.ok){console.warn(`[LanceQL] Failed to load deletion file: ${i.status}`);let u=new Set;return r._deletedRows.set(e,u),u}let a=await i.arrayBuffer(),l=new Uint8Array(a),c;return s==="arrow"?c=zo(l):c=$o(l),console.log(`[LanceQL] Loaded ${c.size} deleted rows for fragment ${e}`),r._deletedRows.set(e,c),c}catch(i){console.error("[LanceQL] Error loading deletion file:",i);let a=new Set;return r._deletedRows.set(e,a),a}}var gr=O(()=>{});async function yr(r,e,t,n=10,s=null,o={}){let{normalized:i=!0,workerPool:a=null,useIndex:l=!0,nprobe:c=20}=o,u=e;if(u<0)throw new Error("No vector column found in dataset");let f=t.length;if(!r.hasIndex())throw new Error("No IVF index found. Vector search requires an IVF index for efficient querying.");if(r._ivfIndex.dimension!==f)throw new Error(`Query dimension (${f}) does not match index dimension (${r._ivfIndex.dimension}).`);if(!r._ivfIndex.hasPartitionIndex)throw new Error("IVF partition index (ivf_partitions.bin) not found. Required for efficient search.");return await Vo(r,t,n,u,c,s)}async function Vo(r,e,t,n,s,o){let i=r._ivfIndex.findNearestPartitions(e,s),a=await r._ivfIndex.fetchPartitionData(i,r._ivfIndex.dimension,(y,w)=>{if(o){let E=w>0?y/w:0;o(Math.floor(E*80),100)}});if(!a||a.rowIds.length===0)throw new Error("IVF index not available. This dataset requires ivf_vectors.bin for efficient search.");let{rowIds:l,vectors:c,preFlattened:u}=a,f=e.length,h=u?c.length/f:c.length,d=new Float32Array(h),p=q();if(p.isAvailable()){let y=p.getMaxVectorsPerBatch(f);if(u)for(let w=0;w<h;w+=y){let E=Math.min(w+y,h),_=E-w,S=c.subarray(w*f,E*f);try{let A=await p.batchCosineSimilarity(e,S,!0,!0);if(A){d.set(A,w);continue}}catch{}if(r.lanceql?.batchCosineSimilarityFlat){let A=r.lanceql.batchCosineSimilarityFlat(e,S,f,!0);d.set(A,w)}else for(let A=0;A<_;A++){let R=A*f,U=0;for(let C=0;C<f;C++)U+=e[C]*S[R+C];d[w+A]=U}}else for(let w=0;w<h;w+=y){let E=Math.min(w+y,h),_=c.slice(w,E);try{let S=await p.batchCosineSimilarity(e,_,!0,!1);if(S){d.set(S,w);continue}}catch{}for(let S=0;S<_.length;S++){let A=_[S];if(!A||A.length!==f)continue;let R=0;for(let U=0;U<f;U++)R+=e[U]*A[U];d[w+S]=R}}}else if(u)for(let y=0;y<h;y++){let w=y*f,E=0;for(let _=0;_<f;_++)E+=e[_]*c[w+_];d[y]=E}else for(let y=0;y<h;y++){let w=c[y];if(!w||w.length!==f)continue;let E=0;for(let _=0;_<f;_++)E+=e[_]*w[_];d[y]=E}o&&o(90,100);let g=new Array(l.length);for(let y=0;y<l.length;y++)g[y]={index:l[y],score:d[y]};let b=Math.min(t,g.length);return Wo(g,b),o&&o(100,100),{indices:g.slice(0,b).map(y=>y.index),scores:g.slice(0,b).map(y=>y.score),usedIndex:!0,searchedRows:l.length}}function Wo(r,e){if(e>=r.length||e<=0)return;let t=0,n=r.length-1;for(;t<n;){let s=t+n>>1;r[s].score>r[t].score&&Ye(r,t,s),r[n].score>r[t].score&&Ye(r,t,n),r[s].score>r[n].score&&Ye(r,s,n);let o=r[n].score,i=t;for(let a=t;a<n;a++)r[a].score>=o&&(Ye(r,i,a),i++);if(Ye(r,i,n),i===e-1)break;i<e-1?t=i+1:n=i-1}}function Ye(r,e,t){let n=r[e];r[e]=r[t],r[t]=n}function wr(r){if(!r._schema)return-1;for(let e=0;e<r._schema.length;e++){let t=r._schema[e];if(t.name==="embedding"||t.name==="vector"||t.type==="fixed_size_list"||t.type==="list")return e}return r._schema.length-1}var br=O(()=>{le()});function xn(r,e){let t=0;for(let n=0;n<r._fragments.length;n++){let s=r._fragments[n];if(e<t+s.numRows)return{fragmentIndex:n,localIndex:e-t};t+=s.numRows}return null}function ye(r,e){let t=new Map;for(let n of e){let s=xn(r,n);s&&(t.has(s.fragmentIndex)||t.set(s.fragmentIndex,{localIndices:[],globalIndices:[]}),t.get(s.fragmentIndex).localIndices.push(s.localIndex),t.get(s.fragmentIndex).globalIndices.push(n))}return t}async function vn(r,{offset:e=0,limit:t=50,columns:n=null,_isPrefetch:s=!1}={}){let o=[],i=0;for(let p=0;p<r._fragments.length;p++){let g=r._fragments[p],b=i,y=i+g.numRows;if(y>e&&b<e+t){let w=Math.max(0,e-b),E=Math.min(g.numRows,e+t-b);o.push({fragmentIndex:p,localOffset:w,localLimit:E-w,globalStart:b+w})}if(i=y,i>=e+t)break}if(o.length===0)return{columns:[],columnNames:r.columnNames,total:r._totalRows};let a=o.map(async p=>{let b=await(await r.openFragment(p.fragmentIndex)).readRows({offset:p.localOffset,limit:p.localLimit,columns:n});return{...p,result:b}}),l=await Promise.all(a);l.sort((p,g)=>p.globalStart-g.globalStart);let c=[],u=l[0]?.result.columnNames||r.columnNames,f=n?n.length:r._numColumns;for(let p=0;p<f;p++){let g=[];for(let b of l)b.result.columns[p]&&g.push(...b.result.columns[p]);c.push(g)}let h={columns:c,columnNames:u,total:r._totalRows},d=e+t;return!s&&d<r._totalRows&&t<=100&&jo(r,d,t,n),h}function jo(r,e,t,n){let s=`${e}-${t}-${n?.join(",")||"all"}`;if(r._prefetchCache?.has(s))return;r._prefetchCache||(r._prefetchCache=new Map);let o=vn(r,{offset:e,limit:t,columns:n,_isPrefetch:!0}).then(i=>{r._prefetchCache.set(s,i)}).catch(()=>{});r._prefetchCache.set(s,o)}async function Er(r,e,t){let n=ye(r,t),s=new Map,o=[];for(let[i,a]of n)o.push((async()=>{let c=await(await r.openFragment(i)).readStringsAtIndices(e,a.localIndices);for(let u=0;u<a.globalIndices.length;u++)s.set(a.globalIndices[u],c[u])})());return await Promise.all(o),t.map(i=>s.get(i)||null)}async function _r(r,e,t){let n=ye(r,t),s=new Map,o=[];for(let[i,a]of n)o.push((async()=>{let c=await(await r.openFragment(i)).readInt64AtIndices(e,a.localIndices);for(let u=0;u<a.globalIndices.length;u++)s.set(a.globalIndices[u],c[u])})());return await Promise.all(o),new BigInt64Array(t.map(i=>s.get(i)||0n))}async function Sr(r,e,t){let n=ye(r,t),s=new Map,o=[];for(let[i,a]of n)o.push((async()=>{let c=await(await r.openFragment(i)).readFloat64AtIndices(e,a.localIndices);for(let u=0;u<a.globalIndices.length;u++)s.set(a.globalIndices[u],c[u])})());return await Promise.all(o),new Float64Array(t.map(i=>s.get(i)||0))}async function Ar(r,e,t){let n=ye(r,t),s=new Map,o=[];for(let[i,a]of n)o.push((async()=>{let c=await(await r.openFragment(i)).readInt32AtIndices(e,a.localIndices);for(let u=0;u<a.globalIndices.length;u++)s.set(a.globalIndices[u],c[u])})());return await Promise.all(o),new Int32Array(t.map(i=>s.get(i)||0))}async function Cr(r,e,t){let n=ye(r,t),s=new Map,o=[];for(let[i,a]of n)o.push((async()=>{let c=await(await r.openFragment(i)).readFloat32AtIndices(e,a.localIndices);for(let u=0;u<a.globalIndices.length;u++)s.set(a.globalIndices[u],c[u])})());return await Promise.all(o),new Float32Array(t.map(i=>s.get(i)||0))}var Ir=O(()=>{});function Ko(r){let e={type:"SELECT",columns:"*",limit:null,offset:null,where:null},t=r.toUpperCase();if(t.includes("LIMIT")){let n=r.match(/LIMIT\s+(\d+)/i);n&&(e.limit=parseInt(n[1]))}if(t.includes("OFFSET")){let n=r.match(/OFFSET\s+(\d+)/i);n&&(e.offset=parseInt(n[1]))}return t.includes("WHERE")&&(e.where=!0),e}async function Rr(r,e){let t=Ko(e);if(t.type==="SELECT"&&t.columns==="*"&&!t.where){let u=t.limit||50,f=t.offset||0;return await r.readRows({offset:f,limit:u})}let n=r._fragments.map(async(u,f)=>{let h=await r.openFragment(f);try{return await h.executeSQL(e)}catch(d){return console.warn(`Fragment ${f} query failed:`,d),{columns:[],columnNames:[],total:0}}}),s=await Promise.all(n);if(s.length===0||s.every(u=>u.columns.length===0))return{columns:[],columnNames:r.columnNames,total:0};let o=s.find(u=>u.columns.length>0);if(!o)return{columns:[],columnNames:r.columnNames,total:0};let i=o.columns.length,a=o.columnNames,l=Array.from({length:i},()=>[]),c=0;for(let u of s){for(let f=0;f<i&&f<u.columns.length;f++)l[f].push(...u.columns[f]);c+=u.total}if(t.limit){let u=t.offset||0;for(let f=0;f<i;f++)l[f]=l[f].slice(u,u+t.limit)}return{columns:l,columnNames:a,total:c}}var Tr=O(()=>{});var xr={};Ee(xr,{RemoteLanceDataset:()=>It});var Ct,It,Nn=O(()=>{At();St();Wt();gr();br();Ir();Tr();Ct=new _e,It=class r{constructor(e,t){this.lanceql=e,this.baseUrl=t.replace(/\/$/,""),this._fragments=[],this._schema=null,this._totalRows=0,this._numColumns=0,this._onFetch=null,this._fragmentFiles=new Map,this._isRemote=!0,this._ivfIndex=null,this._deletedRows=new Map}static async open(e,t,n={}){let s=new r(e,t);s._requestedVersion=n.version||null;let o=n.version?`${t}@v${n.version}`:t;if(!n.skipCache){let a=await Ct.get(o);a&&a.schema&&a.fragments&&(s._schema=a.schema,s._fragments=a.fragments,s._numColumns=a.schema.length,s._totalRows=a.fragments.reduce((l,c)=>l+c.numRows,0),s._version=a.version,s._columnTypes=a.columnTypes||null,s._fromCache=!0)}return s._fromCache||(await s._tryLoadSidecar()||await s._loadManifest(),Ct.set(o,{schema:s._schema,fragments:s._fragments,version:s._version,columnTypes:s._columnTypes||null}).catch(()=>{})),await s._tryLoadIndex(),(n.prefetch??s._fragments.length<=5)&&s._fragments.length>0&&s._prefetchFragments(),s}async _tryLoadSidecar(){try{let e=`${this.baseUrl}/.meta.json`,t=await fetch(e);if(!t.ok)return!1;let n=await t.json();return!n.schema||!n.fragments?!1:(this._schema=n.schema.map(s=>({name:s.name,id:s.index,type:s.type})),this._fragments=n.fragments.map(s=>({id:s.id,path:s.data_files?.[0]||`${s.id}.lance`,numRows:s.num_rows,physicalRows:s.physical_rows||s.num_rows,url:`${this.baseUrl}/data/${s.data_files?.[0]||s.id+".lance"}`,deletionFile:s.has_deletions?{numDeletedRows:s.deleted_rows||0}:null})),this._numColumns=n.num_columns,this._totalRows=n.total_rows,this._version=n.lance_version,this._columnTypes=n.schema.map(s=>{let o=s.type;return o.startsWith("vector[")?"vector":o==="float64"||o==="double"?"float64":o==="float32"?"float32":o.includes("int")?o:o==="string"?"string":"unknown"}),!0)}catch{return!1}}_prefetchFragments(){let e=this._fragments.map((t,n)=>this.openFragment(n).catch(()=>null));Promise.all(e).catch(()=>{})}hasIndex(){return this._ivfIndex!==null&&this._ivfIndex.centroids!==null}async _tryLoadIndex(){try{this._ivfIndex=await ge.tryLoad(this.baseUrl)}catch{this._ivfIndex=null}}async _loadManifest(){let e=null,t=0;if(this._requestedVersion){t=this._requestedVersion;let n=`${this.baseUrl}/_versions/${t}.manifest`,s=await fetch(n);if(!s.ok)throw new Error(`Version ${t} not found (${s.status})`);e=new Uint8Array(await s.arrayBuffer())}else{let n=[1,5,10,20,50,100],s=await Promise.all(n.map(async l=>{try{let c=`${this.baseUrl}/_versions/${l}.manifest`;return(await fetch(c,{method:"HEAD"})).ok?l:0}catch{return 0}})),o=Math.max(...s);if(o>0)for(let l=o+1;l<=o+50;l++)try{let c=`${this.baseUrl}/_versions/${l}.manifest`;if((await fetch(c,{method:"HEAD"})).ok)o=l;else break}catch{break}if(t=o,t===0)throw new Error("No manifest found in dataset");let i=`${this.baseUrl}/_versions/${t}.manifest`,a=await fetch(i);if(!a.ok)throw new Error(`Failed to fetch manifest: ${a.status}`);e=new Uint8Array(await a.arrayBuffer())}this._version=t,this._latestVersion=this._requestedVersion?null:t,this._parseManifest(e)}async listVersions(){let e=[],t=this._latestVersion||100;return(await Promise.all(Array.from({length:t},(s,o)=>o+1).map(async s=>{try{let o=`${this.baseUrl}/_versions/${s}.manifest`;return(await fetch(o,{method:"HEAD"})).ok?s:0}catch{return 0}}))).filter(s=>s>0)}get version(){return this._version}_parseManifest(e){let t=new DataView(e.buffer,e.byteOffset),n=t.getUint32(0,!0),s=4+n,o;if(s+4<e.length){let f=t.getUint32(s,!0);f>0&&s+4+f<=e.length?o=e.slice(s+4,s+4+f):o=e.slice(4,4+n)}else o=e.slice(4,4+n);let i=0,a=[],l=[],c=()=>{let f=0,h=0;for(;i<o.length;){let d=o[i++];if(f|=(d&127)<<h,(d&128)===0)break;h+=7}return f},u=f=>{if(f===0)c();else if(f===2){let h=c();i+=h}else f===5?i+=4:f===1&&(i+=8)};for(;i<o.length;){let f=c(),h=f>>3,d=f&7;if(h===1&&d===2){let p=c(),g=i+p,b=null,y=null,w=null;for(;i<g;){let E=c(),_=E>>3,S=E&7;if(S===0){let A=c();_===3&&(y=A)}else if(S===2){let A=c(),R=o.slice(i,i+A);i+=A,_===2?b=new TextDecoder().decode(R):_===5&&(w=new TextDecoder().decode(R))}else u(S)}b&&a.push({name:b,id:y,type:w})}else if(h===2&&d===2){let p=c(),g=i+p,b=null,y=null,w=0,E=null;for(;i<g;){let _=c(),S=_>>3,A=_&7;if(A===0){let R=c();S===1?b=R:S===4&&(w=R)}else if(A===2){let R=c(),U=o.slice(i,i+R);if(i+=R,S===2){let C=0;for(;C<U.length;){let x=U[C++],T=x>>3,N=x&7;if(N===2){let B=0,P=0;for(;C<U.length;){let L=U[C++];if(B|=(L&127)<<P,(L&128)===0)break;P+=7}let F=U.slice(C,C+B);C+=B,T===1&&(y=new TextDecoder().decode(F))}else if(N===0)for(;C<U.length&&(U[C++]&128)!==0;);else N===5?C+=4:N===1&&(C+=8)}}else S===3&&(E=this._parseDeletionFile(U,b))}else u(A)}if(y){let _=E?w-E.numDeletedRows:w;l.push({id:b,path:y,numRows:_,physicalRows:w,deletionFile:E,url:`${this.baseUrl}/data/${y}`})}}else u(d)}this._schema=a,this._fragments=l,this._numColumns=a.length,this._totalRows=l.reduce((f,h)=>f+h.numRows,0)}_parseDeletionFile(e,t){return dr(e,t,this.baseUrl)}async _loadDeletedRows(e){return pr(this,e)}async isRowDeleted(e,t){return(await this._loadDeletedRows(e)).has(t)}get numColumns(){return this._numColumns}get rowCount(){return this._totalRows}async getRowCount(e=0){return this._totalRows}async readVectorAt(e,t){let n=this._getFragmentForRow(t);return n?await(await this.openFragment(n.fragmentIndex)).readVectorAt(e,n.localIndex):new Float32Array(0)}async getVectorInfo(e){if(this._fragments.length===0)return{rows:0,dimension:0};let n=await(await this.openFragment(0)).getVectorInfo(e);return n.dimension===0?{rows:0,dimension:0}:{rows:this._totalRows,dimension:n.dimension}}get columnNames(){return this._schema?this._schema.map(e=>e.name):[]}get schema(){return this._schema}get fragments(){return this._fragments}get size(){if(this._cachedSize)return this._cachedSize;let e=0;for(let t=0;t<(this._columnTypes?.length||0);t++){let n=this._columnTypes[t];if(n==="int64"||n==="float64"||n==="double")e+=8;else if(n==="int32"||n==="float32")e+=4;else if(n==="string")e+=50;else if(n==="vector"||n?.startsWith("vector[")){let s=n?.match(/\[(\d+)\]/),o=s?parseInt(s[1]):384;e+=o*4}else e+=8}return e===0&&(e=100),this._cachedSize=this._totalRows*e,this._cachedSize}onFetch(e){this._onFetch=e}async openFragment(e){if(e<0||e>=this._fragments.length)throw new Error(`Invalid fragment index: ${e}`);if(this._fragmentFiles.has(e))return this._fragmentFiles.get(e);let t=this._fragments[e],n=await Ne.open(this.lanceql,t.url);return this._onFetch&&n.onFetch(this._onFetch),this._fragmentFiles.set(e,n),n}async readRows(e={}){return vn(this,e)}async detectColumnTypes(){if(this._columnTypes&&this._columnTypes.length>0)return this._columnTypes;if(this._fragments.length===0)return[];let t=await(await this.openFragment(0)).detectColumnTypes();this._columnTypes=t;let n=this._requestedVersion?`${this.baseUrl}@v${this._requestedVersion}`:this.baseUrl;return Ct.get(n).then(s=>{s&&(s.columnTypes=t,Ct.set(n,s).catch(()=>{}))}).catch(()=>{}),t}_getFragmentForRow(e){return xn(this,e)}_groupIndicesByFragment(e){return ye(this,e)}async readStringsAtIndices(e,t){return Er(this,e,t)}async readInt64AtIndices(e,t){return _r(this,e,t)}async readFloat64AtIndices(e,t){return Sr(this,e,t)}async readInt32AtIndices(e,t){return Ar(this,e,t)}async readFloat32AtIndices(e,t){return Cr(this,e,t)}async vectorSearch(e,t,n=10,s=null,o={}){return yr(this,e,t,n,s,o)}_findVectorColumn(){return wr(this)}async executeSQL(e){return Rr(this,e)}close(){for(let e of this._fragmentFiles.values())e.close&&e.close();this._fragmentFiles.clear()}}});function Xo(){try{if(typeof SharedArrayBuffer<"u"&&typeof crossOriginIsolated<"u"&&crossOriginIsolated)return Xe=new SharedArrayBuffer(Yo),Rt="sharedBuffer",console.log("[LanceQL] Using SharedArrayBuffer (zero-copy)"),!0}catch{}try{let r=new ArrayBuffer(8);return typeof ArrayBuffer.prototype.transfer<"u",Rt="transfer",console.log("[LanceQL] Using Transferable ArrayBuffers"),!1}catch{}return Rt="clone",console.log("[LanceQL] Using structured clone (fallback)"),!1}function Zo(){return Ue||(Xo(),Un=new Promise((r,e)=>{console.log("[LanceQL] Using regular Worker for better logging");try{Ue=new Worker(new URL("./lanceql-worker.js?v="+Date.now(),import.meta.url),{type:"module",name:"lanceql"}),Ue.onmessage=t=>{ei(t.data,Ue,r)},Ue.onerror=t=>{console.error("[LanceQL] Worker error:",t),e(t)},Xe&&Ue.postMessage({type:"initSharedBuffer",buffer:Xe})}catch(t){console.error("[LanceQL] Failed to create Worker:",t),e(t)}})),Un}function ei(r,e,t){if(console.log("[LanceQL] Incoming worker message:",r.type||(r.id!==void 0?"RPC reply":"unknown")),r.type==="ready"){t(e);return}if(r.type==="log"){console.log(r.message);return}if(r.id!==void 0){let n=Pn.get(r.id);if(n)if(Pn.delete(r.id),r.sharedOffset!==void 0&&Xe){let s=new Uint8Array(Xe,r.sharedOffset,r.sharedLength),o=JSON.parse(new TextDecoder().decode(s));n.resolve(o)}else if(r.error)n.reject(new Error(r.error));else{let s=r.result;if(s&&s._format==="cursor"){let{cursorId:o,columns:i,rowCount:a}=s;s={_format:"columnar",columns:i,rowCount:a,_cursorId:o,_fetched:!1},Object.defineProperty(s,"data",{configurable:!0,enumerable:!0,get(){return this._fetched||console.warn("Cursor data accessed - fetching from worker"),{}}}),Object.defineProperty(s,"rows",{configurable:!0,enumerable:!0,get(){return[]}})}else if(s&&s._format==="wasm_binary"){let o=-9223372036854775808n,{buffer:i,columns:a,rowCount:l,schema:c}=s,u=new DataView(i),f=new Uint8Array(i),h=32,d=24,p={};for(let g=0;g<a.length;g++){let b=h+g*d,y=u.getUint32(b,!0),w=u.getUint32(b+8,!0),E=Number(u.getBigUint64(b+12,!0)),_=u.getUint32(b+20,!0),S=a[g];if(y<=3){let A=E/_;y===0?p[S]=new BigInt64Array(i,w,A):y===1?p[S]=new Float64Array(i,w,A):y===2?p[S]=new Int32Array(i,w,A):y===3&&(p[S]=new Float32Array(i,w,A))}else{let A=w,R=new Uint32Array(i,A,l),U=w+l*4,C=E-l*4,x=f.subarray(U,U+C),T=new TextDecoder,N=new Array(l),B=!1;p[S]=new Proxy(N,{get(P,F){if(F==="length")return l;if(typeof F=="string"&&!isNaN(F)){if(!B){for(let L=0;L<l;L++){let G=R[L],W=L<l-1?R[L+1]:C;P[L]=T.decode(x.subarray(G,W))}B=!0}return P[+F]}if(F===Symbol.iterator){if(!B){for(let L=0;L<l;L++){let G=R[L],W=L<l-1?R[L+1]:C;P[L]=T.decode(x.subarray(G,W))}B=!0}return()=>P[Symbol.iterator]()}return P[F]}})}}s={_format:"columnar",columns:a,rowCount:l,data:p},Object.defineProperty(s,"rows",{configurable:!0,enumerable:!0,get(){let g=new Array(l),b=a.map(y=>p[y]);for(let y=0;y<l;y++){let w={};for(let E=0;E<a.length;E++){let _=b[E][y];(_===o||typeof _=="number"&&isNaN(_))&&(_=null),w[a[E]]=_}g[y]=w}return Object.defineProperty(this,"rows",{value:g,writable:!1}),g}})}else if(s&&s._format==="packed"){let{columns:o,rowCount:i,packedBuffer:a,colOffsets:l,stringData:c}=s,u={...c||{}};if(a&&l){let f={Float64Array,Float32Array,Int32Array,Int16Array,Int8Array,Uint32Array,Uint16Array,Uint8Array,BigInt64Array,BigUint64Array};for(let[h,d]of Object.entries(l)){let p=f[d.type]||Float64Array;u[h]=new p(a,d.offset,d.length)}}s.data=u,s._format="columnar",Object.defineProperty(s,"rows",{configurable:!0,enumerable:!0,get(){let f=new Array(i),h=o.map(d=>u[d]);for(let d=0;d<i;d++){let p={};for(let g=0;g<o.length;g++)p[o[g]]=h[g][d];f[d]=p}return Object.defineProperty(this,"rows",{value:f,writable:!1}),f}})}else if(s&&s._format==="columnar"){let{columns:o,rowCount:i,data:a}=s;for(let l of o){let c=a[l];if(c&&c._arrowString){let{offsets:u,bytes:f,isList:h,nullable:d}=c;h&&console.log(`[WorkerRPC] Column ${l} is list mode`);let p=new TextDecoder,g=new Array(i),b=!1;a[l]=new Proxy(g,{get(y,w){if(w==="length")return i;if(typeof w=="string"&&!isNaN(w)){if(!b&&f&&u){for(let E=0;E<i;E++){let _=u[E],S=u[E+1];if(d&&_===S){y[E]=null;continue}let A=p.decode(f.subarray(_,S));try{y[E]=h?JSON.parse(A):A}catch{y[E]=A}}b=!0}return y[+w]}if(w===Symbol.iterator){if(!b&&f&&u){for(let E=0;E<i;E++){let _=u[E],S=u[E+1];if(d&&_===S){y[E]=null;continue}let A=p.decode(f.subarray(_,S));try{y[E]=h?JSON.parse(A):A}catch{y[E]=A}}b=!0}return()=>y[Symbol.iterator]()}return y[w]}})}}Object.defineProperty(s,"rows",{configurable:!0,enumerable:!0,get(){let l=new Array(i),c=o.map(u=>a[u]);for(let u=0;u<i;u++){let f={};for(let h=0;h<o.length;h++)f[o[h]]=c[h][u];l[u]=f}return Object.defineProperty(this,"rows",{value:l,writable:!1}),l}})}n.resolve(s)}}}async function M(r,e){let t=await Zo(),n=++Jo;return new Promise((s,o)=>{Pn.set(n,{resolve:s,reject:o});let i=[];if(Rt==="transfer"&&e)for(let a of Object.keys(e)){let l=e[a];l instanceof ArrayBuffer?i.push(l):ArrayBuffer.isView(l)&&i.push(l.buffer)}i.length>0?t.postMessage({id:n,method:r,args:e},i):t.postMessage({id:n,method:r,args:e})})}var Ue,Un,Jo,Pn,Rt,Xe,Yo,Tt=O(()=>{Ue=null,Un=null,Jo=0,Pn=new Map,Rt="clone",Xe=null,Yo=16*1024*1024});var Fn={};Ee(Fn,{LocalDatabase:()=>xt,OPFSJoinExecutor:()=>Pe});var Pe,xt,Ze=O(()=>{Tt();Pe=class{constructor(e=opfsStorage){this.storage=e,this.sessionId=`join_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,this.basePath=`_join_temp/${this.sessionId}`,this.numPartitions=64,this.chunkSize=1e3,this.stats={leftRowsWritten:0,rightRowsWritten:0,resultRowsWritten:0,bytesWrittenToOPFS:0,bytesReadFromOPFS:0,partitionsUsed:new Set}}async*executeHashJoin(e,t,n,s,o={}){let{limit:i=1/0,projection:a=null,leftAlias:l="left",rightAlias:c="right",joinType:u="INNER",prePartitionedLeft:f=null}=o;try{let h;f?h=f:h=await this._partitionToOPFS(e,n,"left");let d=await this._partitionToOPFS(t,s,"right"),p=0,g=new Array(h.columns.length).fill(null),b=new Array(d.columns.length).fill(null),y=[...h.columns.map(C=>`${l}.${C}`),...d.columns.map(C=>`${c}.${C}`)],w=function*(C){C.length>0&&(yield{columns:y,rows:C.splice(0)})};if(u==="CROSS"){let C=[];for(let x of h.partitionsUsed){let T=await this._loadPartition("left",x,h.columns);for(let N of d.partitionsUsed){let B=await this._loadPartition("right",N,d.columns);for(let P of T){for(let F of B){if(p>=i)break;C.push([...P,...F]),p++,C.length>=this.chunkSize&&(yield{columns:y,rows:C.splice(0)})}if(p>=i)break}if(p>=i)break}if(p>=i)break}C.length>0&&(yield{columns:y,rows:C});return}let E=h.columns.indexOf(n),_=d.columns.indexOf(s),S=u==="LEFT"||u==="FULL",A=u==="RIGHT"||u==="FULL",R=A?new Set:null,U=new Set([...h.partitionsUsed].filter(C=>d.partitionsUsed.has(C)));for(let C of U){if(p>=i)break;let x=await this._loadPartition("left",C,h.columns);if(x.length===0)continue;let T=new Map,N=S?new Set:null;for(let F=0;F<x.length;F++){let L=x[F],G=L[E];G!=null&&(T.has(G)||T.set(G,[]),T.get(G).push({row:L,index:F}))}let B=await this._loadPartition("right",C,d.columns),P=[];for(let F=0;F<B.length&&!(p>=i);F++){let L=B[F],G=L[_],W=T.get(G);if(W){R&&R.add(`${C}_${F}`);for(let{row:be,index:oe}of W){if(p>=i)break;N&&N.add(oe),P.push([...be,...L]),p++,P.length>=this.chunkSize&&(yield{columns:y,rows:P.splice(0)})}}}if(S&&N)for(let F=0;F<x.length&&!(p>=i);F++)N.has(F)||(P.push([...x[F],...b]),p++,P.length>=this.chunkSize&&(yield{columns:y,rows:P.splice(0)}));P.length>0&&(yield{columns:y,rows:P})}if(S)for(let C of h.partitionsUsed){if(p>=i)break;if(U.has(C))continue;let x=await this._loadPartition("left",C,h.columns),T=[];for(let N of x){if(p>=i)break;T.push([...N,...b]),p++,T.length>=this.chunkSize&&(yield{columns:y,rows:T.splice(0)})}T.length>0&&(yield{columns:y,rows:T})}if(A)for(let C of d.partitionsUsed){if(p>=i)break;let x=await this._loadPartition("right",C,d.columns),T=[];for(let N=0;N<x.length&&!(p>=i);N++){let B=`${C}_${N}`;R.has(B)||(T.push([...g,...x[N]]),p++,T.length>=this.chunkSize&&(yield{columns:y,rows:T.splice(0)}))}T.length>0&&(yield{columns:y,rows:T})}}finally{await this.cleanup()}}async _partitionToOPFS(e,t,n,s=!1){let o=new Map,i=500,a=null,l=-1,c=0,u=new Set,f=s?new Set:null;for await(let h of e){if(!a&&(a=h.columns,l=a.indexOf(t),l===-1))throw new Error(`Join key column '${t}' not found in columns: ${a.join(", ")}`);for(let d of h.rows){let p=d[l],g=this._hashToPartition(p);u.add(g),s&&p!==null&&p!==void 0&&f.add(p),o.has(g)||o.set(g,[]),o.get(g).push(d),c++,o.get(g).length>=i&&(await this._appendToPartition(n,g,o.get(g)),o.set(g,[]))}}for(let[h,d]of o)d.length>0&&await this._appendToPartition(n,h,d);return n==="left"?this.stats.leftRowsWritten=c:this.stats.rightRowsWritten=c,{columns:a,totalRows:c,partitionsUsed:u,collectedKeys:f}}_hashToPartition(e){if(e==null)return 0;let t=String(e),n=0;for(let s=0;s<t.length;s++){let o=t.charCodeAt(s);n=(n<<5)-n+o,n=n&n}return Math.abs(n)%this.numPartitions}async _appendToPartition(e,t,n){let s=`${this.basePath}/${e}/partition_${String(t).padStart(3,"0")}.jsonl`,o=n.map(l=>JSON.stringify(l)).join(`
`)+`
`,i=new TextEncoder().encode(o),a=await this.storage.load(s);if(a){let l=new Uint8Array(a.length+i.length);l.set(a),l.set(i,a.length),await this.storage.save(s,l),this.stats.bytesWrittenToOPFS+=i.length}else await this.storage.save(s,i),this.stats.bytesWrittenToOPFS+=i.length;this.stats.partitionsUsed.add(t)}async _loadPartition(e,t,n){let s=`${this.basePath}/${e}/partition_${String(t).padStart(3,"0")}.jsonl`,o=await this.storage.load(s);return o?(this.stats.bytesReadFromOPFS+=o.length,new TextDecoder().decode(o).trim().split(`
`).filter(l=>l).map(l=>JSON.parse(l))):[]}getStats(){return{...this.stats,partitionsUsed:this.stats.partitionsUsed.size,bytesWrittenMB:(this.stats.bytesWrittenToOPFS/1024/1024).toFixed(2),bytesReadMB:(this.stats.bytesReadFromOPFS/1024/1024).toFixed(2)}}async cleanup(){try{await this.storage.deleteDir(this.basePath)}catch{}}},xt=class{constructor(e){this.name=e,this._ready=!1}async open(){return this._ready?this:(await M("db:open",{name:this.name}),this._ready=!0,this)}async _ensureOpen(){this._ready||await this.open()}async createTable(e,t,n=!1){return await this._ensureOpen(),M("db:createTable",{db:this.name,tableName:e,columns:t,ifNotExists:n})}async dropTable(e,t=!1){return await this._ensureOpen(),M("db:dropTable",{db:this.name,tableName:e,ifExists:t})}async insert(e,t){return await this._ensureOpen(),M("db:insert",{db:this.name,tableName:e,rows:t})}async flush(){return await this._ensureOpen(),M("db:flush",{db:this.name})}async delete(e,t=null){return await this._ensureOpen(),M("db:delete",{db:this.name,tableName:e,where:t})}async update(e,t,n=null){return await this._ensureOpen(),M("db:update",{db:this.name,tableName:e,updates:t,where:n})}async select(e,t={}){await this._ensureOpen();let n={...t};return delete n.where,M("db:select",{db:this.name,tableName:e,options:n,where:t.whereAST||null})}async exec(e){return await this._ensureOpen(),M("db:exec",{db:this.name,sql:e})}async getTable(e){return await this._ensureOpen(),M("db:getTable",{db:this.name,tableName:e})}async listTables(){return await this._ensureOpen(),M("db:listTables",{db:this.name})}async compact(){return await this._ensureOpen(),M("db:compact",{db:this.name})}async*scan(e,t={}){await this._ensureOpen();let n=await M("db:scanStart",{db:this.name,tableName:e,options:t});for(;;){let{batch:s,done:o}=await M("db:scanNext",{db:this.name,streamId:n});if(s.length>0&&(yield s),o)break}}async close(){await this._ensureOpen(),await this.flush()}}});var On={};Ee(On,{LanceFileWriter:()=>Pt,LanceQL:()=>nt,LocalSQLParser:()=>Ut,wasmUtils:()=>Mr});var Ut,tt,Fr,v,D,ne,Be,Ur,Pr,ti,ni,si,Pt,Mr,ri,nt,st=O(()=>{le();Ut=class{constructor(e){this.tokens=e,this.pos=0}peek(){return this.tokens[this.pos]||{type:TokenType.EOF}}advance(){return this.tokens[this.pos++]||{type:TokenType.EOF}}match(e){return this.peek().type===e?this.advance():null}expect(e){let t=this.advance();if(t.type!==e)throw new Error(`Expected ${e}, got ${t.type}`);return t}parse(){let e=this.peek();switch(e.type){case TokenType.CREATE:return this.parseCreate();case TokenType.DROP:return this.parseDrop();case TokenType.INSERT:return this.parseInsert();case TokenType.UPDATE:return this.parseUpdate();case TokenType.DELETE:return this.parseDelete();case TokenType.SELECT:return this.parseSelect();default:throw new Error(`Unexpected token: ${e.type}`)}}parseCreate(){this.expect(TokenType.CREATE),this.expect(TokenType.TABLE);let e=this.expect(TokenType.IDENTIFIER).value;this.expect(TokenType.LPAREN);let t=[];do{let n=this.expect(TokenType.IDENTIFIER).value,s=this.parseDataType(),o={name:n,type:s};this.match(TokenType.PRIMARY)&&(this.expect(TokenType.KEY),o.primaryKey=!0),t.push(o)}while(this.match(TokenType.COMMA));return this.expect(TokenType.RPAREN),{type:"create_table",table:e,columns:t}}parseDataType(){let e=this.advance(),t=e.value||e.type;if(t==="VECTOR"&&this.match(TokenType.LPAREN)){let n=this.expect(TokenType.NUMBER).value;return this.expect(TokenType.RPAREN),{type:"vector",dim:parseInt(n)}}return(t==="VARCHAR"||t==="TEXT")&&this.match(TokenType.LPAREN)&&(this.expect(TokenType.NUMBER),this.expect(TokenType.RPAREN)),t}parseDrop(){return this.expect(TokenType.DROP),this.expect(TokenType.TABLE),{type:"drop_table",table:this.expect(TokenType.IDENTIFIER).value}}parseInsert(){this.expect(TokenType.INSERT),this.expect(TokenType.INTO);let e=this.expect(TokenType.IDENTIFIER).value,t=null;if(this.match(TokenType.LPAREN)){for(t=[this.expect(TokenType.IDENTIFIER).value];this.match(TokenType.COMMA);)t.push(this.expect(TokenType.IDENTIFIER).value);this.expect(TokenType.RPAREN)}this.expect(TokenType.VALUES);let n=[];do{this.expect(TokenType.LPAREN);let s=[this.parseValue()];for(;this.match(TokenType.COMMA);)s.push(this.parseValue());if(this.expect(TokenType.RPAREN),t){let o={};t.forEach((i,a)=>o[i]=s[a]),n.push(o)}else n.push(s)}while(this.match(TokenType.COMMA));return{type:"insert",table:e,columns:t,rows:n}}parseValue(){let e=this.peek();if(e.type===TokenType.NUMBER){this.advance();let t=parseFloat(e.value);return Number.isInteger(t)?parseInt(e.value):t}if(e.type===TokenType.STRING)return this.advance(),e.value;if(e.type===TokenType.NULL)return this.advance(),null;if(e.type===TokenType.TRUE)return this.advance(),!0;if(e.type===TokenType.FALSE)return this.advance(),!1;if(this.match(TokenType.LBRACKET)){let t=[];do t.push(parseFloat(this.expect(TokenType.NUMBER).value));while(this.match(TokenType.COMMA));return this.expect(TokenType.RBRACKET),t}throw new Error(`Unexpected value token: ${e.type}`)}parseUpdate(){this.expect(TokenType.UPDATE);let e=this.expect(TokenType.IDENTIFIER).value;this.expect(TokenType.SET);let t={};do{let s=this.expect(TokenType.IDENTIFIER).value;this.expect(TokenType.EQ),t[s]=this.parseValue()}while(this.match(TokenType.COMMA));let n=null;return this.match(TokenType.WHERE)&&(n=this.parseWhereExpr()),{type:"update",table:e,set:t,where:n}}parseDelete(){this.expect(TokenType.DELETE),this.expect(TokenType.FROM);let e=this.expect(TokenType.IDENTIFIER).value,t=null;return this.match(TokenType.WHERE)&&(t=this.parseWhereExpr()),{type:"delete",table:e,where:t}}parseSelect(){this.expect(TokenType.SELECT);let e=[];if(this.match(TokenType.STAR))e.push("*");else for(e.push(this.expect(TokenType.IDENTIFIER).value);this.match(TokenType.COMMA);)e.push(this.expect(TokenType.IDENTIFIER).value);this.expect(TokenType.FROM);let t=this.expect(TokenType.IDENTIFIER).value,n=null;this.match(TokenType.WHERE)&&(n=this.parseWhereExpr());let s=null;if(this.match(TokenType.ORDER)){this.expect(TokenType.BY);let a=this.expect(TokenType.IDENTIFIER).value,l=!!this.match(TokenType.DESC);l||this.match(TokenType.ASC),s={column:a,desc:l}}let o=null;this.match(TokenType.LIMIT)&&(o=parseInt(this.expect(TokenType.NUMBER).value));let i=null;return this.match(TokenType.OFFSET)&&(i=parseInt(this.expect(TokenType.NUMBER).value)),{type:"select",table:t,columns:e,where:n,orderBy:s,limit:o,offset:i}}parseWhereExpr(){return this.parseOrExpr()}parseOrExpr(){let e=this.parseAndExpr();for(;this.match(TokenType.OR);){let t=this.parseAndExpr();e={op:"OR",left:e,right:t}}return e}parseAndExpr(){let e=this.parseComparison();for(;this.match(TokenType.AND);){let t=this.parseComparison();e={op:"AND",left:e,right:t}}return e}parseComparison(){let e=this.expect(TokenType.IDENTIFIER).value,t;if(this.match(TokenType.EQ))t="=";else if(this.match(TokenType.NE))t="!=";else if(this.match(TokenType.LT))t="<";else if(this.match(TokenType.LE))t="<=";else if(this.match(TokenType.GT))t=">";else if(this.match(TokenType.GE))t=">=";else if(this.match(TokenType.LIKE))t="LIKE";else throw new Error("Expected comparison operator");let n=this.parseValue();return{op:t,column:e,value:n}}},tt=new TextEncoder,Fr=new TextDecoder,ne=0,Be=0,Ur=()=>!ne||!Be?null:new Uint8Array(D.buffer,ne,Be),Pr=r=>ne&&r<=Be?!0:(ne&&v.free&&v.free(ne,Be),Be=Math.max(r+1024,4096),ne=v.alloc(Be),ne!==0),ti=r=>{if(r instanceof Uint8Array)return Pr(r.length)?(Ur().set(r),[ne,r.length]):[r];if(typeof r!="string")return[r];let e=tt.encode(r);return Pr(e.length)?(Ur().set(e),[ne,e.length]):[r]},ni=(r,e)=>Fr.decode(new Uint8Array(D.buffer,r,e)),si=(r,e)=>new Uint8Array(D.buffer,r,e).slice(),Pt=class{constructor(e){this.schema=e,this.columns=new Map,this.rowCount=0}addRows(e){for(let t of e){for(let n of this.schema)this.columns.has(n.name)||this.columns.set(n.name,[]),this.columns.get(n.name).push(t[n.name]??null);this.rowCount++}}build(){if(!v?.fragmentBegin)return this._buildJson();let e=Math.max(64*1024,this.rowCount*1024);if(!v.fragmentBegin(e))throw new Error("Failed to initialize WASM fragment writer");for(let s of this.schema){let o=this.columns.get(s.name)||[];this._addColumn(s,o)}let t=v.fragmentEnd();if(t===0)throw new Error("Failed to finalize fragment");let n=v.writerGetBuffer();if(!n)throw new Error("Failed to get writer buffer");return new Uint8Array(D.buffer,n,t).slice()}_addColumn(e,t){let n=(e.type||e.dataType||"string").toLowerCase(),s=e.nullable!==!1,o=tt.encode(e.name),i=v.alloc(o.length);new Uint8Array(D.buffer,i,o.length).set(o);let a=0;switch(n){case"int64":case"int":case"integer":case"bigint":{let l=new BigInt64Array(t.map(u=>BigInt(u??0))),c=v.alloc(l.byteLength);new BigInt64Array(D.buffer,c,t.length).set(l),a=v.fragmentAddInt64Column(i,o.length,c,t.length,s),v.free(c,l.byteLength);break}case"int32":{let l=new Int32Array(t.map(u=>u??0)),c=v.alloc(l.byteLength);new Int32Array(D.buffer,c,t.length).set(l),a=v.fragmentAddInt32Column(i,o.length,c,t.length,s),v.free(c,l.byteLength);break}case"float64":case"float":case"double":{let l=new Float64Array(t.map(u=>u??0)),c=v.alloc(l.byteLength);new Float64Array(D.buffer,c,t.length).set(l),a=v.fragmentAddFloat64Column(i,o.length,c,t.length,s),v.free(c,l.byteLength);break}case"float32":{let l=new Float32Array(t.map(u=>u??0)),c=v.alloc(l.byteLength);new Float32Array(D.buffer,c,t.length).set(l),a=v.fragmentAddFloat32Column(i,o.length,c,t.length,s),v.free(c,l.byteLength);break}case"string":case"text":case"varchar":{let l=0,c=new Uint32Array(t.length+1),u=[];for(let p=0;p<t.length;p++){c[p]=l;let g=tt.encode(String(t[p]??""));u.push(...g),l+=g.length}c[t.length]=l;let f=new Uint8Array(u),h=v.alloc(f.length);new Uint8Array(D.buffer,h,f.length).set(f);let d=v.alloc(c.byteLength);new Uint32Array(D.buffer,d,c.length).set(c),a=v.fragmentAddStringColumn(i,o.length,h,f.length,d,t.length,s),v.free(h,f.length),v.free(d,c.byteLength);break}case"bool":case"boolean":{let l=Math.ceil(t.length/8),c=new Uint8Array(l);for(let f=0;f<t.length;f++)t[f]&&(c[Math.floor(f/8)]|=1<<f%8);let u=v.alloc(c.length);new Uint8Array(D.buffer,u,c.length).set(c),a=v.fragmentAddBoolColumn(i,o.length,u,c.length,t.length,s),v.free(u,c.length);break}case"vector":{let l=e.vectorDim||t[0]?.length||0,c=[];for(let h of t)if(Array.isArray(h))c.push(...h);else for(let d=0;d<l;d++)c.push(0);let u=new Float32Array(c),f=v.alloc(u.byteLength);new Float32Array(D.buffer,f,c.length).set(u),a=v.fragmentAddVectorColumn(i,o.length,f,c.length,l,s),v.free(f,u.byteLength);break}default:return v.free(i,o.length),this._addColumn({...e,type:"string"},t)}if(v.free(i,o.length),!a)throw new Error(`Failed to add column '${e.name}'`)}_buildJson(){let e={schema:this.schema,columns:Object.fromEntries(this.columns),rowCount:this.rowCount,format:"json"};return tt.encode(JSON.stringify(e))}},Mr={readStr:ni,readBytes:si,encoder:tt,decoder:Fr,getMemory:()=>D,getExports:()=>v},ri=r=>({getVersion(){let e=v.getVersion(),t=e>>16&255,n=e>>8&255,s=e&255;return`${t}.${n}.${s}`},open(e){return new LanceFile(r,e)},async openUrl(e){return await q().init(),await RemoteLanceFile.open(r,e)},async openDataset(e,t={}){return await q().init(),await RemoteLanceDataset.open(r,e,t)},parseFooter(e){let t=new Uint8Array(e),n=v.alloc(t.length);if(!n)return null;try{new Uint8Array(D.buffer).set(t,n);let s=v.parseFooterGetColumns(n,t.length),o=v.parseFooterGetMajorVersion(n,t.length),i=v.parseFooterGetMinorVersion(n,t.length);return s===0&&o===0?null:{numColumns:s,majorVersion:o,minorVersion:i}}finally{v.free(n,t.length)}},isValidLanceFile(e){let t=new Uint8Array(e),n=v.alloc(t.length);if(!n)return!1;try{return new Uint8Array(D.buffer).set(t,n),v.isValidLanceFile(n,t.length)===1}finally{v.free(n,t.length)}},createDatabase(){return typeof window<"u"?window.lanceql=r:typeof globalThis<"u"&&(globalThis.lanceql=r),new LanceDatabase}}),nt=class{static async load(e="./lanceql.wasm"){let n=await(await fetch(e)).arrayBuffer();v=(await WebAssembly.instantiate(n,{})).instance.exports,D=v.memory;let o=null,i=new Proxy({},{get(a,l){return o||(o=ri(i)),l in o?o[l]:l==="memory"?D:l==="raw"||l==="wasm"?v:typeof v[l]=="function"?(...c)=>v[l](...c.flatMap(ti)):v[l]}});return i}}});Wt();ot();at();le();var Se=class{constructor(){this.device=null,this.pipelines=new Map,this.available=!1,this._initPromise=null}async init(){return this._initPromise?this._initPromise:(this._initPromise=this._doInit(),this._initPromise)}async _doInit(){if(!navigator.gpu)return!1;try{let e=await navigator.gpu.requestAdapter();return e?(this.device=await e.requestDevice({requiredLimits:{maxStorageBufferBindingSize:256*1024*1024}}),this._compileShaders(),this.available=!0,console.log("[GPUAggregator] Initialized"),!0):!1}catch(e){return console.warn("[GPUAggregator] Init failed:",e),!1}}_compileShaders(){let t=this.device.createShaderModule({code:`
struct P { size: u32, wg: u32 }
@group(0) @binding(0) var<uniform> p: P;
@group(0) @binding(1) var<storage, read> i: array<f32>;
@group(0) @binding(2) var<storage, read_write> o: array<f32>;
var<workgroup> s: array<f32, 256>;

@compute @workgroup_size(256)
fn sum(@builtin(global_invocation_id) g: vec3<u32>, @builtin(local_invocation_id) l: vec3<u32>, @builtin(workgroup_id) w: vec3<u32>) {
    s[l.x] = select(0.0, i[g.x], g.x < p.size);
    workgroupBarrier();
    for (var t: u32 = 128u; t > 0u; t >>= 1u) { if (l.x < t) { s[l.x] += s[l.x + t]; } workgroupBarrier(); }
    if (l.x == 0u) { o[w.x] = s[0]; }
}

@compute @workgroup_size(256)
fn sum_f(@builtin(local_invocation_id) l: vec3<u32>) {
    s[l.x] = select(0.0, i[l.x], l.x < p.wg);
    workgroupBarrier();
    for (var t: u32 = 128u; t > 0u; t >>= 1u) { if (l.x < t) { s[l.x] += s[l.x + t]; } workgroupBarrier(); }
    if (l.x == 0u) { o[0] = s[0]; }
}

@compute @workgroup_size(256)
fn min_r(@builtin(global_invocation_id) g: vec3<u32>, @builtin(local_invocation_id) l: vec3<u32>, @builtin(workgroup_id) w: vec3<u32>) {
    s[l.x] = select(3.4e+38, i[g.x], g.x < p.size);
    workgroupBarrier();
    for (var t: u32 = 128u; t > 0u; t >>= 1u) { if (l.x < t) { s[l.x] = min(s[l.x], s[l.x + t]); } workgroupBarrier(); }
    if (l.x == 0u) { o[w.x] = s[0]; }
}

@compute @workgroup_size(256)
fn min_f(@builtin(local_invocation_id) l: vec3<u32>) {
    s[l.x] = select(3.4e+38, i[l.x], l.x < p.wg);
    workgroupBarrier();
    for (var t: u32 = 128u; t > 0u; t >>= 1u) { if (l.x < t) { s[l.x] = min(s[l.x], s[l.x + t]); } workgroupBarrier(); }
    if (l.x == 0u) { o[0] = s[0]; }
}

@compute @workgroup_size(256)
fn max_r(@builtin(global_invocation_id) g: vec3<u32>, @builtin(local_invocation_id) l: vec3<u32>, @builtin(workgroup_id) w: vec3<u32>) {
    s[l.x] = select(-3.4e+38, i[g.x], g.x < p.size);
    workgroupBarrier();
    for (var t: u32 = 128u; t > 0u; t >>= 1u) { if (l.x < t) { s[l.x] = max(s[l.x], s[l.x + t]); } workgroupBarrier(); }
    if (l.x == 0u) { o[w.x] = s[0]; }
}

@compute @workgroup_size(256)
fn max_f(@builtin(local_invocation_id) l: vec3<u32>) {
    s[l.x] = select(-3.4e+38, i[l.x], l.x < p.wg);
    workgroupBarrier();
    for (var t: u32 = 128u; t > 0u; t >>= 1u) { if (l.x < t) { s[l.x] = max(s[l.x], s[l.x + t]); } workgroupBarrier(); }
    if (l.x == 0u) { o[0] = s[0]; }
}`});for(let[n,s]of[["sum","sum"],["sum_final","sum_f"],["min","min_r"],["min_final","min_f"],["max","max_r"],["max_final","max_f"]])this.pipelines.set(n,this.device.createComputePipeline({layout:"auto",compute:{module:t,entryPoint:s}}))}isAvailable(){return this.available}async sum(e){return!this.available||e.length<1e3?this._cpuSum(e):this._gpuReduce(e,"sum")}async min(e){return!this.available||e.length<1e3?e.length?Math.min(...e):null:this._gpuReduce(e,"min")}async max(e){return!this.available||e.length<1e3?e.length?Math.max(...e):null:this._gpuReduce(e,"max")}async avg(e){return e.length===0?null:await this.sum(e)/e.length}count(e){return e.length}async _gpuReduce(e,t){let n=e.length,s=256,o=Math.ceil(n/s),i=e instanceof Float32Array?e:new Float32Array(e),a=this.device.createBuffer({size:i.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});this.device.queue.writeBuffer(a,0,i);let l=this.device.createBuffer({size:o*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),c=this.device.createBuffer({size:4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),u=this.device.createBuffer({size:4,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),f=this.device.createBuffer({size:8,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});this.device.queue.writeBuffer(f,0,new Uint32Array([n,o]));let h=this.device.createBuffer({size:8,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});this.device.queue.writeBuffer(h,0,new Uint32Array([o,o]));let d=this.pipelines.get(t),p=this.pipelines.get(t+"_final"),g=this.device.createBindGroup({layout:d.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:f}},{binding:1,resource:{buffer:a}},{binding:2,resource:{buffer:l}}]}),b=this.device.createBindGroup({layout:p.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:h}},{binding:1,resource:{buffer:l}},{binding:2,resource:{buffer:c}}]}),y=this.device.createCommandEncoder(),w=y.beginComputePass();w.setPipeline(d),w.setBindGroup(0,g),w.dispatchWorkgroups(o),w.end();let E=y.beginComputePass();E.setPipeline(p),E.setBindGroup(0,b),E.dispatchWorkgroups(1),E.end(),y.copyBufferToBuffer(c,0,u,0,4),this.device.queue.submit([y.finish()]),await u.mapAsync(GPUMapMode.READ);let _=new Float32Array(u.getMappedRange())[0];return u.unmap(),a.destroy(),l.destroy(),c.destroy(),u.destroy(),f.destroy(),h.destroy(),_}_cpuSum(e){let t=0;for(let n=0;n<e.length;n++)t+=e[n];return t}},Ht=null;function qr(){return Ht||(Ht=new Se),Ht}var Ae=class{constructor(){this.device=null,this.pipelines=new Map,this.available=!1,this._initPromise=null}async init(){return this._initPromise?this._initPromise:(this._initPromise=this._doInit(),this._initPromise)}async _doInit(){if(!navigator.gpu)return!1;try{let e=await navigator.gpu.requestAdapter();return e?(this.device=await e.requestDevice({requiredLimits:{maxStorageBufferBindingSize:256*1024*1024}}),this._compileShaders(),this.available=!0,console.log("[GPUJoiner] Initialized"),!0):!1}catch(e){return console.warn("[GPUJoiner] Init failed:",e),!1}}_compileShaders(){let t=this.device.createShaderModule({code:`
struct BP { size: u32, cap: u32 }
struct PP { left_size: u32, cap: u32, max_matches: u32 }
@group(0) @binding(0) var<uniform> bp: BP;
@group(0) @binding(1) var<storage, read> bkeys: array<u32>;
@group(0) @binding(2) var<storage, read_write> ht: array<atomic<u32>>;

fn fnv(k: u32) -> u32 {
    var h = 2166136261u;
    h ^= (k & 0xFFu); h *= 16777619u;
    h ^= ((k >> 8u) & 0xFFu); h *= 16777619u;
    h ^= ((k >> 16u) & 0xFFu); h *= 16777619u;
    h ^= ((k >> 24u) & 0xFFu); h *= 16777619u;
    return h;
}

@compute @workgroup_size(256)
fn build(@builtin(global_invocation_id) g: vec3<u32>) {
    if (g.x >= bp.size) { return; }
    let k = bkeys[g.x];
    var s = fnv(k) % bp.cap;
    for (var p = 0u; p < bp.cap; p++) {
        let i = s * 2u;
        let o = atomicCompareExchangeWeak(&ht[i], 0xFFFFFFFFu, k);
        if (o.exchanged) { atomicStore(&ht[i + 1u], g.x); return; }
        s = (s + 1u) % bp.cap;
    }
}

@group(0) @binding(0) var<uniform> pp: PP;
@group(0) @binding(1) var<storage, read> lkeys: array<u32>;
@group(0) @binding(2) var<storage, read> pht: array<u32>;
@group(0) @binding(3) var<storage, read_write> matches: array<u32>;
@group(0) @binding(4) var<storage, read_write> mc: atomic<u32>;

@compute @workgroup_size(256)
fn probe(@builtin(global_invocation_id) g: vec3<u32>) {
    if (g.x >= pp.left_size) { return; }
    let k = lkeys[g.x];
    var s = fnv(k) % pp.cap;
    for (var p = 0u; p < pp.cap; p++) {
        let i = s * 2u;
        let sk = pht[i];
        if (sk == 0xFFFFFFFFu) { return; }
        if (sk == k) {
            let ri = pht[i + 1u];
            let o = atomicAdd(&mc, 1u);
            if (o * 2u + 1u < pp.max_matches * 2u) {
                matches[o * 2u] = g.x;
                matches[o * 2u + 1u] = ri;
            }
        }
        s = (s + 1u) % pp.cap;
    }
}

struct IP { cap: u32 }
@group(0) @binding(0) var<uniform> ip: IP;
@group(0) @binding(1) var<storage, read_write> it: array<u32>;

@compute @workgroup_size(256)
fn init_t(@builtin(global_invocation_id) g: vec3<u32>) {
    if (g.x >= ip.cap * 2u) { return; }
    it[g.x] = select(0u, 0xFFFFFFFFu, g.x % 2u == 0u);
}`});this.pipelines.set("init",this.device.createComputePipeline({layout:"auto",compute:{module:t,entryPoint:"init_t"}})),this.pipelines.set("build",this.device.createComputePipeline({layout:"auto",compute:{module:t,entryPoint:"build"}})),this.pipelines.set("probe",this.device.createComputePipeline({layout:"auto",compute:{module:t,entryPoint:"probe"}}))}isAvailable(){return this.available}async hashJoin(e,t,n,s){let o=e.length,i=t.length;if(!this.available||o*i<1e8)return this._cpuHashJoin(e,t,n,s);let a=this._extractKeys(e,n),l=this._extractKeys(t,s),c=this._nextPow2(i*2),u=Math.max(o*10,1e5),f=this._createBuf(l,GPUBufferUsage.STORAGE),h=this._createBuf(a,GPUBufferUsage.STORAGE),d=this.device.createBuffer({size:c*2*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),p=this.device.createBuffer({size:u*2*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),g=this.device.createBuffer({size:4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),b=this.device.createBuffer({size:4,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),y=this._createUniform(new Uint32Array([c])),w=this._createUniform(new Uint32Array([i,c])),E=this._createUniform(new Uint32Array([o,c,u])),_=this.pipelines.get("init"),S=this.pipelines.get("build"),A=this.pipelines.get("probe"),R=this.device.createBindGroup({layout:_.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:y}},{binding:1,resource:{buffer:d}}]}),U=this.device.createBindGroup({layout:S.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:w}},{binding:1,resource:{buffer:f}},{binding:2,resource:{buffer:d}}]}),C=this.device.createBindGroup({layout:A.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:E}},{binding:1,resource:{buffer:h}},{binding:2,resource:{buffer:d}},{binding:3,resource:{buffer:p}},{binding:4,resource:{buffer:g}}]}),x=this.device.createCommandEncoder(),T=x.beginComputePass();T.setPipeline(_),T.setBindGroup(0,R),T.dispatchWorkgroups(Math.ceil(c*2/256)),T.end();let N=x.beginComputePass();N.setPipeline(S),N.setBindGroup(0,U),N.dispatchWorkgroups(Math.ceil(i/256)),N.end();let B=x.beginComputePass();B.setPipeline(A),B.setBindGroup(0,C),B.dispatchWorkgroups(Math.ceil(o/256)),B.end(),x.copyBufferToBuffer(g,0,b,0,4),this.device.queue.submit([x.finish()]),await b.mapAsync(GPUMapMode.READ);let P=new Uint32Array(b.getMappedRange())[0];b.unmap();let F=Math.min(P,u),L=this.device.createBuffer({size:F*2*4,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),G=this.device.createCommandEncoder();G.copyBufferToBuffer(p,0,L,0,F*2*4),this.device.queue.submit([G.finish()]),await L.mapAsync(GPUMapMode.READ);let W=new Uint32Array(L.getMappedRange().slice(0));L.unmap();let be=new Uint32Array(F),oe=new Uint32Array(F);for(let se=0;se<F;se++)be[se]=W[se*2],oe[se]=W[se*2+1];return f.destroy(),h.destroy(),d.destroy(),p.destroy(),g.destroy(),b.destroy(),L.destroy(),y.destroy(),w.destroy(),E.destroy(),{leftIndices:be,rightIndices:oe,matchCount:F}}_cpuHashJoin(e,t,n,s){let o=new Map;for(let l=0;l<t.length;l++){let c=this._hashKey(t[l][s]);o.has(c)||o.set(c,[]),o.get(c).push(l)}let i=[],a=[];for(let l=0;l<e.length;l++){let c=this._hashKey(e[l][n]);for(let u of o.get(c)||[])i.push(l),a.push(u)}return{leftIndices:new Uint32Array(i),rightIndices:new Uint32Array(a),matchCount:i.length}}_extractKeys(e,t){let n=new Uint32Array(e.length);for(let s=0;s<e.length;s++)n[s]=this._hashKey(e[s][t]);return n}_hashKey(e){if(e==null)return 4294967294;if(typeof e=="number")return Number.isInteger(e)&&e>=0&&e<4294967295?e>>>0:new Uint32Array(new Float32Array([e]).buffer)[0];if(typeof e=="string"){let t=2166136261;for(let n=0;n<e.length;n++)t^=e.charCodeAt(n),t=Math.imul(t,16777619);return t>>>0}return this._hashKey(String(e))}_createBuf(e,t){let n=this.device.createBuffer({size:e.byteLength,usage:t|GPUBufferUsage.COPY_DST});return this.device.queue.writeBuffer(n,0,e),n}_createUniform(e){let t=this.device.createBuffer({size:Math.max(e.byteLength,16),usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});return this.device.queue.writeBuffer(t,0,e),t}_nextPow2(e){let t=1;for(;t<e;)t*=2;return t}},Kt=null;function jr(){return Kt||(Kt=new Ae),Kt}var ct=class{constructor(){this.device=null,this.pipelines=new Map,this.available=!1,this._initPromise=null}async init(){return this._initPromise?this._initPromise:(this._initPromise=this._doInit(),this._initPromise)}async _doInit(){if(!navigator.gpu)return!1;try{let e=await navigator.gpu.requestAdapter();return e?(this.device=await e.requestDevice({requiredLimits:{maxStorageBufferBindingSize:256*1024*1024}}),this._compileShaders(),this.available=!0,console.log("[GPUSorter] Initialized"),!0):!1}catch(e){return console.warn("[GPUSorter] Init failed:",e),!1}}_compileShaders(){let t=this.device.createShaderModule({code:`
struct LP { size: u32, stage: u32, step: u32, asc: u32 }
@group(0) @binding(0) var<uniform> lp: LP;
@group(0) @binding(1) var<storage, read_write> keys: array<f32>;
@group(0) @binding(2) var<storage, read_write> idx: array<u32>;
var<workgroup> sk: array<f32, 512>;
var<workgroup> si: array<u32, 512>;

fn cswap(i: u32, j: u32, d: bool) {
    let ki = sk[i]; let kj = sk[j];
    if (select(ki > kj, ki < kj, d)) {
        sk[i] = kj; sk[j] = ki;
        let t = si[i]; si[i] = si[j]; si[j] = t;
    }
}

@compute @workgroup_size(256)
fn local_sort(@builtin(local_invocation_id) l: vec3<u32>, @builtin(workgroup_id) w: vec3<u32>) {
    let base = w.x * 512u; let t = l.x;
    let i1 = base + t; let i2 = base + t + 256u;
    if (i1 < lp.size) { sk[t] = keys[i1]; si[t] = idx[i1]; } else { sk[t] = 3.4e38; si[t] = i1; }
    if (i2 < lp.size) { sk[t + 256u] = keys[i2]; si[t + 256u] = idx[i2]; } else { sk[t + 256u] = 3.4e38; si[t + 256u] = i2; }
    workgroupBarrier();
    let asc = lp.asc == 1u;
    for (var s = 1u; s < 512u; s = s << 1u) {
        for (var st = s; st > 0u; st = st >> 1u) {
            let bs = st << 1u;
            if (t < 256u) {
                let bi = t / st; let ib = t % st;
                let i = bi * bs + ib; let j = i + st;
                if (j < 512u) { cswap(i, j, ((i / (s << 1u)) % 2u == 0u) == asc); }
            }
            workgroupBarrier();
        }
    }
    if (i1 < lp.size) { keys[i1] = sk[t]; idx[i1] = si[t]; }
    if (i2 < lp.size) { keys[i2] = sk[t + 256u]; idx[i2] = si[t + 256u]; }
}

struct MP { size: u32, stage: u32, step: u32, asc: u32 }
@group(0) @binding(0) var<uniform> mp: MP;
@group(0) @binding(1) var<storage, read_write> mkeys: array<f32>;
@group(0) @binding(2) var<storage, read_write> midx: array<u32>;

@compute @workgroup_size(256)
fn merge(@builtin(global_invocation_id) g: vec3<u32>) {
    let t = g.x; let step = mp.step; let stage = mp.stage;
    let bs = 1u << (stage + 1u); let hb = 1u << stage;
    let bi = t / hb; let ih = t % hb;
    let i = bi * bs + ih; let j = i + step;
    if (j >= mp.size) { return; }
    let d = ((i / bs) % 2u == 0u) == (mp.asc == 1u);
    let ki = mkeys[i]; let kj = mkeys[j];
    if (select(ki > kj, ki < kj, d)) {
        mkeys[i] = kj; mkeys[j] = ki;
        let ti = midx[i]; midx[i] = midx[j]; midx[j] = ti;
    }
}

struct IP { size: u32 }
@group(0) @binding(0) var<uniform> ip: IP;
@group(0) @binding(1) var<storage, read_write> iidx: array<u32>;

@compute @workgroup_size(256)
fn init_idx(@builtin(global_invocation_id) g: vec3<u32>) {
    if (g.x < ip.size) { iidx[g.x] = g.x; }
}`});this.pipelines.set("init",this.device.createComputePipeline({layout:"auto",compute:{module:t,entryPoint:"init_idx"}})),this.pipelines.set("local",this.device.createComputePipeline({layout:"auto",compute:{module:t,entryPoint:"local_sort"}})),this.pipelines.set("merge",this.device.createComputePipeline({layout:"auto",compute:{module:t,entryPoint:"merge"}}))}isAvailable(){return this.available}async sort(e,t=!0){let n=e.length;if(!this.available||n<1e4)return this._cpuSort(e,t);let s=this._nextPow2(n),o=new Float32Array(s);o.set(e instanceof Float32Array?e:new Float32Array(e));for(let _=n;_<s;_++)o[_]=34e37;let i=this._createBuf(o,GPUBufferUsage.STORAGE),a=this.device.createBuffer({size:s*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),l=this.pipelines.get("init"),c=this._createUniform(new Uint32Array([s])),u=this.device.createBindGroup({layout:l.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:c}},{binding:1,resource:{buffer:a}}]}),f=this.pipelines.get("local"),h=this._createUniform(new Uint32Array([s,0,0,t?1:0])),d=this.device.createBindGroup({layout:f.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:h}},{binding:1,resource:{buffer:i}},{binding:2,resource:{buffer:a}}]}),p=this.device.createCommandEncoder(),g=p.beginComputePass();g.setPipeline(l),g.setBindGroup(0,u),g.dispatchWorkgroups(Math.ceil(s/256)),g.end();let b=p.beginComputePass();if(b.setPipeline(f),b.setBindGroup(0,d),b.dispatchWorkgroups(Math.ceil(s/512)),b.end(),this.device.queue.submit([p.finish()]),s>512){let _=this.pipelines.get("merge");for(let S=9;1<<S<s;S++)for(let A=1<<S;A>0;A>>=1){let R=this.device.createCommandEncoder(),U=this._createUniform(new Uint32Array([s,S,A,t?1:0])),C=this.device.createBindGroup({layout:_.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:U}},{binding:1,resource:{buffer:i}},{binding:2,resource:{buffer:a}}]}),x=R.beginComputePass();x.setPipeline(_),x.setBindGroup(0,C),x.dispatchWorkgroups(Math.ceil(s/256)),x.end(),this.device.queue.submit([R.finish()]),U.destroy()}}let y=this.device.createBuffer({size:n*4,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),w=this.device.createCommandEncoder();w.copyBufferToBuffer(a,0,y,0,n*4),this.device.queue.submit([w.finish()]),await y.mapAsync(GPUMapMode.READ);let E=new Uint32Array(y.getMappedRange().slice(0));return y.unmap(),i.destroy(),a.destroy(),c.destroy(),h.destroy(),y.destroy(),E}_cpuSort(e,t){let n=Array.from(e).map((s,o)=>({v:s,i:o}));return n.sort((s,o)=>{let i=s.v<o.v?-1:s.v>o.v?1:0;return t?i:-i}),new Uint32Array(n.map(s=>s.i))}_createBuf(e,t){let n=this.device.createBuffer({size:e.byteLength,usage:t|GPUBufferUsage.COPY_DST});return this.device.queue.writeBuffer(n,0,e),n}_createUniform(e){let t=this.device.createBuffer({size:Math.max(e.byteLength,16),usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});return this.device.queue.writeBuffer(t,0,e),t}_nextPow2(e){let t=1;for(;t<e;)t*=2;return t}},Qt=null;function Jt(){return Qt||(Qt=new ct),Qt}var Ce=class{constructor(){this.device=null,this.pipelines=new Map,this.available=!1,this._initPromise=null}async init(){return this._initPromise?this._initPromise:(this._initPromise=this._doInit(),this._initPromise)}async _doInit(){if(!navigator.gpu)return!1;try{let e=await navigator.gpu.requestAdapter();return e?(this.device=await e.requestDevice({requiredLimits:{maxStorageBufferBindingSize:256*1024*1024}}),this._compileShaders(),this.available=!0,console.log("[GPUGrouper] Initialized"),!0):!1}catch(e){return console.warn("[GPUGrouper] Init failed:",e),!1}}_compileShaders(){let t=this.device.createShaderModule({code:`
struct BP { size: u32, cap: u32 }
struct AP { size: u32, cap: u32 }
struct AGP { size: u32, ng: u32, at: u32 }
struct IP { cap: u32 }
struct IAP { ng: u32, iv: u32 }

@group(0) @binding(0) var<uniform> bp: BP;
@group(0) @binding(1) var<storage, read> bk: array<u32>;
@group(0) @binding(2) var<storage, read_write> ht: array<atomic<u32>>;
@group(0) @binding(3) var<storage, read_write> gc: atomic<u32>;

fn fnv(k: u32) -> u32 { var h = 2166136261u; h ^= (k & 0xFFu); h *= 16777619u; h ^= ((k >> 8u) & 0xFFu); h *= 16777619u; h ^= ((k >> 16u) & 0xFFu); h *= 16777619u; h ^= ((k >> 24u) & 0xFFu); h *= 16777619u; return h; }

@compute @workgroup_size(256) fn build(@builtin(global_invocation_id) g: vec3<u32>) {
    if (g.x >= bp.size) { return; }
    let k = bk[g.x]; var s = fnv(k) % bp.cap;
    for (var p = 0u; p < bp.cap; p++) { let i = s * 2u; let o = atomicCompareExchangeWeak(&ht[i], 0xFFFFFFFFu, k); if (o.exchanged) { atomicStore(&ht[i + 1u], atomicAdd(&gc, 1u)); return; } if (o.old_value == k) { return; } s = (s + 1u) % bp.cap; }
}

@group(0) @binding(0) var<uniform> ap: AP;
@group(0) @binding(1) var<storage, read> ak: array<u32>;
@group(0) @binding(2) var<storage, read> lt: array<u32>;
@group(0) @binding(3) var<storage, read_write> gids: array<u32>;

@compute @workgroup_size(256) fn assign(@builtin(global_invocation_id) g: vec3<u32>) {
    if (g.x >= ap.size) { return; }
    let k = ak[g.x]; var s = fnv(k) % ap.cap;
    for (var p = 0u; p < ap.cap; p++) { let i = s * 2u; if (lt[i] == k) { gids[g.x] = lt[i + 1u]; return; } if (lt[i] == 0xFFFFFFFFu) { gids[g.x] = 0xFFFFFFFFu; return; } s = (s + 1u) % ap.cap; }
    gids[g.x] = 0xFFFFFFFFu;
}

@group(0) @binding(0) var<uniform> agp: AGP;
@group(0) @binding(1) var<storage, read> agi: array<u32>;
@group(0) @binding(2) var<storage, read> vals: array<f32>;
@group(0) @binding(3) var<storage, read_write> res: array<atomic<u32>>;

fn f2s(f: f32) -> u32 { let b = bitcast<u32>(f); return select(b ^ 0x80000000u, ~b, (b & 0x80000000u) != 0u); }

@compute @workgroup_size(256) fn cnt(@builtin(global_invocation_id) g: vec3<u32>) { if (g.x >= agp.size) { return; } let gid = agi[g.x]; if (gid < agp.ng) { atomicAdd(&res[gid], 1u); } }
@compute @workgroup_size(256) fn sum(@builtin(global_invocation_id) g: vec3<u32>) { if (g.x >= agp.size) { return; } let gid = agi[g.x]; let v = vals[g.x]; if (gid < agp.ng && !isNan(v)) { atomicAdd(&res[gid], u32(i32(v * 1000.0))); } }
@compute @workgroup_size(256) fn mn(@builtin(global_invocation_id) g: vec3<u32>) { if (g.x >= agp.size) { return; } let gid = agi[g.x]; let v = vals[g.x]; if (gid < agp.ng && !isNan(v)) { atomicMin(&res[gid], f2s(v)); } }
@compute @workgroup_size(256) fn mx(@builtin(global_invocation_id) g: vec3<u32>) { if (g.x >= agp.size) { return; } let gid = agi[g.x]; let v = vals[g.x]; if (gid < agp.ng && !isNan(v)) { atomicMax(&res[gid], f2s(v)); } }

@group(0) @binding(0) var<uniform> ip: IP;
@group(0) @binding(1) var<storage, read_write> it: array<u32>;
@compute @workgroup_size(256) fn iht(@builtin(global_invocation_id) g: vec3<u32>) { if (g.x >= ip.cap * 2u) { return; } it[g.x] = select(0u, 0xFFFFFFFFu, g.x % 2u == 0u); }

@group(0) @binding(0) var<uniform> iap: IAP;
@group(0) @binding(1) var<storage, read_write> iar: array<u32>;
@compute @workgroup_size(256) fn iag(@builtin(global_invocation_id) g: vec3<u32>) { if (g.x >= iap.ng) { return; } iar[g.x] = iap.iv; }`});this.pipelines.set("iht",this.device.createComputePipeline({layout:"auto",compute:{module:t,entryPoint:"iht"}})),this.pipelines.set("build",this.device.createComputePipeline({layout:"auto",compute:{module:t,entryPoint:"build"}})),this.pipelines.set("assign",this.device.createComputePipeline({layout:"auto",compute:{module:t,entryPoint:"assign"}})),this.pipelines.set("iag",this.device.createComputePipeline({layout:"auto",compute:{module:t,entryPoint:"iag"}})),this.pipelines.set("cnt",this.device.createComputePipeline({layout:"auto",compute:{module:t,entryPoint:"cnt"}})),this.pipelines.set("sum",this.device.createComputePipeline({layout:"auto",compute:{module:t,entryPoint:"sum"}})),this.pipelines.set("mn",this.device.createComputePipeline({layout:"auto",compute:{module:t,entryPoint:"mn"}})),this.pipelines.set("mx",this.device.createComputePipeline({layout:"auto",compute:{module:t,entryPoint:"mx"}}))}isAvailable(){return this.available}async groupBy(e){let t=e.length;if(!this.available||t<1e4)return this._cpuGroupBy(e);let n=this._nextPow2(Math.min(t,1e5)*2),s=this._createBuf(e,GPUBufferUsage.STORAGE),o=this.device.createBuffer({size:n*2*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),i=this.device.createBuffer({size:4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),a=this.device.createBuffer({size:t*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),l=this.pipelines.get("iht"),c=this.pipelines.get("build"),u=this.pipelines.get("assign"),f=this._createUniform(new Uint32Array([n])),h=this._createUniform(new Uint32Array([t,n])),d=this._createUniform(new Uint32Array([t,n])),p=this.device.createBindGroup({layout:l.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:f}},{binding:1,resource:{buffer:o}}]}),g=this.device.createBindGroup({layout:c.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:h}},{binding:1,resource:{buffer:s}},{binding:2,resource:{buffer:o}},{binding:3,resource:{buffer:i}}]}),b=this.device.createBindGroup({layout:u.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:d}},{binding:1,resource:{buffer:s}},{binding:2,resource:{buffer:o}},{binding:3,resource:{buffer:a}}]}),y=this.device.createCommandEncoder(),w=y.beginComputePass();w.setPipeline(l),w.setBindGroup(0,p),w.dispatchWorkgroups(Math.ceil(n*2/256)),w.end();let E=y.beginComputePass();E.setPipeline(c),E.setBindGroup(0,g),E.dispatchWorkgroups(Math.ceil(t/256)),E.end();let _=y.beginComputePass();_.setPipeline(u),_.setBindGroup(0,b),_.dispatchWorkgroups(Math.ceil(t/256)),_.end();let S=this.device.createBuffer({size:4,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST});y.copyBufferToBuffer(i,0,S,0,4),this.device.queue.submit([y.finish()]),await S.mapAsync(GPUMapMode.READ);let A=new Uint32Array(S.getMappedRange())[0];S.unmap();let R=this.device.createBuffer({size:t*4,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),U=this.device.createCommandEncoder();U.copyBufferToBuffer(a,0,R,0,t*4),this.device.queue.submit([U.finish()]),await R.mapAsync(GPUMapMode.READ);let C=new Uint32Array(R.getMappedRange().slice(0));return R.unmap(),s.destroy(),o.destroy(),i.destroy(),a.destroy(),S.destroy(),R.destroy(),f.destroy(),h.destroy(),d.destroy(),{groupIds:C,numGroups:A}}async groupAggregate(e,t,n,s){let o=e.length;if(!this.available||o<1e4)return this._cpuGroupAggregate(e,t,n,s);let i=0,a="cnt";s==="SUM"?a="sum":s==="MIN"?(i=2139095039,a="mn"):s==="MAX"&&(a="mx");let l=this._createBuf(t,GPUBufferUsage.STORAGE),c=this._createBuf(e,GPUBufferUsage.STORAGE),u=this.device.createBuffer({size:n*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),f=this.pipelines.get("iag"),h=this.pipelines.get(a),d=this._createUniform(new Uint32Array([n,i])),p=this._createUniform(new Uint32Array([o,n,0])),g=this.device.createBindGroup({layout:f.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:d}},{binding:1,resource:{buffer:u}}]}),b=this.device.createBindGroup({layout:h.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:p}},{binding:1,resource:{buffer:l}},{binding:2,resource:{buffer:c}},{binding:3,resource:{buffer:u}}]}),y=this.device.createCommandEncoder(),w=y.beginComputePass();w.setPipeline(f),w.setBindGroup(0,g),w.dispatchWorkgroups(Math.max(1,Math.ceil(n/256))),w.end();let E=y.beginComputePass();E.setPipeline(h),E.setBindGroup(0,b),E.dispatchWorkgroups(Math.ceil(o/256)),E.end();let _=this.device.createBuffer({size:n*4,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST});y.copyBufferToBuffer(u,0,_,0,n*4),this.device.queue.submit([y.finish()]),await _.mapAsync(GPUMapMode.READ);let S=new Uint32Array(_.getMappedRange().slice(0));_.unmap();let A=new Float32Array(n);for(let R=0;R<n;R++)if(s==="COUNT")A[R]=S[R];else if(s==="SUM")A[R]=(S[R]|0)/1e3;else{let U=S[R],C=U&2147483648?U^2147483648:~U;A[R]=new Float32Array(new Uint32Array([C]).buffer)[0]}return l.destroy(),c.destroy(),u.destroy(),_.destroy(),d.destroy(),p.destroy(),A}_cpuGroupBy(e){let t=new Map,n=new Uint32Array(e.length),s=0;for(let o=0;o<e.length;o++){let i=e[o];t.has(i)||t.set(i,s++),n[o]=t.get(i)}return{groupIds:n,numGroups:s}}_cpuGroupAggregate(e,t,n,s){let o=new Float32Array(n);s==="MIN"?o.fill(1/0):s==="MAX"&&o.fill(-1/0);for(let i=0;i<e.length;i++){let a=t[i],l=e[i];a>=n||isNaN(l)||(s==="COUNT"?o[a]++:s==="SUM"?o[a]+=l:s==="MIN"?o[a]=Math.min(o[a],l):s==="MAX"&&(o[a]=Math.max(o[a],l)))}return o}_createBuf(e,t){let n=this.device.createBuffer({size:e.byteLength,usage:t|GPUBufferUsage.COPY_DST});return this.device.queue.writeBuffer(n,0,e),n}_createUniform(e){let t=this.device.createBuffer({size:Math.max(e.byteLength,16),usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});return this.device.queue.writeBuffer(t,0,e),t}_nextPow2(e){let t=1;for(;t<e;)t*=2;return t}},Yt=null;function Hr(){return Yt||(Yt=new Ce),Yt}var Ie=class{constructor(){this.device=null,this.pipelines=new Map,this.available=!1,this._initPromise=null}async init(){return this._initPromise?this._initPromise:(this._initPromise=this._doInit(),this._initPromise)}async _doInit(){if(typeof navigator>"u"||!navigator.gpu)return!1;try{let e=await navigator.gpu.requestAdapter();return e?(this.device=await e.requestDevice({requiredLimits:{maxStorageBufferBindingSize:256*1024*1024,maxBufferSize:256*1024*1024}}),await this._compileShaders(),this.available=!0,!0):!1}catch{return!1}}async _compileShaders(){let e=this.device.createShaderModule({code:VECTOR_DISTANCE_SHADER});this.pipelines.set("distance",this.device.createComputePipeline({layout:"auto",compute:{module:e,entryPoint:"compute_distances"}}));let t=this.device.createShaderModule({code:TOPK_SHADER});this.pipelines.set("local_topk",this.device.createComputePipeline({layout:"auto",compute:{module:t,entryPoint:"local_topk"}})),this.pipelines.set("merge_topk",this.device.createComputePipeline({layout:"auto",compute:{module:t,entryPoint:"merge_topk"}}))}isAvailable(){return this.available}async computeDistances(e,t,n=1,s=0){let o=t.length,i=e.length/n;if(!this.available||o<GPU_DISTANCE_THRESHOLD)return this._cpuDistances(e,t,n,s);let a=new Float32Array(o*i);for(let y=0;y<o;y++)a.set(t[y],y*i);let l=this._createUniform(new Uint32Array([i,o,n,s])),c=this._createStorage(e),u=this._createStorage(a),f=this.device.createBuffer({size:n*o*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),h=this.device.createBuffer({size:n*o*4,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),d=this.device.createBindGroup({layout:this.pipelines.get("distance").getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:l}},{binding:1,resource:{buffer:c}},{binding:2,resource:{buffer:u}},{binding:3,resource:{buffer:f}}]}),p=this.device.createCommandEncoder(),g=p.beginComputePass();g.setPipeline(this.pipelines.get("distance")),g.setBindGroup(0,d),g.dispatchWorkgroups(Math.ceil(o/256),n,1),g.end(),p.copyBufferToBuffer(f,0,h,0,n*o*4),this.device.queue.submit([p.finish()]),await h.mapAsync(GPUMapMode.READ);let b=new Float32Array(h.getMappedRange().slice(0));return h.unmap(),[l,c,u,f,h].forEach(y=>y.destroy()),b}async topK(e,t=null,n=10,s=!0){let o=e.length;if(!this.available||o<GPU_TOPK_THRESHOLD)return this._cpuTopK(e,t,n,s);if(!t){t=new Uint32Array(o);for(let C=0;C<o;C++)t[C]=C}let i=Math.ceil(o/512),a=Math.min(n,512),l=i*a,c=this._createUniform(new Uint32Array([o,n,s?1:0,i])),u=this._createStorage(e),f=this._createStorage(t),h=this.device.createBuffer({size:l*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),d=this.device.createBuffer({size:l*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),p=this.device.createBindGroup({layout:this.pipelines.get("local_topk").getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:c}},{binding:1,resource:{buffer:u}},{binding:2,resource:{buffer:f}},{binding:3,resource:{buffer:h}},{binding:4,resource:{buffer:d}}]}),g=this.device.createCommandEncoder(),b=g.beginComputePass();b.setPipeline(this.pipelines.get("local_topk")),b.setBindGroup(0,p),b.dispatchWorkgroups(i,1,1),b.end(),this.device.queue.submit([g.finish()]);let y=this._createUniform(new Uint32Array([l,n,s?1:0,0])),w=this.device.createBuffer({size:n*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),E=this.device.createBuffer({size:n*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),_=this.device.createBuffer({size:n*4,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),S=this.device.createBuffer({size:n*4,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),A=this.device.createBindGroup({layout:this.pipelines.get("merge_topk").getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:y}},{binding:1,resource:{buffer:h}},{binding:2,resource:{buffer:d}},{binding:3,resource:{buffer:w}},{binding:4,resource:{buffer:E}}]});g=this.device.createCommandEncoder(),b=g.beginComputePass(),b.setPipeline(this.pipelines.get("merge_topk")),b.setBindGroup(0,A),b.dispatchWorkgroups(1,1,1),b.end(),g.copyBufferToBuffer(w,0,_,0,n*4),g.copyBufferToBuffer(E,0,S,0,n*4),this.device.queue.submit([g.finish()]),await Promise.all([_.mapAsync(GPUMapMode.READ),S.mapAsync(GPUMapMode.READ)]);let R=new Float32Array(_.getMappedRange().slice(0)),U=new Uint32Array(S.getMappedRange().slice(0));return _.unmap(),S.unmap(),[c,u,f,h,d,y,w,E,_,S].forEach(C=>C.destroy()),{indices:U,scores:R}}async search(e,t,n=10,s={}){let{metric:o=0}=s,i=await this.computeDistances(e,t,1,o),a=o===0||o===2;return await this.topK(i,null,n,a)}_cpuDistances(e,t,n,s){let o=e.length/n,i=t.length,a=new Float32Array(n*i);for(let l=0;l<n;l++){let c=l*o;for(let u=0;u<i;u++){let f=t[u],h=0;if(s===1){for(let d=0;d<o;d++){let p=e[c+d]-f[d];h+=p*p}h=Math.sqrt(h)}else for(let d=0;d<o;d++)h+=e[c+d]*f[d];a[l*i+u]=h}}return a}_cpuTopK(e,t,n,s){let o=e.length;if(!t){t=new Uint32Array(o);for(let l=0;l<o;l++)t[l]=l}let i=Array.from(e).map((l,c)=>({score:l,idx:t[c]}));s?i.sort((l,c)=>c.score-l.score):i.sort((l,c)=>l.score-c.score);let a=i.slice(0,n);return{indices:new Uint32Array(a.map(l=>l.idx)),scores:new Float32Array(a.map(l=>l.score))}}_createStorage(e){let t=this.device.createBuffer({size:e.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});return this.device.queue.writeBuffer(t,0,e),t}_createUniform(e){let t=this.device.createBuffer({size:Math.max(e.byteLength,16),usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});return this.device.queue.writeBuffer(t,0,e),t}},Xt=null;function ut(){return Xt||(Xt=new Ie),Xt}ue();en();Zt();var he=class r{constructor(){this.chunks=[]}static encodeVarint(e){let t=[],n=typeof e=="bigint"?e:BigInt(e);for(;n>0x7fn;)t.push(Number(n&0x7fn)|128),n>>=7n;return t.push(Number(n)),new Uint8Array(t)}static encodeFieldHeader(e,t){let n=e<<3|t;return r.encodeVarint(n)}writeVarint(e,t){this.chunks.push(r.encodeFieldHeader(e,0)),this.chunks.push(r.encodeVarint(t))}writeBytes(e,t){this.chunks.push(r.encodeFieldHeader(e,2)),this.chunks.push(r.encodeVarint(t.length)),this.chunks.push(t)}writePackedUint64(e,t){let n=[];for(let o of t)n.push(r.encodeVarint(o));let s=n.reduce((o,i)=>o+i.length,0);this.chunks.push(r.encodeFieldHeader(e,2)),this.chunks.push(r.encodeVarint(s));for(let o of n)this.chunks.push(o)}toBytes(){let e=this.chunks.reduce((s,o)=>s+o.length,0),t=new Uint8Array(e),n=0;for(let s of this.chunks)t.set(s,n),n+=s.length;return t}clear(){this.chunks=[]}},fe={INT64:"int64",FLOAT64:"float64",STRING:"string",BOOL:"bool",INT32:"int32",FLOAT32:"float32"},We=class{constructor(e={}){this.majorVersion=e.majorVersion??0,this.minorVersion=e.minorVersion??3,this.columns=[],this.rowCount=null}_validateRowCount(e){if(this.rowCount===null)this.rowCount=e;else if(this.rowCount!==e)throw new Error(`Row count mismatch: expected ${this.rowCount}, got ${e}`)}addInt64Column(e,t){this._validateRowCount(t.length),this.columns.push({name:e,type:fe.INT64,data:new Uint8Array(t.buffer,t.byteOffset,t.byteLength),length:t.length})}addInt32Column(e,t){this._validateRowCount(t.length),this.columns.push({name:e,type:fe.INT32,data:new Uint8Array(t.buffer,t.byteOffset,t.byteLength),length:t.length})}addFloat64Column(e,t){this._validateRowCount(t.length),this.columns.push({name:e,type:fe.FLOAT64,data:new Uint8Array(t.buffer,t.byteOffset,t.byteLength),length:t.length})}addFloat32Column(e,t){this._validateRowCount(t.length),this.columns.push({name:e,type:fe.FLOAT32,data:new Uint8Array(t.buffer,t.byteOffset,t.byteLength),length:t.length})}addBoolColumn(e,t){this._validateRowCount(t.length);let n=new Uint8Array(t.length);for(let s=0;s<t.length;s++)n[s]=t[s]?1:0;this.columns.push({name:e,type:fe.BOOL,data:n,length:t.length})}addStringColumn(e,t){this._validateRowCount(t.length);let n=new TextEncoder,s=new Int32Array(t.length+1),o=[],i=0;for(let f=0;f<t.length;f++){s[f]=i;let h=n.encode(t[f]);o.push(h),i+=h.length}s[t.length]=i;let a=new Uint8Array(s.buffer),l=o.reduce((f,h)=>f+h.length,0),c=new Uint8Array(l),u=0;for(let f of o)c.set(f,u),u+=f.length;this.columns.push({name:e,type:fe.STRING,offsetsData:a,stringData:c,data:null,length:t.length})}_buildColumnMeta(e,t,n,s){let o=new he;o.writePackedUint64(1,[BigInt(e)]),o.writePackedUint64(2,[BigInt(t)]),o.writeVarint(3,n),o.writeVarint(5,0);let i=o.toBytes(),a=new he;return a.writeBytes(2,i),a.toBytes()}_buildStringColumnMeta(e,t,n,s,o){let i=new he;i.writePackedUint64(1,[BigInt(e),BigInt(n)]),i.writePackedUint64(2,[BigInt(t),BigInt(s)]),i.writeVarint(3,o),i.writeVarint(5,0);let a=i.toBytes(),l=new he;return l.writeBytes(2,a),l.toBytes()}finalize(){if(this.columns.length===0)throw new Error("No columns added");let e=[],t=0,n=[];for(let w of this.columns)if(w.type===fe.STRING){let E=t;e.push(w.offsetsData),t+=w.offsetsData.length;let _=t;e.push(w.stringData),t+=w.stringData.length,n.push({type:"string",offsetsOffset:E,offsetsSize:w.offsetsData.length,dataOffset:_,dataSize:w.stringData.length,length:w.length})}else{let E=t;e.push(w.data),t+=w.data.length,n.push({type:w.type,offset:E,size:w.data.length,length:w.length})}let s=[];for(let w=0;w<this.columns.length;w++){let E=n[w],_;E.type==="string"?_=this._buildStringColumnMeta(E.offsetsOffset,E.offsetsSize,E.dataOffset,E.dataSize,E.length):_=this._buildColumnMeta(E.offset,E.size,E.length,E.type),s.push(_)}let o=t,i=[],a=0;for(let w of s)i.push(a),e.push(w),t+=w.length,a+=w.length;let l=t,c=new BigUint64Array(i.length);for(let w=0;w<i.length;w++)c[w]=BigInt(i[w]);let u=new Uint8Array(c.buffer);e.push(u),t+=u.length;let f=t,h=0,d=new ArrayBuffer(40),p=new DataView(d);p.setBigUint64(0,BigInt(o),!0),p.setBigUint64(8,BigInt(l),!0),p.setBigUint64(16,BigInt(f),!0),p.setUint32(24,h,!0),p.setUint32(28,this.columns.length,!0),p.setUint16(32,this.majorVersion,!0),p.setUint16(34,this.minorVersion,!0),new Uint8Array(d,36,4).set(mt),e.push(new Uint8Array(d));let g=t+40,b=new Uint8Array(g),y=0;for(let w of e)b.set(w,y),y+=w.length;return b}getNumColumns(){return this.columns.length}getRowCount(){return this.rowCount}getColumnNames(){return this.columns.map(e=>e.name)}};ue();var gt=class{constructor(e="lanceql-files",t=1){this.dbName=e,this.version=t,this.db=null,this.SIZE_THRESHOLD=50*1024*1024}async open(){return this.db?this.db:new Promise((e,t)=>{let n=indexedDB.open(this.dbName,this.version);n.onerror=()=>t(n.error),n.onsuccess=()=>{this.db=n.result,e(this.db)},n.onupgradeneeded=s=>{let o=s.target.result;if(o.objectStoreNames.contains("files")||o.createObjectStore("files",{keyPath:"name"}),!o.objectStoreNames.contains("index")){let i=o.createObjectStore("index",{keyPath:"name"});i.createIndex("timestamp","timestamp"),i.createIndex("size","size")}}})}async hasOPFS(){try{return"storage"in navigator&&"getDirectory"in navigator.storage}catch{return!1}}async save(e,t,n={}){let s=await this.open(),o=t instanceof ArrayBuffer?new Uint8Array(t):t,i=o.byteLength,a=i>=this.SIZE_THRESHOLD&&await this.hasOPFS();if(a)try{let u=await(await(await navigator.storage.getDirectory()).getFileHandle(e,{create:!0})).createWritable();await u.write(o),await u.close()}catch(l){console.warn("[DatasetStorage] OPFS save failed, falling back to IndexedDB:",l)}return a||await new Promise((l,c)=>{let u=s.transaction("files","readwrite");u.objectStore("files").put({name:e,data:o}),u.oncomplete=()=>l(),u.onerror=()=>c(u.error)}),await new Promise((l,c)=>{let u=s.transaction("index","readwrite");u.objectStore("index").put({name:e,size:i,timestamp:Date.now(),storage:a?"opfs":"indexeddb",...n}),u.oncomplete=()=>l(),u.onerror=()=>c(u.error)}),{name:e,size:i,storage:a?"opfs":"indexeddb"}}async load(e){let t=await this.open(),n=await new Promise(s=>{let a=t.transaction("index","readonly").objectStore("index").get(e);a.onsuccess=()=>s(a.result),a.onerror=()=>s(null)});if(!n)return null;if(n.storage==="opfs")try{let a=await(await(await(await navigator.storage.getDirectory()).getFileHandle(e)).getFile()).arrayBuffer();return new Uint8Array(a)}catch(s){return console.warn("[DatasetStorage] OPFS load failed:",s),null}return new Promise(s=>{let a=t.transaction("files","readonly").objectStore("files").get(e);a.onsuccess=()=>{let l=a.result;s(l?l.data:null)},a.onerror=()=>s(null)})}async list(){let e=await this.open();return new Promise(t=>{let o=e.transaction("index","readonly").objectStore("index").getAll();o.onsuccess=()=>t(o.result||[]),o.onerror=()=>t([])})}async delete(e){let t=await this.open();if((await new Promise(s=>{let a=t.transaction("index","readonly").objectStore("index").get(e);a.onsuccess=()=>s(a.result),a.onerror=()=>s(null)}))?.storage==="opfs")try{await(await navigator.storage.getDirectory()).removeEntry(e)}catch(s){console.warn("[DatasetStorage] OPFS delete failed:",s)}await new Promise(s=>{let o=t.transaction("files","readwrite");o.objectStore("files").delete(e),o.oncomplete=()=>s()}),await new Promise(s=>{let o=t.transaction("index","readwrite");o.objectStore("index").delete(e),o.oncomplete=()=>s()})}async exists(e){let t=await this.open();return new Promise(n=>{let i=t.transaction("index","readonly").objectStore("index").get(e);i.onsuccess=()=>n(!!i.result),i.onerror=()=>n(!1)})}async getUsage(){let e=await this.list(),t=e.reduce((i,a)=>i+(a.size||0),0),n=e.filter(i=>i.storage==="indexeddb").length,s=e.filter(i=>i.storage==="opfs").length,o=null;return navigator.storage?.estimate&&(o=await navigator.storage.estimate()),{datasets:e.length,totalSize:t,indexedDBCount:n,opfsCount:s,quota:o}}},Ui=new ce,Pi=new gt;var m={SELECT:"SELECT",DISTINCT:"DISTINCT",FROM:"FROM",WHERE:"WHERE",AND:"AND",OR:"OR",NOT:"NOT",ORDER:"ORDER",BY:"BY",ASC:"ASC",DESC:"DESC",LIMIT:"LIMIT",OFFSET:"OFFSET",AS:"AS",NULL:"NULL",IS:"IS",IN:"IN",BETWEEN:"BETWEEN",LIKE:"LIKE",TRUE:"TRUE",FALSE:"FALSE",GROUP:"GROUP",HAVING:"HAVING",QUALIFY:"QUALIFY",ROLLUP:"ROLLUP",CUBE:"CUBE",GROUPING:"GROUPING",SETS:"SETS",COUNT:"COUNT",SUM:"SUM",AVG:"AVG",MIN:"MIN",MAX:"MAX",NEAR:"NEAR",TOPK:"TOPK",FILE:"FILE",JOIN:"JOIN",INNER:"INNER",LEFT:"LEFT",RIGHT:"RIGHT",FULL:"FULL",OUTER:"OUTER",CROSS:"CROSS",ON:"ON",CREATE:"CREATE",TABLE:"TABLE",INSERT:"INSERT",INTO:"INTO",VALUES:"VALUES",UPDATE:"UPDATE",SET:"SET",DELETE:"DELETE",DROP:"DROP",IF:"IF",EXISTS:"EXISTS",INT:"INT",INTEGER:"INTEGER",BIGINT:"BIGINT",FLOAT:"FLOAT",REAL:"REAL",DOUBLE:"DOUBLE",TEXT:"TEXT",VARCHAR:"VARCHAR",BOOLEAN:"BOOLEAN",BOOL:"BOOL",VECTOR:"VECTOR",PRIMARY:"PRIMARY",KEY:"KEY",WITH:"WITH",RECURSIVE:"RECURSIVE",UNION:"UNION",ALL:"ALL",PIVOT:"PIVOT",UNPIVOT:"UNPIVOT",FOR:"FOR",INTERSECT:"INTERSECT",EXCEPT:"EXCEPT",OVER:"OVER",PARTITION:"PARTITION",ROW_NUMBER:"ROW_NUMBER",RANK:"RANK",DENSE_RANK:"DENSE_RANK",NTILE:"NTILE",LAG:"LAG",LEAD:"LEAD",FIRST_VALUE:"FIRST_VALUE",LAST_VALUE:"LAST_VALUE",NTH_VALUE:"NTH_VALUE",PERCENT_RANK:"PERCENT_RANK",CUME_DIST:"CUME_DIST",ROWS:"ROWS",RANGE:"RANGE",UNBOUNDED:"UNBOUNDED",PRECEDING:"PRECEDING",FOLLOWING:"FOLLOWING",CURRENT:"CURRENT",ROW:"ROW",EXPLAIN:"EXPLAIN",ARRAY:"ARRAY",CASE:"CASE",WHEN:"WHEN",THEN:"THEN",ELSE:"ELSE",END:"END",CAST:"CAST",COALESCE:"COALESCE",NULLIF:"NULLIF",IDENTIFIER:"IDENTIFIER",NUMBER:"NUMBER",STRING:"STRING",STAR:"STAR",COMMA:"COMMA",DOT:"DOT",LPAREN:"LPAREN",RPAREN:"RPAREN",EQ:"EQ",NE:"NE",LT:"LT",LE:"LE",GT:"GT",GE:"GE",PLUS:"PLUS",MINUS:"MINUS",SLASH:"SLASH",LBRACKET:"LBRACKET",RBRACKET:"RBRACKET",EOF:"EOF"},Kr={SELECT:m.SELECT,DISTINCT:m.DISTINCT,FROM:m.FROM,WHERE:m.WHERE,AND:m.AND,OR:m.OR,NOT:m.NOT,ORDER:m.ORDER,BY:m.BY,ASC:m.ASC,DESC:m.DESC,LIMIT:m.LIMIT,OFFSET:m.OFFSET,AS:m.AS,NULL:m.NULL,IS:m.IS,IN:m.IN,BETWEEN:m.BETWEEN,LIKE:m.LIKE,TRUE:m.TRUE,FALSE:m.FALSE,GROUP:m.GROUP,HAVING:m.HAVING,QUALIFY:m.QUALIFY,ROLLUP:m.ROLLUP,CUBE:m.CUBE,GROUPING:m.GROUPING,SETS:m.SETS,COUNT:m.COUNT,SUM:m.SUM,AVG:m.AVG,MIN:m.MIN,MAX:m.MAX,NEAR:m.NEAR,TOPK:m.TOPK,FILE:m.FILE,JOIN:m.JOIN,INNER:m.INNER,LEFT:m.LEFT,RIGHT:m.RIGHT,FULL:m.FULL,OUTER:m.OUTER,CROSS:m.CROSS,ON:m.ON,CREATE:m.CREATE,TABLE:m.TABLE,INSERT:m.INSERT,INTO:m.INTO,VALUES:m.VALUES,UPDATE:m.UPDATE,SET:m.SET,DELETE:m.DELETE,DROP:m.DROP,IF:m.IF,EXISTS:m.EXISTS,INT:m.INT,INTEGER:m.INTEGER,BIGINT:m.BIGINT,FLOAT:m.FLOAT,REAL:m.REAL,DOUBLE:m.DOUBLE,TEXT:m.TEXT,VARCHAR:m.VARCHAR,BOOLEAN:m.BOOLEAN,BOOL:m.BOOL,VECTOR:m.VECTOR,PRIMARY:m.PRIMARY,KEY:m.KEY,WITH:m.WITH,RECURSIVE:m.RECURSIVE,UNION:m.UNION,ALL:m.ALL,PIVOT:m.PIVOT,UNPIVOT:m.UNPIVOT,FOR:m.FOR,INTERSECT:m.INTERSECT,EXCEPT:m.EXCEPT,OVER:m.OVER,PARTITION:m.PARTITION,ROW_NUMBER:m.ROW_NUMBER,RANK:m.RANK,DENSE_RANK:m.DENSE_RANK,NTILE:m.NTILE,LAG:m.LAG,LEAD:m.LEAD,FIRST_VALUE:m.FIRST_VALUE,LAST_VALUE:m.LAST_VALUE,NTH_VALUE:m.NTH_VALUE,PERCENT_RANK:m.PERCENT_RANK,CUME_DIST:m.CUME_DIST,ROWS:m.ROWS,RANGE:m.RANGE,UNBOUNDED:m.UNBOUNDED,PRECEDING:m.PRECEDING,FOLLOWING:m.FOLLOWING,CURRENT:m.CURRENT,ROW:m.ROW,EXPLAIN:m.EXPLAIN,ARRAY:m.ARRAY,CASE:m.CASE,WHEN:m.WHEN,THEN:m.THEN,ELSE:m.ELSE,END:m.END,CAST:m.CAST,COALESCE:m.COALESCE,NULLIF:m.NULLIF},j=class{constructor(e){this.sql=e,this.pos=0,this.length=e.length}peek(){return this.pos>=this.length?"\0":this.sql[this.pos]}advance(){return this.pos<this.length?this.sql[this.pos++]:"\0"}skipWhitespace(){for(;this.pos<this.length&&/\s/.test(this.sql[this.pos]);)this.pos++}readIdentifier(){let e=this.pos;for(;this.pos<this.length&&/[a-zA-Z0-9_]/.test(this.sql[this.pos]);)this.pos++;return this.sql.slice(e,this.pos)}readNumber(){let e=this.pos,t=!1;for(;this.pos<this.length;){let n=this.sql[this.pos];if(n==="."&&!t)t=!0,this.pos++;else if(/\d/.test(n))this.pos++;else break}return this.sql.slice(e,this.pos)}readString(e){let t=this.pos;for(this.advance();this.pos<this.length;){if(this.sql[this.pos]===e){if(this.pos+1<this.length&&this.sql[this.pos+1]===e){this.pos+=2;continue}this.pos++;break}this.pos++}return this.sql.slice(t+1,this.pos-1).replace(new RegExp(e+e,"g"),e)}nextToken(){if(this.skipWhitespace(),this.pos>=this.length)return{type:m.EOF,value:null};let e=this.peek();if(/[a-zA-Z_]/.test(e)){let t=this.readIdentifier(),n=t.toUpperCase(),s=Kr[n]||m.IDENTIFIER;return{type:s,value:s===m.IDENTIFIER?t:n}}if(/\d/.test(e)){let t=this.readNumber();return{type:m.NUMBER,value:t}}if(e==="'"||e==='"'){let t=this.readString(e);return{type:m.STRING,value:t}}switch(this.advance(),e){case"*":return{type:m.STAR,value:"*"};case",":return{type:m.COMMA,value:","};case".":return{type:m.DOT,value:"."};case"(":return{type:m.LPAREN,value:"("};case")":return{type:m.RPAREN,value:")"};case"+":return{type:m.PLUS,value:"+"};case"-":return{type:m.MINUS,value:"-"};case"/":return{type:m.SLASH,value:"/"};case"[":return{type:m.LBRACKET,value:"["};case"]":return{type:m.RBRACKET,value:"]"};case"=":return{type:m.EQ,value:"="};case"<":return this.peek()==="="?(this.advance(),{type:m.LE,value:"<="}):this.peek()===">"?(this.advance(),{type:m.NE,value:"<>"}):{type:m.LT,value:"<"};case">":return this.peek()==="="?(this.advance(),{type:m.GE,value:">="}):{type:m.GT,value:">"};case"!":if(this.peek()==="=")return this.advance(),{type:m.NE,value:"!="};throw new Error(`Unexpected character: ${e}`);default:throw new Error(`Unexpected character: ${e}`)}}tokenize(){let e=[],t;for(;(t=this.nextToken()).type!==m.EOF;)e.push(t);return e.push(t),e}};function H(r){return Qr(r)}function Qr(r){let e=is(r);for(;r.match(m.OR);){let t=is(r);e={type:"binary",op:"OR",left:e,right:t}}return e}function is(r){let e=tn(r);for(;r.match(m.AND);){let t=tn(r);e={type:"binary",op:"AND",left:e,right:t}}return e}function tn(r){return r.match(m.NOT)?{type:"unary",op:"NOT",operand:tn(r)}:Jr(r)}function Jr(r){let e=yt(r);if(r.match(m.IS)){let s=!!r.match(m.NOT);return r.expect(m.NULL),{type:"binary",op:s?"!=":"==",left:e,right:{type:"literal",value:null}}}if(r.match(m.IN)){if(r.expect(m.LPAREN),r.check(m.SELECT)){let o=r.parseSelect(!0);return r.expect(m.RPAREN),{type:"in",expr:e,values:[{type:"subquery",query:o}]}}let s=[];for(s.push(me(r));r.match(m.COMMA);)s.push(me(r));return r.expect(m.RPAREN),{type:"in",expr:e,values:s}}if(r.match(m.BETWEEN)){let s=yt(r);r.expect(m.AND);let o=yt(r);return{type:"between",expr:e,low:s,high:o}}if(r.match(m.LIKE)){let s=me(r);return{type:"like",expr:e,pattern:s}}if(r.match(m.NEAR)){let s=me(r);return{type:"near",column:e,value:s}}let t={[m.EQ]:"==",[m.NE]:"!=",[m.LT]:"<",[m.LE]:"<=",[m.GT]:">",[m.GE]:">="},n=r.match(m.EQ,m.NE,m.LT,m.LE,m.GT,m.GE);if(n){let s=yt(r);return{type:"binary",op:t[n.type],left:e,right:s}}return e}function yt(r){let e=as(r);for(;;){let t=r.match(m.PLUS,m.MINUS);if(!t)break;let n=as(r);e={type:"binary",op:t.value,left:e,right:n}}return e}function as(r){let e=nn(r);for(;;){let t=r.match(m.STAR,m.SLASH);if(!t)break;let n=nn(r);e={type:"binary",op:t.value,left:e,right:n}}return e}function nn(r){return r.match(m.MINUS)?{type:"unary",op:"-",operand:nn(r)}:me(r)}function me(r){if(r.match(m.NULL))return{type:"literal",value:null};if(r.match(m.TRUE))return{type:"literal",value:!0};if(r.match(m.FALSE))return{type:"literal",value:!1};if(r.match(m.ARRAY)){let t=sn(r);for(;r.check(m.LBRACKET);){r.advance();let n=H(r);r.expect(m.RBRACKET),t={type:"subscript",array:t,index:n}}return t}if(r.check(m.LBRACKET)){let t=sn(r);for(;r.check(m.LBRACKET);){r.advance();let n=H(r);r.expect(m.RBRACKET),t={type:"subscript",array:t,index:n}}return t}if(r.check(m.NUMBER)){let t=r.advance().value;return{type:"literal",value:parseFloat(t)}}if(r.check(m.STRING))return{type:"literal",value:r.advance().value};if([m.ROW_NUMBER,m.RANK,m.DENSE_RANK,m.NTILE,m.LAG,m.LEAD,m.FIRST_VALUE,m.LAST_VALUE,m.NTH_VALUE,m.PERCENT_RANK,m.CUME_DIST].some(t=>r.check(t))){let t=r.advance().type;r.expect(m.LPAREN);let n=[];if(!r.check(m.RPAREN))for(n.push(H(r));r.match(m.COMMA);)n.push(H(r));r.expect(m.RPAREN);let s=r.parseOverClause();return{type:"call",name:t,args:n,distinct:!1,over:s}}if(r.check(m.IDENTIFIER)||r.check(m.COUNT,m.SUM,m.AVG,m.MIN,m.MAX,m.GROUPING)){let t=r.advance().value;if(r.match(m.LPAREN)){let s=!!r.match(m.DISTINCT),o=[];if(!r.check(m.RPAREN))if(r.check(m.STAR))r.advance(),o.push({type:"star"});else for(o.push(H(r));r.match(m.COMMA);)o.push(H(r));r.expect(m.RPAREN);let i=null;return r.check(m.OVER)&&(i=r.parseOverClause()),{type:"call",name:t.toUpperCase(),args:o,distinct:s,over:i}}if(r.match(m.DOT)){let s=t,o=r.advance(),i=o.value||o.type.toLowerCase();return{type:"column",table:s,column:i}}let n={type:"column",column:t};if(r.check(m.LBRACKET)){r.advance();let s=H(r);r.expect(m.RBRACKET),n={type:"subscript",array:n,index:s}}return n}if(r.match(m.LPAREN)){if(r.check(m.SELECT)){let n=r.parseSelect(!0);return r.expect(m.RPAREN),{type:"subquery",query:n}}let t=H(r);return r.expect(m.RPAREN),t}if(r.match(m.STAR))return{type:"star"};throw new Error(`Unexpected token: ${r.current().type} (${r.current().value})`)}function wt(r){if(r.match(m.NULL))return{type:"null",value:null};if(r.match(m.TRUE))return{type:"boolean",value:!0};if(r.match(m.FALSE))return{type:"boolean",value:!1};if(r.check(m.NUMBER)){let e=r.advance();return{type:"number",value:e.value.includes(".")?parseFloat(e.value):parseInt(e.value,10)}}if(r.check(m.STRING))return{type:"string",value:r.advance().value};if(r.check(m.MINUS)){r.advance();let e=r.expect(m.NUMBER);return{type:"number",value:e.value.includes(".")?-parseFloat(e.value):-parseInt(e.value,10)}}if(r.check(m.LBRACKET))return sn(r);throw new Error(`Expected value, got ${r.current().type}`)}function sn(r){r.expect(m.LBRACKET);let e=[];if(!r.check(m.RBRACKET))for(e.push(H(r));r.match(m.COMMA);)e.push(H(r));return r.expect(m.RBRACKET),{type:"array",elements:e}}function ls(r){r.expect(m.WITH);let e=!!r.match(m.RECURSIVE),t=[];do{let n=r.expect(m.IDENTIFIER).value,s=[];if(r.match(m.LPAREN)){for(s.push(r.expect(m.IDENTIFIER).value);r.match(m.COMMA);)s.push(r.expect(m.IDENTIFIER).value);r.expect(m.RPAREN)}r.expect(m.AS),r.expect(m.LPAREN);let o=Xr(r,e);r.expect(m.RPAREN),t.push({name:n,columns:s,body:o,recursive:e})}while(r.match(m.COMMA));return t}function Xr(r,e){let t=r.parseSelect(!0,!0);if(e&&r.match(m.UNION)){r.expect(m.ALL);let n=r.parseSelect(!0,!0);return{type:"RECURSIVE_CTE",anchor:t,recursive:n}}return t}function cs(r){let e=[];do if(r.match(m.ROLLUP)){r.expect(m.LPAREN);let n=on(r);r.expect(m.RPAREN),e.push({type:"ROLLUP",columns:n})}else if(r.match(m.CUBE)){r.expect(m.LPAREN);let n=on(r);r.expect(m.RPAREN),e.push({type:"CUBE",columns:n})}else if(r.match(m.GROUPING)){r.expect(m.SETS),r.expect(m.LPAREN);let n=Zr(r);r.expect(m.RPAREN),e.push({type:"GROUPING_SETS",sets:n})}else e.push({type:"COLUMN",column:r.expect(m.IDENTIFIER).value});while(r.match(m.COMMA));let t=null;return r.match(m.TOPK)&&(t=parseInt(r.expect(m.NUMBER).value,10)),{items:e,topK:t}}function Zr(r){let e=[];do r.expect(m.LPAREN),r.check(m.RPAREN)?e.push([]):e.push(on(r)),r.expect(m.RPAREN);while(r.match(m.COMMA));return e}function on(r){let e=[r.expect(m.IDENTIFIER).value];for(;r.match(m.COMMA);)e.push(r.expect(m.IDENTIFIER).value);return e}function us(r){r.expect(m.OVER),r.expect(m.LPAREN);let e={partitionBy:[],orderBy:[],frame:null};if(r.match(m.PARTITION))for(r.expect(m.BY),e.partitionBy.push(r.parseExpr());r.match(m.COMMA);)e.partitionBy.push(r.parseExpr());return r.match(m.ORDER)&&(r.expect(m.BY),e.orderBy=r.parseOrderByList()),(r.check(m.ROWS)||r.check(m.RANGE))&&(e.frame=eo(r)),r.expect(m.RPAREN),e}function eo(r){let t={type:r.advance().type,start:null,end:null};return r.match(m.BETWEEN)?(t.start=rn(r),r.expect(m.AND),t.end=rn(r)):(t.start=rn(r),t.end={type:"CURRENT ROW"}),t}function rn(r){if(r.match(m.UNBOUNDED)){if(r.match(m.PRECEDING))return{type:"UNBOUNDED PRECEDING"};if(r.match(m.FOLLOWING))return{type:"UNBOUNDED FOLLOWING"};throw new Error("Expected PRECEDING or FOLLOWING after UNBOUNDED")}if(r.match(m.CURRENT))return r.expect(m.ROW),{type:"CURRENT ROW"};if(r.check(m.NUMBER)){let e=parseInt(r.advance().value,10);if(r.match(m.PRECEDING))return{type:"PRECEDING",offset:e};if(r.match(m.FOLLOWING))return{type:"FOLLOWING",offset:e};throw new Error("Expected PRECEDING or FOLLOWING after number")}throw new Error("Invalid frame bound")}function fs(r,e){r.expect(m.LPAREN);let t=e(r);if(t.type!=="call")throw new Error("PIVOT requires an aggregate function (e.g., SUM, COUNT, AVG)");r.expect(m.FOR);let n=r.expect(m.IDENTIFIER).value;r.expect(m.IN),r.expect(m.LPAREN);let s=[];for(s.push(e(r).value);r.match(m.COMMA);)s.push(e(r).value);return r.expect(m.RPAREN),r.expect(m.RPAREN),{aggregate:t,forColumn:n,inValues:s}}function hs(r){r.expect(m.LPAREN);let e=r.expect(m.IDENTIFIER).value;r.expect(m.FOR);let t=r.expect(m.IDENTIFIER).value;r.expect(m.IN),r.expect(m.LPAREN);let n=[];for(n.push(r.expect(m.IDENTIFIER).value);r.match(m.COMMA);)n.push(r.expect(m.IDENTIFIER).value);return r.expect(m.RPAREN),r.expect(m.RPAREN),{valueColumn:e,nameColumn:t,inColumns:n}}function ms(r){let e=null,t=null,n=null,s=20,o="minilm";if(r.check(m.IDENTIFIER)){let i=r.advance().value;if(r.check(m.STRING)||r.check(m.NUMBER))e=i;else throw new Error(`NEAR requires quoted text or row number. Did you mean: NEAR '${i}'?`)}if(r.check(m.STRING))t=r.advance().value;else if(r.check(m.NUMBER))n=parseInt(r.advance().value,10);else throw new Error("NEAR requires a quoted text string or row number");return r.match(m.TOPK)&&(s=parseInt(r.expect(m.NUMBER).value,10)),{query:t,searchRow:n,column:e,topK:s,encoder:o}}var K=class{constructor(e){this.tokens=e,this.pos=0}current(){return this.tokens[this.pos]||{type:m.EOF}}advance(){return this.pos<this.tokens.length?this.tokens[this.pos++]:{type:m.EOF}}expect(e){let t=this.current();if(t.type!==e)throw new Error(`Expected ${e}, got ${t.type} (${t.value})`);return this.advance()}match(...e){return e.includes(this.current().type)?this.advance():null}check(...e){return e.includes(this.current().type)}parse(){if(this.check(m.EXPLAIN))return this.advance(),{type:"EXPLAIN",statement:this.parse()};let e=[];if(this.check(m.WITH)&&(e=ls(this)),this.check(m.SELECT)){let t=this.parseSelect();return t.ctes=e,t}else{if(this.check(m.INSERT))return this.parseInsert();if(this.check(m.UPDATE))return this.parseUpdate();if(this.check(m.DELETE))return this.parseDelete();if(this.check(m.CREATE))return this.parseCreateTable();if(this.check(m.DROP))return this.parseDropTable();throw new Error(`Unexpected token: ${this.current().type}. Expected SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, or EXPLAIN`)}}parseSelect(e=!1,t=!1){this.expect(m.SELECT);let n=!!this.match(m.DISTINCT),s=this.parseSelectList(),o=null;this.match(m.FROM)&&(o=this.parseFromClause());let i=[];for(;this.check(m.JOIN)||this.check(m.INNER)||this.check(m.LEFT)||this.check(m.RIGHT)||this.check(m.FULL)||this.check(m.CROSS);)i.push(this.parseJoinClause());let a=null;this.match(m.PIVOT)&&(a=fs(this,me));let l=null;this.match(m.UNPIVOT)&&(l=hs(this));let c=null;this.match(m.WHERE)&&(c=this.parseExpr());let u=[],f=null;if(this.match(m.GROUP)){this.expect(m.BY);let b=cs(this);u=b.items,f=b.topK}let h=null;this.match(m.HAVING)&&(h=this.parseExpr());let d=null;this.match(m.QUALIFY)&&(d=this.parseExpr());let p=null;this.match(m.NEAR)&&(p=ms(this));let g={type:"SELECT",distinct:n,columns:s,from:o,joins:i,pivot:a,unpivot:l,where:c,groupBy:u,groupByTopK:f,having:h,qualify:d,search:p,orderBy:[],limit:null,offset:null};if(!t&&(this.check(m.UNION)||this.check(m.INTERSECT)||this.check(m.EXCEPT))){let b=this.advance().type,y=!!this.match(m.ALL),w=this.parseSelect(!0,!0),E=[],_=null,S=null;if(this.match(m.ORDER)&&(this.expect(m.BY),E=this.parseOrderByList()),(this.match(m.LIMIT)||this.match(m.TOPK))&&(_=parseInt(this.expect(m.NUMBER).value,10)),E.length===0&&this.match(m.ORDER)&&(this.expect(m.BY),E=this.parseOrderByList()),this.match(m.OFFSET)&&(S=parseInt(this.expect(m.NUMBER).value,10)),!e&&this.current().type!==m.EOF)throw new Error(`Unexpected token after query: ${this.current().type} (${this.current().value}). Check your SQL syntax.`);return{type:"SET_OPERATION",operator:b,all:y,left:g,right:w,orderBy:E,limit:_,offset:S,groupByTopK:g.groupByTopK}}if(!t){let b=[],y=null,w=null;this.match(m.ORDER)&&(this.expect(m.BY),b=this.parseOrderByList()),(this.match(m.LIMIT)||this.match(m.TOPK))&&(y=parseInt(this.expect(m.NUMBER).value,10)),b.length===0&&this.match(m.ORDER)&&(this.expect(m.BY),b=this.parseOrderByList()),this.match(m.OFFSET)&&(w=parseInt(this.expect(m.NUMBER).value,10)),g.orderBy=b,g.limit=y,g.offset=w}if(!e&&this.current().type!==m.EOF)throw new Error(`Unexpected token after query: ${this.current().type} (${this.current().value}). Check your SQL syntax.`);return g}parseInsert(){this.expect(m.INSERT),this.expect(m.INTO);let e=this.expect(m.IDENTIFIER).value,t=null;if(this.match(m.LPAREN)){for(t=[],t.push(this.expect(m.IDENTIFIER).value);this.match(m.COMMA);)t.push(this.expect(m.IDENTIFIER).value);this.expect(m.RPAREN)}this.expect(m.VALUES);let n=[];do{this.expect(m.LPAREN);let s=[];for(s.push(wt(this));this.match(m.COMMA);)s.push(wt(this));this.expect(m.RPAREN),n.push(s)}while(this.match(m.COMMA));return{type:"INSERT",table:e,columns:t,rows:n}}parseUpdate(){this.expect(m.UPDATE);let e=this.expect(m.IDENTIFIER).value;this.expect(m.SET);let t=[];do{let s=this.expect(m.IDENTIFIER).value;this.expect(m.EQ);let o=wt(this);t.push({column:s,value:o})}while(this.match(m.COMMA));let n=null;return this.match(m.WHERE)&&(n=this.parseExpr()),{type:"UPDATE",table:e,assignments:t,where:n}}parseDelete(){this.expect(m.DELETE),this.expect(m.FROM);let e=this.expect(m.IDENTIFIER).value,t=null;return this.match(m.WHERE)&&(t=this.parseExpr()),{type:"DELETE",table:e,where:t}}parseCreateTable(){this.expect(m.CREATE),this.expect(m.TABLE);let e=!1;this.match(m.IF)&&(this.expect(m.NOT),this.expect(m.EXISTS),e=!0);let t=this.expect(m.IDENTIFIER).value;this.expect(m.LPAREN);let n=[];do{let s=this.expect(m.IDENTIFIER).value,o="TEXT",i=!1,a=null;this.check(m.INT)||this.check(m.INTEGER)||this.check(m.BIGINT)?(this.advance(),o="INT64"):this.check(m.FLOAT)||this.check(m.REAL)||this.check(m.DOUBLE)?(this.advance(),o="FLOAT64"):this.check(m.TEXT)||this.check(m.VARCHAR)?(this.advance(),o="STRING"):this.check(m.BOOLEAN)||this.check(m.BOOL)?(this.advance(),o="BOOL"):this.check(m.VECTOR)&&(this.advance(),o="VECTOR",this.match(m.LPAREN)&&(a=parseInt(this.expect(m.NUMBER).value,10),this.expect(m.RPAREN))),this.match(m.PRIMARY)&&(this.expect(m.KEY),i=!0),n.push({name:s,dataType:o,primaryKey:i,vectorDim:a})}while(this.match(m.COMMA));return this.expect(m.RPAREN),{type:"CREATE_TABLE",table:t,columns:n,ifNotExists:e}}parseDropTable(){this.expect(m.DROP),this.expect(m.TABLE);let e=!1;return this.match(m.IF)&&(this.expect(m.EXISTS),e=!0),{type:"DROP_TABLE",table:this.expect(m.IDENTIFIER).value,ifExists:e}}parseSelectList(){let e=[this.parseSelectItem()];for(;this.match(m.COMMA);)e.push(this.parseSelectItem());return e}parseSelectItem(){if(this.match(m.STAR))return{type:"star"};let e=this.parseExpr(),t=null;return this.match(m.AS)?t=this.expect(m.IDENTIFIER).value:this.check(m.IDENTIFIER)&&!this.check(m.FROM,m.WHERE,m.ORDER,m.LIMIT,m.TOPK,m.GROUP,m.JOIN,m.INNER,m.LEFT,m.RIGHT,m.COMMA)&&(t=this.advance().value),{type:"expr",expr:e,alias:t}}parseFromClause(){let e=null;if(this.check(m.STRING))e={type:"url",url:this.advance().value};else if(this.check(m.IDENTIFIER)){let t=this.advance().value;if(this.match(m.LPAREN))if(t.toLowerCase()==="read_lance")e={type:"url",function:"read_lance"},this.check(m.RPAREN)||(this.match(m.FILE)?(e.isFile=!0,this.match(m.COMMA)&&(e.version=parseInt(this.expect(m.NUMBER).value,10))):this.check(m.STRING)&&(e.url=this.advance().value,this.match(m.COMMA)&&(e.version=parseInt(this.expect(m.NUMBER).value,10)))),this.expect(m.RPAREN);else throw new Error(`Unknown table function: ${t}. Supported: read_lance()`);else e={type:"table",name:t}}else throw new Error("Expected table name, URL string, or read_lance() after FROM");return e&&(this.match(m.AS)?e.alias=this.expect(m.IDENTIFIER).value:this.check(m.IDENTIFIER)&&!this.check(m.WHERE,m.ORDER,m.LIMIT,m.TOPK,m.GROUP,m.NEAR,m.JOIN,m.INNER,m.LEFT,m.RIGHT,m.COMMA)&&(e.alias=this.advance().value)),e}parseJoinClause(){let e="INNER";this.match(m.INNER)?(this.expect(m.JOIN),e="INNER"):this.match(m.LEFT)?(this.match(m.OUTER),this.expect(m.JOIN),e="LEFT"):this.match(m.RIGHT)?(this.match(m.OUTER),this.expect(m.JOIN),e="RIGHT"):this.match(m.FULL)?(this.match(m.OUTER),this.expect(m.JOIN),e="FULL"):this.match(m.CROSS)?(this.expect(m.JOIN),e="CROSS"):this.expect(m.JOIN);let t=this.parseFromClause(),n=t.alias||null,s=null;return e!=="CROSS"&&(this.expect(m.ON),s=this.parseExpr()),{type:e,table:t,alias:n,on:s}}parseOrderByList(){let e=[this.parseOrderByItem()];for(;this.match(m.COMMA);)e.push(this.parseOrderByItem());return e}parseOrderByItem(){let e=this.expect(m.IDENTIFIER).value,t=!1;return this.match(m.DESC)?t=!0:this.match(m.ASC),{column:e,descending:t}}parseExpr(){return H(this)}parseOverClause(){return us(this)}};var qe=class{constructor(){this._cache=new Map,this._opfsRoot=null,this._computing=new Map}async _getStatsDir(){if(this._opfsRoot)return this._opfsRoot;if(typeof navigator>"u"||!navigator.storage?.getDirectory)return null;try{let e=await navigator.storage.getDirectory();return this._opfsRoot=await e.getDirectoryHandle("lanceql-stats",{create:!0}),this._opfsRoot}catch{return null}}_getCacheKey(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return`stats_${Math.abs(t).toString(16)}`}async loadFromCache(e,t){let n=this._getCacheKey(e);if(this._cache.has(n)){let o=this._cache.get(n);if(o.version===t)return o}let s=await this._getStatsDir();if(!s)return null;try{let a=await(await(await s.getFileHandle(`${n}.json`)).getFile()).text(),l=JSON.parse(a);return l.version!==t?null:(this._cache.set(n,l),l)}catch{return null}}async saveToCache(e,t,n){let s=this._getCacheKey(e),o={datasetUrl:e,version:t,timestamp:Date.now(),columns:n.columns,fragments:n.fragments||null};this._cache.set(s,o);let i=await this._getStatsDir();if(i)try{let l=await(await i.getFileHandle(`${s}.json`,{create:!0})).createWritable();await l.write(JSON.stringify(o)),await l.close()}catch{}}async getColumnStats(e,t,n={}){let s=e.baseUrl,o=e._version,i=n.sampleSize||1e5,a=await this.loadFromCache(s,o);if(a?.columns?.[t])return a.columns[t];let l=`${s}:${t}`;if(this._computing.has(l))return this._computing.get(l);let c=this._computeColumnStats(e,t,i);this._computing.set(l,c);try{let u=await c,f=await this.loadFromCache(s,o)||{columns:{}};return f.columns[t]=u,await this.saveToCache(s,o,f),u}finally{this._computing.delete(l)}}async _computeColumnStats(e,t,n){let s=e.schema.findIndex(c=>c.name===t);if(s===-1)throw new Error(`Column not found: ${t}`);let o=e._columnTypes?.[s]||"unknown",i=["int8","int16","int32","int64","float32","float64","double"].includes(o),a={column:t,type:o,rowCount:0,nullCount:0,min:null,max:null,computed:!0,sampleSize:0},l=0;for(let c=0;c<e._fragments.length&&l<n;c++)try{let u=await e.openFragment(c),f=Math.min(e._fragments[c].numRows,n-l),h=Array.from({length:f},(p,g)=>g),d=await u.readColumnAtIndices(s,h);for(let p of d){if(a.rowCount++,a.sampleSize++,p==null){a.nullCount++;continue}i&&((a.min===null||p<a.min)&&(a.min=p),(a.max===null||p>a.max)&&(a.max=p))}l+=d.length}catch{}return a}async precomputeForPlan(e,t){let n=new Set;for(let a of t.pushedFilters||[])a.column&&n.add(a.column),a.left?.column&&n.add(a.left.column),a.right?.column&&n.add(a.right.column);let s=Array.from(n).map(a=>this.getColumnStats(e,a).catch(()=>null)),o=await Promise.all(s),i=new Map;return Array.from(n).forEach((a,l)=>{o[l]&&i.set(a,o[l])}),i}canMatchFragment(e,t){if(!e||!t)return!0;let n=e[t.column];if(!n||n.min===null||n.max===null)return!0;switch(t.type){case"equality":return t.value>=n.min&&t.value<=n.max;case"range":switch(t.op){case">":return n.max>t.value;case">=":return n.max>=t.value;case"<":return n.min<t.value;case"<=":return n.min<=t.value}break;case"between":return n.max>=t.low&&n.min<=t.high;case"in":if(Array.isArray(t.values))return t.values.some(s=>s>=n.min&&s<=n.max);break}return!0}async getFragmentStats(e,t,n){let s=e.baseUrl,o=e._version,i=await this.loadFromCache(s,o);if(i?.fragments?.[n]?.[t])return i.fragments[n][t];let a=e.schema.findIndex(u=>u.name===t);if(a===-1)return null;let l=e._columnTypes?.[a]||"unknown",c=["int8","int16","int32","int64","float32","float64","double"].includes(l);try{let u=await e.openFragment(n),f=e._fragments[n].numRows,h=Math.min(f,1e4),d=Array.from({length:h},(y,w)=>w),p=await u.readColumnAtIndices(a,d),g={fragmentIndex:n,column:t,rowCount:f,sampledRows:h,nullCount:0,min:null,max:null};for(let y of p){if(y==null){g.nullCount++;continue}c&&((g.min===null||y<g.min)&&(g.min=y),(g.max===null||y>g.max)&&(g.max=y))}let b=await this.loadFromCache(s,o)||{columns:{},fragments:{}};return b.fragments||(b.fragments={}),b.fragments[n]||(b.fragments[n]={}),b.fragments[n][t]=g,await this.saveToCache(s,o,b),g}catch{return null}}async getPrunableFragments(e,t){if(!t||t.length===0||!e._fragments)return null;let n=e._fragments.length,s=[],o=0,i=new Set;for(let a of t)a.column&&i.add(a.column);for(let a=0;a<n;a++){let l=!1;for(let c of t){if(!c.column)continue;let u=await this.getFragmentStats(e,c.column,a);if(u&&!this.canMatchFragment({[c.column]:u},c)){l=!0;break}}l?o++:s.push(a)}return{matchingFragments:s,fragmentsPruned:o,totalFragments:n}}},an=new qe;var bt=class{constructor(e={}){this.isRemote=e.isRemote??!0,this.rttLatency=e.rttLatency??50,this.bandwidthMBps=e.bandwidthMBps??10,this.filterCostPerRow=e.filterCostPerRow??.001,this.hashBuildCostPerRow=e.hashBuildCostPerRow??.01,this.hashProbeCostPerRow=e.hashProbeCostPerRow??.005,this.memoryLimitMB=e.memoryLimitMB??512}estimateScanCost(e,t,n=1){let s=e*t*n,o=this.isRemote?this.rttLatency+s/(this.bandwidthMBps*1024*1024)*1e3:.1,i=e*this.filterCostPerRow;return{totalMs:o+i,networkMs:o,cpuMs:i,bytesToFetch:s,rowsToScan:e*n}}estimateJoinCost(e,t,n,s,o=.1){let i=Math.min(e,t),a=i<e?n:s,l=i*this.hashBuildCostPerRow,u=Math.max(e,t)*this.hashProbeCostPerRow,f=i*a/(1024*1024),h=f>this.memoryLimitMB,d=h?f*10:0;return{totalMs:l+u+d,buildMs:l,probeMs:u,spillMs:d,needsSpill:h,outputRows:Math.round(e*t*o)}}estimateAggregateCost(e,t,n){let s=e*this.hashBuildCostPerRow,o=e*n*1e-4;return{totalMs:s+o,outputRows:t}}comparePlans(e,t){let n=e.totalCost||this.estimatePlanCost(e),s=t.totalCost||this.estimatePlanCost(t);return{recommended:n.totalMs<s.totalMs?"A":"B",costA:n,costB:s,savings:Math.abs(n.totalMs-s.totalMs)}}estimatePlanCost(e){let t=0,n=0,s=[];if(e.leftScan){let o=this.estimateScanCost(e.leftScan.estimatedRows||1e4,e.leftScan.columnBytes||100,e.leftScan.selectivity||1);t+=o.totalMs,n+=o.bytesToFetch,s.push({op:"scan_left",...o})}if(e.rightScan){let o=this.estimateScanCost(e.rightScan.estimatedRows||1e4,e.rightScan.columnBytes||100,e.rightScan.selectivity||1);t+=o.totalMs,n+=o.bytesToFetch,s.push({op:"scan_right",...o})}if(e.join){let o=this.estimateJoinCost(e.leftScan?.estimatedRows||1e4,e.rightScan?.estimatedRows||1e4,e.leftScan?.columnBytes||100,e.rightScan?.columnBytes||100,e.join.selectivity||.1);t+=o.totalMs,s.push({op:"join",...o})}if(e.aggregations&&e.aggregations.length>0){let o=this.estimateAggregateCost(e.estimatedInputRows||1e4,e.groupBy?.length||1,e.aggregations.length);t+=o.totalMs,s.push({op:"aggregate",...o})}return{totalMs:t,totalBytes:n,operations:s,isRemote:this.isRemote}}};function ds(r,e){let t={type:e.type,scanColumns:[],pushedFilters:[],postFilters:[],aggregations:[],groupBy:[],having:null,orderBy:[],limit:e.limit||null,offset:e.offset||0,projection:[],canUseStatistics:!1,canStreamResults:!0,estimatedSelectivity:1},n=new Set;if(e.columns==="*"||Array.isArray(e.columns)&&e.columns.some(s=>s.type==="star"))t.projection=["*"],t.canStreamResults=!1;else if(Array.isArray(e.columns))for(let s of e.columns)no(s,n,t);if(e.where&&(te(e.where,n),un(e.where,t)),e.groupBy&&e.groupBy.length>0)for(let s of e.groupBy)te(s,n),t.groupBy.push(s);if(e.having&&(te(e.having,n),t.having=e.having),e.orderBy&&e.orderBy.length>0)for(let s of e.orderBy)te(s.expr||s,n),t.orderBy.push(s);return t.scanColumns=Array.from(n),t.estimatedSelectivity=so(t.pushedFilters),t.canUseStatistics=t.pushedFilters.some(s=>s.type==="range"||s.type==="equality"),t}function no(r,e,t){if(r.type==="star"){t.projection.push("*");return}if(r.type==="expr"){let n=r.expr;if(n.type==="call"){let s=n.name.toUpperCase();if(["COUNT","SUM","AVG","MIN","MAX","STDDEV","STDDEV_SAMP","STDDEV_POP","VARIANCE","VAR_SAMP","VAR_POP","MEDIAN","STRING_AGG","GROUP_CONCAT"].includes(s)){let i={type:s,column:null,alias:r.alias||`${s}(${n.args[0]?.name||"*"})`,distinct:n.distinct||!1};if(n.args&&n.args.length>0){let a=n.args[0];a.type==="column"?(i.column=a.name||a.column,e.add(i.column)):a.type!=="star"&&te(a,e)}t.aggregations.push(i),t.projection.push({type:"aggregation",index:t.aggregations.length-1});return}}te(n,e),t.projection.push({type:"column",expr:n,alias:r.alias})}}function te(r,e){if(r)if(r.type==="column")e.add(r.name||r.column);else if(r.type==="binary")te(r.left,e),te(r.right,e);else if(r.type==="call")for(let t of r.args||[])te(t,e);else r.type==="unary"&&te(r.operand,e)}function un(r,e){if(r)if(r.type==="binary")if(ln(r))e.pushedFilters.push(cn(r));else if(r.op==="AND")un(r.left,e),un(r.right,e);else if(r.op==="OR"){let t=ln(r.left),n=ln(r.right);t&&n?e.pushedFilters.push({type:"or",left:cn(r.left),right:cn(r.right)}):e.postFilters.push(r)}else e.postFilters.push(r);else e.postFilters.push(r)}function ln(r){if(r.type!=="binary"||!["=","==","!=","<>","<","<=",">",">=","LIKE","IN","BETWEEN"].includes(r.op.toUpperCase()))return!1;let t=r.left.type==="column",n=r.right?.type==="column",s=r.left.type==="literal"||r.left.type==="list",o=r.right?.type==="literal"||r.right?.type==="list";return t&&o||n&&s}function cn(r){let e=r.left.type==="column",t=e?r.left.name||r.left.column:r.right.name||r.right.column,n=e?r.right.value:r.left.value,s=r.op.toUpperCase();if(s==="="||s==="==")return{type:"equality",column:t,value:n,op:"="};if(s==="!="||s==="<>")return{type:"inequality",column:t,value:n,op:"!="};if(["<","<=",">",">="].includes(s))return{type:"range",column:t,value:n,op:s};if(s==="LIKE")return{type:"like",column:t,pattern:n};if(s==="IN"){let o=r.right.type==="list"?r.right.values:[r.right.value];return{type:"in",column:t,values:o}}else if(s==="BETWEEN")return{type:"between",column:t,low:r.right.low,high:r.right.high};return{type:"unknown",expr:r}}function so(r){if(r.length===0)return 1;let e=1;for(let t of r)switch(t.type){case"equality":e*=.1;break;case"range":e*=.3;break;case"in":e*=Math.min(.5,t.values.length*.05);break;case"like":e*=t.pattern.startsWith("%")?.5:.2;break;default:e*=.5}return Math.max(.01,e)}var de=class{plan(e,t){let{leftTableName:n,leftAlias:s,rightTableName:o,rightAlias:i}=t,a=this._analyzeColumns(e,t),l=this._analyzeFilters(e,t),c=this._estimateFetchSize(e,l);return{leftScan:{table:n,alias:s,columns:a.left.all,filters:l.left,limit:c.left,purpose:{join:a.left.join,where:a.left.where,result:a.left.result}},rightScan:{table:o,alias:i,columns:a.right.all,filters:l.right,filterByJoinKeys:!0,purpose:{join:a.right.join,where:a.right.where,result:a.right.result}},join:{type:e.joins[0].type,leftKey:a.joinKeys.left,rightKey:a.joinKeys.right,algorithm:"HASH_JOIN"},projection:a.resultColumns,limit:e.limit||null,offset:e.offset||0}}planSingleTable(e){return ds(this,e)}_analyzeColumns(e,t){let{leftAlias:n,rightAlias:s}=t,o={join:new Set,where:new Set,result:new Set,all:[]},i={join:new Set,where:new Set,result:new Set,all:[]};for(let u of e.columns)if(u.type==="star")o.result.add("*"),i.result.add("*");else if(u.type==="expr"&&u.expr.type==="column"){let f=u.expr,h=f.table||null,d=f.column;(!h||h===n)&&o.result.add(d),(!h||h===s)&&i.result.add(d)}let a=e.joins[0],l=this._extractJoinKeys(a.on,n,s);l.left&&o.join.add(l.left),l.right&&i.join.add(l.right),e.where&&this._extractWhereColumns(e.where,n,s,o.where,i.where),o.all=[...new Set([...o.join,...o.where,...o.result])],i.all=[...new Set([...i.join,...i.where,...i.result])],o.result.has("*")&&(o.all=["*"]),i.result.has("*")&&(i.all=["*"]);let c=[];for(let u of e.columns)if(u.type==="star")c.push("*");else if(u.type==="expr"&&u.expr.type==="column"){let f=u.expr,h=u.alias||`${f.table||""}.${f.column}`.replace(/^\./,"");c.push({table:f.table,column:f.column,alias:h})}return{left:o,right:i,joinKeys:l,resultColumns:c}}_extractJoinKeys(e,t,n){if(!e||e.type!=="binary")return{left:null,right:null};let s=e.left,o=e.right,i=null,a=null;return s.type==="column"&&(!s.table||s.table===t?i=s.column:s.table===n&&(a=s.column)),o.type==="column"&&(!o.table||o.table===t?i=o.column:o.table===n&&(a=o.column)),{left:i,right:a}}_extractWhereColumns(e,t,n,s,o){if(e)if(e.type==="column"){let i=e.table,a=e.column;!i||i===t?s.add(a):i===n&&o.add(a)}else e.type==="binary"?(this._extractWhereColumns(e.left,t,n,s,o),this._extractWhereColumns(e.right,t,n,s,o)):e.type==="unary"&&this._extractWhereColumns(e.expr,t,n,s,o)}_analyzeFilters(e,t){let{leftAlias:n,rightAlias:s}=t,o=[],i=[],a=[];return e.where&&this._separateFilters(e.where,n,s,o,i,a),{left:o,right:i,join:a}}_separateFilters(e,t,n,s,o,i){if(!e)return;if(e.type==="binary"&&e.op==="AND"){this._separateFilters(e.left,t,n,s,o,i),this._separateFilters(e.right,t,n,s,o,i);return}let a=this._getReferencedTables(e,t,n);a.size===1?a.has(t)?s.push(e):a.has(n)&&o.push(e):a.size>1&&i.push(e)}_getReferencedTables(e,t,n){let s=new Set,o=i=>{if(i)if(i.type==="column"){let a=i.table;a?a===t?s.add(t):a===n&&s.add(n):(s.add(t),s.add(n))}else if(i.type==="binary")o(i.left),o(i.right);else if(i.type==="unary")o(i.operand);else if(i.type==="call")for(let a of i.args||[])o(a);else if(i.type==="in"){o(i.expr);for(let a of i.values||[])o(a)}else i.type==="between"?(o(i.expr),o(i.low),o(i.high)):i.type==="like"&&(o(i.expr),o(i.pattern))};return o(e),s}_estimateFetchSize(e,t){let n=e.limit||1e3,s=t.left.length>0?.5:1,a=Math.ceil(n/(s*.7)*2.5);return{left:Math.min(a,1e4),right:null}}};function Te(r){if(!r)return null;if(r.type==="near"){let e=r.column?.name||r.column,t=r.value?.value??r.value;return{column:e,value:t,limit:20}}if(r.type==="binary"&&(r.op==="AND"||r.op==="OR")){let e=Te(r.left);return e||Te(r.right)}return null}function Re(r){if(!r||r.type==="near")return null;if(r.type==="binary"&&(r.op==="AND"||r.op==="OR")){let e=r.left?.type==="near",t=r.right?.type==="near";if(e&&t)return null;if(e)return Re(r.right);if(t)return Re(r.left);let n=Re(r.left),s=Re(r.right);return!n&&!s?null:n?s?{...r,left:n,right:s}:n:s}return r}function ps(r){return!r||typeof r!="string"?[]:r.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter(e=>e.length>1).filter(e=>!oo(e))}function oo(r){return new Set(["a","an","the","and","or","but","in","on","at","to","for","of","with","by","from","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","could","should","may","might","must","shall","can","need","it","its","this","that","these","those","i","you","he","she","we","they","what","which","who","whom","where","when","why","how"]).has(r)}function io(r,e){let s=new Map;for(let o of r){let i=e.termDocs.get(o);if(!i)continue;let a=i.size,l=e.totalDocs,c=Math.log((l-a+.5)/(a+.5)+1);for(let u of i){let f=e.termFreqs.get(o).get(u),h=e.docLengths.get(u),d=e.avgDocLength,p=f*(1.2+1),g=f+1.2*(1-.75+.75*h/d),b=c*(p/g);s.set(u,(s.get(u)||0)+b)}}return s}function ao(r,e){return Array.from(r.entries()).sort((t,n)=>n[1]-t[1]).slice(0,e).map(([t])=>t)}async function lo(r,e,t){let n={termDocs:new Map,termFreqs:new Map,docLengths:new Map,totalDocs:0,avgDocLength:0},s=1e3,o=0;for(let i=0;i<t;i+=s){let a=Math.min(i+s,t),l=Array.from({length:a-i},(u,f)=>i+f),c=await r(e,l);for(let u=0;u<c.length;u++){let f=i+u,h=c[u];if(!h||typeof h!="string")continue;let d=ps(h);n.docLengths.set(f,d.length),o+=d.length,n.totalDocs++;let p=new Map;for(let g of d)p.set(g,(p.get(g)||0)+1);for(let[g,b]of p)n.termDocs.has(g)||(n.termDocs.set(g,new Set),n.termFreqs.set(g,new Map)),n.termDocs.get(g).add(f),n.termFreqs.get(g).set(f,b)}}return n.avgDocLength=n.totalDocs>0?o/n.totalDocs:0,n}async function co(r,e,t){let{column:n,value:s,limit:o}=e,i=r.columnMap[n.toLowerCase()];if(i===void 0)throw new Error(`Column '${n}' not found for text search`);let a=ps(s);if(a.length===0)return[];let l=`fts_${i}_${t}`;r.file._ftsIndexCache||(r.file._ftsIndexCache=new Map);let c=r.file._ftsIndexCache.get(l);c||(c=await lo((f,h)=>r.readColumnData(f,h),i,t),r.file._ftsIndexCache.set(l,c));let u=io(a,c);return ao(u,o)}async function gs(r,e,t){let{column:n,value:s,limit:o}=e,i=r.file.columnNames?.find(c=>c==="embedding"||c===`${n}_embedding`||c.endsWith("_embedding")||c.endsWith("_vector"));if(!i)return await co(r,e,t);let a=r.columnMap[i.toLowerCase()];if(a===void 0)throw new Error(`Vector column '${i}' found but index missing`);let l=Math.min(o,t);try{return(await r.file.vectorSearch(a,s,l)).map(u=>u.index)}catch(c){throw console.error("[SQLExecutor] Vector search failed:",c),new Error(`NEAR search failed: ${c.message}`)}}async function ys(r,e,t,n,s){s&&s("Executing vector search...",0,100);let o=await gs(r,e,n);if(!o||o.length===0)return[];let i=Re(t);if(!i)return o;s&&s("Applying filters...",50,100);let a=new Set;r.collectColumnsFromExpr(i,a);let l={};for(let u of a){let f=r.columnMap[u.toLowerCase()];f!==void 0&&(l[u.toLowerCase()]=await r.readColumnData(f,o))}let c=[];for(let u=0;u<o.length;u++)r.evaluateExpr(i,l,u)&&c.push(o[u]);return c}async function uo(r,e,t){let n=new Set;r.collectColumnsFromExpr(t,n);let s={};for(let o of n){let i=r.columnMap[o.toLowerCase()];i!==void 0&&(s[o.toLowerCase()]=await r.readColumnData(i,e))}return e.filter((o,i)=>r.evaluateExpr(t,s,i))}async function ws(r,e,t,n){let s=Te(e.where);if(!s)return await r.executeAggregateQuery(e,t,n);let o=await gs(r,s,t);if(o.length===0)return r._emptyAggregateResult(e);let i=Re(e.where),a=o;return i&&(a=await uo(r,o,i)),a.length===0?r._emptyAggregateResult(e):e.groupBy&&e.groupBy.length>0?await r._executeGroupByOnIndices(e,a,n):await r._executeSimpleAggregateOnIndices(e,a,n)}function bs(r){return r.columns?.some(e=>e.expr?.type==="call"&&e.expr.over)}function hn(r,e,t,n){if(!e||e.length===0)return[r.map((o,i)=>({idx:i,row:o}))];let s=new Map;for(let o=0;o<r.length;o++){let i=e.map(a=>JSON.stringify(n(a,t,o))).join("|");s.has(i)||s.set(i,[]),s.get(i).push({idx:o,row:r[o]})}return Array.from(s.values())}function pe(r,e,t,n,s){for(let o of t){let i=s({type:"column",column:o.column},n,r.idx),a=s({type:"column",column:o.column},n,e.idx),l=o.direction==="DESC"?-1:1;if(!(i==null&&a==null)){if(i==null)return 1*l;if(a==null||i<a)return-1*l;if(i>a)return 1*l}}return 0}function fn(r,e,t){let n=e.length,s=0,o=t,i=r.start||{type:"UNBOUNDED PRECEDING"},a=i.type.replace(" ","_").toUpperCase(),l=Number(i.offset??i.value??1)||1;switch(a){case"UNBOUNDED_PRECEDING":s=0;break;case"CURRENT_ROW":s=t;break;case"PRECEDING":s=Math.max(0,t-l);break;case"FOLLOWING":s=Math.min(n-1,t+l);break}let c=r.end||{type:"CURRENT ROW"},u=c.type.replace(" ","_").toUpperCase(),f=Number(c.offset??c.value??1)||1;switch(u){case"UNBOUNDED_FOLLOWING":o=n-1;break;case"CURRENT_ROW":o=t;break;case"PRECEDING":o=Math.max(0,t-f);break;case"FOLLOWING":o=Math.min(n-1,t+f);break}return s>o&&([s,o]=[o,s]),[s,o]}function ho(r,e,t,n,s,o){let i=new Array(n.length).fill(null),a=hn(n,t.partitionBy,s,o);for(let l of a){t.orderBy&&t.orderBy.length>0&&l.sort((c,u)=>pe(c,u,t.orderBy,s,o));for(let c=0;c<l.length;c++){let u=l[c].idx;switch(r){case"ROW_NUMBER":i[u]=c+1;break;case"RANK":{c>0&&pe(l[c-1],l[c],t.orderBy,s,o)===0?i[u]=i[l[c-1].idx]:i[u]=c+1;break}case"DENSE_RANK":{c===0?i[u]=1:pe(l[c-1],l[c],t.orderBy,s,o)===0?i[u]=i[l[c-1].idx]:i[u]=i[l[c-1].idx]+1;break}case"NTILE":{let f=Math.max(1,Number(e[0]?.value)||1),h=Math.min(f,l.length);i[u]=Math.floor(c*h/l.length)+1;break}case"PERCENT_RANK":{let f=c+1;for(let d=0;d<c;d++)if(pe(l[d],l[c],t.orderBy,s,o)===0){f=d+1;break}let h=l.length;i[u]=h>1?(f-1)/(h-1):0;break}case"CUME_DIST":{let f=0;for(let h=0;h<l.length;h++)pe(l[h],l[c],t.orderBy,s,o)<=0&&f++;i[u]=f/l.length;break}case"LAG":{let f=e[0],h=e[1]?.value||1,d=e[2]?.value??null;if(c>=h){let p=l[c-h].idx;i[u]=o(f,s,p)}else i[u]=d;break}case"LEAD":{let f=e[0],h=e[1]?.value||1,d=e[2]?.value??null;if(c+h<l.length){let p=l[c+h].idx;i[u]=o(f,s,p)}else i[u]=d;break}case"FIRST_VALUE":{let f=l[0].idx;i[u]=o(e[0],s,f);break}case"LAST_VALUE":{let f=t.frame||{type:"RANGE",start:{type:"UNBOUNDED_PRECEDING"},end:{type:"CURRENT_ROW"}},[,h]=fn(f,l,c),d=l[h].idx;i[u]=o(e[0],s,d);break}case"NTH_VALUE":{let f=Number(e[1]?.value)||1,h=t.frame||{type:"RANGE",start:{type:"UNBOUNDED_PRECEDING"},end:{type:"CURRENT_ROW"}},[d,p]=fn(h,l,c),g=p-d+1;if(f>0&&f<=g){let b=l[d+f-1].idx;i[u]=o(e[0],s,b)}else i[u]=null;break}case"SUM":case"AVG":case"COUNT":case"MIN":case"MAX":{let f=t.frame||{type:"RANGE",start:{type:"UNBOUNDED_PRECEDING"},end:{type:"CURRENT_ROW"}},[h,d]=fn(f,l,c),p=e[0]?.type==="star",g=[],b=0;for(let w=h;w<=d;w++)if(b++,!p){let E=o(e[0],s,l[w].idx),_=Number(E);E!=null&&!isNaN(_)&&g.push(_)}let y=null;switch(r){case"SUM":y=g.reduce((w,E)=>w+E,0);break;case"AVG":y=g.length>0?g.reduce((w,E)=>w+E,0)/g.length:null;break;case"COUNT":y=p?b:g.length;break;case"MIN":y=g.length>0?Math.min(...g):null;break;case"MAX":y=g.length>0?Math.max(...g):null;break}i[u]=y;break}default:i[u]=null}}}return i}function mn(r,e,t,n){let s=[];for(let o=0;o<r.columns.length;o++){let i=r.columns[o];if(i.expr?.type==="call"&&i.expr.over){let a=ho(i.expr.name,i.expr.args,i.expr.over,e,t,n);s.push({colIndex:o,alias:i.alias||i.expr.name,values:a})}}return s}function Es(r,e,t,n,s){let o=s.map(h=>t.rows[h]),i=mn(e,o,n,(h,d,p)=>r._evaluateInMemoryExpr(h,d,p)),a=[];for(let h of e.columns)if(h.alias)a.push(h.alias);else if(h.expr?.type==="call"){let d=h.expr.args?.[0]?.name||h.expr.args?.[0]?.column||"*";a.push(`${h.expr.name}(${d})`)}else h.expr?.type==="column"?a.push(h.expr.name||h.expr.column):a.push("?");let l=[];for(let h=0;h<s.length;h++){let d=s[h],p=[];for(let g=0;g<e.columns.length;g++){let y=e.columns[g].expr;if(y?.over){let w=i.find(E=>E.colIndex===g);p.push(w?w.values[h]:null)}else if(y?.type==="column"){let w=(y.name||y.column||"").toLowerCase();p.push(n[w]?.[d]??null)}else p.push(r._evaluateInMemoryExpr(y,n,d))}l.push(p)}let c=l;if(e.qualify){c=[];let h={};a.forEach((d,p)=>{h[d.toLowerCase()]=p});for(let d=0;d<l.length;d++){let p={};for(let g=0;g<a.length;g++)p[a[g].toLowerCase()]=l[d][g];r._evaluateInMemoryExpr(e.qualify,p,0)&&c.push(l[d])}}if(e.orderBy&&e.orderBy.length>0){let h={};a.forEach((d,p)=>{h[d.toLowerCase()]=p}),c.sort((d,p)=>{for(let g of e.orderBy){let b=h[g.column.toLowerCase()];if(b===void 0){console.warn(`[SQLExecutor] ORDER BY column '${g.column}' not found in result columns`);continue}let y=d[b],w=p[b],E=g.descending||g.direction==="DESC"?-1:1;if(!(y==null&&w==null)){if(y==null)return 1*E;if(w==null||y<w)return-1*E;if(y>w)return 1*E}}return 0})}let u=e.offset||0,f=c;return u>0&&(f=f.slice(u)),e.limit&&(f=f.slice(0,e.limit)),{columns:a,rows:f,total:c.length}}function _s(r,e,t){if(r.type!=="binary"||!["==","!=","<","<=",">",">="].includes(r.op))return null;let n=null,s=null,o=r.op;if(r.left.type==="column"&&r.right.type==="literal"?(n=r.left.name,s=r.right.value):r.left.type==="literal"&&r.right.type==="column"&&(n=r.right.name,s=r.left.value,o==="<"?o=">":o===">"?o="<":o==="<="?o=">=":o===">="&&(o="<=")),!n||s===null)return null;let i=e[n.toLowerCase()];if(i===void 0)return null;let a=t[i];return["int64","int32","float64","float32"].includes(a)?{column:n,colIdx:i,op:o,value:s,colType:a}:null}async function Ss(r,e,t,n){let s=[];for(let i=0;i<t;i+=5e3){if(n){let u=Math.round(i/t*100);n(`Filtering ${e.column}... ${u}%`,i,t)}let a=Math.min(i+5e3,t),l=Array.from({length:a-i},(u,f)=>i+f),c=await r.readColumnData(e.colIdx,l);for(let u=0;u<l.length;u++){let f=c[u],h=!1;switch(e.op){case"==":h=f===e.value;break;case"!=":h=f!==e.value;break;case"<":h=f<e.value;break;case"<=":h=f<=e.value;break;case">":h=f>e.value;break;case">=":h=f>=e.value;break}h&&s.push(l[u])}if(s.length>=1e4)break}return s}async function As(r,e,t,n){let s=[],i=new Set;r.collectColumnsFromExpr(e,i);for(let a=0;a<t;a+=1e3){n&&n("Filtering rows...",a,t);let l=Math.min(a+1e3,t),c=Array.from({length:l-a},(f,h)=>a+h),u={};for(let f of i){let h=r.columnMap[f.toLowerCase()];h!==void 0&&(u[f.toLowerCase()]=await r.readColumnData(h,c))}for(let f=0;f<c.length;f++)z(r,e,u,f)&&s.push(c[f]);if(s.length>=1e4)break}return s}function z(r,e,t,n){if(!e)return null;switch(e.type){case"literal":return e.value;case"column":{let s=t[e.name.toLowerCase()];return s?s[n]:null}case"star":return"*";case"binary":{let s=z(r,e.left,t,n),o=z(r,e.right,t,n);switch(e.op){case"+":return(s||0)+(o||0);case"-":return(s||0)-(o||0);case"*":return(s||0)*(o||0);case"/":return o!==0?(s||0)/o:null;case"==":return s===o;case"!=":return s!==o;case"<":return s<o;case"<=":return s<=o;case">":return s>o;case">=":return s>=o;case"AND":return s&&o;case"OR":return s||o;default:return null}}case"unary":{let s=z(r,e.operand,t,n);switch(e.op){case"-":return-s;case"NOT":return!s;default:return null}}case"in":{let s=z(r,e.expr,t,n);return e.values.map(i=>z(r,i,t,n)).includes(s)}case"between":{let s=z(r,e.expr,t,n),o=z(r,e.low,t,n),i=z(r,e.high,t,n);return s==null||o==null||i==null?null:s>=o&&s<=i}case"like":{let s=z(r,e.expr,t,n),o=z(r,e.pattern,t,n);return typeof s!="string"||typeof o!="string"?!1:new RegExp("^"+o.replace(/%/g,".*").replace(/_/g,".")+"$","i").test(s)}case"near":return!0;case"call":return null;case"subquery":return r._executeSubquery(e.query,t,n);case"array":return e.elements.map(s=>z(r,s,t,n));case"subscript":{let s=z(r,e.array,t,n),o=z(r,e.index,t,n);return Array.isArray(s)?s[o-1]??null:null}default:return null}}function k(r,e,t){if(!r)return null;switch(r.type){case"literal":return r.value;case"column":{let n=r.column.toLowerCase(),s=e[n];return s?Array.isArray(s)?s[t]:s:null}case"binary":{let n=k(r.left,e,t),s=k(r.right,e,t);switch(r.op||r.operator){case"=":case"==":return n==s;case"!=":case"<>":return n!=s;case"<":return n<s;case"<=":return n<=s;case">":return n>s;case">=":return n>=s;case"+":return Number(n)+Number(s);case"-":return Number(n)-Number(s);case"*":return Number(n)*Number(s);case"/":return s!==0?Number(n)/Number(s):null;case"AND":return n&&s;case"OR":return n||s;default:return null}}case"unary":{let n=k(r.operand,e,t);switch(r.op||r.operator){case"NOT":return!n;case"-":return-n;case"IS NULL":return n==null;case"IS NOT NULL":return n!=null;default:return null}}case"call":{let n=r.name.toUpperCase(),s=r.args?.map(o=>k(o,e,t))||[];switch(n){case"UPPER":return String(s[0]).toUpperCase();case"LOWER":return String(s[0]).toLowerCase();case"LENGTH":return String(s[0]).length;case"SUBSTR":case"SUBSTRING":{if(s[0]==null||s[1]==null)return null;let o=Number(s[1]);if(isNaN(o))return null;let i=s[2]!=null?Number(s[2]):void 0;return i!==void 0&&(isNaN(i)||i<0)?null:String(s[0]).substring(o-1,i!==void 0?o-1+i:void 0)}case"COALESCE":return s.find(o=>o!=null)??null;case"ABS":return Math.abs(s[0]);case"ROUND":return Math.round(s[0]*Math.pow(10,s[1]||0))/Math.pow(10,s[1]||0);case"GROUPING":{let o=r.args?.[0],i=o?.column||o?.name;return i?(e._groupingSet||[]).includes(i.toLowerCase())?0:1:0}default:return null}}case"in":{let n=k(r.expr,e,t);return r.values.map(o=>o.value??k(o,e,t)).includes(n)}case"between":{let n=k(r.expr,e,t),s=k(r.low,e,t),o=k(r.high,e,t);return n==null||s==null||o==null?null:n>=s&&n<=o}case"like":{let n=String(k(r.expr,e,t)),s=k(r.pattern,e,t);return new RegExp("^"+String(s).replace(/%/g,".*").replace(/_/g,".")+"$","i").test(n)}case"array":return r.elements.map(n=>k(n,e,t));case"subscript":{let n=k(r.array,e,t),s=k(r.index,e,t);return Array.isArray(n)?n[s-1]??null:null}default:return null}}function Q(r,e){if(r)switch(r.type){case"column":e.add(r.name.toLowerCase());break;case"binary":Q(r.left,e),Q(r.right,e);break;case"unary":Q(r.operand,e);break;case"call":for(let t of r.args||[])Q(t,e);break;case"in":Q(r.expr,e);break;case"between":Q(r.expr,e);break;case"like":Q(r.expr,e);break;case"near":Q(r.column,e);break}}function po(r){let e=0;for(let t of r)if(t==null)e=e*31+0>>>0;else if(typeof t=="number")e=e*31+t>>>0;else if(t instanceof Uint8Array)for(let n of t)e=e*31+n>>>0;else if(Array.isArray(t))for(let n=0;n<t.length;n++)e=e*31+(t[n]||0)>>>0;else{let n=String(t);for(let s=0;s<n.length;s++)e=e*31+n.charCodeAt(s)>>>0}return e}function go(r){let e=new Uint32Array(r.length);for(let t=0;t<r.length;t++)e[t]=po(r[t]);return e}function yo(r,e){let t=e.filter(n=>n!=null&&typeof n=="number");switch(r.toUpperCase()){case"SUM":return t.length>0?t.reduce((n,s)=>n+s,0):null;case"COUNT":return e.filter(n=>n!=null).length;case"AVG":return t.length>0?t.reduce((n,s)=>n+s,0)/t.length:null;case"MIN":return t.length>0?Math.min(...t):null;case"MAX":return t.length>0?Math.max(...t):null;default:return null}}function Cs(r,e,t){let{aggregate:n,forColumn:s,inValues:o}=t,i=e.map(b=>b.type==="star"?"*":b.alias||(b.expr.type==="column"?b.expr.name:null)),a=i.findIndex(b=>b&&b.toLowerCase()===s.toLowerCase());if(a===-1)throw new Error(`PIVOT: Column '${s}' not found in result set`);let l=n.args&&n.args[0]?n.args[0].name||n.args[0].column||n.args[0]:null,c=l?i.findIndex(b=>b&&b.toLowerCase()===String(l).toLowerCase()):-1;if(c===-1&&n.name.toUpperCase()!=="COUNT")throw new Error("PIVOT: Aggregate source column not found");let u=[];for(let b=0;b<i.length;b++)b!==a&&b!==c&&u.push(b);let f=new Map;for(let b of r){let y=u.map(A=>JSON.stringify(b[A])).join("|"),w=b[a],E=c>=0?b[c]:1;f.has(y)||f.set(y,{groupValues:u.map(A=>b[A]),pivots:new Map});let _=f.get(y),S=String(w);_.pivots.has(S)||_.pivots.set(S,[]),_.pivots.get(S).push(E)}let d=[...u.map(b=>i[b]),...o.map(b=>String(b))],p=[];for(let[,b]of f){let y=[...b.groupValues];for(let w of o){let E=String(w),_=b.pivots.get(E)||[];y.push(yo(n.name,_))}p.push(y)}let g=d.map(b=>({type:"column",expr:{type:"column",name:b},alias:b}));return{rows:p,columns:g}}function Is(r,e,t){let{valueColumn:n,nameColumn:s,inColumns:o}=t,i=e.map(d=>d.type==="star"?"*":d.alias||(d.expr.type==="column"?d.expr.name:null)),a=o.map(d=>{let p=i.findIndex(g=>g&&g.toLowerCase()===d.toLowerCase());if(p===-1)throw new Error(`UNPIVOT: Column '${d}' not found in result set`);return p}),l=[],c=[];for(let d=0;d<i.length;d++)a.includes(d)||(l.push(d),c.push(i[d]));let u=[...c,s,n],f=[];for(let d of r){let p=l.map(g=>d[g]);for(let g=0;g<o.length;g++){let b=o[g],y=d[a[g]];y!=null&&f.push([...p,b,y])}}let h=u.map(d=>({type:"column",expr:{type:"column",name:d},alias:d}));return{rows:f,columns:h}}async function dn(r,e,t=null){if(e.length===0)return[];if(e.length>=1e4&&t?.isAvailable?.()){let o=go(e),i=await t.groupBy(o),a=new Int32Array(i).fill(-1);for(let c=0;c<e.length;c++){let u=o[c]%i;a[u]===-1&&(a[u]=c)}let l=[];for(let c=0;c<i;c++)a[c]!==-1&&l.push(e[a[c]]);return l}let n=new Set,s=[];for(let o of e){let i=JSON.stringify(o);n.has(i)||(n.add(i),s.push(o))}return s}async function pn(r,e,t,n,s=null){let o={},i=0;for(let a of n)if(a.type==="star")for(let l of r.file.columnNames||[])o[l.toLowerCase()]=i++;else{let l=a.alias||r.exprToName(a.expr);o[l.toLowerCase()]=i++}if(e.length>=1e4&&s?.isAvailable?.()){let a=new Uint32Array(e.length);for(let c=0;c<e.length;c++)a[c]=c;for(let c=t.length-1;c>=0;c--){let u=t[c],f=o[u.column.toLowerCase()];if(f===void 0)continue;let h=!u.descending,d=new Float32Array(e.length);for(let b=0;b<e.length;b++){let y=e[a[b]][f];if(y==null)d[b]=h?34e37:-34e37;else if(typeof y=="number")d[b]=y;else if(typeof y=="string"){let w=0;for(let E=0;E<Math.min(4,y.length);E++)w=w*256+y.charCodeAt(E);d[b]=w}else d[b]=0}let p=await s.sort(d,h),g=new Uint32Array(e.length);for(let b=0;b<e.length;b++)g[b]=a[p[b]];a=g}let l=[];for(let c=0;c<e.length;c++)l.push(e[a[c]]);e.length=0,e.push(...l);return}e.sort((a,l)=>{for(let c of t){let u=o[c.column.toLowerCase()];if(u===void 0)continue;let f=a[u],h=l[u],d=c.descending?-1:1;if(!(f==null&&h==null)){if(f==null)return 1*d;if(h==null||f<h)return-1*d;if(f>h)return 1*d}}return 0})}function xe(r,e,t,n){if(!r)return!0;if(r.type==="binary"){if(r.op==="AND")return xe(r.left,e,t,n)&&xe(r.right,e,t,n);if(r.op==="OR")return xe(r.left,e,t,n)||xe(r.right,e,t,n);let s=n(r.left,e,t),o=n(r.right,e,t);switch(r.op){case"=":case"==":return s==o;case"!=":case"<>":return s!=o;case"<":return s<o;case"<=":return s<=o;case">":return s>o;case">=":return s>=o;default:return!0}}return!0}function Rs(r,e,t){if(r.type==="literal")return r.value;if(r.type==="column"){let n=r.name||r.column,s=e.indexOf(n)!==-1?e.indexOf(n):e.indexOf(n.toLowerCase());return s!==-1?t[s]:null}return null}function J(r){if(!r)return"?";switch(r.type){case"column":return r.name||r.column||"?";case"literal":return String(r.value);case"call":let e=(r.args||[]).map(t=>J(t)).join(", ");return`${r.name}(${e})`;case"binary":return`${J(r.left)} ${r.op} ${J(r.right)}`;case"star":return"*";default:return"?"}}var ve=["COUNT","SUM","AVG","MIN","MAX","STDDEV","STDDEV_SAMP","STDDEV_POP","VARIANCE","VAR_SAMP","VAR_POP","MEDIAN","STRING_AGG","GROUP_CONCAT"];function yn(r){return!r||r.length===0||typeof r[0]=="string"?!1:r.some(e=>e.type==="ROLLUP"||e.type==="CUBE"||e.type==="GROUPING_SETS")}function bo(r){let e=[];for(let t of r)if(t.type==="COLUMN")e.includes(t.column)||e.push(t.column);else if(t.type==="ROLLUP"||t.type==="CUBE")for(let n of t.columns)e.includes(n)||e.push(n);else if(t.type==="GROUPING_SETS")for(let n of t.sets)for(let s of n)e.includes(s)||e.push(s);return e}var Ts=12;function wn(r){if(r.length>Ts)throw new Error(`CUBE/ROLLUP power set limited to ${Ts} columns (got ${r.length}). This would generate ${Math.pow(2,r.length)} groupings.`);let e=[[]];for(let t of r){let n=e.length;for(let s=0;s<n;s++)e.push([...e[s],t])}return e}function gn(r,e){let t=[];for(let n of r)for(let s of e)t.push([...n,...s]);return t}function bn(r){if(!r||r.length===0)return[[]];if(typeof r[0]=="string")return[r];let e=[[]];for(let n of r)if(n.type==="COLUMN")e=e.map(s=>[...s,n.column]);else if(n.type==="ROLLUP"){let s=[];for(let o=n.columns.length;o>=0;o--)s.push(n.columns.slice(0,o));e=gn(e,s)}else if(n.type==="CUBE"){let s=wn(n.columns);e=gn(e,s)}else n.type==="GROUPING_SETS"&&(e=gn(e,n.sets));let t=new Set;return e.filter(n=>{let s=JSON.stringify(n.sort());return t.has(s)?!1:(t.add(s),!0)})}function je(r,e,t={}){let n=e.filter(s=>s!=null&&typeof s=="number"&&!isNaN(s));switch(r.toUpperCase()){case"COUNT":return e.filter(s=>s!=null).length;case"SUM":return n.reduce((s,o)=>s+o,0);case"AVG":return n.length>0?n.reduce((s,o)=>s+o,0)/n.length:null;case"MIN":return n.length>0?Math.min(...n):null;case"MAX":return n.length>0?Math.max(...n):null;case"STDDEV":case"STDDEV_SAMP":{if(n.length<2)return null;let s=n.reduce((i,a)=>i+a,0)/n.length,o=n.reduce((i,a)=>i+Math.pow(a-s,2),0)/(n.length-1);return Math.sqrt(o)}case"STDDEV_POP":{if(n.length===0)return null;let s=n.reduce((i,a)=>i+a,0)/n.length,o=n.reduce((i,a)=>i+Math.pow(a-s,2),0)/n.length;return Math.sqrt(o)}case"VARIANCE":case"VAR_SAMP":{if(n.length<2)return null;let s=n.reduce((o,i)=>o+i,0)/n.length;return n.reduce((o,i)=>o+Math.pow(i-s,2),0)/(n.length-1)}case"VAR_POP":{if(n.length===0)return null;let s=n.reduce((o,i)=>o+i,0)/n.length;return n.reduce((o,i)=>o+Math.pow(i-s,2),0)/n.length}case"MEDIAN":{if(n.length===0)return null;let s=[...n].sort((i,a)=>i-a),o=Math.floor(s.length/2);return s.length%2?s[o]:(s[o-1]+s[o])/2}case"STRING_AGG":case"GROUP_CONCAT":{let s=t.separator??",";return e.filter(o=>o!=null).map(String).join(s)}default:return null}}function En(r){for(let e of r.columns)if(e.type==="expr"&&e.expr.type==="call"&&ve.includes(e.expr.name.toUpperCase()))return!0;return!1}function _n(r){if(r.columns.length!==1)return!1;let e=r.columns[0];return e.type==="expr"&&e.expr.type==="call"&&e.expr.name.toUpperCase()==="COUNT"?e.expr.args[0]?.type==="star":!1}function xs(r){let e=r.columns.map(n=>n.alias||J(n.expr||n)),t=r.columns.map(n=>{let s=n.expr||n;return s.type==="call"&&s.name.toUpperCase()==="COUNT"?0:null});return r.groupBy&&r.groupBy.length>0?{columns:e,rows:[],total:0,aggregationStats:{scannedRows:0,totalRows:0,coveragePercent:"100.00",isPartialScan:!1,fromSearch:!0}}:{columns:e,rows:[t],total:1,aggregationStats:{scannedRows:0,totalRows:0,coveragePercent:"100.00",isPartialScan:!1,fromSearch:!0}}}function Eo(r,e,t,n,s){let o=new Map,i=n.map(l=>l.toLowerCase());for(let l of t){let c=n.length>0?n.map(u=>{let f=e[u.toLowerCase()]?.[l];return JSON.stringify(f)}).join("|"):"__grand_total__";if(!o.has(c)){let u={};for(let f of s)i.includes(f.toLowerCase())?u[f]=e[f.toLowerCase()]?.[l]:u[f]=null;o.set(c,{values:u,indices:[],_groupingSet:n})}o.get(c).indices.push(l)}if(n.length===0&&o.size===0){let l={};for(let c of s)l[c]=null;o.set("__grand_total__",{values:l,indices:[],_groupingSet:n})}let a=[];for(let[,l]of o){let c={...l.values,_groupingSet:l._groupingSet};for(let u of r.columns){let f=u.expr;if(f?.type==="call"&&ve.includes((f.name||"").toUpperCase())){let h=f.name.toUpperCase(),d=f.args?.[0],p=d?.type==="star",g=(d?.name||d?.column||"").toLowerCase(),b=u.alias||`${h}(${p?"*":g})`,y=l.indices,w=[];p?w=y.map(()=>1):w=y.map(E=>e[g]?.[E]).filter(E=>E!=null),c[b]=h==="COUNT"&&p?y.length:je(h,w)}}a.push(c)}return a}function _o(r,e,t){let n=[];for(let a of r.columns)if(a.alias)n.push(a.alias);else if(a.expr?.type==="call"){let l=a.expr.args?.[0]?.name||a.expr.args?.[0]?.column||"*";n.push(`${a.expr.name}(${l})`)}else a.expr?.type==="column"?n.push(a.expr.name||a.expr.column):n.push("?");let s=e.map(a=>n.map(l=>a[l]??a[l.toLowerCase()]??null));if(r.orderBy&&r.orderBy.length>0){let a={};n.forEach((l,c)=>{a[l.toLowerCase()]=c}),s.sort((l,c)=>{for(let u of r.orderBy){let f=a[u.column.toLowerCase()];if(f===void 0)continue;let h=l[f],d=c[f],p=u.descending||u.direction==="DESC"?-1:1;if(!(h==null&&d==null)){if(h==null)return 1*p;if(d==null||h<d)return-1*p;if(h>d)return 1*p}}return 0})}let o=r.offset||0,i=s;return o>0&&(i=i.slice(o)),r.limit&&(i=i.slice(0,r.limit)),{columns:n,rows:i,total:e.length}}function So(r,e,t,n,s){let o=bn(e.groupBy),i=bo(e.groupBy),a=[];for(let l of o){let c=Eo(e,n,s,l,i);a.push(...c)}return _o(e,a,i)}function vs(r,e,t,n,s){let o=e.groupBy&&e.groupBy.length>0;if(o&&yn(e.groupBy))return So(r,e,t,n,s);let i=new Map;for(let f of s){let h="";o&&(h=e.groupBy.map(d=>{let p=(d.column||d.name||"").toLowerCase(),g=n[p]?.[f];return g==null?"\0":String(g)}).join("")),i.has(h)||i.set(h,[]),i.get(h).push(f)}!o&&i.size===0&&i.set("",[]);let a=[];for(let f of e.columns)if(f.alias)a.push(f.alias);else if(f.expr?.type==="call"){let h=f.expr.args?.[0]?.name||f.expr.args?.[0]?.column||"*";a.push(`${f.expr.name}(${h})`)}else f.expr?.type==="column"?a.push(f.expr.name||f.expr.column):a.push("?");let l=[];for(let[,f]of i){let h=[];for(let d of e.columns){let p=d.expr;if(p?.type==="call"&&ve.includes((p.name||"").toUpperCase())){let g=p.name.toUpperCase(),b=p.args?.[0],y=b?.type==="star",w=(b?.name||b?.column||"").toLowerCase();if(g==="COUNT"&&y)h.push(f.length);else{let E=f.map(S=>n[w]?.[S]),_=p.args?.[1]?.value;h.push(je(g,E,{separator:_}))}}else if(p?.type==="column"){let g=(p.name||p.column||"").toLowerCase();h.push(n[g]?.[f[0]]??null)}else h.push(k(p,n,f[0]))}l.push(h)}if(e.orderBy&&e.orderBy.length>0){let f={};a.forEach((h,d)=>{f[h.toLowerCase()]=d}),l.sort((h,d)=>{for(let p of e.orderBy){let g=f[p.column.toLowerCase()];if(g===void 0)continue;let b=h[g],y=d[g],w=p.descending||p.direction==="DESC"?-1:1;if(!(b==null&&y==null)){if(b==null)return 1*w;if(y==null||b<y)return-1*w;if(b>y)return 1*w}}return 0})}let c=e.offset||0,u=l;return c>0&&(u=u.slice(c)),e.limit&&(u=u.slice(0,e.limit)),{columns:a,rows:u,total:i.size}}function Ns(r,e,t,n){let s=structuredClone(e),o=s.from?.name||s.from?.table,i=Co(s,o),a={};for(let c of i){let u=c.column.toLowerCase();t[u]&&(a[c.table+"."+c.column]=t[u][n])}Object.keys(a).length>0&&Y(s.where,a);let l=s.from?.name?.toLowerCase()||s.from?.table?.toLowerCase();if(l&&r._cteResults?.has(l)){let c=Et(r,s,r._cteResults.get(l));return c.rows.length>0?c.rows[0][0]:null}if(r._database)try{let c=r._database._executeSingleTable(s);return c&&c.then?null:c?.rows?.[0]?.[0]??null}catch{return null}return null}function Co(r,e){let t=[],n=s=>{s&&(s.type==="column"&&s.table&&s.table!==e?t.push(s):s.type==="binary"?(n(s.left),n(s.right)):s.type==="unary"?n(s.operand):s.type==="in"?(n(s.expr),s.values?.forEach(n)):s.type==="between"?(n(s.expr),n(s.low),n(s.high)):s.type==="like"?(n(s.expr),n(s.pattern)):s.type==="call"&&s.args?.forEach(n))};return n(r.where),t}function Y(r,e){if(r)if(r.type==="column"&&r.table){let t=r.table+"."+r.column;e.hasOwnProperty(t)&&(r.type="literal",r.value=e[t],delete r.table,delete r.column)}else r.type==="binary"?(Y(r.left,e),Y(r.right,e)):r.type==="unary"?Y(r.operand,e):r.type==="in"?(Y(r.expr,e),r.values?.forEach(t=>Y(t,e))):r.type==="between"?(Y(r.expr,e),Y(r.low,e),Y(r.high,e)):r.type==="like"?(Y(r.expr,e),Y(r.pattern,e)):r.type==="call"&&r.args?.forEach(t=>Y(t,e))}async function Us(r,e,t){r._database=t;for(let n of e){let s=n.name.toLowerCase();if(n.body.type==="RECURSIVE_CTE"){let o=await He(r,n.body.anchor,t),i={columns:o.columns,rows:[...o.rows]};for(let a=0;a<1e3;a++){r._cteResults.set(s,i);let l=await He(r,n.body.recursive,t);if(l.rows.length===0)break;i={columns:i.columns,rows:[...i.rows,...l.rows]}}r._cteResults.set(s,i)}else{let o=await He(r,n.body,t);r._cteResults.set(s,o)}}}async function He(r,e,t){let n=e.from?.name?.toLowerCase()||e.from?.table?.toLowerCase();return n&&r._cteResults.has(n)?Et(r,e,r._cteResults.get(n)):t._executeSingleTable(e)}function Io(r){let e=["COUNT","SUM","AVG","MIN","MAX","STDDEV","STDDEV_SAMP","STDDEV_POP","VARIANCE","VAR_SAMP","VAR_POP","MEDIAN","STRING_AGG","GROUP_CONCAT"];for(let t of r)if(t.expr?.type==="call"){if(t.expr.over)continue;let n=(t.expr.name||"").toUpperCase();if(e.includes(n))return!0}return!1}function Et(r,e,t){let n={};for(let h=0;h<t.columns.length;h++){let d=t.columns[h].toLowerCase();n[d]=t.rows.map(p=>p[h])}let s=[];for(let h=0;h<t.rows.length;h++)(!e.where||k(e.where,n,h))&&s.push(h);let o=e.groupBy&&e.groupBy.length>0,i=Io(e.columns);if(o||i)return r._executeGroupByAggregation(e,t,n,s);if(r.hasWindowFunctions(e))return r._executeWindowFunctions(e,t,n,s);let a=[],l=[];if(e.columns.length===1&&(e.columns[0].type==="star"||e.columns[0].expr?.type==="star")){for(let h of t.columns)a.push(h);for(let h of s)l.push([...t.rows[h]])}else{for(let h of e.columns)a.push(h.alias||h.expr?.column||"*");for(let h of s){let d=e.columns.map(p=>p.type==="star"||p.expr?.type==="star"?t.rows[h]:k(p.expr,n,h));l.push(d.flat())}}if(e.orderBy&&e.orderBy.length>0){let h={};a.forEach((d,p)=>{h[d.toLowerCase()]=p}),l.sort((d,p)=>{for(let g of e.orderBy){let b=h[g.column.toLowerCase()];if(b===void 0)continue;let y=d[b],w=p[b],E=g.descending||g.direction==="DESC"?-1:1;if(!(y==null&&w==null)){if(y==null)return 1*E;if(w==null||y<w)return-1*E;if(y>w)return 1*E}}return 0})}let u=e.offset||0,f=l;return u>0&&(f=f.slice(u)),e.limit&&(f=f.slice(0,e.limit)),{columns:a,rows:f,total:s.length}}var V=class{constructor(e,t={}){this.file=e,this.columnMap={},this.columnTypes=[],this._cteResults=new Map,this._database=null,this._ftsIndexCache=null,this._debug=t.debug??!1,e.columnNames&&e.columnNames.forEach((n,s)=>{this.columnMap[n.toLowerCase()]=s})}setDatabase(e){this._database=e}async execute(e,t=null){let s=new j(e).tokenize(),i=new K(s).parse(),l=new de().planSingleTable(i);this.columnTypes.length===0&&(this.file._isRemote&&this.file.detectColumnTypes?this.columnTypes=await this.file.detectColumnTypes():this.file._columnTypes?this.columnTypes=this.file._columnTypes:this.columnTypes=Array(this.file.numColumns||0).fill("unknown"));let c=this.file._isRemote?await this.file.getRowCount(0):Number(this.file.getRowCount(0)),u=null;i.where&&l.pushedFilters.length>0&&this.file._isRemote&&(u=await an.precomputeForPlan(this.file,l),l.columnStats=Object.fromEntries(u));let f=l.scanColumns.length>0?l.scanColumns:this.collectNeededColumns(i),h=this.resolveOutputColumns(i);if(l.aggregations.length>0||En(i))return _n(i)&&!i.where&&!i.search?{columns:["COUNT(*)"],rows:[[c]],total:1,aggregationStats:{scannedRows:0,totalRows:c,coveragePercent:"100.00",isPartialScan:!1,fromMetadata:!0},queryPlan:l}:i.search||Te(i.where)?await ws(this,i,c,t):await this.executeAggregateQuery(i,c,t);let p,g=i.limit||100,b=i.offset||0;if(i.where)p=await this.evaluateWhere(i.where,c,t),p=p.slice(b,b+g);else{p=[];let _=Math.min(b+g,c);for(let S=b;S<_;S++)p.push(S)}t&&t("Fetching column data...",0,h.length);let y={};for(let _=0;_<f.length;_++){let S=f[_],A=this.columnMap[S.toLowerCase()];A!==void 0&&(t&&t(`Fetching ${S}...`,_,f.length),y[S.toLowerCase()]=await this.readColumnData(A,p))}let w=[];for(let _=0;_<p.length;_++){let S=[];for(let A of h)if(A.type==="star")for(let R of this.file.columnNames||[])S.push(y[R.toLowerCase()]?.[_]??null);else S.push(this.evaluateExpr(A.expr,y,_));w.push(S)}if(i.pivot){let _=Cs(w,h,i.pivot);w.length=0,w.push(..._.rows),h.length=0,h.push(..._.columns)}if(i.unpivot){let _=Is(w,h,i.unpivot);w.length=0,w.push(..._.rows),h.length=0,h.push(..._.columns)}if(i.distinct){let _=await dn(this,w,gpuSorter);w.length=0,w.push(..._)}i.orderBy&&i.orderBy.length>0&&await pn(this,w,i.orderBy,h,gpuSorter);let E=[];for(let _ of h)_.type==="star"?E.push(...this.file.columnNames||[]):E.push(_.alias||J(_.expr));return{columns:E,rows:w,total:i.limit?w.length:c,orderByOnSubset:i.orderBy&&i.orderBy.length>0&&w.length<c,orderByColumns:i.orderBy?i.orderBy.map(_=>`${_.column} ${_.direction}`):[],queryPlan:l,optimization:{statsComputed:u?.size>0,columnStats:u?Object.fromEntries(u):null,pushedFilters:l.pushedFilters?.length||0,estimatedSelectivity:l.estimatedSelectivity}}}collectNeededColumns(e){let t=new Set;for(let n of e.columns)n.type==="star"?(this.file.columnNames||[]).forEach(s=>t.add(s.toLowerCase())):Q(n.expr,t);e.where&&Q(e.where,t);for(let n of e.orderBy||[])t.add(n.column.toLowerCase());return Array.from(t)}collectColumnsFromExpr(e,t){Q(e,t)}resolveOutputColumns(e){return e.columns}async readColumnData(e,t){let n=this.columnTypes[e]||"unknown";try{if(n==="string"){let s=await this.file.readStringsAtIndices(e,t);return Array.isArray(s)?s:Array.from(s)}else if(n==="int64"){let s=await this.file.readInt64AtIndices(e,t);return Array.from(s,o=>Number(o))}else{if(n==="float64")return Array.from(await this.file.readFloat64AtIndices(e,t));if(n==="int32")return Array.from(await this.file.readInt32AtIndices(e,t));if(n==="float32")return Array.from(await this.file.readFloat32AtIndices(e,t));if(n==="vector")return t.map(()=>"[vector]");try{return await this.file.readStringsAtIndices(e,t)}catch(s){return this._debug&&console.warn(`[SQLExecutor] readColumnData col ${e} fallback failed:`,s.message),t.map(()=>null)}}}catch(s){return this._debug&&console.warn(`[SQLExecutor] readColumnData col ${e} failed:`,s.message),t.map(()=>null)}}async evaluateWhere(e,t,n){let s=Te(e);if(s)return await ys(this,s,e,t,n);let o=_s(e,this.columnMap,this.columnTypes);return o?await Ss(this,o,t,n):await As(this,e,t,n)}evaluateExpr(e,t,n){return z(this,e,t,n)}_executeSubquery(e,t,n){return Ns(this,e,t,n)}_executeCTEBody(e,t){return He(this,e,t)}async materializeCTEs(e,t){return Us(this,e,t)}_executeOnInMemoryData(e,t){return Et(this,e,t)}_evaluateInMemoryExpr(e,t,n){return k(e,t,n)}hasWindowFunctions(e){return bs(e)}computeWindowFunctions(e,t,n){return mn(e,t,n,(s,o,i)=>this._evaluateInMemoryExpr(s,o,i))}_executeWindowFunctions(e,t,n,s){return Es(this,e,t,n,s)}_partitionRows(e,t,n,s){return hn(e,t,n,s)}_compareRowsByOrder(e,t,n,s,o){return pe(e,t,n,s,o)}hasAggregates(e){return En(e)}_executeGroupByAggregation(e,t,n,s){return vs(this,e,t,n,s)}_hasAdvancedGroupBy(e){return yn(e)}_emptyAggregateResult(e){return xs(e)}async executeAggregateQuery(e,t,n){let s=ve,o=[],i=[];for(let h of e.columns)if(h.type==="star")o.push({type:"COUNT",column:null,isStar:!0}),i.push("COUNT(*)");else if(h.expr.type==="call"&&s.includes(h.expr.name.toUpperCase())){let d=h.expr.name.toUpperCase(),p=h.expr.args[0];o.push({type:d,column:p?.type==="column"?p.name:null,isStar:p?.type==="star",sum:0,count:0,min:null,max:null,values:[]}),i.push(h.alias||J(h.expr))}else o.push({type:"FIRST",column:h.expr.type==="column"?h.expr.name:null,value:null}),i.push(h.alias||J(h.expr));let a=new Set;for(let h of o)h.column&&a.add(h.column.toLowerCase());e.where&&this.collectColumnsFromExpr(e.where,a);let l=e.limit?Math.min(e.limit,t):t,c=1e3,u=0;for(let h=0;h<l;h+=c){n&&n("Aggregating...",h,l);let d=Math.min(h+c,l),p=Array.from({length:d-h},(b,y)=>h+y);u+=p.length;let g={};for(let b of a){let y=this.columnMap[b.toLowerCase()];y!==void 0&&(g[b.toLowerCase()]=await this.readColumnData(y,p))}for(let b=0;b<p.length;b++)if(!(e.where&&!this.evaluateExpr(e.where,g,b))){for(let y of o)if(y.type==="COUNT")y.count++;else if(y.type==="FIRST"&&y.value===null&&y.column)y.value=g[y.column.toLowerCase()]?.[b];else if(y.column){let w=g[y.column.toLowerCase()]?.[b];w!=null&&!isNaN(w)&&(y.count++,(y.type==="SUM"||y.type==="AVG")&&(y.sum+=w),y.type==="MIN"&&(y.min=y.min===null?w:Math.min(y.min,w)),y.type==="MAX"&&(y.max=y.max===null?w:Math.max(y.max,w)))}}}let f=o.map(h=>{switch(h.type){case"COUNT":return h.count;case"SUM":return h.sum;case"AVG":return h.count>0?h.sum/h.count:null;case"MIN":return h.min;case"MAX":return h.max;case"FIRST":return h.value;default:return null}});if(e.having){let h={};if(i.forEach((d,p)=>{h[d.toLowerCase()]=[f[p]]}),!this._evaluateInMemoryExpr(e.having,h,0))return{columns:i,rows:[],total:0,aggregationStats:{scannedRows:u,totalRows:t}}}return{columns:i,rows:[f],total:1,aggregationStats:{scannedRows:u,totalRows:t,coveragePercent:t>0?(u/t*100).toFixed(2):"100.00",isPartialScan:u<t}}}async _executeSimpleAggregateOnIndices(e,t,n){let s=e.columns.map(l=>l.alias||J(l.expr||l)),o=new Set;for(let l of e.columns)l.expr?.args?.[0]?.type==="column"&&o.add((l.expr.args[0].name||l.expr.args[0].column).toLowerCase());let i={};for(let l of o){let c=this.columnMap[l];c!==void 0&&(i[l]=await this.readColumnData(c,t))}let a=e.columns.map(l=>{if(l.expr?.type==="call"){let c=l.expr.name.toUpperCase(),u=l.expr.args?.[0],f=u?.type==="star";if(c==="COUNT"&&f)return t.length;let h=(u?.name||u?.column)?.toLowerCase(),d=t.map((p,g)=>i[h]?.[g]);return je(c,d)}return null});return{columns:s,rows:[a],total:1}}async _executeGroupByOnIndices(e,t,n){let s=new Set;for(let c of e.groupBy)s.add((c.column||c.name).toLowerCase());for(let c of e.columns)c.expr?.type==="column"&&s.add((c.expr.name||c.expr.column).toLowerCase()),c.expr?.args?.[0]?.type==="column"&&s.add((c.expr.args[0].name||c.expr.args[0].column).toLowerCase());let o={};for(let c of s){let u=this.columnMap[c];u!==void 0&&(o[c]=await this.readColumnData(u,t))}let i=new Map;for(let c=0;c<t.length;c++){let u=e.groupBy.map(f=>JSON.stringify(o[(f.column||f.name).toLowerCase()]?.[c])).join("|");i.has(u)||i.set(u,[]),i.get(u).push(c)}let a=e.columns.map(c=>c.alias||J(c.expr||c)),l=[];for(let[,c]of i){let u=e.columns.map(f=>{let h=f.expr||f;if(h.type==="call"&&ve.includes(h.name.toUpperCase())){let d=(h.args?.[0]?.name||h.args?.[0]?.column)?.toLowerCase(),p=h.args?.[0]?.type==="star";if(h.name.toUpperCase()==="COUNT"&&p)return c.length;let g=c.map(b=>o[d]?.[b]);return je(h.name.toUpperCase(),g)}else if(h.type==="column")return o[(h.name||h.column).toLowerCase()]?.[c[0]];return null});l.push(u)}return{columns:a,rows:l,total:l.length}}exprToName(e){return J(e)}isSimpleCountStar(e){return _n(e)}async applyOrderBy(e,t,n){return pn(this,e,t,n,gpuSorter)}async applyDistinct(e){return dn(this,e,gpuSorter)}async*executeStream(e,t={}){let{chunkSize:n=1e3}=t,o=new j(e).tokenize(),a=new K(o).parse();this.columnTypes.length===0&&(this.file._isRemote&&this.file.detectColumnTypes?this.columnTypes=await this.file.detectColumnTypes():this.file._columnTypes?this.columnTypes=this.file._columnTypes:this.columnTypes=Array(this.file.numColumns||0).fill("unknown"));let l=this.file._isRemote?await this.file.getRowCount(0):Number(this.file.getRowCount(0)),c=this.collectNeededColumns(a),u=a.limit||l,f=0;for(let h=0;h<l&&f<u;h+=n){let d=Math.min(n,u-f,l-h),p=Array.from({length:d},(w,E)=>h+E),g=[];for(let w of c){let E=this.columnMap[w.toLowerCase()];g.push(E!==void 0?await this.readColumnData(E,p):p.map(()=>null))}let b=p.map((w,E)=>c.map((_,S)=>g[S][E])),y=b;a.where&&(y=b.filter(w=>xe(a.where,c,w,Rs))),y.length>0&&(yield{columns:c,rows:y},f+=y.length)}}_expandGroupBy(e){return bn(e)}_powerSet(e){return wn(e)}_rank(e,t){return(void 0)(e,t)}_denseRank(e,t){return(void 0)(e,t)}_percentRank(e,t){return(void 0)(e,t)}_cumeDist(e,t){return(void 0)(e,t)}_getRowNumber(e){return(void 0)(e)}};le();var _t=class{constructor(e,t){this.lanceql=e,this.wasm=e.wasm,this.memory=e.memory;let n=new Uint8Array(t);if(this.dataPtr=this.wasm.alloc(n.length),!this.dataPtr)throw new Error("Failed to allocate memory for Lance file");if(this.dataLen=n.length,new Uint8Array(this.memory.buffer).set(n,this.dataPtr),this.wasm.openFile(this.dataPtr,this.dataLen)===0)throw this.wasm.free(this.dataPtr,this.dataLen),new Error("Failed to open Lance file")}close(){this.wasm.closeFile(),this.dataPtr&&(this.wasm.free(this.dataPtr,this.dataLen),this.dataPtr=null)}get numColumns(){return this.wasm.getNumColumns()}getRowCount(e){return this.wasm.getRowCount(e)}getColumnDebugInfo(e){return{offset:this.wasm.getColumnBufferOffset(e),size:this.wasm.getColumnBufferSize(e),rows:this.wasm.getRowCount(e)}}readInt64Column(e){let t=Number(this.getRowCount(e));if(t===0)return new BigInt64Array(0);let n=this.wasm.allocInt64Buffer(t);if(!n)throw new Error("Failed to allocate int64 buffer");try{let s=this.wasm.readInt64Column(e,n,t),o=new BigInt64Array(s),i=new BigInt64Array(this.memory.buffer,n,s);return o.set(i),o}finally{this.wasm.freeInt64Buffer(n,t)}}readFloat64Column(e){let t=Number(this.getRowCount(e));if(t===0)return new Float64Array(0);let n=this.wasm.allocFloat64Buffer(t);if(!n)throw new Error("Failed to allocate float64 buffer");try{let s=this.wasm.readFloat64Column(e,n,t),o=new Float64Array(s),i=new Float64Array(this.memory.buffer,n,s);return o.set(i),o}finally{this.wasm.freeFloat64Buffer(n,t)}}readInt32Column(e){let t=Number(this.getRowCount(e));if(t===0)return new Int32Array(0);let n=this.wasm.allocInt32Buffer(t);if(!n)throw new Error("Failed to allocate int32 buffer");try{let s=this.wasm.readInt32Column(e,n,t),o=new Int32Array(s),i=new Int32Array(this.memory.buffer,n,s);return o.set(i),o}finally{this.wasm.free(n,t*4)}}readInt16Column(e){let t=Number(this.getRowCount(e));if(t===0)return new Int16Array(0);let n=this.wasm.allocInt16Buffer(t);if(!n)throw new Error("Failed to allocate int16 buffer");try{let s=this.wasm.readInt16Column(e,n,t),o=new Int16Array(s),i=new Int16Array(this.memory.buffer,n,s);return o.set(i),o}finally{this.wasm.free(n,t*2)}}readInt8Column(e){let t=Number(this.getRowCount(e));if(t===0)return new Int8Array(0);let n=this.wasm.allocInt8Buffer(t);if(!n)throw new Error("Failed to allocate int8 buffer");try{let s=this.wasm.readInt8Column(e,n,t),o=new Int8Array(s),i=new Int8Array(this.memory.buffer,n,s);return o.set(i),o}finally{this.wasm.free(n,t)}}readUint64Column(e){let t=Number(this.getRowCount(e));if(t===0)return new BigUint64Array(0);let n=this.wasm.allocUint64Buffer(t);if(!n)throw new Error("Failed to allocate uint64 buffer");try{let s=this.wasm.readUint64Column(e,n,t),o=new BigUint64Array(s),i=new BigUint64Array(this.memory.buffer,n,s);return o.set(i),o}finally{this.wasm.free(n,t*8)}}readUint32Column(e){let t=Number(this.getRowCount(e));if(t===0)return new Uint32Array(0);let n=this.wasm.allocIndexBuffer(t);if(!n)throw new Error("Failed to allocate uint32 buffer");try{let s=this.wasm.readUint32Column(e,n,t),o=new Uint32Array(s),i=new Uint32Array(this.memory.buffer,n,s);return o.set(i),o}finally{this.wasm.free(n,t*4)}}readUint16Column(e){let t=Number(this.getRowCount(e));if(t===0)return new Uint16Array(0);let n=this.wasm.allocUint16Buffer(t);if(!n)throw new Error("Failed to allocate uint16 buffer");try{let s=this.wasm.readUint16Column(e,n,t),o=new Uint16Array(s),i=new Uint16Array(this.memory.buffer,n,s);return o.set(i),o}finally{this.wasm.free(n,t*2)}}readUint8Column(e){let t=Number(this.getRowCount(e));if(t===0)return new Uint8Array(0);let n=this.wasm.allocStringBuffer(t);if(!n)throw new Error("Failed to allocate uint8 buffer");try{let s=this.wasm.readUint8Column(e,n,t),o=new Uint8Array(s),i=new Uint8Array(this.memory.buffer,n,s);return o.set(i),o}finally{this.wasm.free(n,t)}}readFloat32Column(e){let t=Number(this.getRowCount(e));if(t===0)return new Float32Array(0);let n=this.wasm.allocFloat32Buffer(t);if(!n)throw new Error("Failed to allocate float32 buffer");try{let s=this.wasm.readFloat32Column(e,n,t),o=new Float32Array(s),i=new Float32Array(this.memory.buffer,n,s);return o.set(i),o}finally{this.wasm.free(n,t*4)}}readBoolColumn(e){let t=Number(this.getRowCount(e));if(t===0)return new Uint8Array(0);let n=this.wasm.allocStringBuffer(t);if(!n)throw new Error("Failed to allocate bool buffer");try{let s=this.wasm.readBoolColumn(e,n,t),o=new Uint8Array(s),i=new Uint8Array(this.memory.buffer,n,s);return o.set(i),o}finally{this.wasm.free(n,t)}}readInt32AtIndices(e,t){if(t.length===0)return new Int32Array(0);let n=this.wasm.allocIndexBuffer(t.length);if(!n)throw new Error("Failed to allocate index buffer");let s=this.wasm.allocInt32Buffer(t.length);if(!s)throw this.wasm.free(n,t.length*4),new Error("Failed to allocate output buffer");try{new Uint32Array(this.memory.buffer,n,t.length).set(t);let o=this.wasm.readInt32AtIndices(e,n,t.length,s),i=new Int32Array(o),a=new Int32Array(this.memory.buffer,s,o);return i.set(a),i}finally{this.wasm.free(n,t.length*4),this.wasm.free(s,t.length*4)}}readFloat32AtIndices(e,t){if(t.length===0)return new Float32Array(0);let n=this.wasm.allocIndexBuffer(t.length);if(!n)throw new Error("Failed to allocate index buffer");let s=this.wasm.allocFloat32Buffer(t.length);if(!s)throw this.wasm.free(n,t.length*4),new Error("Failed to allocate output buffer");try{new Uint32Array(this.memory.buffer,n,t.length).set(t);let o=this.wasm.readFloat32AtIndices(e,n,t.length,s),i=new Float32Array(o),a=new Float32Array(this.memory.buffer,s,o);return i.set(a),i}finally{this.wasm.free(n,t.length*4),this.wasm.free(s,t.length*4)}}readUint8AtIndices(e,t){if(t.length===0)return new Uint8Array(0);let n=this.wasm.allocIndexBuffer(t.length);if(!n)throw new Error("Failed to allocate index buffer");let s=this.wasm.allocStringBuffer(t.length);if(!s)throw this.wasm.free(n,t.length*4),new Error("Failed to allocate output buffer");try{new Uint32Array(this.memory.buffer,n,t.length).set(t);let o=this.wasm.readUint8AtIndices(e,n,t.length,s),i=new Uint8Array(o),a=new Uint8Array(this.memory.buffer,s,o);return i.set(a),i}finally{this.wasm.free(n,t.length*4),this.wasm.free(s,t.length)}}readBoolAtIndices(e,t){if(t.length===0)return new Uint8Array(0);let n=this.wasm.allocIndexBuffer(t.length);if(!n)throw new Error("Failed to allocate index buffer");let s=this.wasm.allocStringBuffer(t.length);if(!s)throw this.wasm.free(n,t.length*4),new Error("Failed to allocate output buffer");try{new Uint32Array(this.memory.buffer,n,t.length).set(t);let o=this.wasm.readBoolAtIndices(e,n,t.length,s),i=new Uint8Array(o),a=new Uint8Array(this.memory.buffer,s,o);return i.set(a),i}finally{this.wasm.free(n,t.length*4),this.wasm.free(s,t.length)}}filterInt64(e,t,n){let s=Number(this.getRowCount(e));if(s===0)return new Uint32Array(0);let o=this.wasm.allocIndexBuffer(s);if(!o)throw new Error("Failed to allocate index buffer");try{let i=this.wasm.filterInt64Column(e,t,BigInt(n),o,s),a=new Uint32Array(i),l=new Uint32Array(this.memory.buffer,o,i);return a.set(l),a}finally{this.wasm.free(o,s*4)}}filterFloat64(e,t,n){let s=Number(this.getRowCount(e));if(s===0)return new Uint32Array(0);let o=this.wasm.allocIndexBuffer(s);if(!o)throw new Error("Failed to allocate index buffer");try{let i=this.wasm.filterFloat64Column(e,t,n,o,s),a=new Uint32Array(i),l=new Uint32Array(this.memory.buffer,o,i);return a.set(l),a}finally{this.wasm.free(o,s*4)}}readInt64AtIndices(e,t){if(t.length===0)return new BigInt64Array(0);let n=this.wasm.allocIndexBuffer(t.length);if(!n)throw new Error("Failed to allocate index buffer");let s=this.wasm.allocInt64Buffer(t.length);if(!s)throw this.wasm.free(n,t.length*4),new Error("Failed to allocate output buffer");try{new Uint32Array(this.memory.buffer,n,t.length).set(t);let o=this.wasm.readInt64AtIndices(e,n,t.length,s),i=new BigInt64Array(o),a=new BigInt64Array(this.memory.buffer,s,o);return i.set(a),i}finally{this.wasm.free(n,t.length*4),this.wasm.freeInt64Buffer(s,t.length)}}readFloat64AtIndices(e,t){if(t.length===0)return new Float64Array(0);let n=this.wasm.allocIndexBuffer(t.length);if(!n)throw new Error("Failed to allocate index buffer");let s=this.wasm.allocFloat64Buffer(t.length);if(!s)throw this.wasm.free(n,t.length*4),new Error("Failed to allocate output buffer");try{new Uint32Array(this.memory.buffer,n,t.length).set(t);let o=this.wasm.readFloat64AtIndices(e,n,t.length,s),i=new Float64Array(o),a=new Float64Array(this.memory.buffer,s,o);return i.set(a),i}finally{this.wasm.free(n,t.length*4),this.wasm.freeFloat64Buffer(s,t.length)}}sumInt64(e){return this.wasm.sumInt64Column(e)}sumFloat64(e){return this.wasm.sumFloat64Column(e)}minInt64(e){return this.wasm.minInt64Column(e)}maxInt64(e){return this.wasm.maxInt64Column(e)}avgFloat64(e){return this.wasm.avgFloat64Column(e)}debugStringColInfo(e){let t=this.wasm.debugStringColInfo(e);return{offsetsSize:Number(BigInt(t)>>32n),dataSize:Number(BigInt(t)&0xFFFFFFFFn)}}debugReadStringInfo(e,t){let n=this.wasm.debugReadStringInfo(e,t);if((n&0xFFFF0000n)===0xDEAD0000n){let s=Number(n&0xFFFFn);return{error:{1:"No file data",2:"No column entry",3:"Col meta out of bounds",4:"Not a string column",5:"Row out of bounds",6:"Invalid offset size"}[s]||`Unknown error ${s}`}}return{strStart:Number(BigInt(n)>>32n),strLen:Number(BigInt(n)&0xFFFFFFFFn)}}debugStringDataStart(e){let t=this.wasm.debugStringDataStart(e);return{dataStart:Number(BigInt(t)>>32n),fileLen:Number(BigInt(t)&0xFFFFFFFFn)}}getStringCount(e){return Number(this.wasm.getStringCount(e))}readStringAt(e,t){let s=this.wasm.allocStringBuffer(4096);if(!s)throw new Error("Failed to allocate string buffer");try{let o=this.wasm.readStringAt(e,t,s,4096);if(o===0)return"";let i=new Uint8Array(this.memory.buffer,s,Math.min(o,4096));return new TextDecoder().decode(i)}finally{this.wasm.free(s,4096)}}readStringColumn(e,t=1e3){let n=Math.min(this.getStringCount(e),t);if(n===0)return[];let s=[];for(let o=0;o<n;o++)s.push(this.readStringAt(e,o));return s}readStringsAtIndices(e,t){if(t.length===0)return[];let n=Math.min(t.length*256,256*1024),s=this.wasm.allocIndexBuffer(t.length);if(!s)throw new Error("Failed to allocate index buffer");let o=this.wasm.allocStringBuffer(n);if(!o)throw this.wasm.free(s,t.length*4),new Error("Failed to allocate string buffer");let i=this.wasm.allocU32Buffer(t.length);if(!i)throw this.wasm.free(s,t.length*4),this.wasm.free(o,n),new Error("Failed to allocate length buffer");try{new Uint32Array(this.memory.buffer,s,t.length).set(t);let a=this.wasm.readStringsAtIndices(e,s,t.length,o,n,i),l=new Uint32Array(this.memory.buffer,i,t.length),c=[],u=0;for(let f=0;f<t.length;f++){let h=l[f];if(h>0&&u+h<=a){let d=new Uint8Array(this.memory.buffer,o+u,h);c.push(new TextDecoder().decode(d)),u+=h}else c.push("")}return c}finally{this.wasm.free(s,t.length*4),this.wasm.free(o,n),this.wasm.free(i,t.length*4)}}getVectorInfo(e){let t=this.wasm.getVectorInfo(e);return{rows:Number(BigInt(t)>>32n),dimension:Number(BigInt(t)&0xFFFFFFFFn)}}readVectorAt(e,t){let n=this.getVectorInfo(e);if(n.dimension===0)return new Float32Array(0);let s=this.wasm.allocFloat32Buffer(n.dimension);if(!s)throw new Error("Failed to allocate vector buffer");try{let o=this.wasm.readVectorAt(e,t,s,n.dimension),i=new Float32Array(o),a=new Float32Array(this.memory.buffer,s,o);return i.set(a),i}finally{this.wasm.free(s,n.dimension*4)}}cosineSimilarity(e,t){if(e.length!==t.length)throw new Error("Vector dimensions must match");let n=this.wasm.allocFloat32Buffer(e.length),s=this.wasm.allocFloat32Buffer(t.length);if(!n||!s)throw new Error("Failed to allocate buffers");try{return new Float32Array(this.memory.buffer,n,e.length).set(e),new Float32Array(this.memory.buffer,s,t.length).set(t),this.wasm.cosineSimilarity(n,s,e.length)}finally{this.wasm.free(n,e.length*4),this.wasm.free(s,t.length*4)}}batchCosineSimilarity(e,t,n=!0){if(t.length===0)return new Float32Array(0);let s=e.length,o=t.length,i=this.wasm.allocFloat32Buffer(s),a=this.wasm.allocFloat32Buffer(o*s),l=this.wasm.allocFloat32Buffer(o);if(!i||!a||!l)throw new Error("Failed to allocate WASM buffers");try{new Float32Array(this.memory.buffer,i,s).set(e);let c=new Float32Array(this.memory.buffer,a,o*s);for(let f=0;f<o;f++)c.set(t[f],f*s);this.wasm.batchCosineSimilarity(i,a,s,o,l,n?1:0);let u=new Float32Array(o);return u.set(new Float32Array(this.memory.buffer,l,o)),u}finally{this.wasm.free(i,s*4),this.wasm.free(a,o*s*4),this.wasm.free(l,o*4)}}readAllVectors(e){let t=this.getVectorInfo(e);if(t.dimension===0||t.rows===0)return[];let n=t.dimension,s=t.rows,o=[],i=this.wasm.allocFloat32Buffer(s*n);if(!i)throw new Error("Failed to allocate vector buffer");try{if(this.wasm.readVectorColumn){let a=this.wasm.readVectorColumn(e,i,s*n),l=new Float32Array(this.memory.buffer,i,a);for(let c=0;c<s&&c*n<a;c++){let u=new Float32Array(n);u.set(l.subarray(c*n,(c+1)*n)),o.push(u)}}else for(let a=0;a<s;a++)o.push(this.readVectorAt(e,a));return o}finally{this.wasm.free(i,s*n*4)}}async vectorSearch(e,t,n=10,s=null){let o=t.length,a=this.getVectorInfo(e).rows,l=q();if(l.isAvailable()){s&&s(0,a);let f=this.readAllVectors(e);s&&s(a,a);let h=await l.batchCosineSimilarity(t,f,!0);return await ut().topK(h,null,n,!0)}s&&s(0,a);let c=this.readAllVectors(e);s&&s(a,a);let u=this.lanceql.batchCosineSimilarity(t,c,!0);return await ut().topK(u,null,n,!0)}df(){return new DataFrame(this)}};X(_t,"Op",{EQ:0,NE:1,LT:2,LE:3,GT:4,GE:5});At();Nn();at();var Mn,Bn,Ln,vt;async function vr(){Mn||(Mn=(await Promise.resolve().then(()=>(en(),os))).ChunkedLanceReader),Bn||(Bn=(await Promise.resolve().then(()=>(Ze(),Fn))).LocalDatabase),Ln||(Ln=(await Promise.resolve().then(()=>(ue(),ht))).opfsStorage),vt||(vt=(await Promise.resolve().then(()=>(At(),mr))).RemoteLanceFile)}var Fe=class{constructor(e){this.type=e}async getSchema(){throw new Error("Not implemented")}async getRowCount(){throw new Error("Not implemented")}async readColumn(e,t=0,n=null){throw new Error("Not implemented")}async*scan(e={}){throw new Error("Not implemented")}async insert(e){throw new Error("Write not supported for this source")}isCached(){return!1}async prefetch(){}async evict(){}async close(){}},Me=class extends Fe{constructor(e,t=null){super("local"),this.path=e,this.storage=t,this.reader=null,this.database=null,this._isDatabase=!1}async open(){await vr(),this.storage=this.storage||Ln;let e=`${this.path}/__manifest__`;return await this.storage.exists(e)?(this._isDatabase=!0,this.database=new Bn(this.path,this.storage),await this.database.open()):this.reader=await Mn.open(this.storage,this.path),this}async getSchema(){if(this._isDatabase){let e=this.database.listTables();return e.length===0?[]:this.database.getSchema(e[0])}return Array.from({length:this.reader.getNumColumns()},(e,t)=>({name:`col_${t}`,type:"unknown"}))}async getRowCount(){if(this._isDatabase){let t=this.database.listTables();return t.length===0?0:this.database.count(t[0])}let e=await this.reader.readColumnMetaRaw(0);return 0}async readColumn(e,t=0,n=null){if(this._isDatabase)throw new Error("Use select() for database queries");return this.reader.readColumnMetaRaw(e)}async*scan(e={}){if(this._isDatabase){let t=this.database.listTables();if(t.length===0)return;yield*this.database.scan(t[0],e)}else throw new Error("scan() requires database, use readColumn() for single files")}async insert(e){if(!this._isDatabase)throw new Error("insert() requires database");let t=this.database.listTables();if(t.length===0)throw new Error("No tables in database");return this.database.insert(t[0],e)}isCached(){return!0}async close(){this.reader&&this.reader.close(),this.database&&await this.database.close()}},et=class extends Fe{constructor(e){super("remote"),this.url=e,this.remoteFile=null,this.cachedPath=null}async open(){await vr();let e=await ae().getCacheInfo(this.url);return e&&e.complete&&(this.type="cached",this.cachedPath=e.path),vt&&(this.remoteFile=await vt.open(null,this.url)),this}async getSchema(){if(!this.remoteFile)return[];let e=this.remoteFile.numColumns,t=[];for(let n=0;n<e;n++){let s=await this.remoteFile.getColumnType?.(n)||"unknown";t.push({name:`col_${n}`,type:s})}return t}async getRowCount(){return this.remoteFile&&this.remoteFile.getRowCount?.(0)||0}async readColumn(e,t=0,n=null){if(!this.remoteFile)throw new Error("Remote file not opened");let s=await this.remoteFile.getColumnType?.(e)||"unknown";if(s.includes("int64"))return this.remoteFile.readInt64Column?.(e,n);if(s.includes("float64"))return this.remoteFile.readFloat64Column?.(e,n);if(s.includes("string"))return this.remoteFile.readStrings?.(e,n);throw new Error(`Unsupported column type: ${s}`)}async*scan(e={}){let t=e.batchSize||1e4,n=await this.getRowCount(),s=await this.getSchema();for(let o=0;o<n;o+=t){let i=Math.min(t,n-o),a=[],l={};for(let c=0;c<s.length;c++)l[s[c].name]=await this.readColumn(c,o,i);for(let c=0;c<i;c++){let u={};for(let f of Object.keys(l))u[f]=l[f][c];(!e.where||e.where(u))&&a.push(u)}yield a}}isCached(){return this.type==="cached"}async prefetch(){let e=ae();await e.cache(this.url);let t=await e.getCacheInfo(this.url);t&&t.complete&&(this.type="cached",this.cachedPath=t.path)}async evict(){await ae().evict(this.url),this.type="remote",this.cachedPath=null}async close(){this.remoteFile&&this.remoteFile.close()}};async function Nr(r){if(r.startsWith("opfs://")){let e=r.slice(7),t=new Me(e);return await t.open(),t}else if(r.startsWith("http://")||r.startsWith("https://")){let e=new et(r);return await e.open(),e}else{let e=new Me(r);return await e.open(),e}}var re,Nt=class r{constructor(e){this.file=e,this._filterOps=[],this._selectCols=null,this._limitValue=null,this._isRemote=e._isRemote||e.baseUrl!==void 0}filter(e,t,n,s="int64"){let o={"=":re?.Op?.EQ??0,"==":re?.Op?.EQ??0,"!=":re?.Op?.NE??1,"<>":re?.Op?.NE??1,"<":re?.Op?.LT??2,"<=":re?.Op?.LE??3,">":re?.Op?.GT??4,">=":re?.Op?.GE??5},i=new r(this.file);return i._filterOps=[...this._filterOps,{colIdx:e,op:o[t],opStr:t,value:n,type:s}],i._selectCols=this._selectCols,i._limitValue=this._limitValue,i._isRemote=this._isRemote,i}select(...e){let t=Array.isArray(e[0])?e[0]:e,n=new r(this.file);return n._filterOps=[...this._filterOps],n._selectCols=t,n._limitValue=this._limitValue,n._isRemote=this._isRemote,n}limit(e){let t=new r(this.file);return t._filterOps=[...this._filterOps],t._selectCols=this._selectCols,t._limitValue=e,t._isRemote=this._isRemote,t}toSQL(){let e=this.file.columnNames||this.file._schema?.map(o=>o.name)||Array.from({length:this.file._numColumns||6},(o,i)=>`col_${i}`),t;this._selectCols&&this._selectCols.length>0?t=this._selectCols.map(o=>e[o]||`col_${o}`).join(", "):t="*";let n="";this._filterOps.length>0&&(n=` WHERE ${this._filterOps.map(i=>{let a=e[i.colIdx]||`col_${i.colIdx}`,l=i.type==="string"?`'${i.value}'`:i.value;return`${a} ${i.opStr} ${l}`}).join(" AND ")}`);let s=this._limitValue?` LIMIT ${this._limitValue}`:"";return`SELECT ${t} FROM dataset${n}${s}`}collectIndices(){if(this._isRemote)throw new Error("collectIndices() is sync-only. Use collect() for remote datasets.");let e=null;for(let t of this._filterOps){let n;if(t.type==="int64"?n=this.file.filterInt64(t.colIdx,t.op,t.value):n=this.file.filterFloat64(t.colIdx,t.op,t.value),e===null)e=n;else{let s=new Set(n);e=e.filter(o=>s.has(o)),e=new Uint32Array(e)}}if(e===null){let t=Number(this.file.getRowCount(0));e=new Uint32Array(t);for(let n=0;n<t;n++)e[n]=n}return this._limitValue!==null&&e.length>this._limitValue&&(e=e.slice(0,this._limitValue)),e}async collect(){if(this._isRemote){let o=this.toSQL();return await this.file.executeSQL(o)}let e=this.collectIndices(),t=this._selectCols||Array.from({length:this.file.numColumns},(o,i)=>i),n=[],s=[];for(let o of t){s.push(this.file.columnNames?.[o]||`col_${o}`);try{n.push(Array.from(this.file.readInt64AtIndices(o,e)))}catch{try{n.push(Array.from(this.file.readFloat64AtIndices(o,e)))}catch{n.push(e.map(()=>null))}}}return{columns:n,columnNames:s,total:e.length,_indices:e}}async count(){return this._isRemote?(await this.collect()).columns[0]?.length||0:this.collectIndices().length}};var Le,kn,I=class I{static _autoInit(){I._initialized||(I._initialized=!0,I._registerBuiltinRenderers(),I._injectTriggerStyles(),I._setupObserver(),I._processExisting())}static async _getDataset(e){if(!e){if(I._defaultDataset)return I._datasets.get(I._defaultDataset);throw new Error('No dataset URL. Add data-dataset="https://..." to your element.')}if(I._datasets.has(e))return I._datasets.get(e);if(Le||(Le=(await Promise.resolve().then(()=>(st(),On))).LanceQL),kn||(kn=(await Promise.resolve().then(()=>(Nn(),xr))).RemoteLanceDataset),!I._wasm){let n=document.querySelector("script[data-lanceql-wasm]")?.dataset.lanceqlWasm||"./lanceql.wasm";I._wasm=await Le.load(n)}let t=await kn.open(I._wasm,e);return I._datasets.set(e,t),I._defaultDataset||(I._defaultDataset=e),t}static async init(e={}){I._autoInit(),e.wasmUrl&&(Le||(Le=(await Promise.resolve().then(()=>(st(),On))).LanceQL),I._wasm=await Le.load(e.wasmUrl)),e.dataset&&await I._getDataset(e.dataset)}static _injectTriggerStyles(){if(document.getElementById("lance-data-triggers"))return;let e=document.createElement("style");e.id="lance-data-triggers",e.textContent=`
            @keyframes lance-query-trigger {
                from { --lance-trigger: 0; }
                to { --lance-trigger: 1; }
            }

            .lance-data {
                animation: lance-query-trigger 0.001s;
            }

            .lance-data[data-refresh] {
                animation: lance-query-trigger 0.001s;
            }

            .lance-data[data-loading]::before {
                content: '';
                display: block;
                width: 20px;
                height: 20px;
                border: 2px solid #3b82f6;
                border-top-color: transparent;
                border-radius: 50%;
                animation: lance-spin 0.8s linear infinite;
            }

            @keyframes lance-spin {
                to { transform: rotate(360deg); }
            }

            .lance-data[data-error]::before {
                content: attr(data-error);
                color: #ef4444;
                font-size: 12px;
            }

            .lance-data table {
                width: 100%;
                border-collapse: collapse;
                font-size: 13px;
            }

            .lance-data th, .lance-data td {
                padding: 8px 12px;
                text-align: left;
                border-bottom: 1px solid #334155;
            }

            .lance-data th {
                background: #1e293b;
                font-weight: 500;
                color: #94a3b8;
            }

            .lance-data tr:hover td {
                background: rgba(59, 130, 246, 0.05);
            }

            .lance-data .lance-value {
                font-size: 24px;
                font-weight: 600;
                color: #3b82f6;
            }

            .lance-data .lance-list {
                list-style: none;
                padding: 0;
                margin: 0;
            }

            .lance-data .lance-list li {
                padding: 8px 0;
                border-bottom: 1px solid #334155;
            }

            .lance-data .lance-json {
                background: #0f172a;
                padding: 12px;
                border-radius: 8px;
                font-family: 'SF Mono', Monaco, monospace;
                font-size: 12px;
                white-space: pre-wrap;
                overflow-x: auto;
            }

            .lance-data .lance-images {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 16px;
            }

            .lance-data .lance-images .image-card {
                background: #1e293b;
                border-radius: 8px;
                overflow: hidden;
            }

            .lance-data .lance-images img {
                width: 100%;
                aspect-ratio: 1;
                object-fit: cover;
            }

            .lance-data .lance-images .image-meta {
                padding: 8px;
                font-size: 12px;
                color: #94a3b8;
            }
        `,document.head.appendChild(e)}static _setupObserver(){if(I._observer)return;let e=t=>t.hasAttribute?.("lq-query")||t.hasAttribute?.("lq-src")||t.classList?.contains("lance-data");I._observer=new MutationObserver(t=>{for(let n of t){for(let s of n.addedNodes)s.nodeType===Node.ELEMENT_NODE&&(e(s)&&I._processElement(s),s.querySelectorAll?.("[lq-query], [lq-src], .lance-data")?.forEach(o=>{I._processElement(o)}));n.type==="attributes"&&e(n.target)&&I._processElement(n.target)}}),I._observer.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["lq-query","lq-src","lq-render","lq-bind","data-query","data-dataset","data-render","data-refresh"]}),document.body.addEventListener("animationstart",t=>{t.animationName==="lance-query-trigger"&&e(t.target)&&I._processElement(t.target)})}static _processExisting(){document.querySelectorAll("[lq-query], [lq-src], .lance-data").forEach(e=>{I._processElement(e)})}static _parseConfig(e){let t=(n,s)=>e.getAttribute(n)||e.dataset[s]||null;return{dataset:t("lq-src","dataset"),query:t("lq-query","query"),render:t("lq-render","render")||"table",columns:(t("lq-columns","columns")||"").split(",").map(n=>n.trim()).filter(Boolean),bind:t("lq-bind","bind")}}static render(e,t,n={}){let s=typeof e=="string"?document.querySelector(e):e;if(!s){console.error("[LanceData] Element not found:",e);return}try{s.dispatchEvent(new CustomEvent("lq-start",{detail:{query:n.query||null}}));let o=n.render||s.dataset.render||"table",i=I._renderers[o]||I._renderers.table;s.id&&I._queryCache.set(`rendered:${s.id}`,t),s.innerHTML=i(t,{render:o,...n}),s.dispatchEvent(new CustomEvent("lq-complete",{detail:{query:n.query||null,columns:t.columns||[],total:t.total||t.rows?.length||0}}))}catch(o){throw s.dispatchEvent(new CustomEvent("lq-error",{detail:{query:n.query||null,message:o.message,error:o}})),o}}static _extractUrlFromQuery(e){let t=e.match(/read_lance\s*\(\s*['"]([^'"]+)['"]/i);return t?t[1]:null}static async _processElement(e){if(e.dataset.processing==="true")return;e.dataset.processing="true";let t;try{if(t=I._parseConfig(e),!t.query){e.dataset.processing="false";return}t.bind&&I._setupBinding(e,t),e.dataset.loading="true",delete e.dataset.error,e.dispatchEvent(new CustomEvent("lq-start",{detail:{query:t.query}}));let n=t.dataset||I._extractUrlFromQuery(t.query),s=await I._getDataset(n),o=`${n||"default"}:${t.query}`,i=I._queryCache.get(o);i||(i=await s.executeSQL(t.query),I._queryCache.set(o,i));let a=I._renderers[t.render]||I._renderers.table;e.innerHTML=a(i,t),delete e.dataset.loading,e.dispatchEvent(new CustomEvent("lq-complete",{detail:{query:t.query,columns:i.columns||[],total:i.total||i.rows?.length||0}}))}catch(n){delete e.dataset.loading,e.dataset.error=n.message,console.error("[LanceData]",n),e.dispatchEvent(new CustomEvent("lq-error",{detail:{query:t?.query,message:n.message,error:n}}))}finally{e.dataset.processing="false"}}static _setupBinding(e,t){let n=document.querySelector(t.bind);if(!n)return;let s=t.bind;if(I._bindings.has(s))return;let o=()=>{let i=n.value,a=t.query.replace(/\$value/g,i);e.hasAttribute("lq-query")?e.setAttribute("lq-query",a):e.dataset.query=a,e.dataset.refresh=Date.now()};n.addEventListener("input",o),n.addEventListener("change",o),I._bindings.set(s,{input:n,handler:o,element:e})}static registerRenderer(e,t){I._renderers[e]=t}static _registerBuiltinRenderers(){I._renderers.table=(e,t)=>{if(!e)return'<div class="lance-empty">No results</div>';let n,s;if(e.columns&&e.rows)n=t.columns?.length?t.columns:e.columns.filter(i=>!i.startsWith("_")&&i!=="embedding"),s=e.rows;else if(Array.isArray(e)){if(e.length===0)return'<div class="lance-empty">No results</div>';n=t.columns?.length?t.columns:Object.keys(e[0]).filter(i=>!i.startsWith("_")&&i!=="embedding"),s=e.map(i=>n.map(a=>i[a]))}else return'<div class="lance-empty">No results</div>';if(s.length===0)return'<div class="lance-empty">No results</div>';let o="<table><thead><tr>";for(let i of n)o+=`<th>${I._escapeHtml(String(i))}</th>`;o+="</tr></thead><tbody>";for(let i of s){o+="<tr>";for(let a=0;a<n.length;a++){let l=i[a];o+=`<td>${I._formatValue(l)}</td>`}o+="</tr>"}return o+="</tbody></table>",o},I._renderers.list=(e,t)=>{if(!e||e.length===0)return'<div class="lance-empty">No results</div>';let n=t.columns?.[0]||Object.keys(e[0])[0],s='<ul class="lance-list">';for(let o of e)s+=`<li>${I._formatValue(o[n])}</li>`;return s+="</ul>",s},I._renderers.value=(e,t)=>{if(!e||e.length===0)return'<div class="lance-empty">-</div>';let n=e[0],s=Object.keys(n)[0],o=n[s];return`<div class="lance-value">${I._formatValue(o)}</div>`},I._renderers.json=(e,t)=>`<pre class="lance-json">${I._escapeHtml(JSON.stringify(e,null,2))}</pre>`,I._renderers.images=(e,t)=>{if(!e||e.length===0)return'<div class="lance-empty">No images</div>';let n='<div class="lance-images">';for(let s of e){let o=s.url||s.image_url||s.src,i=s.text||s.caption||s.title||"";o&&(n+=`
                        <div class="image-card">
                            <img src="${I._escapeHtml(o)}" alt="${I._escapeHtml(i)}" loading="lazy">
                            ${i?`<div class="image-meta">${I._escapeHtml(i.substring(0,100))}</div>`:""}
                        </div>
                    `)}return n+="</div>",n},I._renderers.count=(e,t)=>`<span class="lance-count">${(e?.[0]?.count??e?.length??0).toLocaleString()}</span>`}static _isImageUrl(e){if(!e||typeof e!="string")return!1;let t=e.toLowerCase();return(t.startsWith("http://")||t.startsWith("https://"))&&(t.includes(".jpg")||t.includes(".jpeg")||t.includes(".png")||t.includes(".gif")||t.includes(".webp")||t.includes(".svg"))}static _isUrl(e){return!e||typeof e!="string"?!1:e.startsWith("http://")||e.startsWith("https://")}static _formatValue(e){if(e==null)return'<span class="null-value">NULL</span>';if(e==="")return'<span class="empty-value">(empty)</span>';if(typeof e=="number")return Number.isInteger(e)?e.toLocaleString():e.toFixed(4);if(Array.isArray(e))return e.length>10?`<span class="vector-badge">[${e.length}d]</span>`:`[${e.slice(0,5).map(n=>I._formatValue(n)).join(", ")}${e.length>5?"...":""}]`;if(typeof e=="object")return JSON.stringify(e);let t=String(e);if(I._isImageUrl(t)){let n=I._escapeHtml(t),s=n.length>40?n.substring(0,40)+"...":n;return`<div class="image-cell">
                <img src="${n}" alt="" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
                <div class="image-placeholder" style="display:none"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg></div>
                <a href="${n}" target="_blank" class="url-text" title="${n}">${s}</a>
            </div>`}if(I._isUrl(t)){let n=I._escapeHtml(t),s=n.length>50?n.substring(0,50)+"...":n;return`<a href="${n}" target="_blank" class="url-link" title="${n}">${s}</a>`}return t.length>100?`<span title="${I._escapeHtml(t)}">${I._escapeHtml(t.substring(0,100))}...</span>`:I._escapeHtml(t)}static _escapeHtml(e){let t=document.createElement("div");return t.textContent=e,t.innerHTML}static clearCache(){I._queryCache.clear()}static refresh(){I._queryCache.clear(),document.querySelectorAll(".lance-data").forEach(e=>{e.setAttribute("data-refresh",Date.now())})}static destroy(){I._observer&&(I._observer.disconnect(),I._observer=null);for(let[e,t]of I._bindings)t.input.removeEventListener("input",t.handler),t.input.removeEventListener("change",t.handler);I._bindings.clear(),document.getElementById("lance-data-triggers")?.remove(),I._instance=null,I._dataset=null,I._queryCache.clear()}};X(I,"_initialized",!1),X(I,"_observer",null),X(I,"_wasm",null),X(I,"_datasets",new Map),X(I,"_renderers",{}),X(I,"_bindings",new Map),X(I,"_queryCache",new Map),X(I,"_defaultDataset",null);var Oe=I;typeof document<"u"&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>Oe._autoInit()):Oe._autoInit());le();var Dn,ke,Gn,zn,$n,Vn,we=class{constructor(e,t){this.db=e,this.sql=t,this.params=null,this.results=null,this.resultIndex=0,this.done=!1}bind(e){return this.params=e,this.results=null,this.resultIndex=0,this.done=!1,!0}step(){if(this.done)return!1;if(this.results===null){let e=this.db.exec(this.sql,this.params);if(e.length===0||e[0].values.length===0)return this.done=!0,!1;this.results=e[0],this.resultIndex=0}return this.resultIndex>=this.results.values.length?(this.done=!0,!1):!0}get(){if(!this.results||this.resultIndex>=this.results.values.length)return[];let e=this.results.values[this.resultIndex];return this.resultIndex++,e}getAsObject(e){if(!this.results||this.resultIndex>=this.results.values.length)return{};let t=this.results.values[this.resultIndex];this.resultIndex++;let n={};return this.results.columns.forEach((s,o)=>{n[s]=t[o]}),n}getColumnNames(){return this.results?.columns||[]}reset(){return this.results=null,this.resultIndex=0,this.done=!1,!0}free(){return this.results=null,this.params=null,!0}freemem(){return this.free()}},De=class{constructor(e,t=null){e instanceof Uint8Array?(this._inMemory=!0,this._data=e,this._name=":memory:",this._db=null):(this._inMemory=!1,this._name=e||"default",this._storage=t,this._db=null,this._pendingInit=!0),this._open=!1,this._rowsModified=0}async _ensureOpen(){this._open||(Dn||(Dn=(await Promise.resolve().then(()=>(Ze(),Fn))).LocalDatabase),ke||(ke=(await Promise.resolve().then(()=>(ue(),ht))).opfsStorage),!this._db&&!this._inMemory&&(this._db=new Dn(this._name,this._storage||ke)),this._db&&await this._db.open(),this._open=!0)}exec(e,t){return this._execAsync(e,t)}async _execAsync(e,t){await this._ensureOpen();let n=e;if(t){if(Array.isArray(t)){let i=0;n=e.replace(/\?/g,()=>{let a=t[i++];return this._formatValue(a)})}else if(typeof t=="object")for(let[i,a]of Object.entries(t)){let l=new RegExp(`[:$@]${i}\\b`,"g");n=n.replace(l,this._formatValue(a))}}let s=n.split(";").map(i=>i.trim()).filter(i=>i.length>0),o=[];for(let i of s)try{let l=new j(i).tokenize(),u=new K(l).parse();if(u.type==="SELECT"){let f=await this._db._executeAST(u);if(f&&f.length>0){let h=Object.keys(f[0]),d=f.map(p=>h.map(g=>p[g]));o.push({columns:h,values:d})}this._rowsModified=0}else{let f=await this._db._executeAST(u);this._rowsModified=f?.inserted||f?.updated||f?.deleted||0}}catch(a){throw new Error(`SQL error: ${a.message}
Statement: ${i}`)}return o}run(e,t){return this._runAsync(e,t)}async _runAsync(e,t){return await this.exec(e,t),this}prepare(e,t){let n=new we(this,e);return t&&n.bind(t),n}each(e,t,n,s){return this._eachAsync(e,t,n,s),this}async _eachAsync(e,t,n,s){try{let o=await this.exec(e,t);if(o.length>0){let{columns:i,values:a}=o[0];for(let l of a){let c={};i.forEach((u,f)=>{c[u]=l[f]}),n(c)}}s&&s()}catch(o){if(s)s(o);else throw o}}getRowsModified(){return this._rowsModified}async export(){if(this._inMemory&&this._data)return this._data;await this._ensureOpen();let e={version:this._db?.version,tables:{}};if(this._db)for(let t of this._db.listTables()){let n=this._db.getTable(t),s=await this._db.select(t,{});e.tables[t]={schema:n?.schema,rows:s}}return new TextEncoder().encode(JSON.stringify(e))}close(){this._open=!1,this._db=null}create_function(e,t){return console.warn(`[LanceQL] create_function('${e}') not yet implemented`),this}create_aggregate(e,t){return console.warn(`[LanceQL] create_aggregate('${e}') not yet implemented`),this}_formatValue(e){return e==null?"NULL":typeof e=="string"?`'${e.replace(/'/g,"''")}'`:typeof e=="number"?String(e):typeof e=="boolean"?e?"TRUE":"FALSE":Array.isArray(e)?`'[${e.join(",")}]'`:String(e)}};async function Br(r={}){try{ke||(ke=(await Promise.resolve().then(()=>(ue(),ht))).opfsStorage),await ke.open()}catch(e){console.warn("[LanceQL] OPFS not available:",e.message)}try{await q().init(),Gn||(Gn=new Se),zn||(zn=new Ae),$n||($n=new Ce),Vn||(Vn=new Ie),await Gn.init(),await zn.init(),await Jt().init(),await $n.init(),await Vn.init()}catch(e){console.warn("[LanceQL] WebGPU not available:",e.message)}return{Database:De,Statement:we}}St();Ze();ue();async function Wn(r,e){let t=e.from.name||e.from.table,n=e.from.alias||t;e.from.alias&&r.aliases.set(e.from.alias,t);let s=null,o=n,i=t,a=r.getTable(t);for(let l=0;l<e.joins.length;l++){let c=e.joins[l],u=c.table.name||c.table.table,f=c.alias||u;c.alias&&r.aliases.set(c.alias,u);let h=r.getTable(u),d={...e,joins:[c],limit:l===e.joins.length-1?e.limit:void 0,columns:l===e.joins.length-1?e.columns:[{type:"column",column:"*"}]};s===null?s=await oi(r,a,h,d,{leftAlias:o,rightAlias:f,leftTableName:i,rightTableName:u}):s=await qn(r,s,h,d,{leftAlias:o,rightAlias:f,leftTableName:i,rightTableName:u}),o=`${o}_${f}`,i=`(${i} JOIN ${u})`}return s}async function oi(r,e,t,n,s){let{leftAlias:o,rightAlias:i,leftTableName:a,rightTableName:l}=s,c=n.joins[0],u=c.type||"INNER",f=c.on;if(u!=="CROSS"&&(!f||f.type!=="binary"||f.op!=="="))throw new Error("JOIN ON condition must be an equality (e.g., table1.col1 = table2.col2)");let h,d,p,g,b;if(u==="CROSS")h=null,d=null,p=`SELECT * FROM ${a}`,g=`SELECT * FROM ${l}`;else{b=new de().plan(n,s),h=b.join.leftKey,d=b.join.rightKey;let F=b.leftScan.columns,L=b.rightScan.columns,G=b.leftScan.filters,W=b.rightScan.filters,be=F.includes("*")?["*"]:[...new Set([h,...F])],oe="";G.length>0&&(oe=` WHERE ${G.map(Vt=>$(Vt)).join(" AND ")}`),p=`SELECT ${be.join(", ")} FROM ${a}${oe}`;let se=L.includes("*")?["*"]:[...new Set([d,...L])],ss="";W.length>0&&(ss=` WHERE ${W.map(Vt=>$(Vt)).join(" AND ")}`),g=`SELECT ${se.join(", ")} FROM ${l}${ss}`}await ft.open();let y=new Pe(ft),w=new V(e),E=new V(t),_=w.executeStream(p),S=await y._partitionToOPFS(_,h,"left",!0),A=g;if(S.collectedKeys&&S.collectedKeys.size>0&&S.collectedKeys.size<=1e4){let P=Ft(d,S.collectedKeys);A=Mt(g,P)}let U=E.executeStream(A),C=[],x=null;try{for await(let P of y.executeHashJoin(null,U,h,d,{limit:n.limit||1/0,leftAlias:o,rightAlias:i,joinType:c.type||"INNER",prePartitionedLeft:S}))if(x||(x=P.columns),C.push(...P.rows),n.limit&&C.length>=n.limit)break}catch(P){throw console.error("[LanceDatabase] OPFS join failed:",P),P}let T=y.getStats();if(!x||C.length===0)return{columns:[],rows:[],total:0,opfsStats:T};let N=jn(C,x,b.projection,o,i),B=n.limit?N.rows.slice(0,n.limit):N.rows;return{columns:N.columns,rows:B,total:B.length,opfsStats:T}}async function qn(r,e,t,n,s){let{leftAlias:o,rightAlias:i,leftTableName:a,rightTableName:l}=s,c=n.joins[0],u=c.type||"INNER",f=c.on;if(u!=="CROSS"&&(!f||f.type!=="binary"||f.op!=="="))throw new Error("JOIN ON condition must be an equality (e.g., table1.col1 = table2.col2)");let h,d;if(u==="CROSS")h=null,d=null;else{let C=f.left,x=f.right,T=C.column,N=x.column;new Set(e.columns.map(P=>{let F=P.split(".");return F[F.length-1]})).has(T)?(h=T,d=N):(h=N,d=T)}let p=`SELECT * FROM ${l}`,g=1e3;if(h&&u!=="CROSS"){let C=rt(e.columns,h);if(C!==-1){let x=new Set;for(let T of e.rows){let N=T[C];N!=null&&x.add(N)}if(x.size>0&&x.size<=g){let T=Ft(d,x);p=Mt(p,T)}}}let y=await new V(t).execute(new K(new j(p).tokenize()).parse()),w=h?rt(e.columns,h):-1,E=d?rt(y.columns,d):-1,_=[...e.columns,...y.columns.map(C=>`${i}.${C}`)],S=[],A=new Array(y.columns.length).fill(null),R=new Array(e.columns.length).fill(null);if(u==="CROSS")for(let C of e.rows){for(let x of y.rows)if(S.push([...C,...x]),n.limit&&S.length>=n.limit)break;if(n.limit&&S.length>=n.limit)break}else{let C=new Map;for(let T of y.rows){let N=T[E];N!=null&&(C.has(N)||C.set(N,[]),C.get(N).push(T))}let x=u==="FULL"||u==="RIGHT"?new Set:null;for(let T of e.rows){let N=T[w],B=C.get(N)||[];if(B.length>0){for(let P of B)if(S.push([...T,...P]),x&&x.add(y.rows.indexOf(P)),n.limit&&S.length>=n.limit)break}else(u==="LEFT"||u==="FULL")&&S.push([...T,...A]);if(n.limit&&S.length>=n.limit)break}if((u==="RIGHT"||u==="FULL")&&x)for(let T=0;T<y.rows.length&&!(!x.has(T)&&(S.push([...R,...y.rows[T]]),n.limit&&S.length>=n.limit));T++);}let U=n.limit?S.slice(0,n.limit):S;return{columns:_,rows:U,total:U.length}}function rt(r,e){let t=r.indexOf(e);if(t!==-1)return t;for(let n=0;n<r.length;n++){let o=r[n].split(".");if(o[o.length-1]===e)return n}return-1}function $(r){if(!r)return"";if(r.type==="binary"){let e=$(r.left),t=$(r.right);return`${e} ${r.op} ${t}`}else{if(r.type==="column")return r.column;if(r.type==="literal")return typeof r.value=="string"?`'${r.value.replace(/'/g,"''")}'`:r.value===null?"NULL":String(r.value);if(r.type==="call"){let e=(r.args||[]).map(t=>$(t)).join(", ");return`${r.name}(${e})`}else if(r.type==="in"){let e=$(r.expr),t=r.values.map(n=>$(n)).join(", ");return`${e} IN (${t})`}else if(r.type==="between"){let e=$(r.expr),t=$(r.low),n=$(r.high);return`${e} BETWEEN ${t} AND ${n}`}else if(r.type==="like"){let e=$(r.expr),t=$(r.pattern);return`${e} LIKE ${t}`}else if(r.type==="unary"){let e=$(r.operand);return r.op==="NOT"?`NOT ${e}`:`${r.op}${e}`}}return""}function jn(r,e,t,n,s){if(t.includes("*"))return{columns:e,rows:r};let o=[],i=[];for(let l of t){if(l==="*")continue;let c=-1,u=l.column;if(l.table){let f=`${l.table}.${l.column}`;c=e.indexOf(f),u=f}c===-1&&(c=e.findIndex(f=>f===l.column||f.endsWith(`.${l.column}`)),c!==-1&&(u=e[c])),c!==-1&&(o.push(l.alias||u),i.push(c))}let a=r.map(l=>i.map(c=>l[c]));return{columns:o,rows:a}}function Ft(r,e){let t=Array.from(e).map(n=>typeof n=="string"?`'${n.replace(/'/g,"''")}'`:n===null?"NULL":String(n)).join(", ");return`${r} IN (${t})`}function Mt(r,e){return r.toUpperCase().includes("WHERE")?r.replace(/WHERE\s+/i,`WHERE ${e} AND `):r.replace(/FROM\s+(\w+)(\s+\w+)?/i,n=>`${n} WHERE ${e}`)}var Bt=class{constructor(e,t){this.name=e,this.schema=t,this.columns=t.map(n=>n.name),this.rows=[],this._columnIndex=new Map,this.columns.forEach((n,s)=>{this._columnIndex.set(n.toLowerCase(),s)})}toInMemoryData(){return{columns:this.columns,rows:this.rows}}};function Lr(r,e){let t=(e.table||e.name||"").toLowerCase();if(!t)throw new Error("CREATE TABLE requires a table name");if(r.memoryTables.has(t)||r.tables.has(t)){if(e.ifNotExists)return{success:!0,existed:!0,table:t};throw new Error(`Table '${t}' already exists`)}let n=(e.columns||[]).map(o=>({name:o.name,dataType:o.dataType||o.type||"TEXT",primaryKey:o.primaryKey||!1}));if(n.length===0)throw new Error("CREATE TABLE requires at least one column");let s=new Bt(t,n);return r.memoryTables.set(t,s),{success:!0,table:t,columns:n.map(o=>o.name)}}function Or(r,e){let t=(e.table||e.name||"").toLowerCase();if(!r.memoryTables.has(t)){if(e.ifExists)return{success:!0,existed:!1,table:t};throw new Error(`Memory table '${t}' not found`)}return r.memoryTables.delete(t),{success:!0,table:t}}function kr(r,e){let t=(e.table||"").toLowerCase(),n=r.memoryTables.get(t);if(!n)throw new Error(`Memory table '${t}' not found. Use CREATE TABLE first.`);let s=e.columns||n.columns,o=0;for(let i of e.rows||e.values||[]){let a=new Array(n.columns.length).fill(null);s.forEach((l,c)=>{let u=n._columnIndex.get((typeof l=="string"?l:l.name||l).toLowerCase());if(u!==void 0&&c<i.length){let f=i[c];a[u]=f?.value!==void 0?f.value:f}}),n.rows.push(a),o++}return{success:!0,inserted:o,total:n.rows.length}}function Dr(r,e){let t=(e.table||"").toLowerCase(),n=r.memoryTables.get(t);if(!n)throw new Error(`Memory table '${t}' not found`);let s={};n.columns.forEach((a,l)=>{s[a.toLowerCase()]=n.rows.map(c=>c[l])});let o=new V({columnNames:n.columns}),i=0;for(let a=0;a<n.rows.length;a++)if(!e.where||o._evaluateInMemoryExpr(e.where,s,a)){for(let c of e.assignments||e.set||[]){let u=(c.column||c.name||"").toLowerCase(),f=n._columnIndex.get(u);if(f!==void 0){let h=c.value;n.rows[a][f]=h?.value!==void 0?h.value:h}}i++}return{success:!0,updated:i}}function Gr(r,e){let t=(e.table||"").toLowerCase(),n=r.memoryTables.get(t);if(!n)throw new Error(`Memory table '${t}' not found`);let s=n.rows.length;if(e.where){let o={};n.columns.forEach((a,l)=>{o[a.toLowerCase()]=n.rows.map(c=>c[l])});let i=new V({columnNames:n.columns});n.rows=n.rows.filter((a,l)=>!i._evaluateInMemoryExpr(e.where,o,l))}else n.rows=[];return{success:!0,deleted:s-n.rows.length,remaining:n.rows.length}}function Qn(r,e){let t=Dt(e),n=r._planCache.get(t);return n?(n.hits++,n.lastUsed=Date.now(),n.plan):null}function Jn(r,e,t){let n=Dt(e);if(r._planCache.size>=r._planCacheMaxSize){let s=null,o=1/0;for(let[i,a]of r._planCache)a.lastUsed<o&&(o=a.lastUsed,s=i);s&&r._planCache.delete(s)}r._planCache.set(n,{plan:t,hits:0,lastUsed:Date.now(),created:Date.now()})}function Dt(r){return r.trim().replace(/\s+/g," ").toLowerCase()}function $r(r){let e=0;for(let t of r._planCache.values())e+=t.hits;return{size:r._planCache.size,maxSize:r._planCacheMaxSize,totalHits:e}}function Ge(r){if(!r)return r;r.left&&(r.left=Ge(r.left)),r.right&&(r.right=Ge(r.right)),r.operand&&(r.operand=Ge(r.operand)),r.args&&(r.args=r.args.map(t=>Ge(t)));let e=r.op||r.operator;if(r.type==="binary"&&kt(r.left)&&kt(r.right))return li(r);if(r.type==="binary"&&e==="AND"){if(Lt(r.right))return r.left;if(Lt(r.left))return r.right;if(Ot(r.left)||Ot(r.right))return{type:"literal",value:!1}}if(r.type==="binary"&&e==="OR"){if(Ot(r.right))return r.left;if(Ot(r.left))return r.right;if(Lt(r.left)||Lt(r.right))return{type:"literal",value:!0}}return r}function kt(r){return r&&["literal","number","string"].includes(r.type)}function Lt(r){return r?.type==="literal"&&r.value===!0}function Ot(r){return r?.type==="literal"&&r.value===!1}function li(r){let e=ze(r.left),t=ze(r.right),n=r.op||r.operator,s;switch(n){case"+":s=e+t;break;case"-":s=e-t;break;case"*":s=e*t;break;case"/":s=t!==0?e/t:null;break;case"%":s=e%t;break;case"=":case"==":s=e===t;break;case"!=":case"<>":s=e!==t;break;case"<":s=e<t;break;case">":s=e>t;break;case"<=":s=e<=t;break;case">=":s=e>=t;break;default:return r}return{type:"literal",value:s}}function ze(r){return r.type==="number"||r.type==="string"||r.type==="literal"?r.value:null}function Yn(r){let e=[];return Kn(r,e),e}function Kn(r,e){if(!r)return;let t=r.op||r.operator;if(r.type==="binary"&&t==="AND"){Kn(r.left,e),Kn(r.right,e);return}let n=t==="=="?"=":t;if([">","<",">=","<=","=","!=","<>"].includes(n)&&(zr(r.left)&&kt(r.right)?e.push({column:Hn(r.left),operator:n,value:ze(r.right)}):kt(r.left)&&zr(r.right)&&e.push({column:Hn(r.right),operator:ci(n),value:ze(r.left)})),r.type==="between"&&r.expr){let s=Hn(r.expr);s&&r.low&&r.high&&(e.push({column:s,operator:">=",value:ze(r.low)}),e.push({column:s,operator:"<=",value:ze(r.high)}))}}function ci(r){return{">":"<","<":">",">=":"<=","<=":">="}[r]||r}function zr(r){return r&&(r.type==="column"||r.type==="identifier")}function Hn(r){return r.type==="column"?r.name||r.column:r.type==="identifier"?r.name||r.value:null}function Vr(r,e){for(let t of e){let n=r[t.column];if(!n)continue;let{min:s,max:o,nullCount:i,rowCount:a}=n;if(i===a)return!0;switch(t.operator){case">":if(o<=t.value)return!0;break;case">=":if(o<t.value)return!0;break;case"<":if(s>=t.value)return!0;break;case"<=":if(s>t.value)return!0;break;case"=":if(t.value<s||t.value>o)return!0;break;case"!=":case"<>":if(s===o&&s===t.value)return!0;break}}return!1}function Xn(r,e){let t={type:e.type,tables:[],predicates:[],optimizations:[]};if(e.from&&t.tables.push({name:e.from.name||e.from.table,alias:e.from.alias}),e.joins)for(let n of e.joins)t.tables.push({name:n.table?.name||n.table?.table,alias:n.table?.alias,joinType:n.type});return e.where&&(t.predicates=Yn(e.where)),e.where&&t.optimizations.push("PREDICATE_PUSHDOWN"),e.groupBy&&t.optimizations.push("AGGREGATE"),e.orderBy&&t.optimizations.push("SORT"),e.limit&&t.optimizations.push("LIMIT_PUSHDOWN"),{columns:["Plan"],rows:[[JSON.stringify(t,null,2)]],total:1}}var Zn=class{constructor(){this.tables=new Map,this.aliases=new Map,this._planCache=new Map,this._planCacheMaxSize=100,this.memoryTables=new Map}register(e,t){this.tables.set(e,t)}async registerRemote(e,t,n={}){let s=window.lanceql||globalThis.lanceql;if(!s)throw new Error("LanceQL WASM module not loaded. Call LanceQL.load() first.");let o=await s.openDataset(t,n);return this.register(e,o),o}getTable(e){let t=this.aliases.get(e)||e,n=this.tables.get(t);if(!n)throw new Error(`Table '${e}' not found. Did you forget to register it?`);return n}async executeSQL(e){let t=Qn(this,e),n;if(t)n=t;else{let o=new j(e).tokenize();n=new K(o).parse(),n.type!=="EXPLAIN"&&Jn(this,e,n)}if(n.type==="EXPLAIN")return Xn(this,n.statement);if(n.type==="CREATE_TABLE")return Lr(this,n);if(n.type==="DROP_TABLE")return Or(this,n);if(n.type==="INSERT")return kr(this,n);if(n.type==="UPDATE")return Dr(this,n);if(n.type==="DELETE")return Gr(this,n);if(n.type==="SET_OPERATION")return this._executeSetOperation(n);if(n.type!=="SELECT")throw new Error("Only SELECT queries are supported in LanceDatabase");return n.ctes&&n.ctes.length>0?this._executeWithCTEs(n):!n.joins||n.joins.length===0?this._executeSingleTable(n):Wn(this,n)}async _executeWithCTEs(e){let t=new V({columnNames:[]});t.setDatabase(this),await t.materializeCTEs(e.ctes,this);let n=e.from?.name?.toLowerCase()||e.from?.table?.toLowerCase();return n&&t._cteResults.has(n)?t._executeOnInMemoryData(e,t._cteResults.get(n)):!e.joins||e.joins.length===0?this._executeSingleTable(e):Wn(this,e)}async _executeSetOperation(e){let t=await this.executeSQL(this._astToSQL(e.left)),n=await this.executeSQL(this._astToSQL(e.right));if(t.columns.length!==n.columns.length)throw new Error("SET operations require same number of columns");let s=a=>JSON.stringify(a),o;switch(e.operator){case"UNION":if(o=[...t.rows,...n.rows],!e.all){let c=new Set;o=o.filter(u=>{let f=s(u);return c.has(f)?!1:(c.add(f),!0)})}break;case"INTERSECT":let a=new Set(n.rows.map(s));if(o=t.rows.filter(c=>a.has(s(c))),!e.all){let c=new Set;o=o.filter(u=>{let f=s(u);return c.has(f)?!1:(c.add(f),!0)})}break;case"EXCEPT":let l=new Set(n.rows.map(s));if(o=t.rows.filter(c=>!l.has(s(c))),!e.all){let c=new Set;o=o.filter(u=>{let f=s(u);return c.has(f)?!1:(c.add(f),!0)})}break;default:throw new Error(`Unknown SET operator: ${e.operator}`)}if(e.orderBy&&e.orderBy.length>0){let a={};t.columns.forEach((l,c)=>{a[l.toLowerCase()]=c}),o.sort((l,c)=>{for(let u of e.orderBy){let f=a[u.column.toLowerCase()];if(f===void 0)continue;let h=l[f],d=c[f],p=u.direction==="DESC"?-1:1;if(!(h==null&&d==null)){if(h==null)return 1*p;if(d==null||h<d)return-1*p;if(h>d)return 1*p}}return 0})}let i=e.offset||0;return i>0&&(o=o.slice(i)),e.limit&&(o=o.slice(0,e.limit)),{columns:t.columns,rows:o,total:o.length}}_astToSQL(e){if(e.type==="SET_OPERATION"){let n=this._astToSQL(e.left),s=this._astToSQL(e.right),o=e.operator+(e.all?" ALL":"");return`(${n}) ${o} (${s})`}let t=e.distinct?"SELECT DISTINCT ":"SELECT ";if(t+=e.columns.map(n=>{if(n.expr?.type==="star")return"*";let s=this._exprToSQL(n.expr);return n.alias?`${s} AS ${n.alias}`:s}).join(", "),e.from){let n=e.from.name||e.from.table;t+=` FROM ${n}`,e.from.alias&&(t+=` AS ${e.from.alias}`)}if(e.joins)for(let n of e.joins){let s=n.table?.name||n.table?.table;t+=` ${n.type} ${s}`,n.alias&&(t+=` AS ${n.alias}`),n.on&&(t+=` ON ${this._exprToSQL(n.on)}`)}return e.where&&(t+=` WHERE ${this._exprToSQL(e.where)}`),e.groupBy?.length&&(t+=` GROUP BY ${e.groupBy.join(", ")}`),e.having&&(t+=` HAVING ${this._exprToSQL(e.having)}`),e.orderBy?.length&&(t+=` ORDER BY ${e.orderBy.map(n=>`${n.column} ${n.direction||"ASC"}`).join(", ")}`),e.limit&&(t+=` LIMIT ${e.limit}`),e.offset&&(t+=` OFFSET ${e.offset}`),t}_exprToSQL(e){if(!e)return"";switch(e.type){case"literal":return e.value===null?"NULL":typeof e.value=="string"?`'${e.value.replace(/'/g,"''")}'`:String(e.value);case"column":return e.table?`${e.table}.${e.column}`:e.column;case"star":return"*";case"binary":return`(${this._exprToSQL(e.left)} ${e.operator} ${this._exprToSQL(e.right)})`;case"unary":return`(${e.operator} ${this._exprToSQL(e.operand)})`;case"call":let t=e.args.map(s=>this._exprToSQL(s)).join(", ");return`${e.name}(${e.distinct?"DISTINCT ":""}${t})`;case"in":let n=e.values.map(s=>this._exprToSQL(s)).join(", ");return`${this._exprToSQL(e.expr)} IN (${n})`;case"between":return`${this._exprToSQL(e.expr)} BETWEEN ${this._exprToSQL(e.low)} AND ${this._exprToSQL(e.high)}`;case"like":return`${this._exprToSQL(e.expr)} LIKE ${this._exprToSQL(e.pattern)}`;default:return""}}async _executeSingleTable(e){if(!e.from)throw new Error("FROM clause required");let t=e.from.name||e.from.table;if(!t&&e.from.url)throw new Error("Single-table queries must use registered table names, not URLs");let n=t.toLowerCase();if(this.memoryTables.has(n)){let i=this.memoryTables.get(n);return new V({columnNames:i.columns})._executeOnInMemoryData(e,i.toInMemoryData())}let s=this.getTable(t);return new V(s).execute(e)}_extractColumnFromExpr(e,t){if(e.type==="column")return e.table&&e.table!==t?null:e.column;throw new Error(`Invalid join condition expression: ${JSON.stringify(e)}`)}_getColumnsForTable(e,t){let n=[];for(let s of e){if(s.type==="star")return["*"];if(s.type==="expr"&&s.expr.type==="column"){let o=s.expr;(!o.table||o.table===t)&&n.push(o.column)}}return n.length>0?n:["*"]}clearPlanCache(){this._planCache.clear()}getPlanCacheStats(){return $r(this)}_normalizeSQL(e){return Dt(e)}_getCachedPlan(e){return Qn(this,e)}_setCachedPlan(e,t){return Jn(this,e,t)}_clearPlanCache(){this._planCache.clear()}_explainQuery(e){return Xn(this,e)}_optimizeExpr(e){return Ge(e)}_extractRangePredicates(e){return Yn(e)}_canPruneFragment(e,t){return Vr(e,t)}_findColumnIndex(e,t){return rt(e,t)}_filterToSQL(e){return $(e)}_applyProjection(e,t,n,s,o){return jn(e,t,n,s,o)}_buildInClause(e,t){return Ft(e,t)}_hashJoinWithInMemoryLeft(e,t,n,s){return qn(this,e,t,n,s)}_appendWhereClause(e,t){return Mt(e,t)}};Ze();var es=class{constructor(e,t){this.name=e,this.schema=t,this.columns=t.map(n=>n.name),this.rows=[],this._columnIndex=new Map,this.columns.forEach((n,s)=>this._columnIndex.set(n.toLowerCase(),s))}toInMemoryData(){return{columns:this.columns,rows:this.rows}}get rowCount(){return this.rows.length}},ts=class{constructor(e=null,t="./worker.js"){this.size=e||navigator.hardwareConcurrency||4,this.workerPath=t,this.workers=[],this.taskQueue=[],this.pendingTasks=new Map,this.nextTaskId=0,this.idleWorkers=[],this.initialized=!1,this.hasSharedArrayBuffer=typeof SharedArrayBuffer<"u"}async init(){if(this.initialized)return;let e=[];for(let t=0;t<this.size;t++){let n=new Worker(this.workerPath,{type:"module"});this.workers.push(n),n.onmessage=s=>this._handleMessage(t,s.data),n.onerror=s=>this._handleError(t,s),e.push(this._initWorker(t))}await Promise.all(e),this.initialized=!0,console.log(`[WorkerPool] Initialized ${this.size} workers (SharedArrayBuffer: ${this.hasSharedArrayBuffer})`)}_initWorker(e){return new Promise((t,n)=>{let s=this.nextTaskId++;this.pendingTasks.set(s,{resolve:o=>{this.idleWorkers.push(e),t(o)},reject:n}),this.workers[e].postMessage({type:"init",id:s,params:{workerId:e}})})}_handleMessage(e,t){if(t.type==="ready")return;let{id:n,success:s,result:o,error:i}=t,a=this.pendingTasks.get(n);if(!a){console.warn(`[WorkerPool] Unknown task ID: ${n}`);return}this.pendingTasks.delete(n),s?a.resolve(o):a.reject(new Error(i)),this.idleWorkers.push(e),this._processQueue()}_handleError(e,t){console.error(`[WorkerPool] Worker ${e} error:`,t)}_processQueue(){for(;this.taskQueue.length>0&&this.idleWorkers.length>0;){let e=this.taskQueue.shift(),t=this.idleWorkers.shift();this._sendTask(t,e)}}_sendTask(e,t){let n=this.workers[e],s=t.transfer||[];n.postMessage({type:t.type,id:t.id,params:t.params},s)}submit(e,t,n=[]){return new Promise((s,o)=>{let i=this.nextTaskId++;this.pendingTasks.set(i,{resolve:s,reject:o});let a={type:e,params:t,transfer:n,id:i};if(this.idleWorkers.length>0){let l=this.idleWorkers.shift();this._sendTask(l,a)}else this.taskQueue.push(a)})}async parallelVectorSearch(e,t,n,s,o=!1){this.initialized||await this.init();let i=t.map((l,c)=>{let u=new Float32Array(e);return this.submit("vectorSearch",{vectors:l.vectors,query:u,dim:n,numVectors:l.vectors.length/n,topK:s,startIndex:l.startIndex,normalized:o},[l.vectors.buffer,u.buffer])}),a=await Promise.all(i);return this._mergeTopK(a,s)}_mergeTopK(e,t){let n=[];for(let a of e)for(let l=0;l<a.count;l++)n.push({index:a.indices[l],score:a.scores[l]});n.sort((a,l)=>l.score-a.score);let s=Math.min(t,n.length),o=new Uint32Array(s),i=new Float32Array(s);for(let a=0;a<s;a++)o[a]=n[a].index,i[a]=n[a].score;return{indices:o,scores:i}}async parallelBatchSimilarity(e,t,n,s=!1){this.initialized||await this.init();let o=t.map(u=>{let f=new Float32Array(e);return this.submit("batchSimilarity",{query:f,vectors:u,dim:n,numVectors:u.length/n,normalized:s},[u.buffer,f.buffer])}),i=await Promise.all(o),a=i.reduce((u,f)=>u+f.scores.length,0),l=new Float32Array(a),c=0;for(let u of i)l.set(u.scores,c),c+=u.scores.length;return l}terminate(){for(let e of this.workers)e.terminate();this.workers=[],this.idleWorkers=[],this.initialized=!1}},ns=class r{constructor(){this.buffer=null,this.vectors=null,this.dim=0,this.numVectors=0,typeof SharedArrayBuffer>"u"&&console.warn("[SharedVectorStore] SharedArrayBuffer not available. Using regular ArrayBuffer.")}static isAvailable(){return typeof SharedArrayBuffer<"u"&&typeof Atomics<"u"}allocate(e,t){this.numVectors=e,this.dim=t;let n=e*t*4;r.isAvailable()?this.buffer=new SharedArrayBuffer(n):this.buffer=new ArrayBuffer(n),this.vectors=new Float32Array(this.buffer)}set(e,t=0){this.vectors.set(e,t*this.dim)}slice(e,t){let n=e*this.dim,s=t*this.dim;return new Float32Array(this.buffer,n*4,s)}getChunks(e){let t=[],n=Math.ceil(this.numVectors/e);for(let s=0;s<e;s++){let o=s*n,i=Math.min(n,this.numVectors-o);i>0&&t.push({start:o,count:i})}return t}};Tt();var Gt=class{constructor(e,t={}){this.name=e,this.options=t,this._ready=!1,this._sessionMode=t.session||!1,this._semanticSearchEnabled=!1,this._getEncryptionKey=t.getEncryptionKey||null,this._encryptionKeyId=null}async open(){if(this._ready)return this;let e=null;if(this._getEncryptionKey){let t=await this._getEncryptionKey();this._encryptionKeyId=`${this.name}:${Date.now()}`;let n;if(t instanceof CryptoKey)n=await crypto.subtle.exportKey("raw",t);else if(t instanceof ArrayBuffer||t instanceof Uint8Array)n=t instanceof Uint8Array?t:new Uint8Array(t);else if(typeof t=="string"){let o=new TextEncoder().encode(t),i=await crypto.subtle.digest("SHA-256",o);n=new Uint8Array(i)}else throw new Error("Encryption key must be CryptoKey, ArrayBuffer, Uint8Array, or string");e={keyId:this._encryptionKeyId,keyBytes:Array.from(n instanceof Uint8Array?n:new Uint8Array(n))}}return await M("open",{name:this.name,options:this.options,encryption:e}),this._sessionMode&&typeof window<"u"&&window.addEventListener("beforeunload",()=>{this.clear().catch(()=>{})}),this._ready=!0,this}async get(e){return await this._ensureOpen(),M("get",{name:this.name,key:e})}async set(e,t){await this._ensureOpen(),await M("set",{name:this.name,key:e,value:t})}async delete(e){return await this._ensureOpen(),M("delete",{name:this.name,key:e})}async has(e){return await this.get(e)!==void 0}async keys(){return await this._ensureOpen(),M("keys",{name:this.name})}async clear(){await this._ensureOpen(),await M("clear",{name:this.name})}async filter(e,t={}){return await this._ensureOpen(),M("filter",{name:this.name,key:e,query:t})}async find(e,t={}){return await this._ensureOpen(),M("find",{name:this.name,key:e,query:t})}async search(e,t,n=10){return await this._ensureOpen(),M("search",{name:this.name,key:e,text:t,limit:n})}async count(e,t=null){return await this._ensureOpen(),M("count",{name:this.name,key:e,query:t})}subscribe(e,t){return console.warn("[Store] subscribe() not yet implemented"),()=>{}}async enableSemanticSearch(e={}){await this._ensureOpen();let t=await M("enableSemanticSearch",{name:this.name,options:e});return t&&(this._semanticSearchEnabled=!0),t}async disableSemanticSearch(){await M("disableSemanticSearch",{name:this.name}),this._semanticSearchEnabled=!1}hasSemanticSearch(){return this._semanticSearchEnabled}async _ensureOpen(){this._ready||await this.open()}};async function fi(r,e={}){let t=new Gt(r,e);return await t.open(),t}Tt();var zt=class{constructor(e=null){this._getEncryptionKey=e,this._encryptionKeyId=null,this._ready=!1}async _init(){if(this._ready)return this;let e=null;if(this._getEncryptionKey){let t=await this._getEncryptionKey();this._encryptionKeyId=`vault:${Date.now()}`;let n;if(t instanceof CryptoKey)n=await crypto.subtle.exportKey("raw",t);else if(t instanceof ArrayBuffer||t instanceof Uint8Array)n=t instanceof Uint8Array?t:new Uint8Array(t);else if(typeof t=="string"){let o=new TextEncoder().encode(t),i=await crypto.subtle.digest("SHA-256",o);n=new Uint8Array(i)}else throw new Error("Encryption key must be CryptoKey, ArrayBuffer, Uint8Array, or string");e={keyId:this._encryptionKeyId,keyBytes:Array.from(n instanceof Uint8Array?n:new Uint8Array(n))}}return await M("vault:open",{encryption:e}),this._ready=!0,this}async get(e){return M("vault:get",{key:e})}async set(e,t){await M("vault:set",{key:e,value:t})}async delete(e){return M("vault:delete",{key:e})}async keys(){return M("vault:keys",{})}async has(e){return await this.get(e)!==void 0}async exec(e){return M("vault:exec",{sql:e})}async query(e){let t=await this.exec(e);return!t||!t.columns||!t.rows?[]:t.rows.map(n=>{let s={};return t.columns.forEach((o,i)=>{s[o]=n[i]}),s})}table(e){return new $t(this,e)}async tables(){return M("vault:tables",{})}async exportToLance(e){let t=await this.exec(`SELECT * FROM ${e} LIMIT 0`);if(!t||!t.columns)throw new Error(`Table '${e}' not found or empty`);let n=await this.exec(`SELECT * FROM ${e}`);if(!n||!n.rows||n.rows.length===0)throw new Error(`Table '${e}' is empty`);let s=new We,o=n.columns,i=n.rows;for(let a=0;a<o.length;a++){let l=o[a],c=i.map(f=>f[l]!==void 0?f[l]:f[a]),u=c.find(f=>f!=null);if(u===void 0)s.addStringColumn(l,c.map(f=>f===null?"":String(f)));else if(typeof u=="bigint")s.addInt64Column(l,BigInt64Array.from(c.map(f=>f===null?0n:BigInt(f))));else if(typeof u=="number")Number.isInteger(u)&&u<=2147483647&&u>=-2147483648?s.addInt32Column(l,Int32Array.from(c.map(f=>f===null?0:f))):s.addFloat64Column(l,Float64Array.from(c.map(f=>f===null?0:f)));else if(typeof u=="boolean")s.addBoolColumn(l,c.map(f=>f===null?!1:f));else if(Array.isArray(u)){let f=u.length,h=new Float32Array(c.length*f);for(let d=0;d<c.length;d++){let p=c[d]||new Array(f).fill(0);for(let g=0;g<f;g++)h[d*f+g]=p[g]||0}s.addVectorColumn(l,h,f)}else s.addStringColumn(l,c.map(f=>f===null?"":String(f)))}return s.finalize()}async uploadToUrl(e,t,n={}){let{onProgress:s}=n;if(s&&typeof XMLHttpRequest<"u")return new Promise((i,a)=>{let l=new XMLHttpRequest;l.open("PUT",t,!0),l.setRequestHeader("Content-Type","application/octet-stream"),l.upload.onprogress=c=>{c.lengthComputable&&s(c.loaded,c.total)},l.onload=()=>{l.status>=200&&l.status<300?i({ok:!0,status:l.status}):a(new Error(`Upload failed: ${l.status} ${l.statusText}`))},l.onerror=()=>a(new Error("Upload failed: network error")),l.send(e)});let o=await fetch(t,{method:"PUT",body:e,headers:{"Content-Type":"application/octet-stream"}});if(!o.ok)throw new Error(`Upload failed: ${o.status} ${o.statusText}`);return o}async exportToRemote(e,t,n={}){let s=await this.exportToLance(e);return await this.uploadToUrl(s,t,n),{size:s.length,url:t.split("?")[0]}}},$t=class r{constructor(e,t){this._vault=e,this._tableName=t,this._filters=[],this._similar=null,this._selectCols=null,this._limitValue=null,this._orderBy=null}filter(e,t,n){let s=this._clone();return s._filters.push({column:e,op:t,value:n}),s}similar(e,t,n=20){let s=this._clone();return s._similar={column:e,text:t,limit:n},s}select(...e){let t=this._clone();return t._selectCols=e.flat(),t}limit(e){let t=this._clone();return t._limitValue=e,t}orderBy(e,t="ASC"){let n=this._clone();return n._orderBy={column:e,direction:t},n}async toArray(){let e=this._toSQL();return this._vault.query(e)}async first(){let e=this._clone();return e._limitValue=1,(await e.toArray())[0]||null}async count(){let e=this._toSQL(!0);return(await this._vault.exec(e))?.rows?.[0]?.[0]||0}_toSQL(e=!1){let n=`SELECT ${e?"COUNT(*)":this._selectCols?.join(", ")||"*"} FROM ${this._tableName}`,s=[];for(let i of this._filters){let a=typeof i.value=="string"?`'${i.value}'`:i.value;s.push(`${i.column} ${i.op} ${a}`)}this._similar&&s.push(`${this._similar.column} NEAR '${this._similar.text}'`),s.length>0&&(n+=" WHERE "+s.join(" AND ")),this._orderBy&&!e&&(n+=` ORDER BY ${this._orderBy.column} ${this._orderBy.direction}`);let o=this._similar?.limit||this._limitValue;return o&&!e&&(n+=` LIMIT ${o}`),n}_clone(){let e=new r(this._vault,this._tableName);return e._filters=[...this._filters],e._similar=this._similar,e._selectCols=this._selectCols?[...this._selectCols]:null,e._limitValue=this._limitValue,e._orderBy=this._orderBy,e}};async function hi(r=null){let e=new zt(r);return await e._init(),e}st();st();export{dt as ChunkedLanceReader,bt as CostModel,Nt as DataFrame,De as Database,gt as DatasetStorage,Se as GPUAggregator,Ce as GPUGrouper,Ae as GPUJoiner,ct as GPUSorter,Ie as GPUVectorSearch,it as HotTierCache,ge as IVFIndex,ie as LRUCache,Oe as LanceData,Fe as LanceDataBase,Zn as LanceDatabase,_t as LanceFile,Pt as LanceFileWriter,nt as LanceQL,xt as LocalDatabase,Ut as LocalSQLParser,Ve as MemoryManager,es as MemoryTable,_e as MetadataCache,$e as OPFSFileReader,Pe as OPFSJoinExecutor,Me as OPFSLanceData,ce as OPFSStorage,he as ProtobufEncoder,We as PureLanceWriter,de as QueryPlanner,et as RemoteLanceData,It as RemoteLanceDataset,Ne as RemoteLanceFile,V as SQLExecutor,j as SQLLexer,K as SQLParser,ns as SharedVectorStore,we as Statement,qe as StatisticsManager,Gt as Store,$t as TableRef,zt as Vault,lt as WebGPUAccelerator,ts as WorkerPool,nt as default,qr as getGPUAggregator,Hr as getGPUGrouper,jr as getGPUJoiner,Jt as getGPUSorter,ut as getGPUVectorSearch,ae as getHotTierCache,q as getWebGPUAccelerator,Br as initSqlJs,fi as lanceStore,Nr as openLance,hi as vault,Mr as wasmUtils};
//# sourceMappingURL=lanceql.esm.js.map
