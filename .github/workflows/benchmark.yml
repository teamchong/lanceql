name: Benchmark

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'benchmarks/**'
      - '.github/workflows/benchmark.yml'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'benchmarks/**'
      - '.github/workflows/benchmark.yml'

jobs:
  benchmark-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Build library
        run: zig build lib

      - name: Run Parquet benchmark
        run: |
          echo "=== LanceQL Benchmark Results ===" > benchmark-results.txt
          echo "Platform: Linux (CPU only)" >> benchmark-results.txt
          echo "Date: $(date -u)" >> benchmark-results.txt
          echo "" >> benchmark-results.txt

          echo "=== Parquet Reader ===" >> benchmark-results.txt
          zig build test-parquet 2>&1 | grep -E "(Benchmark|Throughput|Avg|Min|Max|rows)" >> benchmark-results.txt || true
          echo "" >> benchmark-results.txt

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-linux
          path: benchmark-results.txt
          retention-days: 30

  benchmark-macos:
    runs-on: macos-14  # Apple Silicon (M1)
    steps:
      - uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Build Metal shaders
        run: zig build metal-shaders

      - name: Build library
        run: zig build lib

      - name: Run SQL clause benchmark
        run: |
          echo "=== LanceQL Benchmark Results ===" > benchmark-results.txt
          echo "Platform: macOS Apple Silicon (GPU enabled)" >> benchmark-results.txt
          echo "Date: $(date -u)" >> benchmark-results.txt
          echo "" >> benchmark-results.txt

          echo "=== SQL Clause Benchmark ===" >> benchmark-results.txt
          zig build bench-sql 2>&1 | tee -a benchmark-results.txt
          echo "" >> benchmark-results.txt

      - name: Run @logic_table workflow benchmark
        run: |
          echo "=== @logic_table Workflow Benchmark ===" >> benchmark-results.txt
          zig build bench-logic-table 2>&1 | tee -a benchmark-results.txt
          echo "" >> benchmark-results.txt

      - name: Run vector benchmark (GPU)
        run: |
          echo "=== Vector Operations (GPU vs CPU) ===" >> benchmark-results.txt
          zig build bench-vector 2>&1 | tee -a benchmark-results.txt
          echo "" >> benchmark-results.txt

      - name: Run Parquet benchmark
        run: |
          echo "=== Parquet Reader ===" >> benchmark-results.txt
          zig build test-parquet 2>&1 | grep -E "(Benchmark|Throughput|Avg|Min|Max|rows)" >> benchmark-results.txt || true

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-macos
          path: benchmark-results.txt
          retention-days: 30

  compare-results:
    needs: [benchmark-linux, benchmark-macos]
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Download Linux results
        uses: actions/download-artifact@v4
        with:
          name: benchmark-results-linux
          path: linux

      - name: Download macOS results
        uses: actions/download-artifact@v4
        with:
          name: benchmark-results-macos
          path: macos

      - name: Comment benchmark results on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## ðŸš€ LanceQL Benchmark Results\n\n';

            try {
              const macosResults = fs.readFileSync('macos/benchmark-results.txt', 'utf8');
              comment += '### macOS (Apple Silicon + GPU)\n```\n' + macosResults + '\n```\n\n';
            } catch (e) {
              comment += '### macOS\n_No results available_\n\n';
            }

            try {
              const linuxResults = fs.readFileSync('linux/benchmark-results.txt', 'utf8');
              comment += '### Linux (CPU only)\n```\n' + linuxResults + '\n```\n';
            } catch (e) {
              comment += '### Linux\n_No results available_\n';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
